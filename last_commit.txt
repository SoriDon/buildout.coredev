Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2019-06-15T17:22:19+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/648f53f7b7ef93e0aae7b895d0a1ea78131fce35

add more logging during migration

Files changed:
M plone/app/contenttypes/migration/browser.py
M plone/app/contenttypes/migration/utils.py
M plone/app/contenttypes/upgrades.py

b'diff --git a/plone/app/contenttypes/migration/browser.py b/plone/app/contenttypes/migration/browser.py\nindex 13a2d8f0..2332aabb 100644\n--- a/plone/app/contenttypes/migration/browser.py\n+++ b/plone/app/contenttypes/migration/browser.py\n@@ -218,6 +218,7 @@ def __call__(self,\n         use_new_view_names(portal, types_to_fix=[\'Plone Site\'])\n \n         if reindex_catalog:\n+            logger.info(\'Rebuiling catalog. This may take a while...\')\n             catalog.clearFindAndRebuild()\n \n         # restore references\ndiff --git a/plone/app/contenttypes/migration/utils.py b/plone/app/contenttypes/migration/utils.py\nindex 2b9adfd1..cd231160 100644\n--- a/plone/app/contenttypes/migration/utils.py\n+++ b/plone/app/contenttypes/migration/utils.py\n@@ -334,7 +334,11 @@ def restore_references(context):\n     the content-types framework.\n     """\n     key = \'ALL_REFERENCES\'\n-    for ref in IAnnotations(context)[key]:\n+    all_references = IAnnotations(context)[key]\n+    logger.info(\'Restoring {0} relations.\'.format(\n+        len(all_references))\n+    )\n+    for index, ref in enumerate(all_references):\n         source_obj = uuidToObject(ref[\'from_uuid\'])\n         target_obj = uuidToObject(ref[\'to_uuid\'])\n         relationship = ref[\'relationship\']\n@@ -350,6 +354,9 @@ def restore_references(context):\n                     \'/\'.join(context.getPhysicalPath())\n                 )\n             )\n+        if not index % 100:\n+            logger.info(\'Restoring relations: {}/{}\'.format(\n+                index, len(all_references)))\n     del IAnnotations(context)[key]\n \n \ndiff --git a/plone/app/contenttypes/upgrades.py b/plone/app/contenttypes/upgrades.py\nindex 19c83819..026a8e08 100644\n--- a/plone/app/contenttypes/upgrades.py\n+++ b/plone/app/contenttypes/upgrades.py\n@@ -152,6 +152,7 @@ def enable_shortname_behavior(context):\n def use_new_view_names(context, types_to_fix=None):  # noqa\n     """Migrate old view names to new view names."""\n     # Don\'t reload the profile. Only change the settings.\n+    logger.info(\'Start updating view names...\')\n     portal = getSite()\n     portal_types = getToolByName(portal, \'portal_types\')\n     if types_to_fix is None:\n@@ -220,6 +221,7 @@ def _fixup(obj, view_map):\n     catalog = getToolByName(portal, \'portal_catalog\')\n     search = catalog.unrestrictedSearchResults\n     for portal_type in types_to_fix:\n+        logger.info(\'Updating view names for {}\'.format(portal_type))\n         brains = search(portal_type=portal_type)\n         objs = _brains2objs(brains)\n         for obj in objs:\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2019-06-15T17:22:19+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/e8e75682614a7e299bdb6592c6215d6aa5b46c0e

add changenote

Files changed:
A news/526.feature

b'diff --git a/news/526.feature b/news/526.feature\nnew file mode 100644\nindex 00000000..10587ade\n--- /dev/null\n+++ b/news/526.feature\n@@ -0,0 +1,2 @@\n+Add more log-messages during migration from AT to DX.\n+[pbauer]\n\\ No newline at end of file\n'

