Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2018-11-10T09:08:32+01:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/39c29158197f29071ab47ff23da883f1d0daf4f3

add threads option for waitress + ZServer

Files changed:
M CHANGES.rst
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/wsgi.txt
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 9621d6a..da633b5 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -10,7 +10,9 @@ Breaking changes:\n \n New features:\n \n-- *add item here*\n+- Add new option \'threads\' used to specify the number of workers for both\n+  waitress + ZServer, and a deprecation warning for \'zserver-threads\'.\n+  [tschorr]\n \n Bug fixes:\n \ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex d8a0d94..283f09f 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -14,6 +14,7 @@\n ##############################################################################\n \n from plone.recipe.zope2instance import make\n+from warnings import warn\n from zc.recipe.egg.egg import Egg\n from zc.recipe.egg.egg import Scripts\n \n@@ -403,7 +404,12 @@ def is_rs_option(name):\n             file_storage_snippet = self.render_file_storage(\n                 file_storage, blob_storage, base_dir, var_dir, zlib)\n \n-        zserver_threads = options.get(\'zserver-threads\', \'2\')\n+        if \'zserver-threads\' in options:\n+            warn(\n+                \'option "zserver-threads" is deprecated, please use "threads"\',\n+                DeprecationWarning)\n+        zserver_threads = options.get(\n+            \'threads\', options.get(\'zserver-threads\', \'2\'))\n         if zserver_threads:\n             zserver_threads = \'zserver-threads %s\' % zserver_threads\n \n@@ -598,9 +604,13 @@ def is_rs_option(name):\n     def build_wsgi_ini(self):\n         options = self.options\n         wsgi_ini_path = os.path.join(options[\'location\'], \'etc\', \'wsgi.ini\')\n+        listen = options.get(\'http-address\', \'0.0.0.0:8080\')\n+        if \':\' not in listen:\n+            listen = \'0.0.0.0:{}\'.format(listen)\n         options = {\n             \'location\': options[\'location\'],\n-            \'http_address\': options.get(\'http-address\', \'8080\'),\n+            \'http_address\': listen,\n+            \'threads\': options.get(\'threads\', 4),\n         }\n         wsgi_ini = wsgi_ini_template % options\n         with open(wsgi_ini_path, \'w\') as f:\n@@ -1128,7 +1138,8 @@ def render_file_storage(self, file_storage, blob_storage,\n wsgi_ini_template = """\\\n [server:main]\n use = egg:waitress#main\n-listen = 0.0.0.0:%(http_address)s\n+listen = %(http_address)s\n+threads = %(threads)s\n \n [app:zope]\n use = egg:Zope#main\ndiff --git a/src/plone/recipe/zope2instance/tests/wsgi.txt b/src/plone/recipe/zope2instance/tests/wsgi.txt\nindex 98b80c5..dc91892 100644\n--- a/src/plone/recipe/zope2instance/tests/wsgi.txt\n+++ b/src/plone/recipe/zope2instance/tests/wsgi.txt\n@@ -1,7 +1,9 @@\n-=====================\n-Test wsgi.py creation\n-=====================\n+===========================\n+Test wsgi instance creation\n+===========================\n \n+Test default configuration\n+==========================\n \n     >>> from __future__ import print_function\n     >>> from zc.buildout.testing import *\n@@ -15,10 +17,10 @@ plone.recipe.zope2instance::\n     >>> write(\'buildout.cfg\',\n     ... \'\'\'\n     ... [buildout]\n-    ... parts = wsgi.py\n+    ... parts = instance\n     ... find-links = %(sample_buildout)s/eggs\n     ...\n-    ... [wsgi.py]\n+    ... [instance]\n     ... recipe = plone.recipe.zope2instance\n     ... eggs =\n     ... user = me:me\n@@ -28,18 +30,18 @@ plone.recipe.zope2instance::\n Let\'s run it::\n \n     >>> print(system(join(\'bin\', \'buildout\'))),\n-    Installing wsgi.py.\n-    Generated script \'...wsgi.py\'...\n+    Installing instance.\n+    Generated script \'...instance\'...\n \n-We should have a wsgi.py part, with a basic zope.conf::\n+We should have an instance part, with a basic zope.conf::\n \n-    >>> instance = os.path.join(sample_buildout, \'parts\', \'wsgi.py\')\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n     >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n     >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n     >>> print(zope_conf)\n-    %define INSTANCEHOME .../sample-buildout/parts/wsgi.py\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n     instancehome $INSTANCEHOME\n-    %define CLIENTHOME .../sample-buildout/var/wsgi.py\n+    %define CLIENTHOME .../sample-buildout/var/instance\n     clienthome $CLIENTHOME\n     debug-mode off\n     security-policy-implementation C\n@@ -67,3 +69,91 @@ We should have a wsgi.py part, with a basic zope.conf::\n         container-class Products.TemporaryFolder.TemporaryContainer\n     </zodb_db>\n     python-check-interval 1000\n+\n+The buildout has also created an INI file containing the waitress configuration:\n+\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n+    >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n+    >>> print(wsgi_ini)\n+    [server:main]\n+    use = egg:waitress#main\n+    listen = 0.0.0.0:8080\n+    threads = 4\n+    <BLANKLINE>\n+    [app:zope]\n+    use = egg:Zope#main\n+    zope_conf = .../sample-buildout/parts/instance/etc/zope.conf\n+    <BLANKLINE>\n+    [pipeline:main]\n+    pipeline =\n+        egg:Zope#httpexceptions\n+        zope\n+    <BLANKLINE>\n+    [loggers]\n+    keys = root, plone\n+    <BLANKLINE>\n+    [handlers]\n+    keys = console\n+    <BLANKLINE>\n+    [formatters]\n+    keys = generic\n+    <BLANKLINE>\n+    [logger_root]\n+    level = INFO\n+    handlers = console\n+    <BLANKLINE>\n+    [logger_plone]\n+    level = DEBUG\n+    handlers =\n+    qualname = plone\n+    <BLANKLINE>\n+    [handler_console]\n+    class = StreamHandler\n+    args = (sys.stderr,)\n+    level = NOTSET\n+    formatter = generic\n+    <BLANKLINE>\n+    [formatter_generic]\n+    format = %(asctime)s %(levelname)-5.5s [%(name)s:%(lineno)s][%(threadName)s] %(message)s\n+    <BLANKLINE>\n+\n+Custom WSGI options\n+=================\n+\n+Let\'s create another buildout configuring a custom port and a custom number of workers::\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... http-address = localhost:6543\n+    ... threads = 3\n+    ... wsgi = on\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'.../sample-buildout/bin/instance\'.\n+    ...\n+\n+The buildout has updated our INI file:\n+\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n+    >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n+    >>> print(wsgi_ini)\n+    [server:main]\n+    use = egg:waitress#main\n+    listen = localhost:6543\n+    threads = 3\n+    <BLANKLINE>\n+    [app:zope]\n+    ...\ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 55546bd..44857e2 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -1801,6 +1801,78 @@ And check it::\n     </http-server>\n     ...\n \n+Configuring ZServer workers is also possible using the \'threads\' option:\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... threads = 3\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+And check it::\n+\n+    >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n+    >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n+    >>> print(zope_conf)\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n+    ...\n+    zserver-threads 3\n+    ...\n+    <http-server>\n+    ...\n+\n+The \'zserver-threads\' option is deprecated but still working:\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... zserver-threads = 3\n+    ... \'\'\' % options)\n+\n+Run it::\n+\n+    >>> import warnings\n+    >>> warnings.simplefilter(\'error\')\n+    >>> print(system(join(\'bin\', \'buildout\')))\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+And check it::\n+\n+    >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n+    >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n+    >>> print(zope_conf)\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n+    ...\n+    zserver-threads 3\n+    ...\n+    <http-server>\n+    ...\n+\n Edge Cases\n ==========\n \n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2018-11-10T09:10:21+01:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/45972a69b09d9584a3cfcbe14d2090f961f916a1

remove unnecessary import

Files changed:
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b"diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 44857e2..fa615d6 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -1853,8 +1853,6 @@ The 'zserver-threads' option is deprecated but still working:\n \n Run it::\n \n-    >>> import warnings\n-    >>> warnings.simplefilter('error')\n     >>> print(system(join('bin', 'buildout')))\n     Uninstalling instance.\n     Installing instance.\n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2018-11-10T14:54:54+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/96486d8c07cab1f028683510d71a511043fc0618

Merge pull request #55 from plone/add_threads_option

Add a new threads option

Files changed:
M CHANGES.rst
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/wsgi.txt
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 9621d6a..da633b5 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -10,7 +10,9 @@ Breaking changes:\n \n New features:\n \n-- *add item here*\n+- Add new option \'threads\' used to specify the number of workers for both\n+  waitress + ZServer, and a deprecation warning for \'zserver-threads\'.\n+  [tschorr]\n \n Bug fixes:\n \ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex d8a0d94..283f09f 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -14,6 +14,7 @@\n ##############################################################################\n \n from plone.recipe.zope2instance import make\n+from warnings import warn\n from zc.recipe.egg.egg import Egg\n from zc.recipe.egg.egg import Scripts\n \n@@ -403,7 +404,12 @@ def is_rs_option(name):\n             file_storage_snippet = self.render_file_storage(\n                 file_storage, blob_storage, base_dir, var_dir, zlib)\n \n-        zserver_threads = options.get(\'zserver-threads\', \'2\')\n+        if \'zserver-threads\' in options:\n+            warn(\n+                \'option "zserver-threads" is deprecated, please use "threads"\',\n+                DeprecationWarning)\n+        zserver_threads = options.get(\n+            \'threads\', options.get(\'zserver-threads\', \'2\'))\n         if zserver_threads:\n             zserver_threads = \'zserver-threads %s\' % zserver_threads\n \n@@ -598,9 +604,13 @@ def is_rs_option(name):\n     def build_wsgi_ini(self):\n         options = self.options\n         wsgi_ini_path = os.path.join(options[\'location\'], \'etc\', \'wsgi.ini\')\n+        listen = options.get(\'http-address\', \'0.0.0.0:8080\')\n+        if \':\' not in listen:\n+            listen = \'0.0.0.0:{}\'.format(listen)\n         options = {\n             \'location\': options[\'location\'],\n-            \'http_address\': options.get(\'http-address\', \'8080\'),\n+            \'http_address\': listen,\n+            \'threads\': options.get(\'threads\', 4),\n         }\n         wsgi_ini = wsgi_ini_template % options\n         with open(wsgi_ini_path, \'w\') as f:\n@@ -1128,7 +1138,8 @@ def render_file_storage(self, file_storage, blob_storage,\n wsgi_ini_template = """\\\n [server:main]\n use = egg:waitress#main\n-listen = 0.0.0.0:%(http_address)s\n+listen = %(http_address)s\n+threads = %(threads)s\n \n [app:zope]\n use = egg:Zope#main\ndiff --git a/src/plone/recipe/zope2instance/tests/wsgi.txt b/src/plone/recipe/zope2instance/tests/wsgi.txt\nindex 98b80c5..dc91892 100644\n--- a/src/plone/recipe/zope2instance/tests/wsgi.txt\n+++ b/src/plone/recipe/zope2instance/tests/wsgi.txt\n@@ -1,7 +1,9 @@\n-=====================\n-Test wsgi.py creation\n-=====================\n+===========================\n+Test wsgi instance creation\n+===========================\n \n+Test default configuration\n+==========================\n \n     >>> from __future__ import print_function\n     >>> from zc.buildout.testing import *\n@@ -15,10 +17,10 @@ plone.recipe.zope2instance::\n     >>> write(\'buildout.cfg\',\n     ... \'\'\'\n     ... [buildout]\n-    ... parts = wsgi.py\n+    ... parts = instance\n     ... find-links = %(sample_buildout)s/eggs\n     ...\n-    ... [wsgi.py]\n+    ... [instance]\n     ... recipe = plone.recipe.zope2instance\n     ... eggs =\n     ... user = me:me\n@@ -28,18 +30,18 @@ plone.recipe.zope2instance::\n Let\'s run it::\n \n     >>> print(system(join(\'bin\', \'buildout\'))),\n-    Installing wsgi.py.\n-    Generated script \'...wsgi.py\'...\n+    Installing instance.\n+    Generated script \'...instance\'...\n \n-We should have a wsgi.py part, with a basic zope.conf::\n+We should have an instance part, with a basic zope.conf::\n \n-    >>> instance = os.path.join(sample_buildout, \'parts\', \'wsgi.py\')\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n     >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n     >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n     >>> print(zope_conf)\n-    %define INSTANCEHOME .../sample-buildout/parts/wsgi.py\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n     instancehome $INSTANCEHOME\n-    %define CLIENTHOME .../sample-buildout/var/wsgi.py\n+    %define CLIENTHOME .../sample-buildout/var/instance\n     clienthome $CLIENTHOME\n     debug-mode off\n     security-policy-implementation C\n@@ -67,3 +69,91 @@ We should have a wsgi.py part, with a basic zope.conf::\n         container-class Products.TemporaryFolder.TemporaryContainer\n     </zodb_db>\n     python-check-interval 1000\n+\n+The buildout has also created an INI file containing the waitress configuration:\n+\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n+    >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n+    >>> print(wsgi_ini)\n+    [server:main]\n+    use = egg:waitress#main\n+    listen = 0.0.0.0:8080\n+    threads = 4\n+    <BLANKLINE>\n+    [app:zope]\n+    use = egg:Zope#main\n+    zope_conf = .../sample-buildout/parts/instance/etc/zope.conf\n+    <BLANKLINE>\n+    [pipeline:main]\n+    pipeline =\n+        egg:Zope#httpexceptions\n+        zope\n+    <BLANKLINE>\n+    [loggers]\n+    keys = root, plone\n+    <BLANKLINE>\n+    [handlers]\n+    keys = console\n+    <BLANKLINE>\n+    [formatters]\n+    keys = generic\n+    <BLANKLINE>\n+    [logger_root]\n+    level = INFO\n+    handlers = console\n+    <BLANKLINE>\n+    [logger_plone]\n+    level = DEBUG\n+    handlers =\n+    qualname = plone\n+    <BLANKLINE>\n+    [handler_console]\n+    class = StreamHandler\n+    args = (sys.stderr,)\n+    level = NOTSET\n+    formatter = generic\n+    <BLANKLINE>\n+    [formatter_generic]\n+    format = %(asctime)s %(levelname)-5.5s [%(name)s:%(lineno)s][%(threadName)s] %(message)s\n+    <BLANKLINE>\n+\n+Custom WSGI options\n+=================\n+\n+Let\'s create another buildout configuring a custom port and a custom number of workers::\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... http-address = localhost:6543\n+    ... threads = 3\n+    ... wsgi = on\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'.../sample-buildout/bin/instance\'.\n+    ...\n+\n+The buildout has updated our INI file:\n+\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n+    >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n+    >>> print(wsgi_ini)\n+    [server:main]\n+    use = egg:waitress#main\n+    listen = localhost:6543\n+    threads = 3\n+    <BLANKLINE>\n+    [app:zope]\n+    ...\ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 55546bd..fa615d6 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -1801,6 +1801,76 @@ And check it::\n     </http-server>\n     ...\n \n+Configuring ZServer workers is also possible using the \'threads\' option:\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... threads = 3\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+And check it::\n+\n+    >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n+    >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n+    >>> print(zope_conf)\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n+    ...\n+    zserver-threads 3\n+    ...\n+    <http-server>\n+    ...\n+\n+The \'zserver-threads\' option is deprecated but still working:\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... zserver-threads = 3\n+    ... \'\'\' % options)\n+\n+Run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\')))\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+And check it::\n+\n+    >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n+    >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n+    >>> print(zope_conf)\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n+    ...\n+    zserver-threads 3\n+    ...\n+    <http-server>\n+    ...\n+\n Edge Cases\n ==========\n \n'

