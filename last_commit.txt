Repository: plone.session


Branch: refs/heads/master
Date: 2022-03-30T18:09:42+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.session/commit/32fdb0011504274d6e7dc0fd86c0ecd1400ac4a6

Register single bundle for Plone 6 for our optional refresh support.

An upgrade step for this is in plone.app.upgrade, otherwise we leave partial bundles behind.
Removed our own upgrade step and profile, as they are not needed when migrating from Plone 5.2.

Fixes https://github.com/plone/plone.session/issues/24

Files changed:
A news/24.breaking
M plone/session/configure.zcml
M plone/session/hiddenprofiles.py
M plone/session/profiles.zcml
M plone/session/profiles/default/metadata.xml
M plone/session/profiles/default/registry.xml
M plone/session/profiles/uninstall/registry.xml
D plone/session/profiles/remove-legacy-resources/cssregistry.xml
D plone/session/profiles/remove-legacy-resources/jsregistry.xml
D plone/session/profiles/remove-legacy-resources/metadata.xml
D plone/session/upgrades.py
D plone/session/upgrades.zcml

b'diff --git a/news/24.breaking b/news/24.breaking\nnew file mode 100644\nindex 0000000..5a40f80\n--- /dev/null\n+++ b/news/24.breaking\n@@ -0,0 +1,4 @@\n+Register single resource bundle for Plone 6 for our optional refresh support.\n+An upgrade step for this is in plone.app.upgrade, otherwise we leave partial bundles behind.\n+Removed our own upgrade step and profile, as they are not needed when migrating from Plone 5.2.\n+[maurits]\ndiff --git a/plone/session/configure.zcml b/plone/session/configure.zcml\nindex 815ddcb..0b40a0e 100644\n--- a/plone/session/configure.zcml\n+++ b/plone/session/configure.zcml\n@@ -10,11 +10,6 @@\n \n   <include package="plone.protect" />\n   <include file="resources.zcml" />\n-  <include\n-      file="upgrades.zcml"\n-      zcml:condition="installed Products.CMFPlone"\n-  />\n-\n   <include\n       file="profiles.zcml"\n       zcml:condition="installed Products.CMFPlone"\ndiff --git a/plone/session/hiddenprofiles.py b/plone/session/hiddenprofiles.py\nindex 0e20049..07abe16 100644\n--- a/plone/session/hiddenprofiles.py\n+++ b/plone/session/hiddenprofiles.py\n@@ -12,6 +12,5 @@ def getNonInstallableProfiles(self):\n \n         """\n         return [\n-            u\'plone.session:uninstall\',\n-            u\'plone.session:remove-legacy-resources\',\n+            \'plone.session:uninstall\',\n         ]\ndiff --git a/plone/session/profiles.zcml b/plone/session/profiles.zcml\nindex 0e44fa2..5e9bbac 100644\n--- a/plone/session/profiles.zcml\n+++ b/plone/session/profiles.zcml\n@@ -19,14 +19,6 @@\n       title="Session refresh support [uninstall]"\n   />\n \n-  <gs:registerProfile\n-      description="Remove plone.session legacy portal_css/portal_js registration"\n-      directory="profiles/remove-legacy-resources"\n-      name="remove-legacy-resources"\n-      provides="Products.GenericSetup.interfaces.EXTENSION"\n-      title="Session refresh support: Remove legacy resources"\n-  />\n-\n   <utility\n       name="plone.session"\n       factory=".hiddenprofiles.HiddenProfiles"\ndiff --git a/plone/session/profiles/default/metadata.xml b/plone/session/profiles/default/metadata.xml\nindex 3c0f850..299e5a1 100644\n--- a/plone/session/profiles/default/metadata.xml\n+++ b/plone/session/profiles/default/metadata.xml\n@@ -1,4 +1,8 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>1001</version>\n+  <!-- Note: it is good to create upgrade steps in this package,\n+       but the upgrade to 1002 is done in plone.app.upgrade,\n+       for Plone 6.0.0a4.  There we have code to properly remove\n+       old bundles with old settings. -->\n+  <version>1002</version>\n </metadata>\ndiff --git a/plone/session/profiles/default/registry.xml b/plone/session/profiles/default/registry.xml\nindex dcf9716..ca990ed 100644\n--- a/plone/session/profiles/default/registry.xml\n+++ b/plone/session/profiles/default/registry.xml\n@@ -1,31 +1,23 @@\n <?xml version="1.0"?>\n <registry>\n   <!--\n-  =============================\n-  JS/CSS Registry Configuration\n-  =============================\n+  ===============================\n+  Resource Registry Configuration\n+  ===============================\n   -->\n   <records\n       interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      prefix="plone.bundles/plone-session-pseudo-css">\n+      prefix="plone.bundles/plone-session">\n+    <value key="enabled">True</value>\n+    <value key="jscompilation">++resource++plone.session.refreshsupport.js</value>\n     <!-- This is a pseudo CSS generating a link in the Head .\n          The way to trigger the session refresh should be refactored at some point.\n     -->\n-    <value key="enabled">True</value>\n     <value key="csscompilation">acl_users/session/refresh?session_refresh=true&amp;type=css&amp;minutes=5</value>\n-    <value key="last_compilation">2018-03-27 00:00:00</value>\n-    <value key="compile">False</value>\n     <value key="expression">python: member is not None</value>\n+    <value key="depends">jquery</value>\n+    <value key="load_async">False</value>\n+    <value key="load_defer">False</value>\n   </records>\n \n-  <records\n-      interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      prefix="plone.bundles/plone-session-js">\n-    <value key="enabled">True</value>\n-    <value key="jscompilation">++resource++plone.session.refreshsupport.js</value>\n-    <value key="last_compilation">2018-03-27 00:00:00</value>\n-    <value key="compile">False</value>\n-    <value key="depends">plone-logged-in</value>\n-    <value key="merge_with">logged-in</value>\n-  </records>\n-</registry>\n\\ No newline at end of file\n+</registry>\ndiff --git a/plone/session/profiles/remove-legacy-resources/cssregistry.xml b/plone/session/profiles/remove-legacy-resources/cssregistry.xml\ndeleted file mode 100644\nindex 629e2e8..0000000\n--- a/plone/session/profiles/remove-legacy-resources/cssregistry.xml\n+++ /dev/null\n@@ -1,7 +0,0 @@\n-<?xml version="1.0"?>\n-<object name="portal_css" meta_type="Stylesheets Registry">\n-    <stylesheet\n-        id="acl_users/session/refresh?session_refresh=true&amp;type=css&amp;minutes=5"\n-        remove="true"\n-        />\n-</object>\ndiff --git a/plone/session/profiles/remove-legacy-resources/jsregistry.xml b/plone/session/profiles/remove-legacy-resources/jsregistry.xml\ndeleted file mode 100644\nindex 5a754c7..0000000\n--- a/plone/session/profiles/remove-legacy-resources/jsregistry.xml\n+++ /dev/null\n@@ -1,7 +0,0 @@\n-<?xml version="1.0"?>\n-<object name="portal_javascripts" meta_type="JavaScripts Registry">\n-    <javascript\n-        id="++resource++plone.session.refreshsupport.js"\n-        remove="true"\n-        />\n-</object>\ndiff --git a/plone/session/profiles/remove-legacy-resources/metadata.xml b/plone/session/profiles/remove-legacy-resources/metadata.xml\ndeleted file mode 100644\nindex b22370d..0000000\n--- a/plone/session/profiles/remove-legacy-resources/metadata.xml\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-<?xml version="1.0"?>\n-<metadata>\n-  <version>1000</version>\n-</metadata>\ndiff --git a/plone/session/profiles/uninstall/registry.xml b/plone/session/profiles/uninstall/registry.xml\nindex bb91895..6dfe299 100644\n--- a/plone/session/profiles/uninstall/registry.xml\n+++ b/plone/session/profiles/uninstall/registry.xml\n@@ -3,14 +3,8 @@\n \n   <records\n       interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      prefix="plone.bundles/session-refresh-pseudo-css"\n+      prefix="plone.bundles/plone-session"\n       remove="true">\n   </records>\n \n-  <records\n-      interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      prefix="plone.bundles/session-refresh-js"\n-      remove="true">\n-  </records>\n-\n-</registry>\n\\ No newline at end of file\n+</registry>\ndiff --git a/plone/session/upgrades.py b/plone/session/upgrades.py\ndeleted file mode 100644\nindex 8da0c86..0000000\n--- a/plone/session/upgrades.py\n+++ /dev/null\n@@ -1,9 +0,0 @@\n-# -*- coding: utf-8 -*-\n-from Products.CMFCore.utils import getToolByName\n-\n-\n-def upgrade_1000_to_1001(context):\n-    # remove legacy registry, register in the new registry\n-    setup = getToolByName(context, \'portal_setup\')\n-    setup.runAllImportStepsFromProfile(\'plone.session:remove-legacy-resources\')\n-    setup.runAllImportStepsFromProfile(\'plone.session:default\')\ndiff --git a/plone/session/upgrades.zcml b/plone/session/upgrades.zcml\ndeleted file mode 100644\nindex 33194c0..0000000\n--- a/plone/session/upgrades.zcml\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-<configure\n-    xmlns:zope="http://namespaces.zope.org/zope"\n-    xmlns:browser="http://namespaces.zope.org/browser"\n-    xmlns:genericsetup="http://namespaces.zope.org/genericsetup">\n-\n-  <genericsetup:upgradeStep\n-      source="1000"\n-      destination="1001"\n-      title="Use new resource registry."\n-      description=""\n-      profile="plone.session:default"\n-      handler="plone.session.upgrades.upgrade_1000_to_1001"\n-  />\n-\n-</configure>\n'

Repository: plone.session


Branch: refs/heads/master
Date: 2022-04-07T20:45:36+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.session/commit/8c6967f275fcbfa086aed91bcc7000a35b5cb6fa

Merge pull request #25 from plone/maurits-plone6-resource-issue-24

Register single bundle for Plone 6 for our optional refresh support.

Files changed:
A news/24.breaking
M plone/session/configure.zcml
M plone/session/hiddenprofiles.py
M plone/session/profiles.zcml
M plone/session/profiles/default/metadata.xml
M plone/session/profiles/default/registry.xml
M plone/session/profiles/uninstall/registry.xml
D plone/session/profiles/remove-legacy-resources/cssregistry.xml
D plone/session/profiles/remove-legacy-resources/jsregistry.xml
D plone/session/profiles/remove-legacy-resources/metadata.xml
D plone/session/upgrades.py
D plone/session/upgrades.zcml

b'diff --git a/news/24.breaking b/news/24.breaking\nnew file mode 100644\nindex 0000000..5a40f80\n--- /dev/null\n+++ b/news/24.breaking\n@@ -0,0 +1,4 @@\n+Register single resource bundle for Plone 6 for our optional refresh support.\n+An upgrade step for this is in plone.app.upgrade, otherwise we leave partial bundles behind.\n+Removed our own upgrade step and profile, as they are not needed when migrating from Plone 5.2.\n+[maurits]\ndiff --git a/plone/session/configure.zcml b/plone/session/configure.zcml\nindex 815ddcb..0b40a0e 100644\n--- a/plone/session/configure.zcml\n+++ b/plone/session/configure.zcml\n@@ -10,11 +10,6 @@\n \n   <include package="plone.protect" />\n   <include file="resources.zcml" />\n-  <include\n-      file="upgrades.zcml"\n-      zcml:condition="installed Products.CMFPlone"\n-  />\n-\n   <include\n       file="profiles.zcml"\n       zcml:condition="installed Products.CMFPlone"\ndiff --git a/plone/session/hiddenprofiles.py b/plone/session/hiddenprofiles.py\nindex 0e20049..07abe16 100644\n--- a/plone/session/hiddenprofiles.py\n+++ b/plone/session/hiddenprofiles.py\n@@ -12,6 +12,5 @@ def getNonInstallableProfiles(self):\n \n         """\n         return [\n-            u\'plone.session:uninstall\',\n-            u\'plone.session:remove-legacy-resources\',\n+            \'plone.session:uninstall\',\n         ]\ndiff --git a/plone/session/profiles.zcml b/plone/session/profiles.zcml\nindex 0e44fa2..5e9bbac 100644\n--- a/plone/session/profiles.zcml\n+++ b/plone/session/profiles.zcml\n@@ -19,14 +19,6 @@\n       title="Session refresh support [uninstall]"\n   />\n \n-  <gs:registerProfile\n-      description="Remove plone.session legacy portal_css/portal_js registration"\n-      directory="profiles/remove-legacy-resources"\n-      name="remove-legacy-resources"\n-      provides="Products.GenericSetup.interfaces.EXTENSION"\n-      title="Session refresh support: Remove legacy resources"\n-  />\n-\n   <utility\n       name="plone.session"\n       factory=".hiddenprofiles.HiddenProfiles"\ndiff --git a/plone/session/profiles/default/metadata.xml b/plone/session/profiles/default/metadata.xml\nindex 3c0f850..299e5a1 100644\n--- a/plone/session/profiles/default/metadata.xml\n+++ b/plone/session/profiles/default/metadata.xml\n@@ -1,4 +1,8 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>1001</version>\n+  <!-- Note: it is good to create upgrade steps in this package,\n+       but the upgrade to 1002 is done in plone.app.upgrade,\n+       for Plone 6.0.0a4.  There we have code to properly remove\n+       old bundles with old settings. -->\n+  <version>1002</version>\n </metadata>\ndiff --git a/plone/session/profiles/default/registry.xml b/plone/session/profiles/default/registry.xml\nindex dcf9716..ca990ed 100644\n--- a/plone/session/profiles/default/registry.xml\n+++ b/plone/session/profiles/default/registry.xml\n@@ -1,31 +1,23 @@\n <?xml version="1.0"?>\n <registry>\n   <!--\n-  =============================\n-  JS/CSS Registry Configuration\n-  =============================\n+  ===============================\n+  Resource Registry Configuration\n+  ===============================\n   -->\n   <records\n       interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      prefix="plone.bundles/plone-session-pseudo-css">\n+      prefix="plone.bundles/plone-session">\n+    <value key="enabled">True</value>\n+    <value key="jscompilation">++resource++plone.session.refreshsupport.js</value>\n     <!-- This is a pseudo CSS generating a link in the Head .\n          The way to trigger the session refresh should be refactored at some point.\n     -->\n-    <value key="enabled">True</value>\n     <value key="csscompilation">acl_users/session/refresh?session_refresh=true&amp;type=css&amp;minutes=5</value>\n-    <value key="last_compilation">2018-03-27 00:00:00</value>\n-    <value key="compile">False</value>\n     <value key="expression">python: member is not None</value>\n+    <value key="depends">jquery</value>\n+    <value key="load_async">False</value>\n+    <value key="load_defer">False</value>\n   </records>\n \n-  <records\n-      interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      prefix="plone.bundles/plone-session-js">\n-    <value key="enabled">True</value>\n-    <value key="jscompilation">++resource++plone.session.refreshsupport.js</value>\n-    <value key="last_compilation">2018-03-27 00:00:00</value>\n-    <value key="compile">False</value>\n-    <value key="depends">plone-logged-in</value>\n-    <value key="merge_with">logged-in</value>\n-  </records>\n-</registry>\n\\ No newline at end of file\n+</registry>\ndiff --git a/plone/session/profiles/remove-legacy-resources/cssregistry.xml b/plone/session/profiles/remove-legacy-resources/cssregistry.xml\ndeleted file mode 100644\nindex 629e2e8..0000000\n--- a/plone/session/profiles/remove-legacy-resources/cssregistry.xml\n+++ /dev/null\n@@ -1,7 +0,0 @@\n-<?xml version="1.0"?>\n-<object name="portal_css" meta_type="Stylesheets Registry">\n-    <stylesheet\n-        id="acl_users/session/refresh?session_refresh=true&amp;type=css&amp;minutes=5"\n-        remove="true"\n-        />\n-</object>\ndiff --git a/plone/session/profiles/remove-legacy-resources/jsregistry.xml b/plone/session/profiles/remove-legacy-resources/jsregistry.xml\ndeleted file mode 100644\nindex 5a754c7..0000000\n--- a/plone/session/profiles/remove-legacy-resources/jsregistry.xml\n+++ /dev/null\n@@ -1,7 +0,0 @@\n-<?xml version="1.0"?>\n-<object name="portal_javascripts" meta_type="JavaScripts Registry">\n-    <javascript\n-        id="++resource++plone.session.refreshsupport.js"\n-        remove="true"\n-        />\n-</object>\ndiff --git a/plone/session/profiles/remove-legacy-resources/metadata.xml b/plone/session/profiles/remove-legacy-resources/metadata.xml\ndeleted file mode 100644\nindex b22370d..0000000\n--- a/plone/session/profiles/remove-legacy-resources/metadata.xml\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-<?xml version="1.0"?>\n-<metadata>\n-  <version>1000</version>\n-</metadata>\ndiff --git a/plone/session/profiles/uninstall/registry.xml b/plone/session/profiles/uninstall/registry.xml\nindex bb91895..6dfe299 100644\n--- a/plone/session/profiles/uninstall/registry.xml\n+++ b/plone/session/profiles/uninstall/registry.xml\n@@ -3,14 +3,8 @@\n \n   <records\n       interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      prefix="plone.bundles/session-refresh-pseudo-css"\n+      prefix="plone.bundles/plone-session"\n       remove="true">\n   </records>\n \n-  <records\n-      interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      prefix="plone.bundles/session-refresh-js"\n-      remove="true">\n-  </records>\n-\n-</registry>\n\\ No newline at end of file\n+</registry>\ndiff --git a/plone/session/upgrades.py b/plone/session/upgrades.py\ndeleted file mode 100644\nindex 8da0c86..0000000\n--- a/plone/session/upgrades.py\n+++ /dev/null\n@@ -1,9 +0,0 @@\n-# -*- coding: utf-8 -*-\n-from Products.CMFCore.utils import getToolByName\n-\n-\n-def upgrade_1000_to_1001(context):\n-    # remove legacy registry, register in the new registry\n-    setup = getToolByName(context, \'portal_setup\')\n-    setup.runAllImportStepsFromProfile(\'plone.session:remove-legacy-resources\')\n-    setup.runAllImportStepsFromProfile(\'plone.session:default\')\ndiff --git a/plone/session/upgrades.zcml b/plone/session/upgrades.zcml\ndeleted file mode 100644\nindex 33194c0..0000000\n--- a/plone/session/upgrades.zcml\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-<configure\n-    xmlns:zope="http://namespaces.zope.org/zope"\n-    xmlns:browser="http://namespaces.zope.org/browser"\n-    xmlns:genericsetup="http://namespaces.zope.org/genericsetup">\n-\n-  <genericsetup:upgradeStep\n-      source="1000"\n-      destination="1001"\n-      title="Use new resource registry."\n-      description=""\n-      profile="plone.session:default"\n-      handler="plone.session.upgrades.upgrade_1000_to_1001"\n-  />\n-\n-</configure>\n'

