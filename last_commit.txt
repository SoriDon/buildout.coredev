Repository: plone.app.users


Branch: refs/heads/master
Date: 2018-05-03T14:57:34+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.users/commit/f6fae44b34326eec00f596697d8990610574a859

Move forgotten 'registered' template from Products.CMFPlone skins to here, were it belongs to

Files changed:
A plone/app/users/browser/registered.pt
A plone/app/users/browser/registered.py
M CHANGES.rst
M plone/app/users/browser/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 2b266f6..d2050d3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -16,6 +16,23 @@ Bug fixes:
 
 - Import ``activatePluginInterfaces`` from canonical location in PlonePAS.
   [maurits]
+- Move forgotten 'registered' template from Products.CMFPlone skins to here, were it belongs to.
+  [jensens]
+
+
+2.4.2 (2018-04-03)
+------------------
+
+Bug fixes:
+
+- Make ``IUserDataSchema.email`` field ``description`` translatable.
+  [jensens]
+
+
+2.4.1 (2018-02-05)
+------------------
+
+Bug fixes:
 
 - Provide the UserDataPanelAdapter for INavigationRoot, so @@personal-information
   is not broken with p.a.multilingual
diff --git a/plone/app/users/browser/configure.zcml b/plone/app/users/browser/configure.zcml
index 9f9b6c3..3a31117 100644
--- a/plone/app/users/browser/configure.zcml
+++ b/plone/app/users/browser/configure.zcml
@@ -21,6 +21,14 @@
       permission="cmf.AddPortalMember"
       />
 
+  <browser:page
+      name="registered"
+      for="plone.app.layout.navigation.interfaces.INavigationRoot"
+      class=".registered.RegisteredView"
+      template="registered.pt"
+      permission="cmf.AddPortalMember"
+      />
+
   <browser:page
       name="new-user"
       for="plone.app.layout.navigation.interfaces.INavigationRoot"
diff --git a/plone/app/users/browser/registered.pt b/plone/app/users/browser/registered.pt
new file mode 100644
index 0000000..af64f8e
--- /dev/null
+++ b/plone/app/users/browser/registered.pt
@@ -0,0 +1,102 @@
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
+      xmlns:tal="http://xml.zope.org/namespaces/tal"
+      xmlns:metal="http://xml.zope.org/namespaces/metal"
+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
+      metal:use-macro="context/main_template/macros/master"
+      i18n:domain="plone">
+<body>
+
+
+<metal:main fill-slot="main"
+     tal:define="auth nocall:context/acl_users/credentials_cookie_auth|nothing">
+
+    <div id="content-core" tal:condition="python: not auth" i18n:translate="registered_disabled">
+           Cookie authentication has been disabled.
+    </div>
+
+    <div tal:define="enable_user_pwd_choice python:context.portal_registry['plone.enable_user_pwd_choice']"
+         tal:omit-tag=""
+         tal:condition="python: auth">
+
+        <h1 class="documentFirstHeading"
+            i18n:translate="heading_welcome">
+            Welcome!
+        </h1>
+
+        <div class="documentDescription" i18n:translate="description_you_are_registered">
+            You have been registered.
+        </div>
+
+        <div id="content-core">
+            <p tal:condition="not: enable_user_pwd_choice"
+               i18n:translate="description_password_reset_or_registered">
+                You will receive an e-mail shortly containing a URL that will allow you to
+                set your password. When you receive this e-mail, please follow the link to
+                complete your registration process. NOTE: The password reset URL will expire
+                on <span tal:replace="view/expire_date" i18n:name="time"/>. If your
+                password reset request expires, you may use the "Forgot your password" link
+                to generate another password reset request.
+            </p>
+
+            <tal:block condition="enable_user_pwd_choice">
+                <p i18n:translate="description_you_can_log_on_now">
+                    Click the button to log in immediately.
+                </p>
+
+                <div class="portalMessage error pat-cookietrigger" style="display:none">
+                    <strong i18n:translate="">
+                        Error
+                    </strong>
+                    <span tal:omit-tag=""
+                        i18n:translate="enable_cookies_message_before_login">
+                        Cookies are not enabled. You must enable cookies before you can log in.
+                    </span>
+                </div>
+
+
+                <form action=""
+                      method="post"
+                      tal:define="form request/form;
+                                  username python: form.get('form.widgets.username') or form.get('form.username');
+                                  password python: form.get('form.widgets.password') or form.get('form.password');
+                                  ac_name auth/name_cookie|string:__ac_name;
+                                  ac_password auth/pw_cookie|string:__ac_password;
+                                  portal_url context/portal_url;"
+                      tal:attributes="action python:'%s/login_form' % portal_url">
+
+                     <input type="hidden" name="form.submitted" value="1" />
+                     <input type="hidden" name="js_enabled" id="js_enabled" value="0" />
+                     <input type="hidden" name="cookies_enabled" id="cookies_enabled" value="0" />
+                     <input type="hidden" name="login_name" id="login_name" value="" />
+                     <input type="hidden" name="pwd_empty" id="pwd_empty" value="0" />
+
+                    <input type="hidden"
+                           name="came_from"
+                           value=""
+                           tal:attributes="value request/came_from|nothing;" />
+                    <input type="hidden"
+                           name="ac_name"
+                           value=""
+                           tal:attributes="id ac_name;
+                                           name ac_name;
+                                           value username;" />
+                    <input type="hidden"
+                           name="ac_password"
+                           value=""
+                           tal:attributes="name ac_password;
+                                           id ac_password;
+                                           value password;" />
+                    <input class="standalone"
+                           type="submit"
+                           value="Log in"
+                           i18n:attributes="value label_log_in;"
+                           />
+                </form>
+            </tal:block>
+        </div>
+
+    </div>
+
+</metal:main>
+</body>
+</html>
diff --git a/plone/app/users/browser/registered.py b/plone/app/users/browser/registered.py
new file mode 100644
index 0000000..f4ca723
--- /dev/null
+++ b/plone/app/users/browser/registered.py
@@ -0,0 +1,16 @@
+# -*- coding: utf-8 -*-
+from Products.CMFCore.utils import getToolByName
+from Products.Five import BrowserView
+from zope.component import getMultiAdapter
+
+import datetime
+
+
+class RegisteredView(BrowserView):
+
+    def expire_date(self):
+        ppr = getToolByName(self.context, 'portal_password_reset')
+        expire_length = datetime.timedelta(days=ppr.getExpirationTimeout())
+        expiration_date = datetime.datetime.now() + expire_length
+        ploneview = getMultiAdapter((self.context, self.request), name='plone')
+        return ploneview.toLocalizedTime(expiration_date, long_format=1)


