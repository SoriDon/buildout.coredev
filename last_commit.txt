Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2024-01-23T16:59:16+01:00
Author: Georg Bernhard (gogobd) <g.bernhard@akbild.ac.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/ca370828eed17ba6a413336bb581e7d2df49ad73

Implemented better selection for path preset

Files changed:
M src/plone/app/multilingual/browser/interfaces.py

b'diff --git a/src/plone/app/multilingual/browser/interfaces.py b/src/plone/app/multilingual/browser/interfaces.py\nindex 9cb6650b..0ed6f1b3 100644\n--- a/src/plone/app/multilingual/browser/interfaces.py\n+++ b/src/plone/app/multilingual/browser/interfaces.py\n@@ -1,6 +1,7 @@\n from Acquisition import aq_parent\n from plone.app.multilingual import _\n from plone.app.multilingual.browser.vocabularies import untranslated_languages\n+from plone.app.multilingual.interfaces import ITranslationManager\n from plone.app.z3cform.widget import RelatedItemsFieldWidget\n from plone.autoform import directives\n from plone.autoform.interfaces import IFormFieldProvider\n@@ -17,11 +18,14 @@\n \n \n def make_relation_root_path(context):\n-    ctx = getSite()\n-    if not IPloneSiteRoot.providedBy(ctx):\n-        ctx = aq_parent(ctx)\n-    return "/".join(ctx.getPhysicalPath())\n-\n+    current_object = context\n+    target_language = context.REQUEST.get(\'language\')\n+    closest_translation = None\n+    while closest_translation is None:\n+        current_object = current_object.aq_parent\n+        tm = ITranslationManager(current_object)\n+        closest_translation = tm.get_translation(target_language)\n+    return "/".join(closest_translation.getPhysicalPath())\n \n class IMultilingualLayer(interface.Interface):\n     """browser layer"""\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2024-01-23T18:44:03+01:00
Author: gogobd (gogobd) <gogo@bluedynamics.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/cd0d948a4c550d7238b14d160a54d18ccbd36c18

Linting, removing obsolete imports

Files changed:
A news/445.feature
M src/plone/app/multilingual/browser/interfaces.py

b'diff --git a/news/445.feature b/news/445.feature\nnew file mode 100644\nindex 000000000..c1396406e\n--- /dev/null\n+++ b/news/445.feature\n@@ -0,0 +1,2 @@\n+Implement a more reasonable default for "connect translations" dialog.\n+[gogobd]\ndiff --git a/src/plone/app/multilingual/browser/interfaces.py b/src/plone/app/multilingual/browser/interfaces.py\nindex 0ed6f1b30..5de36ab3f 100644\n--- a/src/plone/app/multilingual/browser/interfaces.py\n+++ b/src/plone/app/multilingual/browser/interfaces.py\n@@ -1,25 +1,22 @@\n-from Acquisition import aq_parent\n from plone.app.multilingual import _\n from plone.app.multilingual.browser.vocabularies import untranslated_languages\n from plone.app.multilingual.interfaces import ITranslationManager\n from plone.app.z3cform.widget import RelatedItemsFieldWidget\n from plone.autoform import directives\n from plone.autoform.interfaces import IFormFieldProvider\n-from plone.base.interfaces import IPloneSiteRoot\n from plone.supermodel import model\n from z3c.relationfield.schema import RelationChoice\n from zope import interface\n from zope import schema\n from zope.browsermenu.interfaces import IBrowserMenu\n from zope.browsermenu.interfaces import IBrowserSubMenuItem\n-from zope.component.hooks import getSite\n from zope.interface import provider\n from zope.schema.interfaces import IContextAwareDefaultFactory\n \n \n def make_relation_root_path(context):\n     current_object = context\n-    target_language = context.REQUEST.get(\'language\')\n+    target_language = context.REQUEST.get("language")\n     closest_translation = None\n     while closest_translation is None:\n         current_object = current_object.aq_parent\n@@ -27,6 +24,7 @@ def make_relation_root_path(context):\n         closest_translation = tm.get_translation(target_language)\n     return "/".join(closest_translation.getPhysicalPath())\n \n+\n class IMultilingualLayer(interface.Interface):\n     """browser layer"""\n \n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2024-01-25T16:20:34+01:00
Author: gogobd (gogobd) <gogo@bluedynamics.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/75b02b4c642f607f0d2b8a008615fda435a697e6

Added better checks and bells and whistles

Files changed:
M src/plone/app/multilingual/browser/interfaces.py

b'diff --git a/src/plone/app/multilingual/browser/interfaces.py b/src/plone/app/multilingual/browser/interfaces.py\nindex 5de36ab3..8977a0e3 100644\n--- a/src/plone/app/multilingual/browser/interfaces.py\n+++ b/src/plone/app/multilingual/browser/interfaces.py\n@@ -1,27 +1,50 @@\n+from AccessControl import getSecurityManager\n from plone.app.multilingual import _\n from plone.app.multilingual.browser.vocabularies import untranslated_languages\n from plone.app.multilingual.interfaces import ITranslationManager\n from plone.app.z3cform.widget import RelatedItemsFieldWidget\n from plone.autoform import directives\n from plone.autoform.interfaces import IFormFieldProvider\n+from plone.base.interfaces import IPloneSiteRoot\n from plone.supermodel import model\n from z3c.relationfield.schema import RelationChoice\n from zope import interface\n from zope import schema\n from zope.browsermenu.interfaces import IBrowserMenu\n from zope.browsermenu.interfaces import IBrowserSubMenuItem\n+from zope.component.hooks import getSite\n from zope.interface import provider\n from zope.schema.interfaces import IContextAwareDefaultFactory\n \n \n def make_relation_root_path(context):\n+    security_manager = getSecurityManager()\n+    site = getSite()\n+\n+    # This should not happen, there\'s no View permission for the current object\n+    if not security_manager.checkPermission("View", context):\n+        return "/".join(site.getPhysicalPath())\n+\n+    # Try to find the "closest" object in the target language\n     current_object = context\n-    target_language = context.REQUEST.get("language")\n+    target_language = context.REQUEST.get("language", None)\n+\n+    if target_language is None:\n+        return "/".join(site.getPhysicalPath())\n+\n     closest_translation = None\n     while closest_translation is None:\n         current_object = current_object.aq_parent\n-        tm = ITranslationManager(current_object)\n-        closest_translation = tm.get_translation(target_language)\n+        translation_manager = ITranslationManager(current_object)\n+        closest_translation = translation_manager.get_translation(target_language)\n+        if IPloneSiteRoot.providedBy(closest_translation):\n+            break\n+\n+    # If the closest translation has no View permission default to old behavior\n+    if not security_manager.checkPermission("View", closest_translation):\n+        return "/".join(site.getPhysicalPath())\n+\n+    # Everything went well, return the translation\'s path\n     return "/".join(closest_translation.getPhysicalPath())\n \n \n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2024-01-26T12:26:33+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/a52aa3a0cf498940058dbbadccea3de86e971b1a

Merge pull request #446 from plone/better-folder-preset

Implemented better selection for path preset

Files changed:
A news/445.feature
M src/plone/app/multilingual/browser/interfaces.py

b'diff --git a/news/445.feature b/news/445.feature\nnew file mode 100644\nindex 000000000..c1396406e\n--- /dev/null\n+++ b/news/445.feature\n@@ -0,0 +1,2 @@\n+Implement a more reasonable default for "connect translations" dialog.\n+[gogobd]\ndiff --git a/src/plone/app/multilingual/browser/interfaces.py b/src/plone/app/multilingual/browser/interfaces.py\nindex 9cb6650bb..8977a0e34 100644\n--- a/src/plone/app/multilingual/browser/interfaces.py\n+++ b/src/plone/app/multilingual/browser/interfaces.py\n@@ -1,6 +1,7 @@\n-from Acquisition import aq_parent\n+from AccessControl import getSecurityManager\n from plone.app.multilingual import _\n from plone.app.multilingual.browser.vocabularies import untranslated_languages\n+from plone.app.multilingual.interfaces import ITranslationManager\n from plone.app.z3cform.widget import RelatedItemsFieldWidget\n from plone.autoform import directives\n from plone.autoform.interfaces import IFormFieldProvider\n@@ -17,10 +18,34 @@\n \n \n def make_relation_root_path(context):\n-    ctx = getSite()\n-    if not IPloneSiteRoot.providedBy(ctx):\n-        ctx = aq_parent(ctx)\n-    return "/".join(ctx.getPhysicalPath())\n+    security_manager = getSecurityManager()\n+    site = getSite()\n+\n+    # This should not happen, there\'s no View permission for the current object\n+    if not security_manager.checkPermission("View", context):\n+        return "/".join(site.getPhysicalPath())\n+\n+    # Try to find the "closest" object in the target language\n+    current_object = context\n+    target_language = context.REQUEST.get("language", None)\n+\n+    if target_language is None:\n+        return "/".join(site.getPhysicalPath())\n+\n+    closest_translation = None\n+    while closest_translation is None:\n+        current_object = current_object.aq_parent\n+        translation_manager = ITranslationManager(current_object)\n+        closest_translation = translation_manager.get_translation(target_language)\n+        if IPloneSiteRoot.providedBy(closest_translation):\n+            break\n+\n+    # If the closest translation has no View permission default to old behavior\n+    if not security_manager.checkPermission("View", closest_translation):\n+        return "/".join(site.getPhysicalPath())\n+\n+    # Everything went well, return the translation\'s path\n+    return "/".join(closest_translation.getPhysicalPath())\n \n \n class IMultilingualLayer(interface.Interface):\n'

