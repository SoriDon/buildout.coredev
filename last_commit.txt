Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-09-19T17:07:22+02:00
Author: Gagaro (Gagaro) <gagaro42@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/b212e10522c9262271de7b02ee4d994163bfeb52

fix: Remove site path from path in show_inactive in catalog search

Files changed:
M CHANGES.rst
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c5576c879..aa85c7eb9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,6 +18,9 @@ New features:
 
 Bug fixes:
 
+- Remove site path from path in show_inactive in catalog search
+  [Gagaro]
+
 - Don't raise Unauthorized on show_inactive check in catalog search
   [tomgross]
 
diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py
index f421e9e02..d6cf97703 100644
--- a/Products/CMFPlone/CatalogTool.py
+++ b/Products/CMFPlone/CatalogTool.py
@@ -415,7 +415,8 @@ def allow_inactive(self, query_kw):
         for path in list(paths):
             path = path.encode('utf-8')  # paths must not be unicode
             try:
-                parts = path.split('/')
+                site_path = '/'.join(site.getPhysicalPath())
+                parts = path[len(site_path) + 1:].split('/')
                 parent = site.unrestrictedTraverse('/'.join(parts[:-1]))
                 objs.append(parent.restrictedTraverse(parts[-1]))
             except (KeyError, AttributeError, Unauthorized):
diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py
index ffe06dae0..a9559b760 100644
--- a/Products/CMFPlone/tests/testCatalogTool.py
+++ b/Products/CMFPlone/tests/testCatalogTool.py
@@ -1170,6 +1170,35 @@ def testExpiredWithoutPermissionOnSubpath(self):
         res = self.catalog(**query)
         self.assertResults(res, expected_result)
 
+    def testExpiredWithSameNameAsSite(self):
+        # Create an expired folder with the same name as the site
+        setRoles(self.portal, TEST_USER_ID, ['Manager'])
+        self.portal.invokeFactory('Folder', id=self.portal.id)
+
+        # Add the AccessInactivePortalContent permission in the plone folder
+        # The user should NOT have this permission in self.folder
+        self.portal.plone.manage_role('Member', [AccessInactivePortalContent])
+
+        # Expire a document
+        self.folder.doc.setExpirationDate(DateTime(2000, 12, 31))
+        self.folder.doc.reindexObject()
+        self.nofx()
+
+        # Inactive content isn't shown without the required permission.
+        expected_result = [content for content in base_content if content != 'doc'] + ['plone']
+
+        # Login as unprivileged user
+        self.login(user2)
+
+        # Path is the site's one
+        query = {
+            'path': '/'.join(self.portal.getPhysicalPath())
+        }
+        res = self.catalog.searchResults(**query)
+        self.assertResults(res, expected_result)
+        res = self.catalog(**query)
+        self.assertResults(res, expected_result)
+
     def testSearchResultsWithAdditionalExpiryFilter(self):
         # For this test we want the expires and effective indices in place,
         # let's make sure everything still works


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-09-19T18:10:23+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/722dbb22924912e75872fedccb3c304421b0f1b8

Merge pull request #2149 from plone/fix-catalog-allow-inactive-path

fix: Remove site path from path in show_inactive in catalog search

Files changed:
M CHANGES.rst
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c5576c879..aa85c7eb9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,6 +18,9 @@ New features:
 
 Bug fixes:
 
+- Remove site path from path in show_inactive in catalog search
+  [Gagaro]
+
 - Don't raise Unauthorized on show_inactive check in catalog search
   [tomgross]
 
diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py
index f421e9e02..d6cf97703 100644
--- a/Products/CMFPlone/CatalogTool.py
+++ b/Products/CMFPlone/CatalogTool.py
@@ -415,7 +415,8 @@ def allow_inactive(self, query_kw):
         for path in list(paths):
             path = path.encode('utf-8')  # paths must not be unicode
             try:
-                parts = path.split('/')
+                site_path = '/'.join(site.getPhysicalPath())
+                parts = path[len(site_path) + 1:].split('/')
                 parent = site.unrestrictedTraverse('/'.join(parts[:-1]))
                 objs.append(parent.restrictedTraverse(parts[-1]))
             except (KeyError, AttributeError, Unauthorized):
diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py
index ffe06dae0..a9559b760 100644
--- a/Products/CMFPlone/tests/testCatalogTool.py
+++ b/Products/CMFPlone/tests/testCatalogTool.py
@@ -1170,6 +1170,35 @@ def testExpiredWithoutPermissionOnSubpath(self):
         res = self.catalog(**query)
         self.assertResults(res, expected_result)
 
+    def testExpiredWithSameNameAsSite(self):
+        # Create an expired folder with the same name as the site
+        setRoles(self.portal, TEST_USER_ID, ['Manager'])
+        self.portal.invokeFactory('Folder', id=self.portal.id)
+
+        # Add the AccessInactivePortalContent permission in the plone folder
+        # The user should NOT have this permission in self.folder
+        self.portal.plone.manage_role('Member', [AccessInactivePortalContent])
+
+        # Expire a document
+        self.folder.doc.setExpirationDate(DateTime(2000, 12, 31))
+        self.folder.doc.reindexObject()
+        self.nofx()
+
+        # Inactive content isn't shown without the required permission.
+        expected_result = [content for content in base_content if content != 'doc'] + ['plone']
+
+        # Login as unprivileged user
+        self.login(user2)
+
+        # Path is the site's one
+        query = {
+            'path': '/'.join(self.portal.getPhysicalPath())
+        }
+        res = self.catalog.searchResults(**query)
+        self.assertResults(res, expected_result)
+        res = self.catalog(**query)
+        self.assertResults(res, expected_result)
+
     def testSearchResultsWithAdditionalExpiryFilter(self):
         # For this test we want the expires and effective indices in place,
         # let's make sure everything still works


