Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-10-02T10:25:01+02:00
Author: Manuel Reinhardt (reinhardt) <reinhardt@syslab.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/1474057e4047ee20e56f3d6802f66d9fa7aa0428

Use human_readable_size from Products.CMFPlone.utils
to replace getObjSize script. #1801

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/file.py
M plone/app/contenttypes/indexers.py
M plone/app/contenttypes/tests/test_indexes.py
M plone/app/contenttypes/utils.py
D plone/app/contenttypes/tests/test_utils.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex bd38fba8..d1fce4b0 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -25,6 +25,9 @@ New features:\n   the factories are now working properly and can be reconfigured\n   wherever you might need them. ZCA FTW!\n   [iham]\n+- Use human_readable_size from Products.CMFPlone.utils to replace getObjSize\n+  script. #1801\n+  [reinhardt]\n \n Bug fixes:\n \ndiff --git a/plone/app/contenttypes/browser/file.py b/plone/app/contenttypes/browser/file.py\nindex cbe05ddd..ce09ea38 100644\n--- a/plone/app/contenttypes/browser/file.py\n+++ b/plone/app/contenttypes/browser/file.py\n@@ -1,6 +1,6 @@\n # -*- coding: utf-8 -*-\n from plone.app.contenttypes.browser.utils import Utils\n-from plone.app.contenttypes.utils import human_readable_size\n+from Products.CMFPlone.utils import human_readable_size\n \n \n class FileView(Utils):\ndiff --git a/plone/app/contenttypes/indexers.py b/plone/app/contenttypes/indexers.py\nindex afea3e15..a2ba27fb 100644\n--- a/plone/app/contenttypes/indexers.py\n+++ b/plone/app/contenttypes/indexers.py\n@@ -16,6 +16,7 @@\n from plone.rfc822.interfaces import IPrimaryFieldInfo\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.utils import safe_unicode\n+from Products.CMFPlone.utils import human_readable_size\n from Products.PortalTransforms.libtransforms.utils import MissingBinary\n from ZODB.POSException import ConflictError\n \n@@ -165,7 +166,7 @@ def getObjSize_image(obj):\n             u\'please reindex!\'.format(obj.absolute_url())\n         )\n         return\n-    return obj.getObjSize(None, primary_field_info.value.size)\n+    return human_readable_size(primary_field_info.value.size)\n \n \n @indexer(IFile)\n@@ -178,7 +179,7 @@ def getObjSize_file(obj):\n             u\'please reindex!\'.format(obj.absolute_url())\n         )\n         return\n-    return obj.getObjSize(None, primary_field_info.value.size)\n+    return human_readable_size(primary_field_info.value.size)\n \n \n @indexer(IDexterityContent)\ndiff --git a/plone/app/contenttypes/tests/test_indexes.py b/plone/app/contenttypes/tests/test_indexes.py\nindex d703584f..f8181db6 100644\n--- a/plone/app/contenttypes/tests/test_indexes.py\n+++ b/plone/app/contenttypes/tests/test_indexes.py\n@@ -370,9 +370,8 @@ def test_getobjsize_image(self):\n             path=\'/plone/folder/image\',\n         ))\n \n-        # XXX: Do we still rely on getObjSize in portal_skins/plone_scripts?\n         self.assertEqual(\n-            self.portal.getObjSize(None, primary_field_info.value.size),\n+            \'5.0 KB\',\n             brains[0].getObjSize,\n         )\n \n@@ -391,8 +390,7 @@ def test_getobjsize_file(self):\n             path=\'/plone/folder/file\',\n         ))\n \n-        # XXX: Do we still rely on getObjSize in portal_skins/plone_scripts?\n         self.assertEqual(\n-            self.portal.getObjSize(None, primary_field_info.value.size),\n+            \'5.0 KB\',\n             brains[0].getObjSize,\n         )\ndiff --git a/plone/app/contenttypes/tests/test_utils.py b/plone/app/contenttypes/tests/test_utils.py\ndeleted file mode 100644\nindex 91befe16..00000000\n--- a/plone/app/contenttypes/tests/test_utils.py\n+++ /dev/null\n@@ -1,23 +0,0 @@\n-# -*- coding: utf-8 -*-\n-from plone.app.contenttypes.utils import human_readable_size\n-\n-import unittest\n-\n-\n-class PloneAppContenttypesUtilsTestCase(unittest.TestCase):\n-\n-    def test_human_readable_size(self):\n-        self.assertEqual(human_readable_size(0), \'0 B\')\n-        self.assertEqual(human_readable_size(1), \'1 B\')\n-        size = 1000\n-        self.assertEqual(human_readable_size(1000), \'1000 B\')\n-        size += 24\n-        self.assertEqual(human_readable_size(size), \'1.0 KB\')\n-        size += 512\n-        self.assertEqual(human_readable_size(size), \'1.5 KB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1.5 MB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1.5 GB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1536.0 GB\')\ndiff --git a/plone/app/contenttypes/utils.py b/plone/app/contenttypes/utils.py\nindex 39858ef5..262fac81 100644\n--- a/plone/app/contenttypes/utils.py\n+++ b/plone/app/contenttypes/utils.py\n@@ -42,18 +42,3 @@ def replace_link_variables_by_paths(context, url):\n def _replace_variable_by_path(url, variable, obj):\n     path = \'/\'.join(obj.getPhysicalPath())\n     return url.replace(variable, path)\n-\n-\n-def human_readable_size(size):\n-    """Return human readable size.\n-    Based on https://stackoverflow.com/a/1094933\n-    """\n-    if size < 1024:\n-        return \'{size} B\'.format(size=size)\n-\n-    for unit in (\'KB\', \'MB\', \'GB\'):\n-        size /= 1024.0\n-        if size < 1024.0:\n-            return \'{size:.1f} {unit}\'.format(size=size, unit=unit)\n-\n-    return \'{size:.1f} GB\'.format(size=size)\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-10-02T14:27:03+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/755e85ad6de570efd969b543d94e84db0571679f

Merge pull request #493 from plone/1801-human-readable-size

Use human_readable_size from Products.CMFPlone.utils

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/file.py
M plone/app/contenttypes/indexers.py
M plone/app/contenttypes/tests/test_indexes.py
M plone/app/contenttypes/utils.py
D plone/app/contenttypes/tests/test_utils.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 72da4fcf..3a51f5f6 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -25,6 +25,9 @@ New features:\n   the factories are now working properly and can be reconfigured\n   wherever you might need them. ZCA FTW!\n   [iham]\n+- Use human_readable_size from Products.CMFPlone.utils to replace getObjSize\n+  script. #1801\n+  [reinhardt]\n \n Bug fixes:\n \ndiff --git a/plone/app/contenttypes/browser/file.py b/plone/app/contenttypes/browser/file.py\nindex cbe05ddd..ce09ea38 100644\n--- a/plone/app/contenttypes/browser/file.py\n+++ b/plone/app/contenttypes/browser/file.py\n@@ -1,6 +1,6 @@\n # -*- coding: utf-8 -*-\n from plone.app.contenttypes.browser.utils import Utils\n-from plone.app.contenttypes.utils import human_readable_size\n+from Products.CMFPlone.utils import human_readable_size\n \n \n class FileView(Utils):\ndiff --git a/plone/app/contenttypes/indexers.py b/plone/app/contenttypes/indexers.py\nindex afea3e15..a2ba27fb 100644\n--- a/plone/app/contenttypes/indexers.py\n+++ b/plone/app/contenttypes/indexers.py\n@@ -16,6 +16,7 @@\n from plone.rfc822.interfaces import IPrimaryFieldInfo\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.utils import safe_unicode\n+from Products.CMFPlone.utils import human_readable_size\n from Products.PortalTransforms.libtransforms.utils import MissingBinary\n from ZODB.POSException import ConflictError\n \n@@ -165,7 +166,7 @@ def getObjSize_image(obj):\n             u\'please reindex!\'.format(obj.absolute_url())\n         )\n         return\n-    return obj.getObjSize(None, primary_field_info.value.size)\n+    return human_readable_size(primary_field_info.value.size)\n \n \n @indexer(IFile)\n@@ -178,7 +179,7 @@ def getObjSize_file(obj):\n             u\'please reindex!\'.format(obj.absolute_url())\n         )\n         return\n-    return obj.getObjSize(None, primary_field_info.value.size)\n+    return human_readable_size(primary_field_info.value.size)\n \n \n @indexer(IDexterityContent)\ndiff --git a/plone/app/contenttypes/tests/test_indexes.py b/plone/app/contenttypes/tests/test_indexes.py\nindex d703584f..f8181db6 100644\n--- a/plone/app/contenttypes/tests/test_indexes.py\n+++ b/plone/app/contenttypes/tests/test_indexes.py\n@@ -370,9 +370,8 @@ def test_getobjsize_image(self):\n             path=\'/plone/folder/image\',\n         ))\n \n-        # XXX: Do we still rely on getObjSize in portal_skins/plone_scripts?\n         self.assertEqual(\n-            self.portal.getObjSize(None, primary_field_info.value.size),\n+            \'5.0 KB\',\n             brains[0].getObjSize,\n         )\n \n@@ -391,8 +390,7 @@ def test_getobjsize_file(self):\n             path=\'/plone/folder/file\',\n         ))\n \n-        # XXX: Do we still rely on getObjSize in portal_skins/plone_scripts?\n         self.assertEqual(\n-            self.portal.getObjSize(None, primary_field_info.value.size),\n+            \'5.0 KB\',\n             brains[0].getObjSize,\n         )\ndiff --git a/plone/app/contenttypes/tests/test_utils.py b/plone/app/contenttypes/tests/test_utils.py\ndeleted file mode 100644\nindex 91befe16..00000000\n--- a/plone/app/contenttypes/tests/test_utils.py\n+++ /dev/null\n@@ -1,23 +0,0 @@\n-# -*- coding: utf-8 -*-\n-from plone.app.contenttypes.utils import human_readable_size\n-\n-import unittest\n-\n-\n-class PloneAppContenttypesUtilsTestCase(unittest.TestCase):\n-\n-    def test_human_readable_size(self):\n-        self.assertEqual(human_readable_size(0), \'0 B\')\n-        self.assertEqual(human_readable_size(1), \'1 B\')\n-        size = 1000\n-        self.assertEqual(human_readable_size(1000), \'1000 B\')\n-        size += 24\n-        self.assertEqual(human_readable_size(size), \'1.0 KB\')\n-        size += 512\n-        self.assertEqual(human_readable_size(size), \'1.5 KB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1.5 MB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1.5 GB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1536.0 GB\')\ndiff --git a/plone/app/contenttypes/utils.py b/plone/app/contenttypes/utils.py\nindex 39858ef5..262fac81 100644\n--- a/plone/app/contenttypes/utils.py\n+++ b/plone/app/contenttypes/utils.py\n@@ -42,18 +42,3 @@ def replace_link_variables_by_paths(context, url):\n def _replace_variable_by_path(url, variable, obj):\n     path = \'/\'.join(obj.getPhysicalPath())\n     return url.replace(variable, path)\n-\n-\n-def human_readable_size(size):\n-    """Return human readable size.\n-    Based on https://stackoverflow.com/a/1094933\n-    """\n-    if size < 1024:\n-        return \'{size} B\'.format(size=size)\n-\n-    for unit in (\'KB\', \'MB\', \'GB\'):\n-        size /= 1024.0\n-        if size < 1024.0:\n-            return \'{size:.1f} {unit}\'.format(size=size, unit=unit)\n-\n-    return \'{size:.1f} GB\'.format(size=size)\n'

