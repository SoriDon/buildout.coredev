Repository: plone.restapi


Branch: refs/heads/master
Date: 2023-04-07T13:49:02+02:00
Author: Katja SÃ¼ss (ksuess) <k.suess@rohberg.ch>
Commit: https://github.com/plone/plone.restapi/commit/c39ca4dbac15921ecc729cbec5b69a1f2a0a6111

Add UID to relationvalue_converter summary (#1605)

* Add UID to relationvalue_converter summary

Support RelationList field with named StaticCatalogVocabulary and SelectWidget

* Fix tests: UID

---------

Co-authored-by: Timo Stollenwerk &lt;tisto@users.noreply.github.com&gt;

Files changed:
A news/1605.feature
M src/plone/restapi/serializer/relationfield.py
M src/plone/restapi/tests/test_content_get.py
M src/plone/restapi/tests/test_dxfield_serializer.py
M src/plone/restapi/tests/test_serializer_converters.py

b'diff --git a/news/1605.feature b/news/1605.feature\nnew file mode 100644\nindex 000000000..b005cd793\n--- /dev/null\n+++ b/news/1605.feature\n@@ -0,0 +1 @@\n+Add UID to relationvalue_converter summary. @ksuess\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/serializer/relationfield.py b/src/plone/restapi/serializer/relationfield.py\nindex 931453fbe..28483ce42 100644\n--- a/src/plone/restapi/serializer/relationfield.py\n+++ b/src/plone/restapi/serializer/relationfield.py\n@@ -18,9 +18,9 @@\n @implementer(IJsonCompatible)\n def relationvalue_converter(value):\n     if value.to_object:\n-        summary = getMultiAdapter(\n-            (value.to_object, getRequest()), ISerializeToJsonSummary\n-        )()\n+        request = getRequest()\n+        request.form["metadata_fields"] = ["UID"]\n+        summary = getMultiAdapter((value.to_object, request), ISerializeToJsonSummary)()\n         return json_compatible(summary)\n \n \ndiff --git a/src/plone/restapi/tests/test_content_get.py b/src/plone/restapi/tests/test_content_get.py\nindex 0bd9e0cde..34cd70d13 100644\n--- a/src/plone/restapi/tests/test_content_get.py\n+++ b/src/plone/restapi/tests/test_content_get.py\n@@ -128,6 +128,7 @@ def test_get_content_includes_related_items(self):\n                 {\n                     "@id": self.portal_url + "/folder1/folder2/doc2",\n                     "@type": "Document",\n+                    "UID": self.portal.folder1.folder2.doc2.UID(),\n                     "description": "",\n                     "review_state": "published",\n                     "title": "My Document 2",\n@@ -166,6 +167,7 @@ def test_get_content_related_items_without_workflow(self):\n                 {\n                     "@id": self.portal_url + "/imagewf",\n                     "@type": "Image",\n+                    "UID": self.portal.imagewf.UID(),\n                     "description": "This is an image",\n                     "review_state": None,\n                     "title": "Image without workflow",\ndiff --git a/src/plone/restapi/tests/test_dxfield_serializer.py b/src/plone/restapi/tests/test_dxfield_serializer.py\nindex 6c386ece6..851d48cdd 100644\n--- a/src/plone/restapi/tests/test_dxfield_serializer.py\n+++ b/src/plone/restapi/tests/test_dxfield_serializer.py\n@@ -273,6 +273,7 @@ def test_relationchoice_field_serialization_returns_summary_dict(self):\n             {\n                 "@id": "http://nohost/plone/doc2",\n                 "@type": "DXTestDocument",\n+                "UID": doc2.UID(),\n                 "title": "Referenceable Document",\n                 "description": "Description 2",\n                 "review_state": "private",\n@@ -304,6 +305,7 @@ def test_relationlist_field_serialization_returns_list(self):\n                 {\n                     "@id": "http://nohost/plone/doc2",\n                     "@type": "DXTestDocument",\n+                    "UID": doc2.UID(),\n                     "title": "Referenceable Document",\n                     "description": "Description 2",\n                     "review_state": "private",\n@@ -311,6 +313,7 @@ def test_relationlist_field_serialization_returns_list(self):\n                 {\n                     "@id": "http://nohost/plone/doc3",\n                     "@type": "DXTestDocument",\n+                    "UID": doc3.UID(),\n                     "title": "Referenceable Document",\n                     "description": "Description 3",\n                     "review_state": "private",\ndiff --git a/src/plone/restapi/tests/test_serializer_converters.py b/src/plone/restapi/tests/test_serializer_converters.py\nindex c3f7d8383..6f9c1cf30 100644\n--- a/src/plone/restapi/tests/test_serializer_converters.py\n+++ b/src/plone/restapi/tests/test_serializer_converters.py\n@@ -203,6 +203,7 @@ def test_relation_value(self):\n                 "@id": "http://nohost/plone/doc1",\n                 "@type": "DXTestDocument",\n                 "title": "Document 1",\n+                "UID": doc1.UID(),\n                 "description": "Description",\n                 "review_state": "private",\n             },\n'

