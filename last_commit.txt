Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-06-21T19:12:08+02:00
Author: Janina (wkbkhard) <hard@werkbank.de>
Commit: https://github.com/plone/plone.restapi/commit/0052a5694ac1dcb75a27b6539a8066a51ea23948

Effective Date Not Set Properly in Volto #761

Files changed:
M src/plone/restapi/services/workflow/transition.py

b"diff --git a/src/plone/restapi/services/workflow/transition.py b/src/plone/restapi/services/workflow/transition.py\nindex 05cfb0ee..4897b03d 100644\n--- a/src/plone/restapi/services/workflow/transition.py\n+++ b/src/plone/restapi/services/workflow/transition.py\n@@ -16,6 +16,7 @@\n from zope.interface import implementer\n from zope.publisher.interfaces import IPublishTraverse\n from zope.publisher.interfaces import NotFound\n+from DateTime import DateTime\n \n import plone.protect.interfaces\n \n@@ -105,6 +106,10 @@ def recurse_transition(\n                 )\n                 deserializer(data=publication_dates)\n \n+            if obj.EffectiveDate() == 'None':\n+                obj.setEffectiveDate(DateTime())\n+                obj.reindexObject()\n+\n             self.wftool.doActionFor(obj, self.transition, comment=comment)\n             if include_children and IFolderish.providedBy(obj):\n                 self.recurse_transition(\n"

Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-06-21T20:48:21+02:00
Author: Janina (wkbkhard) <hard@werkbank.de>
Commit: https://github.com/plone/plone.restapi/commit/0be3489f99c8bcdf89f8a2c9f0dcec40441ca708

Set effective_date and reindex obj on workflow transitions

Files changed:
A news/760.bugfix
M src/plone/restapi/services/workflow/transition.py
M src/plone/restapi/tests/test_workflow.py

b'diff --git a/news/760.bugfix b/news/760.bugfix\nnew file mode 100644\nindex 00000000..6736bd21\n--- /dev/null\n+++ b/news/760.bugfix\n@@ -0,0 +1 @@\n+Set effective_date and reindex obj on workflow transitions. [wkbkhard]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/services/workflow/transition.py b/src/plone/restapi/services/workflow/transition.py\nindex 05cfb0ee..4897b03d 100644\n--- a/src/plone/restapi/services/workflow/transition.py\n+++ b/src/plone/restapi/services/workflow/transition.py\n@@ -16,6 +16,7 @@\n from zope.interface import implementer\n from zope.publisher.interfaces import IPublishTraverse\n from zope.publisher.interfaces import NotFound\n+from DateTime import DateTime\n \n import plone.protect.interfaces\n \n@@ -105,6 +106,10 @@ def recurse_transition(\n                 )\n                 deserializer(data=publication_dates)\n \n+            if obj.EffectiveDate() == \'None\':\n+                obj.setEffectiveDate(DateTime())\n+                obj.reindexObject()\n+\n             self.wftool.doActionFor(obj, self.transition, comment=comment)\n             if include_children and IFolderish.providedBy(obj):\n                 self.recurse_transition(\ndiff --git a/src/plone/restapi/tests/test_workflow.py b/src/plone/restapi/tests/test_workflow.py\nindex 659e530f..85b9e278 100644\n--- a/src/plone/restapi/tests/test_workflow.py\n+++ b/src/plone/restapi/tests/test_workflow.py\n@@ -1,4 +1,5 @@\n # -*- coding: utf-8 -*-\n+from DateTime import DateTime\n from Products.CMFCore.utils import getToolByName\n from ZPublisher.pubevents import PubStart\n from base64 import b64encode\n@@ -126,6 +127,15 @@ def test_transition_action_succeeds(self):\n             u"published", self.wftool.getInfoFor(self.portal.doc1, u"review_state")\n         )\n \n+    def test_transition_action_succeeds_changes_effective(self):\n+        doc1 = self.portal.doc1\n+        self.assertEqual(doc1.effective_date, None)\n+        now = DateTime()\n+        service = self.traverse(\'/plone/doc1/@workflow/publish\')\n+        service.reply()\n+        self.assertTrue(isinstance(doc1.effective_date, DateTime))\n+        self.assertTrue(doc1.effective_date >= now)\n+\n     def test_calling_endpoint_without_transition_gives_400(self):\n         service = self.traverse("/plone/doc1/@workflow")\n         res = service.reply()\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-06-21T20:55:03+02:00
Author: Janina (wkbkhard) <hard@werkbank.de>
Commit: https://github.com/plone/plone.restapi/commit/2055b0a5614875332ca291235b75c0f48ae13d07

Merge branch 'effectiveDateNotSet' of https://github.com/plone/plone.restapi into effectiveDateNotSet

Files changed:


b''

Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-06-21T22:31:10+02:00
Author: Timo Stollenwerk (tisto) <tisto@users.noreply.github.com>
Commit: https://github.com/plone/plone.restapi/commit/8177080875316717e15a2ad7a76a75182ab9a66d

Merge pull request #761 from plone/effectiveDateNotSet

Effective date not set

Files changed:
A news/760.bugfix
M src/plone/restapi/services/workflow/transition.py
M src/plone/restapi/tests/test_workflow.py

b'diff --git a/news/760.bugfix b/news/760.bugfix\nnew file mode 100644\nindex 00000000..6736bd21\n--- /dev/null\n+++ b/news/760.bugfix\n@@ -0,0 +1 @@\n+Set effective_date and reindex obj on workflow transitions. [wkbkhard]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/services/workflow/transition.py b/src/plone/restapi/services/workflow/transition.py\nindex 05cfb0ee..4897b03d 100644\n--- a/src/plone/restapi/services/workflow/transition.py\n+++ b/src/plone/restapi/services/workflow/transition.py\n@@ -16,6 +16,7 @@\n from zope.interface import implementer\n from zope.publisher.interfaces import IPublishTraverse\n from zope.publisher.interfaces import NotFound\n+from DateTime import DateTime\n \n import plone.protect.interfaces\n \n@@ -105,6 +106,10 @@ def recurse_transition(\n                 )\n                 deserializer(data=publication_dates)\n \n+            if obj.EffectiveDate() == \'None\':\n+                obj.setEffectiveDate(DateTime())\n+                obj.reindexObject()\n+\n             self.wftool.doActionFor(obj, self.transition, comment=comment)\n             if include_children and IFolderish.providedBy(obj):\n                 self.recurse_transition(\ndiff --git a/src/plone/restapi/tests/test_workflow.py b/src/plone/restapi/tests/test_workflow.py\nindex 659e530f..85b9e278 100644\n--- a/src/plone/restapi/tests/test_workflow.py\n+++ b/src/plone/restapi/tests/test_workflow.py\n@@ -1,4 +1,5 @@\n # -*- coding: utf-8 -*-\n+from DateTime import DateTime\n from Products.CMFCore.utils import getToolByName\n from ZPublisher.pubevents import PubStart\n from base64 import b64encode\n@@ -126,6 +127,15 @@ def test_transition_action_succeeds(self):\n             u"published", self.wftool.getInfoFor(self.portal.doc1, u"review_state")\n         )\n \n+    def test_transition_action_succeeds_changes_effective(self):\n+        doc1 = self.portal.doc1\n+        self.assertEqual(doc1.effective_date, None)\n+        now = DateTime()\n+        service = self.traverse(\'/plone/doc1/@workflow/publish\')\n+        service.reply()\n+        self.assertTrue(isinstance(doc1.effective_date, DateTime))\n+        self.assertTrue(doc1.effective_date >= now)\n+\n     def test_calling_endpoint_without_transition_gives_400(self):\n         service = self.traverse("/plone/doc1/@workflow")\n         res = service.reply()\n'

