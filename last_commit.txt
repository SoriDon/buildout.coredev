Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-06-24T19:11:38+02:00
Author: Thomas Buchberger (buchi) <t.buchberger@4teamwork.ch>
Commit: https://github.com/plone/plone.restapi/commit/cab9f5458c5875bcfcffb88ba32eab21a1520ca2

Add helper for returning 204 responses

Files changed:
M src/plone/restapi/services/__init__.py

b'diff --git a/src/plone/restapi/services/__init__.py b/src/plone/restapi/services/__init__.py\nindex 5f8e72a7..8111751e 100644\n--- a/src/plone/restapi/services/__init__.py\n+++ b/src/plone/restapi/services/__init__.py\n@@ -35,3 +35,7 @@ def reply(self):\n            the no content marker if the response body should be empty.\n         """\n         return _no_content_marker\n+\n+    def reply_no_content(self, status=204):\n+        self.request.response.setStatus(status)\n+        return _no_content_marker\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-06-24T19:14:07+02:00
Author: Thomas Buchberger (buchi) <t.buchberger@4teamwork.ch>
Commit: https://github.com/plone/plone.restapi/commit/4e11c22a3bb9fcc3847bf116826d3d63117cd9b9

Return empty response for status 204

Files changed:
A news/775.bugfix
M src/plone/restapi/services/content/delete.py
M src/plone/restapi/services/content/sharing.py
M src/plone/restapi/services/content/tus.py
M src/plone/restapi/services/content/update.py
M src/plone/restapi/services/controlpanels/patch.py
M src/plone/restapi/services/discussion/conversation.py
M src/plone/restapi/services/email_notification/post.py
M src/plone/restapi/services/email_send/post.py
M src/plone/restapi/services/groups/delete.py
M src/plone/restapi/services/groups/update.py
M src/plone/restapi/services/multilingual/pam.py
M src/plone/restapi/services/registry/update.py
M src/plone/restapi/services/users/delete.py
M src/plone/restapi/services/users/update.py

b'diff --git a/news/775.bugfix b/news/775.bugfix\nnew file mode 100644\nindex 00000000..11d976f4\n--- /dev/null\n+++ b/news/775.bugfix\n@@ -0,0 +1,3 @@\n+Return empty response for status 204 (No Content).\n+[buchi]\n+\ndiff --git a/src/plone/restapi/services/content/delete.py b/src/plone/restapi/services/content/delete.py\nindex 33b032cf..8d4f59d7 100644\n--- a/src/plone/restapi/services/content/delete.py\n+++ b/src/plone/restapi/services/content/delete.py\n@@ -16,5 +16,4 @@ def reply(self):\n         except LinkIntegrityNotificationException:\n             pass\n \n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/content/sharing.py b/src/plone/restapi/services/content/sharing.py\nindex 459c2035..f432ea0a 100644\n--- a/src/plone/restapi/services/content/sharing.py\n+++ b/src/plone/restapi/services/content/sharing.py\n@@ -63,5 +63,4 @@ def reply(self):\n             return dict(error=dict(type="DeserializationError", message=str(e)))\n \n         # TODO: alternativley return the patched object with a 200\n-        self.request.response.setStatus(204)\n-        return\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/content/tus.py b/src/plone/restapi/services/content/tus.py\nindex c26876e9..f5bfdc34 100644\n--- a/src/plone/restapi/services/content/tus.py\n+++ b/src/plone/restapi/services/content/tus.py\n@@ -227,8 +227,7 @@ def reply(self):\n \n         self.request.response.setHeader("Tus-Resumable", "1.0.0")\n         self.request.response.setHeader("Upload-Offset", "{}".format(offset))\n-        self.request.response.setStatus(204, lock=1)\n-        return super(UploadPatch, self).reply()\n+        return self.reply_no_content()\n \n     def create_or_modify_content(self, tus_upload):\n         metadata = tus_upload.metadata()\ndiff --git a/src/plone/restapi/services/content/update.py b/src/plone/restapi/services/content/update.py\nindex 6066985a..a37e28e6 100644\n--- a/src/plone/restapi/services/content/update.py\n+++ b/src/plone/restapi/services/content/update.py\n@@ -47,5 +47,4 @@ def reply(self):\n             serialized_obj = serializer()\n             return serialized_obj\n \n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/controlpanels/patch.py b/src/plone/restapi/services/controlpanels/patch.py\nindex 8002f98b..ae3e492b 100644\n--- a/src/plone/restapi/services/controlpanels/patch.py\n+++ b/src/plone/restapi/services/controlpanels/patch.py\n@@ -34,4 +34,4 @@ def reply(self):\n         deserializer = IDeserializeFromJson(panel)\n         deserializer()  # The deserializer knows where to put it.\n \n-        self.request.response.setStatus(204)\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/discussion/conversation.py b/src/plone/restapi/services/discussion/conversation.py\nindex 17ab841f..72cdf485 100644\n--- a/src/plone/restapi/services/discussion/conversation.py\n+++ b/src/plone/restapi/services/discussion/conversation.py\n@@ -87,8 +87,8 @@ def reply(self):\n \n         form.handleComment(form=form, action=action)\n \n-        self.request.response.setStatus(204)\n         fix_location_header(self.context, self.request)\n+        return self.reply_no_content()\n \n \n @implementer(IPublishTraverse)\n@@ -132,8 +132,8 @@ def reply(self):\n         comment.modification_date = datetime.utcnow()\n         form.handleComment(form=form, action=action)\n \n-        self.request.response.setStatus(204)\n         fix_location_header(self.context, self.request)\n+        return self.reply_no_content()\n \n \n @implementer(IPublishTraverse)\n@@ -162,7 +162,7 @@ def reply(self):\n             raise Unauthorized()\n \n         del conversation[self.comment_id]\n-        self.request.response.setStatus(204)\n+        return self.reply_no_content()\n \n     # Helper functions copied from p.a.discussion\'s viewlet to support Plone 4\n \ndiff --git a/src/plone/restapi/services/email_notification/post.py b/src/plone/restapi/services/email_notification/post.py\nindex 5f0ea2da..b6d328bf 100644\n--- a/src/plone/restapi/services/email_notification/post.py\n+++ b/src/plone/restapi/services/email_notification/post.py\n@@ -43,5 +43,4 @@ def reply(self):\n             )\n         )\n \n-        self.request.response.setStatus(204)\n-        return\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/email_send/post.py b/src/plone/restapi/services/email_send/post.py\nindex 41cfcf42..d90e021d 100644\n--- a/src/plone/restapi/services/email_send/post.py\n+++ b/src/plone/restapi/services/email_send/post.py\n@@ -119,5 +119,4 @@ def reply(self):\n             self.request.response.setStatus(500)\n             return dict(error=dict(type="InternalServerError", message=message))\n \n-        self.request.response.setStatus(204)\n-        return\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/groups/delete.py b/src/plone/restapi/services/groups/delete.py\nindex a05e780c..aa4365ee 100644\n--- a/src/plone/restapi/services/groups/delete.py\n+++ b/src/plone/restapi/services/groups/delete.py\n@@ -42,7 +42,6 @@ def reply(self):\n \n         delete_successful = portal_groups.removeGroup(self._get_group_id)\n         if delete_successful:\n-            self.request.response.setStatus(204)\n+            return self.reply_no_content()\n         else:\n-            self.request.response.setStatus(404)\n-        return None\n+            return self.reply_no_content(status=404)\ndiff --git a/src/plone/restapi/services/groups/update.py b/src/plone/restapi/services/groups/update.py\nindex 00b06a2d..b8a713c6 100644\n--- a/src/plone/restapi/services/groups/update.py\n+++ b/src/plone/restapi/services/groups/update.py\n@@ -80,5 +80,4 @@ def reply(self):\n                 if userid in memberids:\n                     group.removeMember(userid)\n \n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/multilingual/pam.py b/src/plone/restapi/services/multilingual/pam.py\nindex d7773106..29fab72f 100644\n--- a/src/plone/restapi/services/multilingual/pam.py\n+++ b/src/plone/restapi/services/multilingual/pam.py\n@@ -136,5 +136,4 @@ def reply(self):\n             )\n \n         manager.remove_translation(language)\n-        self.request.response.setStatus(204)\n-        return {}\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/registry/update.py b/src/plone/restapi/services/registry/update.py\nindex 1cb6f754..2d21f11e 100644\n--- a/src/plone/restapi/services/registry/update.py\n+++ b/src/plone/restapi/services/registry/update.py\n@@ -24,5 +24,4 @@ def reply(self):\n                     "records! Couldn\'t find key %r" % key\n                 )\n             registry[key] = value\n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/users/delete.py b/src/plone/restapi/services/users/delete.py\nindex d1e58292..fca9be19 100644\n--- a/src/plone/restapi/services/users/delete.py\n+++ b/src/plone/restapi/services/users/delete.py\n@@ -31,7 +31,6 @@ def reply(self):\n         portal_membership = getToolByName(portal, "portal_membership")\n         delete_successful = portal_membership.deleteMembers((self._get_user_id,))\n         if delete_successful:\n-            self.request.response.setStatus(204)\n+            return self.reply_no_content()\n         else:\n-            self.request.response.setStatus(404)\n-        return None\n+            return self.reply_no_content(status=404)\ndiff --git a/src/plone/restapi/services/users/update.py b/src/plone/restapi/services/users/update.py\nindex b6d61ca4..907f4667 100644\n--- a/src/plone/restapi/services/users/update.py\n+++ b/src/plone/restapi/services/users/update.py\n@@ -114,8 +114,7 @@ def reply(self):\n                     403, "Forbidden", "You can\'t update the " "properties of this user"\n                 )\n \n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\n \n     @property\n     def can_manage_users(self):\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-06-29T10:30:32+02:00
Author: Timo Stollenwerk (tisto) <tisto@users.noreply.github.com>
Commit: https://github.com/plone/plone.restapi/commit/e38142ccbe7d705da97df534462f3730e89e1ecd

Merge pull request #776 from plone/fix-204-no-content

Fix 204 no content

Files changed:
A news/775.bugfix
M src/plone/restapi/services/__init__.py
M src/plone/restapi/services/content/delete.py
M src/plone/restapi/services/content/sharing.py
M src/plone/restapi/services/content/tus.py
M src/plone/restapi/services/content/update.py
M src/plone/restapi/services/controlpanels/patch.py
M src/plone/restapi/services/discussion/conversation.py
M src/plone/restapi/services/email_notification/post.py
M src/plone/restapi/services/email_send/post.py
M src/plone/restapi/services/groups/delete.py
M src/plone/restapi/services/groups/update.py
M src/plone/restapi/services/multilingual/pam.py
M src/plone/restapi/services/registry/update.py
M src/plone/restapi/services/users/delete.py
M src/plone/restapi/services/users/update.py

b'diff --git a/news/775.bugfix b/news/775.bugfix\nnew file mode 100644\nindex 00000000..11d976f4\n--- /dev/null\n+++ b/news/775.bugfix\n@@ -0,0 +1,3 @@\n+Return empty response for status 204 (No Content).\n+[buchi]\n+\ndiff --git a/src/plone/restapi/services/__init__.py b/src/plone/restapi/services/__init__.py\nindex 5f8e72a7..8111751e 100644\n--- a/src/plone/restapi/services/__init__.py\n+++ b/src/plone/restapi/services/__init__.py\n@@ -35,3 +35,7 @@ def reply(self):\n            the no content marker if the response body should be empty.\n         """\n         return _no_content_marker\n+\n+    def reply_no_content(self, status=204):\n+        self.request.response.setStatus(status)\n+        return _no_content_marker\ndiff --git a/src/plone/restapi/services/content/delete.py b/src/plone/restapi/services/content/delete.py\nindex 33b032cf..8d4f59d7 100644\n--- a/src/plone/restapi/services/content/delete.py\n+++ b/src/plone/restapi/services/content/delete.py\n@@ -16,5 +16,4 @@ def reply(self):\n         except LinkIntegrityNotificationException:\n             pass\n \n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/content/sharing.py b/src/plone/restapi/services/content/sharing.py\nindex 459c2035..f432ea0a 100644\n--- a/src/plone/restapi/services/content/sharing.py\n+++ b/src/plone/restapi/services/content/sharing.py\n@@ -63,5 +63,4 @@ def reply(self):\n             return dict(error=dict(type="DeserializationError", message=str(e)))\n \n         # TODO: alternativley return the patched object with a 200\n-        self.request.response.setStatus(204)\n-        return\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/content/tus.py b/src/plone/restapi/services/content/tus.py\nindex c26876e9..f5bfdc34 100644\n--- a/src/plone/restapi/services/content/tus.py\n+++ b/src/plone/restapi/services/content/tus.py\n@@ -227,8 +227,7 @@ def reply(self):\n \n         self.request.response.setHeader("Tus-Resumable", "1.0.0")\n         self.request.response.setHeader("Upload-Offset", "{}".format(offset))\n-        self.request.response.setStatus(204, lock=1)\n-        return super(UploadPatch, self).reply()\n+        return self.reply_no_content()\n \n     def create_or_modify_content(self, tus_upload):\n         metadata = tus_upload.metadata()\ndiff --git a/src/plone/restapi/services/content/update.py b/src/plone/restapi/services/content/update.py\nindex 6066985a..a37e28e6 100644\n--- a/src/plone/restapi/services/content/update.py\n+++ b/src/plone/restapi/services/content/update.py\n@@ -47,5 +47,4 @@ def reply(self):\n             serialized_obj = serializer()\n             return serialized_obj\n \n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/controlpanels/patch.py b/src/plone/restapi/services/controlpanels/patch.py\nindex 8002f98b..ae3e492b 100644\n--- a/src/plone/restapi/services/controlpanels/patch.py\n+++ b/src/plone/restapi/services/controlpanels/patch.py\n@@ -34,4 +34,4 @@ def reply(self):\n         deserializer = IDeserializeFromJson(panel)\n         deserializer()  # The deserializer knows where to put it.\n \n-        self.request.response.setStatus(204)\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/discussion/conversation.py b/src/plone/restapi/services/discussion/conversation.py\nindex 17ab841f..72cdf485 100644\n--- a/src/plone/restapi/services/discussion/conversation.py\n+++ b/src/plone/restapi/services/discussion/conversation.py\n@@ -87,8 +87,8 @@ def reply(self):\n \n         form.handleComment(form=form, action=action)\n \n-        self.request.response.setStatus(204)\n         fix_location_header(self.context, self.request)\n+        return self.reply_no_content()\n \n \n @implementer(IPublishTraverse)\n@@ -132,8 +132,8 @@ def reply(self):\n         comment.modification_date = datetime.utcnow()\n         form.handleComment(form=form, action=action)\n \n-        self.request.response.setStatus(204)\n         fix_location_header(self.context, self.request)\n+        return self.reply_no_content()\n \n \n @implementer(IPublishTraverse)\n@@ -162,7 +162,7 @@ def reply(self):\n             raise Unauthorized()\n \n         del conversation[self.comment_id]\n-        self.request.response.setStatus(204)\n+        return self.reply_no_content()\n \n     # Helper functions copied from p.a.discussion\'s viewlet to support Plone 4\n \ndiff --git a/src/plone/restapi/services/email_notification/post.py b/src/plone/restapi/services/email_notification/post.py\nindex 5f0ea2da..b6d328bf 100644\n--- a/src/plone/restapi/services/email_notification/post.py\n+++ b/src/plone/restapi/services/email_notification/post.py\n@@ -43,5 +43,4 @@ def reply(self):\n             )\n         )\n \n-        self.request.response.setStatus(204)\n-        return\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/email_send/post.py b/src/plone/restapi/services/email_send/post.py\nindex 41cfcf42..d90e021d 100644\n--- a/src/plone/restapi/services/email_send/post.py\n+++ b/src/plone/restapi/services/email_send/post.py\n@@ -119,5 +119,4 @@ def reply(self):\n             self.request.response.setStatus(500)\n             return dict(error=dict(type="InternalServerError", message=message))\n \n-        self.request.response.setStatus(204)\n-        return\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/groups/delete.py b/src/plone/restapi/services/groups/delete.py\nindex a05e780c..aa4365ee 100644\n--- a/src/plone/restapi/services/groups/delete.py\n+++ b/src/plone/restapi/services/groups/delete.py\n@@ -42,7 +42,6 @@ def reply(self):\n \n         delete_successful = portal_groups.removeGroup(self._get_group_id)\n         if delete_successful:\n-            self.request.response.setStatus(204)\n+            return self.reply_no_content()\n         else:\n-            self.request.response.setStatus(404)\n-        return None\n+            return self.reply_no_content(status=404)\ndiff --git a/src/plone/restapi/services/groups/update.py b/src/plone/restapi/services/groups/update.py\nindex 00b06a2d..b8a713c6 100644\n--- a/src/plone/restapi/services/groups/update.py\n+++ b/src/plone/restapi/services/groups/update.py\n@@ -80,5 +80,4 @@ def reply(self):\n                 if userid in memberids:\n                     group.removeMember(userid)\n \n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/multilingual/pam.py b/src/plone/restapi/services/multilingual/pam.py\nindex d7773106..29fab72f 100644\n--- a/src/plone/restapi/services/multilingual/pam.py\n+++ b/src/plone/restapi/services/multilingual/pam.py\n@@ -136,5 +136,4 @@ def reply(self):\n             )\n \n         manager.remove_translation(language)\n-        self.request.response.setStatus(204)\n-        return {}\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/registry/update.py b/src/plone/restapi/services/registry/update.py\nindex 1cb6f754..2d21f11e 100644\n--- a/src/plone/restapi/services/registry/update.py\n+++ b/src/plone/restapi/services/registry/update.py\n@@ -24,5 +24,4 @@ def reply(self):\n                     "records! Couldn\'t find key %r" % key\n                 )\n             registry[key] = value\n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\ndiff --git a/src/plone/restapi/services/users/delete.py b/src/plone/restapi/services/users/delete.py\nindex d1e58292..fca9be19 100644\n--- a/src/plone/restapi/services/users/delete.py\n+++ b/src/plone/restapi/services/users/delete.py\n@@ -31,7 +31,6 @@ def reply(self):\n         portal_membership = getToolByName(portal, "portal_membership")\n         delete_successful = portal_membership.deleteMembers((self._get_user_id,))\n         if delete_successful:\n-            self.request.response.setStatus(204)\n+            return self.reply_no_content()\n         else:\n-            self.request.response.setStatus(404)\n-        return None\n+            return self.reply_no_content(status=404)\ndiff --git a/src/plone/restapi/services/users/update.py b/src/plone/restapi/services/users/update.py\nindex b6d61ca4..907f4667 100644\n--- a/src/plone/restapi/services/users/update.py\n+++ b/src/plone/restapi/services/users/update.py\n@@ -114,8 +114,7 @@ def reply(self):\n                     403, "Forbidden", "You can\'t update the " "properties of this user"\n                 )\n \n-        self.request.response.setStatus(204)\n-        return None\n+        return self.reply_no_content()\n \n     @property\n     def can_manage_users(self):\n'

