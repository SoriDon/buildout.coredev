Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-04-26T12:30:59+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.namedfile/commit/6fbac9662eca476e4ecd4584d84f036b496c8a3e

apply @loechels comments for fix for #46

Files changed:
M CHANGES.rst
M plone/namedfile/utils/jpeg_utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index dd2b1fb..137cdad 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- Fix #46, when ``tiff_utils.process_tiff`` failed and a ``width referenced before assignment`` error occured.
+- Fix #46, when ``process_png``, ``process_jpeg`` and ``process_tiff`` could fail with a ``width referenced before assignment`` error.
   [thet]
 
 - Fix contentType attribute should be str type, what leads to validation errors (fixes `#38`_).
diff --git a/plone/namedfile/utils/jpeg_utils.py b/plone/namedfile/utils/jpeg_utils.py
index 4144aa7..3a5977e 100644
--- a/plone/namedfile/utils/jpeg_utils.py
+++ b/plone/namedfile/utils/jpeg_utils.py
@@ -16,6 +16,7 @@ def process_jpeg(data):
     size = len(data)
 
     if (size >= 2) and data.startswith('\377\330'):  # handle JPEGs
+        content_type = 'image/jpeg'
         jpeg = StringIO(data)
         jpeg.read(2)
         b = jpeg.read(1)
@@ -28,7 +29,6 @@ def process_jpeg(data):
                 if (ord(b) >= 0xC0 and ord(b) <= 0xC3):
                     jpeg.read(3)
                     h, w = struct.unpack('>HH', jpeg.read(4))
-                    content_type = 'image/jpeg'
                     break
                 else:
                     jpeg.read(int(struct.unpack('>H', jpeg.read(2))[0]) - 2)


Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-04-26T13:19:54+02:00
Author: Alexander Loechel (loechel) <loechel@users.noreply.github.com>
Commit: https://github.com/plone/plone.namedfile/commit/4cc9df30dfe921f6dc37fc0aee2261c6fa69a7fb

Merge pull request #48 from plone/thet-fix-46-2

apply @loechels comments for fix for #46

Files changed:
M CHANGES.rst
M plone/namedfile/utils/jpeg_utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index dd2b1fb..137cdad 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- Fix #46, when ``tiff_utils.process_tiff`` failed and a ``width referenced before assignment`` error occured.
+- Fix #46, when ``process_png``, ``process_jpeg`` and ``process_tiff`` could fail with a ``width referenced before assignment`` error.
   [thet]
 
 - Fix contentType attribute should be str type, what leads to validation errors (fixes `#38`_).
diff --git a/plone/namedfile/utils/jpeg_utils.py b/plone/namedfile/utils/jpeg_utils.py
index 4144aa7..3a5977e 100644
--- a/plone/namedfile/utils/jpeg_utils.py
+++ b/plone/namedfile/utils/jpeg_utils.py
@@ -16,6 +16,7 @@ def process_jpeg(data):
     size = len(data)
 
     if (size >= 2) and data.startswith('\377\330'):  # handle JPEGs
+        content_type = 'image/jpeg'
         jpeg = StringIO(data)
         jpeg.read(2)
         b = jpeg.read(1)
@@ -28,7 +29,6 @@ def process_jpeg(data):
                 if (ord(b) >= 0xC0 and ord(b) <= 0xC3):
                     jpeg.read(3)
                     h, w = struct.unpack('>HH', jpeg.read(4))
-                    content_type = 'image/jpeg'
                     break
                 else:
                     jpeg.read(int(struct.unpack('>H', jpeg.read(2))[0]) - 2)


