Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-06-07T20:42:10+02:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/602d5e892a70a532f20d89d718cd0c09956b3cbd

Add current state and translation to the @workflow endpoint (#1147)

* Add current state and translation to the @workflow endpoint

* Add translation to the current state title

* Translated wf test

Files changed:
A news/1146.feature
M src/plone/restapi/services/workflow/info.py
M src/plone/restapi/tests/http-examples/expansion_expanded_full.resp
M src/plone/restapi/tests/http-examples/translated_messages_object_workflow.resp
M src/plone/restapi/tests/http-examples/workflow_get.resp
M src/plone/restapi/tests/test_workflow.py

b'diff --git a/news/1146.feature b/news/1146.feature\nnew file mode 100644\nindex 000000000..6f5921718\n--- /dev/null\n+++ b/news/1146.feature\n@@ -0,0 +1,2 @@\n+Add current state and translation to the @workflow endpoint\n+[sneridagh]\ndiff --git a/src/plone/restapi/services/workflow/info.py b/src/plone/restapi/services/workflow/info.py\nindex b729eb4d0..c6b134fe7 100644\n--- a/src/plone/restapi/services/workflow/info.py\n+++ b/src/plone/restapi/services/workflow/info.py\n@@ -68,8 +68,21 @@ def __call__(self, expand=False):\n                 title = title.decode("utf8")\n             history[item]["title"] = self.context.translate(title)\n \n+        current_state = wftool.getInfoFor(self.context, "review_state")\n+        current_state_title = wftool.getTitleForStateOnType(\n+            current_state,\n+            self.context.portal_type,\n+        )\n+\n         result["workflow"].update(\n-            {"history": json_compatible(history), "transitions": transitions}\n+            {\n+                "history": json_compatible(history),\n+                "transitions": transitions,\n+                "state": {\n+                    "id": current_state,\n+                    "title": self.context.translate(current_state_title),\n+                },\n+            }\n         )\n         return result\n \ndiff --git a/src/plone/restapi/tests/http-examples/expansion_expanded_full.resp b/src/plone/restapi/tests/http-examples/expansion_expanded_full.resp\nindex 905ea4d1d..bac25fd2c 100644\n--- a/src/plone/restapi/tests/http-examples/expansion_expanded_full.resp\n+++ b/src/plone/restapi/tests/http-examples/expansion_expanded_full.resp\n@@ -197,6 +197,10 @@ Content-Type: application/json\n           "title": "Private"\n         }\n       ], \n+      "state": {\n+        "id": "private", \n+        "title": "Private"\n+      }, \n       "transitions": [\n         {\n           "@id": "http://localhost:55001/plone/front-page/@workflow/publish", \ndiff --git a/src/plone/restapi/tests/http-examples/translated_messages_object_workflow.resp b/src/plone/restapi/tests/http-examples/translated_messages_object_workflow.resp\nindex b43e107c7..aa19384f7 100644\n--- a/src/plone/restapi/tests/http-examples/translated_messages_object_workflow.resp\n+++ b/src/plone/restapi/tests/http-examples/translated_messages_object_workflow.resp\n@@ -13,6 +13,10 @@ Content-Type: application/json\n       "title": "Privado"\n     }\n   ], \n+  "state": {\n+    "id": "private", \n+    "title": "Privado"\n+  }, \n   "transitions": [\n     {\n       "@id": "http://localhost:55001/plone/front-page/@workflow/publish", \ndiff --git a/src/plone/restapi/tests/http-examples/workflow_get.resp b/src/plone/restapi/tests/http-examples/workflow_get.resp\nindex 08d043166..90ea3a3ff 100644\n--- a/src/plone/restapi/tests/http-examples/workflow_get.resp\n+++ b/src/plone/restapi/tests/http-examples/workflow_get.resp\n@@ -13,6 +13,10 @@ Content-Type: application/json\n       "title": "Private"\n     }\n   ], \n+  "state": {\n+    "id": "private", \n+    "title": "Private"\n+  }, \n   "transitions": [\n     {\n       "@id": "http://localhost:55001/plone/front-page/@workflow/publish", \ndiff --git a/src/plone/restapi/tests/test_workflow.py b/src/plone/restapi/tests/test_workflow.py\nindex aa40b9629..67f9d86fb 100644\n--- a/src/plone/restapi/tests/test_workflow.py\n+++ b/src/plone/restapi/tests/test_workflow.py\n@@ -45,6 +45,17 @@ def test_workflow_info_includes_history(self):\n         self.assertEqual("published", history[-1][u"review_state"])\n         self.assertEqual(u"Published with accent \xc3\xa9", history[-1][u"title"])\n \n+    def test_workflow_info_includes_current_state(self):\n+        wfinfo = getMultiAdapter(\n+            (self.doc1, self.request), name=u"GET_application_json_@workflow"\n+        )\n+        info = wfinfo.reply()\n+        self.assertIn("state", info)\n+        state = info["state"]\n+        self.assertEqual(2, len(state))\n+        self.assertEqual("published", state["id"])\n+        self.assertEqual(u"Published with accent \xc3\xa9", state["title"])\n+\n     def test_workflow_info_unauthorized_history(self):\n         login(self.portal, SITE_OWNER_NAME)\n         doc2 = self.portal[\n'

