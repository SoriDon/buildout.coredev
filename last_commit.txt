Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-04-07T23:21:22+02:00
Author: agitator (agitator) <agitator@users.noreply.github.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/afd49b147385194abba42bcb650ba2f741469dfc

Added support for images in liveSearch results. (#3489)

* Added support for images in liveSearch results.

* add news

Files changed:
A news/3489.feature
M Products/CMFPlone/browser/search.py

b'diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py\nindex a8c34129d6..8e396ed2ed 100644\n--- a/Products/CMFPlone/browser/search.py\n+++ b/Products/CMFPlone/browser/search.py\n@@ -1,5 +1,6 @@\n from DateTime import DateTime\n from plone.app.contentlisting.interfaces import IContentListing\n+from plone.app.layout.navigation.interfaces import INavigationRoot\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.browser.navtree import getNavigationRoot\n@@ -249,27 +250,37 @@ def __call__(self):\n \n         registry = queryUtility(IRegistry)\n         length = registry.get(\'plone.search_results_description_length\')\n+        show_images = registry.get(\'plone.search_show_images\')\n+        if show_images:\n+            image_scale = registry.get(\'plone.search_image_scale\')\n+            # image_scaling = getMultiAdapter((self.context, self.request), name=\'image_scale\')\n+            self.image_scaling = getMultiAdapter((INavigationRoot(self.context), self.request), name=\'image_scale\')\n         plone_view = getMultiAdapter(\n             (self.context, self.request), name=\'plone\')\n-        registry = getUtility(IRegistry)\n         view_action_types = registry.get(\n             \'plone.types_use_view_action_in_listings\', [])\n         for item in batch:\n             url = item.getURL()\n             if item.portal_type in view_action_types:\n                 url = \'%s/view\' % url\n+            img_tag = None\n+            if show_images:\n+                img_tag = self.get_image_tag(item, image_scale)\n             items.append({\n                 \'id\': item.UID,\n                 \'title\': item.Title,\n                 \'description\': plone_view.cropText(item.Description, length),\n                 \'url\': url,\n                 \'state\': item.review_state if item.review_state else None,\n+                \'img_tag\': img_tag,\n             })\n         return json.dumps({\n             \'total\': len(results),\n             \'items\': items\n         })\n \n+    def get_image_tag(self, item, image_scale):\n+        return self.image_scaling.tag(item, "image", scale=image_scale)\n \n class SortOption:\n \ndiff --git a/news/3489.feature b/news/3489.feature\nnew file mode 100644\nindex 0000000000..4b029fb1f5\n--- /dev/null\n+++ b/news/3489.feature\n@@ -0,0 +1,2 @@\n+Added support for images in liveSearch results.\n+[agitator]\n\\ No newline at end of file\n'

