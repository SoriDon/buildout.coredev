Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2016-02-19T14:20:16-08:00
Author: Alec Mitchell (alecpm) <alecpm@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/ebb3ae1dc708cd2dccfb81cab75af273ca7a5500

Use custom catalog vocabulary for translation content mapping widget, which searches all site content.

Files changed:
M CHANGES.rst
M src/plone/app/multilingual/browser/configure.zcml
M src/plone/app/multilingual/browser/interfaces.py
M src/plone/app/multilingual/browser/vocabularies.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 89ed4aa..dfcbe2d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,10 @@ New:
 
 Fixes:
 
+- Use custom catalog vocabulary for translation content mapping widget,
+  which searches all site content.
+  [alecm]
+
 - Update Site Setup link in all control panels (fixes https://github.com/plone/Products.CMFPlone/issues/1255)
   [davilima6]
 
diff --git a/src/plone/app/multilingual/browser/configure.zcml b/src/plone/app/multilingual/browser/configure.zcml
index bbf2f8c..0317fe1 100644
--- a/src/plone/app/multilingual/browser/configure.zcml
+++ b/src/plone/app/multilingual/browser/configure.zcml
@@ -28,6 +28,11 @@
       component=".vocabularies.AllAvailableLanguageVocabularyFactory"
       name="plone.app.multilingual.vocabularies.AllAvailableLanguageVocabulary"/>
 
+  <utility
+      factory=".vocabularies.RootCatalogVocabularyFactory"
+      name="plone.app.multilingual.RootCatalog"
+      />
+
   <adapter
       name="addtranslation"
       factory=".add.AddViewTraverser"/>
diff --git a/src/plone/app/multilingual/browser/interfaces.py b/src/plone/app/multilingual/browser/interfaces.py
index ff8c7a8..b05ebad 100644
--- a/src/plone/app/multilingual/browser/interfaces.py
+++ b/src/plone/app/multilingual/browser/interfaces.py
@@ -56,7 +56,7 @@ class IAddTranslation(model.Schema):
     )
     content = RelationChoice(
         title=_(u"content"),
-        vocabulary="plone.app.vocabularies.Catalog",
+        vocabulary="plone.app.multilingual.RootCatalog",
         required=True,
     )
 
diff --git a/src/plone/app/multilingual/browser/vocabularies.py b/src/plone/app/multilingual/browser/vocabularies.py
index f5528e9..e1aa5e1 100644
--- a/src/plone/app/multilingual/browser/vocabularies.py
+++ b/src/plone/app/multilingual/browser/vocabularies.py
@@ -3,6 +3,7 @@
 from plone.app.multilingual.browser.utils import is_language_independent
 from Products.CMFPlone.interfaces import ILanguage
 from plone.app.multilingual.interfaces import ITranslationManager
+from plone.app.vocabularies.catalog import CatalogVocabularyFactory
 from plone.i18n.locales.interfaces import ILanguageAvailability
 from zope.component import getGlobalSiteManager
 from zope.component.hooks import getSite
@@ -146,3 +147,12 @@ def __call__(self, context):
         return SimpleVocabulary(items)
 
 AllAvailableLanguageVocabularyFactory = AllAvailableLanguageVocabulary()
+
+
+class RootCatalogVocabularyFactory(CatalogVocabularyFactory):
+    """Catalog Vocabulary which always uses the site root"""
+
+    def __call__(self, context, query=None):
+        portal = getToolByName(context, 'portal_url').getPortalObject()
+        return super(RootCatalogVocabularyFactory, self).__call__(portal,
+                                                                  query)


Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2016-02-22T15:59:25+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/300f23fe679ac185df32a384b13d9301562dcf7b

Merge pull request #210 from plone/navroot-fixes

Use custom catalog vocabulary for translation content mapping widget, which searches all site content.

Files changed:
M CHANGES.rst
M src/plone/app/multilingual/browser/configure.zcml
M src/plone/app/multilingual/browser/interfaces.py
M src/plone/app/multilingual/browser/vocabularies.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 89ed4aa..dfcbe2d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,10 @@ New:
 
 Fixes:
 
+- Use custom catalog vocabulary for translation content mapping widget,
+  which searches all site content.
+  [alecm]
+
 - Update Site Setup link in all control panels (fixes https://github.com/plone/Products.CMFPlone/issues/1255)
   [davilima6]
 
diff --git a/src/plone/app/multilingual/browser/configure.zcml b/src/plone/app/multilingual/browser/configure.zcml
index bbf2f8c..0317fe1 100644
--- a/src/plone/app/multilingual/browser/configure.zcml
+++ b/src/plone/app/multilingual/browser/configure.zcml
@@ -28,6 +28,11 @@
       component=".vocabularies.AllAvailableLanguageVocabularyFactory"
       name="plone.app.multilingual.vocabularies.AllAvailableLanguageVocabulary"/>
 
+  <utility
+      factory=".vocabularies.RootCatalogVocabularyFactory"
+      name="plone.app.multilingual.RootCatalog"
+      />
+
   <adapter
       name="addtranslation"
       factory=".add.AddViewTraverser"/>
diff --git a/src/plone/app/multilingual/browser/interfaces.py b/src/plone/app/multilingual/browser/interfaces.py
index ff8c7a8..b05ebad 100644
--- a/src/plone/app/multilingual/browser/interfaces.py
+++ b/src/plone/app/multilingual/browser/interfaces.py
@@ -56,7 +56,7 @@ class IAddTranslation(model.Schema):
     )
     content = RelationChoice(
         title=_(u"content"),
-        vocabulary="plone.app.vocabularies.Catalog",
+        vocabulary="plone.app.multilingual.RootCatalog",
         required=True,
     )
 
diff --git a/src/plone/app/multilingual/browser/vocabularies.py b/src/plone/app/multilingual/browser/vocabularies.py
index f5528e9..e1aa5e1 100644
--- a/src/plone/app/multilingual/browser/vocabularies.py
+++ b/src/plone/app/multilingual/browser/vocabularies.py
@@ -3,6 +3,7 @@
 from plone.app.multilingual.browser.utils import is_language_independent
 from Products.CMFPlone.interfaces import ILanguage
 from plone.app.multilingual.interfaces import ITranslationManager
+from plone.app.vocabularies.catalog import CatalogVocabularyFactory
 from plone.i18n.locales.interfaces import ILanguageAvailability
 from zope.component import getGlobalSiteManager
 from zope.component.hooks import getSite
@@ -146,3 +147,12 @@ def __call__(self, context):
         return SimpleVocabulary(items)
 
 AllAvailableLanguageVocabularyFactory = AllAvailableLanguageVocabulary()
+
+
+class RootCatalogVocabularyFactory(CatalogVocabularyFactory):
+    """Catalog Vocabulary which always uses the site root"""
+
+    def __call__(self, context, query=None):
+        portal = getToolByName(context, 'portal_url').getPortalObject()
+        return super(RootCatalogVocabularyFactory, self).__call__(portal,
+                                                                  query)


