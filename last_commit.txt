Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2022-09-27T13:05:02+02:00
Author: Balázs Reé (reebalazs) <ree@greenfinity.hu>
Commit: https://github.com/plone/Products.CMFEditions/commit/dfb115fb7648b7069de98853d7c839b1f6a3899f

Fix object remains locked after version retrieved

After a version is retrieved from history, the object remains locked.

Files changed:
A news/93.bugfix
M CHANGES.rst
M Products/CMFEditions/CopyModifyMergeRepositoryTool.py
M Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex e35e3bc..c039d19 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -16,7 +16,6 @@ Bug fixes:\n \n - - Only fire ObjectModifiedEvent once when an item is reverted to an old version. [davisagli] (#90)\n \n-\n 4.0.0b1 (2022-07-21)\n --------------------\n \ndiff --git a/Products/CMFEditions/CopyModifyMergeRepositoryTool.py b/Products/CMFEditions/CopyModifyMergeRepositoryTool.py\nindex 3fe4ff6..3405a9a 100644\n--- a/Products/CMFEditions/CopyModifyMergeRepositoryTool.py\n+++ b/Products/CMFEditions/CopyModifyMergeRepositoryTool.py\n@@ -55,6 +55,7 @@\n from Products.CMFEditions.VersionPolicies import VersionPolicy\n from ZODB.broken import Broken\n from zope.interface import implementer\n+from plone.locking.interfaces import ILockable\n \n import logging\n import time\n@@ -663,6 +664,7 @@ def _doInplaceFixups(self, queue, inplace):\n             if inplace:\n                 self._fixIds(obj)\n                 self._fixupCatalogData(obj)\n+                self._unlock(obj)\n \n     def _fixupCatalogData(self, obj):\n         """Reindex the object, otherwise the catalog will certainly\n@@ -714,6 +716,13 @@ def _fixIds(self, obj):\n                     obj._setObject(temp_id, child)\n                     all_ids.append(temp_id)\n \n+    def _unlock(self, obj):\n+        try:\n+            lockable = ILockable(obj)\n+        except TypeError:\n+            lockable = None\n+        if lockable:\n+            lockable.unlock()\n \n @implementer(IVersionData)\n class VersionData:\ndiff --git a/Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py b/Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py\nindex a49b913..14b3775 100644\n--- a/Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py\n+++ b/Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py\n@@ -33,6 +33,9 @@\n from Products.CMFEditions.tests.base import CMFEditionsBaseTestCase\n from Products.CMFEditions.VersionPolicies import VersionPolicy\n from zope.interface.verify import verifyObject\n+from zope.interface import alsoProvides\n+from plone.locking.interfaces import ILockable\n+from plone.locking.interfaces import ITTWLockable\n \n import transaction\n \n@@ -292,6 +295,20 @@ def test09_getHistoryMetadata(self):\n             "save number 2",  # noqa: E501\n         )\n \n+    def test10_unlockedAfterRevert(self):\n+        portal_repository = self.portal.portal_repository\n+        doc = self.portal.doc\n+        doc.text = "text v1"\n+        # Lock the object before saving\n+        alsoProvides(doc, ITTWLockable)\n+        ILockable(doc).lock()\n+        portal_repository.applyVersionControl(doc, comment="save number 1")\n+        doc.text = "text v2"\n+        portal_repository.save(doc, comment="save number 2")\n+        # Revert to previous version\n+        portal_repository.revert(doc, 0)\n+        self.assertFalse(ILockable(self.portal.doc).locked())\n+\n \n class TestRepositoryWithDummyArchivist(TestCopyModifyMergeRepositoryToolBase):\n     def _setupArchivist(self):\ndiff --git a/news/93.bugfix b/news/93.bugfix\nnew file mode 100644\nindex 0000000..504b57a\n--- /dev/null\n+++ b/news/93.bugfix\n@@ -0,0 +1 @@\n+Fix object remains locked after version retrieved\n\\ No newline at end of file\n'

Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2022-09-28T08:29:58-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/Products.CMFEditions/commit/194f5cc44368d3dd78ff2d5232149a42f6648ae2

Merge pull request #92 from plone/ree-object-remains-locked-after-version-retrieved

Fix object remains locked after version retrieved

Files changed:
A news/93.bugfix
M CHANGES.rst
M Products/CMFEditions/CopyModifyMergeRepositoryTool.py
M Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex e35e3bc..c039d19 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -16,7 +16,6 @@ Bug fixes:\n \n - - Only fire ObjectModifiedEvent once when an item is reverted to an old version. [davisagli] (#90)\n \n-\n 4.0.0b1 (2022-07-21)\n --------------------\n \ndiff --git a/Products/CMFEditions/CopyModifyMergeRepositoryTool.py b/Products/CMFEditions/CopyModifyMergeRepositoryTool.py\nindex 3fe4ff6..3405a9a 100644\n--- a/Products/CMFEditions/CopyModifyMergeRepositoryTool.py\n+++ b/Products/CMFEditions/CopyModifyMergeRepositoryTool.py\n@@ -55,6 +55,7 @@\n from Products.CMFEditions.VersionPolicies import VersionPolicy\n from ZODB.broken import Broken\n from zope.interface import implementer\n+from plone.locking.interfaces import ILockable\n \n import logging\n import time\n@@ -663,6 +664,7 @@ def _doInplaceFixups(self, queue, inplace):\n             if inplace:\n                 self._fixIds(obj)\n                 self._fixupCatalogData(obj)\n+                self._unlock(obj)\n \n     def _fixupCatalogData(self, obj):\n         """Reindex the object, otherwise the catalog will certainly\n@@ -714,6 +716,13 @@ def _fixIds(self, obj):\n                     obj._setObject(temp_id, child)\n                     all_ids.append(temp_id)\n \n+    def _unlock(self, obj):\n+        try:\n+            lockable = ILockable(obj)\n+        except TypeError:\n+            lockable = None\n+        if lockable:\n+            lockable.unlock()\n \n @implementer(IVersionData)\n class VersionData:\ndiff --git a/Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py b/Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py\nindex a49b913..14b3775 100644\n--- a/Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py\n+++ b/Products/CMFEditions/tests/test_CopyModifyMergeRepositoryTool.py\n@@ -33,6 +33,9 @@\n from Products.CMFEditions.tests.base import CMFEditionsBaseTestCase\n from Products.CMFEditions.VersionPolicies import VersionPolicy\n from zope.interface.verify import verifyObject\n+from zope.interface import alsoProvides\n+from plone.locking.interfaces import ILockable\n+from plone.locking.interfaces import ITTWLockable\n \n import transaction\n \n@@ -292,6 +295,20 @@ def test09_getHistoryMetadata(self):\n             "save number 2",  # noqa: E501\n         )\n \n+    def test10_unlockedAfterRevert(self):\n+        portal_repository = self.portal.portal_repository\n+        doc = self.portal.doc\n+        doc.text = "text v1"\n+        # Lock the object before saving\n+        alsoProvides(doc, ITTWLockable)\n+        ILockable(doc).lock()\n+        portal_repository.applyVersionControl(doc, comment="save number 1")\n+        doc.text = "text v2"\n+        portal_repository.save(doc, comment="save number 2")\n+        # Revert to previous version\n+        portal_repository.revert(doc, 0)\n+        self.assertFalse(ILockable(self.portal.doc).locked())\n+\n \n class TestRepositoryWithDummyArchivist(TestCopyModifyMergeRepositoryToolBase):\n     def _setupArchivist(self):\ndiff --git a/news/93.bugfix b/news/93.bugfix\nnew file mode 100644\nindex 0000000..504b57a\n--- /dev/null\n+++ b/news/93.bugfix\n@@ -0,0 +1 @@\n+Fix object remains locked after version retrieved\n\\ No newline at end of file\n'

