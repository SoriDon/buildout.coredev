Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2016-09-20T14:18:13+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.portlets/commit/3b77a093e9443aae4992731951c6216254174477

Added `referer` property to `PortletAdding` view.

Now all views like this have it.

Files changed:
M CHANGES.rst
M plone/app/portlets/browser/adding.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 404d36e..7017af3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,6 +15,9 @@ New features:
 
 Bug fixes:
 
+- Added ``referer`` property to ``PortletAdding`` view.  Now all views
+  like this have it.  [maurits]
+
 - Apply security hotfix 20160830 for redirects.  [maurits]
 
 
diff --git a/plone/app/portlets/browser/adding.py b/plone/app/portlets/browser/adding.py
index db8933f..67f93ad 100644
--- a/plone/app/portlets/browser/adding.py
+++ b/plone/app/portlets/browser/adding.py
@@ -35,12 +35,17 @@ def add(self, content):
         chooser = INameChooser(manager)
         manager[chooser.chooseName(None, content)] = content
 
+    @property
+    def referer(self):
+        return self.request.get('referer', '')
+
     def nextURL(self):
-        referer = self.request.get('referer')
         urltool = getToolByName(self.context, 'portal_url')
+        referer = self.referer
         if not referer or not urltool.isURLInPortal(referer):
             context = aq_parent(aq_inner(self.context))
-            url = str(getMultiAdapter((context, self.request), name=u"absolute_url"))
+            url = str(getMultiAdapter((context, self.request),
+                                      name=u"absolute_url"))
             referer = url + '/@@manage-portlets'
         return referer
 


