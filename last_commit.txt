Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2017-03-08T16:17:05+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/6102dcf26951a7dd297711aad3dc2c2b140571a5

Removed Plone 5.0 installer code from tests.

And test that multiple installs and uninstalls work.
This actually worked already on Plone 5.1, but we now test it explicitly.
See https://github.com/plone/Products.CMFPlone/issues/1959.

Files changed:
M CHANGES.rst
M Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a93bb45..c855634 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Removed Plone 5.0 installer code from tests.
+  Test that multiple installs and uninstalls work.
+  See `issue 1959 <https://github.com/plone/Products.CMFPlone/issues/1959>`_.
+  [maurits]
 
 
 1.7.2 (2017-01-17)
diff --git a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
index 4c0b18c..e2feb13 100644
--- a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
+++ b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
@@ -23,6 +23,7 @@
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlacefulWorkflow.PlacefulWorkflowTool import WorkflowPolicyConfig_id
 from Products.CMFPlacefulWorkflow.interfaces import IPlacefulMarker
+from Products.CMFPlone.utils import get_installer
 from Testing import ZopeTestCase
 from zExceptions import Forbidden
 
@@ -41,29 +42,6 @@ def createMember(self, id, pw, email, roles=('Member', )):
                 'username': id, 'email': email})
         return member
 
-    def installation(self, productName, uninstall=False, reinstall=False):
-        assert not (uninstall and reinstall)
-        try:
-            from Products.CMFPlone.utils import get_installer
-        except ImportError:
-            # Plone 5.0
-            self.qi = self.portal.portal_quickinstaller
-            if uninstall:
-                self.qi.uninstallProducts([productName])
-            elif reinstall:
-                self.qi.installProduct(productName, reinstall=True)
-            else:
-                self.qi.installProduct(productName)
-        else:
-            self.qi = get_installer(self.portal)
-            if uninstall:
-                self.qi.uninstall_product(productName)
-            elif reinstall:
-                self.qi.uninstall_product(productName)
-                self.qi.install_product(productName)
-            else:
-                self.qi.install_product(productName)
-
     def setupSecurityContext(self, ):
         self.logout()
         self.loginAsPortalOwner()
@@ -73,7 +51,8 @@ def setupSecurityContext(self, ):
         self.user3 = self.createMember('user3', 'abcd4', 'abc@domain.tld')
 
         self.folder = self.portal.portal_membership.getHomeFolder('user1')
-        self.installation('CMFPlacefulWorkflow')
+        self.qi = get_installer(self.portal)
+        self.qi.install_product('CMFPlacefulWorkflow')
         self.logout()
 
     def afterSetUp(self, ):
@@ -110,19 +89,30 @@ def test_marker_applied_and_unapplied(self):
         """
         self.failUnless(IPlacefulMarker.providedBy(self.workflow))
         self.loginAsPortalOwner()
-        self.installation('CMFPlacefulWorkflow', uninstall=True)
+        self.qi.uninstall_product('CMFPlacefulWorkflow')
         self.failIf(IPlacefulMarker.providedBy(self.workflow))
 
-        self.installation('CMFPlacefulWorkflow')
+        self.qi.install_product('CMFPlacefulWorkflow')
         self.failUnless(IPlacefulMarker.providedBy(self.workflow))
 
     def test_reinstall(self):
         """
         Test if upgrade is going the good way
         """
-        self.installation('CMFPlacefulWorkflow', reinstall=True)
+        self.qi.uninstall_product('CMFPlacefulWorkflow')
+        self.qi.install_product('CMFPlacefulWorkflow')
         self.assertTrue('portal_placeful_workflow' in self.portal.objectIds())
 
+    def test_activation_reactivation(self):
+        """Test multiple installs and uninstalls."""
+        self.loginAsPortalOwner()
+        self.qi.uninstall_product('CMFPlacefulWorkflow')
+        self.assertFalse('portal_placeful_workflow' in self.portal)
+        self.qi.install_product('CMFPlacefulWorkflow')
+        self.assertTrue('portal_placeful_workflow' in self.portal)
+        self.qi.uninstall_product('CMFPlacefulWorkflow')
+        self.assertFalse('portal_placeful_workflow' in self.portal)
+
     def test_prefs_workflow_policy_mapping_set_PostOnly(self):
         """
         Check POST on mapping policy


Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2017-03-09T06:15:23+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/b82531aef63fd5084e575ac46662d29190257210

Merge pull request #17 from plone/remove-plone50-test-code-master

Removed Plone 5.0 installer code from tests.

Files changed:
M CHANGES.rst
M Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a93bb45..c855634 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Removed Plone 5.0 installer code from tests.
+  Test that multiple installs and uninstalls work.
+  See `issue 1959 <https://github.com/plone/Products.CMFPlone/issues/1959>`_.
+  [maurits]
 
 
 1.7.2 (2017-01-17)
diff --git a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
index 4c0b18c..e2feb13 100644
--- a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
+++ b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
@@ -23,6 +23,7 @@
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlacefulWorkflow.PlacefulWorkflowTool import WorkflowPolicyConfig_id
 from Products.CMFPlacefulWorkflow.interfaces import IPlacefulMarker
+from Products.CMFPlone.utils import get_installer
 from Testing import ZopeTestCase
 from zExceptions import Forbidden
 
@@ -41,29 +42,6 @@ def createMember(self, id, pw, email, roles=('Member', )):
                 'username': id, 'email': email})
         return member
 
-    def installation(self, productName, uninstall=False, reinstall=False):
-        assert not (uninstall and reinstall)
-        try:
-            from Products.CMFPlone.utils import get_installer
-        except ImportError:
-            # Plone 5.0
-            self.qi = self.portal.portal_quickinstaller
-            if uninstall:
-                self.qi.uninstallProducts([productName])
-            elif reinstall:
-                self.qi.installProduct(productName, reinstall=True)
-            else:
-                self.qi.installProduct(productName)
-        else:
-            self.qi = get_installer(self.portal)
-            if uninstall:
-                self.qi.uninstall_product(productName)
-            elif reinstall:
-                self.qi.uninstall_product(productName)
-                self.qi.install_product(productName)
-            else:
-                self.qi.install_product(productName)
-
     def setupSecurityContext(self, ):
         self.logout()
         self.loginAsPortalOwner()
@@ -73,7 +51,8 @@ def setupSecurityContext(self, ):
         self.user3 = self.createMember('user3', 'abcd4', 'abc@domain.tld')
 
         self.folder = self.portal.portal_membership.getHomeFolder('user1')
-        self.installation('CMFPlacefulWorkflow')
+        self.qi = get_installer(self.portal)
+        self.qi.install_product('CMFPlacefulWorkflow')
         self.logout()
 
     def afterSetUp(self, ):
@@ -110,19 +89,30 @@ def test_marker_applied_and_unapplied(self):
         """
         self.failUnless(IPlacefulMarker.providedBy(self.workflow))
         self.loginAsPortalOwner()
-        self.installation('CMFPlacefulWorkflow', uninstall=True)
+        self.qi.uninstall_product('CMFPlacefulWorkflow')
         self.failIf(IPlacefulMarker.providedBy(self.workflow))
 
-        self.installation('CMFPlacefulWorkflow')
+        self.qi.install_product('CMFPlacefulWorkflow')
         self.failUnless(IPlacefulMarker.providedBy(self.workflow))
 
     def test_reinstall(self):
         """
         Test if upgrade is going the good way
         """
-        self.installation('CMFPlacefulWorkflow', reinstall=True)
+        self.qi.uninstall_product('CMFPlacefulWorkflow')
+        self.qi.install_product('CMFPlacefulWorkflow')
         self.assertTrue('portal_placeful_workflow' in self.portal.objectIds())
 
+    def test_activation_reactivation(self):
+        """Test multiple installs and uninstalls."""
+        self.loginAsPortalOwner()
+        self.qi.uninstall_product('CMFPlacefulWorkflow')
+        self.assertFalse('portal_placeful_workflow' in self.portal)
+        self.qi.install_product('CMFPlacefulWorkflow')
+        self.assertTrue('portal_placeful_workflow' in self.portal)
+        self.qi.uninstall_product('CMFPlacefulWorkflow')
+        self.assertFalse('portal_placeful_workflow' in self.portal)
+
     def test_prefs_workflow_policy_mapping_set_PostOnly(self):
         """
         Check POST on mapping policy


