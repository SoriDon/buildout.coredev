Repository: plone.restapi


Branch: refs/heads/master
Date: 2018-09-13T21:28:08+02:00
Author: HÃ©ctor Velarde (hvelarde) <hvelarde@yahoo.com>
Commit: https://github.com/plone/plone.restapi/commit/ff3d6768e9ff05c98626049698c313c860d5d3e5

Avoid AttributeError on add-on installation (#619)

Avoid AttributeError on add-on installation

Files changed:
M CHANGES.rst
M src/plone/restapi/setuphandlers.py

b"diff --git a/CHANGES.rst b/CHANGES.rst\nindex b90ac783..3e350a9a 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -6,6 +6,9 @@ Changelog\n \n Bugfixes:\n \n+- Avoid ``AttributeError`` on add-on installation (fixes `#465 <https://github.com/plone/plone.restapi/issues/465>`_.\n+  [lukasgraf, hvelarde]\n+\n - Make search work with a path query containing a list of paths in a virtual hosting setting.\n   [sunew]\n \ndiff --git a/src/plone/restapi/setuphandlers.py b/src/plone/restapi/setuphandlers.py\nindex ce9f3c3e..3b6ef6f9 100644\n--- a/src/plone/restapi/setuphandlers.py\n+++ b/src/plone/restapi/setuphandlers.py\n@@ -4,6 +4,7 @@\n from plone.restapi.pas.plugin import JWTAuthenticationPlugin\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import INonInstallable\n+from Products.PluggableAuthService.interfaces.authservice import IPluggableAuthService  # noqa: E501\n from zope.interface import implementer\n \n \n@@ -30,7 +31,7 @@ def install_pas_plugin(context):\n     uf_parent = aq_inner(context)\n     while True:\n         uf = getToolByName(uf_parent, 'acl_users')\n-        if 'jwt_auth' not in uf:\n+        if IPluggableAuthService.providedBy(uf) and 'jwt_auth' not in uf:\n             plugin = JWTAuthenticationPlugin('jwt_auth')\n             uf._setObject(plugin.getId(), plugin)\n             plugin = uf['jwt_auth']\n"

