Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2016-12-07T01:05:02-06:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.portlets/commit/15f47243b2b6e5bd5d4bb744949a78e42757efa8

OFS.traversable cannot do unicode
Make sure, that ``utils.assignment_mapping_from_key`` traverses only to non-unicode paths.
OFS.traversable doesn't accept unicode paths.

Files changed:
M CHANGES.rst
M plone/app/portlets/tests/test_utils.py
M plone/app/portlets/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index aa153c0..419a3aa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Make sure, that ``utils.assignment_mapping_from_key`` traverses only to non-unicode paths.
+  OFS.traversable doesn't accept unicode paths.
+  [thet]
 
 
 4.2.2 (2016-11-18)
diff --git a/plone/app/portlets/tests/test_utils.py b/plone/app/portlets/tests/test_utils.py
index 9a6e9d8..41ab8ec 100644
--- a/plone/app/portlets/tests/test_utils.py
+++ b/plone/app/portlets/tests/test_utils.py
@@ -31,6 +31,17 @@ def testGetPortletFromContext(self):
         a = assignment_from_key(self.portal, u'plone.leftcolumn', CONTEXT_CATEGORY, path, 'foo')
         self.assertEqual(c, a)
 
+    def testGetPortletFromContextUnicodePath(self):
+        """Do not fail, if path is a unicode object.
+        plone.portlets.utils.unhashPortletInfo returns a unicode path key.
+        """
+        mapping = getMultiAdapter((self.portal, self.manager), IPortletAssignmentMapping)
+        c = classic.Assignment()
+        mapping['foo'] = c
+        path = u'/'.join(self.portal.getPhysicalPath())
+        a = assignment_from_key(self.portal, u'plone.leftcolumn', CONTEXT_CATEGORY, path, 'foo')
+        self.assertEqual(c, a)
+
     def testGetPortletFromUserCategory(self):
         c = classic.Assignment()
         self.cat[user_name]['foo'] = c
diff --git a/plone/app/portlets/utils.py b/plone/app/portlets/utils.py
index eb8a635..f4e56c6 100644
--- a/plone/app/portlets/utils.py
+++ b/plone/app/portlets/utils.py
@@ -50,6 +50,7 @@ def assignment_mapping_from_key(context, manager_name, category, key, create=Fal
                 path = path[len(portal_path)+1:]
             while path.startswith('/'):
                 path = path[1:]
+            path = path.encode('utf-8')  # OFS.traversable cannot do unicode
             obj = portal.restrictedTraverse(path, None)
         if obj is None:
             raise KeyError, "Cannot find object at path %s" % path


Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2016-12-09T10:43:07+01:00
Author: agitator (agitator) <hpeter@agitator.com>
Commit: https://github.com/plone/plone.app.portlets/commit/78b2ce381a0a3041ad9100a75520e408bbaf17ff

Merge pull request #92 from plone/thet-traversableunicodefix

OFS.traversable cannot do unicode

Files changed:
M CHANGES.rst
M plone/app/portlets/tests/test_utils.py
M plone/app/portlets/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index aa153c0..419a3aa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Make sure, that ``utils.assignment_mapping_from_key`` traverses only to non-unicode paths.
+  OFS.traversable doesn't accept unicode paths.
+  [thet]
 
 
 4.2.2 (2016-11-18)
diff --git a/plone/app/portlets/tests/test_utils.py b/plone/app/portlets/tests/test_utils.py
index 9a6e9d8..41ab8ec 100644
--- a/plone/app/portlets/tests/test_utils.py
+++ b/plone/app/portlets/tests/test_utils.py
@@ -31,6 +31,17 @@ def testGetPortletFromContext(self):
         a = assignment_from_key(self.portal, u'plone.leftcolumn', CONTEXT_CATEGORY, path, 'foo')
         self.assertEqual(c, a)
 
+    def testGetPortletFromContextUnicodePath(self):
+        """Do not fail, if path is a unicode object.
+        plone.portlets.utils.unhashPortletInfo returns a unicode path key.
+        """
+        mapping = getMultiAdapter((self.portal, self.manager), IPortletAssignmentMapping)
+        c = classic.Assignment()
+        mapping['foo'] = c
+        path = u'/'.join(self.portal.getPhysicalPath())
+        a = assignment_from_key(self.portal, u'plone.leftcolumn', CONTEXT_CATEGORY, path, 'foo')
+        self.assertEqual(c, a)
+
     def testGetPortletFromUserCategory(self):
         c = classic.Assignment()
         self.cat[user_name]['foo'] = c
diff --git a/plone/app/portlets/utils.py b/plone/app/portlets/utils.py
index eb8a635..f4e56c6 100644
--- a/plone/app/portlets/utils.py
+++ b/plone/app/portlets/utils.py
@@ -50,6 +50,7 @@ def assignment_mapping_from_key(context, manager_name, category, key, create=Fal
                 path = path[len(portal_path)+1:]
             while path.startswith('/'):
                 path = path[1:]
+            path = path.encode('utf-8')  # OFS.traversable cannot do unicode
             obj = portal.restrictedTraverse(path, None)
         if obj is None:
             raise KeyError, "Cannot find object at path %s" % path


