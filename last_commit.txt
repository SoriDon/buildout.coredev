Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-11-23T07:25:51+01:00
Author: Wesley Barroso Lopes (wesleybl) <wesleybl@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/a2e5343338429fa3680044682fd5177035ba6d2f

Fix random failures in tests (#1270)

* Fix random failure in test_serialize_to_json_collection_include_items

When we don't have the sort_on parameter, it's not guaranteed that the
search result will always come in the same order. This was causing the
test to fail randomly. So we sort the titles before comparing the
result.

This fixes the error:

AssertionError: 'Document 2' != 'Document 1'

* Fix random failure in test_querystringsearch_complex

When we don't have the sort_on parameter, it's not guaranteed that the
search result will always come in the same order. This was causing the
test to fail randomly. So we add the sort_on parameter to ensure that
the result always comes in the same order.

This fixes the error:

AssertionError: 'Test Document 8' != 'Test Document 4'

Files changed:
M src/plone/restapi/tests/test_serializer.py
M src/plone/restapi/tests/test_services_querystringsearch.py

b'diff --git a/src/plone/restapi/tests/test_serializer.py b/src/plone/restapi/tests/test_serializer.py\nindex a9d552f17..271b86c30 100644\n--- a/src/plone/restapi/tests/test_serializer.py\n+++ b/src/plone/restapi/tests/test_serializer.py\n@@ -385,8 +385,10 @@ def test_serialize_to_json_collection_include_items(self):\n         self.request.form["include_items"] = True\n         serialized = self.serialize(self.portal.collection1)\n         items = serialized.get("items")\n-        self.assertEqual(items[0]["title"], self.portal.doc1.Title())\n-        self.assertEqual(items[1]["title"], self.portal.doc2.Title())\n+        self.assertEqual(\n+            sorted([item["title"] for item in items]),\n+            [self.portal.doc1.Title(), self.portal.doc2.Title()],\n+        )\n         self.assertEqual(serialized.get("items_total"), 2)\n \n     def test_serialize_returns_site_root_common(self):\ndiff --git a/src/plone/restapi/tests/test_services_querystringsearch.py b/src/plone/restapi/tests/test_services_querystringsearch.py\nindex 0373ab07d..22c7ae07c 100644\n--- a/src/plone/restapi/tests/test_services_querystringsearch.py\n+++ b/src/plone/restapi/tests/test_services_querystringsearch.py\n@@ -130,6 +130,7 @@ def test_querystringsearch_complex(self):\n                     }\n                 ],\n                 "b_size": 5,\n+                "sort_on": "sortable_title",\n             },\n         )\n \n@@ -153,6 +154,7 @@ def test_querystringsearch_complex(self):\n                 ],\n                 "b_size": 5,\n                 "b_start": 5,\n+                "sort_on": "sortable_title",\n             },\n         )\n \n'

