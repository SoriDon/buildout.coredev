Repository: plone.testing


Branch: refs/heads/master
Date: 2018-10-02T17:28:33+02:00
Author: Joni Orponen (Rotonen) <joni.orponen@gmail.com>
Commit: https://github.com/plone/plone.testing/commit/702f3f68e1751186ebde1e0d216b366da4092e51

Enable picking a free port for ZServer layers automatically.

Files changed:
M CHANGES.rst
M src/plone/testing/z2.py
M src/plone/testing/z2.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex c74a653..8174869 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -6,7 +6,9 @@ Changelog\n \n Breaking changes:\n \n-- *add item here*\n+- Default to picking a dynamical port for ZServer layers instead of a static\n+  default port.\n+  [Rotonen]\n \n New features:\n \ndiff --git a/src/plone/testing/z2.py b/src/plone/testing/z2.py\nindex 17f7a83..b83dd91 100644\n--- a/src/plone/testing/z2.py\n+++ b/src/plone/testing/z2.py\n@@ -973,8 +973,10 @@ class ZServer(Layer):\n \n     defaultBases = (STARTUP,)\n \n-    host = os.environ.get(\'ZSERVER_HOST\', \'localhost\')\n-    port = int(os.environ.get(\'ZSERVER_PORT\', 55001))\n+    # Default to \'bindall\' (marked by an empty string) from os.socket\n+    host = os.environ.get(\'ZSERVER_HOST\', \'\')\n+    # Default to letting the OS allocate us a free port (marked by 0)\n+    port = int(os.environ.get(\'ZSERVER_PORT\', 0))\n     timeout = 5.0\n     log = None\n \n@@ -1044,6 +1046,17 @@ def setUpServer(self):\n \n         self.zserver = server\n \n+        # If we dynamically set the host/port, we want to reset it to localhost\n+        # Otherwise this will depend on, for example, the local network setup\n+        if self.host in (\'\', \'0.0.0.0\', \'127.0.0.1\', ):\n+            self.zserver.server_name = \'localhost\'\n+\n+        # Refresh the hostname and port in case we dynamically picked them\n+        self.host = self.zserver.server_name\n+        self[\'host\'] = self.host\n+        self.port = self.zserver.server_port\n+        self[\'port\'] = self.port\n+\n     def tearDownServer(self):\n         """Close the ZServer socket\n         """\n@@ -1092,8 +1105,10 @@ class FTPServer(ZServer):\n \n     defaultBases = (STARTUP,)\n \n-    host = os.environ.get(\'FTPSERVER_HOST\', \'localhost\')\n-    port = int(os.environ.get(\'FTPSERVER_PORT\', 55002))\n+    # Default to \'bindall\' (marked by an empty string) from os.socket\n+    host = os.environ.get(\'FTPSERVER_HOST\', \'\')\n+    # Default to letting the OS allocate us a free port (marked by 0)\n+    port = int(os.environ.get(\'FTPSERVER_PORT\', 0))\n     threads = 1\n     timeout = 5.0\n     log = None\n@@ -1118,6 +1133,20 @@ def setUpServer(self):\n             port=self.port,\n             logger_object=zopeLog)\n \n+\n+        # Refresh the hostname and port in case we dynamically picked them\n+        self.host, self.port = self.ftpServer.socket.getsockname()\n+\n+        # If we dynamically set the host/port, we want to reset it to localhost\n+        # Otherwise this will depend on, for example, the local network setup\n+        if self.host in (\'\', \'0.0.0.0\', \'127.0.0.1\', ):\n+            self.host = \'localhost\'\n+            self.ftpServer.hostname = \'localhost\'\n+            self.ftpServer.ip = \'127.0.0.1\'\n+\n+        self[\'host\'] = self.host\n+        self[\'port\'] = self.port\n+\n     def tearDownServer(self):\n         """Close the FTPServer socket\n         """\ndiff --git a/src/plone/testing/z2.rst b/src/plone/testing/z2.rst\nindex 9ab1b67..8b922ba 100644\n--- a/src/plone/testing/z2.rst\n+++ b/src/plone/testing/z2.rst\n@@ -467,13 +467,7 @@ The ``ZSERVER`` layer provides a ``FunctionalTesting`` layer that has ``ZSERVER_\n After layer setup, the resources ``host`` and ``port`` are available, and indicate where Zope is running.::\n \n     >>> host = z2.ZSERVER[\'host\']\n-    >>> host\n-    \'localhost\'\n-\n     >>> port = z2.ZSERVER[\'port\']\n-    >>> import os\n-    >>> port == int(os.environ.get(\'ZSERVER_PORT\', 55001))\n-    True\n \n Let\'s now simulate a test.\n Test setup does nothing beyond what the base layers do.::\n@@ -573,13 +567,7 @@ The ``FTP_SERVER`` layer is based on ``FTP_SERVER_FIXTURE``, using the ``Functio\n After layer setup, the resources ``host`` and ``port`` are available, and indicate where Zope is running.::\n \n     >>> host = z2.FTP_SERVER[\'host\']\n-    >>> host\n-    \'localhost\'\n-\n     >>> port = z2.FTP_SERVER[\'port\']\n-    >>> import os\n-    >>> port == int(os.environ.get(\'FTPSERVER_PORT\', 55002))\n-    True\n \n Let\'s now simulate a test.\n Test setup does nothing beyond what the base layers do.::\n'

Repository: plone.testing


Branch: refs/heads/master
Date: 2018-10-03T13:24:26+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.testing/commit/4e6bd262963421a976aa5517650a1c517c3f19c3

Merge pull request #52 from plone/jo-51

Enable picking a free port for ZServer layers automatically

Files changed:
M CHANGES.rst
M src/plone/testing/z2.py
M src/plone/testing/z2.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex c74a653..8174869 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -6,7 +6,9 @@ Changelog\n \n Breaking changes:\n \n-- *add item here*\n+- Default to picking a dynamical port for ZServer layers instead of a static\n+  default port.\n+  [Rotonen]\n \n New features:\n \ndiff --git a/src/plone/testing/z2.py b/src/plone/testing/z2.py\nindex 17f7a83..b83dd91 100644\n--- a/src/plone/testing/z2.py\n+++ b/src/plone/testing/z2.py\n@@ -973,8 +973,10 @@ class ZServer(Layer):\n \n     defaultBases = (STARTUP,)\n \n-    host = os.environ.get(\'ZSERVER_HOST\', \'localhost\')\n-    port = int(os.environ.get(\'ZSERVER_PORT\', 55001))\n+    # Default to \'bindall\' (marked by an empty string) from os.socket\n+    host = os.environ.get(\'ZSERVER_HOST\', \'\')\n+    # Default to letting the OS allocate us a free port (marked by 0)\n+    port = int(os.environ.get(\'ZSERVER_PORT\', 0))\n     timeout = 5.0\n     log = None\n \n@@ -1044,6 +1046,17 @@ def setUpServer(self):\n \n         self.zserver = server\n \n+        # If we dynamically set the host/port, we want to reset it to localhost\n+        # Otherwise this will depend on, for example, the local network setup\n+        if self.host in (\'\', \'0.0.0.0\', \'127.0.0.1\', ):\n+            self.zserver.server_name = \'localhost\'\n+\n+        # Refresh the hostname and port in case we dynamically picked them\n+        self.host = self.zserver.server_name\n+        self[\'host\'] = self.host\n+        self.port = self.zserver.server_port\n+        self[\'port\'] = self.port\n+\n     def tearDownServer(self):\n         """Close the ZServer socket\n         """\n@@ -1092,8 +1105,10 @@ class FTPServer(ZServer):\n \n     defaultBases = (STARTUP,)\n \n-    host = os.environ.get(\'FTPSERVER_HOST\', \'localhost\')\n-    port = int(os.environ.get(\'FTPSERVER_PORT\', 55002))\n+    # Default to \'bindall\' (marked by an empty string) from os.socket\n+    host = os.environ.get(\'FTPSERVER_HOST\', \'\')\n+    # Default to letting the OS allocate us a free port (marked by 0)\n+    port = int(os.environ.get(\'FTPSERVER_PORT\', 0))\n     threads = 1\n     timeout = 5.0\n     log = None\n@@ -1118,6 +1133,20 @@ def setUpServer(self):\n             port=self.port,\n             logger_object=zopeLog)\n \n+\n+        # Refresh the hostname and port in case we dynamically picked them\n+        self.host, self.port = self.ftpServer.socket.getsockname()\n+\n+        # If we dynamically set the host/port, we want to reset it to localhost\n+        # Otherwise this will depend on, for example, the local network setup\n+        if self.host in (\'\', \'0.0.0.0\', \'127.0.0.1\', ):\n+            self.host = \'localhost\'\n+            self.ftpServer.hostname = \'localhost\'\n+            self.ftpServer.ip = \'127.0.0.1\'\n+\n+        self[\'host\'] = self.host\n+        self[\'port\'] = self.port\n+\n     def tearDownServer(self):\n         """Close the FTPServer socket\n         """\ndiff --git a/src/plone/testing/z2.rst b/src/plone/testing/z2.rst\nindex 9ab1b67..8b922ba 100644\n--- a/src/plone/testing/z2.rst\n+++ b/src/plone/testing/z2.rst\n@@ -467,13 +467,7 @@ The ``ZSERVER`` layer provides a ``FunctionalTesting`` layer that has ``ZSERVER_\n After layer setup, the resources ``host`` and ``port`` are available, and indicate where Zope is running.::\n \n     >>> host = z2.ZSERVER[\'host\']\n-    >>> host\n-    \'localhost\'\n-\n     >>> port = z2.ZSERVER[\'port\']\n-    >>> import os\n-    >>> port == int(os.environ.get(\'ZSERVER_PORT\', 55001))\n-    True\n \n Let\'s now simulate a test.\n Test setup does nothing beyond what the base layers do.::\n@@ -573,13 +567,7 @@ The ``FTP_SERVER`` layer is based on ``FTP_SERVER_FIXTURE``, using the ``Functio\n After layer setup, the resources ``host`` and ``port`` are available, and indicate where Zope is running.::\n \n     >>> host = z2.FTP_SERVER[\'host\']\n-    >>> host\n-    \'localhost\'\n-\n     >>> port = z2.FTP_SERVER[\'port\']\n-    >>> import os\n-    >>> port == int(os.environ.get(\'FTPSERVER_PORT\', 55002))\n-    True\n \n Let\'s now simulate a test.\n Test setup does nothing beyond what the base layers do.::\n'

