Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-05-29T16:48:11+02:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/plone.namedfile/commit/9928a2099a1ce186c8f1720efffbe10fa3871115

Re added Compatibility for Plone 4

Files changed:
M CHANGES.rst
M plone/namedfile/utils/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b52c670..6d6bfd7 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -26,6 +26,9 @@ Bug fixes:
 - Fix: Do not log failing PIL image regognition as error, but as warning.
   [jensens]
 
+- Fix: compatibility for Plone 4 re-added.
+  [loechel]
+
 
 4.2.0 (2017-03-26)
 ------------------
diff --git a/plone/namedfile/utils/__init__.py b/plone/namedfile/utils/__init__.py
index 7ce3350..1508ca9 100644
--- a/plone/namedfile/utils/__init__.py
+++ b/plone/namedfile/utils/__init__.py
@@ -1,12 +1,12 @@
 # -*- coding: utf-8 -*-
 
 from logging import getLogger
+from plone import api
 from plone.namedfile.interfaces import IBlobby
 from plone.namedfile.utils.jpeg_utils import process_jpeg
 from plone.namedfile.utils.png_utils import process_png
 from plone.namedfile.utils.tiff_utils import process_tiff
 from plone.registry.interfaces import IRegistry
-from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
 from StringIO import StringIO
 from zope.component import queryUtility
 
@@ -17,6 +17,10 @@
 import struct
 import urllib
 
+if api.env.plone_version() >= '5.0':
+    import pdb; pdb.set_trace()
+    from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
+
 
 log = getLogger(__name__)
 
@@ -272,14 +276,16 @@ def getRetinaScales():
     registry = queryUtility(IRegistry)
     if not registry:
         return []
-    settings = registry.forInterface(
-        IImagingSchema, prefix='plone', check=False)
-    if settings.retina_scales == '2x':
+    if api.env.plone_version() >= '5.0':
+        settings = registry.forInterface(
+            IImagingSchema, prefix='plone', check=False)
+
+    if settings and settings.retina_scales == '2x':
         return [{
             'scale': 2,
             'quality': settings.quality_2x,
         }]
-    if settings.retina_scales == '3x':
+    elif settings and settings.retina_scales == '3x':
         return [
             {
                 'scale': 2,


Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-05-29T16:57:32+02:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/plone.namedfile/commit/72d38c9a506968dd7e1e45cf8e7a213515830381

move import to location where it acutally is used

Files changed:
M plone/namedfile/utils/__init__.py

diff --git a/plone/namedfile/utils/__init__.py b/plone/namedfile/utils/__init__.py
index 1508ca9..e55368b 100644
--- a/plone/namedfile/utils/__init__.py
+++ b/plone/namedfile/utils/__init__.py
@@ -17,10 +17,6 @@
 import struct
 import urllib
 
-if api.env.plone_version() >= '5.0':
-    import pdb; pdb.set_trace()
-    from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
-
 
 log = getLogger(__name__)
 
@@ -277,6 +273,7 @@ def getRetinaScales():
     if not registry:
         return []
     if api.env.plone_version() >= '5.0':
+        from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
         settings = registry.forInterface(
             IImagingSchema, prefix='plone', check=False)
 


Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-05-29T17:06:06+02:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/plone.namedfile/commit/2af19ecacfb73380a86810413c85041a34fb1a3d

cleanup of getRetinaScales

Files changed:
M plone/namedfile/utils/__init__.py

diff --git a/plone/namedfile/utils/__init__.py b/plone/namedfile/utils/__init__.py
index e55368b..94fa6eb 100644
--- a/plone/namedfile/utils/__init__.py
+++ b/plone/namedfile/utils/__init__.py
@@ -1,7 +1,6 @@
 # -*- coding: utf-8 -*-
 
 from logging import getLogger
-from plone import api
 from plone.namedfile.interfaces import IBlobby
 from plone.namedfile.utils.jpeg_utils import process_jpeg
 from plone.namedfile.utils.png_utils import process_png
@@ -269,27 +268,21 @@ def rotate_image(image_data, method=None, REQUEST=None):
 
 
 def getRetinaScales():
-    registry = queryUtility(IRegistry)
-    if not registry:
-        return []
-    if api.env.plone_version() >= '5.0':
+    try:
         from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
-        settings = registry.forInterface(
-            IImagingSchema, prefix='plone', check=False)
-
-    if settings and settings.retina_scales == '2x':
-        return [{
-            'scale': 2,
-            'quality': settings.quality_2x,
-        }]
-    elif settings and settings.retina_scales == '3x':
-        return [
-            {
-                'scale': 2,
-                'quality': settings.quality_2x,
-            },
-            {
-                'scale': 3,
-                'quality': settings.quality_3x,
-            }]
+        registry = queryUtility(IRegistry)
+        if registy:
+            settings = registry.forInterface(
+                IImagingSchema, prefix='plone', check=False)
+            if settings.retina_scales == '2x':
+                return [
+                    {'scale': 2, 'quality': settings.quality_2x},
+                ]
+            elif settings.retina_scales == '3x':
+                return [
+                    {'scale': 2, 'quality': settings.quality_2x},
+                    {'scale': 3, 'quality': settings.quality_3x},
+                ]
+    except ImportError:
+        log.info('IImagingSchema for Retina Scales not importable.')
     return []


Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-05-30T13:25:39+02:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/plone.namedfile/commit/be41dd1846523c67774484eddd8f918679e9ef8a

move try except Import to module level

Files changed:
M plone/namedfile/utils/__init__.py

diff --git a/plone/namedfile/utils/__init__.py b/plone/namedfile/utils/__init__.py
index 94fa6eb..44fa146 100644
--- a/plone/namedfile/utils/__init__.py
+++ b/plone/namedfile/utils/__init__.py
@@ -19,6 +19,12 @@
 
 log = getLogger(__name__)
 
+try:
+    from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
+except ImportError:
+    IImagingSchema = None
+    log.info('IImagingSchema for Retina Scales not available.')
+
 
 try:
     # use this to stream data if we can
@@ -268,21 +274,17 @@ def rotate_image(image_data, method=None, REQUEST=None):
 
 
 def getRetinaScales():
-    try:
-        from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
-        registry = queryUtility(IRegistry)
-        if registy:
-            settings = registry.forInterface(
-                IImagingSchema, prefix='plone', check=False)
-            if settings.retina_scales == '2x':
-                return [
-                    {'scale': 2, 'quality': settings.quality_2x},
-                ]
-            elif settings.retina_scales == '3x':
-                return [
-                    {'scale': 2, 'quality': settings.quality_2x},
-                    {'scale': 3, 'quality': settings.quality_3x},
-                ]
-    except ImportError:
-        log.info('IImagingSchema for Retina Scales not importable.')
+    registry = queryUtility(IRegistry)
+    if IImagingSchema and registry:
+        settings = registry.forInterface(
+            IImagingSchema, prefix='plone', check=False)
+        if settings.retina_scales == '2x':
+            return [
+                {'scale': 2, 'quality': settings.quality_2x},
+            ]
+        elif settings.retina_scales == '3x':
+            return [
+                {'scale': 2, 'quality': settings.quality_2x},
+                {'scale': 3, 'quality': settings.quality_3x},
+            ]
     return []


Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-05-30T16:31:40+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.namedfile/commit/06998233b7157049e9461b3323d3a34da316d552

Merge pull request #51 from plone/p4_compat

Re added Compatibility for Plone 4

Files changed:
M CHANGES.rst
M plone/namedfile/utils/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b52c670..6d6bfd7 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -26,6 +26,9 @@ Bug fixes:
 - Fix: Do not log failing PIL image regognition as error, but as warning.
   [jensens]
 
+- Fix: compatibility for Plone 4 re-added.
+  [loechel]
+
 
 4.2.0 (2017-03-26)
 ------------------
diff --git a/plone/namedfile/utils/__init__.py b/plone/namedfile/utils/__init__.py
index 7ce3350..44fa146 100644
--- a/plone/namedfile/utils/__init__.py
+++ b/plone/namedfile/utils/__init__.py
@@ -6,7 +6,6 @@
 from plone.namedfile.utils.png_utils import process_png
 from plone.namedfile.utils.tiff_utils import process_tiff
 from plone.registry.interfaces import IRegistry
-from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
 from StringIO import StringIO
 from zope.component import queryUtility
 
@@ -20,6 +19,12 @@
 
 log = getLogger(__name__)
 
+try:
+    from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
+except ImportError:
+    IImagingSchema = None
+    log.info('IImagingSchema for Retina Scales not available.')
+
 
 try:
     # use this to stream data if we can
@@ -270,23 +275,16 @@ def rotate_image(image_data, method=None, REQUEST=None):
 
 def getRetinaScales():
     registry = queryUtility(IRegistry)
-    if not registry:
-        return []
-    settings = registry.forInterface(
-        IImagingSchema, prefix='plone', check=False)
-    if settings.retina_scales == '2x':
-        return [{
-            'scale': 2,
-            'quality': settings.quality_2x,
-        }]
-    if settings.retina_scales == '3x':
-        return [
-            {
-                'scale': 2,
-                'quality': settings.quality_2x,
-            },
-            {
-                'scale': 3,
-                'quality': settings.quality_3x,
-            }]
+    if IImagingSchema and registry:
+        settings = registry.forInterface(
+            IImagingSchema, prefix='plone', check=False)
+        if settings.retina_scales == '2x':
+            return [
+                {'scale': 2, 'quality': settings.quality_2x},
+            ]
+        elif settings.retina_scales == '3x':
+            return [
+                {'scale': 2, 'quality': settings.quality_2x},
+                {'scale': 3, 'quality': settings.quality_3x},
+            ]
     return []


