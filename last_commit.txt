Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2017-08-01T21:38:43Z
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/684925af03d7eb3358463a6dfc800a3b8510a472

Make AT imports optional

Files changed:
M plone/app/linkintegrity/tests/test_upgrade.py
M plone/app/linkintegrity/upgrades.py

diff --git a/plone/app/linkintegrity/tests/test_upgrade.py b/plone/app/linkintegrity/tests/test_upgrade.py
index 0b1119b..3f3913b 100644
--- a/plone/app/linkintegrity/tests/test_upgrade.py
+++ b/plone/app/linkintegrity/tests/test_upgrade.py
@@ -3,12 +3,19 @@
 from plone.app.linkintegrity.tests.base import ATBaseTestCase
 from plone.app.linkintegrity.upgrades import migrate_linkintegrity_relations
 from plone.app.linkintegrity.utils import hasIncomingLinks
-from Products.Archetypes.interfaces import IReferenceable
+try:
+    from Products.Archetypes.interfaces import IReferenceable
+    HAS_AT = True
+except ImportError:
+    HAS_AT = False
+import unittest
 
 
 class ReferenceMigrationATTestCase(ATBaseTestCase):
     """Reference migration testcase for at content types"""
 
+    @unittest.skipUnless(
+        HAS_AT, 'Archetypes are not installed. Skipping migration tests')
     def test_upgrade(self):
         doc3 = self.portal['doc3']
         doc1 = self.portal['doc1']
diff --git a/plone/app/linkintegrity/upgrades.py b/plone/app/linkintegrity/upgrades.py
index 0a93b8d..50a8669 100644
--- a/plone/app/linkintegrity/upgrades.py
+++ b/plone/app/linkintegrity/upgrades.py
@@ -1,7 +1,10 @@
 # -*- coding: utf-8 -*-
 from plone.app.linkintegrity.handlers import referencedRelationship
 from plone.app.uuid.utils import uuidToObject
-from Products.Archetypes.config import REFERENCE_CATALOG
+try:
+    from Products.Archetypes.config import REFERENCE_CATALOG
+except ImportError:
+    REFERENCE_CATALOG = "reference_catalog"
 from Products.CMFCore.utils import getToolByName
 from zope.lifecycleevent import modified
 


Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2017-08-01T21:39:40Z
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/f9d1ac67bb04088e0dd0ae129a25759b13026aa3

Document changes

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 2a0912a..1161e48 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -17,6 +17,8 @@ Bug fixes:
 - Do not fail on invalid objects in referenec_catalog. Fixes #32 and #48
   [pbauer]
 
+- Fix undeclared hard dependency on Archetypes
+  [tomgross]
 
 3.3.1 (2017-06-01)
 ------------------


Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2017-08-07T11:50:24+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/964d044759f6e728753c10ea5c808a882a7fcd12

Merge pull request #57 from plone/tg_no_hard_at_dep

Remove undeclared/hard dependency on Archetypes

Files changed:
M CHANGES.rst
M plone/app/linkintegrity/tests/test_upgrade.py
M plone/app/linkintegrity/upgrades.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 2a0912a..1161e48 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -17,6 +17,8 @@ Bug fixes:
 - Do not fail on invalid objects in referenec_catalog. Fixes #32 and #48
   [pbauer]
 
+- Fix undeclared hard dependency on Archetypes
+  [tomgross]
 
 3.3.1 (2017-06-01)
 ------------------
diff --git a/plone/app/linkintegrity/tests/test_upgrade.py b/plone/app/linkintegrity/tests/test_upgrade.py
index 0b1119b..3f3913b 100644
--- a/plone/app/linkintegrity/tests/test_upgrade.py
+++ b/plone/app/linkintegrity/tests/test_upgrade.py
@@ -3,12 +3,19 @@
 from plone.app.linkintegrity.tests.base import ATBaseTestCase
 from plone.app.linkintegrity.upgrades import migrate_linkintegrity_relations
 from plone.app.linkintegrity.utils import hasIncomingLinks
-from Products.Archetypes.interfaces import IReferenceable
+try:
+    from Products.Archetypes.interfaces import IReferenceable
+    HAS_AT = True
+except ImportError:
+    HAS_AT = False
+import unittest
 
 
 class ReferenceMigrationATTestCase(ATBaseTestCase):
     """Reference migration testcase for at content types"""
 
+    @unittest.skipUnless(
+        HAS_AT, 'Archetypes are not installed. Skipping migration tests')
     def test_upgrade(self):
         doc3 = self.portal['doc3']
         doc1 = self.portal['doc1']
diff --git a/plone/app/linkintegrity/upgrades.py b/plone/app/linkintegrity/upgrades.py
index 0a93b8d..50a8669 100644
--- a/plone/app/linkintegrity/upgrades.py
+++ b/plone/app/linkintegrity/upgrades.py
@@ -1,7 +1,10 @@
 # -*- coding: utf-8 -*-
 from plone.app.linkintegrity.handlers import referencedRelationship
 from plone.app.uuid.utils import uuidToObject
-from Products.Archetypes.config import REFERENCE_CATALOG
+try:
+    from Products.Archetypes.config import REFERENCE_CATALOG
+except ImportError:
+    REFERENCE_CATALOG = "reference_catalog"
 from Products.CMFCore.utils import getToolByName
 from zope.lifecycleevent import modified
 


