Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-04-19T21:09:14+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/511f588e38923a7a35f3d1acfc6ed1a10985488b

Mockup TinyMCE settings: Fix URLs in TinyMCE external_plugins settings.

Add the portal URL to external_plugins values for relative and absolute
URLs.

Before this fix external plugins could not be found if they were not added with
the full path or a full URL. The path is different for virtual hosted sites and
sites directly served from Zope.

Files changed:
A news/3767.bugfix
M Products/CMFPlone/patterns/tinymce.py
M Products/CMFPlone/tests/test_patternsettings.py

b'diff --git a/Products/CMFPlone/patterns/tinymce.py b/Products/CMFPlone/patterns/tinymce.py\nindex 43206c8384..c3dbe18abb 100644\n--- a/Products/CMFPlone/patterns/tinymce.py\n+++ b/Products/CMFPlone/patterns/tinymce.py\n@@ -171,7 +171,13 @@ def get_tiny_config(self):\n             parts = plugin.split("|")\n             if len(parts) != 2:\n                 continue\n-            tiny_config["external_plugins"][parts[0]] = parts[1]\n+            url = parts[1].strip()\n+            if not url:\n+                continue\n+            if url.find("//", 0, 8) == -1:\n+                # assuming relative/absolute w/out url scheme\n+                url = f"{self.nav_root_url}/{url}"\n+            tiny_config["external_plugins"][parts[0]] = url\n \n         tiny_config["style_formats"] = self.get_all_style_formats()\n         if settings.formats:\ndiff --git a/Products/CMFPlone/tests/test_patternsettings.py b/Products/CMFPlone/tests/test_patternsettings.py\nindex fd4c38fe0f..7309f9f813 100644\n--- a/Products/CMFPlone/tests/test_patternsettings.py\n+++ b/Products/CMFPlone/tests/test_patternsettings.py\n@@ -44,6 +44,47 @@ def test_other_settings(self):\n         conf = self.get_conf()\n         self.assertEqual(conf[\'tiny\'][\'foo\'], \'bar\')\n \n+    def test_external_plugins(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(ITinyMCESchema, prefix="plone")\n+        settings.custom_plugins = [\n+            "plugin1|https://example.com/plugin1.js",\n+            "plugin2|//example.com/plugin2.js",\n+            "plugin3|/plugin3.js",\n+            "plugin4|plugin4.js",\n+            "plugin5|  plugin5.js  ",\n+            "plugin6|../plugin6.js",\n+            "plugin7|",\n+            "plugin8",\n+        ]\n+        conf = self.get_conf()\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin1"],\n+            "https://example.com/plugin1.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin2"],\n+            "//example.com/plugin2.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin3"],\n+            "http://nohost/plone//plugin3.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin4"],\n+            "http://nohost/plone/plugin4.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin5"],\n+            "http://nohost/plone/plugin5.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin6"],\n+            "http://nohost/plone/../plugin6.js",\n+        )\n+        self.assertNotIn("plugin7", conf["tiny"]["external_plugins"])\n+        self.assertNotIn("plugin8", conf["tiny"]["external_plugins"])\n+\n \n class TestPatternSettingsView(unittest.TestCase):\n     """Ensure that the basic redirector setup is successful.\ndiff --git a/news/3767.bugfix b/news/3767.bugfix\nnew file mode 100644\nindex 0000000000..73af0c1102\n--- /dev/null\n+++ b/news/3767.bugfix\n@@ -0,0 +1,8 @@\n+Mockup TinyMCE settings: Fix URLs in TinyMCE external_plugins settings.\n+\n+Add the portal URL to external_plugins values for relative and absolute\n+URLs.\n+\n+Before this fix external plugins could not be found if they were not added with\n+the full path or a full URL. The path is different for virtual hosted sites and\n+sites directly served from Zope.\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-04-20T08:57:54+02:00
Author: Peter Mathis (petschki) <petschki@users.noreply.github.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/4a81ae1abc2406344edb18eec6bd896fa3641d9a

Merge pull request #3767 from plone/tinymce-external-plugins

Fix URLs in TinyMCE external_plugins settings

Files changed:
A news/3767.bugfix
M Products/CMFPlone/patterns/tinymce.py
M Products/CMFPlone/tests/test_patternsettings.py

b'diff --git a/Products/CMFPlone/patterns/tinymce.py b/Products/CMFPlone/patterns/tinymce.py\nindex 43206c8384..c3dbe18abb 100644\n--- a/Products/CMFPlone/patterns/tinymce.py\n+++ b/Products/CMFPlone/patterns/tinymce.py\n@@ -171,7 +171,13 @@ def get_tiny_config(self):\n             parts = plugin.split("|")\n             if len(parts) != 2:\n                 continue\n-            tiny_config["external_plugins"][parts[0]] = parts[1]\n+            url = parts[1].strip()\n+            if not url:\n+                continue\n+            if url.find("//", 0, 8) == -1:\n+                # assuming relative/absolute w/out url scheme\n+                url = f"{self.nav_root_url}/{url}"\n+            tiny_config["external_plugins"][parts[0]] = url\n \n         tiny_config["style_formats"] = self.get_all_style_formats()\n         if settings.formats:\ndiff --git a/Products/CMFPlone/tests/test_patternsettings.py b/Products/CMFPlone/tests/test_patternsettings.py\nindex fd4c38fe0f..7309f9f813 100644\n--- a/Products/CMFPlone/tests/test_patternsettings.py\n+++ b/Products/CMFPlone/tests/test_patternsettings.py\n@@ -44,6 +44,47 @@ def test_other_settings(self):\n         conf = self.get_conf()\n         self.assertEqual(conf[\'tiny\'][\'foo\'], \'bar\')\n \n+    def test_external_plugins(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(ITinyMCESchema, prefix="plone")\n+        settings.custom_plugins = [\n+            "plugin1|https://example.com/plugin1.js",\n+            "plugin2|//example.com/plugin2.js",\n+            "plugin3|/plugin3.js",\n+            "plugin4|plugin4.js",\n+            "plugin5|  plugin5.js  ",\n+            "plugin6|../plugin6.js",\n+            "plugin7|",\n+            "plugin8",\n+        ]\n+        conf = self.get_conf()\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin1"],\n+            "https://example.com/plugin1.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin2"],\n+            "//example.com/plugin2.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin3"],\n+            "http://nohost/plone//plugin3.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin4"],\n+            "http://nohost/plone/plugin4.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin5"],\n+            "http://nohost/plone/plugin5.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin6"],\n+            "http://nohost/plone/../plugin6.js",\n+        )\n+        self.assertNotIn("plugin7", conf["tiny"]["external_plugins"])\n+        self.assertNotIn("plugin8", conf["tiny"]["external_plugins"])\n+\n \n class TestPatternSettingsView(unittest.TestCase):\n     """Ensure that the basic redirector setup is successful.\ndiff --git a/news/3767.bugfix b/news/3767.bugfix\nnew file mode 100644\nindex 0000000000..73af0c1102\n--- /dev/null\n+++ b/news/3767.bugfix\n@@ -0,0 +1,8 @@\n+Mockup TinyMCE settings: Fix URLs in TinyMCE external_plugins settings.\n+\n+Add the portal URL to external_plugins values for relative and absolute\n+URLs.\n+\n+Before this fix external plugins could not be found if they were not added with\n+the full path or a full URL. The path is different for virtual hosted sites and\n+sites directly served from Zope.\n'

