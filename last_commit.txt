Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2016-11-08T16:59:11+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.Archetypes/commit/a05a65ed87278698330fe6127f641432e0df6847

Do not show uninstall profile on install

Files changed:
M Products/Archetypes/profiles.zcml
M Products/Archetypes/setuphandlers.py

diff --git a/Products/Archetypes/profiles.zcml b/Products/Archetypes/profiles.zcml
index 866157f..b59ce6c 100644
--- a/Products/Archetypes/profiles.zcml
+++ b/Products/Archetypes/profiles.zcml
@@ -18,4 +18,9 @@
       provides="Products.GenericSetup.interfaces.EXTENSION"
       />
 
+  <utility
+      name="Products.Archetypes"
+      factory=".setuphandlers.HiddenProfiles"
+    />
+
 </configure>
diff --git a/Products/Archetypes/setuphandlers.py b/Products/Archetypes/setuphandlers.py
index 9b2a361..ed73bd0 100644
--- a/Products/Archetypes/setuphandlers.py
+++ b/Products/Archetypes/setuphandlers.py
@@ -1,9 +1,25 @@
 """
 Archetypes setup handlers.
 """
-
+from Products.Archetypes.config import REFERENCE_CATALOG
+from Products.Archetypes.config import TOOL_NAME
+from Products.Archetypes.config import UID_CATALOG
 from Products.CMFCore.utils import getToolByName
-from Products.Archetypes.config import TOOL_NAME, REFERENCE_CATALOG, UID_CATALOG
+from Products.CMFPlone.interfaces import INonInstallable
+from zope.interface import implementer
+
+
+@implementer(INonInstallable)
+class HiddenProfiles(object):
+
+    def getNonInstallableProfiles(self):
+        """Prevents uninstall profile from showing up in the profile list
+        when creating a Plone site.
+
+        """
+        return [
+            u'Products.Archetypes:uninstall',
+        ]
 
 
 def install_uidcatalog(out, site, rebuild=False):
@@ -23,7 +39,7 @@ def install_uidcatalog(out, site, rebuild=False):
             reindex = True
 
     for metadata in metadata_defs:
-        if not indexName in catalog.schema():
+        if indexName not in catalog.schema():
             catalog.addColumn(metadata)
             reindex = True
     if reindex:
@@ -39,10 +55,10 @@ def install_referenceCatalog(out, site, rebuild=False):
                                  ('targetUID', 'FieldIndex'),
                                  ('relationship', 'FieldIndex'),
                                  ('targetId', 'FieldIndex'),):
-        if not indexName in catalog.indexes():
+        if indexName not in catalog.indexes():
             catalog.addIndex(indexName, indexType, extra=None)
             reindex = True
-        if not indexName in catalog.schema():
+        if indexName not in catalog.schema():
             catalog.addColumn(indexName)
             reindex = True
     if reindex:


