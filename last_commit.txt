Repository: Products.CMFDynamicViewFTI


Branch: refs/heads/master
Date: 2018-11-07T15:08:00+09:00
Author: Gauthier Bastien (gbastien) <g.bastien@imio.be>
Commit: https://github.com/plone/Products.CMFDynamicViewFTI/commit/176e51f97c9ceed15d4969298eb5fc2b02d8b5ba

Added test showing that fti.defaultView fallback to default view is broken

Files changed:
M Products/CMFDynamicViewFTI/tests/test_fti.py

b"diff --git a/Products/CMFDynamicViewFTI/tests/test_fti.py b/Products/CMFDynamicViewFTI/tests/test_fti.py\nindex e9cb10a..f1aefdf 100644\n--- a/Products/CMFDynamicViewFTI/tests/test_fti.py\n+++ b/Products/CMFDynamicViewFTI/tests/test_fti.py\n@@ -190,6 +190,15 @@ def test_NonFolderishObjectReturnsNone(self):\n         info = self.types.getTypeInfo(dynfolder)\n         self.assertEqual(info.getDefaultPage(dynfolder), None)\n \n+    def test_DefaultViewWithBadLayoutUseFallback(self):\n+        dynfolder = self._makeOne()\n+        dynfolder.layout = 'bad_view'\n+        info = self.types.getTypeInfo(dynfolder)\n+        self.assertEqual(\n+            info.defaultView(dynfolder),\n+            'index_html'\n+        )\n+\n \n if six.PY2:\n     # I have no idea what is or should be happending here.\n"

Repository: Products.CMFDynamicViewFTI


Branch: refs/heads/master
Date: 2018-12-04T12:35:03+01:00
Author: Gauthier Bastien (gbastien) <g.bastien@imio.be>
Commit: https://github.com/plone/Products.CMFDynamicViewFTI/commit/71dfd0ffe99b6eaaeab4726b41e297d2c3383ae3

Pass **kw from browserdefault.getLayout to fti.getViewMethod to be able to handle the "check_exists" parameter to fix issue with fallback to default view not working.

Files changed:
A news/16.bugfix
M Products/CMFDynamicViewFTI/browserdefault.py

b'diff --git a/Products/CMFDynamicViewFTI/browserdefault.py b/Products/CMFDynamicViewFTI/browserdefault.py\nindex bc9b5f4..48f8396 100644\n--- a/Products/CMFDynamicViewFTI/browserdefault.py\n+++ b/Products/CMFDynamicViewFTI/browserdefault.py\n@@ -96,7 +96,7 @@ def getLayout(self, **kw):\n         fti = self.getTypeInfo()\n         if fti is None:\n             return None\n-        return fti.getViewMethod(self)\n+        return fti.getViewMethod(self, **kw)\n \n     @security.public\n     def canSetDefaultPage(self):\ndiff --git a/news/16.bugfix b/news/16.bugfix\nnew file mode 100644\nindex 0000000..41dd9c9\n--- /dev/null\n+++ b/news/16.bugfix\n@@ -0,0 +1 @@\n+Fixed fallback to default view. [gbastien]\n'

Repository: Products.CMFDynamicViewFTI


Branch: refs/heads/master
Date: 2018-12-06T09:22:21+01:00
Author: Gauthier Bastien (gbastien) <g.bastien@imio.be>
Commit: https://github.com/plone/Products.CMFDynamicViewFTI/commit/20e763854f86bcd52e7968681b9ace300c046bd0

type_info.default_view_fallback is False by default, enable it so it works in test

Files changed:
M Products/CMFDynamicViewFTI/tests/test_fti.py

b"diff --git a/Products/CMFDynamicViewFTI/tests/test_fti.py b/Products/CMFDynamicViewFTI/tests/test_fti.py\nindex f1aefdf..da646b9 100644\n--- a/Products/CMFDynamicViewFTI/tests/test_fti.py\n+++ b/Products/CMFDynamicViewFTI/tests/test_fti.py\n@@ -2,7 +2,6 @@\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n from Products.CMFCore.interfaces import ITypeInformation\n-from Products.CMFCore.utils import getToolByName\n from Products.CMFDynamicViewFTI.fti import DynamicViewTypeInformation\n from Products.CMFDynamicViewFTI.interfaces import IDynamicViewTypeInformation\n from Products.CMFDynamicViewFTI.tests import CMFDVFTITestCase\n@@ -194,11 +193,18 @@ def test_DefaultViewWithBadLayoutUseFallback(self):\n         dynfolder = self._makeOne()\n         dynfolder.layout = 'bad_view'\n         info = self.types.getTypeInfo(dynfolder)\n+        # fallback not returned if not activated\n+        self.assertFalse(info.default_view_fallback)\n         self.assertEqual(\n             info.defaultView(dynfolder),\n-            'index_html'\n+            'bad_view'\n+        )\n+        # enable fallback\n+        info.default_view_fallback = True\n+        self.assertEqual(\n+            info.defaultView(dynfolder),\n+            info.default_view\n         )\n-\n \n if six.PY2:\n     # I have no idea what is or should be happending here.\n"

Repository: Products.CMFDynamicViewFTI


Branch: refs/heads/master
Date: 2018-12-06T16:07:19+01:00
Author: Gauthier Bastien (gbastien) <g.bastien@imio.be>
Commit: https://github.com/plone/Products.CMFDynamicViewFTI/commit/3b8ffda66c53726faba9525cc9d493264eddb3c1

When check_exists, check also if layout is a view

Files changed:
M Products/CMFDynamicViewFTI/fti.py

b'diff --git a/Products/CMFDynamicViewFTI/fti.py b/Products/CMFDynamicViewFTI/fti.py\nindex 36e81fd..2d2cb51 100644\n--- a/Products/CMFDynamicViewFTI/fti.py\n+++ b/Products/CMFDynamicViewFTI/fti.py\n@@ -150,7 +150,10 @@ def getViewMethod(\n         if check_exists:\n             method = getattr(context, layout, None)\n             if method is None:\n-                return default\n+                # maybe it is a view?\n+                view = context.unrestrictedTraverse(layout, None)\n+                if not view:\n+                    return default\n         return layout\n \n     @security.protected(View)\n'

Repository: Products.CMFDynamicViewFTI


Branch: refs/heads/master
Date: 2018-12-31T01:56:42+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFDynamicViewFTI/commit/85cbcf07b57851d1f7d9c344abd54be7282a1c7b

Merge pull request #17 from plone/defaultView_fallback_broken

Default view fallback broken

Files changed:
A news/16.bugfix
M Products/CMFDynamicViewFTI/browserdefault.py
M Products/CMFDynamicViewFTI/fti.py
M Products/CMFDynamicViewFTI/tests/test_fti.py

b"diff --git a/Products/CMFDynamicViewFTI/browserdefault.py b/Products/CMFDynamicViewFTI/browserdefault.py\nindex bc9b5f4..48f8396 100644\n--- a/Products/CMFDynamicViewFTI/browserdefault.py\n+++ b/Products/CMFDynamicViewFTI/browserdefault.py\n@@ -96,7 +96,7 @@ def getLayout(self, **kw):\n         fti = self.getTypeInfo()\n         if fti is None:\n             return None\n-        return fti.getViewMethod(self)\n+        return fti.getViewMethod(self, **kw)\n \n     @security.public\n     def canSetDefaultPage(self):\ndiff --git a/Products/CMFDynamicViewFTI/fti.py b/Products/CMFDynamicViewFTI/fti.py\nindex 36e81fd..2d2cb51 100644\n--- a/Products/CMFDynamicViewFTI/fti.py\n+++ b/Products/CMFDynamicViewFTI/fti.py\n@@ -150,7 +150,10 @@ def getViewMethod(\n         if check_exists:\n             method = getattr(context, layout, None)\n             if method is None:\n-                return default\n+                # maybe it is a view?\n+                view = context.unrestrictedTraverse(layout, None)\n+                if not view:\n+                    return default\n         return layout\n \n     @security.protected(View)\ndiff --git a/Products/CMFDynamicViewFTI/tests/test_fti.py b/Products/CMFDynamicViewFTI/tests/test_fti.py\nindex e9cb10a..da646b9 100644\n--- a/Products/CMFDynamicViewFTI/tests/test_fti.py\n+++ b/Products/CMFDynamicViewFTI/tests/test_fti.py\n@@ -2,7 +2,6 @@\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n from Products.CMFCore.interfaces import ITypeInformation\n-from Products.CMFCore.utils import getToolByName\n from Products.CMFDynamicViewFTI.fti import DynamicViewTypeInformation\n from Products.CMFDynamicViewFTI.interfaces import IDynamicViewTypeInformation\n from Products.CMFDynamicViewFTI.tests import CMFDVFTITestCase\n@@ -190,6 +189,22 @@ def test_NonFolderishObjectReturnsNone(self):\n         info = self.types.getTypeInfo(dynfolder)\n         self.assertEqual(info.getDefaultPage(dynfolder), None)\n \n+    def test_DefaultViewWithBadLayoutUseFallback(self):\n+        dynfolder = self._makeOne()\n+        dynfolder.layout = 'bad_view'\n+        info = self.types.getTypeInfo(dynfolder)\n+        # fallback not returned if not activated\n+        self.assertFalse(info.default_view_fallback)\n+        self.assertEqual(\n+            info.defaultView(dynfolder),\n+            'bad_view'\n+        )\n+        # enable fallback\n+        info.default_view_fallback = True\n+        self.assertEqual(\n+            info.defaultView(dynfolder),\n+            info.default_view\n+        )\n \n if six.PY2:\n     # I have no idea what is or should be happending here.\ndiff --git a/news/16.bugfix b/news/16.bugfix\nnew file mode 100644\nindex 0000000..41dd9c9\n--- /dev/null\n+++ b/news/16.bugfix\n@@ -0,0 +1 @@\n+Fixed fallback to default view. [gbastien]\n"

