Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-04-19T20:36:37-05:00
Author: Jens Vagelpohl (dataflake) <jens@netz.ooo>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/58edac61effce861eb675152bd2f3972cb696bb4

Add ability to turn off ``zodb-temporary-storage`` to prevent Zope 4 breakage

Files changed:
A news/87.bugfix
M README.rst
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/README.rst b/README.rst\nindex 3f900c7..616ec8c 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -487,7 +487,9 @@ zodb-cache-size-bytes\n \n zodb-temporary-storage\n   If given Zope\'s default temporary storage definition will be replaced by\n-  the lines of this parameter.\n+  the lines of this parameter. If set to "off" or "false", no temporary storage\n+  definition will be created. This prevents startup issues for basic Zope 4\n+  sites as it does not ship with the required packages by default anymore.\n \n zope-conf\n   A relative or absolute path to a `zope.conf` file. If this is given, many of\ndiff --git a/news/87.bugfix b/news/87.bugfix\nnew file mode 100644\nindex 0000000..94b4ac4\n--- /dev/null\n+++ b/news/87.bugfix\n@@ -0,0 +1 @@\n+Add ability to turn off ``zodb-temporary-storage`` to prevent Zope 4 breakage\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 447bbbb..005b870 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -600,8 +600,11 @@ def is_rs_option(name):\n             storage_snippet = indent(\n                 options[\'storage-wrapper\'] % storage_snippet, 4)\n \n-        zodb_tmp_storage = options.get(\'zodb-temporary-storage\',\n-                                       zodb_temporary_storage_template)\n+        zodb_tmp_storage = options.get(\'zodb-temporary-storage\', \'on\')\n+        if zodb_tmp_storage.lower() in (\'off\', \'false\', \'0\'):\n+            zodb_tmp_storage = \'\'\n+        else:\n+            zodb_tmp_storage = zodb_temporary_storage_template\n         template = wsgi_conf_template if self.wsgi else zope_conf_template\n \n         pid_file = options.get(\ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 56a5515..c04feff 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -94,6 +94,62 @@ FTP and WebDAV\n With wsgi there is no FTP and WebDAV. Use Python 2 and ``wsgi = off`` for that.\n \n \n+Turning off ZODB temporary storage\n+==================================\n+Zope 4 does not ship with the required packages anymore, so to avoid breakage\n+the creation of the ZODB temporary storage definition can be turned off:\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... zodb-temporary-storage = off\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+The generated configuration has no temporary storage section anymore:\n+\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n+    >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n+    >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n+    >>> print(zope_conf)\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n+    instancehome $INSTANCEHOME\n+    %define CLIENTHOME .../sample-buildout/var/instance\n+    clienthome $CLIENTHOME\n+    debug-mode off\n+    security-policy-implementation C\n+    verbose-security off\n+    default-zpublisher-encoding utf-8\n+    <zodb_db main>\n+        # Main database\n+        cache-size 30000\n+        # Blob-enabled FileStorage database\n+        <blobstorage>\n+          blob-dir .../sample-buildout/var/blobstorage\n+          # FileStorage database\n+          <filestorage>\n+            path .../sample-buildout/var/filestorage/Data.fs\n+          </filestorage>\n+        </blobstorage>\n+        mount-point /\n+    </zodb_db>\n+    python-check-interval 1000\n+\n+\n DemoStorage\n ===========\n \n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-04-21T00:00:10+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/22bbaf3613d0552c1c42d5c93480434e6e8e0751

Merge pull request #93 from plone/issue_87

Add ability to turn off `zodb-temporary-storage` to prevent Zope 4 breakage

Files changed:
A news/87.bugfix
M README.rst
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/README.rst b/README.rst\nindex 3f900c7..616ec8c 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -487,7 +487,9 @@ zodb-cache-size-bytes\n \n zodb-temporary-storage\n   If given Zope\'s default temporary storage definition will be replaced by\n-  the lines of this parameter.\n+  the lines of this parameter. If set to "off" or "false", no temporary storage\n+  definition will be created. This prevents startup issues for basic Zope 4\n+  sites as it does not ship with the required packages by default anymore.\n \n zope-conf\n   A relative or absolute path to a `zope.conf` file. If this is given, many of\ndiff --git a/news/87.bugfix b/news/87.bugfix\nnew file mode 100644\nindex 0000000..94b4ac4\n--- /dev/null\n+++ b/news/87.bugfix\n@@ -0,0 +1 @@\n+Add ability to turn off ``zodb-temporary-storage`` to prevent Zope 4 breakage\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 447bbbb..005b870 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -600,8 +600,11 @@ def is_rs_option(name):\n             storage_snippet = indent(\n                 options[\'storage-wrapper\'] % storage_snippet, 4)\n \n-        zodb_tmp_storage = options.get(\'zodb-temporary-storage\',\n-                                       zodb_temporary_storage_template)\n+        zodb_tmp_storage = options.get(\'zodb-temporary-storage\', \'on\')\n+        if zodb_tmp_storage.lower() in (\'off\', \'false\', \'0\'):\n+            zodb_tmp_storage = \'\'\n+        else:\n+            zodb_tmp_storage = zodb_temporary_storage_template\n         template = wsgi_conf_template if self.wsgi else zope_conf_template\n \n         pid_file = options.get(\ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 56a5515..c04feff 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -94,6 +94,62 @@ FTP and WebDAV\n With wsgi there is no FTP and WebDAV. Use Python 2 and ``wsgi = off`` for that.\n \n \n+Turning off ZODB temporary storage\n+==================================\n+Zope 4 does not ship with the required packages anymore, so to avoid breakage\n+the creation of the ZODB temporary storage definition can be turned off:\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... zodb-temporary-storage = off\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+The generated configuration has no temporary storage section anymore:\n+\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n+    >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n+    >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n+    >>> print(zope_conf)\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n+    instancehome $INSTANCEHOME\n+    %define CLIENTHOME .../sample-buildout/var/instance\n+    clienthome $CLIENTHOME\n+    debug-mode off\n+    security-policy-implementation C\n+    verbose-security off\n+    default-zpublisher-encoding utf-8\n+    <zodb_db main>\n+        # Main database\n+        cache-size 30000\n+        # Blob-enabled FileStorage database\n+        <blobstorage>\n+          blob-dir .../sample-buildout/var/blobstorage\n+          # FileStorage database\n+          <filestorage>\n+            path .../sample-buildout/var/filestorage/Data.fs\n+          </filestorage>\n+        </blobstorage>\n+        mount-point /\n+    </zodb_db>\n+    python-check-interval 1000\n+\n+\n DemoStorage\n ===========\n \n'

