Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-04-06T21:23:46+02:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/93233439134341c2e483344a681beb03526525c2

Fix #1511 when aggregating bundles, use ++plone++static overrided versions if any

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py
M Products/CMFPlone/tests/test_metabundles.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1afbbac..a33f261 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -34,6 +34,9 @@ Fixes:
 - Gruntfile failed if only css or only javascripts were registered.
   [jensens]
 
+- Bundle aggregation must use ++plone++static overrided versions if any.
+  [ebrehault]
+
 
 5.1a1 (2016-03-31)
 ------------------
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 25e564e..0b42e90 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -31,6 +31,14 @@ def get_production_resource_directory():
 
 
 def get_resource(context, path):
+    if path.startswith('++plone++'):
+        # ++plone++ resources can be customized, we return their override
+        # value if any
+        overrides = get_override_directory(context)
+        filepath = path[9:]
+        if overrides.isFile(filepath):
+            return overrides.readFile(filepath)
+
     resource = context.unrestrictedTraverse(path)
     if isinstance(resource, FilesystemFile):
         (directory, sep, filename) = path.rpartition('/')
@@ -96,13 +104,17 @@ def write_css(context, folder, meta_bundle):
     folder.writeFile(meta_bundle + ".css", fi)
 
 
-def combine_bundles(context):
+def get_override_directory(context):
     persistent_directory = queryUtility(IResourceDirectory, name="persistent")
     if persistent_directory is None:
         return
     if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:
         persistent_directory.makeDirectory(OVERRIDE_RESOURCE_DIRECTORY_NAME)
-    container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+    return persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+
+
+def combine_bundles(context):
+    container = get_override_directory(context)
     if PRODUCTION_RESOURCE_DIRECTORY not in container:
         container.makeDirectory(PRODUCTION_RESOURCE_DIRECTORY)
     production_folder = container[PRODUCTION_RESOURCE_DIRECTORY]
diff --git a/Products/CMFPlone/tests/test_metabundles.py b/Products/CMFPlone/tests/test_metabundles.py
index 35d2346..3b29e6c 100644
--- a/Products/CMFPlone/tests/test_metabundles.py
+++ b/Products/CMFPlone/tests/test_metabundles.py
@@ -38,3 +38,16 @@ def test_default_js_bundle(self):
             "jQuery",
             self.production_folder.readFile('default.js')
         )
+
+    def test_overrides(self):
+        persistent_directory = getUtility(
+            IResourceDirectory, name="persistent")
+        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+        container.makeDirectory('static')
+        static = container['static']
+        static.writeFile('plone-legacy-compiled.js', 'alert("Overrided legacy!");')
+        combine_bundles(self.portal)
+        self.assertIn(
+            'alert("Overrided legacy!");',
+            self.production_folder.readFile('default.js')
+        )


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-04-07T06:53:41+02:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/175540c405012f4c9a7ee4d754a1310265a3d58a

Merge pull request #1512 from plone/fix-bundle-aggregation

Fix #1511 when aggregating bundles, use ++plone++static overrided versions if any

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py
M Products/CMFPlone/tests/test_metabundles.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1afbbac..a33f261 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -34,6 +34,9 @@ Fixes:
 - Gruntfile failed if only css or only javascripts were registered.
   [jensens]
 
+- Bundle aggregation must use ++plone++static overrided versions if any.
+  [ebrehault]
+
 
 5.1a1 (2016-03-31)
 ------------------
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 25e564e..0b42e90 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -31,6 +31,14 @@ def get_production_resource_directory():
 
 
 def get_resource(context, path):
+    if path.startswith('++plone++'):
+        # ++plone++ resources can be customized, we return their override
+        # value if any
+        overrides = get_override_directory(context)
+        filepath = path[9:]
+        if overrides.isFile(filepath):
+            return overrides.readFile(filepath)
+
     resource = context.unrestrictedTraverse(path)
     if isinstance(resource, FilesystemFile):
         (directory, sep, filename) = path.rpartition('/')
@@ -96,13 +104,17 @@ def write_css(context, folder, meta_bundle):
     folder.writeFile(meta_bundle + ".css", fi)
 
 
-def combine_bundles(context):
+def get_override_directory(context):
     persistent_directory = queryUtility(IResourceDirectory, name="persistent")
     if persistent_directory is None:
         return
     if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:
         persistent_directory.makeDirectory(OVERRIDE_RESOURCE_DIRECTORY_NAME)
-    container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+    return persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+
+
+def combine_bundles(context):
+    container = get_override_directory(context)
     if PRODUCTION_RESOURCE_DIRECTORY not in container:
         container.makeDirectory(PRODUCTION_RESOURCE_DIRECTORY)
     production_folder = container[PRODUCTION_RESOURCE_DIRECTORY]
diff --git a/Products/CMFPlone/tests/test_metabundles.py b/Products/CMFPlone/tests/test_metabundles.py
index 35d2346..3b29e6c 100644
--- a/Products/CMFPlone/tests/test_metabundles.py
+++ b/Products/CMFPlone/tests/test_metabundles.py
@@ -38,3 +38,16 @@ def test_default_js_bundle(self):
             "jQuery",
             self.production_folder.readFile('default.js')
         )
+
+    def test_overrides(self):
+        persistent_directory = getUtility(
+            IResourceDirectory, name="persistent")
+        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+        container.makeDirectory('static')
+        static = container['static']
+        static.writeFile('plone-legacy-compiled.js', 'alert("Overrided legacy!");')
+        combine_bundles(self.portal)
+        self.assertIn(
+            'alert("Overrided legacy!");',
+            self.production_folder.readFile('default.js')
+        )


