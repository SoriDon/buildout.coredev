Repository: plone.app.event


Branch: refs/heads/master
Date: 2016-01-26T18:38:41+01:00
Author: Patrick Gerken (do3cc) <patrick.gerken@zumtobelgroup.com>
Commit: https://github.com/plone/plone.app.event/commit/7c68ef116b5b782c0cca79baa92fa3304e4323d0

Cleaner tests

Files changed:
M CHANGES.rst
M plone/app/event/testing.py
M plone/app/event/tests/test_dx_behaviors.py

diff --git a/CHANGES.rst b/CHANGES.rst
index eb77705..150f313 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,8 @@ New:
 
 Fixes:
 
-- *add item here*
+- Ensure that unittests reset the timezone information
+  [do3cc]
 
 
 2.0.6 (2016-01-08)
diff --git a/plone/app/event/testing.py b/plone/app/event/testing.py
index ee1b6f7..c8deb5f 100644
--- a/plone/app/event/testing.py
+++ b/plone/app/event/testing.py
@@ -27,12 +27,18 @@ def set_browserlayer(request):
 
 def set_timezone(tz):
     # Set the portal timezone
+    if tz is None:
+        return None
     reg = getUtility(IRegistry)
+    current_tz = reg.get('plone.portal_timezone', None)
     reg['plone.portal_timezone'] = tz
+    return tz
 
 
 def set_env_timezone(tz):
+    current_tz = os.environ['TZ']
     os.environ['TZ'] = tz
+    return current_tz
 
 
 def os_zone():
diff --git a/plone/app/event/tests/test_dx_behaviors.py b/plone/app/event/tests/test_dx_behaviors.py
index 1a3c2af..3e6c756 100644
--- a/plone/app/event/tests/test_dx_behaviors.py
+++ b/plone/app/event/tests/test_dx_behaviors.py
@@ -395,7 +395,10 @@ class TestDXEventUnittest(unittest.TestCase):
     """
 
     def setUp(self):
-        set_env_timezone(TEST_TIMEZONE)
+        self.orig_tz = set_env_timezone(TEST_TIMEZONE)
+
+    def tearDown(self):
+        set_env_timezone(self.orig_tz)
 
     def test_validate_invariants_ok(self):
         mock = MockEvent()


