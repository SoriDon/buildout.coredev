Repository: plone.versioncheck


Branch: refs/heads/master
Date: 2017-05-05T14:09:35+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.versioncheck/commit/2dbb6a9b1e42498c828575368d8d115074cf2eee

Fixes #17: Requirements were missing.

Files changed:
M CHANGES.rst
M src/plone/versioncheck/formatter.py
M src/plone/versioncheck/tpl/browser.jinja
M src/plone/versioncheck/tracking.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f3045bb..2b830b9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 1.6.3 (unreleased)
 ------------------
 
+- Fixes #17: Requirements were missing.
+  [jensens]
+
 - Optimization: Reduce load on PyPI when fetching release dates.
   [jensens]
 
diff --git a/src/plone/versioncheck/formatter.py b/src/plone/versioncheck/formatter.py
index bf36111..3de0e9c 100644
--- a/src/plone/versioncheck/formatter.py
+++ b/src/plone/versioncheck/formatter.py
@@ -80,7 +80,6 @@ def builder(pkgsinfo, newer_only=False, newer_orphaned_only=False, limit=None):
     pypi = pkgsinfo.get('pypi', {})
     tracked = pkgsinfo.get('tracking', {}).get('versions', {})
     requ = pkgsinfo.get('tracking', {}).get('required_by', {})
-
     names = sorted(set(tracked.keys()) | set(pkgs.keys()))
 
     for nidx, name in enumerate(names):
diff --git a/src/plone/versioncheck/tpl/browser.jinja b/src/plone/versioncheck/tpl/browser.jinja
index 6279b52..e2f85d3 100644
--- a/src/plone/versioncheck/tpl/browser.jinja
+++ b/src/plone/versioncheck/tpl/browser.jinja
@@ -84,7 +84,11 @@
             {% for req in record.get('required_by', [])|sort %}
             <a href="#{{req}}">{{req}}</a>
             {% else %}
+            {% if record['state'] != 'O' %}
+            -/-
+            {% else %}
             &nbsp;
+            {% endif %}
             {% endfor %}
             </td>
             {% endif %}
diff --git a/src/plone/versioncheck/tracking.py b/src/plone/versioncheck/tracking.py
index d4d83ba..6b20dbf 100644
--- a/src/plone/versioncheck/tracking.py
+++ b/src/plone/versioncheck/tracking.py
@@ -19,11 +19,12 @@
 TRACKINGFILENAME = '.plone.versioncheck.tracked.json'
 
 
-def enable_tracking(old_get_dist):
+def track_get_dist(old_get_dist):
     def get_dist(self, requirement, *ags, **kw):
         dists = old_get_dist(self, requirement, *ags, **kw)
         for dist in dists:
-            versions_by_name[dist.project_name.lower()] = (
+            dist_name = dist.project_name.lower()
+            versions_by_name[dist_name] = (
                 dist.version,
                 (
                     dist.precedence == DEVELOP_DIST and
@@ -32,12 +33,18 @@ def get_dist(self, requirement, *ags, **kw):
                     dist.location
                 )
             )
-            dist_ = str(dist).split(' ')[0].lower()
+            if dist_name not in required_by:
+                required_by[dist_name] = []
+            if (
+                requirement.key != dist_name and
+                requirement.key not in required_by[dist_name]
+            ):
+                required_by[dist_name].append(requirement.key)
             for req in dist.requires():
                 if req.key not in required_by:
                     required_by[req.key] = []
-                if dist_ not in required_by[req.key]:
-                    required_by[req.key].append(dist_)
+                if dist_name not in required_by[req.key]:
+                    required_by[req.key].append(dist_name)
         return dists
     return get_dist
 
@@ -63,7 +70,7 @@ def install(buildout):
         TRACKINGFILENAME,
     )
     easy_install.Installer.__tracked_versions = {}
-    easy_install.Installer._get_dist = enable_tracking(
+    easy_install.Installer._get_dist = track_get_dist(
         easy_install.Installer._get_dist
     )
     logging.shutdown = write_tracked(logging.shutdown, filepath)


