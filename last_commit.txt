Repository: plone.app.content


Branch: refs/heads/master
Date: 2018-10-04T14:47:01+02:00
Author: Manuel Reinhardt (reinhardt) <reinhardt@syslab.com>
Commit: https://github.com/plone/plone.app.content/commit/b8e0c572b51b9195b9ae1cabda5285bcf6a86011

Use isExpired util method instead of isExpired.py skin script.

Files changed:
M CHANGES.rst
M plone/app/content/browser/content_status_history.py
M plone/app/content/browser/reviewlist.py
M plone/app/content/browser/templates/content_status_history.pt

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex c8ad3ab..12d6957 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -15,6 +15,10 @@ New features:\n   #1801\n   [reinhardt]\n \n+- Use isExpired util method instead of isExpired.py skin script.\n+  https://github.com/plone/Products.CMFPlone/issues/1801\n+  [reinhardt]\n+\n Bug fixes:\n \n - *add item here*\ndiff --git a/plone/app/content/browser/content_status_history.py b/plone/app/content/browser/content_status_history.py\nindex 14eacd2..8add28d 100644\n--- a/plone/app/content/browser/content_status_history.py\n+++ b/plone/app/content/browser/content_status_history.py\n@@ -1,6 +1,7 @@\n # -*- coding: utf-8 -*-\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.utils import isExpired\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import field\n from z3c.form import form\n@@ -133,3 +134,6 @@ def redirect_to_referrer(self):\n         referer = self.request.get(\'HTTP_REFERER\', \'\')\n         target_url = referer.split(\'?\', 1)[0]\n         return self.request.RESPONSE.redirect(target_url)\n+\n+    def isExpired(self, content):\n+        return isExpired(content)\ndiff --git a/plone/app/content/browser/reviewlist.py b/plone/app/content/browser/reviewlist.py\nindex 84db314..a1fd56f 100644\n--- a/plone/app/content/browser/reviewlist.py\n+++ b/plone/app/content/browser/reviewlist.py\n@@ -4,8 +4,9 @@\n from plone.app.content.browser.tableview import TableBrowserView\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.utils import safe_unicode\n from Products.CMFPlone.utils import human_readable_size\n+from Products.CMFPlone.utils import isExpired\n+from Products.CMFPlone.utils import safe_unicode\n from six.moves import map\n from six.moves.urllib.parse import quote_plus\n from zope.component import getMultiAdapter\n@@ -127,7 +128,7 @@ def items(self):\n                 relative_url=relative_url,\n                 view_url=view_url,\n                 table_row_class=table_row_class,\n-                is_expired=self.context.isExpired(obj)\n+                is_expired=isExpired(obj)\n             ))\n         return results\n \ndiff --git a/plone/app/content/browser/templates/content_status_history.pt b/plone/app/content/browser/templates/content_status_history.pt\nindex 8089871..c4386d5 100644\n--- a/plone/app/content/browser/templates/content_status_history.pt\n+++ b/plone/app/content/browser/templates/content_status_history.pt\n@@ -173,7 +173,7 @@\n                                     </a>\n \n                                 <span class="state-expired"\n-                                      tal:condition="python:context.isExpired(item)"\n+                                      tal:condition="python:view.isExpired(item)"\n                                       i18n:translate="time_expired">expired</span>\n                             </td>\n \n'

Repository: plone.app.content


Branch: refs/heads/master
Date: 2018-10-05T20:28:14+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.content/commit/e41532a73548af36d5029fc18bc53ac87c09ef61

Merge branch 'master' into 1801-is-expired

Files changed:
M CHANGES.rst
M plone/app/content/browser/content_status_history.py
M plone/app/content/browser/reviewlist.py
M plone/app/content/browser/templates/content_status_history.pt

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 12d6957..d66ca4c 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -10,6 +10,9 @@ Breaking changes:\n \n New features:\n \n+- Replaced usages of my_worklist.py skin script.\n+  https://github.com/plone/Products.CMFPlone/issues/1801\n+  [reinhardt]\n - Use obj.get_size() instead of getObjSize skin script.\n   Allows removing the script and also returns a numerical value.\n   #1801\ndiff --git a/plone/app/content/browser/content_status_history.py b/plone/app/content/browser/content_status_history.py\nindex 8add28d..3b51696 100644\n--- a/plone/app/content/browser/content_status_history.py\n+++ b/plone/app/content/browser/content_status_history.py\n@@ -2,6 +2,7 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.utils import isExpired\n+from Products.CMFPlone.utils import human_readable_size\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import field\n from z3c.form import form\n@@ -137,3 +138,6 @@ def redirect_to_referrer(self):\n \n     def isExpired(self, content):\n         return isExpired(content)\n+\n+      def human_readable_size(self, size):\n+        return human_readable_size(size)\ndiff --git a/plone/app/content/browser/reviewlist.py b/plone/app/content/browser/reviewlist.py\nindex a1fd56f..1b062f6 100644\n--- a/plone/app/content/browser/reviewlist.py\n+++ b/plone/app/content/browser/reviewlist.py\n@@ -18,7 +18,12 @@\n class FullReviewListView(BrowserView):\n \n     def revlist(self):\n-        return self.context.my_worklist()\n+        portal_membership = getToolByName(self.context, \'portal_membership\')\n+        portal_workflow = getToolByName(self.context, \'portal_workflow\')\n+        if portal_membership.isAnonymousUser():\n+            return []\n+\n+        return portal_workflow.getWorklistsResults()\n \n     def url(self):\n         return self.context.absolute_url() + \'/full_review_list\'\n@@ -55,6 +60,7 @@ def items(self):\n                                        name=u\'plone_layout\')\n         portal_workflow = getToolByName(self.context, \'portal_workflow\')\n         portal_types = getToolByName(self.context, \'portal_types\')\n+        portal_membership = getToolByName(self.context, \'portal_membership\')\n \n         registry = getUtility(IRegistry)\n         use_view_action = registry.get(\n@@ -63,7 +69,12 @@ def items(self):\n         browser_default = plone_utils.browserDefault(self.context)\n \n         results = list()\n-        for i, obj in enumerate(self.context.my_worklist()):\n+        if portal_membership.isAnonymousUser():\n+            worklist = []\n+        else:\n+            worklist = portal_workflow.getWorklistsResults()\n+\n+        for i, obj in enumerate(worklist):\n             if i % 2 == 0:\n                 table_row_class = "even"\n             else:\ndiff --git a/plone/app/content/browser/templates/content_status_history.pt b/plone/app/content/browser/templates/content_status_history.pt\nindex c4386d5..72bc4a0 100644\n--- a/plone/app/content/browser/templates/content_status_history.pt\n+++ b/plone/app/content/browser/templates/content_status_history.pt\n@@ -123,7 +123,7 @@\n                                            item_title_or_id     item/pretty_title_or_id;\n                                            item_description     item/Description;\n                                            item_type            item/portal_type;\n-                                           item_size            item/getObjSize;\n+                                           item_size            python:view.human_readable_size(item.get_size());\n                                            item_modified        item/ModificationDate;\n                                            item_type_class      python:\'contenttype-\' + normalizeString(item_type);\n                                            item_wf_state        item/review_state|python: wtool.getInfoFor(item, \'review_state\', \'\');\n'

Repository: plone.app.content


Branch: refs/heads/master
Date: 2018-10-05T20:34:17+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.content/commit/f5d1c41e2f5d8cf3d693680d8e3e7f0338318ed0

Merge pull request #165 from plone/1801-is-expired

Use isExpired util method instead of isExpired.py skin script.

Files changed:
M CHANGES.rst
M plone/app/content/browser/content_status_history.py
M plone/app/content/browser/reviewlist.py
M plone/app/content/browser/templates/content_status_history.pt

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex d5d14a2..d66ca4c 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -18,6 +18,10 @@ New features:\n   #1801\n   [reinhardt]\n \n+- Use isExpired util method instead of isExpired.py skin script.\n+  https://github.com/plone/Products.CMFPlone/issues/1801\n+  [reinhardt]\n+\n Bug fixes:\n \n - *add item here*\ndiff --git a/plone/app/content/browser/content_status_history.py b/plone/app/content/browser/content_status_history.py\nindex 6ce7bb7..3b51696 100644\n--- a/plone/app/content/browser/content_status_history.py\n+++ b/plone/app/content/browser/content_status_history.py\n@@ -1,6 +1,7 @@\n # -*- coding: utf-8 -*-\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.utils import isExpired\n from Products.CMFPlone.utils import human_readable_size\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import field\n@@ -135,5 +136,8 @@ def redirect_to_referrer(self):\n         target_url = referer.split(\'?\', 1)[0]\n         return self.request.RESPONSE.redirect(target_url)\n \n-    def human_readable_size(self, size):\n+    def isExpired(self, content):\n+        return isExpired(content)\n+\n+      def human_readable_size(self, size):\n         return human_readable_size(size)\ndiff --git a/plone/app/content/browser/reviewlist.py b/plone/app/content/browser/reviewlist.py\nindex f3ae032..1b062f6 100644\n--- a/plone/app/content/browser/reviewlist.py\n+++ b/plone/app/content/browser/reviewlist.py\n@@ -4,8 +4,9 @@\n from plone.app.content.browser.tableview import TableBrowserView\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.utils import safe_unicode\n from Products.CMFPlone.utils import human_readable_size\n+from Products.CMFPlone.utils import isExpired\n+from Products.CMFPlone.utils import safe_unicode\n from six.moves import map\n from six.moves.urllib.parse import quote_plus\n from zope.component import getMultiAdapter\n@@ -138,7 +139,7 @@ def items(self):\n                 relative_url=relative_url,\n                 view_url=view_url,\n                 table_row_class=table_row_class,\n-                is_expired=self.context.isExpired(obj)\n+                is_expired=isExpired(obj)\n             ))\n         return results\n \ndiff --git a/plone/app/content/browser/templates/content_status_history.pt b/plone/app/content/browser/templates/content_status_history.pt\nindex 113a382..72bc4a0 100644\n--- a/plone/app/content/browser/templates/content_status_history.pt\n+++ b/plone/app/content/browser/templates/content_status_history.pt\n@@ -173,7 +173,7 @@\n                                     </a>\n \n                                 <span class="state-expired"\n-                                      tal:condition="python:context.isExpired(item)"\n+                                      tal:condition="python:view.isExpired(item)"\n                                       i18n:translate="time_expired">expired</span>\n                             </td>\n \n'

