Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-04-15T00:21:22+09:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/plone.namedfile/commit/0ba30c5297ee73d07cb74b29bbd588bdd26f003e

fix Bug #2008.

This bug was due to a very reduced exif set, which did not include ImageIFD.XResolution and ImageIFD.YResolution information.

Files changed:
M CHANGES.rst
M plone/namedfile/utils/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9e3313c..db77719 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix bug on Image rotation if ImageIFD.XResolution or ImageIFD.YResolution are not set.
+  [loechel]
 
 
 4.2.0 (2017-03-26)
diff --git a/plone/namedfile/utils/__init__.py b/plone/namedfile/utils/__init__.py
index 222b740..39c1789 100644
--- a/plone/namedfile/utils/__init__.py
+++ b/plone/namedfile/utils/__init__.py
@@ -196,6 +196,11 @@ def rotate_image(image_data, method=None, REQUEST=None):
             pass
         if exif_data and piexif.ImageIFD.Orientation in exif_data['0th']:
             orientation = exif_data['0th'][piexif.ImageIFD.Orientation]
+        if exif_data and \
+                (not exif_data['0th'].get(piexif.ImageIFD.XResolution) or \
+                 not exif_data['0th'].get(piexif.ImageIFD.YResolution)):
+            exif_data['0th'][piexif.ImageIFD.XResolution] = (img.width, 1)
+            exif_data['0th'][piexif.ImageIFD.YResolution] = (img.height, 1)
     if exif_data is None:
         width, height = img.size
         exif_data = {
@@ -219,19 +224,31 @@ def rotate_image(image_data, method=None, REQUEST=None):
     elif orientation == 3:
         img = img.transpose(PIL.Image.ROTATE_180)
     elif orientation == 4:
-        img = img.transpose(PIL.Image.ROTATE_180).transpose(PIL.Image.FLIP_LEFT_RIGHT)  # NOQA
+        img = img.transpose(PIL.Image.ROTATE_180).transpose(
+            PIL.Image.FLIP_LEFT_RIGHT)
     elif orientation == 5:
-        img = img.transpose(PIL.Image.ROTATE_270).transpose(PIL.Image.FLIP_LEFT_RIGHT)  # NOQA
-        exif_data['0th'][piexif.ImageIFD.XResolution], exif_data['0th'][piexif.ImageIFD.YResolution] = exif_data['0th'][piexif.ImageIFD.YResolution], exif_data['0th'][piexif.ImageIFD.XResolution]  # NOQA
+        img = img.transpose(PIL.Image.ROTATE_270).transpose(
+            PIL.Image.FLIP_LEFT_RIGHT)
     elif orientation == 6:
         img = img.transpose(PIL.Image.ROTATE_270)
-        exif_data['0th'][piexif.ImageIFD.XResolution], exif_data['0th'][piexif.ImageIFD.YResolution] = exif_data['0th'][piexif.ImageIFD.YResolution], exif_data['0th'][piexif.ImageIFD.XResolution]  # NOQA
     elif orientation == 7:
-        img = img.transpose(PIL.Image.ROTATE_90).transpose(PIL.Image.FLIP_LEFT_RIGHT)  # NOQA
-        exif_data['0th'][piexif.ImageIFD.XResolution], exif_data['0th'][piexif.ImageIFD.YResolution] = exif_data['0th'][piexif.ImageIFD.YResolution], exif_data['0th'][piexif.ImageIFD.XResolution]  # NOQA
+        img = img.transpose(PIL.Image.ROTATE_90).transpose(
+            PIL.Image.FLIP_LEFT_RIGHT)
     elif orientation == 8:
         img = img.transpose(PIL.Image.ROTATE_90)
-        exif_data['0th'][piexif.ImageIFD.XResolution], exif_data['0th'][piexif.ImageIFD.YResolution] = exif_data['0th'][piexif.ImageIFD.YResolution], exif_data['0th'][piexif.ImageIFD.XResolution]  # NOQA
+
+    if orientation in [5, 6, 7, 8]:
+        if exif_data['0th'][piexif.ImageIFD.XResolution] and \
+                exif_data['0th'][piexif.ImageIFD.YResolution]:
+            exif_data['0th'][piexif.ImageIFD.XResolution], \
+                exif_data['0th'][piexif.ImageIFD.YResolution] = \
+                exif_data['0th'][piexif.ImageIFD.YResolution], \
+                exif_data['0th'][piexif.ImageIFD.XResolution]
+        else:
+            exif_data['0th'][piexif.ImageIFD.XResolution], \
+                exif_data['0th'][piexif.ImageIFD.YResolution] = \
+                (img.width, 1), (img.height, 1)
+
 
     # set orientation to normal
     exif_data['0th'][piexif.ImageIFD.Orientation] = 1


Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-04-15T00:27:00+09:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/plone.namedfile/commit/ef37f90dc94dc991b31551eb6f945473675dc614

fix some flake8 warings in context of this fix

Files changed:
M plone/namedfile/utils/__init__.py

diff --git a/plone/namedfile/utils/__init__.py b/plone/namedfile/utils/__init__.py
index 39c1789..2ec9a8c 100644
--- a/plone/namedfile/utils/__init__.py
+++ b/plone/namedfile/utils/__init__.py
@@ -197,7 +197,7 @@ def rotate_image(image_data, method=None, REQUEST=None):
         if exif_data and piexif.ImageIFD.Orientation in exif_data['0th']:
             orientation = exif_data['0th'][piexif.ImageIFD.Orientation]
         if exif_data and \
-                (not exif_data['0th'].get(piexif.ImageIFD.XResolution) or \
+                (not exif_data['0th'].get(piexif.ImageIFD.XResolution) or
                  not exif_data['0th'].get(piexif.ImageIFD.YResolution)):
             exif_data['0th'][piexif.ImageIFD.XResolution] = (img.width, 1)
             exif_data['0th'][piexif.ImageIFD.YResolution] = (img.height, 1)
@@ -249,7 +249,6 @@ def rotate_image(image_data, method=None, REQUEST=None):
                 exif_data['0th'][piexif.ImageIFD.YResolution] = \
                 (img.width, 1), (img.height, 1)
 
-
     # set orientation to normal
     exif_data['0th'][piexif.ImageIFD.Orientation] = 1
 


Repository: plone.namedfile


Branch: refs/heads/master
Date: 2017-04-14T22:42:45+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.namedfile/commit/fe0318099144144a342e253de18e6da3ce114bcb

Merge pull request #44 from plone/bugfix_autorotate

fix Bug #2008.

Files changed:
M CHANGES.rst
M plone/namedfile/utils/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9e3313c..db77719 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix bug on Image rotation if ImageIFD.XResolution or ImageIFD.YResolution are not set.
+  [loechel]
 
 
 4.2.0 (2017-03-26)
diff --git a/plone/namedfile/utils/__init__.py b/plone/namedfile/utils/__init__.py
index 222b740..2ec9a8c 100644
--- a/plone/namedfile/utils/__init__.py
+++ b/plone/namedfile/utils/__init__.py
@@ -196,6 +196,11 @@ def rotate_image(image_data, method=None, REQUEST=None):
             pass
         if exif_data and piexif.ImageIFD.Orientation in exif_data['0th']:
             orientation = exif_data['0th'][piexif.ImageIFD.Orientation]
+        if exif_data and \
+                (not exif_data['0th'].get(piexif.ImageIFD.XResolution) or
+                 not exif_data['0th'].get(piexif.ImageIFD.YResolution)):
+            exif_data['0th'][piexif.ImageIFD.XResolution] = (img.width, 1)
+            exif_data['0th'][piexif.ImageIFD.YResolution] = (img.height, 1)
     if exif_data is None:
         width, height = img.size
         exif_data = {
@@ -219,19 +224,30 @@ def rotate_image(image_data, method=None, REQUEST=None):
     elif orientation == 3:
         img = img.transpose(PIL.Image.ROTATE_180)
     elif orientation == 4:
-        img = img.transpose(PIL.Image.ROTATE_180).transpose(PIL.Image.FLIP_LEFT_RIGHT)  # NOQA
+        img = img.transpose(PIL.Image.ROTATE_180).transpose(
+            PIL.Image.FLIP_LEFT_RIGHT)
     elif orientation == 5:
-        img = img.transpose(PIL.Image.ROTATE_270).transpose(PIL.Image.FLIP_LEFT_RIGHT)  # NOQA
-        exif_data['0th'][piexif.ImageIFD.XResolution], exif_data['0th'][piexif.ImageIFD.YResolution] = exif_data['0th'][piexif.ImageIFD.YResolution], exif_data['0th'][piexif.ImageIFD.XResolution]  # NOQA
+        img = img.transpose(PIL.Image.ROTATE_270).transpose(
+            PIL.Image.FLIP_LEFT_RIGHT)
     elif orientation == 6:
         img = img.transpose(PIL.Image.ROTATE_270)
-        exif_data['0th'][piexif.ImageIFD.XResolution], exif_data['0th'][piexif.ImageIFD.YResolution] = exif_data['0th'][piexif.ImageIFD.YResolution], exif_data['0th'][piexif.ImageIFD.XResolution]  # NOQA
     elif orientation == 7:
-        img = img.transpose(PIL.Image.ROTATE_90).transpose(PIL.Image.FLIP_LEFT_RIGHT)  # NOQA
-        exif_data['0th'][piexif.ImageIFD.XResolution], exif_data['0th'][piexif.ImageIFD.YResolution] = exif_data['0th'][piexif.ImageIFD.YResolution], exif_data['0th'][piexif.ImageIFD.XResolution]  # NOQA
+        img = img.transpose(PIL.Image.ROTATE_90).transpose(
+            PIL.Image.FLIP_LEFT_RIGHT)
     elif orientation == 8:
         img = img.transpose(PIL.Image.ROTATE_90)
-        exif_data['0th'][piexif.ImageIFD.XResolution], exif_data['0th'][piexif.ImageIFD.YResolution] = exif_data['0th'][piexif.ImageIFD.YResolution], exif_data['0th'][piexif.ImageIFD.XResolution]  # NOQA
+
+    if orientation in [5, 6, 7, 8]:
+        if exif_data['0th'][piexif.ImageIFD.XResolution] and \
+                exif_data['0th'][piexif.ImageIFD.YResolution]:
+            exif_data['0th'][piexif.ImageIFD.XResolution], \
+                exif_data['0th'][piexif.ImageIFD.YResolution] = \
+                exif_data['0th'][piexif.ImageIFD.YResolution], \
+                exif_data['0th'][piexif.ImageIFD.XResolution]
+        else:
+            exif_data['0th'][piexif.ImageIFD.XResolution], \
+                exif_data['0th'][piexif.ImageIFD.YResolution] = \
+                (img.width, 1), (img.height, 1)
 
     # set orientation to normal
     exif_data['0th'][piexif.ImageIFD.Orientation] = 1


