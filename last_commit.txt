Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-11-29T20:51:52+01:00
Author: Andrea Cecchi (cekk) <andrea.cecchi85@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/a7cd3237b532b042e7f0c35053836ea49be3ef7a

Enable table blocks indexing (#1281)

* enable table blocks indexing

* add changelog

Files changed:
A news/1281.feature
M src/plone/restapi/indexers.py
M src/plone/restapi/indexers.zcml
M src/plone/restapi/tests/test_blocks_searchable_text.py

b'diff --git a/news/1281.feature b/news/1281.feature\nnew file mode 100644\nindex 000000000..44438ac3d\n--- /dev/null\n+++ b/news/1281.feature\n@@ -0,0 +1 @@\n+Enable table blocks indexing [cekk]\ndiff --git a/src/plone/restapi/indexers.py b/src/plone/restapi/indexers.py\nindex 9e9205a25..c3663a91d 100644\n--- a/src/plone/restapi/indexers.py\n+++ b/src/plone/restapi/indexers.py\n@@ -35,6 +35,26 @@ def __call__(self, value):\n         return _extract_text(value)\n \n \n+@implementer(IBlockSearchableText)\n+@adapter(IBlocks, IBrowserRequest)\n+class TableBlockSearchableText:\n+    def __init__(self, context, request):\n+        self.context = context\n+        self.request = request\n+\n+    def __call__(self, value):\n+        table = value.get("table", {})\n+        if not table:\n+            return ""\n+        result = ""\n+        for row in table.get("rows", []):\n+            for cell in row.get("cells", []):\n+                for paragraph in cell.get("value", {}).get("blocks", {}):\n+                    text = paragraph["text"]\n+                    result = " ".join((result, text))\n+        return result\n+\n+\n @indexer(IBlocks)\n def SearchableText_blocks(obj):\n     request = getRequest()\ndiff --git a/src/plone/restapi/indexers.zcml b/src/plone/restapi/indexers.zcml\nindex f208d815c..39ec49297 100644\n--- a/src/plone/restapi/indexers.zcml\n+++ b/src/plone/restapi/indexers.zcml\n@@ -20,6 +20,10 @@\n              *"\n         name="slate"\n         />\n+    <adapter\n+        factory=".indexers.TableBlockSearchableText"\n+        name="table"\n+        />\n   </configure>\n \n </configure>\ndiff --git a/src/plone/restapi/tests/test_blocks_searchable_text.py b/src/plone/restapi/tests/test_blocks_searchable_text.py\nindex 4e580aec8..414679d5e 100644\n--- a/src/plone/restapi/tests/test_blocks_searchable_text.py\n+++ b/src/plone/restapi/tests/test_blocks_searchable_text.py\n@@ -250,3 +250,113 @@ def test_search_slate_text(self):\n \n         brain = results[0]\n         self.assertEqual(brain.Title, "A document")\n+\n+    def test_search_table_text(self):\n+        """Test text in tables is indexed"""\n+        self.doc.blocks = {\n+            "uuid1": {\n+                "@type": "table",\n+                "table": {\n+                    "rows": [\n+                        {\n+                            "cells": [\n+                                {\n+                                    "key": "3dli7",\n+                                    "type": "header",\n+                                    "value": {\n+                                        "blocks": [\n+                                            {\n+                                                "key": "1kh23",\n+                                                "text": "First header",\n+                                                "type": "unstyled",\n+                                                "depth": 0,\n+                                                "inlineStyleRanges": [],\n+                                                "entityRanges": [],\n+                                                "data": {},\n+                                            }\n+                                        ],\n+                                        "entityMap": {},\n+                                    },\n+                                },\n+                                {\n+                                    "key": "3dli8",\n+                                    "type": "header",\n+                                    "value": {\n+                                        "blocks": [\n+                                            {\n+                                                "key": "1kh23",\n+                                                "text": "Second header",\n+                                                "type": "unstyled",\n+                                                "depth": 0,\n+                                                "inlineStyleRanges": [],\n+                                                "entityRanges": [],\n+                                                "data": {},\n+                                            }\n+                                        ],\n+                                        "entityMap": {},\n+                                    },\n+                                },\n+                            ],\n+                        },\n+                        {\n+                            "cells": [\n+                                {\n+                                    "key": "3dli9",\n+                                    "type": "data",\n+                                    "value": {\n+                                        "blocks": [\n+                                            {\n+                                                "key": "1kh23",\n+                                                "text": "Data foo",\n+                                                "type": "unstyled",\n+                                                "depth": 0,\n+                                                "inlineStyleRanges": [],\n+                                                "entityRanges": [],\n+                                                "data": {},\n+                                            }\n+                                        ],\n+                                        "entityMap": {},\n+                                    },\n+                                },\n+                                {\n+                                    "key": "3dl29",\n+                                    "type": "data",\n+                                    "value": {\n+                                        "blocks": [\n+                                            {\n+                                                "key": "1kh23",\n+                                                "text": "Data bar",\n+                                                "type": "unstyled",\n+                                                "depth": 0,\n+                                                "inlineStyleRanges": [],\n+                                                "entityRanges": [],\n+                                                "data": {},\n+                                            }\n+                                        ],\n+                                        "entityMap": {},\n+                                    },\n+                                },\n+                            ],\n+                        },\n+                    ],\n+                },\n+            }\n+        }\n+        self.doc.blocks_layout = [\n+            "uuid1",\n+        ]\n+        self.portal.portal_catalog.indexObject(self.doc)\n+\n+        query = {"SearchableText": "foo"}\n+        results = self.portal.portal_catalog.searchResults(**query)\n+        self.assertEqual(len(results), 1)\n+\n+        brain = results[0]\n+        self.assertEqual(brain.Title, "A document")\n+\n+        query = {"SearchableText": "first"}\n+        results = self.portal.portal_catalog.searchResults(**query)\n+        self.assertEqual(len(results), 1)\n+\n+        brain = results[0]\n+        self.assertEqual(brain.Title, "A document")\n'

