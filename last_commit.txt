Repository: plone.app.contentlisting


Branch: refs/heads/master
Date: 2018-10-02T12:03:40+02:00
Author: Manuel Reinhardt (reinhardt) <reinhardt@syslab.com>
Commit: https://github.com/plone/plone.app.contentlisting/commit/2f149608372c8ce1e5757da18ca4ebc5ab33eb3b

Use human_readable_size from Products.CMFPlone.utils
to replace getObjSize script. #1801

Files changed:
M CHANGES.rst
M plone/app/contentlisting/realobject.py
M plone/app/contentlisting/tests/test_integration_unit.py

b"diff --git a/CHANGES.rst b/CHANGES.rst\nindex 3f975a7..766afc7 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -13,6 +13,9 @@ New features:\n \n - Python 3 support\n   [hvelarde, gforcada, davisagli]\n+- Use human_readable_size from Products.CMFPlone.utils to replace getObjSize\n+  script. #1801\n+  [reinhardt]\n \n Bug fixes:\n \ndiff --git a/plone/app/contentlisting/realobject.py b/plone/app/contentlisting/realobject.py\nindex 5b6ca58..a9b4410 100644\n--- a/plone/app/contentlisting/realobject.py\n+++ b/plone/app/contentlisting/realobject.py\n@@ -6,6 +6,7 @@\n from plone.rfc822.interfaces import IPrimaryFieldInfo\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.utils import human_readable_size\n from zope.interface import implementer\n \n \n@@ -73,13 +74,12 @@ def getSize(self):\n         except TypeError:\n             # no primary field available, dexterity raises a TypeError\n             # with the slightly missleading message 'could not adapt'.\n-            return 0\n+            primary_field_info = None\n         if primary_field_info is None or not primary_field_info.value:\n-            return 0\n-        return obj.getObjSize(\n-            None,\n-            getattr(primary_field_info.value, 'size', 0),\n-        )\n+            size = 0\n+        else:\n+            size = getattr(primary_field_info.value, 'size', 0)\n+        return human_readable_size(size)\n \n     def review_state(self):\n         obj = self.getObject()\ndiff --git a/plone/app/contentlisting/tests/test_integration_unit.py b/plone/app/contentlisting/tests/test_integration_unit.py\nindex d4a3501..8406083 100644\n--- a/plone/app/contentlisting/tests/test_integration_unit.py\n+++ b/plone/app/contentlisting/tests/test_integration_unit.py\n@@ -231,6 +231,9 @@ def test_item_getURL(self):\n         )\n         self.assertEqual(self.item.getURL(), self.realitem.absolute_url())\n \n+    def test_item_getSize(self):\n+        self.assertEqual(self.item.getSize().upper(), '0 KB')\n+\n     def test_item_reviewState(self):\n         wftool = getToolByName(self.realitem, 'portal_workflow')\n         wf = wftool.getInfoFor(self.realitem, 'review_state')\n"

Repository: plone.app.contentlisting


Branch: refs/heads/master
Date: 2018-10-05T20:16:44+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contentlisting/commit/f98915c7059f4b17ff6c0b83cbba4f308143539c

Merge pull request #31 from plone/1801-human-readable-size

Use human_readable_size from Products.CMFPlone.utils

Files changed:
M CHANGES.rst
M plone/app/contentlisting/realobject.py
M plone/app/contentlisting/tests/test_integration_unit.py

b"diff --git a/CHANGES.rst b/CHANGES.rst\nindex 3f975a7..766afc7 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -13,6 +13,9 @@ New features:\n \n - Python 3 support\n   [hvelarde, gforcada, davisagli]\n+- Use human_readable_size from Products.CMFPlone.utils to replace getObjSize\n+  script. #1801\n+  [reinhardt]\n \n Bug fixes:\n \ndiff --git a/plone/app/contentlisting/realobject.py b/plone/app/contentlisting/realobject.py\nindex 5b6ca58..a9b4410 100644\n--- a/plone/app/contentlisting/realobject.py\n+++ b/plone/app/contentlisting/realobject.py\n@@ -6,6 +6,7 @@\n from plone.rfc822.interfaces import IPrimaryFieldInfo\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.utils import human_readable_size\n from zope.interface import implementer\n \n \n@@ -73,13 +74,12 @@ def getSize(self):\n         except TypeError:\n             # no primary field available, dexterity raises a TypeError\n             # with the slightly missleading message 'could not adapt'.\n-            return 0\n+            primary_field_info = None\n         if primary_field_info is None or not primary_field_info.value:\n-            return 0\n-        return obj.getObjSize(\n-            None,\n-            getattr(primary_field_info.value, 'size', 0),\n-        )\n+            size = 0\n+        else:\n+            size = getattr(primary_field_info.value, 'size', 0)\n+        return human_readable_size(size)\n \n     def review_state(self):\n         obj = self.getObject()\ndiff --git a/plone/app/contentlisting/tests/test_integration_unit.py b/plone/app/contentlisting/tests/test_integration_unit.py\nindex d4a3501..8406083 100644\n--- a/plone/app/contentlisting/tests/test_integration_unit.py\n+++ b/plone/app/contentlisting/tests/test_integration_unit.py\n@@ -231,6 +231,9 @@ def test_item_getURL(self):\n         )\n         self.assertEqual(self.item.getURL(), self.realitem.absolute_url())\n \n+    def test_item_getSize(self):\n+        self.assertEqual(self.item.getSize().upper(), '0 KB')\n+\n     def test_item_reviewState(self):\n         wftool = getToolByName(self.realitem, 'portal_workflow')\n         wf = wftool.getInfoFor(self.realitem, 'review_state')\n"

