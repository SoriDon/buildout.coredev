Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-04-15T12:27:36+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/d7d0fe5503fa4d38a29037ce46cd4698be786220

gracefully handle tracebacks when installing addons during site creation

fixes #2228

Files changed:
A news/2228.bugfix
M Products/CMFPlone/factory.py

b'diff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py\nindex c7bf9ea89..f5c7f8cf9 100644\n--- a/Products/CMFPlone/factory.py\n+++ b/Products/CMFPlone/factory.py\n@@ -3,6 +3,7 @@\n from Products.CMFPlone.events import SiteManagerCreatedEvent\n from Products.CMFPlone.interfaces import INonInstallable\n from Products.GenericSetup.tool import SetupTool\n+from Products.statusmessages.interfaces import IStatusMessage\n from plone.registry.interfaces import IRegistry\n from zope.component import queryUtility\n from zope.event import notify\n@@ -163,8 +164,16 @@ def addPloneSite(context, site_id, title=\'Plone site\', description=\'\',\n     site.manage_changeProperties(**props)\n \n     for extension_id in extension_ids:\n-        setup_tool.runAllImportStepsFromProfile(\n-            \'profile-%s\' % extension_id)\n+        try:\n+            setup_tool.runAllImportStepsFromProfile(\n+                \'profile-%s\' % extension_id)\n+        except Exception as msg:\n+            IStatusMessage(request).add(\n+                \'Could not install {}: {}\\n\'\n+                \'Please try to install it manually using the "Addons" \'\n+                \'controlpanel and report any issues to the \'\n+                \'addon maintainers\'.format(extension_id, msg.args),\n+                type=\'warning\')\n \n     if snapshot is True:\n         setup_tool.createSnapshot(\'initial_configuration\')\ndiff --git a/news/2228.bugfix b/news/2228.bugfix\nnew file mode 100644\nindex 000000000..5bb1df8de\n--- /dev/null\n+++ b/news/2228.bugfix\n@@ -0,0 +1,2 @@\n+gracefully handle tracebacks during addon installation\n+[petschki]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-04-15T12:57:49+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/8b1011a20c9da53e6065495956db68031c3f2513

make message translatable

Files changed:
M Products/CMFPlone/factory.py

b'diff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py\nindex f5c7f8cf9..b07e9ea63 100644\n--- a/Products/CMFPlone/factory.py\n+++ b/Products/CMFPlone/factory.py\n@@ -1,4 +1,5 @@\n # -*- coding: utf-8 -*-\n+from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.Portal import PloneSite\n from Products.CMFPlone.events import SiteManagerCreatedEvent\n from Products.CMFPlone.interfaces import INonInstallable\n@@ -168,11 +169,15 @@ def addPloneSite(context, site_id, title=\'Plone site\', description=\'\',\n             setup_tool.runAllImportStepsFromProfile(\n                 \'profile-%s\' % extension_id)\n         except Exception as msg:\n-            IStatusMessage(request).add(\n-                \'Could not install {}: {}\\n\'\n+            IStatusMessage(request).add(_(\n+                \'Could not install ${profile_id}: ${error_msg}! \'\n                 \'Please try to install it manually using the "Addons" \'\n                 \'controlpanel and report any issues to the \'\n-                \'addon maintainers\'.format(extension_id, msg.args),\n+                \'addon maintainers.\',\n+                mapping={\n+                    \'profile_id\': extension_id,\n+                    \'error_msg\': msg.args,\n+                }),\n                 type=\'warning\')\n \n     if snapshot is True:\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-04-16T11:27:53+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/102231f47154c379e6959df84935e8ff8b58d47f

Merge branch 'master' into petschki_issue_2228

Files changed:
M Products/CMFPlone/browser/login/templates/forced_password_change.pt
M Products/CMFPlone/browser/login/templates/initial_login_password_change.pt
M Products/CMFPlone/browser/login/templates/insufficient_privileges.pt
M Products/CMFPlone/browser/login/templates/logged_out.pt
M Products/CMFPlone/browser/login/templates/mail_password_form.pt
M Products/CMFPlone/browser/login/templates/mail_password_response.pt
M Products/CMFPlone/browser/login/templates/pwreset_expired.pt
M Products/CMFPlone/browser/login/templates/pwreset_finish.pt
M Products/CMFPlone/browser/login/templates/pwreset_form.pt
M Products/CMFPlone/browser/login/templates/pwreset_invalid.pt
M Products/CMFPlone/browser/templates/accessibility-info.pt
M Products/CMFPlone/browser/templates/author.pt
M Products/CMFPlone/browser/templates/contact-info.pt
M Products/CMFPlone/browser/templates/error_message.pt
M Products/CMFPlone/browser/templates/five_template.pt
M Products/CMFPlone/browser/templates/main_template.pt
M Products/CMFPlone/browser/templates/search.pt
M Products/CMFPlone/browser/templates/send_feedback_confirm.pt
M Products/CMFPlone/browser/templates/sitemap.pt
M Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt
M Products/CMFPlone/skins/plone_templates/index_html.pt
M Products/CMFPlone/skins/plone_templates/recently_modified.pt
M Products/CMFPlone/skins/plone_templates/recently_published.pt
M Products/CMFPlone/skins/plone_templates/test_rendering.pt

b'diff --git a/Products/CMFPlone/browser/login/templates/forced_password_change.pt b/Products/CMFPlone/browser/login/templates/forced_password_change.pt\nindex d7e90e358..bc40b50ab 100644\n--- a/Products/CMFPlone/browser/login/templates/forced_password_change.pt\n+++ b/Products/CMFPlone/browser/login/templates/forced_password_change.pt\n@@ -3,7 +3,7 @@\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       i18n:domain="plone"\n-      metal:use-macro="context/main_template/macros/master">\n+      metal:use-macro="context/@@main_template/macros/master">\n \n   <metal:title fill-slot="content-title">\n     <h1 class="documentFirstHeading"\ndiff --git a/Products/CMFPlone/browser/login/templates/initial_login_password_change.pt b/Products/CMFPlone/browser/login/templates/initial_login_password_change.pt\nindex 51d54a454..468d24feb 100644\n--- a/Products/CMFPlone/browser/login/templates/initial_login_password_change.pt\n+++ b/Products/CMFPlone/browser/login/templates/initial_login_password_change.pt\n@@ -3,7 +3,7 @@\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       i18n:domain="plone"\n-      metal:use-macro="context/main_template/macros/master">\n+      metal:use-macro="context/@@main_template/macros/master">\n \n   <metal:title fill-slot="content-title">\n     <h1 class="documentFirstHeading"\ndiff --git a/Products/CMFPlone/browser/login/templates/insufficient_privileges.pt b/Products/CMFPlone/browser/login/templates/insufficient_privileges.pt\nindex 107aa2ba8..dc0b859b7 100644\n--- a/Products/CMFPlone/browser/login/templates/insufficient_privileges.pt\n+++ b/Products/CMFPlone/browser/login/templates/insufficient_privileges.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <head>\ndiff --git a/Products/CMFPlone/browser/login/templates/logged_out.pt b/Products/CMFPlone/browser/login/templates/logged_out.pt\nindex c6778e9b3..78ff9004b 100644\n--- a/Products/CMFPlone/browser/login/templates/logged_out.pt\n+++ b/Products/CMFPlone/browser/login/templates/logged_out.pt\n@@ -2,7 +2,7 @@\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <head>\ndiff --git a/Products/CMFPlone/browser/login/templates/mail_password_form.pt b/Products/CMFPlone/browser/login/templates/mail_password_form.pt\nindex e597411f8..da457d9d2 100644\n--- a/Products/CMFPlone/browser/login/templates/mail_password_form.pt\n+++ b/Products/CMFPlone/browser/login/templates/mail_password_form.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n <body>\n \ndiff --git a/Products/CMFPlone/browser/login/templates/mail_password_response.pt b/Products/CMFPlone/browser/login/templates/mail_password_response.pt\nindex c8c601967..10f2d73cc 100644\n--- a/Products/CMFPlone/browser/login/templates/mail_password_response.pt\n+++ b/Products/CMFPlone/browser/login/templates/mail_password_response.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n <body>\n \ndiff --git a/Products/CMFPlone/browser/login/templates/pwreset_expired.pt b/Products/CMFPlone/browser/login/templates/pwreset_expired.pt\nindex e2e1c1c64..061a399ad 100644\n--- a/Products/CMFPlone/browser/login/templates/pwreset_expired.pt\n+++ b/Products/CMFPlone/browser/login/templates/pwreset_expired.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n <body>\n \ndiff --git a/Products/CMFPlone/browser/login/templates/pwreset_finish.pt b/Products/CMFPlone/browser/login/templates/pwreset_finish.pt\nindex bfc05a128..6fb4a4c1a 100644\n--- a/Products/CMFPlone/browser/login/templates/pwreset_finish.pt\n+++ b/Products/CMFPlone/browser/login/templates/pwreset_finish.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n <body>\n \ndiff --git a/Products/CMFPlone/browser/login/templates/pwreset_form.pt b/Products/CMFPlone/browser/login/templates/pwreset_form.pt\nindex 46dda3f39..5a49dd805 100644\n--- a/Products/CMFPlone/browser/login/templates/pwreset_form.pt\n+++ b/Products/CMFPlone/browser/login/templates/pwreset_form.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n <body>\n \ndiff --git a/Products/CMFPlone/browser/login/templates/pwreset_invalid.pt b/Products/CMFPlone/browser/login/templates/pwreset_invalid.pt\nindex 1be9f9f26..f6b7cca79 100644\n--- a/Products/CMFPlone/browser/login/templates/pwreset_invalid.pt\n+++ b/Products/CMFPlone/browser/login/templates/pwreset_invalid.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n <body>\n \ndiff --git a/Products/CMFPlone/browser/templates/accessibility-info.pt b/Products/CMFPlone/browser/templates/accessibility-info.pt\nindex 3806baa2e..f7b350eab 100644\n--- a/Products/CMFPlone/browser/templates/accessibility-info.pt\n+++ b/Products/CMFPlone/browser/templates/accessibility-info.pt\n@@ -3,7 +3,7 @@\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <body>\ndiff --git a/Products/CMFPlone/browser/templates/author.pt b/Products/CMFPlone/browser/templates/author.pt\nindex d4b15dc6e..7edf51c99 100644\n--- a/Products/CMFPlone/browser/templates/author.pt\n+++ b/Products/CMFPlone/browser/templates/author.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <head>\ndiff --git a/Products/CMFPlone/browser/templates/contact-info.pt b/Products/CMFPlone/browser/templates/contact-info.pt\nindex a43024deb..4329ff3c4 100644\n--- a/Products/CMFPlone/browser/templates/contact-info.pt\n+++ b/Products/CMFPlone/browser/templates/contact-info.pt\n@@ -2,7 +2,7 @@\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <head>\ndiff --git a/Products/CMFPlone/browser/templates/error_message.pt b/Products/CMFPlone/browser/templates/error_message.pt\nindex d73e88d70..d1d7be29b 100644\n--- a/Products/CMFPlone/browser/templates/error_message.pt\n+++ b/Products/CMFPlone/browser/templates/error_message.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <body>\ndiff --git a/Products/CMFPlone/browser/templates/five_template.pt b/Products/CMFPlone/browser/templates/five_template.pt\nindex 6110d6620..5ccbd857b 100644\n--- a/Products/CMFPlone/browser/templates/five_template.pt\n+++ b/Products/CMFPlone/browser/templates/five_template.pt\n@@ -1,5 +1,5 @@\n <metal:macro metal:define-macro="page"\n-><html metal:use-macro="context/main_template/macros/master">\n+><html metal:use-macro="context/@@main_template/macros/master">\n <head>\n <metal:slot metal:fill-slot="style_slot"\n ><metal:slot metal:define-slot="style_slot" /></metal:slot>\ndiff --git a/Products/CMFPlone/browser/templates/main_template.pt b/Products/CMFPlone/browser/templates/main_template.pt\nindex 2b1d3915a..4f8a6cce6 100644\n--- a/Products/CMFPlone/browser/templates/main_template.pt\n+++ b/Products/CMFPlone/browser/templates/main_template.pt\n@@ -5,17 +5,17 @@\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      tal:define="portal_state context/@@plone_portal_state;\n-          context_state context/@@plone_context_state;\n-          plone_view context/@@plone;\n-          plone_layout context/@@plone_layout;\n-          lang portal_state/language;\n+      tal:define="portal_state python:context.restrictedTraverse(\'@@plone_portal_state\');\n+          context_state python:context.restrictedTraverse(\'@@plone_context_state\');\n+          plone_view python:context.restrictedTraverse(\'@@plone\');\n+          plone_layout python:context.restrictedTraverse(\'@@plone_layout\');\n+          lang python:portal_state.language();\n           view nocall:view | nocall: plone_view;\n           dummy python: plone_layout.mark_view(view);\n-          portal_url portal_state/portal_url;\n-          checkPermission nocall: context/portal_membership/checkPermission;\n-          site_properties context/portal_properties/site_properties;\n-          ajax_include_head request/ajax_include_head | nothing;\n+          portal_url python:portal_state.portal_url();\n+          checkPermission python:context.restrictedTraverse(\'portal_membership\').checkPermission;\n+          site_properties python:context.restrictedTraverse(\'portal_properties\').site_properties;\n+          ajax_include_head python:request.get(\'ajax_include_head\', False);\n           ajax_load python:False;"\n       i18n:domain="plone"\n       tal:attributes="lang lang;">\ndiff --git a/Products/CMFPlone/browser/templates/search.pt b/Products/CMFPlone/browser/templates/search.pt\nindex aa05139b7..bf307ee2d 100644\n--- a/Products/CMFPlone/browser/templates/search.pt\n+++ b/Products/CMFPlone/browser/templates/search.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <head>\ndiff --git a/Products/CMFPlone/browser/templates/send_feedback_confirm.pt b/Products/CMFPlone/browser/templates/send_feedback_confirm.pt\nindex 4246f4353..99c5de6ec 100644\n--- a/Products/CMFPlone/browser/templates/send_feedback_confirm.pt\n+++ b/Products/CMFPlone/browser/templates/send_feedback_confirm.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <head>\n@@ -19,7 +19,7 @@\n         i18n:translate="heading_send_feedback_confirm">\n         Site Administrator has been contacted.\n     </h1>\n-\t\n+\n     <div class="documentDescription" i18n:translate="message_send_feedback_confirm">\n         A mail has now been sent to the site administrator regarding your\n         questions and/or comments.\ndiff --git a/Products/CMFPlone/browser/templates/sitemap.pt b/Products/CMFPlone/browser/templates/sitemap.pt\nindex b773d1f7b..d9d21ce6c 100644\n--- a/Products/CMFPlone/browser/templates/sitemap.pt\n+++ b/Products/CMFPlone/browser/templates/sitemap.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <head>\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt b/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt\nindex 0d36e82d4..a53478e32 100644\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt\n+++ b/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt\n@@ -1,5 +1,5 @@\n <metal:page define-macro="master">\n-  <tal:block metal:use-macro="context/main_template/macros/master">\n+  <tal:block metal:use-macro="context/@@main_template/macros/master">\n \n     <metal:block fill-slot="top_slot">\n         <metal:override define-slot="top_slot">\n@@ -21,7 +21,7 @@\n         <metal:slot define-slot="prefs_configlet_wrapper">\n           <metal:slot define-slot="prefs_configlet_content">\n \n-            <metal:block metal:use-macro="context/main_template/macros/content">\n+            <metal:block metal:use-macro="context/@@main_template/macros/content">\n               <metal:override metal:fill-slot="main">\n                 <metal:slot metal:define-slot="prefs_configlet_main" tal:content="nothing">\n                   Page body text\ndiff --git a/Products/CMFPlone/skins/plone_templates/index_html.pt b/Products/CMFPlone/skins/plone_templates/index_html.pt\nindex 7b5e09fb7..bceba801f 100644\n--- a/Products/CMFPlone/skins/plone_templates/index_html.pt\n+++ b/Products/CMFPlone/skins/plone_templates/index_html.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <body>\ndiff --git a/Products/CMFPlone/skins/plone_templates/recently_modified.pt b/Products/CMFPlone/skins/plone_templates/recently_modified.pt\nindex 50833f331..7ee649e25 100644\n--- a/Products/CMFPlone/skins/plone_templates/recently_modified.pt\n+++ b/Products/CMFPlone/skins/plone_templates/recently_modified.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <metal:block fill-slot="top_slot"\ndiff --git a/Products/CMFPlone/skins/plone_templates/recently_published.pt b/Products/CMFPlone/skins/plone_templates/recently_published.pt\nindex 568603493..cccd879ec 100644\n--- a/Products/CMFPlone/skins/plone_templates/recently_published.pt\n+++ b/Products/CMFPlone/skins/plone_templates/recently_published.pt\n@@ -3,7 +3,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <metal:block fill-slot="top_slot"\ndiff --git a/Products/CMFPlone/skins/plone_templates/test_rendering.pt b/Products/CMFPlone/skins/plone_templates/test_rendering.pt\nindex 37db1de48..a44a0a5d5 100644\n--- a/Products/CMFPlone/skins/plone_templates/test_rendering.pt\n+++ b/Products/CMFPlone/skins/plone_templates/test_rendering.pt\n@@ -5,7 +5,7 @@\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n+      metal:use-macro="context/@@main_template/macros/master"\n       i18n:domain="plone">\n \n <body>\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-04-16T11:27:58+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/71af9d573796b8fcfd914fad270a288231926f50

add logger.exception

Files changed:
M Products/CMFPlone/factory.py

b"diff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py\nindex b07e9ea63..ce329e14d 100644\n--- a/Products/CMFPlone/factory.py\n+++ b/Products/CMFPlone/factory.py\n@@ -5,6 +5,7 @@\n from Products.CMFPlone.interfaces import INonInstallable\n from Products.GenericSetup.tool import SetupTool\n from Products.statusmessages.interfaces import IStatusMessage\n+from logging import getLogger\n from plone.registry.interfaces import IRegistry\n from zope.component import queryUtility\n from zope.event import notify\n@@ -18,6 +19,8 @@\n # A little hint for PloneTestCase\n _IMREALLYPLONE5 = True\n \n+logger = getLogger('Plone')\n+\n \n @implementer(INonInstallable)\n class NonInstallable(object):\n@@ -178,7 +181,10 @@ def addPloneSite(context, site_id, title='Plone site', description='',\n                     'profile_id': extension_id,\n                     'error_msg': msg.args,\n                 }),\n-                type='warning')\n+                type='error')\n+            logger.exception(\n+                'Error while installing addon {}. '\n+                'See traceback below for details.'.format(extension_id))\n \n     if snapshot is True:\n         setup_tool.createSnapshot('initial_configuration')\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-04-16T20:15:38+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/e08c72b9a4316a53f6bac4957dc29fcb20ffdf69

Merge branch 'master' into petschki_issue_2228

Files changed:
A news/2842.bugfix
M Products/CMFPlone/browser/login/login.py
M Products/CMFPlone/tests/test_login_form.py

b'diff --git a/Products/CMFPlone/browser/login/login.py b/Products/CMFPlone/browser/login/login.py\nindex 4114e1711..2ceda2300 100644\n--- a/Products/CMFPlone/browser/login/login.py\n+++ b/Products/CMFPlone/browser/login/login.py\n@@ -68,15 +68,18 @@ def render(self):\n     def _handle_external_login(self, url):\n         """Handle login on this portal where login is external."""\n         next_ = self.request.get(\'next\', None)\n+        came_from = self.request.get(\'came_from\')\n+        urlparts = [part for part in parse.urlparse(url)]\n+        qs = dict(parse.parse_qsl(urlparts[4]))\n         portal_url = getToolByName(self.context, \'portal_url\')\n         if next_ is not None and not portal_url.isURLInPortal(next_):\n             next_ = None\n         if next_ is not None:\n-            url = \'{0}?next={1}\'.format(url, next_)\n-        came_from = self.request.get(\'came_from\')\n+            qs[\'next\'] = next_\n         if came_from:\n-            url = \'{0}&came_from={1}\'.format(url, came_from)\n-        self.request.response.redirect(url)\n+            qs[\'came_from\'] = came_from\n+        urlparts[4] = parse.urlencode(qs)\n+        self.request.response.redirect(parse.urlunparse(urlparts))\n \n     def _get_auth(self):\n         try:\ndiff --git a/Products/CMFPlone/tests/test_login_form.py b/Products/CMFPlone/tests/test_login_form.py\nindex f1a3a6849..49e20620c 100644\n--- a/Products/CMFPlone/tests/test_login_form.py\n+++ b/Products/CMFPlone/tests/test_login_form.py\n@@ -79,9 +79,9 @@ def test_login_external(self):\n             form.request.response.getHeader(\'Location\'),\n         )\n \n-    def test_login_external_with_params(self):\n+    def test_login_external_with_all_params(self):\n         registry = self.layer[\'portal\'].portal_registry\n-        registry[\'plone.external_login_url\'] = \'http://testurl/extlogin\'\n+        registry[\'plone.external_login_url\'] = \'http://testurl/extlogin?level=debug\'\n         self.request[\'came_from\'] = \'foo\'\n         self.request[\'next\'] = \'bar\'\n         form = self.portal.restrictedTraverse(\'login\')\n@@ -94,6 +94,22 @@ def test_login_external_with_params(self):\n             \'next=bar\',\n             form.request.response.getHeader(\'Location\'),\n         )\n+        # Keep the original query string\n+        self.assertIn(\n+            \'level=debug\',\n+            form.request.response.getHeader(\'Location\'),\n+        )\n+\n+    def test_login_external_without_next_param(self):\n+        registry = self.layer[\'portal\'].portal_registry\n+        registry[\'plone.external_login_url\'] = \'http://testurl/extlogin\'\n+        self.request[\'came_from\'] = \'foo\'\n+        form = self.portal.restrictedTraverse(\'login\')\n+        form()\n+        self.assertIn(\n+            \'came_from=foo\',\n+            form.request.response.getHeader(\'Location\'),\n+        )\n \n     def test_failsafe_login_external(self):\n         registry = self.layer[\'portal\'].portal_registry\ndiff --git a/news/2842.bugfix b/news/2842.bugfix\nnew file mode 100644\nindex 000000000..d65b47082\n--- /dev/null\n+++ b/news/2842.bugfix\n@@ -0,0 +1 @@\n+Fix malformed url when redirecting to external login. [ericof]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-04-17T09:04:11+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/0265f4afe8fb5ac0a61216aa779138e11cfa6404

Merge pull request #2840 from plone/petschki_issue_2228

gracefully handle tracebacks when installing addons during site creation

Files changed:
A news/2228.bugfix
M Products/CMFPlone/factory.py

b'diff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py\nindex c7bf9ea89..ce329e14d 100644\n--- a/Products/CMFPlone/factory.py\n+++ b/Products/CMFPlone/factory.py\n@@ -1,8 +1,11 @@\n # -*- coding: utf-8 -*-\n+from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.Portal import PloneSite\n from Products.CMFPlone.events import SiteManagerCreatedEvent\n from Products.CMFPlone.interfaces import INonInstallable\n from Products.GenericSetup.tool import SetupTool\n+from Products.statusmessages.interfaces import IStatusMessage\n+from logging import getLogger\n from plone.registry.interfaces import IRegistry\n from zope.component import queryUtility\n from zope.event import notify\n@@ -16,6 +19,8 @@\n # A little hint for PloneTestCase\n _IMREALLYPLONE5 = True\n \n+logger = getLogger(\'Plone\')\n+\n \n @implementer(INonInstallable)\n class NonInstallable(object):\n@@ -163,8 +168,23 @@ def addPloneSite(context, site_id, title=\'Plone site\', description=\'\',\n     site.manage_changeProperties(**props)\n \n     for extension_id in extension_ids:\n-        setup_tool.runAllImportStepsFromProfile(\n-            \'profile-%s\' % extension_id)\n+        try:\n+            setup_tool.runAllImportStepsFromProfile(\n+                \'profile-%s\' % extension_id)\n+        except Exception as msg:\n+            IStatusMessage(request).add(_(\n+                \'Could not install ${profile_id}: ${error_msg}! \'\n+                \'Please try to install it manually using the "Addons" \'\n+                \'controlpanel and report any issues to the \'\n+                \'addon maintainers.\',\n+                mapping={\n+                    \'profile_id\': extension_id,\n+                    \'error_msg\': msg.args,\n+                }),\n+                type=\'error\')\n+            logger.exception(\n+                \'Error while installing addon {}. \'\n+                \'See traceback below for details.\'.format(extension_id))\n \n     if snapshot is True:\n         setup_tool.createSnapshot(\'initial_configuration\')\ndiff --git a/news/2228.bugfix b/news/2228.bugfix\nnew file mode 100644\nindex 000000000..5bb1df8de\n--- /dev/null\n+++ b/news/2228.bugfix\n@@ -0,0 +1,2 @@\n+gracefully handle tracebacks during addon installation\n+[petschki]\n'

