Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-11-07T21:58:03-08:00
Author: Balázs Reé (reebalazs) <ree@greenfinity.hu>
Commit: https://github.com/plone/plone.restapi/commit/322a554b0f398385ce2d9ea6017dd2e13ea01b9a

fix time to be returned with a timezone specifier (#1531)

* fix time to be returned with a timezone specifier

* Update news/1530.bugfix

Co-authored-by: David Glick &lt;david@glicksoftware.com&gt;

Files changed:
A news/1530.bugfix
M src/plone/restapi/services/history/get.py
M src/plone/restapi/tests/http-examples/history_get.resp
M src/plone/restapi/tests/http-examples/translated_messages_addons.resp
M src/plone/restapi/tests/http-examples/translated_messages_object_history.resp

b'diff --git a/news/1530.bugfix b/news/1530.bugfix\nnew file mode 100644\nindex 000000000..451acb4cf\n--- /dev/null\n+++ b/news/1530.bugfix\n@@ -0,0 +1 @@\n+Fix time to be returned with a timezone specifier in history endpoint @reebalazs\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/services/history/get.py b/src/plone/restapi/services/history/get.py\nindex 22095e615..d4543eb41 100644\n--- a/src/plone/restapi/services/history/get.py\n+++ b/src/plone/restapi/services/history/get.py\n@@ -71,7 +71,13 @@ def reply(self):\n             # Versioning entries use a timestamp,\n             # workflow ISO formatted string\n             if not isinstance(item["time"], str):\n-                item["time"] = dt.fromtimestamp(int(item["time"])).isoformat()\n+                # Note that isoformat does not add the Z at the end of the string, The lack of the\n+                # timezone specifier causes Intl (and derivative libraries) in the browser not to\n+                # use local time, which is considered a bug in applications. Therefore we add the Z\n+                # to the end to make sure that the date will be interpreted properly by the client.\n+                item["time"] = dt.fromtimestamp(int(item["time"])).strftime(\n+                    "%Y-%m-%dT%H:%M:%SZ"\n+                )\n \n             # The create event has an empty \'action\', but we like it to say\n             # \'Create\', alike the transition_title\ndiff --git a/src/plone/restapi/tests/http-examples/history_get.resp b/src/plone/restapi/tests/http-examples/history_get.resp\nindex de29a07dc..7819c1085 100644\n--- a/src/plone/restapi/tests/http-examples/history_get.resp\n+++ b/src/plone/restapi/tests/http-examples/history_get.resp\n@@ -13,7 +13,7 @@ Content-Type: application/json\n         },\n         "comments": "Initial version",\n         "may_revert": true,\n-        "time": "1995-07-31T17:30:00",\n+        "time": "1995-07-31T17:30:00Z",\n         "transition_title": "Edited",\n         "type": "versioning",\n         "version": 0\n@@ -29,7 +29,7 @@ Content-Type: application/json\n         "comments": "",\n         "review_state": "private",\n         "state_title": "Private",\n-        "time": "1995-07-31T18:30:00",\n+        "time": "1995-07-31T18:30:00Z",\n         "transition_title": "Create",\n         "type": "workflow"\n     }\ndiff --git a/src/plone/restapi/tests/http-examples/translated_messages_addons.resp b/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\nindex b310a87fd..5af758c19 100644\n--- a/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\n+++ b/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\n@@ -73,7 +73,7 @@ Content-Type: application/json\n                 "newVersion": "0006",\n                 "required": false\n             },\n-            "version": "8.31.1.dev0"\n+            "version": "8.32.1.dev0"\n         },\n         {\n             "@id": "http://localhost:55001/plone/@addons/plone.session",\ndiff --git a/src/plone/restapi/tests/http-examples/translated_messages_object_history.resp b/src/plone/restapi/tests/http-examples/translated_messages_object_history.resp\nindex ae005d877..d691c98e3 100644\n--- a/src/plone/restapi/tests/http-examples/translated_messages_object_history.resp\n+++ b/src/plone/restapi/tests/http-examples/translated_messages_object_history.resp\n@@ -13,7 +13,7 @@ Content-Type: application/json\n         },\n         "comments": "Versi\\u00f3n inicial",\n         "may_revert": true,\n-        "time": "1995-07-31T17:30:00",\n+        "time": "1995-07-31T17:30:00Z",\n         "transition_title": "Editado",\n         "type": "versioning",\n         "version": 0\n@@ -29,7 +29,7 @@ Content-Type: application/json\n         "comments": "",\n         "review_state": "private",\n         "state_title": "Privado",\n-        "time": "1995-07-31T18:30:00",\n+        "time": "1995-07-31T18:30:00Z",\n         "transition_title": "Crear",\n         "type": "workflow"\n     }\n'

