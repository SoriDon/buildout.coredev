Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-09-13T19:16:32+02:00
Author: Érico Andrei (ericof) <ericof@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/10da0d0e67691f73e25b1b50a0c294bea9d09227

Fix #1222: Order users by fullname.

Files changed:
A news/1222.bugfix
M src/plone/restapi/services/users/get.py

b'diff --git a/news/1222.bugfix b/news/1222.bugfix\nnew file mode 100644\nindex 000000000..1652f94f9\n--- /dev/null\n+++ b/news/1222.bugfix\n@@ -0,0 +1,2 @@\n+Fix @users endpoint to return list of users ordered by fullname property\n+[ericof]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/services/users/get.py b/src/plone/restapi/services/users/get.py\nindex cf29d5c9f..72d690731 100644\n--- a/src/plone/restapi/services/users/get.py\n+++ b/src/plone/restapi/services/users/get.py\n@@ -2,6 +2,7 @@\n from plone.restapi.interfaces import ISerializeToJson\n from plone.restapi.services import Service\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.utils import normalizeString\n from zExceptions import BadRequest\n from zope.component import queryMultiAdapter\n from zope.component.hooks import getSite\n@@ -36,15 +37,25 @@ def _get_user_id(self):\n     def _get_user(self, user_id):\n         return self.portal_membership.getMemberById(user_id)\n \n+    @staticmethod\n+    def _sort_users(users):\n+        users.sort(\n+            key=lambda x: x is not None\n+            and normalizeString(x.getProperty("fullname", ""))\n+        )\n+        return users\n+\n     def _get_users(self):\n         results = {user["userid"] for user in self.acl_users.searchUsers()}\n-        return [self.portal_membership.getMemberById(userid) for userid in results]\n+        users = [self.portal_membership.getMemberById(userid) for userid in results]\n+        return self._sort_users(users)\n \n     def _get_filtered_users(self, query, limit):\n         results = self.acl_users.searchUsers(id=query, max_results=limit)\n-        return [\n+        users = [\n             self.portal_membership.getMemberById(user["userid"]) for user in results\n         ]\n+        return self._sort_users(users)\n \n     def has_permission_to_query(self):\n         sm = getSecurityManager()\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-09-13T21:25:13+02:00
Author: Érico Andrei (ericof) <ericof@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/3956dde1bad69a4bf27e89852e47fdd196eebb1a

Merge pull request #1223 from plone/users-ordering-fix

Order users by fullname.

Files changed:
A news/1222.bugfix
M src/plone/restapi/services/users/get.py

b'diff --git a/news/1222.bugfix b/news/1222.bugfix\nnew file mode 100644\nindex 000000000..1652f94f9\n--- /dev/null\n+++ b/news/1222.bugfix\n@@ -0,0 +1,2 @@\n+Fix @users endpoint to return list of users ordered by fullname property\n+[ericof]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/services/users/get.py b/src/plone/restapi/services/users/get.py\nindex cf29d5c9f..72d690731 100644\n--- a/src/plone/restapi/services/users/get.py\n+++ b/src/plone/restapi/services/users/get.py\n@@ -2,6 +2,7 @@\n from plone.restapi.interfaces import ISerializeToJson\n from plone.restapi.services import Service\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.utils import normalizeString\n from zExceptions import BadRequest\n from zope.component import queryMultiAdapter\n from zope.component.hooks import getSite\n@@ -36,15 +37,25 @@ def _get_user_id(self):\n     def _get_user(self, user_id):\n         return self.portal_membership.getMemberById(user_id)\n \n+    @staticmethod\n+    def _sort_users(users):\n+        users.sort(\n+            key=lambda x: x is not None\n+            and normalizeString(x.getProperty("fullname", ""))\n+        )\n+        return users\n+\n     def _get_users(self):\n         results = {user["userid"] for user in self.acl_users.searchUsers()}\n-        return [self.portal_membership.getMemberById(userid) for userid in results]\n+        users = [self.portal_membership.getMemberById(userid) for userid in results]\n+        return self._sort_users(users)\n \n     def _get_filtered_users(self, query, limit):\n         results = self.acl_users.searchUsers(id=query, max_results=limit)\n-        return [\n+        users = [\n             self.portal_membership.getMemberById(user["userid"]) for user in results\n         ]\n+        return self._sort_users(users)\n \n     def has_permission_to_query(self):\n         sm = getSecurityManager()\n'

