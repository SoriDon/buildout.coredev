Repository: plone.app.widgets


Branch: refs/heads/master
Date: 2016-02-18T16:19:32-08:00
Author: Alec Mitchell (alecpm) <alecpm@gmail.com>
Commit: https://github.com/plone/plone.app.widgets/commit/9aa25defbf736bc6ae480c88020267b4d17bb0b7

Add navigation root support to related items widget. Fix incorrect options merge for TinyMCE widget. Allow context url lookup to work with a wider variety of form types.

Files changed:
M CHANGES.rst
M plone/app/widgets/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0c8f956..d8ba9e2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,11 +6,14 @@ Changelog
 
 New:
 
-- *add item here*
+- Add navigation root support to related items widget. Fix incorrect options
+  merge for TinyMCE widget.
+  [alecm]
 
 Fixes:
 
-- *add item here*
+- Ensure vocabulary lookup works on add forms for related items widget.
+  [alecm]
 
 
 2.0.3 (2016-02-14)
diff --git a/plone/app/widgets/utils.py b/plone/app/widgets/utils.py
index daec100..2d3dd27 100644
--- a/plone/app/widgets/utils.py
+++ b/plone/app/widgets/utils.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 
+from Acquisition import aq_base
 from Products.CMFCore.interfaces import ISiteRoot
 from Products.CMFCore.utils import getToolByName
 from datetime import datetime
@@ -10,7 +11,7 @@
 from zope.i18n import translate
 from zope.i18nmessageid import MessageFactory
 from zope.schema.interfaces import IVocabularyFactory
-from z3c.form.interfaces import IAddForm
+from z3c.form.interfaces import IForm
 from zope.component import getMultiAdapter
 from zope.component import ComponentLookupError
 import json
@@ -119,11 +120,11 @@ def get_ajaxselect_options(context, value, separator, vocabulary_name,
 
 def get_relateditems_options(context, value, separator, vocabulary_name,
                              vocabulary_view, field_name=None):
-    portal = get_portal()
-    options = get_ajaxselect_options(portal, value, separator,
+    options = get_ajaxselect_options(context, value, separator,
                                      vocabulary_name, vocabulary_view,
                                      field_name)
-
+    if IForm.providedBy(context):
+        context = context.context
     request = getRequest()
     msgstr = translate(_(u'Search'), context=request)
     options.setdefault('searchText', msgstr)
@@ -134,6 +135,12 @@ def get_relateditems_options(context, value, separator, vocabulary_name,
                        context=request)
     options.setdefault('homeText', msgstr)
     options.setdefault('folderTypes', ['Folder'])
+
+    nav_root = getNavigationRootObject(context, get_portal())
+    options['rootPath'] = (
+        '/'.join(nav_root.getPhysicalPath()) if nav_root else '/'
+    )
+
     return options
 
 
@@ -155,15 +162,15 @@ def get_tinymce_options(context, field, request):
     We're just going to be looking up settings from
     plone pattern options
     """
-    args = {'pattern_options': {}}
+    options = {}
     try:
         pattern_options = getMultiAdapter(
             (context, request, field),
             name="plone_settings").tinymce()['data-pat-tinymce']
-        args['pattern_options'] = json.loads(pattern_options)
+        options = json.loads(pattern_options)
     except (ComponentLookupError, AttributeError):
         pass
-    return args
+    return options
 
 
 def get_portal():
@@ -189,7 +196,7 @@ def get_portal_url(context):
 
 
 def get_context_url(context):
-    if IAddForm.providedBy(context):
+    if IForm.providedBy(context):
         # Use the request URL if we are looking at an addform
         url = context.request.get('URL')
     elif hasattr(context, 'absolute_url'):
@@ -199,3 +206,10 @@ def get_context_url(context):
     else:
         url = get_portal_url(context)
     return url
+
+
+def get_widget_form(widget):
+    form = getattr(widget, 'form', None)
+    if getattr(aq_base(form), 'parentForm', None) is not None:
+        form = form.parentForm
+    return form


Repository: plone.app.widgets


Branch: refs/heads/master
Date: 2016-02-22T15:59:17+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.widgets/commit/fb28d6a43730311ccd2262781ed1b9a7124a9262

Merge pull request #131 from plone/navroot-fixes

Add navigation root support to related items widget.

Files changed:
M CHANGES.rst
M plone/app/widgets/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0c8f956..d8ba9e2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,11 +6,14 @@ Changelog
 
 New:
 
-- *add item here*
+- Add navigation root support to related items widget. Fix incorrect options
+  merge for TinyMCE widget.
+  [alecm]
 
 Fixes:
 
-- *add item here*
+- Ensure vocabulary lookup works on add forms for related items widget.
+  [alecm]
 
 
 2.0.3 (2016-02-14)
diff --git a/plone/app/widgets/utils.py b/plone/app/widgets/utils.py
index daec100..2d3dd27 100644
--- a/plone/app/widgets/utils.py
+++ b/plone/app/widgets/utils.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 
+from Acquisition import aq_base
 from Products.CMFCore.interfaces import ISiteRoot
 from Products.CMFCore.utils import getToolByName
 from datetime import datetime
@@ -10,7 +11,7 @@
 from zope.i18n import translate
 from zope.i18nmessageid import MessageFactory
 from zope.schema.interfaces import IVocabularyFactory
-from z3c.form.interfaces import IAddForm
+from z3c.form.interfaces import IForm
 from zope.component import getMultiAdapter
 from zope.component import ComponentLookupError
 import json
@@ -119,11 +120,11 @@ def get_ajaxselect_options(context, value, separator, vocabulary_name,
 
 def get_relateditems_options(context, value, separator, vocabulary_name,
                              vocabulary_view, field_name=None):
-    portal = get_portal()
-    options = get_ajaxselect_options(portal, value, separator,
+    options = get_ajaxselect_options(context, value, separator,
                                      vocabulary_name, vocabulary_view,
                                      field_name)
-
+    if IForm.providedBy(context):
+        context = context.context
     request = getRequest()
     msgstr = translate(_(u'Search'), context=request)
     options.setdefault('searchText', msgstr)
@@ -134,6 +135,12 @@ def get_relateditems_options(context, value, separator, vocabulary_name,
                        context=request)
     options.setdefault('homeText', msgstr)
     options.setdefault('folderTypes', ['Folder'])
+
+    nav_root = getNavigationRootObject(context, get_portal())
+    options['rootPath'] = (
+        '/'.join(nav_root.getPhysicalPath()) if nav_root else '/'
+    )
+
     return options
 
 
@@ -155,15 +162,15 @@ def get_tinymce_options(context, field, request):
     We're just going to be looking up settings from
     plone pattern options
     """
-    args = {'pattern_options': {}}
+    options = {}
     try:
         pattern_options = getMultiAdapter(
             (context, request, field),
             name="plone_settings").tinymce()['data-pat-tinymce']
-        args['pattern_options'] = json.loads(pattern_options)
+        options = json.loads(pattern_options)
     except (ComponentLookupError, AttributeError):
         pass
-    return args
+    return options
 
 
 def get_portal():
@@ -189,7 +196,7 @@ def get_portal_url(context):
 
 
 def get_context_url(context):
-    if IAddForm.providedBy(context):
+    if IForm.providedBy(context):
         # Use the request URL if we are looking at an addform
         url = context.request.get('URL')
     elif hasattr(context, 'absolute_url'):
@@ -199,3 +206,10 @@ def get_context_url(context):
     else:
         url = get_portal_url(context)
     return url
+
+
+def get_widget_form(widget):
+    form = getattr(widget, 'form', None)
+    if getattr(aq_base(form), 'parentForm', None) is not None:
+        form = form.parentForm
+    return form


