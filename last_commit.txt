Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2021-09-24T23:48:44+02:00
Author: Michael Launay (michaellaunay) <michaellaunay@ecreall.com>
Commit: https://github.com/plone/plone.app.portlets/commit/851b4bda1feed101e4b6ac6c37f4e687120a33d5

Fix Plone 5.2.4 migrating troubles

Old portlet version didn't have no_thumb attribute, so when you finished to migrate them to Plone5.2.4 python3 and run instance you have :
2021-09-23 15:35:38,262 INFO    [plone.protect:38][waitress-0] auto rotating keyring _anon
2021-09-23 15:35:40,235 ERROR   [portlets:58][waitress-1] Error while rendering &lt;plone.app.portlets.manager.ColumnPortletManagerRenderer object at 0x7f452b6b2520&gt;
Traceback (most recent call last):
  File "/home/michaellaunay/plone524/buildout-cache/eggs/cp38/Zope-4.5.5-py3.8.egg/OFS/Traversable.py", line 297, in unrestrictedTraverse
    next = obj[name]
TypeError: 'Assignment' object is not subscriptableDuring handling of the above exception, another exception occurred:Traceback (most recent call last):
  File "/home/michaellaunay/plone524/buildout-cache/eggs/cp38/Zope-4.5.5-py3.8.egg/OFS/Traversable.py", line 309, in unrestrictedTraverse
    raise NotFound(name)
zExceptions.NotFound: no_thumbsDuring handling of the above exception, another exception occurred:Traceback (most recent call last):
  File "/home/michaellaunay/plone524/buildout-cache/eggs/cp38/Chameleon-3.9.0-py3.8.egg/chameleon/template.py", line 192, in render
    self._render(stream, econtext, rcontext)
  File "/home/michaellaunay/plone524/zeocluster/var/cache/0430f070bad760a6150431e1fc100209.py", line 235, in render
    __value = _static_139935422494224('path', 'view/data/no_thumbs', econtext=econtext)(_static_139935422494512(econtext, __zt_tmp))
  File "/home/michaellaunay/plone524/buildout-cache/eggs/cp38/zope.tales-5.1-py3.8.egg/zope/tales/expressions.py", line 250, in __call__
    return self._eval(econtext)
  File "/home/michaellaunay/plone524/buildout-cache/eggs/cp38/Zope-4.5.5-py3.8.egg/Products/PageTemplates/Expressions.py", line 188, in _eval
    ob = self._subexprs[-1](econtext)
  File "/home/michaellaunay/plone524/buildout-cache/eggs/cp38/zope.tales-5.1-py3.8.egg/zope/tales/expressions.py", line 153, in _eval
    ob = self._traverser(ob, element, econtext)
  File "/home/michaellaunay/plone524/buildout-cache/eggs/cp38/Zope-4.5.5-py3.8.egg/Products/PageTemplates/Expressions.py", line 102, in trustedBoboAwareZopeTraverse
    object = object.unrestrictedTraverse(name)
  File "/home/michaellaunay/plone524/buildout-cache/eggs/cp38/Zope-4.5.5-py3.8.egg/OFS/Traversable.py", line 317, in unrestrictedTraverse
    (obj, aq_acquire(self, 'REQUEST')),
AttributeError: REQUEST

Files changed:
M plone/app/portlets/portlets/recent.py

b'diff --git a/plone/app/portlets/portlets/recent.py b/plone/app/portlets/portlets/recent.py\nindex e0178218..f89e615a 100644\n--- a/plone/app/portlets/portlets/recent.py\n+++ b/plone/app/portlets/portlets/recent.py\n@@ -61,6 +61,7 @@ class IRecentPortlet(IPortletDataProvider):\n class Assignment(base.Assignment):\n     no_icons = False\n     thumb_scale = None\n+    no_thumbs = False\n \n     def __init__(self, count=5, no_icons=False, thumb_scale=None, no_thumbs=False):\n         self.count = count\n'

Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2022-07-04T13:51:00+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.portlets/commit/93ee1dee700c8187963f662ad49df16704402ef0

Merge branch 'master' into patch-1

Files changed:
A plone/app/portlets/browser/templates/footer.pt
A plone/app/portlets/browser/templates/manage_portlets_fallback.pt
A plone/app/portlets/browser/viewlets.py
A plone/app/portlets/dashboard/__init__.py
A plone/app/portlets/dashboard/configure.zcml
A plone/app/portlets/dashboard/dashboard.pt
A plone/app/portlets/dashboard/dashboard.py
A plone/app/portlets/dashboard/user_actions.pt
A plone/app/portlets/dashboard/user_actions.py
M CHANGES.rst
M plone/__init__.py
M plone/app/__init__.py
M plone/app/portlets/assignable.py
M plone/app/portlets/browser/adding.py
M plone/app/portlets/browser/configure.zcml
M plone/app/portlets/browser/editmanager.py
M plone/app/portlets/browser/formhelper.py
M plone/app/portlets/browser/manage.py
M plone/app/portlets/browser/templates/manage-contextual.pt
M plone/app/portlets/browser/templates/manage-group-dashboard.pt
M plone/app/portlets/browser/templates/manage-group.pt
M plone/app/portlets/browser/templates/topbar-manage-portlets.pt
M plone/app/portlets/browser/traversal.py
M plone/app/portlets/browser/utils.py
M plone/app/portlets/checker.py
M plone/app/portlets/configure.zcml
M plone/app/portlets/exportimport/__init__.py
M plone/app/portlets/exportimport/portlets.py
M plone/app/portlets/manager.py
M plone/app/portlets/metaconfigure.py
M plone/app/portlets/metadirectives.py
M plone/app/portlets/portlets/__init__.py
M plone/app/portlets/portlets/actions.py
M plone/app/portlets/portlets/base.py
M plone/app/portlets/portlets/classic.py
M plone/app/portlets/portlets/language.py
M plone/app/portlets/portlets/login.py
M plone/app/portlets/portlets/navigation.py
M plone/app/portlets/portlets/navigation_recurse.pt
M plone/app/portlets/portlets/news.py
M plone/app/portlets/portlets/recent.pt
M plone/app/portlets/portlets/recent.py
M plone/app/portlets/portlets/review.py
M plone/app/portlets/portlets/rss.py
M plone/app/portlets/portlets/search.pt
M plone/app/portlets/portlets/search.py
M plone/app/portlets/storage.py
M plone/app/portlets/tests/test_formextender.py
M setup.cfg
M setup.py
D plone/app/portlets/browser/manage-portlets.js
D plone/app/portlets/dashboard.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 74aae3ee..7db62182 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -8,6 +8,67 @@ Changelog\n \n .. towncrier release notes start\n \n+5.0.0b1 (2022-06-23)\n+--------------------\n+\n+Bug fixes:\n+\n+\n+- Styling Links as Buttons in Portlet Management View\n+  [1letter] (#164)\n+\n+\n+5.0.0a10 (2022-04-08)\n+---------------------\n+\n+Bug fixes:\n+\n+\n+- Use @@iconresolver to display icons in navigation portlet.\n+  [pbauer] (#162)\n+\n+\n+5.0.0a9 (2022-04-04)\n+--------------------\n+\n+Breaking changes:\n+\n+\n+- Remove manage-portlets.js, this is part of mockup now [MrTango] (#159)\n+\n+\n+5.0.0a8 (2022-03-23)\n+--------------------\n+\n+New features:\n+\n+\n+- Fixes for latest z3c.form\n+  [petschki] (#161)\n+\n+\n+5.0.0a7 (2021-11-23)\n+--------------------\n+\n+Breaking changes:\n+\n+\n+- Move most (hard dependency) portlet related from `plone.app.layout`:\n+  Dashboard, Portlet related viewlets.\n+  A first step towards a Portlet-as-an-Addon story.\n+  [jensens] (#160)\n+\n+\n+5.0.0a6 (2021-10-16)\n+--------------------\n+\n+Bug fixes:\n+\n+\n+- Add missing i18n:translate tags\n+  [erral] (#158)\n+\n+\n 5.0.0a5 (2021-09-15)\n --------------------\n \ndiff --git a/plone/__init__.py b/plone/__init__.py\nindex 05f0bebb..5284146e 100644\n--- a/plone/__init__.py\n+++ b/plone/__init__.py\n@@ -1,7 +1 @@\n-# See http://peak.telecommunity.com/DevCenter/setuptools#namespace-packages\n-try:\n-    __import__("pkg_resources").declare_namespace(__name__)\n-except ImportError:\n-    from pkgutil import extend_path\n-\n-    __path__ = extend_path(__path__, __name__)\n+__import__("pkg_resources").declare_namespace(__name__)\ndiff --git a/plone/app/__init__.py b/plone/app/__init__.py\nindex 05f0bebb..5284146e 100644\n--- a/plone/app/__init__.py\n+++ b/plone/app/__init__.py\n@@ -1,7 +1 @@\n-# See http://peak.telecommunity.com/DevCenter/setuptools#namespace-packages\n-try:\n-    __import__("pkg_resources").declare_namespace(__name__)\n-except ImportError:\n-    from pkgutil import extend_path\n-\n-    __path__ = extend_path(__path__, __name__)\n+__import__("pkg_resources").declare_namespace(__name__)\ndiff --git a/plone/app/portlets/assignable.py b/plone/app/portlets/assignable.py\nindex b6b0471d..902b34b8 100644\n--- a/plone/app/portlets/assignable.py\n+++ b/plone/app/portlets/assignable.py\n@@ -1,4 +1,4 @@\n-from plone.app.portlets.storage import PortletAssignmentMapping\n+from .storage import PortletAssignmentMapping\n from plone.portlets.constants import CONTEXT_ASSIGNMENT_KEY\n from plone.portlets.constants import CONTEXT_CATEGORY\n from plone.portlets.interfaces import ILocalPortletAssignable\ndiff --git a/plone/app/portlets/browser/adding.py b/plone/app/portlets/browser/adding.py\nindex 48340277..656babe3 100644\n--- a/plone/app/portlets/browser/adding.py\n+++ b/plone/app/portlets/browser/adding.py\n@@ -1,9 +1,9 @@\n+from ..interfaces import IPortletPermissionChecker\n+from .interfaces import IPortletAdding\n from Acquisition import aq_base\n from Acquisition import aq_inner\n from Acquisition import aq_parent\n from OFS.SimpleItem import SimpleItem\n-from plone.app.portlets.browser.interfaces import IPortletAdding\n-from plone.app.portlets.interfaces import IPortletPermissionChecker\n from Products.CMFCore.utils import getToolByName\n from Products.Five import BrowserView\n from warnings import warn\ndiff --git a/plone/app/portlets/browser/configure.zcml b/plone/app/portlets/browser/configure.zcml\nindex 8ba32160..653f3487 100644\n--- a/plone/app/portlets/browser/configure.zcml\n+++ b/plone/app/portlets/browser/configure.zcml\n@@ -213,12 +213,6 @@\n \n     </configure>\n \n-    <!-- Resources -->\n-    <browser:resource\n-        name="manage-portlets.js"\n-        file="manage-portlets.js"\n-        />\n-\n     <browser:page\n         for="*"\n         name="render-portlet"\n@@ -227,4 +221,23 @@\n         permission="zope2.View"\n         />\n \n+    <!-- Portlets Footer -->\n+    <browser:viewlet\n+        name="plone.footer"\n+        for="*"\n+        manager="plone.app.layout.viewlets.interfaces.IPortalFooter"\n+        class=".viewlets.FooterViewlet"\n+        permission="zope.Public"\n+        />\n+\n+    <!-- Manage portlets Fallback link -->\n+    <browser:viewlet\n+        name="plone.manage_portlets_fallback"\n+        for="plone.portlets.interfaces.ILocalPortletAssignable"\n+        view="plone.app.layout.globals.interfaces.IViewView"\n+        manager="plone.app.layout.viewlets.interfaces.IBelowContent"\n+        class=".viewlets.ManagePortletsFallbackViewlet"\n+        permission="zope2.View"\n+        />\n+\n </configure>\ndiff --git a/plone/app/portlets/browser/editmanager.py b/plone/app/portlets/browser/editmanager.py\nindex 80a4851a..5e5842b2 100644\n--- a/plone/app/portlets/browser/editmanager.py\n+++ b/plone/app/portlets/browser/editmanager.py\n@@ -1,14 +1,14 @@\n+from ..interfaces import IDashboard\n+from ..interfaces import IPortletPermissionChecker\n+from .interfaces import IManageColumnPortletsView\n+from .interfaces import IManageContextualPortletsView\n+from .interfaces import IManageDashboardPortletsView\n from AccessControl import Unauthorized\n from Acquisition import aq_inner\n from Acquisition import aq_parent\n from Acquisition import Explicit\n from Acquisition.interfaces import IAcquirer\n from five.customerize.zpt import TTWViewTemplateRenderer\n-from plone.app.portlets.browser.interfaces import IManageColumnPortletsView\n-from plone.app.portlets.browser.interfaces import IManageContextualPortletsView\n-from plone.app.portlets.browser.interfaces import IManageDashboardPortletsView\n-from plone.app.portlets.interfaces import IDashboard\n-from plone.app.portlets.interfaces import IPortletPermissionChecker\n from plone.memoize.view import memoize\n from plone.portlets.constants import CONTENT_TYPE_CATEGORY\n from plone.portlets.constants import CONTEXT_CATEGORY\ndiff --git a/plone/app/portlets/browser/formhelper.py b/plone/app/portlets/browser/formhelper.py\nindex 7740d25a..3a104c73 100644\n--- a/plone/app/portlets/browser/formhelper.py\n+++ b/plone/app/portlets/browser/formhelper.py\n@@ -1,11 +1,11 @@\n+from .. import PloneMessageFactory as _\n+from ..browser.interfaces import IPortletAddForm\n+from ..browser.interfaces import IPortletEditForm\n+from ..interfaces import IPortletPermissionChecker\n from Acquisition import aq_base\n from Acquisition import aq_inner\n from Acquisition import aq_parent\n from Acquisition.interfaces import IAcquirer\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.browser.interfaces import IPortletAddForm\n-from plone.app.portlets.browser.interfaces import IPortletEditForm\n-from plone.app.portlets.interfaces import IPortletPermissionChecker\n from plone.autoform.form import AutoExtensibleForm\n from Products.CMFCore.utils import getToolByName\n from Products.Five.browser import BrowserView\ndiff --git a/plone/app/portlets/browser/manage-portlets.js b/plone/app/portlets/browser/manage-portlets.js\ndeleted file mode 100644\nindex 755bad58..00000000\n--- a/plone/app/portlets/browser/manage-portlets.js\n+++ /dev/null\n@@ -1,228 +0,0 @@\n-define([\n-  \'jquery\',\n-  \'pat-base\',\n-  \'mockup-utils\',\n-  \'mockup-patterns-modal\',\n-  \'translate\',\n-  \'pat-logger\',\n-  \'jquery.form\'\n-], function ($, Base, utils, Modal, _t, logger) {\n-  \'use strict\';\n-\n-  var log = logger.getLogger(\'pat-manage-portlets\');\n-\n-  var ManagePortlets = Base.extend({\n-    name: \'manage-portlets\',\n-    trigger: \'.pat-manage-portlets\',\n-    parser: \'mockup\',\n-    messageTimeout: 0,\n-    submitTimeout: 0,\n-    switchTimeout: 0,\n-    isModal: false,\n-    dirty: false,\n-    init: function(){\n-      var that = this;\n-      var $modal = that.$el.parents(\'.plone-modal\');\n-      if($modal.length === 1){\n-        this.isModal = true;\n-        /* want to do something on exit from modal now */\n-        var modal = $modal.data(\'pattern-plone-modal\');\n-        modal.on(\'hide\', function(){\n-          if(that.dirty){\n-            window.location.reload();\n-          }\n-        });\n-        that.loading = modal.loading;\n-      }else{\n-        that.loading = utils.loading;\n-      }\n-      that.bind();\n-    },\n-    bind: function(){\n-      var that = this;\n-      that.setupAddDropdown();\n-      that.setupSwitchPortletManager();\n-      that.setupSavePortletsSettings();\n-      that.setupPortletEdit();\n-      if(that.isModal){\n-        /* if we\'re in a modal, it\'s possible we have a link to\n-           parent case, bind the link so we can reload modal */\n-        $(\'.portlets-link-to-parent\').off(\'click\').click(function(e){\n-          that.loading.show();\n-          var $el = $(this);\n-          e.preventDefault();\n-          $.ajax({\n-            url: $el.attr(\'href\'),\n-            data: {\n-              ajax_load: 1\n-            }\n-          }).done(function(html){\n-            var $body = $(utils.parseBodyTag(html));\n-            var $modal = $el.parents(\'.plone-modal-body\');\n-            $modal.empty();\n-            var $content = $(\'#content\', $body);\n-            var $h1 = $(\'h1\', $content);\n-            $(\'.plone-modal-header\', $modal.parent()).find(\'h2\').html($h1.html());\n-            $h1.remove();\n-            $modal.append($content);\n-            that.rebind($(\'.pat-manage-portlets\', $content), true);\n-            that.loading.hide();\n-          });\n-        });\n-      }\n-    },\n-    rebind: function($el, suppress){\n-      log.info(\'rebind\');\n-      if ($.contains(document, this.$el[0])) {\n-        // $el is not detached, replace it\n-        this.$el.replaceWith($el);\n-      }\n-      this.$el = $el;\n-      this.bind();\n-      if(!suppress){\n-        this.statusMessage();\n-      }\n-      this.dirty = true;\n-    },\n-    statusMessage: function(msg){\n-      if(msg === undefined){\n-        msg = _t("Portlet changes saved");\n-      }\n-      var that = this;\n-\n-      var $message = $(\'#portlet-message\');\n-      if($message.length === 0){\n-        $message = $(\'<div class="alert alert-info" role="alert" id="portlet-message" style="opacity: 0"></div>\');\n-        if(that.isModal){\n-          $(\'.plone-modal-body:visible\').prepend($message);\n-        }else{\n-          $(\'#content-core\').prepend($message);\n-        }\n-      }\n-      $message.html(\'<strong class="mr-1">\' + _t("Info") + \'</strong>\' + msg);\n-      clearTimeout(that.messageTimeout);\n-      $message.fadeTo(500, 1);\n-      that.messageTimeout = window.setTimeout(function(){\n-        $message.fadeTo(500, 0.6);\n-      }, 3000);\n-    },\n-    showEditPortlet: function(url){\n-      log.info(\'show edit portlet in modal\');\n-      var that = this;\n-      var $a = $(\'<a/>\');\n-      $(\'body\').append($a);\n-      var pattern = new Modal($a, {\n-        ajaxUrl: url,\n-        actionOptions: {\n-          displayInModal: false,\n-          reloadWindowOnClose: false,\n-          isForm: true,\n-          onSuccess: function(modal, html){\n-            pattern.hide();\n-            var $body = $(utils.parseBodyTag(html));\n-            that.rebind($(\'#\' + that.$el.attr(\'id\'), $body).eq(0));\n-            that.statusMessage(_t(\'Portlet added\'));\n-          }\n-        }\n-      });\n-      pattern.on(\'after-render\', function(){\n-        var $el = $(\'#\' + that.$el.attr(\'id\'), pattern.$raw);\n-        /* this is a check that the add form doesn\'t just automatically\n-           create the portlet without an actual form.\n-           If element is found here, we can short circuit and\n-           continue on. */\n-        if($el.length === 1){\n-          /* hacky, trying to prevent modal parts from flickering here */\n-          $el = $el.clone();\n-          pattern.on(\'shown\', function(){\n-            pattern.hide();\n-          });\n-          that.rebind($el);\n-          that.statusMessage(_t(\'Portlet added\'));\n-        }\n-      });\n-      pattern.show();\n-    },\n-    setupPortletEdit: function(){\n-      var that = this;\n-      $(\'.managedPortlet .portletHeader > a\', that.$el).click(function(e){\n-        e.preventDefault();\n-        that.showEditPortlet($(this).attr(\'href\'));\n-      });\n-    },\n-    setupAddDropdown: function(){\n-      var that = this;\n-      $(\'.add-portlet\', that.$el).change(function(e){\n-        e.preventDefault();\n-        var $select = $(this);\n-        var $form = $select.parents(\'form\');\n-        var contextUrl = $select.attr(\'data-context-url\');\n-        var url = contextUrl + $select.val() +\n-          \'?_authenticator=\' + $(\'[name="_authenticator"]\').val() +\n-          \'&referer=\' + $(\'[name="referer"]\', $form).val();\n-        that.showEditPortlet(url);\n-      });\n-    },\n-    setupSavePortletsSettings: function(){\n-      var that = this;\n-      $(\'.portlets-settings, form.portlet-action\', that.$el).ajaxForm({\n-        beforeSubmit: function(){\n-          that.loading.show();\n-        },\n-        success: function(html){\n-          that.loading.hide();\n-          log.info(\'form submit\');\n-          var $body = $(utils.parseBodyTag(html));\n-          that.rebind($(\'#\' + that.$el.attr(\'id\'), $body).eq(0));\n-        }\n-      });\n-      // Block/unblock inherited portlets (parent, group and content type portlets)\n-      $(\'.portlets-settings select\', that.$el).change(function(){\n-        log.info(\'select change\');\n-        clearTimeout(that.submitTimeout);\n-        that.submitTimeout = window.setTimeout(function(){\n-          $(\'.portlets-settings\', that.$el).submit();\n-        }, 100);\n-      });\n-    },\n-    setupSwitchPortletManager: function(){\n-      var that = this;\n-      $(\'#main-container\').on(\'change\', \'.switch-portlet-manager\', function(e){\n-        e.stopImmediatePropagation();\n-        log.info(\'switch portlet manager\');\n-        var url_ = $(this).val();\n-        clearTimeout(that.switchTimeout);\n-        that.switchTimeout = window.setTimeout(function() {\n-          that._reloadPortletManager(url_);\n-        }, 100);\n-      });\n-      // Handle back/forward browser buttons\n-      $(window).on(\'popstate\', function(e) {\n-        e.stopImmediatePropagation();\n-        if (e && e.state === undefined) {\n-          var url_ = window.location.href;\n-          log.info("redirecting to: " + url_);\n-          that._reloadPortletManager(url_, true);\n-        }\n-      });\n-    },\n-    _reloadPortletManager: function(url_, is_popstate){\n-      var that = this;\n-      that.loading.show();\n-      $.get(url_, {ajax_load: 1}).done(function(html) {\n-        var $html = $(utils.parseBodyTag(html));\n-        var $content = (\'#content\', $html);\n-        $(\'#content\').html($content);\n-        that.rebind($(\'.pat-manage-portlets\', $content), true);\n-        if (!is_popstate) {\n-          window.history.pushState(null, null, url_);\n-        } else {\n-          window.history.replaceState(null, null, url_);\n-        }\n-        that.loading.hide();\n-      });\n-    }\n-  });\n-\n-  return ManagePortlets;\n-});\ndiff --git a/plone/app/portlets/browser/manage.py b/plone/app/portlets/browser/manage.py\nindex 916bf7b0..0face36a 100644\n--- a/plone/app/portlets/browser/manage.py\n+++ b/plone/app/portlets/browser/manage.py\n@@ -1,17 +1,17 @@\n+from ..interfaces import IPortletPermissionChecker\n+from ..interfaces import ITopbarManagePortlets\n+from ..storage import GroupDashboardPortletAssignmentMapping\n+from ..storage import PortletAssignmentMapping\n+from ..storage import UserPortletAssignmentMapping\n+from .interfaces import IManageContentTypePortletsView\n+from .interfaces import IManageContextualPortletsView\n+from .interfaces import IManageDashboardPortletsView\n+from .interfaces import IManageGroupPortletsView\n+from .interfaces import IManagePortletsView\n from AccessControl import Unauthorized\n from Acquisition import aq_base\n from Acquisition import aq_inner\n from plone.app.portlets import utils\n-from plone.app.portlets.browser.interfaces import IManageContentTypePortletsView\n-from plone.app.portlets.browser.interfaces import IManageContextualPortletsView\n-from plone.app.portlets.browser.interfaces import IManageDashboardPortletsView\n-from plone.app.portlets.browser.interfaces import IManageGroupPortletsView\n-from plone.app.portlets.browser.interfaces import IManagePortletsView\n-from plone.app.portlets.interfaces import IPortletPermissionChecker\n-from plone.app.portlets.interfaces import ITopbarManagePortlets\n-from plone.app.portlets.storage import GroupDashboardPortletAssignmentMapping\n-from plone.app.portlets.storage import PortletAssignmentMapping\n-from plone.app.portlets.storage import UserPortletAssignmentMapping\n from plone.memoize.view import memoize\n from plone.portlets.constants import CONTENT_TYPE_CATEGORY\n from plone.portlets.constants import CONTEXT_CATEGORY\ndiff --git a/plone/app/portlets/browser/templates/footer.pt b/plone/app/portlets/browser/templates/footer.pt\nnew file mode 100644\nindex 00000000..df16ba9d\n--- /dev/null\n+++ b/plone/app/portlets/browser/templates/footer.pt\n@@ -0,0 +1,5 @@\n+<div class="row">\n+\t<div class="col-xs-12">\n+\t\t<div tal:on-error="nothing" tal:replace="structure view/render_footer_portlets" />\n+\t</div>\n+</div>\ndiff --git a/plone/app/portlets/browser/templates/manage-contextual.pt b/plone/app/portlets/browser/templates/manage-contextual.pt\nindex 8674ef90..1cf4829f 100644\n--- a/plone/app/portlets/browser/templates/manage-contextual.pt\n+++ b/plone/app/portlets/browser/templates/manage-contextual.pt\n@@ -14,8 +14,10 @@\n         Manage portlets for\n         <q i18n:name="context_title" tal:content="context/Title">title</q>\n     </h1>\n+    \n+    \n     <a href=""\n-        class="link-parent"\n+        class="link-parent d-inline-block mb-3"\n         tal:attributes="href string:${context/absolute_url}"\n         i18n:translate="return_to_view">\n       Return\n@@ -23,13 +25,13 @@\n \n     <tal:block tal:define="is_portal_root context/@@plone_context_state/is_portal_root;"\n             tal:condition="not:is_portal_root">\n-    -\n-    <a class="link-parent" tal:condition="plone_view/getParentObject|nothing"\n+    <a class="link-parent mb-3 ms-3" tal:condition="plone_view/getParentObject|nothing"\n     tal:attributes="href python:plone_view.getParentObject().absolute_url()+\'/@@manage-portlets\'"\n     i18n:translate="">\n     Go to parent folder\n     </a>\n     </tal:block>\n+    \n \n     <div class="alert alert-info"\n         role="status"\ndiff --git a/plone/app/portlets/browser/templates/manage-group-dashboard.pt b/plone/app/portlets/browser/templates/manage-group-dashboard.pt\nindex f8a5b791..e99baf91 100644\n--- a/plone/app/portlets/browser/templates/manage-group-dashboard.pt\n+++ b/plone/app/portlets/browser/templates/manage-group-dashboard.pt\n@@ -17,7 +17,7 @@\n <metal:b fill-slot="prefs_configlet_main">\n \n     <header>\n-      <h1 class="documentFirstHeading">Group: ${view/group}</h1>\n+      <h1 class="documentFirstHeading" i18n:translate="">Group: <span i18n:name="groupname" tal:content="view/group" tal:omit-tag=""/></h1>\n     </header>\n \n     <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n@@ -25,7 +25,7 @@\n     </div>\n \n     <div id="content-core" tal:define="token context/@@authenticator/token">\n-      <div class="autotabs">        \n+      <div class="autotabs">\n         <nav class="autotoc-nav nav nav-tabs mb-3">\n           <a class="nav-link" href="${portal_url}/@@usergroup-groupmembership?groupname=${request/key}"\n              i18n:translate="label_group_members">Group Members</a>\n@@ -33,7 +33,7 @@\n              i18n:translate="label_group_properties">Group Properties</a>\n           <a class="nav-link" href="${portal_url}/@@manage-group-portlets?key=${request/key}&_authenticator=${token}"\n              i18n:translate="label_group_portlets">Group Portlets</a>\n-          <a class="active nav-link" \n+          <a class="active nav-link"\n              href="${portal_url}/@@manage-group-dashboard?key=${request/key}&_authenticator=${token}"\n              i18n:translate="label_group_dashboard">Group Dashboard</a>\n         </nav>\ndiff --git a/plone/app/portlets/browser/templates/manage-group.pt b/plone/app/portlets/browser/templates/manage-group.pt\nindex 6abad3f9..5d5c7c3c 100644\n--- a/plone/app/portlets/browser/templates/manage-group.pt\n+++ b/plone/app/portlets/browser/templates/manage-group.pt\n@@ -21,13 +21,13 @@\n     Up to Groups Overview\n   </a>\n \n-  <h1 class="documentFirstHeading">Group: ${view/group}</h1>\n+  <h1 class="documentFirstHeading" i18n:translate="">Group: <span i18n:name="groupname" tal:content="view/group" tal:omit-tag=""/></h1>\n </metal:b>\n \n <metal:b fill-slot="content-core">\n   <metal:b metal:define-macro="props" tal:omit-tag="">\n \n-    <div class="autotabs" tal:define="token context/@@authenticator/token">        \n+    <div class="autotabs" tal:define="token context/@@authenticator/token">\n       <nav class="autotoc-nav">\n         <a href="${portal_url}/@@usergroup-groupmembership?groupname=${request/key}"\n            i18n:translate="label_group_members">Group Members</a>\ndiff --git a/plone/app/portlets/browser/templates/manage_portlets_fallback.pt b/plone/app/portlets/browser/templates/manage_portlets_fallback.pt\nnew file mode 100644\nindex 00000000..ec5592d9\n--- /dev/null\n+++ b/plone/app/portlets/browser/templates/manage_portlets_fallback.pt\n@@ -0,0 +1,14 @@\n+<div tal:condition="view/available" class="row managePortlets-row">\n+\t<tal:comment tal:condition="nothing">\n+\t\t**********\n+\t\tNEEDED COL\n+\t\t**********\n+\t</tal:comment>\n+    <a class="managePortletsFallback"\n+        tal:attributes="href string:${view/object_url}/@@manage-portlets"\n+        i18n:domain="plone"\n+        i18n:translate="manage_portlets_link">\n+        Manage portlets\n+    </a>\n+\n+</div>\n\\ No newline at end of file\ndiff --git a/plone/app/portlets/browser/templates/topbar-manage-portlets.pt b/plone/app/portlets/browser/templates/topbar-manage-portlets.pt\nindex f638b68e..11d9aaa0 100644\n--- a/plone/app/portlets/browser/templates/topbar-manage-portlets.pt\n+++ b/plone/app/portlets/browser/templates/topbar-manage-portlets.pt\n@@ -34,17 +34,17 @@\n         Manage portlets for\n         <q i18n:name="context_title" tal:content="context/Title">title</q>\n       </h1>\n-\n-      <a class="link-parent"\n+      \n+      <a class="link-parent d-inline-block mb-3"\n           tal:attributes="href context/absolute_url"\n           i18n:translate="return_to_view">\n         Return\n-      </a>\n+      </a>      \n \n       <div class="alert alert-info"\n           role="status"\n           tal:condition="plone_view/isDefaultPageInFolder|nothing">\n-        <strong>\n+        <strong i18n:translate="">\n             Info\n         </strong>\n         <div i18n:translate="label_manage_portlets_default_view_container">\ndiff --git a/plone/app/portlets/browser/traversal.py b/plone/app/portlets/browser/traversal.py\nindex 8a50bb28..310b3b8f 100644\n--- a/plone/app/portlets/browser/traversal.py\n+++ b/plone/app/portlets/browser/traversal.py\n@@ -1,6 +1,6 @@\n-from plone.app.portlets.storage import GroupDashboardPortletAssignmentMapping\n-from plone.app.portlets.storage import PortletAssignmentMapping\n-from plone.app.portlets.storage import UserPortletAssignmentMapping\n+from ..storage import GroupDashboardPortletAssignmentMapping\n+from ..storage import PortletAssignmentMapping\n+from ..storage import UserPortletAssignmentMapping\n from plone.portlets.constants import CONTENT_TYPE_CATEGORY\n from plone.portlets.constants import GROUP_CATEGORY\n from plone.portlets.constants import USER_CATEGORY\ndiff --git a/plone/app/portlets/browser/utils.py b/plone/app/portlets/browser/utils.py\nindex c86749f8..d4a32dbd 100644\n--- a/plone/app/portlets/browser/utils.py\n+++ b/plone/app/portlets/browser/utils.py\n@@ -1,5 +1,5 @@\n-from plone.app.portlets.interfaces import IDeferredPortletRenderer\n-from plone.app.portlets.utils import assignment_from_key\n+from ..interfaces import IDeferredPortletRenderer\n+from ..utils import assignment_from_key\n from plone.portlets.interfaces import IPortletManager\n from plone.portlets.interfaces import IPortletRenderer\n from plone.portlets.utils import unhashPortletInfo\ndiff --git a/plone/app/portlets/browser/viewlets.py b/plone/app/portlets/browser/viewlets.py\nnew file mode 100644\nindex 00000000..6a365f00\n--- /dev/null\n+++ b/plone/app/portlets/browser/viewlets.py\n@@ -0,0 +1,68 @@\n+from zope.component import getMultiAdapter\n+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n+from plone.app.layout.viewlets.common import ViewletBase\n+from AccessControl import getSecurityManager\n+from datetime import date\n+\n+\n+class ManagePortletsFallbackViewlet(ViewletBase):\n+    """Manage portlets fallback link that sits below content"""\n+\n+    index = ViewPageTemplateFile("templates/manage_portlets_fallback.pt")\n+\n+    def update(self):\n+        plonelayout = getMultiAdapter(\n+            (self.context, self.request), name=u"plone_layout"\n+        )\n+        context_state = getMultiAdapter(\n+            (self.context, self.request), name=u"plone_context_state"\n+        )\n+\n+        self.portlet_assignable = context_state.portlet_assignable()\n+        self.sl = plonelayout.have_portlets("plone.leftcolumn", self.context)\n+        self.sr = plonelayout.have_portlets("plone.rightcolumn", self.context)\n+        self.object_url = context_state.object_url()\n+\n+    def available(self):\n+        secman = getSecurityManager()\n+        has_manage_portlets_permission = secman.checkPermission(\n+            "Portlets: Manage portlets", self.context\n+        )\n+        if not has_manage_portlets_permission:\n+            return False\n+        return bool(not self.sl and not self.sr and self.portlet_assignable)\n+\n+class FooterViewlet(ViewletBase):\n+    index = ViewPageTemplateFile("templates/footer.pt")\n+\n+    def update(self):\n+        super(FooterViewlet, self).update()\n+        self.year = date.today().year\n+\n+    def render_footer_portlets(self):\n+        """\n+        You might ask, why is this necessary. Well, let me tell you a story...\n+\n+        plone.app.portlets, in order to provide @@manage-portlets on a context,\n+        overrides the IPortletRenderer for the IManageContextualPortletsView\n+        view.\n+        See plone.portlets and plone.app.portlets\n+\n+        Seems fine right? Well, most of the time it is. Except, here.\n+        Previously, we were just using the syntax like\n+        `provider:plone.footerportlets` to render the footer portlets.\n+        Since this tal expression was inside a viewlet,\n+        the view is no longer IManageContextualPortletsView when\n+        visiting @@manage-portlets. Instead, it was IViewlet.\n+        See zope.contentprovider\n+\n+        In to fix this short coming, we render the portlet column by\n+        manually doing the multi adapter lookup and then manually\n+        doing the rendering for the content provider.\n+        See zope.contentprovider\n+        """\n+        portlet_manager = getMultiAdapter(\n+            (self.context, self.request, self.__parent__), name="plone.footerportlets"\n+        )\n+        portlet_manager.update()\n+        return portlet_manager.render()\ndiff --git a/plone/app/portlets/checker.py b/plone/app/portlets/checker.py\nindex 274deeef..079a7055 100644\n--- a/plone/app/portlets/checker.py\n+++ b/plone/app/portlets/checker.py\n@@ -1,9 +1,9 @@\n+from .interfaces import IGroupDashboardPortletAssignmentMapping\n+from .interfaces import IPortletPermissionChecker\n+from .interfaces import IUserPortletAssignmentMapping\n from AccessControl import getSecurityManager\n from AccessControl import Unauthorized\n from Acquisition import aq_inner\n-from plone.app.portlets.interfaces import IGroupDashboardPortletAssignmentMapping\n-from plone.app.portlets.interfaces import IPortletPermissionChecker\n-from plone.app.portlets.interfaces import IUserPortletAssignmentMapping\n from plone.portlets.interfaces import IPortletAssignmentMapping\n from zope.component import adapter\n from zope.interface import implementer\ndiff --git a/plone/app/portlets/configure.zcml b/plone/app/portlets/configure.zcml\nindex 5a153bce..b4b59569 100644\n--- a/plone/app/portlets/configure.zcml\n+++ b/plone/app/portlets/configure.zcml\n@@ -12,6 +12,7 @@\n     <include file="permissions.zcml" />\n \n     <include package=".browser" />\n+    <include package=".dashboard" />\n     <include package=".exportimport" />\n     <include package=".portlets" />\n \ndiff --git a/plone/app/portlets/dashboard.py b/plone/app/portlets/dashboard/__init__.py\nsimilarity index 91%\nrename from plone/app/portlets/dashboard.py\nrename to plone/app/portlets/dashboard/__init__.py\nindex cf1cce8e..38c106b7 100644\n--- a/plone/app/portlets/dashboard.py\n+++ b/plone/app/portlets/dashboard/__init__.py\n@@ -1,6 +1,6 @@\n-from plone.app.portlets import portlets\n-from plone.app.portlets.interfaces import IDefaultDashboard\n-from plone.app.portlets.storage import UserPortletAssignmentMapping\n+from .. import portlets\n+from ..interfaces import IDefaultDashboard\n+from ..storage import UserPortletAssignmentMapping\n from plone.portlets.constants import USER_CATEGORY\n from plone.portlets.interfaces import IPortletManager\n from Products.PluggableAuthService.interfaces.authservice import IPropertiedUser\ndiff --git a/plone/app/portlets/dashboard/configure.zcml b/plone/app/portlets/dashboard/configure.zcml\nnew file mode 100644\nindex 00000000..c206737c\n--- /dev/null\n+++ b/plone/app/portlets/dashboard/configure.zcml\n@@ -0,0 +1,22 @@\n+<configure\n+    xmlns="http://namespaces.zope.org/zope"\n+    xmlns:browser="http://namespaces.zope.org/browser">\n+\n+    <browser:page\n+        for="plone.app.layout.navigation.interfaces.INavigationRoot"\n+        name="dashboard"\n+        permission="plone.app.portlets.ViewDashboard"\n+        class=".dashboard.DashboardView"\n+        template="dashboard.pt"\n+        />\n+\n+    <!-- this view provides a not-js fallback for the user dropdown menu.\n+    It has been placed here to be near the personal bar code -->\n+    <browser:page\n+        for="plone.app.layout.navigation.interfaces.INavigationRoot"\n+        name="useractions"\n+        permission="zope2.View"\n+        class=".user_actions.UserActionsView"\n+        template="user_actions.pt"\n+        />\n+</configure>\ndiff --git a/plone/app/portlets/dashboard/dashboard.pt b/plone/app/portlets/dashboard/dashboard.pt\nnew file mode 100644\nindex 00000000..71de849a\n--- /dev/null\n+++ b/plone/app/portlets/dashboard/dashboard.pt\n@@ -0,0 +1,70 @@\n+<html\n+    xmlns="http://www.w3.org/1999/xhtml"\n+    xml:lang="en"\n+    xmlns:tal="http://xml.zope.org/namespaces/tal"\n+    xmlns:metal="http://xml.zope.org/namespaces/metal"\n+    xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+    lang="en"\n+    metal:use-macro="context/main_template/macros/master"\n+    i18n:domain="plone">\n+\n+  <body>\n+\n+    <metal:b fill-slot="content-title">\n+      <h1\n+          class="documentFirstHeading"\n+          i18n:translate="heading_dashboard"\n+          tal:define="memberinfo context/portal_membership/getMemberInfo;\n+                  member context/@@plone_portal_state/member;\n+                  name python:memberinfo[\'fullname\'] or member.getId() or member.getId()">\n+        <span\n+            tal:replace="name"\n+            i18n:name="user_name" />\n+        &#8217;s dashboard\n+      </h1>\n+    </metal:b>\n+\n+    <metal:b fill-slot="content-core">\n+      <tal:b metal:define-macro="content-core">\n+\n+        <div class="autotabs">\n+          <nav class="autotoc-nav nav nav-tabs mb-3">\n+            <span class="nav-item">\n+              <a\n+                  class="active nav-link"\n+                  href="${context/@@plone_portal_state/navigation_root_url}/dashboard"\n+                  i18n:translate="label_dashboard">Dashboard</a>\n+            </span>\n+            <span class="nav-item">\n+              <a\n+                  href="${context/@@plone_portal_state/navigation_root_url}/@@manage-dashboard?_authenticator=${view/auth_token}"\n+                  class="nav-link"\n+                  i18n:translate="label_edit">Edit</a>\n+            </span>\n+          </nav>\n+\n+\n+          <div\n+              id="dashboard"\n+              class="row row-cols-1 row-cols-md-2 gy-2">\n+            <div\n+                id="dashboard-portlets1"\n+                tal:content="structure provider:plone.dashboard1" />\n+            <div\n+                id="dashboard-portlets2"\n+                tal:content="structure provider:plone.dashboard2" />\n+            <div\n+                id="dashboard-portlets3"\n+                tal:content="structure provider:plone.dashboard3" />\n+            <div\n+                id="dashboard-portlets4"\n+                tal:content="structure provider:plone.dashboard4" />\n+          </div>\n+\n+        </div>\n+\n+      </tal:b>\n+    </metal:b>\n+\n+  </body>\n+</html>\ndiff --git a/plone/app/portlets/dashboard/dashboard.py b/plone/app/portlets/dashboard/dashboard.py\nnew file mode 100644\nindex 00000000..abc42837\n--- /dev/null\n+++ b/plone/app/portlets/dashboard/dashboard.py\n@@ -0,0 +1,72 @@\n+# -*- coding: utf-8 -*-\n+from AccessControl import getSecurityManager\n+from plone.memoize.instance import memoize\n+from plone.portlets.constants import GROUP_CATEGORY\n+from plone.portlets.constants import USER_CATEGORY\n+from plone.portlets.interfaces import IPortletManager\n+from plone.protect.authenticator import createToken\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.Five.browser import BrowserView\n+from Products.statusmessages.interfaces import IStatusMessage\n+from zope.component import getUtility\n+from zope.interface import implementer\n+from zope.interface import Interface\n+\n+\n+class IDashboard(Interface):\n+    """the dashboard display columns of portlet to the loggedin user"""\n+\n+\n+@implementer(IDashboard)\n+class DashboardView(BrowserView):\n+    """Power the dashboard"""\n+\n+    def __call__(self):\n+        self.request.set("disable_border", 1)\n+        self.request.set("disable_plone.leftcolumn", 1)\n+        self.request.set("disable_plone.rightcolumn", 1)\n+        if self.can_edit() and self.empty():\n+            message = _(\n+                u"info_empty_dashboard",\n+                default=u"Your dashboard is currently empty. Click the"\n+                " <em>edit</em> tab to assign some personal"\n+                " portlets.",\n+            )\n+            IStatusMessage(self.request).add(message)\n+        return self.index()\n+\n+    @property\n+    def auth_token(self):\n+        return createToken()\n+\n+    @memoize\n+    def can_edit(self):\n+        return bool(\n+            getSecurityManager().checkPermission(\n+                "Portlets: Manage own portlets", self.context\n+            )\n+        )\n+\n+    @memoize\n+    def empty(self):\n+        dashboards = [\n+            getUtility(IPortletManager, name=name)\n+            for name in [\n+                "plone.dashboard1",\n+                "plone.dashboard2",\n+                "plone.dashboard3",\n+                "plone.dashboard4",\n+            ]\n+        ]\n+\n+        portal_membership = getToolByName(self.context, "portal_membership")\n+        member = portal_membership.getAuthenticatedMember()\n+        userid = member.getId()\n+\n+        num_portlets = 0\n+        for dashboard in dashboards:\n+            num_portlets += len(dashboard.get(USER_CATEGORY, {}).get(userid, {}))\n+            for groupid in member.getGroups():\n+                num_portlets += len(dashboard.get(GROUP_CATEGORY, {}).get(groupid, {}))\n+        return num_portlets == 0\ndiff --git a/plone/app/portlets/dashboard/user_actions.pt b/plone/app/portlets/dashboard/user_actions.pt\nnew file mode 100644\nindex 00000000..ce532f1f\n--- /dev/null\n+++ b/plone/app/portlets/dashboard/user_actions.pt\n@@ -0,0 +1,35 @@\n+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      lang="en"\n+      metal:use-macro="context/main_template/macros/master"\n+      i18n:domain="plone">\n+\n+<head>\n+    <metal:block fill-slot="top_slot"\n+                 tal:define="dummy python:request.set(\'disable_border\',1);\n+                             disable_column_one python:request.set(\'disable_plone.leftcolumn\',1);\n+                             disable_column_two python:request.set(\'disable_plone.rightcolumn\',1);" />\n+</head>\n+\n+<body>\n+\n+<metal:main fill-slot="main">\n+<h1 i18n:translate="" class="documentFirstHeading">User Actions</h1>\n+<ul id="user-actions">\n+    <li tal:repeat="action view/user_actions">\n+        <a href=""\n+           tal:attributes="href action/url;\n+                           target action/link_target|nothing;\n+                           id string:personaltoolspage-${action/id};"\n+           tal:content="action/title"\n+           i18n:translate="">\n+            action title\n+        </a>\n+    </li>\n+</ul>\n+</metal:main>\n+\n+</body>\n+</html>\ndiff --git a/plone/app/portlets/dashboard/user_actions.py b/plone/app/portlets/dashboard/user_actions.py\nnew file mode 100644\nindex 00000000..64e10f96\n--- /dev/null\n+++ b/plone/app/portlets/dashboard/user_actions.py\n@@ -0,0 +1,15 @@\n+# -*- coding: utf-8 -*-\n+from Products.Five.browser import BrowserView\n+from zope.component import getMultiAdapter\n+\n+\n+class UserActionsView(BrowserView):\n+    """Power the useraction fallback page"""\n+\n+    def user_actions(self):\n+        context_state = getMultiAdapter(\n+            (self.context, self.request), name=u"plone_context_state"\n+        )\n+\n+        actions = context_state.actions("user")\n+        return actions\ndiff --git a/plone/app/portlets/exportimport/__init__.py b/plone/app/portlets/exportimport/__init__.py\nindex 792d6005..e69de29b 100644\n--- a/plone/app/portlets/exportimport/__init__.py\n+++ b/plone/app/portlets/exportimport/__init__.py\n@@ -1 +0,0 @@\n-#\ndiff --git a/plone/app/portlets/exportimport/portlets.py b/plone/app/portlets/exportimport/portlets.py\nindex f0e30a51..6c404fac 100644\n--- a/plone/app/portlets/exportimport/portlets.py\n+++ b/plone/app/portlets/exportimport/portlets.py\n@@ -76,13 +76,11 @@\n \n """\n \n+from ..interfaces import IDefaultPortletManager\n+from ..interfaces import IPortletTypeInterface\n+from ..utils import assignment_mapping_from_key\n+from .interfaces import IPortletAssignmentExportImportHandler\n from operator import attrgetter\n-from plone.app.portlets.exportimport.interfaces import (\n-    IPortletAssignmentExportImportHandler,\n-)\n-from plone.app.portlets.interfaces import IDefaultPortletManager\n-from plone.app.portlets.interfaces import IPortletTypeInterface\n-from plone.app.portlets.utils import assignment_mapping_from_key\n from plone.portlets.constants import CONTENT_TYPE_CATEGORY\n from plone.portlets.constants import CONTEXT_CATEGORY\n from plone.portlets.constants import GROUP_CATEGORY\ndiff --git a/plone/app/portlets/manager.py b/plone/app/portlets/manager.py\nindex e7f3e943..90743b7d 100644\n--- a/plone/app/portlets/manager.py\n+++ b/plone/app/portlets/manager.py\n@@ -1,8 +1,8 @@\n+from .interfaces import IColumn\n+from .interfaces import IDashboard\n from Acquisition import aq_acquire\n from Acquisition import aq_inner\n from Acquisition import Explicit\n-from plone.app.portlets.interfaces import IColumn\n-from plone.app.portlets.interfaces import IDashboard\n from plone.portlets.interfaces import IPortletRenderer\n from plone.portlets.manager import PortletManagerRenderer as BasePortletManagerRenderer\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\ndiff --git a/plone/app/portlets/metaconfigure.py b/plone/app/portlets/metaconfigure.py\nindex 2296c7cb..2dff5aae 100644\n--- a/plone/app/portlets/metaconfigure.py\n+++ b/plone/app/portlets/metaconfigure.py\n@@ -1,5 +1,5 @@\n-from plone.app.portlets.browser.interfaces import IPortletAdding\n-from plone.app.portlets.interfaces import IPortletTypeInterface\n+from .browser.interfaces import IPortletAdding\n+from .interfaces import IPortletTypeInterface\n from plone.portlets.interfaces import IPortletManager\n from plone.portlets.interfaces import IPortletRenderer\n from Products.Five.browser.metaconfigure import page\ndiff --git a/plone/app/portlets/metadirectives.py b/plone/app/portlets/metadirectives.py\nindex 051bd9a2..c00664cb 100644\n--- a/plone/app/portlets/metadirectives.py\n+++ b/plone/app/portlets/metadirectives.py\n@@ -1,4 +1,4 @@\n-from plone.app.portlets import PloneMessageFactory as _\n+from . import PloneMessageFactory as _\n from plone.portlets.interfaces import IPortletManager\n from zope import schema\n from zope.configuration import fields as configuration_fields\ndiff --git a/plone/app/portlets/portlets/__init__.py b/plone/app/portlets/portlets/__init__.py\nindex 792d6005..e69de29b 100644\n--- a/plone/app/portlets/portlets/__init__.py\n+++ b/plone/app/portlets/portlets/__init__.py\n@@ -1 +0,0 @@\n-#\ndiff --git a/plone/app/portlets/portlets/actions.py b/plone/app/portlets/portlets/actions.py\nindex afb24374..7e8d3c14 100644\n--- a/plone/app/portlets/portlets/actions.py\n+++ b/plone/app/portlets/portlets/actions.py\n@@ -1,6 +1,6 @@\n+from .. import PloneMessageFactory as _\n+from ..portlets import base\n from Acquisition import aq_inner\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.portlets import base\n from plone.i18n.normalizer.interfaces import IIDNormalizer\n from plone.memoize import view as pm_view\n from plone.portlets.interfaces import IPortletDataProvider\ndiff --git a/plone/app/portlets/portlets/base.py b/plone/app/portlets/portlets/base.py\nindex 05840a15..cfe507cb 100644\n--- a/plone/app/portlets/portlets/base.py\n+++ b/plone/app/portlets/portlets/base.py\n@@ -1,9 +1,7 @@\n+from ..browser.formhelper import AddForm\n+from ..browser.formhelper import EditForm\n+from ..browser.formhelper import NullAddForm\n from OFS.SimpleItem import SimpleItem\n-\n-# Convenience imports\n-from plone.app.portlets.browser.formhelper import AddForm\n-from plone.app.portlets.browser.formhelper import EditForm\n-from plone.app.portlets.browser.formhelper import NullAddForm\n from plone.app.portlets.interfaces import IDeferredPortletRenderer\n from plone.portlets.interfaces import IPortletAssignment\n from plone.portlets.interfaces import IPortletRenderer\ndiff --git a/plone/app/portlets/portlets/classic.py b/plone/app/portlets/portlets/classic.py\nindex 6d9e45c3..9a1b1ea2 100644\n--- a/plone/app/portlets/portlets/classic.py\n+++ b/plone/app/portlets/portlets/classic.py\n@@ -1,5 +1,5 @@\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.portlets import base\n+from .. import PloneMessageFactory as _\n+from ..portlets import base\n from plone.portlets.interfaces import IPortletDataProvider\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from zope import schema\ndiff --git a/plone/app/portlets/portlets/language.py b/plone/app/portlets/portlets/language.py\nindex 368a3c03..23906b7d 100644\n--- a/plone/app/portlets/portlets/language.py\n+++ b/plone/app/portlets/portlets/language.py\n@@ -1,6 +1,6 @@\n from plone.app.i18n.locales.browser.selector import LanguageSelector\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.portlets import base\n+from .. import PloneMessageFactory as _\n+from ..portlets import base\n from plone.portlets.interfaces import IPortletDataProvider\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from zope.component import getMultiAdapter\ndiff --git a/plone/app/portlets/portlets/login.py b/plone/app/portlets/portlets/login.py\nindex 9314e23a..3f6cc1ac 100644\n--- a/plone/app/portlets/portlets/login.py\n+++ b/plone/app/portlets/portlets/login.py\n@@ -1,5 +1,5 @@\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.portlets import base\n+from .. import PloneMessageFactory as _\n+from ..portlets import base\n from plone.memoize.instance import memoize\n from plone.portlets.interfaces import IPortletDataProvider\n from Products.CMFCore.utils import getToolByName\ndiff --git a/plone/app/portlets/portlets/navigation.py b/plone/app/portlets/portlets/navigation.py\nindex a32b7ce7..4d5c4f4c 100644\n--- a/plone/app/portlets/portlets/navigation.py\n+++ b/plone/app/portlets/portlets/navigation.py\n@@ -1,3 +1,5 @@\n+from .. import PloneMessageFactory as _\n+from ..portlets import base\n from Acquisition import aq_base\n from Acquisition import aq_inner\n from Acquisition import aq_parent\n@@ -8,8 +10,6 @@\n from plone.app.layout.navigation.navtree import buildFolderTree\n from plone.app.layout.navigation.root import getNavigationRoot\n from plone.app.layout.navigation.root import getNavigationRootObject\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.portlets import base\n from plone.app.uuid.utils import uuidToObject\n from plone.app.vocabularies.catalog import CatalogSource\n from plone.i18n.normalizer.interfaces import IIDNormalizer\n@@ -369,22 +369,6 @@ def thumb_scale(self):\n         thumb_scale_portlet = settings.thumb_scale_portlet\n         return thumb_scale_portlet\n \n-    def getMimeTypeIcon(self, node):\n-        try:\n-            if not node["normalized_portal_type"] == "file":\n-                return None\n-            fileo = node["item"].getObject().file\n-            portal_url = getNavigationRoot(self.context)\n-            mtt = getToolByName(self.context, "mimetypes_registry")\n-            if fileo.contentType:\n-                ctype = mtt.lookup(fileo.contentType)\n-                if not ctype:\n-                    return None\n-                return os.path.join(portal_url, guess_icon_path(ctype[0]))\n-        except AttributeError:\n-            return None\n-        return None\n-\n     def update(self):\n         pass\n \ndiff --git a/plone/app/portlets/portlets/navigation_recurse.pt b/plone/app/portlets/portlets/navigation_recurse.pt\nindex 1f3dd0bc..8b6a9d28 100644\n--- a/plone/app/portlets/portlets/navigation_recurse.pt\n+++ b/plone/app/portlets/portlets/navigation_recurse.pt\n@@ -3,7 +3,9 @@\n                     bottomLevel options/bottomLevel | nothing;\n                     supress_icon    view/data/no_icons;\n                     supress_thumb   view/data/no_thumbs;\n-                    thumb_scale view/thumb_scale"\n+                    thumb_scale view/thumb_scale;\n+                    icons nocall:context/@@iconresolver;\n+                    normalizeString nocall: context/plone_utils/normalizeString;"\n             i18n:domain="plone">\n \n <metal:main define-macro="nav_main"\n@@ -22,8 +24,7 @@\n                 is_in_path      node/currentParent;\n                 li_class        python:\' navTreeCurrentNode\' if is_current else \'\';\n                 li_extr_class   python:\' navTreeItemInPath\' if is_in_path else \'\';\n-                li_folder_class python:\' navTreeFolderish\' if show_children else \'\';\n-                normalizeString nocall: context/plone_utils/normalizeString;"\n+                li_folder_class python:\' navTreeFolderish\' if show_children else \'\';"\n     tal:condition="python:bottomLevel &lt;= 0 or level &lt;= bottomLevel"\n     tal:attributes="class string:navTreeItem visualNoMarker${li_class}${li_extr_class}${li_folder_class} section-${node/normalized_id}">\n \n@@ -35,9 +36,11 @@\n                            title node/Description;\n                            class string:${item_class}${li_class}${li_extr_class}${li_folder_class} ${item_type_class}">\n \n-             <img class="mime-icon" tal:condition="python:item_type ==\'File\' and not supress_icon"\n-                             tal:attributes="href node/getURL;\n-                                             src python:view.getMimeTypeIcon(node);">\n+            <tal:icon tal:condition="python: not supress_icon and item_type != \'File\'"\n+                      tal:replace="structure python:icons.tag(f\'contenttype/{normalizeString(item_type)}\')" />\n+\n+            <tal:icon tal:condition="python: not supress_icon and item_type == \'File\'"\n+                      tal:replace="structure python:icons.tag(f\'mimetype-{item.mime_type}\')" />\n \n             <img tal:condition="python:has_thumb and thumb_scale"\n                  tal:replace="structure python:image_scale.tag(item, \'image\', scale=thumb_scale, css_class=\'float-end thumb-\'+thumb_scale)">\ndiff --git a/plone/app/portlets/portlets/news.py b/plone/app/portlets/portlets/news.py\nindex ec3aabd2..0075ee9d 100644\n--- a/plone/app/portlets/portlets/news.py\n+++ b/plone/app/portlets/portlets/news.py\n@@ -1,8 +1,8 @@\n+from .. import PloneMessageFactory as _\n+from ..cache import render_cachekey\n+from ..portlets import base\n from Acquisition import aq_inner\n from plone.app.layout.navigation.root import getNavigationRootObject\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.cache import render_cachekey\n-from plone.app.portlets.portlets import base\n from plone.app.z3cform.widget import SelectFieldWidget\n from plone.autoform.directives import widget\n from plone.memoize import ram\ndiff --git a/plone/app/portlets/portlets/recent.pt b/plone/app/portlets/portlets/recent.pt\nindex e2f0214f..d7ce3ed1 100644\n--- a/plone/app/portlets/portlets/recent.pt\n+++ b/plone/app/portlets/portlets/recent.pt\n@@ -16,7 +16,8 @@\n                     image_scale portal/@@image_scale;\n                     supress_icon view/data/no_icons;\n                     supress_thumb view/data/no_thumbs;\n-                    thumb_scale view/thumb_scale">\n+                    thumb_scale view/thumb_scale;\n+                    icons nocall:context/@@iconresolver;">\n       <ul>\n         <tal:items\n             tal:define="plone_view context/@@plone;\n@@ -29,7 +30,12 @@\n                         item_wf_state_class python:\'state-\' + normalizeString(item_wf_state);\n                         item_class python:\'contenttype-\' + normalizeString(obj.portal_type) if not supress_icon else \'\';">\n           <a href="" tal:attributes="href string:${obj/getURL}/view; title obj/Description; class string:$item_wf_state_class tile $item_class">\n-            <img class="mime-icon" tal:condition="python:item_type ==\'File\' and not supress_icon" tal:attributes="href obj/getURL; src python:view.getMimeTypeIcon(obj);">\n+\n+            <tal:icon tal:condition="python: not supress_icon and item_type != \'File\'"\n+                      tal:replace="structure python:icons.tag(f\'contenttype/{normalizeString(item_type)}\')" />\n+            <tal:icon tal:condition="python: not supress_icon and item_type == \'File\'"\n+                      tal:replace="structure python:icons.tag(f\'mimetype-{obj.mime_type}\')" />\n+\n             <img tal:condition="python:obj.getIcon and thumb_scale and not supress_thumb and image_scale" tal:replace="structure python:image_scale.tag(obj, \'image\', scale=thumb_scale, css_class=\'float-end thumb-\'+thumb_scale)" />\n             <span tal:content="obj/pretty_title_or_id">Title</span>\n           </a>\ndiff --git a/plone/app/portlets/portlets/recent.py b/plone/app/portlets/portlets/recent.py\nindex f89e615a..6ee8eeb7 100644\n--- a/plone/app/portlets/portlets/recent.py\n+++ b/plone/app/portlets/portlets/recent.py\n@@ -1,8 +1,8 @@\n+from .. import PloneMessageFactory as _\n+from ..cache import render_cachekey\n+from ..portlets import base\n from Acquisition import aq_inner\n from plone.app.layout.navigation.root import getNavigationRoot\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.cache import render_cachekey\n-from plone.app.portlets.portlets import base\n from plone.memoize import ram\n from plone.memoize.compress import xhtml_compress\n from plone.memoize.instance import memoize\ndiff --git a/plone/app/portlets/portlets/review.py b/plone/app/portlets/portlets/review.py\nindex e59d8360..cba8d97f 100644\n--- a/plone/app/portlets/portlets/review.py\n+++ b/plone/app/portlets/portlets/review.py\n@@ -1,7 +1,7 @@\n+from .. import PloneMessageFactory as _\n+from ..browser import formhelper\n+from ..portlets import base\n from Acquisition import aq_inner\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.browser import formhelper\n-from plone.app.portlets.portlets import base\n from plone.i18n.normalizer.interfaces import IIDNormalizer\n from plone.memoize.instance import memoize\n from plone.portlets.interfaces import IPortletDataProvider\ndiff --git a/plone/app/portlets/portlets/rss.py b/plone/app/portlets/portlets/rss.py\nindex 6cf4ce12..c53a37bd 100644\n--- a/plone/app/portlets/portlets/rss.py\n+++ b/plone/app/portlets/portlets/rss.py\n@@ -1,8 +1,8 @@\n+from .. import PloneMessageFactory as _\n+from ..portlets import base\n from DateTime import DateTime\n from DateTime.interfaces import DateTimeError\n from logging import getLogger\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.portlets import base\n from plone.portlets.interfaces import IPortletDataProvider\n from Products.Five.browser.pagetemplatefile import ZopeTwoPageTemplateFile\n from urllib.parse import urlparse\ndiff --git a/plone/app/portlets/portlets/search.pt b/plone/app/portlets/portlets/search.pt\nindex 216fecf8..7d1289f4 100644\n--- a/plone/app/portlets/portlets/search.pt\n+++ b/plone/app/portlets/portlets/search.pt\n@@ -31,7 +31,7 @@\n                 i18n:attributes="title title_search_title; placeholder title_search_site"\n                 tal:attributes="value request/SearchableText|nothing; class python:livesearch and \'form-control portlet-search-gadget\' or \'form-control portlet-search-gadget-nols\'"/>\n             <div class="input-group-append">\n-              <button type="submit" class="btn btn-primary" value="Search" i18n:attributes="value label_search">Submit</button>\n+              <button type="submit" class="btn btn-primary" value="Search" i18n:attributes="value label_search" i18n:translate="label_submit">Submit</button>\n             </div>\n           </div>\n           <div class="LSResult" style="" tal:condition="livesearch" tal:attributes="data-livesearch view/livesearch_action;">\ndiff --git a/plone/app/portlets/portlets/search.py b/plone/app/portlets/portlets/search.py\nindex f4813280..db7b3a68 100644\n--- a/plone/app/portlets/portlets/search.py\n+++ b/plone/app/portlets/portlets/search.py\n@@ -1,6 +1,6 @@\n+from .. import PloneMessageFactory as _\n+from ..portlets import base\n from plone.app.layout.navigation.root import getNavigationRoot\n-from plone.app.portlets import PloneMessageFactory as _\n-from plone.app.portlets.portlets import base\n from plone.portlets.interfaces import IPortletDataProvider\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from zope import schema\ndiff --git a/plone/app/portlets/storage.py b/plone/app/portlets/storage.py\nindex 8a4eba53..dca4820b 100644\n--- a/plone/app/portlets/storage.py\n+++ b/plone/app/portlets/storage.py\n@@ -1,8 +1,8 @@\n+from .interfaces import IGroupDashboardPortletAssignmentMapping\n+from .interfaces import IUserPortletAssignmentMapping\n from Acquisition import aq_base\n from BTrees.OOBTree import OOBTree\n from OFS.SimpleItem import SimpleItem\n-from plone.app.portlets.interfaces import IGroupDashboardPortletAssignmentMapping\n-from plone.app.portlets.interfaces import IUserPortletAssignmentMapping\n from plone.i18n.normalizer.interfaces import IIDNormalizer\n from plone.portlets import constants\n from plone.portlets.constants import CONTEXT_ASSIGNMENT_KEY\ndiff --git a/plone/app/portlets/tests/test_formextender.py b/plone/app/portlets/tests/test_formextender.py\nindex 6961f178..51fb7ada 100644\n--- a/plone/app/portlets/tests/test_formextender.py\n+++ b/plone/app/portlets/tests/test_formextender.py\n@@ -59,7 +59,7 @@ def __getattr__(self, attr):\n \n class TestSchemaExtender(PortletsTestCase):\n     def test_addform_fields(self):\n-        schema_field_names = field.Fields(news.INewsPortlet).keys()\n+        schema_field_names = [k for k in field.Fields(news.INewsPortlet).keys()]\n \n         # We use the news portlet as a random example of a portlet\n         portlet = getUtility(IPortletType, name="portlets.News")\n@@ -67,7 +67,7 @@ def test_addform_fields(self):\n         mapping = self.portal.restrictedTraverse("++contextportlets++plone.leftcolumn")\n         addview = mapping.restrictedTraverse("+/" + portlet.addview)\n         addview.update()\n-        addview_field_names = addview.fields.keys()\n+        addview_field_names = [k for k in addview.fields.keys()]\n \n         # Our addview schema before we register our extender:\n         self.assertEqual(addview_field_names, schema_field_names)\n@@ -85,7 +85,7 @@ def test_addform_fields(self):\n         mapping = self.portal.restrictedTraverse("++contextportlets++plone.leftcolumn")\n         addview = mapping.restrictedTraverse("+/" + portlet.addview)\n         addview.update()\n-        addview_field_names = addview.fields.keys()\n+        addview_field_names = [k for k in addview.fields.keys()]\n \n         gsm.unregisterAdapter(\n             PortletCssClassFormExtender,\n@@ -150,14 +150,14 @@ def test_invoke_add_form(self):\n \n     def test_editform_fields(self):\n \n-        schema_field_names = field.Fields(news.INewsPortlet).keys()\n+        schema_field_names = [k for k in field.Fields(news.INewsPortlet).keys()]\n \n         mapping = PortletAssignmentMapping()\n         request = self.folder.REQUEST\n         mapping["foo"] = news.Assignment(count=5)\n         editview = getMultiAdapter((mapping["foo"], request), name="edit")\n         editview.update()\n-        editview_field_names = editview.fields.keys()\n+        editview_field_names = [k for k in editview.fields.keys()]\n \n         # Our editview schema before we register our extender:\n         self.assertEqual(editview_field_names, schema_field_names)\n@@ -177,7 +177,7 @@ def test_editform_fields(self):\n         mapping["foo"] = news.Assignment(count=5)\n         editview = getMultiAdapter((mapping["foo"], request), name="edit")\n         editview.update()\n-        editview_field_names = editview.fields.keys()\n+        editview_field_names = [k for k in editview.fields.keys()]\n \n         gsm.unregisterAdapter(\n             PortletCssClassFormExtender,\ndiff --git a/setup.cfg b/setup.cfg\nindex be9558ad..908a1d62 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -6,4 +6,4 @@ force_single_line = True\n lines_after_imports = 2\n \n [bdist_wheel]\n-universal = 1\n+universal = 0\ndiff --git a/setup.py b/setup.py\nindex 9165b40c..a44fbd88 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -2,7 +2,7 @@\n from setuptools import setup\n \n \n-version = "5.0.0a6.dev0"\n+version = "5.0.0b2.dev0"\n \n setup(\n     name="plone.app.portlets",\n'

Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2022-07-05T11:54:43+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.portlets/commit/718657502c3e5fbe244f49ea91fbd5268d90c811

Create 157.bugfix

Files changed:
A news/157.bugfix

b'diff --git a/news/157.bugfix b/news/157.bugfix\nnew file mode 100644\nindex 00000000..e2ed70c6\n--- /dev/null\n+++ b/news/157.bugfix\n@@ -0,0 +1 @@\n+Fix Plone 5.2.4 migrating troubles [michaellaunay]\n'

Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2022-07-05T11:55:06+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.portlets/commit/d79d9f0ff2761a35933f4d202c9960b359e7f60c

Merge pull request #157 from michaellaunay/patch-1

Fix Plone 5.2.4 migrating troubles

Files changed:
A news/157.bugfix
M plone/app/portlets/portlets/recent.py

b'diff --git a/news/157.bugfix b/news/157.bugfix\nnew file mode 100644\nindex 00000000..e2ed70c6\n--- /dev/null\n+++ b/news/157.bugfix\n@@ -0,0 +1 @@\n+Fix Plone 5.2.4 migrating troubles [michaellaunay]\ndiff --git a/plone/app/portlets/portlets/recent.py b/plone/app/portlets/portlets/recent.py\nindex 1893c525..6ee8eeb7 100644\n--- a/plone/app/portlets/portlets/recent.py\n+++ b/plone/app/portlets/portlets/recent.py\n@@ -61,6 +61,7 @@ class IRecentPortlet(IPortletDataProvider):\n class Assignment(base.Assignment):\n     no_icons = False\n     thumb_scale = None\n+    no_thumbs = False\n \n     def __init__(self, count=5, no_icons=False, thumb_scale=None, no_thumbs=False):\n         self.count = count\n'

