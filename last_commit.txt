Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-04-10T10:55:02+03:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/Products.CMFPlone/commit/73d9f7ccfada653cb103bc968902a871dee4e9bb

Fix issue where catalog search with path failed when path had inaccessible (private) levels

Files changed:
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py
index d51cf69..50c3047 100644
--- a/Products/CMFPlone/CatalogTool.py
+++ b/Products/CMFPlone/CatalogTool.py
@@ -409,7 +409,9 @@ def allow_inactive(self, query_kw):
         for path in list(paths):
             path = path.encode('utf-8')  # paths must not be unicode
             try:
-                objs.append(site.restrictedTraverse(path))
+                parts = path.split('/')
+                parent = site.unrestrictedTraverse('/'.join(parts[:-1]))
+                objs.append(parent.restrictedTraverse(parts[-1]))
             except (KeyError, AttributeError):
                 # When no object is found don't raise an error
                 pass
diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py
index 0635d5e..2d2d053 100644
--- a/Products/CMFPlone/tests/testCatalogTool.py
+++ b/Products/CMFPlone/tests/testCatalogTool.py
@@ -1026,6 +1026,34 @@ def testCallExpiredWithPermission(self):
         res = self.catalog()
         self.assertResults(res, base_content)
 
+    def testPathWithPrivateMidLevel(self):
+        # This test was added to test issue where allow_inactive-check raised
+        # Unauthorized-exception with the search conditions of this test.
+
+        # Be anonymous to enable allow_inactive -check
+        self.logout()
+
+        # Check that search shows both self.folder and self.folder.doc
+        path = '/'.join(self.folder.aq_parent.getPhysicalPath())
+        results = [b.getPath() for b in self.catalog(path=path)]
+        self.assertIn('/'.join(self.folder.getPhysicalPath()), results)
+        self.assertIn('/'.join(self.folder.doc.getPhysicalPath()), results)
+
+        # Hide self.folder from anonymous, but leave self.folder.doc visible
+        self.login(TEST_USER_NAME)
+        self.portal.portal_workflow.doActionFor(self.folder, 'hide')
+        self.logout()
+
+        # Check that self.folder.doc is still visible while self.folder is not
+        results = [b.getPath() for b in self.catalog(path=path)]
+        self.assertNotIn('/'.join(self.folder.getPhysicalPath()), results)
+        self.assertIn('/'.join(self.folder.doc.getPhysicalPath()), results)
+
+        # Check that direct search for self.folder.doc can be made
+        path = '/'.join(self.folder.doc.getPhysicalPath())
+        results = [b.getPath() for b in self.catalog(path=path)]
+        self.assertIn('/'.join(self.folder.doc.getPhysicalPath()), results)
+
     def testExpiredWithPermissionOnSubpath(self):
         self.folder.doc.setExpirationDate(DateTime(2000, 12, 31))
         self.folder.doc.reindexObject()


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-04-10T10:55:06+03:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/Products.CMFPlone/commit/0520fc9d2916d9d553845348ffdb8f618aa9ffc7

Update changelog

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index b71f55e..cbb17bd 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -19,6 +19,10 @@ New features:
 
 Bug fixes:
 
+- Fix issue where catalog search with path failed when path had inaccessible
+  (private) levels
+  [datakurre]
+
 - Add constraint to avoid filling ``twitter_username`` field with strings starting with a "@" character.
   [hvelarde]
   


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-04-10T13:17:38+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/ea027cde41431caa7ae7c1a14be34f633cf933ba

Merge pull request #1996 from plone/datakurre-restrictedTraverse

Fix issue where catalog search with path failed when path had inaccessible (private) levels

Files changed:
M CHANGES.rst
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b71f55e..cbb17bd 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -19,6 +19,10 @@ New features:
 
 Bug fixes:
 
+- Fix issue where catalog search with path failed when path had inaccessible
+  (private) levels
+  [datakurre]
+
 - Add constraint to avoid filling ``twitter_username`` field with strings starting with a "@" character.
   [hvelarde]
   
diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py
index d51cf69..50c3047 100644
--- a/Products/CMFPlone/CatalogTool.py
+++ b/Products/CMFPlone/CatalogTool.py
@@ -409,7 +409,9 @@ def allow_inactive(self, query_kw):
         for path in list(paths):
             path = path.encode('utf-8')  # paths must not be unicode
             try:
-                objs.append(site.restrictedTraverse(path))
+                parts = path.split('/')
+                parent = site.unrestrictedTraverse('/'.join(parts[:-1]))
+                objs.append(parent.restrictedTraverse(parts[-1]))
             except (KeyError, AttributeError):
                 # When no object is found don't raise an error
                 pass
diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py
index 0635d5e..2d2d053 100644
--- a/Products/CMFPlone/tests/testCatalogTool.py
+++ b/Products/CMFPlone/tests/testCatalogTool.py
@@ -1026,6 +1026,34 @@ def testCallExpiredWithPermission(self):
         res = self.catalog()
         self.assertResults(res, base_content)
 
+    def testPathWithPrivateMidLevel(self):
+        # This test was added to test issue where allow_inactive-check raised
+        # Unauthorized-exception with the search conditions of this test.
+
+        # Be anonymous to enable allow_inactive -check
+        self.logout()
+
+        # Check that search shows both self.folder and self.folder.doc
+        path = '/'.join(self.folder.aq_parent.getPhysicalPath())
+        results = [b.getPath() for b in self.catalog(path=path)]
+        self.assertIn('/'.join(self.folder.getPhysicalPath()), results)
+        self.assertIn('/'.join(self.folder.doc.getPhysicalPath()), results)
+
+        # Hide self.folder from anonymous, but leave self.folder.doc visible
+        self.login(TEST_USER_NAME)
+        self.portal.portal_workflow.doActionFor(self.folder, 'hide')
+        self.logout()
+
+        # Check that self.folder.doc is still visible while self.folder is not
+        results = [b.getPath() for b in self.catalog(path=path)]
+        self.assertNotIn('/'.join(self.folder.getPhysicalPath()), results)
+        self.assertIn('/'.join(self.folder.doc.getPhysicalPath()), results)
+
+        # Check that direct search for self.folder.doc can be made
+        path = '/'.join(self.folder.doc.getPhysicalPath())
+        results = [b.getPath() for b in self.catalog(path=path)]
+        self.assertIn('/'.join(self.folder.doc.getPhysicalPath()), results)
+
     def testExpiredWithPermissionOnSubpath(self):
         self.folder.doc.setExpirationDate(DateTime(2000, 12, 31))
         self.folder.doc.reindexObject()


