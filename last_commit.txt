Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2021-10-15T19:39:56+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/b9132a281b1fe0b50c13220842e9b5833e057148

Upgrade: fix icon expressions for portal_types and their view and edit actions.

Sees [this PR comment](https://github.com/plone/plone.app.upgrade/pull/259#issuecomment-944213712).

Files changed:
A news/259.bugfix
M plone/app/contenttypes/profiles/default/metadata.xml
M plone/app/contenttypes/upgrades.py
M plone/app/contenttypes/upgrades.zcml

b'diff --git a/news/259.bugfix b/news/259.bugfix\nnew file mode 100644\nindex 00000000..c0f614d8\n--- /dev/null\n+++ b/news/259.bugfix\n@@ -0,0 +1,3 @@\n+Upgrade: fix icon expressions for portal_types and their view and edit actions.\n+See `this PR comment <https://github.com/plone/plone.app.upgrade/pull/259#issuecomment-944213712>`_.\n+[maurits]\ndiff --git a/plone/app/contenttypes/profiles/default/metadata.xml b/plone/app/contenttypes/profiles/default/metadata.xml\nindex 687667d6..245c492a 100644\n--- a/plone/app/contenttypes/profiles/default/metadata.xml\n+++ b/plone/app/contenttypes/profiles/default/metadata.xml\n@@ -1,5 +1,5 @@\n <metadata>\n- <version>1107</version>\n+ <version>3000</version>\n  <dependencies>\n   <dependency>profile-plone.app.dexterity:default</dependency>\n   <dependency>profile-plone.app.event:default</dependency>\ndiff --git a/plone/app/contenttypes/upgrades.py b/plone/app/contenttypes/upgrades.py\nindex 026a8e08..a58b7174 100644\n--- a/plone/app/contenttypes/upgrades.py\n+++ b/plone/app/contenttypes/upgrades.py\n@@ -256,3 +256,109 @@ def searchabletext_richtext(context):\n     objs = _brains2objs(brains)\n     for obj in objs:\n         obj.reindexObject(idxs=[\'SearchableText\'])\n+\n+\n+def update_type_icons(context):\n+    """Update portal_type icons.\n+\n+    We want to update two things:\n+\n+    - the icon_expr property of the portal_type\n+    - the icon_expr property of the view and edit actions.\n+\n+    This is for the standard types defined here, plus the Plone Site.\n+\n+    An earlier version of this upgrade step did this in xml in an upgrade\n+    profile.  This led to duplicate view and edit actions, because the xml did\n+    not contain a category for the action.\n+    A second try with xml still resulted in duplicate view actions,\n+    and the view and edit actions were invisible.\n+\n+    Conclusion: if we want to do this in xml, we must specify *all* properties.\n+    And we do not want this, because these properties may have been changed\n+    by the user.\n+    So: we do it in Python.\n+    """\n+    types = {\n+        "Collection": "string:contenttype/collection",\n+        "Document": "string:contenttype/document",\n+        "Event": "string:contenttype/event",\n+        "File": "string:contenttype/file",\n+        "Folder": "string:contenttype/folder",\n+        "Image": "string:contenttype/image",\n+        "Link": "string:contenttype/link",\n+        "News Item": "string:contenttype/news-item",\n+        "Plone Site": "string:contenttype/plone",\n+    }\n+    view_icon_expr = "string:toolbar-action/view"\n+    edit_icon_expr = "string:toolbar-action/edit"\n+    for type_name, icon_expr in types.items():\n+        fti = queryUtility(IDexterityFTI, name=type_name)\n+        if not fti:\n+            continue\n+        if fti.getProperty("icon_expr") != icon_expr:\n+            if not fti.hasProperty("icon_expr"):\n+                fti._setProperty("icon_expr", icon_expr)\n+            else:\n+                fti._updateProperty("icon_expr", icon_expr)\n+            logger.info("Set icon_expr property on FTI %s to %s", type_name, icon_expr)\n+\n+        # Build up the new actions list.\n+        new_actions = []\n+        discarded_actions = []\n+        found_visible_view = False\n+        found_visible_edit = False\n+        changed_icon_expression = False\n+        for action in fti._actions:\n+            if not action.category:\n+                discarded_actions.append(action)\n+                continue\n+            if action.category != "object":\n+                new_actions.append(action)\n+                continue\n+            if action.id not in ("view", "edit"):\n+                new_actions.append(action)\n+                continue\n+            # At this point we have id=view/edit and category=object.\n+            if not action.visible:\n+                # A previous version of the update may have resulted in\n+                # an extra, invisible action.\n+                discarded_actions.append(action)\n+                continue\n+            action_icon_expr = action.getIconExpression()\n+            if action.id == "view":\n+                found_visible_view = True\n+                if action_icon_expr != view_icon_expr:\n+                    # This is what we wanted: change the icon expression.\n+                    action.setIconExpression(view_icon_expr)\n+                    changed_icon_expression = True\n+            elif action.id == "edit":\n+                found_visible_edit = True\n+                if action_icon_expr != edit_icon_expr:\n+                    # This is what we wanted: change the icon expression.\n+                    action.setIconExpression(edit_icon_expr)\n+                    changed_icon_expression = True\n+            new_actions.append(action)\n+        if not (found_visible_view and found_visible_edit):\n+            # This is an unexpected situation.\n+            # If we change something, we might make it worse.\n+            logger.warning(\n+                "Did not find both visible view and edit actions for type %s. Not updating type icons.",\n+                type_name,\n+            )\n+            continue\n+        if not (discarded_actions or changed_icon_expression):\n+            # no changes needed\n+            continue\n+        if discarded_actions:\n+            logger.info(\n+                "Removed %d actions without category from FTI %s.",\n+                len(discarded_actions),\n+                type_name,\n+            )\n+        if changed_icon_expression:\n+            logger.info(\n+                "Changed icon expression for view/edit action from FTI %s.",\n+                type_name,\n+            )\n+        fti._actions = tuple(new_actions)\ndiff --git a/plone/app/contenttypes/upgrades.zcml b/plone/app/contenttypes/upgrades.zcml\nindex 96fadb76..ff9a1bfb 100644\n--- a/plone/app/contenttypes/upgrades.zcml\n+++ b/plone/app/contenttypes/upgrades.zcml\n@@ -94,11 +94,11 @@\n       for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION" />\n \n-  <genericsetup:upgradeDepends\n-      source="1106"\n-      destination="1107"\n+  <genericsetup:upgradeStep\n+      source="*"\n+      destination="3000"\n       profile="plone.app.contenttypes:default"\n       title="Update Type icons"\n-      import_profile="plone.app.contenttypes:1007" />\n+      handler=".upgrades.update_type_icons" />\n \n </configure>\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2021-10-15T19:39:56+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/b7e5ac282a39b750b1352a9614287cd2945bae30

Removed 1107 upgrade profile.

We now handle this in the upgrade step of the previous commit.
Note: in some places, this profile was accidentally called 1007.

Files changed:
M plone/app/contenttypes/setuphandlers.py
M plone/app/contenttypes/upgrades.zcml
D plone/app/contenttypes/profiles/upgrades/1107/types.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Collection.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Document.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Event.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/File.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Folder.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Image.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Link.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/News_Item.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Plone_Site.xml

b'diff --git a/plone/app/contenttypes/profiles/upgrades/1107/types.xml b/plone/app/contenttypes/profiles/upgrades/1107/types.xml\ndeleted file mode 100644\nindex 7992932d..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types.xml\n+++ /dev/null\n@@ -1,13 +0,0 @@\n-<?xml version="1.0"?>\n-<object meta_type="Plone Types Tool" name="portal_types">\n-\n- <object meta_type="Dexterity FTI" name="Collection" />\n- <object meta_type="Dexterity FTI" name="Document" />\n- <object meta_type="Dexterity FTI" name="Folder" />\n- <object meta_type="Dexterity FTI" name="Link" />\n- <object meta_type="Dexterity FTI" name="File" />\n- <object meta_type="Dexterity FTI" name="Image" />\n- <object meta_type="Dexterity FTI" name="News Item" />\n- <object meta_type="Dexterity FTI" name="Event" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Collection.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Collection.xml\ndeleted file mode 100644\nindex c0e91930..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Collection.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    name="Collection"\n-    meta_type="Dexterity FTI"\n-    i18n:domain="plone"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/collection</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Document.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Document.xml\ndeleted file mode 100644\nindex fb666e67..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Document.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Document"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/document</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Event.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Event.xml\ndeleted file mode 100644\nindex 23f0ec59..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Event.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Event"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/event</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/File.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/File.xml\ndeleted file mode 100644\nindex f4d1f9e4..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/File.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="File"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/file</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Folder.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Folder.xml\ndeleted file mode 100644\nindex ea9b18b8..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Folder.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Folder"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/folder</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Image.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Image.xml\ndeleted file mode 100644\nindex 1d853e16..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Image.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Image"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/image</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Link.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Link.xml\ndeleted file mode 100644\nindex bb555473..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Link.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Link"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/link</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/News_Item.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/News_Item.xml\ndeleted file mode 100644\nindex 656d74c1..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/News_Item.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="News Item"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/news-item</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Plone_Site.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Plone_Site.xml\ndeleted file mode 100644\nindex 21ddcfe1..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Plone_Site.xml\n+++ /dev/null\n@@ -1,9 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    name="Plone Site"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/plone</property>\n-\n-</object>\ndiff --git a/plone/app/contenttypes/setuphandlers.py b/plone/app/contenttypes/setuphandlers.py\nindex 1ced3011..a2261918 100644\n--- a/plone/app/contenttypes/setuphandlers.py\n+++ b/plone/app/contenttypes/setuphandlers.py\n@@ -39,7 +39,6 @@ def getNonInstallableProfiles(self):\n         return [\n             u\'plone.app.contenttypes:uninstall\',\n             u\'plone.app.contenttypes:default\',\n-            u\'plone.app.contenttypes:1007\',\n         ]\n \n \ndiff --git a/plone/app/contenttypes/upgrades.zcml b/plone/app/contenttypes/upgrades.zcml\nindex ff9a1bfb..0799f68c 100644\n--- a/plone/app/contenttypes/upgrades.zcml\n+++ b/plone/app/contenttypes/upgrades.zcml\n@@ -87,13 +87,6 @@\n       handler=".upgrades.searchabletext_richtext"\n       />\n \n-  <genericsetup:registerProfile name="1007"\n-      title="Update bundles"\n-      description=\'Configuration for version 1007\'\n-      directory="profiles/upgrades/1107"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n-      provides="Products.GenericSetup.interfaces.EXTENSION" />\n-\n   <genericsetup:upgradeStep\n       source="*"\n       destination="3000"\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2021-10-15T23:29:42+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.contenttypes/commit/0baebf512f6079369093f730241262316eb3da2b

Merge pull request #615 from plone/maurits/upgrade-action-icons-in-python

Upgrade icon expressions in Python

Files changed:
A news/259.bugfix
M plone/app/contenttypes/profiles/default/metadata.xml
M plone/app/contenttypes/setuphandlers.py
M plone/app/contenttypes/upgrades.py
M plone/app/contenttypes/upgrades.zcml
D plone/app/contenttypes/profiles/upgrades/1107/types.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Collection.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Document.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Event.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/File.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Folder.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Image.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Link.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/News_Item.xml
D plone/app/contenttypes/profiles/upgrades/1107/types/Plone_Site.xml

b'diff --git a/news/259.bugfix b/news/259.bugfix\nnew file mode 100644\nindex 00000000..c0f614d8\n--- /dev/null\n+++ b/news/259.bugfix\n@@ -0,0 +1,3 @@\n+Upgrade: fix icon expressions for portal_types and their view and edit actions.\n+See `this PR comment <https://github.com/plone/plone.app.upgrade/pull/259#issuecomment-944213712>`_.\n+[maurits]\ndiff --git a/plone/app/contenttypes/profiles/default/metadata.xml b/plone/app/contenttypes/profiles/default/metadata.xml\nindex 687667d6..245c492a 100644\n--- a/plone/app/contenttypes/profiles/default/metadata.xml\n+++ b/plone/app/contenttypes/profiles/default/metadata.xml\n@@ -1,5 +1,5 @@\n <metadata>\n- <version>1107</version>\n+ <version>3000</version>\n  <dependencies>\n   <dependency>profile-plone.app.dexterity:default</dependency>\n   <dependency>profile-plone.app.event:default</dependency>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types.xml b/plone/app/contenttypes/profiles/upgrades/1107/types.xml\ndeleted file mode 100644\nindex 7992932d..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types.xml\n+++ /dev/null\n@@ -1,13 +0,0 @@\n-<?xml version="1.0"?>\n-<object meta_type="Plone Types Tool" name="portal_types">\n-\n- <object meta_type="Dexterity FTI" name="Collection" />\n- <object meta_type="Dexterity FTI" name="Document" />\n- <object meta_type="Dexterity FTI" name="Folder" />\n- <object meta_type="Dexterity FTI" name="Link" />\n- <object meta_type="Dexterity FTI" name="File" />\n- <object meta_type="Dexterity FTI" name="Image" />\n- <object meta_type="Dexterity FTI" name="News Item" />\n- <object meta_type="Dexterity FTI" name="Event" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Collection.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Collection.xml\ndeleted file mode 100644\nindex c0e91930..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Collection.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    name="Collection"\n-    meta_type="Dexterity FTI"\n-    i18n:domain="plone"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/collection</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Document.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Document.xml\ndeleted file mode 100644\nindex fb666e67..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Document.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Document"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/document</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Event.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Event.xml\ndeleted file mode 100644\nindex 23f0ec59..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Event.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Event"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/event</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/File.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/File.xml\ndeleted file mode 100644\nindex f4d1f9e4..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/File.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="File"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/file</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Folder.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Folder.xml\ndeleted file mode 100644\nindex ea9b18b8..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Folder.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Folder"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/folder</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Image.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Image.xml\ndeleted file mode 100644\nindex 1d853e16..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Image.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Image"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/image</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Link.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Link.xml\ndeleted file mode 100644\nindex bb555473..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Link.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="Link"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/link</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/News_Item.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/News_Item.xml\ndeleted file mode 100644\nindex 656d74c1..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/News_Item.xml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    meta_type="Dexterity FTI"\n-    name="News Item"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/news-item</property>\n-\n-  <action\n-      title="View"\n-      action_id="view"\n-      icon_expr="string:toolbar-action/view" />\n-\n-  <action\n-      title="Edit"\n-      action_id="edit"\n-      icon_expr="string:toolbar-action/edit" />\n-\n-</object>\ndiff --git a/plone/app/contenttypes/profiles/upgrades/1107/types/Plone_Site.xml b/plone/app/contenttypes/profiles/upgrades/1107/types/Plone_Site.xml\ndeleted file mode 100644\nindex 21ddcfe1..00000000\n--- a/plone/app/contenttypes/profiles/upgrades/1107/types/Plone_Site.xml\n+++ /dev/null\n@@ -1,9 +0,0 @@\n-<?xml version="1.0"?>\n-<object\n-    i18n:domain="plone"\n-    name="Plone Site"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n-\n-  <property name="icon_expr">string:contenttype/plone</property>\n-\n-</object>\ndiff --git a/plone/app/contenttypes/setuphandlers.py b/plone/app/contenttypes/setuphandlers.py\nindex 1ced3011..a2261918 100644\n--- a/plone/app/contenttypes/setuphandlers.py\n+++ b/plone/app/contenttypes/setuphandlers.py\n@@ -39,7 +39,6 @@ def getNonInstallableProfiles(self):\n         return [\n             u\'plone.app.contenttypes:uninstall\',\n             u\'plone.app.contenttypes:default\',\n-            u\'plone.app.contenttypes:1007\',\n         ]\n \n \ndiff --git a/plone/app/contenttypes/upgrades.py b/plone/app/contenttypes/upgrades.py\nindex 026a8e08..a58b7174 100644\n--- a/plone/app/contenttypes/upgrades.py\n+++ b/plone/app/contenttypes/upgrades.py\n@@ -256,3 +256,109 @@ def searchabletext_richtext(context):\n     objs = _brains2objs(brains)\n     for obj in objs:\n         obj.reindexObject(idxs=[\'SearchableText\'])\n+\n+\n+def update_type_icons(context):\n+    """Update portal_type icons.\n+\n+    We want to update two things:\n+\n+    - the icon_expr property of the portal_type\n+    - the icon_expr property of the view and edit actions.\n+\n+    This is for the standard types defined here, plus the Plone Site.\n+\n+    An earlier version of this upgrade step did this in xml in an upgrade\n+    profile.  This led to duplicate view and edit actions, because the xml did\n+    not contain a category for the action.\n+    A second try with xml still resulted in duplicate view actions,\n+    and the view and edit actions were invisible.\n+\n+    Conclusion: if we want to do this in xml, we must specify *all* properties.\n+    And we do not want this, because these properties may have been changed\n+    by the user.\n+    So: we do it in Python.\n+    """\n+    types = {\n+        "Collection": "string:contenttype/collection",\n+        "Document": "string:contenttype/document",\n+        "Event": "string:contenttype/event",\n+        "File": "string:contenttype/file",\n+        "Folder": "string:contenttype/folder",\n+        "Image": "string:contenttype/image",\n+        "Link": "string:contenttype/link",\n+        "News Item": "string:contenttype/news-item",\n+        "Plone Site": "string:contenttype/plone",\n+    }\n+    view_icon_expr = "string:toolbar-action/view"\n+    edit_icon_expr = "string:toolbar-action/edit"\n+    for type_name, icon_expr in types.items():\n+        fti = queryUtility(IDexterityFTI, name=type_name)\n+        if not fti:\n+            continue\n+        if fti.getProperty("icon_expr") != icon_expr:\n+            if not fti.hasProperty("icon_expr"):\n+                fti._setProperty("icon_expr", icon_expr)\n+            else:\n+                fti._updateProperty("icon_expr", icon_expr)\n+            logger.info("Set icon_expr property on FTI %s to %s", type_name, icon_expr)\n+\n+        # Build up the new actions list.\n+        new_actions = []\n+        discarded_actions = []\n+        found_visible_view = False\n+        found_visible_edit = False\n+        changed_icon_expression = False\n+        for action in fti._actions:\n+            if not action.category:\n+                discarded_actions.append(action)\n+                continue\n+            if action.category != "object":\n+                new_actions.append(action)\n+                continue\n+            if action.id not in ("view", "edit"):\n+                new_actions.append(action)\n+                continue\n+            # At this point we have id=view/edit and category=object.\n+            if not action.visible:\n+                # A previous version of the update may have resulted in\n+                # an extra, invisible action.\n+                discarded_actions.append(action)\n+                continue\n+            action_icon_expr = action.getIconExpression()\n+            if action.id == "view":\n+                found_visible_view = True\n+                if action_icon_expr != view_icon_expr:\n+                    # This is what we wanted: change the icon expression.\n+                    action.setIconExpression(view_icon_expr)\n+                    changed_icon_expression = True\n+            elif action.id == "edit":\n+                found_visible_edit = True\n+                if action_icon_expr != edit_icon_expr:\n+                    # This is what we wanted: change the icon expression.\n+                    action.setIconExpression(edit_icon_expr)\n+                    changed_icon_expression = True\n+            new_actions.append(action)\n+        if not (found_visible_view and found_visible_edit):\n+            # This is an unexpected situation.\n+            # If we change something, we might make it worse.\n+            logger.warning(\n+                "Did not find both visible view and edit actions for type %s. Not updating type icons.",\n+                type_name,\n+            )\n+            continue\n+        if not (discarded_actions or changed_icon_expression):\n+            # no changes needed\n+            continue\n+        if discarded_actions:\n+            logger.info(\n+                "Removed %d actions without category from FTI %s.",\n+                len(discarded_actions),\n+                type_name,\n+            )\n+        if changed_icon_expression:\n+            logger.info(\n+                "Changed icon expression for view/edit action from FTI %s.",\n+                type_name,\n+            )\n+        fti._actions = tuple(new_actions)\ndiff --git a/plone/app/contenttypes/upgrades.zcml b/plone/app/contenttypes/upgrades.zcml\nindex 96fadb76..0799f68c 100644\n--- a/plone/app/contenttypes/upgrades.zcml\n+++ b/plone/app/contenttypes/upgrades.zcml\n@@ -87,18 +87,11 @@\n       handler=".upgrades.searchabletext_richtext"\n       />\n \n-  <genericsetup:registerProfile name="1007"\n-      title="Update bundles"\n-      description=\'Configuration for version 1007\'\n-      directory="profiles/upgrades/1107"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n-      provides="Products.GenericSetup.interfaces.EXTENSION" />\n-\n-  <genericsetup:upgradeDepends\n-      source="1106"\n-      destination="1107"\n+  <genericsetup:upgradeStep\n+      source="*"\n+      destination="3000"\n       profile="plone.app.contenttypes:default"\n       title="Update Type icons"\n-      import_profile="plone.app.contenttypes:1007" />\n+      handler=".upgrades.update_type_icons" />\n \n </configure>\n'

