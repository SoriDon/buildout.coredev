Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2018-01-29T14:49:02+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/95b0f27be794b82de146cd9a2990b9826b0633b6

Revert "Remove backward compatibility for Products.PlacelessTranslationService" (#2280)

Files changed:
M CHANGES.rst
M Products/CMFPlone/overrides.zcml
M Products/CMFPlone/tests/testSecurity.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 68cc5f746..574bb9f9b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -22,10 +22,6 @@ Breaking changes:
 - Render exceptions using an exception view instead of standard_error_message.
   [davisagli]
 
-- Remove backward compatibility for Products.PlacelessTranslationService 
-  [ksuess]
-
-
 New Features:
 
 - Fix imports to work with Python 3.
diff --git a/Products/CMFPlone/overrides.zcml b/Products/CMFPlone/overrides.zcml
index a265aee8d..af88b7514 100644
--- a/Products/CMFPlone/overrides.zcml
+++ b/Products/CMFPlone/overrides.zcml
@@ -4,6 +4,7 @@
            i18n_domain="plone">
 
     <include package="Products.CMFCore" file="overrides.zcml" />
+    <include package="Products.PlacelessTranslationService" file="overrides.zcml" />
     <include package="plone.app.portlets" file="overrides.zcml" />
 
     <utility
diff --git a/Products/CMFPlone/tests/testSecurity.py b/Products/CMFPlone/tests/testSecurity.py
index 80e863f2b..ee8e97192 100644
--- a/Products/CMFPlone/tests/testSecurity.py
+++ b/Products/CMFPlone/tests/testSecurity.py
@@ -28,6 +28,32 @@ def test_setHeader_drops_LF(self):
         self.assertEqual(response.headers['location'],
                          'http://www.ietf.org/rfc/rfc2616.txt')
 
+    def test_PT_allow_module_not_available_in_RestrictedPython_1(self):
+        src = '''
+from AccessControl import Unauthorized
+try:
+    import Products.PlacelessTranslationService
+except (ImportError, Unauthorized):
+    raise AssertionError("Failed to import Products.PTS")
+Products.PlacelessTranslationService.allow_module('os')
+'''
+        from Products.PythonScripts.PythonScript import PythonScript
+        script = makerequest(PythonScript('fooscript'))
+        script._filepath = 'fooscript'
+        script.write(src)
+        self.assertRaises((ImportError, Unauthorized), script)
+
+    def test_PT_allow_module_not_available_in_RestrictedPython_2(self):
+        src = '''
+from Products.PlacelessTranslationService import allow_module
+allow_module('os')
+'''
+        from Products.PythonScripts.PythonScript import PythonScript
+        script = makerequest(PythonScript('barscript'))
+        script._filepath = 'barscript'
+        script.write(src)
+        self.assertRaises((ImportError, Unauthorized), script)
+
     def test_get_request_var_or_attr_disallowed(self):
         import App.Undo
         self.assertFalse(hasattr(App.Undo.UndoSupport,
diff --git a/setup.py b/setup.py
index fd2c77703..69696da3e 100644
--- a/setup.py
+++ b/setup.py
@@ -62,6 +62,7 @@
         'Products.ExternalEditor',
         'Products.GenericSetup >= 1.8.2',
         'Products.MimetypesRegistry',
+        'Products.PlacelessTranslationService',
         # 'Products.PloneLanguageTool',
         'Products.PlonePAS',
         'Products.PluggableAuthService',


