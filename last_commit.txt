Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2022-05-19T17:26:18+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/f347ab224c405f1b194e8d06bc681db7178a18c8

When using images view, call tag directly.

See https://github.com/plone/Products.CMFPlone/issues/3535

Files changed:
A news/3535.bugfix
M plone/app/contenttypes/behaviors/leadimage.pt
M plone/app/contenttypes/browser/templates/image.pt
M plone/app/contenttypes/browser/templates/listing_summary.pt
M plone/app/contenttypes/tests/test_image.py

b'diff --git a/news/3535.bugfix b/news/3535.bugfix\nnew file mode 100644\nindex 000000000..540a8b34e\n--- /dev/null\n+++ b/news/3535.bugfix\n@@ -0,0 +1,2 @@\n+When using ``@@images`` view, call ``tag`` directly.\n+[maurits]\ndiff --git a/plone/app/contenttypes/behaviors/leadimage.pt b/plone/app/contenttypes/behaviors/leadimage.pt\nindex 4ce5494cd..6becd24c5 100644\n--- a/plone/app/contenttypes/behaviors/leadimage.pt\n+++ b/plone/app/contenttypes/behaviors/leadimage.pt\n@@ -1,10 +1,9 @@\n-<section id="section-leadimage" tal:condition="python: view.available" tal:define="scale_func context/@@images; scaled_image python: getattr(context.aq_explicit, \'image\', False) and scale_func.scale(\'image\', scale=\'large\')">\n-\n-  <figure class="newsImageContainer" tal:condition="python: scaled_image">\n-      <img tal:replace="structure python: scaled_image.tag(css_class=\'figure-img img-fluid\')" />\n+<section id="section-leadimage"\n+         tal:condition="view/available">\n+  <figure class="newsImageContainer" tal:define="images context/@@images">\n+      <img tal:replace="structure python: images.tag(\'image\', scale=\'large\', css_class=\'figure-img img-fluid\')" />\n       <figcaption class="figure-caption" tal:condition="python: getattr(context, \'image_caption\', None)" tal:content="python: context.image_caption">\n         Image caption\n       </figcaption>\n   </figure>\n-\n </section>\ndiff --git a/plone/app/contenttypes/browser/templates/image.pt b/plone/app/contenttypes/browser/templates/image.pt\nindex d7505c28d..2a4459a9e 100644\n--- a/plone/app/contenttypes/browser/templates/image.pt\n+++ b/plone/app/contenttypes/browser/templates/image.pt\n@@ -22,7 +22,7 @@\n   <section class="section section-main">\n     <figure class="figure">\n       <a tal:attributes="href string:${context/@@plone_context_state/object_url}/image_view_fullscreen"\n-         tal:define="scale context/@@images; img_tag python:scale.scale(\'image\', scale=\'large\').tag(css_class=\'figure-img img-fluid\')"\n+         tal:define="scale context/@@images; img_tag python:scale.tag(\'image\', scale=\'large\', css_class=\'figure-img img-fluid\')"\n          tal:on-error="string: Image cannot be displayed">\n         <img tal:replace="structure img_tag" />\n       </a>\ndiff --git a/plone/app/contenttypes/browser/templates/listing_summary.pt b/plone/app/contenttypes/browser/templates/listing_summary.pt\nindex 95873a871..5c35f359c 100644\n--- a/plone/app/contenttypes/browser/templates/listing_summary.pt\n+++ b/plone/app/contenttypes/browser/templates/listing_summary.pt\n@@ -45,7 +45,8 @@\n \n           </div>\n \n-          <div class="col-3" tal:define="thumb_url python:item_url + \'/@@images/image/\' + thumb_scale_summary;" tal:condition="python: item_has_image and thumb_scale_summary">\n+          <div class="col-3"\n+               tal:condition="python: item_has_image and thumb_scale_summary">\n             <a tal:attributes="href item_link">\n               <img tal:replace="structure python:image_scale.tag(item, \'image\', scale=thumb_scale_summary, css_class=\'image-responsive thumb-\' + thumb_scale_summary)" />\n             </a>\ndiff --git a/plone/app/contenttypes/tests/test_image.py b/plone/app/contenttypes/tests/test_image.py\nindex 0df6a6b7b..396fd01cf 100644\n--- a/plone/app/contenttypes/tests/test_image.py\n+++ b/plone/app/contenttypes/tests/test_image.py\n@@ -103,7 +103,7 @@ def test_svg_image(self):\n         self.image.image = dummy_image("image.svg")\n         scale = self.image.restrictedTraverse("@@images")\n         self.assertRegex(\n-            scale.scale("image", scale="large").tag(),\n+            scale.tag("image", scale="large"),\n             r\'<img src="http://nohost/plone/image/@@images/[a-z0-9\\-]*.svg" alt="My Image" title="My Image" height="[a-z0-9\\-]*" width="[a-z0-9\\-]*" />\',  # noqa: E501\n         )\n \n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2022-05-20T10:09:57+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/85f93a75560f5e3d331a41101abf886c946751d5

Fixed album view when a folder has no image.

Files changed:
M plone/app/contenttypes/browser/templates/listing_album.pt

b'diff --git a/plone/app/contenttypes/browser/templates/listing_album.pt b/plone/app/contenttypes/browser/templates/listing_album.pt\nindex 50d8f250..57473bed 100644\n--- a/plone/app/contenttypes/browser/templates/listing_album.pt\n+++ b/plone/app/contenttypes/browser/templates/listing_album.pt\n@@ -36,7 +36,8 @@\n   <tal:albums tal:repeat="album albums">\n     <div class="col mb-5">\n       <div class="card album h-100">\n-        <div tal:define="scale python:image_scale.tag(album, \'image\', scale=\'mini\')" tal:condition="scale" class="card-image d-flex justify-content-center align-items-center" style="height: 14rem;">\n+        <div tal:define="scale python:image_scale.tag(album, \'image\', scale=\'mini\') if getattr(album, \'image\', None) else None"\n+         tal:condition="scale" class="card-image d-flex justify-content-center align-items-center" style="height: 14rem;">\n           <img tal:replace="structure scale" />\n         </div>\n         <div class="card-body">\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2022-05-20T15:44:14+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/efa69bfdf247fb29ebd74fa8125edf903062e46d

Merge pull request #647 from plone/maurits-images

When using images view, call tag directly.

Files changed:
A news/3535.bugfix
M plone/app/contenttypes/behaviors/leadimage.pt
M plone/app/contenttypes/browser/templates/image.pt
M plone/app/contenttypes/browser/templates/listing_album.pt
M plone/app/contenttypes/browser/templates/listing_summary.pt
M plone/app/contenttypes/tests/test_image.py

b'diff --git a/news/3535.bugfix b/news/3535.bugfix\nnew file mode 100644\nindex 000000000..540a8b34e\n--- /dev/null\n+++ b/news/3535.bugfix\n@@ -0,0 +1,2 @@\n+When using ``@@images`` view, call ``tag`` directly.\n+[maurits]\ndiff --git a/plone/app/contenttypes/behaviors/leadimage.pt b/plone/app/contenttypes/behaviors/leadimage.pt\nindex 4ce5494cd..6becd24c5 100644\n--- a/plone/app/contenttypes/behaviors/leadimage.pt\n+++ b/plone/app/contenttypes/behaviors/leadimage.pt\n@@ -1,10 +1,9 @@\n-<section id="section-leadimage" tal:condition="python: view.available" tal:define="scale_func context/@@images; scaled_image python: getattr(context.aq_explicit, \'image\', False) and scale_func.scale(\'image\', scale=\'large\')">\n-\n-  <figure class="newsImageContainer" tal:condition="python: scaled_image">\n-      <img tal:replace="structure python: scaled_image.tag(css_class=\'figure-img img-fluid\')" />\n+<section id="section-leadimage"\n+         tal:condition="view/available">\n+  <figure class="newsImageContainer" tal:define="images context/@@images">\n+      <img tal:replace="structure python: images.tag(\'image\', scale=\'large\', css_class=\'figure-img img-fluid\')" />\n       <figcaption class="figure-caption" tal:condition="python: getattr(context, \'image_caption\', None)" tal:content="python: context.image_caption">\n         Image caption\n       </figcaption>\n   </figure>\n-\n </section>\ndiff --git a/plone/app/contenttypes/browser/templates/image.pt b/plone/app/contenttypes/browser/templates/image.pt\nindex d7505c28d..2a4459a9e 100644\n--- a/plone/app/contenttypes/browser/templates/image.pt\n+++ b/plone/app/contenttypes/browser/templates/image.pt\n@@ -22,7 +22,7 @@\n   <section class="section section-main">\n     <figure class="figure">\n       <a tal:attributes="href string:${context/@@plone_context_state/object_url}/image_view_fullscreen"\n-         tal:define="scale context/@@images; img_tag python:scale.scale(\'image\', scale=\'large\').tag(css_class=\'figure-img img-fluid\')"\n+         tal:define="scale context/@@images; img_tag python:scale.tag(\'image\', scale=\'large\', css_class=\'figure-img img-fluid\')"\n          tal:on-error="string: Image cannot be displayed">\n         <img tal:replace="structure img_tag" />\n       </a>\ndiff --git a/plone/app/contenttypes/browser/templates/listing_album.pt b/plone/app/contenttypes/browser/templates/listing_album.pt\nindex 50d8f250d..57473bed2 100644\n--- a/plone/app/contenttypes/browser/templates/listing_album.pt\n+++ b/plone/app/contenttypes/browser/templates/listing_album.pt\n@@ -36,7 +36,8 @@\n   <tal:albums tal:repeat="album albums">\n     <div class="col mb-5">\n       <div class="card album h-100">\n-        <div tal:define="scale python:image_scale.tag(album, \'image\', scale=\'mini\')" tal:condition="scale" class="card-image d-flex justify-content-center align-items-center" style="height: 14rem;">\n+        <div tal:define="scale python:image_scale.tag(album, \'image\', scale=\'mini\') if getattr(album, \'image\', None) else None"\n+         tal:condition="scale" class="card-image d-flex justify-content-center align-items-center" style="height: 14rem;">\n           <img tal:replace="structure scale" />\n         </div>\n         <div class="card-body">\ndiff --git a/plone/app/contenttypes/browser/templates/listing_summary.pt b/plone/app/contenttypes/browser/templates/listing_summary.pt\nindex 95873a871..5c35f359c 100644\n--- a/plone/app/contenttypes/browser/templates/listing_summary.pt\n+++ b/plone/app/contenttypes/browser/templates/listing_summary.pt\n@@ -45,7 +45,8 @@\n \n           </div>\n \n-          <div class="col-3" tal:define="thumb_url python:item_url + \'/@@images/image/\' + thumb_scale_summary;" tal:condition="python: item_has_image and thumb_scale_summary">\n+          <div class="col-3"\n+               tal:condition="python: item_has_image and thumb_scale_summary">\n             <a tal:attributes="href item_link">\n               <img tal:replace="structure python:image_scale.tag(item, \'image\', scale=thumb_scale_summary, css_class=\'image-responsive thumb-\' + thumb_scale_summary)" />\n             </a>\ndiff --git a/plone/app/contenttypes/tests/test_image.py b/plone/app/contenttypes/tests/test_image.py\nindex 0df6a6b7b..396fd01cf 100644\n--- a/plone/app/contenttypes/tests/test_image.py\n+++ b/plone/app/contenttypes/tests/test_image.py\n@@ -103,7 +103,7 @@ def test_svg_image(self):\n         self.image.image = dummy_image("image.svg")\n         scale = self.image.restrictedTraverse("@@images")\n         self.assertRegex(\n-            scale.scale("image", scale="large").tag(),\n+            scale.tag("image", scale="large"),\n             r\'<img src="http://nohost/plone/image/@@images/[a-z0-9\\-]*.svg" alt="My Image" title="My Image" height="[a-z0-9\\-]*" width="[a-z0-9\\-]*" />\',  # noqa: E501\n         )\n \n'

