Repository: plone.volto


Branch: refs/heads/main
Date: 2022-01-19T21:16:45+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.volto/commit/102ffa85118f3ec5feb0de7e200a1e466947d871

Remove c.folderishtypes dependency. (#36)

* Remove c.folderishtypes dependency.

* Fixes

* Add aliases to old collective.folderishtypes contents and interfaces

* Implement a migration from old collective.folderishtypes content to plone.volto content

* Lint

* Flake8 fixes

Co-authored-by: Érico Andrei &lt;ericof@gmail.com&gt;
Co-authored-by: Timo Stollenwerk &lt;tisto@users.noreply.github.com&gt;

Files changed:
A src/plone/volto/content.py
A src/plone/volto/profiles/default/types/Event.xml
A src/plone/volto/profiles/default/types/News_Item.xml
M CHANGES.rst
M setup.py
M src/plone/volto/dependencies.zcml
M src/plone/volto/interfaces.py
M src/plone/volto/patches.py
M src/plone/volto/profiles/default/metadata.xml
M src/plone/volto/profiles/default/types.xml
M src/plone/volto/profiles/default/types/Document.xml
M src/plone/volto/upgrades.py
M src/plone/volto/upgrades.zcml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex b249149..3abb6f2 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -11,6 +11,12 @@ Changelog\n 3.1.0a9 (2022-01-15)\n --------------------\n \n+Breaking:\n+\n+- Remove c.folderishtypes dependency\n+\n+New Feature:\n+\n - Add new field in the coresandbox: not constrained by vocabulary field but the vocabulary defined in the widget.\n   [sneridagh]\n \ndiff --git a/setup.py b/setup.py\nindex 6bd94d0..942ff00 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -57,7 +57,6 @@ def readfile(name):\n         "Products.GenericSetup",\n         "setuptools",\n         "plone.restapi>=8.13.0",\n-        "collective.folderishtypes[dexterity]",\n         "plone.app.vocabularies>=4.3.0",\n     ],\n     extras_require={\ndiff --git a/src/plone/volto/content.py b/src/plone/volto/content.py\nnew file mode 100644\nindex 0000000..2e67e18\n--- /dev/null\n+++ b/src/plone/volto/content.py\n@@ -0,0 +1,24 @@\n+# -*- coding: utf-8 -*-\n+from plone.volto.interfaces import IFolderishDocument\n+from plone.volto.interfaces import IFolderishEvent\n+from plone.volto.interfaces import IFolderishNewsItem\n+from plone.app.contenttypes.interfaces import IDocument\n+from plone.app.contenttypes.interfaces import IEvent\n+from plone.app.contenttypes.interfaces import INewsItem\n+from plone.dexterity.content import Container\n+from zope.interface import implementer\n+\n+\n+@implementer(IDocument, IFolderishDocument)\n+class FolderishDocument(Container):\n+    pass\n+\n+\n+@implementer(IEvent, IFolderishEvent)\n+class FolderishEvent(Container):\n+    pass\n+\n+\n+@implementer(INewsItem, IFolderishNewsItem)\n+class FolderishNewsItem(Container):\n+    pass\ndiff --git a/src/plone/volto/dependencies.zcml b/src/plone/volto/dependencies.zcml\nindex d34667f..bd61c7d 100644\n--- a/src/plone/volto/dependencies.zcml\n+++ b/src/plone/volto/dependencies.zcml\n@@ -18,6 +18,5 @@\n       />\n   <include package="plone.restapi" />\n   <include package="plone.api" />\n-  <include package="collective.folderishtypes" />\n \n </configure>\ndiff --git a/src/plone/volto/interfaces.py b/src/plone/volto/interfaces.py\nindex 41701c5..9938251 100644\n--- a/src/plone/volto/interfaces.py\n+++ b/src/plone/volto/interfaces.py\n@@ -9,6 +9,10 @@ class IPloneVoltoCoreLayer(IDefaultBrowserLayer):\n     """Marker interface that defines a browser layer."""\n \n \n+class IThemeSpecific(IPloneVoltoCoreLayer):\n+    """bbb for collective.folderishtypes browser interface."""\n+\n+\n class IVoltoSettings(Interface):\n     """Volto settings necessary to store in the backend"""\n \n@@ -17,3 +21,19 @@ class IVoltoSettings(Interface):\n         description=u"Used for rewriting URL\'s sent in the password reset e-mail by Plone.",\n         default="http://localhost:3000",\n     )\n+\n+\n+class IFolderishType(Interface):\n+    """Marker interface"""\n+\n+\n+class IFolderishDocument(IFolderishType):\n+    """Marker interface"""\n+\n+\n+class IFolderishEvent(IFolderishType):\n+    """Marker interface"""\n+\n+\n+class IFolderishNewsItem(IFolderishType):\n+    """Marker interface"""\ndiff --git a/src/plone/volto/patches.py b/src/plone/volto/patches.py\nindex bfd8dba..333356e 100644\n--- a/src/plone/volto/patches.py\n+++ b/src/plone/volto/patches.py\n@@ -1,3 +1,7 @@\n+from plone.app.upgrade.utils import alias_module\n+from plone.volto import logger\n+from plone.volto import content\n+from plone.volto import interfaces\n from plone.volto.interfaces import IVoltoSettings\n from plone.registry.interfaces import IRegistry\n from plone.rest.interfaces import IAPIRequest\n@@ -12,6 +16,15 @@\n LOG = logging.getLogger("Zope.SiteErrorLog")\n \n \n+try:\n+    from collective.folderishtypes.dx import content  # noqa F401\n+except ImportError:\n+    logger.info("Aliasing collective.folderish classes to plone.volto classes.")\n+    alias_module("collective.folderishtypes.dx.content", content)\n+    alias_module("collective.folderishtypes.dx.interfaces", interfaces)\n+    alias_module("collective.folderishtypes.interfaces", interfaces)\n+\n+\n def _do_copy_to_zlog(self, now, strtype, entry_id, url, tb_text):\n     when = _rate_restrict_pool.get(strtype, 0)\n     if now > when:\ndiff --git a/src/plone/volto/profiles/default/metadata.xml b/src/plone/volto/profiles/default/metadata.xml\nindex 36539e9..7a6e546 100644\n--- a/src/plone/volto/profiles/default/metadata.xml\n+++ b/src/plone/volto/profiles/default/metadata.xml\n@@ -1,8 +1,7 @@\n <?xml version="1.0" encoding="UTF-8"?>\n <metadata>\n-  <version>1012</version>\n+  <version>1014</version>\n   <dependencies>\n-    <dependency>profile-collective.folderishtypes.dx:default</dependency>\n     <dependency>profile-plone.restapi:blocks</dependency>\n   </dependencies>\n </metadata>\ndiff --git a/src/plone/volto/profiles/default/types.xml b/src/plone/volto/profiles/default/types.xml\nindex fee4cc8..0401464 100644\n--- a/src/plone/volto/profiles/default/types.xml\n+++ b/src/plone/volto/profiles/default/types.xml\n@@ -3,4 +3,6 @@\n   <object name="Plone Site" />\n   <object meta_type="Dexterity FTI" name="LRF" />\n   <object meta_type="Dexterity FTI" name="Document" />\n+  <object meta_type="Dexterity FTI" name="News Item" />\n+  <object meta_type="Dexterity FTI" name="Event" />\n </object>\ndiff --git a/src/plone/volto/profiles/default/types/Document.xml b/src/plone/volto/profiles/default/types/Document.xml\nindex 88e2284..9fd8222 100644\n--- a/src/plone/volto/profiles/default/types/Document.xml\n+++ b/src/plone/volto/profiles/default/types/Document.xml\n@@ -5,8 +5,12 @@\n     name="Document"\n     xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n \n+  <property name="filter_content_types">False</property>\n+  <property name="klass">plone.volto.content.FolderishDocument</property>\n+\n   <!-- Enabled behaviors -->\n   <property name="behaviors">\n+    <element value="plone.constraintypes"/>\n     <element value="plone.namefromtitle" />\n     <element value="plone.allowdiscussion" />\n     <element value="plone.excludefromnavigation" />\ndiff --git a/src/plone/volto/profiles/default/types/Event.xml b/src/plone/volto/profiles/default/types/Event.xml\nnew file mode 100644\nindex 0000000..b4bbde2\n--- /dev/null\n+++ b/src/plone/volto/profiles/default/types/Event.xml\n@@ -0,0 +1,9 @@\n+<?xml version="1.0"?>\n+<object name="Event" meta_type="Dexterity FTI" i18n:domain="plone"\n+    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n+  <property name="filter_content_types">False</property>\n+  <property name="klass">plone.volto.content.FolderishEvent</property>\n+  <property name="behaviors" purge="false">\n+    <element value="plone.constraintypes"/>\n+  </property>\n+</object>\ndiff --git a/src/plone/volto/profiles/default/types/News_Item.xml b/src/plone/volto/profiles/default/types/News_Item.xml\nnew file mode 100644\nindex 0000000..f3dc922\n--- /dev/null\n+++ b/src/plone/volto/profiles/default/types/News_Item.xml\n@@ -0,0 +1,9 @@\n+<?xml version="1.0"?>\n+<object name="News Item" meta_type="Dexterity FTI" i18n:domain="plone"\n+    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n+  <property name="filter_content_types">False</property>\n+  <property name="klass">plone.volto.content.FolderishNewsItem</property>\n+  <property name="behaviors" purge="false">\n+    <element value="plone.constraintypes"/>\n+  </property>\n+</object>\ndiff --git a/src/plone/volto/upgrades.py b/src/plone/volto/upgrades.py\nindex 7e1d695..e1615e8 100644\n--- a/src/plone/volto/upgrades.py\n+++ b/src/plone/volto/upgrades.py\n@@ -1,6 +1,40 @@\n from copy import deepcopy\n from plone import api\n from plone.restapi.behaviors import IBlocks\n+from plone.volto import content\n+from plone.volto import logger\n+\n+\n+MIGRATION = {\n+    "Document": content.FolderishDocument,\n+    "Event": content.FolderishEvent,\n+    "News Item": content.FolderishNewsItem,\n+}\n+\n+\n+def migrate_content_classes(context):\n+    """Migrate content created with collective.folderishtypes to plone.volto."""\n+    interface = "collective.folderishtypes.interfaces.IFolderishType"\n+    idxs = [\n+        "object_provides",\n+    ]\n+    brains = api.content.find(object_provides=interface)\n+    total_brains = len(brains)\n+    logger.info(f"Migration: {total_brains} contents to be migrated.")\n+    for idx, brain in enumerate(brains):\n+        content = brain.getObject()\n+        content_id = content.getId()\n+        content.__class__ = MIGRATION[content.portal_type]\n+        parent = content.aq_parent\n+        parent._delOb(content_id)\n+        parent._setOb(content_id, content)\n+        content = parent[content_id]\n+        content.reindexObject(idxs=idxs)\n+\n+        if idx and idx % 100 == 0:\n+            logger.info(f"Migration: {idx + 1} / {total_brains}")\n+\n+    logger.info("Migration from collective.folderishtypes to plone.volto complete")\n \n \n def from12to13_migrate_listings(context):\ndiff --git a/src/plone/volto/upgrades.zcml b/src/plone/volto/upgrades.zcml\nindex 468b808..ffbb174 100644\n--- a/src/plone/volto/upgrades.zcml\n+++ b/src/plone/volto/upgrades.zcml\n@@ -21,4 +21,20 @@\n       import_steps="catalog"\n       />\n \n+  <genericsetup:upgradeDepends\n+      title="Move from c.folderishtypes to local"\n+      profile="plone.volto:default"\n+      source="1012"\n+      destination="1013"\n+      import_steps="typeinfo"\n+      />\n+\n+  <genericsetup:upgradeStep\n+      title="Migrate existing content classes from old c.folderishtypes to local"\n+      profile="plone.volto:default"\n+      source="1013"\n+      destination="1014"\n+      handler=".upgrades.migrate_content_classes"\n+      />\n+\n </configure>\n'

