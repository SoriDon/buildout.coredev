Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-05-06T20:01:01+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/16f2556611db8e38ac6d94c73c3f010cdd79b6db

Explicitly include zcml of more packages. (#3525)

* Explicitly include zcml of more packages.

Part of https://github.com/plone/Products.CMFPlone/issues/3188.

Also reorder the zcml loading more logically.
Require `plone.resource`: this is used by various packages, but only required by `plone.staticresources`, which did not seem right to me.

* Fix order of loading zcml.

* Do not try to load zcml for most optional packages.

It gives problems in the tests.  Before, their zcml was loaded by autoinclude, which does not happen in the tests.

It mostly seems plone.app.caching that causes strange errors:

```
1

  File "/srv/python3.9/lib/python3.9/unittest/case.py", line 59, in testPartExecutor
    yield
  File "/srv/python3.9/lib/python3.9/unittest/case.py", line 592, in run
    self._callTestMethod(testMethod)
  File "/srv/python3.9/lib/python3.9/unittest/case.py", line 550, in _callTestMethod
    method()
  File "/home/jenkins/workspace/pull-request-6.0-3.9/src/plone.app.content/plone/app/content/tests/test_widgets.py", line 642, in testGetMimeIcon
    self.portal.invokeFactory("File", id="my-file", title="My file")
  File "/home/jenkins/.buildout/eggs/cp39/plone.dexterity-3.0.0a2-py3.9.egg/plone/dexterity/content.py", line 830, in invokeFactory
    return super(Container, self).invokeFactory(
  File "/home/jenkins/.buildout/eggs/cp39/Products.CMFCore-2.5.4-py3.9.egg/Products/CMFCore/PortalFolder.py", line 299, in invokeFactory
    return ttool.constructContent(type_name, self, id, RESPONSE,
  File "/home/jenkins/.buildout/eggs/cp39/Products.CMFCore-2.5.4-py3.9.egg/Products/CMFCore/TypesTool.py", line 809, in constructContent
    ob = info.constructInstance(container, id, *args, **kw)
  File "/home/jenkins/.buildout/eggs/cp39/Products.CMFCore-2.5.4-py3.9.egg/Products/CMFCore/TypesTool.py", line 308, in constructInstance
    return self._constructInstance(container, id, *args, **kw)
  File "/home/jenkins/.buildout/eggs/cp39/Products.CMFCore-2.5.4-py3.9.egg/Products/CMFCore/TypesTool.py", line 570, in _constructInstance
    rval = container._setObject(id, obj)
  File "/home/jenkins/.buildout/eggs/cp39/Products.BTreeFolder2-4.3-py3.9.egg/Products/BTreeFolder2/BTreeFolder2.py", line 465, in _setObject
    notify(ObjectAddedEvent(ob, self, id))
  File "/home/jenkins/.buildout/eggs/cp39/zope.event-4.5.0-py3.9.egg/zope/event/__init__.py", line 32, in notify
    subscriber(event)
  File "/home/jenkins/.buildout/eggs/cp39/zope.component-5.0.1-py3.9.egg/zope/component/event.py", line 27, in dispatch
    component_subscribers(event, None)
  File "/home/jenkins/.buildout/eggs/cp39/zope.component-5.0.1-py3.9.egg/zope/component/_api.py", line 134, in subscribers
    return sitemanager.subscribers(objects, interface)
  File "/home/jenkins/.buildout/eggs/cp39/zope.interface-5.4.0-py3.9-linux-x86_64.egg/zope/interface/registry.py", line 448, in subscribers
    return self.adapters.subscribers(objects, provided)
  File "/home/jenkins/.buildout/eggs/cp39/zope.interface-5.4.0-py3.9-linux-x86_64.egg/zope/interface/adapter.py", line 899, in subscribers
    subscription(*objects)
  File "/home/jenkins/.buildout/eggs/cp39/zope.component-5.0.1-py3.9.egg/zope/component/event.py", line 36, in objectEventNotify
    component_subscribers((event.object, event), None)
  File "/home/jenkins/.buildout/eggs/cp39/zope.component-5.0.1-py3.9.egg/zope/component/_api.py", line 134, in subscribers
    return sitemanager.subscribers(objects, interface)
  File "/home/jenkins/.buildout/eggs/cp39/zope.interface-5.4.0-py3.9-linux-x86_64.egg/zope/interface/registry.py", line 448, in subscribers
    return self.adapters.subscribers(objects, provided)
  File "/home/jenkins/.buildout/eggs/cp39/zope.interface-5.4.0-py3.9-linux-x86_64.egg/zope/interface/adapter.py", line 899, in subscribers
    subscription(*objects)
  File "/home/jenkins/workspace/pull-request-6.0-3.9/src/plone.app.caching/plone/app/caching/purge.py", line 241, in purgeOnMovedOrRemoved
    and "delete_confirmation" in request.URL
  File "/home/jenkins/.buildout/eggs/cp39/zope.publisher-6.1.0-py3.9.egg/zope/publisher/http.py", line 219, in __getitem__
    raise KeyError(name)
```

Here request is apparently something weird that throws this KeyError whey you try to access its URL attribute.

Files changed:
A news/3188.bugfix
M Products/CMFPlone/configure.zcml
M Products/CMFPlone/controlpanel/configure.zcml
M Products/CMFPlone/meta.zcml
M Products/CMFPlone/overrides.zcml
M setup.py

b'diff --git a/Products/CMFPlone/configure.zcml b/Products/CMFPlone/configure.zcml\nindex 6a4901f637..96a76b4c51 100644\n--- a/Products/CMFPlone/configure.zcml\n+++ b/Products/CMFPlone/configure.zcml\n@@ -5,54 +5,70 @@\n            xmlns:i18n="http://namespaces.zope.org/i18n"\n            i18n_domain="plone">\n \n+  <!-- basic zope/cmf -->\n   <include package="zope.app.locales" />\n   <include package="Products.CMFCore" />\n   <include package="Products.GenericSetup" />\n-  <include package="plone.app.contentmenu" />\n+\n+  <!-- Our controlpanel config defines several permissions, so load it early. -->\n+  <include package=".controlpanel" />\n+\n+  <!-- plone.* -->\n+  <include package="plone.batching" />\n+  <include package="plone.browserlayer" />\n+  <include package="plone.contentrules" />\n+  <include package="plone.dexterity" />\n+  <include package="plone.folder" />\n+  <include package="plone.i18n" />\n+  <include package="plone.indexer" />\n+  <include package="plone.locking" />\n+  <include package="plone.memoize" />\n+  <include package="plone.outputfilters" />\n+  <include package="plone.portlets" />\n+  <include package="plone.protect" />\n+  <include package="plone.registry" />\n+  <include package="plone.resource" />\n+  <include package="plone.schema" />\n+  <include package="plone.session" />\n+  <include package="plone.staticresources" />\n+  <include package="plone.subrequest" />\n+  <include package="plone.theme" />\n+\n+  <!-- plone.app.* -->\n   <include package="plone.app.content" />\n+  <include package="plone.app.contentlisting" />\n+  <include package="plone.app.contentmenu" />\n   <include package="plone.app.contentrules" />\n   <include package="plone.app.contenttypes" />\n   <include package="plone.app.customerize" />\n+  <include package="plone.app.dexterity" />\n   <include package="plone.app.discussion" />\n   <include package="plone.app.i18n" />\n   <include package="plone.app.layout" />\n   <include package="plone.app.linkintegrity" />\n   <include package="plone.app.locales" />\n+  <include package="plone.app.multilingual" />\n   <include package="plone.app.portlets" />\n   <include package="plone.app.redirector" />\n   <include package="plone.app.registry" />\n   <include package="plone.app.theming" />\n-  <include zcml:condition="installed plone.app.upgrade" package="plone.app.upgrade" />\n   <include package="plone.app.users" />\n   <include package="plone.app.uuid" />\n   <include package="plone.app.viewletmanager" />\n   <include package="plone.app.vocabularies" />\n   <include package="plone.app.workflow" />\n-  <include package="plone.batching" />\n-  <include package="plone.dexterity" />\n-  <include package="plone.memoize" />\n-  <include package="plone.outputfilters" />\n-  <include package="plone.session" />\n-  <include package="plone.protect" />\n-  <include package="plone.indexer" />\n-\n-  <include package="plone.staticresources" />\n \n-  <!-- viewlets zope 3 layers support for themes -->\n-  <include package="plone.browserlayer" />\n-  <include package="plone.theme" />\n+  <!-- plone extra -->\n+  <include package="plone.portlet.static" />\n+  <include package="plone.portlet.collection" />\n+  <include package="plonetheme.barceloneta" />\n \n-  <!-- multilingual -->\n-  <include package="plone.app.multilingual" />\n+  <!-- conditional -->\n+  <include zcml:condition="installed plone.app.upgrade" package="plone.app.upgrade" />\n \n-  <include package=".controlpanel" />\n   <include package=".resources" />\n   <include package=".patterns" />\n \n-  <!-- extra portlets -->\n-  <include package="plone.portlet.static" />\n-  <include package="plone.portlet.collection" />\n-\n   <!-- local role PAS plugin -->\n   <include package="borg.localrole" />\n   <include package="borg.localrole"\ndiff --git a/Products/CMFPlone/controlpanel/configure.zcml b/Products/CMFPlone/controlpanel/configure.zcml\nindex 86f75133c2..c25bb55caa 100644\n--- a/Products/CMFPlone/controlpanel/configure.zcml\n+++ b/Products/CMFPlone/controlpanel/configure.zcml\n@@ -2,12 +2,10 @@\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:five="http://namespaces.zope.org/five">\n \n+  <include file="permissions.zcml" />\n   <include package="plone.app.registry" />\n-\n   <include package=".bbb" />\n   <include package=".browser" />\n-\n   <include file="events.zcml" />\n-  <include file="permissions.zcml" />\n \n </configure>\ndiff --git a/Products/CMFPlone/meta.zcml b/Products/CMFPlone/meta.zcml\nindex 23422680dc..4f7b7c53a9 100644\n--- a/Products/CMFPlone/meta.zcml\n+++ b/Products/CMFPlone/meta.zcml\n@@ -23,7 +23,12 @@\n     <include package="Products.CMFCore" file="meta.zcml" />\n     <include package="Products.GenericSetup" file="meta.zcml" />\n \n+    <include package="plone.dexterity" file="meta.zcml" />\n+    <include package="plone.resource" file="meta.zcml" />\n+    <include package="plone.app.dexterity" file="meta.zcml" />\n     <include package="plone.app.portlets" file="meta.zcml" />\n+    <include package="plone.contentrules" file="meta.zcml" />\n+    <include package="plone.session" file="meta.zcml" />\n \n     <!-- plone.autoinclude\'s `autoIncludePlugins` directive finds\n          and executes ZCML files from any installed packages\ndiff --git a/Products/CMFPlone/overrides.zcml b/Products/CMFPlone/overrides.zcml\nindex 27f8494efe..f756997d4f 100644\n--- a/Products/CMFPlone/overrides.zcml\n+++ b/Products/CMFPlone/overrides.zcml\n@@ -4,8 +4,11 @@\n            i18n_domain="plone">\n \n     <include package="Products.CMFCore" file="overrides.zcml" />\n+    <include package="five.localsitemanager" file="overrides.zcml" />\n     <include package="plone.i18n" file="overrides.zcml" />\n     <include package="plone.app.portlets" file="overrides.zcml" />\n+    <include package="plone.app.multilingual" file="overrides.zcml" />\n+    <include package="plone.app.dexterity" file="overrides.zcml" />\n \n     <utility\n         provides="Products.PageTemplates.interfaces.IUnicodeEncodingConflictResolver"\ndiff --git a/news/3188.bugfix b/news/3188.bugfix\nnew file mode 100644\nindex 0000000000..e2d2797361\n--- /dev/null\n+++ b/news/3188.bugfix\n@@ -0,0 +1,4 @@\n+Explicitly include zcml of more packages.\n+Reorder the zcml loading.\n+Require ``plone.resource``.\n+[maurits]\ndiff --git a/setup.py b/setup.py\nindex 0e9b3918f2..e05ac0bbfc 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -82,6 +82,7 @@\n         \'plone.portlets\',\n         \'plone.protect >= 3.0.0\',\n         \'plone.registry\',\n+        \'plone.resource\',\n         \'plone.schema\',\n         \'plone.session\',\n         \'plone.staticresources\',\n'

