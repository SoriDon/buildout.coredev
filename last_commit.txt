Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-07-19T09:11:54+02:00
Author: ksuess (ksuess) <k.suess@rohberg.ch>
Commit: https://github.com/plone/plone.restapi/commit/0f687b189487bd6f5b54282595da4b69126f3b37

Fix of users endpoint for Membrane users.

acl_users.searchUsers fails for id=None

Files changed:
A news/1459.bugfix
M src/plone/restapi/services/users/get.py

b'diff --git a/news/1459.bugfix b/news/1459.bugfix\nnew file mode 100644\nindex 000000000..f281b0331\n--- /dev/null\n+++ b/news/1459.bugfix\n@@ -0,0 +1 @@\n+Fix of users endpoint for Membrane users. [ksuess]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/services/users/get.py b/src/plone/restapi/services/users/get.py\nindex 4bc5271f4..4bdda66c5 100644\n--- a/src/plone/restapi/services/users/get.py\n+++ b/src/plone/restapi/services/users/get.py\n@@ -63,8 +63,8 @@ def _principal_search_results(\n \n         return principals\n \n-    def _get_users(self):\n-        results = {user["userid"] for user in self.acl_users.searchUsers()}\n+    def _get_users(self, **kw):\n+        results = {user["userid"] for user in self.acl_users.searchUsers(**kw)}\n         users = [self.portal_membership.getMemberById(userid) for userid in results]\n         return self._sort_users(users)\n \n@@ -103,14 +103,19 @@ def _get_filtered_users(self, query, groups_filter, search_term, limit):\n         if search_term:\n             users = self._user_search_results()\n         else:\n-            results = self.acl_users.searchUsers(id=query, max_results=limit)\n-            users = [\n-                self.portal_membership.getMemberById(user["userid"]) for user in results\n-            ]\n+            kw = {}\n+            if query:\n+                kw["id"] = query\n+                # No max_results if groups_filter\n+                if limit:\n+                    kw["max_results"] = limit\n+            users = self._get_users(**kw)\n+\n         if groups_filter:\n             users = [\n                 user for user in users if set(user.getGroups()) & set(groups_filter)\n             ]\n+        users = limit and users[:limit] or users\n         return self._sort_users(users)\n \n     def has_permission_to_query(self):\n@@ -131,7 +136,7 @@ def reply(self):\n         if len(self.query) > 0 and len(self.params) == 0:\n             query = self.query.get("query", "")\n             groups_filter = self.query.get("groups-filter:list", [])\n-            limit = self.query.get("limit", [DEFAULT_SEARCH_RESULTS_LIMIT])[0]\n+            limit = int(self.query.get("limit", [DEFAULT_SEARCH_RESULTS_LIMIT])[0])\n             if query or groups_filter or self.search_term or limit:\n                 if self.has_permission_to_query():\n                     users = self._get_filtered_users(\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-07-19T09:36:10+02:00
Author: ksuess (ksuess) <k.suess@rohberg.ch>
Commit: https://github.com/plone/plone.restapi/commit/c773cd5c4f1c29d557fb27c6e44576695c2eea92

Update translated_messages_addons.resp

Files changed:
M docs/source/conf.py
M src/plone/restapi/tests/http-examples/translated_messages_addons.resp
M src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp

b'diff --git a/docs/source/conf.py b/docs/source/conf.py\nindex c7261d9fe..f875873b0 100644\n--- a/docs/source/conf.py\n+++ b/docs/source/conf.py\n@@ -32,7 +32,7 @@\n # built documents.\n # TODO: There must be a way to import this from `setup.py` so we don\'t have to\n # update it manually for each release.\n-version = "8.21.3.dev0"\n+version = "8.24.1.dev0"\n release = version\n \n # -- General configuration ----------------------------------------------------\ndiff --git a/src/plone/restapi/tests/http-examples/translated_messages_addons.resp b/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\nindex a9de8d8b2..52de69ced 100644\n--- a/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\n+++ b/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\n@@ -73,7 +73,7 @@ Content-Type: application/json\n                 "newVersion": "0006",\n                 "required": false\n             },\n-            "version": "8.23.1.dev0"\n+            "version": "8.24.1.dev0"\n         },\n         {\n             "@id": "http://localhost:55001/plone/@addons/plone.session",\ndiff --git a/src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp b/src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp\nindex 683549cf9..60387b328 100644\n--- a/src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp\n+++ b/src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp\n@@ -40,7 +40,7 @@ Content-Type: application/json\n     "language": "",\n     "layout": "document_view",\n     "lock": {\n-        "created": "1995-07-31T17:30:00",\n+        "created": "1995-07-31T19:30:00",\n         "creator": "admin",\n         "creator_name": "admin",\n         "creator_url": "http://localhost:55001/plone/author/admin",\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-07-19T10:00:48+02:00
Author: ksuess (ksuess) <k.suess@rohberg.ch>
Commit: https://github.com/plone/plone.restapi/commit/37568f4447a2729acf101709b5559a25dcfe3fe7

Update workingcopy_baseline_get.resp

Files changed:
M src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp

b'diff --git a/src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp b/src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp\nindex 60387b328..683549cf9 100644\n--- a/src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp\n+++ b/src/plone/restapi/tests/http-examples/workingcopy_baseline_get.resp\n@@ -40,7 +40,7 @@ Content-Type: application/json\n     "language": "",\n     "layout": "document_view",\n     "lock": {\n-        "created": "1995-07-31T19:30:00",\n+        "created": "1995-07-31T17:30:00",\n         "creator": "admin",\n         "creator_name": "admin",\n         "creator_url": "http://localhost:55001/plone/author/admin",\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-08-01T09:52:47+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.restapi/commit/311d00924ca8923a52232ff349ca22b68f409938

Merge pull request #1460 from plone/fix-users-endpoint-for-membrane-users

Fix of users endpoint for Membrane users.

Files changed:
A news/1459.bugfix
M docs/source/conf.py
M src/plone/restapi/services/users/get.py
M src/plone/restapi/tests/http-examples/translated_messages_addons.resp

b'diff --git a/docs/source/conf.py b/docs/source/conf.py\nindex c7261d9fe..f875873b0 100644\n--- a/docs/source/conf.py\n+++ b/docs/source/conf.py\n@@ -32,7 +32,7 @@\n # built documents.\n # TODO: There must be a way to import this from `setup.py` so we don\'t have to\n # update it manually for each release.\n-version = "8.21.3.dev0"\n+version = "8.24.1.dev0"\n release = version\n \n # -- General configuration ----------------------------------------------------\ndiff --git a/news/1459.bugfix b/news/1459.bugfix\nnew file mode 100644\nindex 000000000..f281b0331\n--- /dev/null\n+++ b/news/1459.bugfix\n@@ -0,0 +1 @@\n+Fix of users endpoint for Membrane users. [ksuess]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/services/users/get.py b/src/plone/restapi/services/users/get.py\nindex 4bc5271f4..4bdda66c5 100644\n--- a/src/plone/restapi/services/users/get.py\n+++ b/src/plone/restapi/services/users/get.py\n@@ -63,8 +63,8 @@ def _principal_search_results(\n \n         return principals\n \n-    def _get_users(self):\n-        results = {user["userid"] for user in self.acl_users.searchUsers()}\n+    def _get_users(self, **kw):\n+        results = {user["userid"] for user in self.acl_users.searchUsers(**kw)}\n         users = [self.portal_membership.getMemberById(userid) for userid in results]\n         return self._sort_users(users)\n \n@@ -103,14 +103,19 @@ def _get_filtered_users(self, query, groups_filter, search_term, limit):\n         if search_term:\n             users = self._user_search_results()\n         else:\n-            results = self.acl_users.searchUsers(id=query, max_results=limit)\n-            users = [\n-                self.portal_membership.getMemberById(user["userid"]) for user in results\n-            ]\n+            kw = {}\n+            if query:\n+                kw["id"] = query\n+                # No max_results if groups_filter\n+                if limit:\n+                    kw["max_results"] = limit\n+            users = self._get_users(**kw)\n+\n         if groups_filter:\n             users = [\n                 user for user in users if set(user.getGroups()) & set(groups_filter)\n             ]\n+        users = limit and users[:limit] or users\n         return self._sort_users(users)\n \n     def has_permission_to_query(self):\n@@ -131,7 +136,7 @@ def reply(self):\n         if len(self.query) > 0 and len(self.params) == 0:\n             query = self.query.get("query", "")\n             groups_filter = self.query.get("groups-filter:list", [])\n-            limit = self.query.get("limit", [DEFAULT_SEARCH_RESULTS_LIMIT])[0]\n+            limit = int(self.query.get("limit", [DEFAULT_SEARCH_RESULTS_LIMIT])[0])\n             if query or groups_filter or self.search_term or limit:\n                 if self.has_permission_to_query():\n                     users = self._get_filtered_users(\ndiff --git a/src/plone/restapi/tests/http-examples/translated_messages_addons.resp b/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\nindex a9de8d8b2..52de69ced 100644\n--- a/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\n+++ b/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\n@@ -73,7 +73,7 @@ Content-Type: application/json\n                 "newVersion": "0006",\n                 "required": false\n             },\n-            "version": "8.23.1.dev0"\n+            "version": "8.24.1.dev0"\n         },\n         {\n             "@id": "http://localhost:55001/plone/@addons/plone.session",\n'

