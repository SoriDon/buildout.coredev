Repository: plone.app.content


Branch: refs/heads/master
Date: 2019-10-15T22:23:22+02:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/plone.app.content/commit/13f331620ddd9b94a3664d64e467060bc6abda9d

Follow default_page_types setting when showing the items that can be selected as default page

Files changed:
A news/182.bugfix
M plone/app/content/browser/selection.py
M plone/app/content/tests/test_selectdefaultpage.py

b'diff --git a/news/182.bugfix b/news/182.bugfix\nnew file mode 100644\nindex 0000000..7303a98\n--- /dev/null\n+++ b/news/182.bugfix\n@@ -0,0 +1 @@\n+Follow default_page_types setting when showing the items that can be selected as default page [erral]\n\\ No newline at end of file\ndiff --git a/plone/app/content/browser/selection.py b/plone/app/content/browser/selection.py\nindex 057eae1..89ac24f 100644\n--- a/plone/app/content/browser/selection.py\n+++ b/plone/app/content/browser/selection.py\n@@ -125,5 +125,6 @@ def get_selectable_items(self):\n                     # Disallow folderish types if you can\'t add any content.\n                     # To override you have to add type to default_page_types\n                     continue\n-            results.append(brain)\n+\n+                results.append(brain)\n         return results\ndiff --git a/plone/app/content/tests/test_selectdefaultpage.py b/plone/app/content/tests/test_selectdefaultpage.py\nindex 76779f4..b287dc0 100644\n--- a/plone/app/content/tests/test_selectdefaultpage.py\n+++ b/plone/app/content/tests/test_selectdefaultpage.py\n@@ -18,6 +18,10 @@\n             \'title\': \'Test Document\',\n             \'description\': \'Test Document Description\'}\n \n+NEWSITEM = {\'id\': \'testnews\',\n+            \'title\': \'Test News Item\',\n+            \'description\': \'Test News Item Description\'}\n+\n \n class SelectDefaultPageDXTestCase(unittest.TestCase):\n \n@@ -59,6 +63,16 @@ def _createDocument(self, context):\n         # doc.setExcludeFromNav(True)\n         return doc\n \n+    def _createNewsItem(self, context):\n+        context.invokeFactory(id=NEWSITEM[\'id\'], type_name=\'News Item\')\n+        doc = getattr(context, NEWSITEM[\'id\'])\n+        doc.setTitle(NEWSITEM[\'title\'])\n+        doc.setDescription(NEWSITEM[\'description\'])\n+        doc.reindexObject()\n+        # we don\'t want it in the navigation\n+        # doc.setExcludeFromNav(True)\n+        return doc\n+\n     def _create_structure(self):\n         setRoles(self.portal, TEST_USER_ID, [\'Manager\'])\n         folder = self._createFolder()\n@@ -111,6 +125,16 @@ def test_default_page_action_save(self):\n         self.assertEqual(self.browser.url, folder.absolute_url())\n         self.assertEqual(folder.getDefaultPage(), \'testdoc\')\n \n+    def test_selectable_types_filter(self):\n+        self.portal.portal_registry[\'plone.default_page_types\'] = [u\'News Item\']\n+        folder = self.portal.testfolder\n+        self._createNewsItem(folder)\n+\n+        view = folder.restrictedTraverse(\'@@select_default_page\')()\n+        self.assertTrue(\'id="testdoc"\' not in view)\n+        self.assertTrue(\'id="testnews"\' in view)\n+\n+\n \n if HAS_AT:\n     class SelectDefaultPageATTestCase(SelectDefaultPageDXTestCase):\n'

Repository: plone.app.content


Branch: refs/heads/master
Date: 2019-10-15T23:52:06+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.content/commit/7d51404f6db2d4826c184c1816c65674e851917e

Merge pull request #184 from plone/erral-issue-182

Follow default_page_types setting when showing the items that can be selected as default page

Files changed:
A news/182.bugfix
M plone/app/content/browser/selection.py
M plone/app/content/tests/test_selectdefaultpage.py

b'diff --git a/news/182.bugfix b/news/182.bugfix\nnew file mode 100644\nindex 0000000..7303a98\n--- /dev/null\n+++ b/news/182.bugfix\n@@ -0,0 +1 @@\n+Follow default_page_types setting when showing the items that can be selected as default page [erral]\n\\ No newline at end of file\ndiff --git a/plone/app/content/browser/selection.py b/plone/app/content/browser/selection.py\nindex 057eae1..89ac24f 100644\n--- a/plone/app/content/browser/selection.py\n+++ b/plone/app/content/browser/selection.py\n@@ -125,5 +125,6 @@ def get_selectable_items(self):\n                     # Disallow folderish types if you can\'t add any content.\n                     # To override you have to add type to default_page_types\n                     continue\n-            results.append(brain)\n+\n+                results.append(brain)\n         return results\ndiff --git a/plone/app/content/tests/test_selectdefaultpage.py b/plone/app/content/tests/test_selectdefaultpage.py\nindex 76779f4..b287dc0 100644\n--- a/plone/app/content/tests/test_selectdefaultpage.py\n+++ b/plone/app/content/tests/test_selectdefaultpage.py\n@@ -18,6 +18,10 @@\n             \'title\': \'Test Document\',\n             \'description\': \'Test Document Description\'}\n \n+NEWSITEM = {\'id\': \'testnews\',\n+            \'title\': \'Test News Item\',\n+            \'description\': \'Test News Item Description\'}\n+\n \n class SelectDefaultPageDXTestCase(unittest.TestCase):\n \n@@ -59,6 +63,16 @@ def _createDocument(self, context):\n         # doc.setExcludeFromNav(True)\n         return doc\n \n+    def _createNewsItem(self, context):\n+        context.invokeFactory(id=NEWSITEM[\'id\'], type_name=\'News Item\')\n+        doc = getattr(context, NEWSITEM[\'id\'])\n+        doc.setTitle(NEWSITEM[\'title\'])\n+        doc.setDescription(NEWSITEM[\'description\'])\n+        doc.reindexObject()\n+        # we don\'t want it in the navigation\n+        # doc.setExcludeFromNav(True)\n+        return doc\n+\n     def _create_structure(self):\n         setRoles(self.portal, TEST_USER_ID, [\'Manager\'])\n         folder = self._createFolder()\n@@ -111,6 +125,16 @@ def test_default_page_action_save(self):\n         self.assertEqual(self.browser.url, folder.absolute_url())\n         self.assertEqual(folder.getDefaultPage(), \'testdoc\')\n \n+    def test_selectable_types_filter(self):\n+        self.portal.portal_registry[\'plone.default_page_types\'] = [u\'News Item\']\n+        folder = self.portal.testfolder\n+        self._createNewsItem(folder)\n+\n+        view = folder.restrictedTraverse(\'@@select_default_page\')()\n+        self.assertTrue(\'id="testdoc"\' not in view)\n+        self.assertTrue(\'id="testnews"\' in view)\n+\n+\n \n if HAS_AT:\n     class SelectDefaultPageATTestCase(SelectDefaultPageDXTestCase):\n'

