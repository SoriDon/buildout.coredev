Repository: Products.CMFFormController


Branch: refs/heads/master
Date: 2016-01-25T16:37:27+01:00
Author: Fred van Dijk (fredvd) <fredvd@gmail.com>
Commit: https://github.com/plone/Products.CMFFormController/commit/c0b6654a6d4c6f18260e94c4d7c71165c140bde8

Move patch from plone.protect 3.x to Actions.RedirectTo
so it allows ATContentTypes add forms to append auth token

Files changed:
M CHANGES.txt
M Products/CMFFormController/Actions/RedirectTo.py

diff --git a/CHANGES.txt b/CHANGES.txt
index d12c078..845a20e 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,8 +4,9 @@ Changelog
 3.0.6 (unreleased)
 ------------------
 
-- Nothing changed yet.
-
+- Move patch from plone.protect 3.x to Actions.RedirectTo so it allows ATContentTypes add forms to append auth token.
+  Issue https://github.com/plone/Products.CMFPlone/issues/1335
+  [staeff, fredvd]
 
 3.0.5 (2015-06-05)
 ------------------
diff --git a/Products/CMFFormController/Actions/RedirectTo.py b/Products/CMFFormController/Actions/RedirectTo.py
index 6eec8e5..ee9f11b 100644
--- a/Products/CMFFormController/Actions/RedirectTo.py
+++ b/Products/CMFFormController/Actions/RedirectTo.py
@@ -16,7 +16,19 @@ def __call__(self, controller_state):
             # No host specified, so url is relative.  Get an absolute url.
             url = urljoin(context.absolute_url()+'/', url)
         url = self.updateQuery(url, controller_state.kwargs)
-        return context.REQUEST.RESPONSE.redirect(url)
+        request = context.REQUEST
+        # this is mostly just for archetypes edit forms...
+        if 'edit' in url and '_authenticator' not in url and \
+                '_authenticator' in request.form:
+            if '?' in url:
+                url += '&'
+            else:
+                url += '?'
+            auth = request.form['_authenticator']
+            if isinstance(auth, list):
+                auth = auth[0]
+            url += '_authenticator=' + auth
+        return request.RESPONSE.redirect(url)
 
 
 registerFormAction('redirect_to',


Repository: Products.CMFFormController


Branch: refs/heads/master
Date: 2016-08-30T19:46:31+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFFormController/commit/67c1514e873d458eadcbd3acd8b82bc535c55c73

Merge remote-tracking branch 'origin/remove-ploneprotect-monkeypatch' into remove-ploneprotect-monkeypatch-master

We will keep the previous branch for merging with the 3.0.x branch.

Files changed:
M CHANGES.rst
M Products/CMFFormController/Actions/RedirectTo.py

diff --git a/CHANGES.rst b/CHANGES.rst
index edbd86c..fab5f88 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,7 @@ Changelog
 3.1.2 (unreleased)
 ------------------
 
+
 Breaking changes:
 
 - *add item here*
@@ -14,7 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Move patch from plone.protect 3.x to Actions.RedirectTo so it allows ATContentTypes add forms to append auth token.
+  Issue https://github.com/plone/Products.CMFPlone/issues/1335
+  [staeff, fredvd]
 
 
 3.1.1 (2016-08-12)
diff --git a/Products/CMFFormController/Actions/RedirectTo.py b/Products/CMFFormController/Actions/RedirectTo.py
index 6eec8e5..ee9f11b 100644
--- a/Products/CMFFormController/Actions/RedirectTo.py
+++ b/Products/CMFFormController/Actions/RedirectTo.py
@@ -16,7 +16,19 @@ def __call__(self, controller_state):
             # No host specified, so url is relative.  Get an absolute url.
             url = urljoin(context.absolute_url()+'/', url)
         url = self.updateQuery(url, controller_state.kwargs)
-        return context.REQUEST.RESPONSE.redirect(url)
+        request = context.REQUEST
+        # this is mostly just for archetypes edit forms...
+        if 'edit' in url and '_authenticator' not in url and \
+                '_authenticator' in request.form:
+            if '?' in url:
+                url += '&'
+            else:
+                url += '?'
+            auth = request.form['_authenticator']
+            if isinstance(auth, list):
+                auth = auth[0]
+            url += '_authenticator=' + auth
+        return request.RESPONSE.redirect(url)
 
 
 registerFormAction('redirect_to',


Repository: Products.CMFFormController


Branch: refs/heads/master
Date: 2016-08-31T00:22:46+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFFormController/commit/ab1a3b0f45655d9f132ffc1498d0284b9ead231b

Merge pull request #7 from plone/remove-ploneprotect-monkeypatch-master

Take over plone.protect RedirectTo patch [master]

Files changed:
M CHANGES.rst
M Products/CMFFormController/Actions/RedirectTo.py

diff --git a/CHANGES.rst b/CHANGES.rst
index edbd86c..fab5f88 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,7 @@ Changelog
 3.1.2 (unreleased)
 ------------------
 
+
 Breaking changes:
 
 - *add item here*
@@ -14,7 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Move patch from plone.protect 3.x to Actions.RedirectTo so it allows ATContentTypes add forms to append auth token.
+  Issue https://github.com/plone/Products.CMFPlone/issues/1335
+  [staeff, fredvd]
 
 
 3.1.1 (2016-08-12)
diff --git a/Products/CMFFormController/Actions/RedirectTo.py b/Products/CMFFormController/Actions/RedirectTo.py
index 6eec8e5..ee9f11b 100644
--- a/Products/CMFFormController/Actions/RedirectTo.py
+++ b/Products/CMFFormController/Actions/RedirectTo.py
@@ -16,7 +16,19 @@ def __call__(self, controller_state):
             # No host specified, so url is relative.  Get an absolute url.
             url = urljoin(context.absolute_url()+'/', url)
         url = self.updateQuery(url, controller_state.kwargs)
-        return context.REQUEST.RESPONSE.redirect(url)
+        request = context.REQUEST
+        # this is mostly just for archetypes edit forms...
+        if 'edit' in url and '_authenticator' not in url and \
+                '_authenticator' in request.form:
+            if '?' in url:
+                url += '&'
+            else:
+                url += '?'
+            auth = request.form['_authenticator']
+            if isinstance(auth, list):
+                auth = auth[0]
+            url += '_authenticator=' + auth
+        return request.RESPONSE.redirect(url)
 
 
 registerFormAction('redirect_to',


