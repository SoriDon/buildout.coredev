Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-03-25T01:09:18+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/eb9450d0156c9aac04d5a6e6fabe88a78993e25a

Removed no longer used password_form.pt and plone_change_password.py.

No longer register now empty skin layers `plone_prefs` and `plone_form_scripts`.

Fixes https://github.com/plone/Products.CMFPlone/issues/3240

Files changed:
A news/3240.bugfix
M Products/CMFPlone/profiles/default/skins.xml
M Products/CMFPlone/tests/testControlPanelScripts.py
D Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py
D Products/CMFPlone/skins/plone_prefs/password_form.pt
D Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata

b'diff --git a/Products/CMFPlone/profiles/default/skins.xml b/Products/CMFPlone/profiles/default/skins.xml\nindex b8be444eff..0a115c2ebc 100644\n--- a/Products/CMFPlone/profiles/default/skins.xml\n+++ b/Products/CMFPlone/profiles/default/skins.xml\n@@ -3,12 +3,8 @@\n    cookie_persistence="False" default_skin="Plone Default"\n    request_varname="plone_skin">\n  <object name="custom" meta_type="Folder"/>\n- <object name="plone_form_scripts" meta_type="Filesystem Directory View"\n-    directory="Products.CMFPlone:skins/plone_form_scripts"/>\n  <object name="plone_images" meta_type="Filesystem Directory View"\n     directory="Products.CMFPlone:skins/plone_images"/>\n- <object name="plone_prefs" meta_type="Filesystem Directory View"\n-    directory="Products.CMFPlone:skins/plone_prefs"/>\n  <object name="plone_scripts" meta_type="Filesystem Directory View"\n     directory="Products.CMFPlone:skins/plone_scripts"/>\n  <object name="plone_templates" meta_type="Filesystem Directory View"\n@@ -18,9 +14,7 @@\n  <skin-path name="Plone Default">\n   <layer name="custom"/>\n   <layer name="plone_wysiwyg"/>\n-  <layer name="plone_prefs"/>\n   <layer name="plone_templates"/>\n-  <layer name="plone_form_scripts"/>\n   <layer name="plone_scripts"/>\n   <layer name="plone_images"/>\n  </skin-path>\ndiff --git a/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py b/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py\ndeleted file mode 100644\nindex 77a5ee90b0..0000000000\n--- a/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py\n+++ /dev/null\n@@ -1,54 +0,0 @@\n-## Script (Python) "plone_change_password"\n-##bind container=container\n-##bind context=context\n-##bind namespace=\n-##bind script=script\n-##bind subpath=traverse_subpath\n-##title=Action to change password\n-##parameters=password, password_confirm, current, domains=None\n-\n-from Products.CMFPlone import PloneMessageFactory as _\n-\n-REQUEST = context.REQUEST\n-if \'cancel\' in REQUEST.form:\n-    context.plone_utils.addPortalMessage(_(\'Password change was canceled.\'),\n-                                         \'warning\')\n-    return context.REQUEST.RESPONSE.redirect(\n-            \'%s/@@personal-preferences\' % context.absolute_url())\n-\n-mt = context.portal_membership\n-\n-if not mt.testCurrentPassword(current):\n-    failMessage = _(\'Does not match current password.\')\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-failMessage = context.portal_registration \\\n-                    .testPasswordValidity(password, password_confirm)\n-if failMessage:\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-member = mt.getAuthenticatedMember()\n-try:\n-    mt.setPassword(password, domains, REQUEST=context.REQUEST)\n-except AttributeError:\n-    failMessage = _(\'While changing your password an AttributeError \'\n-                    \'occurred. This is usually caused by your user being \'\n-                    \'defined outside the portal.\')\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-from Products.CMFPlone.utils import transaction_note\n-transaction_note(\'Changed password for %s\' % (member.getUserName()))\n-\n-context.plone_utils.addPortalMessage(_(\'Password changed.\'))\n-\n-return context.REQUEST.RESPONSE.redirect(\n-            \'%s/@@personal-preferences\' % context.absolute_url())\ndiff --git a/Products/CMFPlone/skins/plone_prefs/password_form.pt b/Products/CMFPlone/skins/plone_prefs/password_form.pt\ndeleted file mode 100644\nindex 45d75b9915..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/password_form.pt\n+++ /dev/null\n@@ -1,98 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/prefs_main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<body>\n-\n-<metal:main fill-slot="prefs_configlet_main">\n-\n-    <h1 class="documentFirstHeading"\n-        i18n:translate="heading_change_password_for">\n-        Change password for <span tal:content="user/getUserName" tal:omit-tag="" i18n:name="user">user</span>\n-    </h1>\n-\n-    <div id="content-core">\n-        <a href=""\n-           class="link-parent"\n-           tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/dashboard"\n-           i18n:translate="label_to_dashboard">\n-            Up to my dashboard\n-        </a>\n-        <form action="plone_change_password"\n-              class="pat-formautofocus pat-formunloadalert"\n-              name="change_password"\n-              method="post">\n-\n-            <fieldset>\n-                <legend i18n:translate="legend_password_details">Password Details</legend>\n-\n-                <div class="field">\n-                    <label for="current" i18n:translate="label_current_password">Current password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_current_password">\n-                    Enter your current password.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="current"\n-                           name="current"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="field">\n-                    <label for="password" i18n:translate="label_new_password">New password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_new_password">\n-                    Enter your new password.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="password"\n-                           name="password"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="field">\n-                    <label for="password_confirm" i18n:translate="label_confirm_password">Confirm password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_confirm_password">\n-                    Re-enter the password. Make sure the passwords are identical.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="password_confirm"\n-                           name="password_confirm"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="formControls">\n-                    <input class="btn btn-primary"\n-                           type="submit"\n-                           value="Change Password"\n-                           i18n:attributes="value label_change_password;"\n-                           />\n-                    <input class="btn btn-secondary"\n-                           type="submit"\n-                           name="cancel"\n-                           value="Cancel"\n-                           i18n:attributes="value label_cancel;"\n-                           />\n-                </div>\n-\n-                <input tal:replace="structure context/@@authenticator/authenticator" />\n-\n-            </fieldset>\n-        </form>\n-    </div>\n-\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata b/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata\ndeleted file mode 100644\nindex 51853704e4..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-[default]\n-title=Change password\ndiff --git a/Products/CMFPlone/tests/testControlPanelScripts.py b/Products/CMFPlone/tests/testControlPanelScripts.py\nindex e0428af4cb..d37e54f2ef 100644\n--- a/Products/CMFPlone/tests/testControlPanelScripts.py\n+++ b/Products/CMFPlone/tests/testControlPanelScripts.py\n@@ -1,35 +1,7 @@\n-from DateTime import DateTime\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n-from plone.app.testing import TEST_USER_NAME\n-from plone.app.testing import TEST_USER_PASSWORD\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n-from zExceptions import Forbidden\n-\n-import unittest\n-\n-\n-class TestPrefsUserManage(unittest.TestCase):\n-\n-    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-\n-    def setUp(self):\n-        self.portal = self.layer[\'portal\']\n-        self.membership = self.portal.portal_membership\n-        self.membership.memberareaCreationFlag = 0\n-        # self.setupAuthenticator()\n-\n-    def test_ploneChangePasswordPostOnly(self):\n-        # self.login(TEST_USER_NAME)\n-        self.layer[\'request\'].method = \'GET\'\n-        with self.assertRaises(Forbidden):\n-            self.portal.plone_change_password(\n-                current=TEST_USER_PASSWORD,\n-                password=TEST_USER_PASSWORD,\n-                password_confirm=TEST_USER_PASSWORD,\n-            )\n \n \n class TestAccessControlPanelScripts(PloneTestCase):\ndiff --git a/news/3240.bugfix b/news/3240.bugfix\nnew file mode 100644\nindex 0000000000..a22c67adf0\n--- /dev/null\n+++ b/news/3240.bugfix\n@@ -0,0 +1,3 @@\n+Removed no longer used ``password_form.pt`` and ``plone_change_password.py``.\n+No longer register now empty skin layers ``plone_prefs`` and ``plone_form_scripts``.\n+[maurits]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-03-27T01:00:36+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/75abae2fe4e2991112d9d2a8eaec09299360ec65

Merge pull request #3462 from plone/maurits-remove-unused-password-form-and-script

Removed no longer used password_form.pt and plone_change_password.py.

Files changed:
A news/3240.bugfix
M Products/CMFPlone/profiles/default/skins.xml
M Products/CMFPlone/tests/testControlPanelScripts.py
D Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py
D Products/CMFPlone/skins/plone_prefs/password_form.pt
D Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata

b'diff --git a/Products/CMFPlone/profiles/default/skins.xml b/Products/CMFPlone/profiles/default/skins.xml\nindex b8be444eff..0a115c2ebc 100644\n--- a/Products/CMFPlone/profiles/default/skins.xml\n+++ b/Products/CMFPlone/profiles/default/skins.xml\n@@ -3,12 +3,8 @@\n    cookie_persistence="False" default_skin="Plone Default"\n    request_varname="plone_skin">\n  <object name="custom" meta_type="Folder"/>\n- <object name="plone_form_scripts" meta_type="Filesystem Directory View"\n-    directory="Products.CMFPlone:skins/plone_form_scripts"/>\n  <object name="plone_images" meta_type="Filesystem Directory View"\n     directory="Products.CMFPlone:skins/plone_images"/>\n- <object name="plone_prefs" meta_type="Filesystem Directory View"\n-    directory="Products.CMFPlone:skins/plone_prefs"/>\n  <object name="plone_scripts" meta_type="Filesystem Directory View"\n     directory="Products.CMFPlone:skins/plone_scripts"/>\n  <object name="plone_templates" meta_type="Filesystem Directory View"\n@@ -18,9 +14,7 @@\n  <skin-path name="Plone Default">\n   <layer name="custom"/>\n   <layer name="plone_wysiwyg"/>\n-  <layer name="plone_prefs"/>\n   <layer name="plone_templates"/>\n-  <layer name="plone_form_scripts"/>\n   <layer name="plone_scripts"/>\n   <layer name="plone_images"/>\n  </skin-path>\ndiff --git a/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py b/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py\ndeleted file mode 100644\nindex 77a5ee90b0..0000000000\n--- a/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py\n+++ /dev/null\n@@ -1,54 +0,0 @@\n-## Script (Python) "plone_change_password"\n-##bind container=container\n-##bind context=context\n-##bind namespace=\n-##bind script=script\n-##bind subpath=traverse_subpath\n-##title=Action to change password\n-##parameters=password, password_confirm, current, domains=None\n-\n-from Products.CMFPlone import PloneMessageFactory as _\n-\n-REQUEST = context.REQUEST\n-if \'cancel\' in REQUEST.form:\n-    context.plone_utils.addPortalMessage(_(\'Password change was canceled.\'),\n-                                         \'warning\')\n-    return context.REQUEST.RESPONSE.redirect(\n-            \'%s/@@personal-preferences\' % context.absolute_url())\n-\n-mt = context.portal_membership\n-\n-if not mt.testCurrentPassword(current):\n-    failMessage = _(\'Does not match current password.\')\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-failMessage = context.portal_registration \\\n-                    .testPasswordValidity(password, password_confirm)\n-if failMessage:\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-member = mt.getAuthenticatedMember()\n-try:\n-    mt.setPassword(password, domains, REQUEST=context.REQUEST)\n-except AttributeError:\n-    failMessage = _(\'While changing your password an AttributeError \'\n-                    \'occurred. This is usually caused by your user being \'\n-                    \'defined outside the portal.\')\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-from Products.CMFPlone.utils import transaction_note\n-transaction_note(\'Changed password for %s\' % (member.getUserName()))\n-\n-context.plone_utils.addPortalMessage(_(\'Password changed.\'))\n-\n-return context.REQUEST.RESPONSE.redirect(\n-            \'%s/@@personal-preferences\' % context.absolute_url())\ndiff --git a/Products/CMFPlone/skins/plone_prefs/password_form.pt b/Products/CMFPlone/skins/plone_prefs/password_form.pt\ndeleted file mode 100644\nindex 45d75b9915..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/password_form.pt\n+++ /dev/null\n@@ -1,98 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/prefs_main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<body>\n-\n-<metal:main fill-slot="prefs_configlet_main">\n-\n-    <h1 class="documentFirstHeading"\n-        i18n:translate="heading_change_password_for">\n-        Change password for <span tal:content="user/getUserName" tal:omit-tag="" i18n:name="user">user</span>\n-    </h1>\n-\n-    <div id="content-core">\n-        <a href=""\n-           class="link-parent"\n-           tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/dashboard"\n-           i18n:translate="label_to_dashboard">\n-            Up to my dashboard\n-        </a>\n-        <form action="plone_change_password"\n-              class="pat-formautofocus pat-formunloadalert"\n-              name="change_password"\n-              method="post">\n-\n-            <fieldset>\n-                <legend i18n:translate="legend_password_details">Password Details</legend>\n-\n-                <div class="field">\n-                    <label for="current" i18n:translate="label_current_password">Current password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_current_password">\n-                    Enter your current password.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="current"\n-                           name="current"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="field">\n-                    <label for="password" i18n:translate="label_new_password">New password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_new_password">\n-                    Enter your new password.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="password"\n-                           name="password"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="field">\n-                    <label for="password_confirm" i18n:translate="label_confirm_password">Confirm password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_confirm_password">\n-                    Re-enter the password. Make sure the passwords are identical.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="password_confirm"\n-                           name="password_confirm"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="formControls">\n-                    <input class="btn btn-primary"\n-                           type="submit"\n-                           value="Change Password"\n-                           i18n:attributes="value label_change_password;"\n-                           />\n-                    <input class="btn btn-secondary"\n-                           type="submit"\n-                           name="cancel"\n-                           value="Cancel"\n-                           i18n:attributes="value label_cancel;"\n-                           />\n-                </div>\n-\n-                <input tal:replace="structure context/@@authenticator/authenticator" />\n-\n-            </fieldset>\n-        </form>\n-    </div>\n-\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata b/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata\ndeleted file mode 100644\nindex 51853704e4..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-[default]\n-title=Change password\ndiff --git a/Products/CMFPlone/tests/testControlPanelScripts.py b/Products/CMFPlone/tests/testControlPanelScripts.py\nindex e0428af4cb..d37e54f2ef 100644\n--- a/Products/CMFPlone/tests/testControlPanelScripts.py\n+++ b/Products/CMFPlone/tests/testControlPanelScripts.py\n@@ -1,35 +1,7 @@\n-from DateTime import DateTime\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n-from plone.app.testing import TEST_USER_NAME\n-from plone.app.testing import TEST_USER_PASSWORD\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n-from zExceptions import Forbidden\n-\n-import unittest\n-\n-\n-class TestPrefsUserManage(unittest.TestCase):\n-\n-    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-\n-    def setUp(self):\n-        self.portal = self.layer[\'portal\']\n-        self.membership = self.portal.portal_membership\n-        self.membership.memberareaCreationFlag = 0\n-        # self.setupAuthenticator()\n-\n-    def test_ploneChangePasswordPostOnly(self):\n-        # self.login(TEST_USER_NAME)\n-        self.layer[\'request\'].method = \'GET\'\n-        with self.assertRaises(Forbidden):\n-            self.portal.plone_change_password(\n-                current=TEST_USER_PASSWORD,\n-                password=TEST_USER_PASSWORD,\n-                password_confirm=TEST_USER_PASSWORD,\n-            )\n \n \n class TestAccessControlPanelScripts(PloneTestCase):\ndiff --git a/news/3240.bugfix b/news/3240.bugfix\nnew file mode 100644\nindex 0000000000..a22c67adf0\n--- /dev/null\n+++ b/news/3240.bugfix\n@@ -0,0 +1,3 @@\n+Removed no longer used ``password_form.pt`` and ``plone_change_password.py``.\n+No longer register now empty skin layers ``plone_prefs`` and ``plone_form_scripts``.\n+[maurits]\n'

