Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-02-21T21:41:23+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/c0162080bf7a0d57709937d5fbf864c998d35a2d

Restrict unlinking on Language Root Folders (#1333)

Files changed:
A news/1332.bugfix
M src/plone/restapi/services/multilingual/pam.py
M src/plone/restapi/tests/test_translations.py

b'diff --git a/news/1332.bugfix b/news/1332.bugfix\nnew file mode 100644\nindex 000000000..f0cd54f69\n--- /dev/null\n+++ b/news/1332.bugfix\n@@ -0,0 +1,2 @@\n+Restrict unlinking on Language Root Folders\n+[sneridagh]\ndiff --git a/src/plone/restapi/services/multilingual/pam.py b/src/plone/restapi/services/multilingual/pam.py\nindex 3dcece9d6..267b5179c 100644\n--- a/src/plone/restapi/services/multilingual/pam.py\n+++ b/src/plone/restapi/services/multilingual/pam.py\n@@ -176,8 +176,7 @@ def reply(self):\n                     message="You need to provide the language to unlink",\n                 )\n             )\n-\n-        if language not in list(manager.get_translations()):\n+        elif language not in list(manager.get_translations()):\n             self.request.response.setStatus(400)\n             return dict(\n                 error=dict(\n@@ -185,6 +184,14 @@ def reply(self):\n                     message=f"This objects is not translated into {language}",\n                 )\n             )\n+        elif self.context.portal_type == "LRF":\n+            self.request.response.setStatus(400)\n+            return dict(\n+                error=dict(\n+                    type="BadRequest",\n+                    message="Language Root Folders cannot be unlinked",\n+                )\n+            )\n \n         manager.remove_translation(language)\n         # We want to leave a log in the transaction that the unlink has been executed\ndiff --git a/src/plone/restapi/tests/test_translations.py b/src/plone/restapi/tests/test_translations.py\nindex fb8a7e290..901691a77 100644\n--- a/src/plone/restapi/tests/test_translations.py\n+++ b/src/plone/restapi/tests/test_translations.py\n@@ -276,6 +276,19 @@ def test_calling_with_an_untranslated_content_gives_400(self):\n         )\n         self.assertEqual(400, response.status_code)\n \n+    def test_translation_unlinking_a_LRF_errors(self):\n+        response = requests.delete(\n+            f"{self.portal[\'en\'].absolute_url()}/@translations",\n+            headers={"Accept": "application/json"},\n+            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),\n+            json={"language": "es"},\n+        )\n+        self.assertEqual(400, response.status_code)\n+        self.assertEqual(\n+            response.json()["error"]["message"],\n+            "Language Root Folders cannot be unlinked",\n+        )\n+\n \n class TestCreateContentsAsTranslations(unittest.TestCase):\n     layer = PLONE_RESTAPI_DX_PAM_FUNCTIONAL_TESTING\n'

