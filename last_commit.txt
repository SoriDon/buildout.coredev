Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2016-07-21T17:01:33-06:00
Author: Sean Upton (seanupton) <sdupton@gmail.com>
Commit: https://github.com/plone/Products.Archetypes/commit/d07b5e4dcb77ab92e84b0b0118d14267a17eef02

DateWidget, DatetimeWidget (pick-a-date) now able to clear previous
values; fixes inability to clear an already set date or datetime in
Archetypes fields.

Files changed:
M CHANGES.rst
M Products/Archetypes/Widget.py
M Products/Archetypes/tests/test_pawidgets.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3d01664..d16c957 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,9 @@ New features:
 
 Bug fixes:
 
+- DateWidget, DatetimeWidget now able to clear previous values.
+  [seanupton]
+
 - Use zope.interface decorator.
   [gforcada]
 
diff --git a/Products/Archetypes/Widget.py b/Products/Archetypes/Widget.py
index 1dba93f..116d1db 100644
--- a/Products/Archetypes/Widget.py
+++ b/Products/Archetypes/Widget.py
@@ -1023,6 +1023,10 @@ def process_form(self, instance, field, form, empty_marker=None):
 
         value = value.split('-')
 
+        if value[0] == '':
+            # empty value, clear any previous value
+            return None, {}
+
         try:
             value = DateTime(datetime(*map(int, value)))
         except:
@@ -1102,8 +1106,11 @@ def process_form(self, instance, field, form, empty_marker=None):
             return empty_marker
 
         tmp = value.split(' ')
+
         if not tmp[0]:
-            return empty_marker
+            # empty: clear, not preserve, any previous value
+            return None, {}
+
         value = tmp[0].split('-')
         if len(tmp) == 2 and ':' in tmp[1]:
             value += tmp[1].split(':')
diff --git a/Products/Archetypes/tests/test_pawidgets.py b/Products/Archetypes/tests/test_pawidgets.py
index d624bd6..ae95c29 100644
--- a/Products/Archetypes/tests/test_pawidgets.py
+++ b/Products/Archetypes/tests/test_pawidgets.py
@@ -124,6 +124,16 @@ def test_process_form(self):
             (datetime(2011, 11, 22))
         )
 
+    def test_process_form_empty_existing(self):
+        form = {
+            'fieldname': ''
+        }
+        self.assertEqual(
+            self.widget.process_form(
+                self.context, self.field, form)[0],
+            None
+        )
+
 
 class DatetimeWidgetTests(unittest.TestCase):
 
@@ -188,6 +198,16 @@ def test_process_form(self):
             (datetime(2011, 11, 22, 13, 30))
         )
 
+    def test_process_form_empty_existing(self):
+        form = {
+            'fieldname': ''
+        }
+        self.assertEqual(
+            self.widget.process_form(
+                self.context, self.field, form)[0],
+            None
+        )
+
 
 class SelectWidgetTests(unittest.TestCase):
 


Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2016-08-11T06:56:54-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.Archetypes/commit/fd14d4657f088dae18b932faec7472e90854bcfd

Merge pull request #59 from seanupton/master

DateWidget, DatetimeWidget (pick-a-date) now able to clear previous

Files changed:
M CHANGES.rst
M Products/Archetypes/Widget.py
M Products/Archetypes/tests/test_pawidgets.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3d01664..d16c957 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,9 @@ New features:
 
 Bug fixes:
 
+- DateWidget, DatetimeWidget now able to clear previous values.
+  [seanupton]
+
 - Use zope.interface decorator.
   [gforcada]
 
diff --git a/Products/Archetypes/Widget.py b/Products/Archetypes/Widget.py
index 1dba93f..116d1db 100644
--- a/Products/Archetypes/Widget.py
+++ b/Products/Archetypes/Widget.py
@@ -1023,6 +1023,10 @@ def process_form(self, instance, field, form, empty_marker=None):
 
         value = value.split('-')
 
+        if value[0] == '':
+            # empty value, clear any previous value
+            return None, {}
+
         try:
             value = DateTime(datetime(*map(int, value)))
         except:
@@ -1102,8 +1106,11 @@ def process_form(self, instance, field, form, empty_marker=None):
             return empty_marker
 
         tmp = value.split(' ')
+
         if not tmp[0]:
-            return empty_marker
+            # empty: clear, not preserve, any previous value
+            return None, {}
+
         value = tmp[0].split('-')
         if len(tmp) == 2 and ':' in tmp[1]:
             value += tmp[1].split(':')
diff --git a/Products/Archetypes/tests/test_pawidgets.py b/Products/Archetypes/tests/test_pawidgets.py
index d624bd6..ae95c29 100644
--- a/Products/Archetypes/tests/test_pawidgets.py
+++ b/Products/Archetypes/tests/test_pawidgets.py
@@ -124,6 +124,16 @@ def test_process_form(self):
             (datetime(2011, 11, 22))
         )
 
+    def test_process_form_empty_existing(self):
+        form = {
+            'fieldname': ''
+        }
+        self.assertEqual(
+            self.widget.process_form(
+                self.context, self.field, form)[0],
+            None
+        )
+
 
 class DatetimeWidgetTests(unittest.TestCase):
 
@@ -188,6 +198,16 @@ def test_process_form(self):
             (datetime(2011, 11, 22, 13, 30))
         )
 
+    def test_process_form_empty_existing(self):
+        form = {
+            'fieldname': ''
+        }
+        self.assertEqual(
+            self.widget.process_form(
+                self.context, self.field, form)[0],
+            None
+        )
+
 
 class SelectWidgetTests(unittest.TestCase):
 


