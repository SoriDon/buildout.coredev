Repository: plone.namedfile


Branch: refs/heads/master
Date: 2022-11-21T15:37:22+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.namedfile/commit/8064f435dfd54717679e784cccf54318fadc8831

Fixed writing to the database each time an original is requested.

This happens when requesting the original under a unique id.
Fixes https://github.com/plone/Products.CMFPlone/issues/3678

Files changed:
A news/3678.bugfix
M plone/namedfile/scaling.py

b'diff --git a/news/3678.bugfix b/news/3678.bugfix\nnew file mode 100644\nindex 0000000..ff779e4\n--- /dev/null\n+++ b/news/3678.bugfix\n@@ -0,0 +1,3 @@\n+Fixed writing to the database each time an original is requested.\n+This happens when requesting the original under a unique id.\n+[maurits]\ndiff --git a/plone/namedfile/scaling.py b/plone/namedfile/scaling.py\nindex 853dd61..c21e8c8 100644\n--- a/plone/namedfile/scaling.py\n+++ b/plone/namedfile/scaling.py\n@@ -318,7 +318,6 @@ def __call__(\n         height=None,\n         width=None,\n         scale=None,\n-        want_original=None,\n         **parameters,\n     ):\n \n@@ -333,26 +332,25 @@ def __call__(\n         orig_value = self.get_original_value()\n         if orig_value is None:\n             return\n-        if height is None and width is None and want_original is None:\n-            # We don\'t seem to want an image, so we return nothing\n-            # as image value (the first argument).\n-            dummy, format_ = orig_value.contentType.split("/", 1)\n-            return None, format_, (orig_value._width, orig_value._height)\n-        if "direction" in parameters:\n-            warnings.warn(\n-                "The \'direction\' option is deprecated, use \'mode\' instead.",\n-                DeprecationWarning,\n-            )\n-            # We must get rid of this duplicate parameter, otherwise it ends up in\n-            # hashes and it negates the next condition.\n-            mode = parameters.pop("direction")\n-        if (\n-            not parameters\n-            and height\n-            and width\n-            and height == getattr(orig_value, "_height", None)\n-            and width == getattr(orig_value, "_width", None)\n-        ) or want_original:\n+        want_original = height is None and width is None\n+        if not want_original:\n+            if "direction" in parameters:\n+                warnings.warn(\n+                    "The \'direction\' option is deprecated, use \'mode\' instead.",\n+                    DeprecationWarning,\n+                )\n+                # We must get rid of this duplicate parameter, otherwise it ends up in\n+                # hashes and it negates the next condition.\n+                mode = parameters.pop("direction")\n+            if (\n+                not parameters\n+                and height\n+                and width\n+                and height == getattr(orig_value, "_height", None)\n+                and width == getattr(orig_value, "_width", None)\n+            ):\n+                want_original = True\n+        if want_original:\n             # No special wishes, and the original image already has the\n             # requested height and width.  Return the original.\n             dummy, format_ = orig_value.contentType.split("/", 1)\n'

Repository: plone.namedfile


Branch: refs/heads/master
Date: 2022-11-21T17:20:43+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.namedfile/commit/5f367ab6a531f68d6d9a79058bc4ee114db843fb

Merge pull request #136 from plone/maurits-want-original

Fixed writing to the database each time an original is requested.

Files changed:
A news/3678.bugfix
M plone/namedfile/scaling.py

b'diff --git a/news/3678.bugfix b/news/3678.bugfix\nnew file mode 100644\nindex 0000000..ff779e4\n--- /dev/null\n+++ b/news/3678.bugfix\n@@ -0,0 +1,3 @@\n+Fixed writing to the database each time an original is requested.\n+This happens when requesting the original under a unique id.\n+[maurits]\ndiff --git a/plone/namedfile/scaling.py b/plone/namedfile/scaling.py\nindex 853dd61..c21e8c8 100644\n--- a/plone/namedfile/scaling.py\n+++ b/plone/namedfile/scaling.py\n@@ -318,7 +318,6 @@ def __call__(\n         height=None,\n         width=None,\n         scale=None,\n-        want_original=None,\n         **parameters,\n     ):\n \n@@ -333,26 +332,25 @@ def __call__(\n         orig_value = self.get_original_value()\n         if orig_value is None:\n             return\n-        if height is None and width is None and want_original is None:\n-            # We don\'t seem to want an image, so we return nothing\n-            # as image value (the first argument).\n-            dummy, format_ = orig_value.contentType.split("/", 1)\n-            return None, format_, (orig_value._width, orig_value._height)\n-        if "direction" in parameters:\n-            warnings.warn(\n-                "The \'direction\' option is deprecated, use \'mode\' instead.",\n-                DeprecationWarning,\n-            )\n-            # We must get rid of this duplicate parameter, otherwise it ends up in\n-            # hashes and it negates the next condition.\n-            mode = parameters.pop("direction")\n-        if (\n-            not parameters\n-            and height\n-            and width\n-            and height == getattr(orig_value, "_height", None)\n-            and width == getattr(orig_value, "_width", None)\n-        ) or want_original:\n+        want_original = height is None and width is None\n+        if not want_original:\n+            if "direction" in parameters:\n+                warnings.warn(\n+                    "The \'direction\' option is deprecated, use \'mode\' instead.",\n+                    DeprecationWarning,\n+                )\n+                # We must get rid of this duplicate parameter, otherwise it ends up in\n+                # hashes and it negates the next condition.\n+                mode = parameters.pop("direction")\n+            if (\n+                not parameters\n+                and height\n+                and width\n+                and height == getattr(orig_value, "_height", None)\n+                and width == getattr(orig_value, "_width", None)\n+            ):\n+                want_original = True\n+        if want_original:\n             # No special wishes, and the original image already has the\n             # requested height and width.  Return the original.\n             dummy, format_ = orig_value.contentType.split("/", 1)\n'

