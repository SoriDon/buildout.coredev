Repository: plone.app.users


Branch: refs/heads/master
Date: 2019-08-23T09:19:33+02:00
Author: Thomas Massmann (tmassman) <thomas.massmann@it-spir.it>
Commit: https://github.com/plone/plone.app.users/commit/b0990b09f08d706ca101d67d3d377b40463251ce

Use many_groups setting from IUserGroupsSettingsSchema.

Files changed:
A news/83.bugfix
M plone/app/users/browser/register.py

b"diff --git a/news/83.bugfix b/news/83.bugfix\nnew file mode 100644\nindex 0000000..e8c2098\n--- /dev/null\n+++ b/news/83.bugfix\n@@ -0,0 +1,2 @@\n+Fix many_groups usage in AddUserForm\n+[tmassman]\ndiff --git a/plone/app/users/browser/register.py b/plone/app/users/browser/register.py\nindex 87a02b4..63ca305 100644\n--- a/plone/app/users/browser/register.py\n+++ b/plone/app/users/browser/register.py\n@@ -1,5 +1,6 @@\n # -*- coding: utf-8 -*-\n from AccessControl import getSecurityManager\n+from Acquisition import aq_inner\n from plone.app.users.browser.account import AccountPanelSchemaAdapter\n from plone.app.users.browser.interfaces import ILoginNameGenerator\n from plone.app.users.browser.interfaces import IUserIdGenerator\n@@ -18,6 +19,7 @@\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.interfaces import IPloneSiteRoot\n from Products.CMFPlone.interfaces import ISecuritySchema\n+from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema\n from Products.CMFPlone.utils import get_portal\n from Products.CMFPlone.utils import normalizeString\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n@@ -639,9 +641,11 @@ def updateFields(self):\n                 not settings.enable_user_pwd_choice\n \n         # Append the manager-focused fields\n-        portal_props = getToolByName(self.context, 'portal_properties')\n-        props = portal_props.site_properties\n-        many_groups = props.getProperty('many_groups', False)\n+        user_group_settings = getAdapter(\n+            aq_inner(self.context),\n+            IUserGroupsSettingsSchema,\n+        )\n+        many_groups = user_group_settings.many_groups\n         if not many_groups:\n             allFields = defaultFields + field.Fields(IAddUserSchema)\n             allFields['groups'].widgetFactory = CheckBoxFieldWidget\n"

Repository: plone.app.users


Branch: refs/heads/master
Date: 2019-08-23T11:44:16+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.users/commit/bdcc4df08c947abe8d9540023ed3fd8e67748801

Merge pull request #84 from plone/fix-many-users-add-form

Use many_groups setting from IUserGroupsSettingsSchema.

Files changed:
A news/83.bugfix
M plone/app/users/browser/register.py

b"diff --git a/news/83.bugfix b/news/83.bugfix\nnew file mode 100644\nindex 0000000..e8c2098\n--- /dev/null\n+++ b/news/83.bugfix\n@@ -0,0 +1,2 @@\n+Fix many_groups usage in AddUserForm\n+[tmassman]\ndiff --git a/plone/app/users/browser/register.py b/plone/app/users/browser/register.py\nindex 87a02b4..63ca305 100644\n--- a/plone/app/users/browser/register.py\n+++ b/plone/app/users/browser/register.py\n@@ -1,5 +1,6 @@\n # -*- coding: utf-8 -*-\n from AccessControl import getSecurityManager\n+from Acquisition import aq_inner\n from plone.app.users.browser.account import AccountPanelSchemaAdapter\n from plone.app.users.browser.interfaces import ILoginNameGenerator\n from plone.app.users.browser.interfaces import IUserIdGenerator\n@@ -18,6 +19,7 @@\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.interfaces import IPloneSiteRoot\n from Products.CMFPlone.interfaces import ISecuritySchema\n+from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema\n from Products.CMFPlone.utils import get_portal\n from Products.CMFPlone.utils import normalizeString\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n@@ -639,9 +641,11 @@ def updateFields(self):\n                 not settings.enable_user_pwd_choice\n \n         # Append the manager-focused fields\n-        portal_props = getToolByName(self.context, 'portal_properties')\n-        props = portal_props.site_properties\n-        many_groups = props.getProperty('many_groups', False)\n+        user_group_settings = getAdapter(\n+            aq_inner(self.context),\n+            IUserGroupsSettingsSchema,\n+        )\n+        many_groups = user_group_settings.many_groups\n         if not many_groups:\n             allFields = defaultFields + field.Fields(IAddUserSchema)\n             allFields['groups'].widgetFactory = CheckBoxFieldWidget\n"

