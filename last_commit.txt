Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2022-02-02T17:34:18+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/47cfad88e7c941d6741a5ba33286dfa0ea903fa7

Fix several exceptions when calling fix_unicode_properties.

Fixes https://github.com/plone/plone.app.upgrade/issues/270
I will make a PR for Zope as well, which has the same code.

Files changed:
A news/270.bugfix
M plone/app/upgrade/v60/alphas.py

b'diff --git a/news/270.bugfix b/news/270.bugfix\nnew file mode 100644\nindex 00000000..243f8971\n--- /dev/null\n+++ b/news/270.bugfix\n@@ -0,0 +1,2 @@\n+Fix several exceptions when calling ``fix_unicode_properties``.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex d9c2e292..d0adb75f 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -166,11 +166,19 @@ def _fix_properties(obj, path=None):\n             # We don\'t care about the path then, it is only shown in logs.\n             path = "/dummy"\n \n+    if not hasattr(obj, "_updateProperty"):\n+        # Seen with portal_url tool, most items in portal_skins,\n+        # catalog lexicons, workflow states/transitions/variables, etc.\n+        return\n     try:\n         prop_map = obj.propertyMap()\n-    except AttributeError:\n-        # Object does not inherit from PropertyManager.\n-        # For example \'MountedObject\'.\n+    except (AttributeError, TypeError, KeyError, ValueError):\n+        # If getting the property map fails, there is nothing we can do.\n+        # Problems seen in practice:\n+        # - Object does not inherit from PropertyManager,\n+        #   for example \'MountedObject\'.\n+        # - Object is a no longer existing skin layer.\n+        logger.warning("Error getting property map from %s", path)\n         return\n \n     for prop_info in prop_map:\n@@ -256,11 +264,17 @@ def fix_unicode_properties(context):\n     If it is not there, we use our own copy.\n     The Zope one should be leading though.\n     Our copy can be removed when Zope 5.4. is released.\n+\n+    Update: there is a problem with both versions of the code,\n+    so for the moment we fix it in our own version,\n+    and always use it.\n+    See https://github.com/plone/plone.app.upgrade/issues/270\n     """\n-    try:\n-        from ZPublisher.utils import fix_properties\n-    except ImportError:\n-        fix_properties = _fix_properties\n+    # try:\n+    #     from ZPublisher.utils import fix_properties\n+    # except ImportError:\n+    #     fix_properties = _fix_properties\n+    fix_properties = _fix_properties\n     portal = getSite()\n     portal.reindexObject()\n     portal.ZopeFindAndApply(portal, search_sub=1, apply_func=fix_properties)\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2022-02-08T21:26:22+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/23499544dd9e3b6998c8815b853b11f1e6dc588d

Merge pull request #271 from plone/maurits-issue-270-improve-fix-unicode-properties

Fix several exceptions when calling fix_unicode_properties.

Files changed:
A news/270.bugfix
M plone/app/upgrade/v60/alphas.py

b'diff --git a/news/270.bugfix b/news/270.bugfix\nnew file mode 100644\nindex 00000000..243f8971\n--- /dev/null\n+++ b/news/270.bugfix\n@@ -0,0 +1,2 @@\n+Fix several exceptions when calling ``fix_unicode_properties``.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex d9c2e292..d0adb75f 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -166,11 +166,19 @@ def _fix_properties(obj, path=None):\n             # We don\'t care about the path then, it is only shown in logs.\n             path = "/dummy"\n \n+    if not hasattr(obj, "_updateProperty"):\n+        # Seen with portal_url tool, most items in portal_skins,\n+        # catalog lexicons, workflow states/transitions/variables, etc.\n+        return\n     try:\n         prop_map = obj.propertyMap()\n-    except AttributeError:\n-        # Object does not inherit from PropertyManager.\n-        # For example \'MountedObject\'.\n+    except (AttributeError, TypeError, KeyError, ValueError):\n+        # If getting the property map fails, there is nothing we can do.\n+        # Problems seen in practice:\n+        # - Object does not inherit from PropertyManager,\n+        #   for example \'MountedObject\'.\n+        # - Object is a no longer existing skin layer.\n+        logger.warning("Error getting property map from %s", path)\n         return\n \n     for prop_info in prop_map:\n@@ -256,11 +264,17 @@ def fix_unicode_properties(context):\n     If it is not there, we use our own copy.\n     The Zope one should be leading though.\n     Our copy can be removed when Zope 5.4. is released.\n+\n+    Update: there is a problem with both versions of the code,\n+    so for the moment we fix it in our own version,\n+    and always use it.\n+    See https://github.com/plone/plone.app.upgrade/issues/270\n     """\n-    try:\n-        from ZPublisher.utils import fix_properties\n-    except ImportError:\n-        fix_properties = _fix_properties\n+    # try:\n+    #     from ZPublisher.utils import fix_properties\n+    # except ImportError:\n+    #     fix_properties = _fix_properties\n+    fix_properties = _fix_properties\n     portal = getSite()\n     portal.reindexObject()\n     portal.ZopeFindAndApply(portal, search_sub=1, apply_func=fix_properties)\n'

