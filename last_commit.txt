Repository: plone.app.users


Branch: refs/heads/master
Date: 2022-02-17T21:02:09+02:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/plone.app.users/commit/c89ac033e6ea7bdbecbd893a35ca204cc20c3675

Show unfiltered member fields for manager in user profile page

Files changed:
A news/106.feature
M plone/app/users/browser/userdatapanel.py

b"diff --git a/news/106.feature b/news/106.feature\nnew file mode 100644\nindex 0000000..8dfce81\n--- /dev/null\n+++ b/news/106.feature\n@@ -0,0 +1 @@\n+Show unfiltered member fields for manager in user profile page [MrTango]\n\\ No newline at end of file\ndiff --git a/plone/app/users/browser/userdatapanel.py b/plone/app/users/browser/userdatapanel.py\nindex 5fc8a2b..e876765 100644\n--- a/plone/app/users/browser/userdatapanel.py\n+++ b/plone/app/users/browser/userdatapanel.py\n@@ -1,4 +1,5 @@\n # -*- coding: utf-8 -*-\n+from AccessControl.SecurityManagement import getSecurityManager\n from plone.app.layout.navigation.interfaces import INavigationRoot\n from plone.app.users.browser.account import AccountPanelForm\n from plone.app.users.browser.account import AccountPanelSchemaAdapter\n@@ -99,12 +100,22 @@ def __call__(self):\n \n def getUserDataSchema():\n     portal = get_portal()\n-    schema = getattr(portal, '_v_userdata_schema', None)\n+    form_name = u'In User Profile'\n+    if getSecurityManager().checkPermission('Manage portal', portal):\n+        form_name = None\n+    if form_name:\n+        schema = getattr(portal, '_v_userdata_schema', None)\n+    else:\n+        schema = getattr(portal, '_v_userdata_manager_schema', None)\n     if schema is None:\n-        portal._v_userdata_schema = schema = getFromBaseSchema(\n+        schema = getFromBaseSchema(\n             IUserDataSchema,\n-            form_name=u'In User Profile'\n+            form_name=form_name\n         )\n+        if form_name:\n+            portal._v_userdata_schema = schema\n+        else:\n+            portal._v_userdata_manager_schema = schema\n         # as schema is a generated supermodel,\n         # needed adapters can only be registered at run time\n         provideAdapter(UserDataPanelAdapter, (IPloneSiteRoot,), schema)\n"

Repository: plone.app.users


Branch: refs/heads/master
Date: 2022-02-23T18:05:02+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.users/commit/2f621b4eefa4bb89a798f9796ba3ae23cd79d502

Merge pull request #106 from plone/mrtango-unfiltered-userschema-for-manager

Show unfiltered member fields for manager in user profile

Files changed:
A news/106.feature
M plone/app/users/browser/userdatapanel.py

b"diff --git a/news/106.feature b/news/106.feature\nnew file mode 100644\nindex 0000000..8dfce81\n--- /dev/null\n+++ b/news/106.feature\n@@ -0,0 +1 @@\n+Show unfiltered member fields for manager in user profile page [MrTango]\n\\ No newline at end of file\ndiff --git a/plone/app/users/browser/userdatapanel.py b/plone/app/users/browser/userdatapanel.py\nindex 5fc8a2b..e876765 100644\n--- a/plone/app/users/browser/userdatapanel.py\n+++ b/plone/app/users/browser/userdatapanel.py\n@@ -1,4 +1,5 @@\n # -*- coding: utf-8 -*-\n+from AccessControl.SecurityManagement import getSecurityManager\n from plone.app.layout.navigation.interfaces import INavigationRoot\n from plone.app.users.browser.account import AccountPanelForm\n from plone.app.users.browser.account import AccountPanelSchemaAdapter\n@@ -99,12 +100,22 @@ def __call__(self):\n \n def getUserDataSchema():\n     portal = get_portal()\n-    schema = getattr(portal, '_v_userdata_schema', None)\n+    form_name = u'In User Profile'\n+    if getSecurityManager().checkPermission('Manage portal', portal):\n+        form_name = None\n+    if form_name:\n+        schema = getattr(portal, '_v_userdata_schema', None)\n+    else:\n+        schema = getattr(portal, '_v_userdata_manager_schema', None)\n     if schema is None:\n-        portal._v_userdata_schema = schema = getFromBaseSchema(\n+        schema = getFromBaseSchema(\n             IUserDataSchema,\n-            form_name=u'In User Profile'\n+            form_name=form_name\n         )\n+        if form_name:\n+            portal._v_userdata_schema = schema\n+        else:\n+            portal._v_userdata_manager_schema = schema\n         # as schema is a generated supermodel,\n         # needed adapters can only be registered at run time\n         provideAdapter(UserDataPanelAdapter, (IPloneSiteRoot,), schema)\n"

