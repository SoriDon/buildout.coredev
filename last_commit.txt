Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2019-06-24T08:43:27+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.discussion/commit/f39a7551f697494fc3e99edd1c6583db0b1b79d9

Registrr old js in legacy bundle (same as in p.a.event)

Files changed:
M plone/app/discussion/profiles/default/registry.xml
D plone/app/discussion/profiles/default/jsregistry.xml

b'diff --git a/plone/app/discussion/profiles/default/jsregistry.xml b/plone/app/discussion/profiles/default/jsregistry.xml\ndeleted file mode 100644\nindex db55b255..00000000\n--- a/plone/app/discussion/profiles/default/jsregistry.xml\n+++ /dev/null\n@@ -1,7 +0,0 @@\n-<?xml version="1.0"?>\n-<object name="portal_javascripts">\n- <javascript\n-     id="++resource++plone.app.discussion.javascripts/comments.js"\n-     insert-after="collapsibleformfields.js"\n-     />\n-</object>\ndiff --git a/plone/app/discussion/profiles/default/registry.xml b/plone/app/discussion/profiles/default/registry.xml\nindex 1e0d5355..5c046f44 100644\n--- a/plone/app/discussion/profiles/default/registry.xml\n+++ b/plone/app/discussion/profiles/default/registry.xml\n@@ -4,4 +4,17 @@\n     <value key="edit_comment_enabled">False</value>\n     <value key="delete_own_comment_enabled">False</value>\n   </records>\n+\n+  <records prefix="plone.resources/plone-app-discussion"\n+            interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n+      <value key="js">++resource++plone.app.discussion.javascripts/comments.js</value>\n+  </records>\n+  <records prefix="plone.bundles/plone-legacy"\n+            interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n+    <value key="resources" purge="false">\n+      <element>plone-app-discussion</element>\n+    </value>\n+    <value key="last_compilation"></value>\n+  </records>\n+\n </registry>\n'

Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2019-06-24T16:57:11+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.discussion/commit/9b02d2b2fcc97119cc148de273d78e2dff4a0980

add changenote

Files changed:
A news/157.bugfix

b'diff --git a/news/157.bugfix b/news/157.bugfix\nnew file mode 100644\nindex 00000000..0b13d04a\n--- /dev/null\n+++ b/news/157.bugfix\n@@ -0,0 +1,2 @@\n+Fix reply to comment by adding old-school js-resources to legacy-bundle. Fix #157\n+[pbauer]\n\\ No newline at end of file\n'

Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2019-06-27T19:43:27+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.discussion/commit/4966d8388e7d10e768ee7d5037cf19dcb06bfb93

add plone.resource dependency and change to plone:static

Files changed:
M docs/source/howtos/howto_override_comments_viewlet.txt
M plone/app/discussion/browser/configure.zcml
M plone/app/discussion/browser/controlpanel.pt
M plone/app/discussion/browser/moderation.pt
M plone/app/discussion/profiles/default/metadata.xml
M plone/app/discussion/profiles/default/registry.xml

b'diff --git a/docs/source/howtos/howto_override_comments_viewlet.txt b/docs/source/howtos/howto_override_comments_viewlet.txt\nindex 11c0248e..b45aba4f 100644\n--- a/docs/source/howtos/howto_override_comments_viewlet.txt\n+++ b/docs/source/howtos/howto_override_comments_viewlet.txt\n@@ -135,36 +135,4 @@ comments.py file with our custom version of the comments viewlet::\n                 return "%s/memberhome/%s" % (self.context.portal_url(), username)\n \n To override the comments viewlet template, we create a comment.pt file in the\n-same directory and copy the contents from::\n-\n-    ...\n-\n-\n-Override the comments viewlet Javascript\n-----------------------------------------\n-\n-Overriding the comments viewlet javascript works just like overriding the\n-comments viewlet. We register the javascript file for our custom browser\n-layer and remove the existing javascript file in\n-profiles/default/jsregistry.xml::\n-\n-    <?xml version="1.0"?>\n-    <object name="portal_javascripts">\n-     <!-- Remove plone.app.discussion comments javascript -->\n-     <javascript\n-         id="++resource++plone.app.discussion.javascripts/comments.js"\n-         remove="True"\n-         />\n-     <!-- Register a custom version of the plone.app.discussion javascript -->\n-     <javascript\n-         id="++resource++example.myaddonproduct.javascripts/comments.js" />\n-    </object>\n-\n-browser/configure.zcml::\n-\n-    <!-- Resource directory for javascripts -->\n-    <browser:resourceDirectory\n-      name="example.myaddonproduct.javascripts"\n-      directory="javascripts"\n-      layer="example.myaddonprocuts.interfaces.IBrowserLayer"\n-      />\n+same directory and copy the contents from the original.\ndiff --git a/plone/app/discussion/browser/configure.zcml b/plone/app/discussion/browser/configure.zcml\nindex 6a0efa26..7bb5aace 100644\n--- a/plone/app/discussion/browser/configure.zcml\n+++ b/plone/app/discussion/browser/configure.zcml\n@@ -1,6 +1,7 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:browser="http://namespaces.zope.org/browser"\n+    xmlns:plone="http://namespaces.plone.org/plone"\n     xmlns:zcml="http://namespaces.zope.org/zcml"\n     i18n_domain="plone">\n \n@@ -129,10 +130,10 @@\n         />\n \n     <!-- Resource directory for javascripts -->\n-    <browser:resourceDirectory\n+    <plone:static\n         name="plone.app.discussion.javascripts"\n+        type="plone"\n         directory="javascripts"\n-        layer="..interfaces.IDiscussionLayer"\n         />\n \n     <!-- Control panel -->\ndiff --git a/plone/app/discussion/browser/controlpanel.pt b/plone/app/discussion/browser/controlpanel.pt\nindex b62a447e..d525fcba 100644\n--- a/plone/app/discussion/browser/controlpanel.pt\n+++ b/plone/app/discussion/browser/controlpanel.pt\n@@ -70,7 +70,7 @@\n     </div>\n \n   <script type="text/javascript"\n-          tal:attributes="src string:${portal_url}/++resource++plone.app.discussion.javascripts/controlpanel.js">\n+          tal:attributes="src string:${portal_url}/++plone++plone.app.discussion.javascripts/controlpanel.js">\n   </script>\n \n </article>\ndiff --git a/plone/app/discussion/browser/moderation.pt b/plone/app/discussion/browser/moderation.pt\nindex 797c18ab..073d4d23 100644\n--- a/plone/app/discussion/browser/moderation.pt\n+++ b/plone/app/discussion/browser/moderation.pt\n@@ -18,7 +18,7 @@\n                     b_start request/b_start | b_start;\n                     moderation_enabled view/moderation_enabled;">\n         <script type="text/javascript"\n-            tal:attributes="src string:${context/portal_url}/++resource++plone.app.discussion.javascripts/moderation.js">\n+            tal:attributes="src string:${context/portal_url}/++plone++plone.app.discussion.javascripts/moderation.js">\n         </script>\n \n         <h1 class="documentFirstHeading" i18n:translate="heading_moderate_comments">\ndiff --git a/plone/app/discussion/profiles/default/metadata.xml b/plone/app/discussion/profiles/default/metadata.xml\nindex f14a7070..65572517 100644\n--- a/plone/app/discussion/profiles/default/metadata.xml\n+++ b/plone/app/discussion/profiles/default/metadata.xml\n@@ -1,6 +1,7 @@\n <metadata>\n  <version>1000</version>\n  <dependencies>\n+  <dependency>profile-plone.resource:default</dependency>\n   <dependency>profile-plone.app.registry:default</dependency>\n  </dependencies>\n </metadata>\ndiff --git a/plone/app/discussion/profiles/default/registry.xml b/plone/app/discussion/profiles/default/registry.xml\nindex 5c046f44..ba7fe987 100644\n--- a/plone/app/discussion/profiles/default/registry.xml\n+++ b/plone/app/discussion/profiles/default/registry.xml\n@@ -7,7 +7,7 @@\n \n   <records prefix="plone.resources/plone-app-discussion"\n             interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n-      <value key="js">++resource++plone.app.discussion.javascripts/comments.js</value>\n+      <value key="js">++plone++plone.app.discussion.javascripts/comments.js</value>\n   </records>\n   <records prefix="plone.bundles/plone-legacy"\n             interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n'

Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2019-06-27T19:59:20+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.discussion/commit/c229e516903215f250c38a8269a41f76308eaecb

add upgrade-step to re-enable comments.js

Files changed:
M plone/app/discussion/profiles/default/metadata.xml
M plone/app/discussion/upgrades.py
M plone/app/discussion/upgrades.zcml

b'diff --git a/plone/app/discussion/profiles/default/metadata.xml b/plone/app/discussion/profiles/default/metadata.xml\nindex 65572517..c779e86e 100644\n--- a/plone/app/discussion/profiles/default/metadata.xml\n+++ b/plone/app/discussion/profiles/default/metadata.xml\n@@ -1,5 +1,5 @@\n <metadata>\n- <version>1000</version>\n+ <version>1001</version>\n  <dependencies>\n   <dependency>profile-plone.resource:default</dependency>\n   <dependency>profile-plone.app.registry:default</dependency>\ndiff --git a/plone/app/discussion/upgrades.py b/plone/app/discussion/upgrades.py\nindex d9114f4e..7a0e30c1 100644\n--- a/plone/app/discussion/upgrades.py\n+++ b/plone/app/discussion/upgrades.py\n@@ -61,3 +61,7 @@ def upgrade_comment_workflows(context):\n             comment.reindexObjectSecurity()\n         except (AttributeError, KeyError):\n             logger.info(\'Could not reindex comment {0}\'.format(brain.getURL()))\n+\n+\n+def add_js_to_plone_legacy(context):\n+    context.runImportStepFromProfile(default_profile, \'plone.app.registry\')\ndiff --git a/plone/app/discussion/upgrades.zcml b/plone/app/discussion/upgrades.zcml\nindex 9fa258c6..02a7e541 100644\n--- a/plone/app/discussion/upgrades.zcml\n+++ b/plone/app/discussion/upgrades.zcml\n@@ -51,4 +51,15 @@\n         />\n   </genericsetup:upgradeSteps>\n \n+  <genericsetup:upgradeSteps\n+      source="1000"\n+      destination="1001"\n+      profile="plone.app.discussion:default">\n+    <genericsetup:upgradeStep\n+        title="Move comment.js into plone-legacy bundle"\n+        description=""\n+        handler=".upgrades.add_js_to_plone_legacy"\n+        />\n+  </genericsetup:upgradeSteps>\n+\n </configure>\n'

Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2019-06-27T22:24:58+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.discussion/commit/6cedcc4df66dfe2c709b34a8a5e45a62b03d9a6d

Merge pull request #158 from plone/register_js_in_legacy_bundle

Register old js in legacy bundle to fix missing js

Files changed:
A news/157.bugfix
M docs/source/howtos/howto_override_comments_viewlet.txt
M plone/app/discussion/browser/configure.zcml
M plone/app/discussion/browser/controlpanel.pt
M plone/app/discussion/browser/moderation.pt
M plone/app/discussion/profiles/default/metadata.xml
M plone/app/discussion/profiles/default/registry.xml
M plone/app/discussion/upgrades.py
M plone/app/discussion/upgrades.zcml
D plone/app/discussion/profiles/default/jsregistry.xml

b'diff --git a/docs/source/howtos/howto_override_comments_viewlet.txt b/docs/source/howtos/howto_override_comments_viewlet.txt\nindex 11c0248e..b45aba4f 100644\n--- a/docs/source/howtos/howto_override_comments_viewlet.txt\n+++ b/docs/source/howtos/howto_override_comments_viewlet.txt\n@@ -135,36 +135,4 @@ comments.py file with our custom version of the comments viewlet::\n                 return "%s/memberhome/%s" % (self.context.portal_url(), username)\n \n To override the comments viewlet template, we create a comment.pt file in the\n-same directory and copy the contents from::\n-\n-    ...\n-\n-\n-Override the comments viewlet Javascript\n-----------------------------------------\n-\n-Overriding the comments viewlet javascript works just like overriding the\n-comments viewlet. We register the javascript file for our custom browser\n-layer and remove the existing javascript file in\n-profiles/default/jsregistry.xml::\n-\n-    <?xml version="1.0"?>\n-    <object name="portal_javascripts">\n-     <!-- Remove plone.app.discussion comments javascript -->\n-     <javascript\n-         id="++resource++plone.app.discussion.javascripts/comments.js"\n-         remove="True"\n-         />\n-     <!-- Register a custom version of the plone.app.discussion javascript -->\n-     <javascript\n-         id="++resource++example.myaddonproduct.javascripts/comments.js" />\n-    </object>\n-\n-browser/configure.zcml::\n-\n-    <!-- Resource directory for javascripts -->\n-    <browser:resourceDirectory\n-      name="example.myaddonproduct.javascripts"\n-      directory="javascripts"\n-      layer="example.myaddonprocuts.interfaces.IBrowserLayer"\n-      />\n+same directory and copy the contents from the original.\ndiff --git a/news/157.bugfix b/news/157.bugfix\nnew file mode 100644\nindex 00000000..0b13d04a\n--- /dev/null\n+++ b/news/157.bugfix\n@@ -0,0 +1,2 @@\n+Fix reply to comment by adding old-school js-resources to legacy-bundle. Fix #157\n+[pbauer]\n\\ No newline at end of file\ndiff --git a/plone/app/discussion/browser/configure.zcml b/plone/app/discussion/browser/configure.zcml\nindex 6a0efa26..7bb5aace 100644\n--- a/plone/app/discussion/browser/configure.zcml\n+++ b/plone/app/discussion/browser/configure.zcml\n@@ -1,6 +1,7 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:browser="http://namespaces.zope.org/browser"\n+    xmlns:plone="http://namespaces.plone.org/plone"\n     xmlns:zcml="http://namespaces.zope.org/zcml"\n     i18n_domain="plone">\n \n@@ -129,10 +130,10 @@\n         />\n \n     <!-- Resource directory for javascripts -->\n-    <browser:resourceDirectory\n+    <plone:static\n         name="plone.app.discussion.javascripts"\n+        type="plone"\n         directory="javascripts"\n-        layer="..interfaces.IDiscussionLayer"\n         />\n \n     <!-- Control panel -->\ndiff --git a/plone/app/discussion/browser/controlpanel.pt b/plone/app/discussion/browser/controlpanel.pt\nindex b62a447e..d525fcba 100644\n--- a/plone/app/discussion/browser/controlpanel.pt\n+++ b/plone/app/discussion/browser/controlpanel.pt\n@@ -70,7 +70,7 @@\n     </div>\n \n   <script type="text/javascript"\n-          tal:attributes="src string:${portal_url}/++resource++plone.app.discussion.javascripts/controlpanel.js">\n+          tal:attributes="src string:${portal_url}/++plone++plone.app.discussion.javascripts/controlpanel.js">\n   </script>\n \n </article>\ndiff --git a/plone/app/discussion/browser/moderation.pt b/plone/app/discussion/browser/moderation.pt\nindex 797c18ab..073d4d23 100644\n--- a/plone/app/discussion/browser/moderation.pt\n+++ b/plone/app/discussion/browser/moderation.pt\n@@ -18,7 +18,7 @@\n                     b_start request/b_start | b_start;\n                     moderation_enabled view/moderation_enabled;">\n         <script type="text/javascript"\n-            tal:attributes="src string:${context/portal_url}/++resource++plone.app.discussion.javascripts/moderation.js">\n+            tal:attributes="src string:${context/portal_url}/++plone++plone.app.discussion.javascripts/moderation.js">\n         </script>\n \n         <h1 class="documentFirstHeading" i18n:translate="heading_moderate_comments">\ndiff --git a/plone/app/discussion/profiles/default/jsregistry.xml b/plone/app/discussion/profiles/default/jsregistry.xml\ndeleted file mode 100644\nindex db55b255..00000000\n--- a/plone/app/discussion/profiles/default/jsregistry.xml\n+++ /dev/null\n@@ -1,7 +0,0 @@\n-<?xml version="1.0"?>\n-<object name="portal_javascripts">\n- <javascript\n-     id="++resource++plone.app.discussion.javascripts/comments.js"\n-     insert-after="collapsibleformfields.js"\n-     />\n-</object>\ndiff --git a/plone/app/discussion/profiles/default/metadata.xml b/plone/app/discussion/profiles/default/metadata.xml\nindex f14a7070..c779e86e 100644\n--- a/plone/app/discussion/profiles/default/metadata.xml\n+++ b/plone/app/discussion/profiles/default/metadata.xml\n@@ -1,6 +1,7 @@\n <metadata>\n- <version>1000</version>\n+ <version>1001</version>\n  <dependencies>\n+  <dependency>profile-plone.resource:default</dependency>\n   <dependency>profile-plone.app.registry:default</dependency>\n  </dependencies>\n </metadata>\ndiff --git a/plone/app/discussion/profiles/default/registry.xml b/plone/app/discussion/profiles/default/registry.xml\nindex 1e0d5355..ba7fe987 100644\n--- a/plone/app/discussion/profiles/default/registry.xml\n+++ b/plone/app/discussion/profiles/default/registry.xml\n@@ -4,4 +4,17 @@\n     <value key="edit_comment_enabled">False</value>\n     <value key="delete_own_comment_enabled">False</value>\n   </records>\n+\n+  <records prefix="plone.resources/plone-app-discussion"\n+            interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n+      <value key="js">++plone++plone.app.discussion.javascripts/comments.js</value>\n+  </records>\n+  <records prefix="plone.bundles/plone-legacy"\n+            interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n+    <value key="resources" purge="false">\n+      <element>plone-app-discussion</element>\n+    </value>\n+    <value key="last_compilation"></value>\n+  </records>\n+\n </registry>\ndiff --git a/plone/app/discussion/upgrades.py b/plone/app/discussion/upgrades.py\nindex d9114f4e..7a0e30c1 100644\n--- a/plone/app/discussion/upgrades.py\n+++ b/plone/app/discussion/upgrades.py\n@@ -61,3 +61,7 @@ def upgrade_comment_workflows(context):\n             comment.reindexObjectSecurity()\n         except (AttributeError, KeyError):\n             logger.info(\'Could not reindex comment {0}\'.format(brain.getURL()))\n+\n+\n+def add_js_to_plone_legacy(context):\n+    context.runImportStepFromProfile(default_profile, \'plone.app.registry\')\ndiff --git a/plone/app/discussion/upgrades.zcml b/plone/app/discussion/upgrades.zcml\nindex 9fa258c6..02a7e541 100644\n--- a/plone/app/discussion/upgrades.zcml\n+++ b/plone/app/discussion/upgrades.zcml\n@@ -51,4 +51,15 @@\n         />\n   </genericsetup:upgradeSteps>\n \n+  <genericsetup:upgradeSteps\n+      source="1000"\n+      destination="1001"\n+      profile="plone.app.discussion:default">\n+    <genericsetup:upgradeStep\n+        title="Move comment.js into plone-legacy bundle"\n+        description=""\n+        handler=".upgrades.add_js_to_plone_legacy"\n+        />\n+  </genericsetup:upgradeSteps>\n+\n </configure>\n'

