Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-11-25T01:10:27+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/a3d920bbc94f1f525230ed42941177ae2754ea8e

fix #3323

Files changed:
A news/3323.bugifx
M Products/CMFPlone/Portal.py

b'diff --git a/Products/CMFPlone/Portal.py b/Products/CMFPlone/Portal.py\nindex 0474b4f6ca..4c49cce3a1 100644\n--- a/Products/CMFPlone/Portal.py\n+++ b/Products/CMFPlone/Portal.py\n@@ -139,6 +139,24 @@ def __before_publishing_traverse__(self, arg1, arg2=None):\n \n         super(PloneSite, self).__before_publishing_traverse__(arg1, arg2)\n \n+    # Partly from OFS.OrderSupport\n+    @security.protected(permissions.AccessContentsInformation)\n+    def tpValues(self):\n+        # Return a list of subobjects, used by ZMI tree tag (and only there).\n+        # see also https://github.com/plone/Products.CMFPlone/issues/3323\n+        result = []\n+        obj_ids = self.objectIds()\n+        obj_ids.sort()\n+        getOb = self._getOb\n+        for id in obj_ids:\n+            obj = getOb(id)\n+            if (\n+                hasattr(aq_base(obj), \'isPrincipiaFolderish\')\n+                and obj.isPrincipiaFolderish\n+            ):\n+                result.append(obj)\n+        return result\n+\n     def __browser_default__(self, request):\n         """ Set default so we can return whatever we want instead\n         of index_html """\ndiff --git a/news/3323.bugifx b/news/3323.bugifx\nnew file mode 100644\nindex 0000000000..957a8924b3\n--- /dev/null\n+++ b/news/3323.bugifx\n@@ -0,0 +1,2 @@\n+Fix #3323DX-Site-Root: ZMI Nav-Tree is no longer expandable.\n+[jensens]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-11-25T13:19:04+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/a918fae09ef30aee59f1ba58870234a9ded6e210

Merge branch 'master' into fix-3323

Files changed:
A news/3337.bugfix
A news/3366.bugfix
M Products/CMFPlone/Portal.py

b'diff --git a/Products/CMFPlone/Portal.py b/Products/CMFPlone/Portal.py\nindex 4c49cce3a1..d668f40b5a 100644\n--- a/Products/CMFPlone/Portal.py\n+++ b/Products/CMFPlone/Portal.py\n@@ -6,7 +6,6 @@\n from five.localsitemanager.registry import PersistentComponents\n from OFS.ObjectManager import REPLACEABLE\n from plone.dexterity.content import Container\n-from plone.i18n.locales.interfaces import IMetadataLanguageAvailability\n from Products.CMFCore import permissions\n from Products.CMFCore.interfaces import IContentish\n from Products.CMFCore.interfaces import ISiteRoot\n@@ -34,7 +33,6 @@\n from Products.CMFPlone.permissions import ReplyToItem\n from Products.CMFPlone.permissions import View\n from Products.Five.component.interfaces import IObjectManagerSite\n-from zope.component import queryUtility\n from zope.interface.interfaces import ComponentLookupError\n from zope.event import notify\n from zope.interface import classImplementsOnly\n@@ -192,8 +190,7 @@ def manage_beforeDelete(self, container, item):\n         PloneSite.inheritedAttribute(\'manage_beforeDelete\')(self, container,\n                                                             item)\n \n-    security.declareProtected(permissions.DeleteObjects, \'manage_delObjects\')\n-\n+    @security.protected(permissions.DeleteObjects)\n     def manage_delObjects(self, ids=None, REQUEST=None):\n         """We need to enforce security."""\n         if ids is None:\n@@ -213,9 +210,7 @@ def view(self):\n         """\n         return self()\n \n-    security.declareProtected(permissions.AccessContentsInformation,\n-                              \'folderlistingFolderContents\')\n-\n+    @security.protected(permissions.AccessContentsInformation)\n     def folderlistingFolderContents(self, contentFilter=None):\n         """Calls listFolderContents in protected only by ACI so that\n         folder_listing can work without the List folder contents permission.\n@@ -225,17 +220,6 @@ def folderlistingFolderContents(self, contentFilter=None):\n         """\n         return self.listFolderContents(contentFilter)\n \n-    security.declarePublic(\'availableLanguages\')\n-\n-    def availableLanguages(self):\n-        util = queryUtility(IMetadataLanguageAvailability)\n-        languages = util.getLanguageListing()\n-        languages.sort(lambda x, y: cmp(x[1], y[1]))\n-        # Put language neutral at the top.\n-        languages.insert(0, (\'\', _(\'Language neutral (site default)\')))\n-\n-        return languages\n-\n     def isEffective(self, date):\n         # Override DefaultDublinCoreImpl\'s test, since we are always viewable.\n         return 1\ndiff --git a/news/3337.bugfix b/news/3337.bugfix\nnew file mode 100644\nindex 0000000000..e37d1f9b8c\n--- /dev/null\n+++ b/news/3337.bugfix\n@@ -0,0 +1,3 @@\n+Fixes #3337: \n+Remove dead code that wont work in Py 3 anyway if called (cmp).\n+[jensens]\ndiff --git a/news/3366.bugfix b/news/3366.bugfix\nnew file mode 100644\nindex 0000000000..29be868560\n--- /dev/null\n+++ b/news/3366.bugfix\n@@ -0,0 +1,2 @@\n+In Portal: use security decorators\n+[jensens]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-11-25T13:26:14+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/c8d8805b18f7974bd6129c9a717f6680bc6fac0e

optimization suggested by @ale-rt

Files changed:
M Products/CMFPlone/Portal.py

b'diff --git a/Products/CMFPlone/Portal.py b/Products/CMFPlone/Portal.py\nindex d668f40b5a..024a9e49cf 100644\n--- a/Products/CMFPlone/Portal.py\n+++ b/Products/CMFPlone/Portal.py\n@@ -137,23 +137,15 @@ def __before_publishing_traverse__(self, arg1, arg2=None):\n \n         super(PloneSite, self).__before_publishing_traverse__(arg1, arg2)\n \n-    # Partly from OFS.OrderSupport\n+    # Concept from OFS.OrderSupport\n     @security.protected(permissions.AccessContentsInformation)\n     def tpValues(self):\n         # Return a list of subobjects, used by ZMI tree tag (and only there).\n         # see also https://github.com/plone/Products.CMFPlone/issues/3323\n-        result = []\n-        obj_ids = self.objectIds()\n-        obj_ids.sort()\n-        getOb = self._getOb\n-        for id in obj_ids:\n-            obj = getOb(id)\n-            if (\n-                hasattr(aq_base(obj), \'isPrincipiaFolderish\')\n-                and obj.isPrincipiaFolderish\n-            ):\n-                result.append(obj)\n-        return result\n+        return sorted(\n+            (obj for obj in self.objectValues() if getattr(aq_base(obj), \'isPrincipiaFolderish\', False)),\n+            key=lambda obj: obj.getId(),\n+        )\n \n     def __browser_default__(self, request):\n         """ Set default so we can return whatever we want instead\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-11-25T19:07:16+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/6a951f90e92a22d6ef29b16a25c44de4874f6bd6

Merge pull request #3367 from plone/fix-3323

fix #3323

Files changed:
A news/3323.bugifx
M Products/CMFPlone/Portal.py

b'diff --git a/Products/CMFPlone/Portal.py b/Products/CMFPlone/Portal.py\nindex 8710dbbb18..024a9e49cf 100644\n--- a/Products/CMFPlone/Portal.py\n+++ b/Products/CMFPlone/Portal.py\n@@ -137,6 +137,16 @@ def __before_publishing_traverse__(self, arg1, arg2=None):\n \n         super(PloneSite, self).__before_publishing_traverse__(arg1, arg2)\n \n+    # Concept from OFS.OrderSupport\n+    @security.protected(permissions.AccessContentsInformation)\n+    def tpValues(self):\n+        # Return a list of subobjects, used by ZMI tree tag (and only there).\n+        # see also https://github.com/plone/Products.CMFPlone/issues/3323\n+        return sorted(\n+            (obj for obj in self.objectValues() if getattr(aq_base(obj), \'isPrincipiaFolderish\', False)),\n+            key=lambda obj: obj.getId(),\n+        )\n+\n     def __browser_default__(self, request):\n         """ Set default so we can return whatever we want instead\n         of index_html """\ndiff --git a/news/3323.bugifx b/news/3323.bugifx\nnew file mode 100644\nindex 0000000000..957a8924b3\n--- /dev/null\n+++ b/news/3323.bugifx\n@@ -0,0 +1,2 @@\n+Fix #3323DX-Site-Root: ZMI Nav-Tree is no longer expandable.\n+[jensens]\n\\ No newline at end of file\n'

