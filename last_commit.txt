Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-10-24T15:37:44-07:00
Author: Jon Pentland (instification) <instification@users.noreply.github.com>
Commit: https://github.com/plone/plone.restapi/commit/b4f4967f4e656549cbd70188288d2f8ea67eb0b6

Fix test_statictime for p.a.discussion comments (#1520)

* Fix test_statictime for p.a.discussion comments

* Use portal timezone when testing comment dates

* Add changelog entry

* Support newer/older versions of p.a.discussion

* black

* compare against p.a.discussion 4.0.0b4.dev1

* Update p.a.discussion discovery. Check for presence of localized_now. Use more descriptive variable name

* remove unused imports

Files changed:
A news/1520.bugfix
M src/plone/restapi/tests/test_statictime.py

b'diff --git a/news/1520.bugfix b/news/1520.bugfix\nnew file mode 100644\nindex 000000000..612025511\n--- /dev/null\n+++ b/news/1520.bugfix\n@@ -0,0 +1,2 @@\n+Update statictime tests following changes to p.a.disucssion (see \n+https://github.com/plone/plone.app.discussion/pull/204) - [instification]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/tests/test_statictime.py b/src/plone/restapi/tests/test_statictime.py\nindex 35c508e81..95ade5be3 100644\n--- a/src/plone/restapi/tests/test_statictime.py\n+++ b/src/plone/restapi/tests/test_statictime.py\n@@ -1,11 +1,14 @@\n from datetime import datetime\n from DateTime import DateTime\n from datetime import timedelta\n+from dateutil import tz\n from operator import itemgetter\n from plone import api\n from plone.app.discussion.interfaces import IConversation\n from plone.app.discussion.interfaces import IDiscussionSettings\n from plone.app.discussion.interfaces import IReplies\n+from plone.app.discussion import comment\n+from plone.app.event.base import default_timezone\n from plone.app.layout.viewlets.content import ContentHistoryViewlet\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n@@ -25,6 +28,10 @@\n import transaction\n import unittest\n \n+# Check if comments from p.a.discussion are tz aware\n+# Introduced via https://github.com/plone/plone.app.discussion/pull/204\n+HAS_TZ_AWARE_COMMENTS = hasattr(comment, "localized_now")\n+\n \n class TestStaticTime(unittest.TestCase):\n \n@@ -75,12 +82,20 @@ def assert_roughly_now(self, dt):\n         if isinstance(pydt, DateTime):\n             pydt = pydt.asdatetime()\n         elif isinstance(pydt, float):\n-            pydt = datetime.fromtimestamp(pydt)\n+            if HAS_TZ_AWARE_COMMENTS:\n+                pydt = datetime.fromtimestamp(pydt).astimezone(\n+                    tz.gettz(default_timezone())\n+                )\n+            else:\n+                pydt = datetime.fromtimestamp(pydt)\n \n         epsilon = timedelta(minutes=5)\n-        now = datetime.now()\n-        if pydt.tzinfo is not None:\n-            now = pydt.tzinfo.localize(now)\n+        if HAS_TZ_AWARE_COMMENTS:\n+            now = datetime.now().astimezone(tz.gettz(default_timezone()))\n+        else:\n+            now = datetime.now()\n+            if pydt.tzinfo is not None:\n+                now = pydt.tzinfo.localize(now)\n \n         upper = now + epsilon\n         lower = now - epsilon\n@@ -136,7 +151,12 @@ def test_statictime_dxcontent_modified(self):\n         self.assert_of_same_type(fake_datetimes, real_datetimes)\n \n     def test_statictime_comment_created(self):\n-        frozen_time = datetime(1950, 7, 31, 13, 45)\n+        if HAS_TZ_AWARE_COMMENTS:\n+            frozen_time = datetime(1950, 7, 31, 13, 45).astimezone(\n+                tz.gettz(default_timezone())\n+            )\n+        else:\n+            frozen_time = datetime(1950, 7, 31, 13, 45)\n         statictime = StaticTime(created=frozen_time)\n \n         statictime.start()\n@@ -154,7 +174,12 @@ def test_statictime_comment_created(self):\n         self.assert_of_same_type(fake_datetimes, real_datetimes)\n \n     def test_statictime_comment_modified(self):\n-        frozen_time = datetime(1950, 7, 31, 17, 30)\n+        if HAS_TZ_AWARE_COMMENTS:\n+            frozen_time = datetime(1950, 7, 31, 17, 30).astimezone(\n+                tz.gettz(default_timezone())\n+            )\n+        else:\n+            frozen_time = datetime(1950, 7, 31, 17, 30)\n         statictime = StaticTime(modified=frozen_time)\n \n         statictime.start()\n'

