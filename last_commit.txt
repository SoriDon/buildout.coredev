Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-11-18T03:01:13+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.restapi/commit/bf6b573ba4f9f3f2c61c71d08c807940399e2b4e

Fix AttributeError REQUEST in linkintegrity when pasting nested content (#1537)

Fix AttributeError for REQUEST in linkintegrity when pasting nested content.

Fixes https://github.com/plone/plone.restapi/issues/1536

Files changed:
A news/1536.bugfix
M src/plone/restapi/blocks_linkintegrity.py

b'diff --git a/news/1536.bugfix b/news/1536.bugfix\nnew file mode 100644\nindex 000000000..ab0674207\n--- /dev/null\n+++ b/news/1536.bugfix\n@@ -0,0 +1,2 @@\n+Fix AttributeError for ``REQUEST`` in linkintegrity when pasting nested content.\n+[maurits]\ndiff --git a/src/plone/restapi/blocks_linkintegrity.py b/src/plone/restapi/blocks_linkintegrity.py\nindex ab62ad283..b65aefdca 100644\n--- a/src/plone/restapi/blocks_linkintegrity.py\n+++ b/src/plone/restapi/blocks_linkintegrity.py\n@@ -6,6 +6,7 @@\n from plone.restapi.interfaces import IBlockFieldLinkIntegrityRetriever\n from zope.component import adapter\n from zope.component import subscribers\n+from zope.globalrequest import getRequest\n from zope.interface import implementer\n from zope.publisher.interfaces.browser import IBrowserRequest\n \n@@ -19,11 +20,17 @@ def retrieveLinks(self):\n         """Finds all links from the object and return them."""\n         links = set()\n         blocks = getattr(self.context, "blocks", {})\n+        if not blocks:\n+            return links\n+        request = getattr(self.context, "REQUEST", None)\n+        if request is None:\n+            # context does not have full acquisition chain\n+            request = getRequest()\n         for block in blocks.values():\n             block_type = block.get("@type", None)\n             handlers = []\n             for h in subscribers(\n-                (self.context, self.context.REQUEST),\n+                (self.context, request),\n                 IBlockFieldLinkIntegrityRetriever,\n             ):\n                 if h.block_type == block_type or h.block_type is None:\n'

