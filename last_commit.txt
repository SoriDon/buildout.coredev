Repository: plone.app.layout


Branch: refs/heads/master
Date: 2019-06-29T23:31:55+02:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.app.layout/commit/eda5c87b1fec265c885c512df789ddb25bfef5f1

fix portal_tabs_view.topLevelTabs called twice

Files changed:
A news/201.bugfix
M plone/app/layout/viewlets/common.py

b"diff --git a/news/201.bugfix b/news/201.bugfix\nnew file mode 100644\nindex 00000000..354ece59\n--- /dev/null\n+++ b/news/201.bugfix\n@@ -0,0 +1,2 @@\n+fix portal_tabs_view.topLevelTabs called twice\n+[mamico]\ndiff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex a1fd7a56..1eda4d42 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -272,11 +272,8 @@ def current_language(self):\n     @memoize\n     def navtree(self):\n         ret = defaultdict(list)\n-        portal_tabs_view = getMultiAdapter((self.context, self.request),\n-                                           name='portal_tabs_view')\n-        tabs = portal_tabs_view.topLevelTabs()\n         navtree_path = self.navtree_path\n-        for tab in tabs:\n+        for tab in self.portal_tabs:\n             entry = tab.copy()\n             entry.update({\n                 'path': '/'.join((navtree_path, tab['id'])),\n"

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2019-07-04T17:01:05+02:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.app.layout/commit/6e2c47713f757e06291ad5b23d783e1cb6b399c6

memoize topLevelTabs

Files changed:
M plone/app/layout/viewlets/common.py

b"diff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex 1eda4d42..79b9fbc0 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -387,12 +387,15 @@ def build_tree(self, path, first_run=True):\n     def render_globalnav(self):\n         return self.build_tree(self.navtree_path)\n \n+    @property\n+    @memoize\n+    def portal_tabs(self):\n+        portal_tabs_view = getMultiAdapter((self.context, self.request),\n+               name='portal_tabs_view')\n+        return portal_tabs_view.topLevelTabs()\n+\n     def update(self):\n         context = aq_inner(self.context)\n-        portal_tabs_view = getMultiAdapter((context, self.request),\n-                                           name='portal_tabs_view')\n-        self.portal_tabs = portal_tabs_view.topLevelTabs()\n-\n         self.selected_tabs = self.selectedTabs(portal_tabs=self.portal_tabs)\n         self.selected_portal_tab = self.selected_tabs['portal']\n \n"

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2019-07-04T18:12:13+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/441f4543c8e8387670f12939040739849fcde808

Merge pull request #201 from mamico/master

fix portal_tabs_view.topLevelTabs called twice

Files changed:
A news/201.bugfix
M plone/app/layout/viewlets/common.py

b"diff --git a/news/201.bugfix b/news/201.bugfix\nnew file mode 100644\nindex 00000000..354ece59\n--- /dev/null\n+++ b/news/201.bugfix\n@@ -0,0 +1,2 @@\n+fix portal_tabs_view.topLevelTabs called twice\n+[mamico]\ndiff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex a1fd7a56..79b9fbc0 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -272,11 +272,8 @@ def current_language(self):\n     @memoize\n     def navtree(self):\n         ret = defaultdict(list)\n-        portal_tabs_view = getMultiAdapter((self.context, self.request),\n-                                           name='portal_tabs_view')\n-        tabs = portal_tabs_view.topLevelTabs()\n         navtree_path = self.navtree_path\n-        for tab in tabs:\n+        for tab in self.portal_tabs:\n             entry = tab.copy()\n             entry.update({\n                 'path': '/'.join((navtree_path, tab['id'])),\n@@ -390,12 +387,15 @@ def build_tree(self, path, first_run=True):\n     def render_globalnav(self):\n         return self.build_tree(self.navtree_path)\n \n+    @property\n+    @memoize\n+    def portal_tabs(self):\n+        portal_tabs_view = getMultiAdapter((self.context, self.request),\n+               name='portal_tabs_view')\n+        return portal_tabs_view.topLevelTabs()\n+\n     def update(self):\n         context = aq_inner(self.context)\n-        portal_tabs_view = getMultiAdapter((context, self.request),\n-                                           name='portal_tabs_view')\n-        self.portal_tabs = portal_tabs_view.topLevelTabs()\n-\n         self.selected_tabs = self.selectedTabs(portal_tabs=self.portal_tabs)\n         self.selected_portal_tab = self.selected_tabs['portal']\n \n"

