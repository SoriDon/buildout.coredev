Repository: plone.volto


Branch: refs/heads/main
Date: 2021-11-07T16:26:43+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.volto/commit/dcea0f45666ddb34896aa1c33d6f5eceb1ac927b

Use new metadata utility for adding the image_field to the default se… (#20)

* Use new metadata utility for adding the image_field to the default serialization

* Fix naming

* Constrain the minimum p.restapi version that works with the new metadata utility

* Zpretty happy

* Update CHANGES.rst

Co-authored-by: Timo Stollenwerk &lt;tisto@users.noreply.github.com&gt;

Files changed:
A src/plone/volto/summary.py
M CHANGES.rst
M setup.py
M src/plone/volto/configure.zcml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex fe6d5ce..d5fb4a7 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -4,6 +4,9 @@ Changelog\n 3.1.0a5 (unreleased)\n --------------------\n \n+- Use new metadata utility for adding the ``image_field`` to the default serialization. This feature requires the JSONSummarySerializerMetadata serializer that has been added with plone.restapi 8.13.0.\n+  [ericof]\n+\n Internal:\n \n - Use plone/setup-plone github action.\ndiff --git a/setup.py b/setup.py\nindex 8a1c96b..b16c76f 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -42,8 +42,8 @@ def readfile(name):\n         "License :: OSI Approved :: GNU General Public License v2 (GPLv2)",\n     ],\n     keywords="Python Plone CMS",\n-    author=\'Plone Foundation\',\n-    author_email=\'releasemanager@plone.org\',\n+    author="Plone Foundation",\n+    author_email="releasemanager@plone.org",\n     url="https://github.com/plone/plone.volto",\n     license="GPL version 2",\n     packages=find_packages("src", exclude=["ez_setup"]),\n@@ -56,7 +56,7 @@ def readfile(name):\n         "plone.api",\n         "Products.GenericSetup",\n         "setuptools",\n-        "plone.restapi",\n+        "plone.restapi>=8.13.0",\n         "collective.folderishtypes[dexterity]",\n     ],\n     extras_require={\ndiff --git a/src/plone/volto/configure.zcml b/src/plone/volto/configure.zcml\nindex e8e6af8..df6c21a 100644\n--- a/src/plone/volto/configure.zcml\n+++ b/src/plone/volto/configure.zcml\n@@ -111,6 +111,11 @@\n       name="image_field"\n       />\n \n+  <utility\n+      factory=".summary.JSONSummarySerializerMetadata"\n+      name="plone.volto.summary_serializer_metadata"\n+      />\n+\n   <configure zcml:condition="have plonerestapi-7">\n     <subscriber\n         factory=".transforms.NestedResolveUIDDeserializer"\ndiff --git a/src/plone/volto/summary.py b/src/plone/volto/summary.py\nnew file mode 100644\nindex 0000000..8b314e9\n--- /dev/null\n+++ b/src/plone/volto/summary.py\n@@ -0,0 +1,10 @@\n+from plone.restapi.interfaces import IJSONSummarySerializerMetadata\n+from zope.interface import implementer\n+\n+\n+@implementer(IJSONSummarySerializerMetadata)\n+class JSONSummarySerializerMetadata:\n+    def default_metadata_fields(self):\n+        return {\n+            "image_field",\n+        }\n'

