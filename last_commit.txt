Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:10:32+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/a288ae3854ae4b1b15d003c0a2b837dca15316f8

Configuring with plone/meta

Files changed:
A .editorconfig
A .meta.toml
A .pre-commit-config.yaml
A news/243ca9ec.internal
A tox.ini
M pyproject.toml
M setup.cfg

b'diff --git a/.editorconfig b/.editorconfig\nnew file mode 100644\nindex 0000000..b4158b8\n--- /dev/null\n+++ b/.editorconfig\n@@ -0,0 +1,39 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+#\n+# EditorConfig Configuration file, for more details see:\n+# http://EditorConfig.org\n+# EditorConfig is a convention description, that could be interpreted\n+# by multiple editors to enforce common coding conventions for specific\n+# file types\n+\n+# top-most EditorConfig file:\n+# Will ignore other EditorConfig files in Home directory or upper tree level.\n+root = true\n+\n+\n+[*]  # For All Files\n+# Unix-style newlines with a newline ending every file\n+end_of_line = lf\n+insert_final_newline = true\n+trim_trailing_whitespace = true\n+# Set default charset\n+charset = utf-8\n+# Indent style default\n+indent_style = space\n+# Max Line Length - a hard line wrap, should be disabled\n+max_line_length = off\n+\n+[*.{py,cfg,ini}]\n+# 4 space indentation\n+indent_size = 4\n+\n+[*.{yml,zpt,pt,dtml,zcml}]\n+# 2 space indentation\n+indent_size = 2\n+\n+[{Makefile,.gitmodules}]\n+# Tab indentation (no size specified, but view as 4 spaces)\n+indent_style = tab\n+indent_size = unset\n+tab_width = unset\ndiff --git a/.meta.toml b/.meta.toml\nnew file mode 100644\nindex 0000000..4ed1a1d\n--- /dev/null\n+++ b/.meta.toml\n@@ -0,0 +1,5 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+[meta]\n+template = "default"\n+commit-id = "789b0936"\ndiff --git a/.pre-commit-config.yaml b/.pre-commit-config.yaml\nnew file mode 100644\nindex 0000000..582f8ac\n--- /dev/null\n+++ b/.pre-commit-config.yaml\n@@ -0,0 +1,42 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+ci:\n+    autofix_prs: false\n+    autoupdate_schedule: monthly\n+\n+repos:\n+-   repo: https://github.com/asottile/pyupgrade\n+    rev: v3.3.1\n+    hooks:\n+    -   id: pyupgrade\n+        args: [--py38-plus]\n+-   repo: https://github.com/pycqa/isort\n+    rev: 5.12.0\n+    hooks:\n+    -   id: isort\n+-   repo: https://github.com/psf/black\n+    rev: 23.1.0\n+    hooks:\n+    -   id: black\n+-   repo: https://github.com/collective/zpretty\n+    rev: 3.0.2\n+    hooks:\n+    -   id: zpretty\n+-   repo: https://github.com/PyCQA/flake8\n+    rev: 6.0.0\n+    hooks:\n+    -   id: flake8\n+-   repo: https://github.com/codespell-project/codespell\n+    rev: v2.2.2\n+    hooks:\n+    -   id: codespell\n+        additional_dependencies:\n+          - tomli\n+-   repo: https://github.com/mgedmin/check-manifest\n+    rev: "0.49"\n+    hooks:\n+    -   id: check-manifest\n+-   repo: https://github.com/regebro/pyroma\n+    rev: "4.2"\n+    hooks:\n+    -   id: pyroma\ndiff --git a/news/243ca9ec.internal b/news/243ca9ec.internal\nnew file mode 100644\nindex 0000000..c08f539\n--- /dev/null\n+++ b/news/243ca9ec.internal\n@@ -0,0 +1,2 @@\n+Update configuration files.\n+[plone devs]\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 4dca648..9eb73f3 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -1,3 +1,5 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n [tool.towncrier]\n filename = "CHANGES.rst"\n directory = "news/"\n@@ -19,9 +21,42 @@ directory = "bugfix"\n name = "Bug fixes:"\n showcontent = true\n \n+[[tool.towncrier.type]]\n+directory = "internal"\n+name = "Internal:"\n+showcontent = true\n+\n+[[tool.towncrier.type]]\n+directory = "documentation"\n+name = "Documentation:"\n+showcontent = true\n+\n+[[tool.towncrier.type]]\n+directory = "tests"\n+name = "Tests"\n+showcontent = true\n+\n [tool.isort]\n-# black compatible Plone isort rules:\n-profile = "black"\n-force_alphabetical_sort = true\n-force_single_line = true\n-lines_after_imports = 2\n\\ No newline at end of file\n+profile = "plone"\n+\n+[tool.black]\n+target-version = ["py38"]\n+\n+[tool.dependencychecker]\n+Zope = [\n+  # Zope own provided namespaces\n+  \'App\', \'OFS\', \'Products.Five\', \'Products.OFSP\', \'Products.PageTemplates\',\n+  \'Products.SiteAccess\', \'Shared\', \'Testing\', \'ZPublisher\', \'ZTUtils\',\n+  \'Zope2\', \'webdav\', \'zmi\',\n+  # Zope dependencies\n+  \'Acquisition\', \'DateTime\', \'transaction\', \'zExceptions\', \'ZODB\', \'zope.component\',\n+  \'zope.configuration\', \'zope.container\', \'zope.deferredimport\', \'zope.event\',\n+  \'zope.exceptions\', \'zope.globalrequest\', \'zope.i18n\', \'zope.i18nmessageid\',\n+  \'zope.interface\', \'zope.lifecycleevent\', \'zope.location\', \'zope.publisher\',\n+  \'zope.schema\', \'zope.security\', \'zope.site\', \'zope.traversing\', \'AccessControl\',\n+]\n+\'plone.base\' = [\n+  \'AccessControl\', \'Products.BTreeFolder2\', \'Products.CMFCore\',\n+  \'Products.CMFDynamicViewFTI\', \'zope.deprecation\',\n+]\n+python-dateutil = [\'dateutil\']\ndiff --git a/setup.cfg b/setup.cfg\nindex ffe928a..4a2916b 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -1,8 +1,25 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+[bdist_wheel]\n+universal = 0\n+\n+[flake8]\n+doctests = 1\n+ignore =\n+    # black takes care of line length\n+    E501,\n+    # black takes care of where to break lines\n+    W503,\n+    # black takes care of spaces within slicing (list[:])\n+    E203,\n+    # black takes care of spaces after commas\n+    E231,\n+\n [check-manifest]\n ignore =\n+    .editorconfig\n+    .meta.toml\n+    .pre-commit-config.yaml\n+    tox.ini\n     *.cfg\n     requirements.txt\n-\n-\n-[bdist_wheel]\n-universal = 0\ndiff --git a/tox.ini b/tox.ini\nnew file mode 100644\nindex 0000000..4e18961\n--- /dev/null\n+++ b/tox.ini\n@@ -0,0 +1,50 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+[tox]\n+envlist =\n+    format\n+    lint\n+    test\n+\n+[testenv]\n+allowlist_externals =\n+    sh\n+\n+[testenv:format]\n+description = automatically reformat code\n+skip_install = true\n+deps =\n+    pre-commit\n+commands =\n+    pre-commit run -a pyupgrade\n+    pre-commit run -a isort\n+    pre-commit run -a black\n+    pre-commit run -a zpretty\n+\n+[testenv:lint]\n+description = run linters that will help improve the code style\n+skip_install = true\n+deps =\n+    pre-commit\n+commands =\n+    pre-commit run -a\n+\n+[testenv:dependencies]\n+description = check if the package defines all its dependencies and generate a graph out of them\n+deps =\n+    z3c.dependencychecker==2.11\n+    pipdeptree==2.5.1\n+    graphviz  # optional dependency of pipdeptree\n+commands =\n+    dependencychecker\n+    sh -c \'pipdeptree --exclude setuptools,wheel,pipdeptree,z3c.dependencychecker,zope.interface,zope.component --graph-output svg > dependencies.svg\'\n+\n+[testenv:test]\n+usedevelop = true\n+deps =\n+    zope.testrunner\n+    -c https://dist.plone.org/release/6.0-dev/constraints.txt\n+commands =\n+    zope-testrunner --test-path={toxinidir} -s plone.app.z3cform\n+extras =\n+    test\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:10:44+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/c4bbfa7d1355bd26eda140510665c5f710208865

chore: pyupgrade

Files changed:
M plone/app/z3cform/widget.py

b'diff --git a/plone/app/z3cform/widget.py b/plone/app/z3cform/widget.py\nindex 95e89cb..c1507a6 100644\n--- a/plone/app/z3cform/widget.py\n+++ b/plone/app/z3cform/widget.py\n@@ -788,7 +788,7 @@ def render_input_mode(self):\n             mt_select = etree.Element("select")\n             mt_select.attrib["id"] = f"{self.id}_text_format"\n             mt_select.attrib["name"] = f"{self.name}.mimeType"\n-            mt_select.attrib["class"] = "form-select {}".format(mt_pattern_name)\n+            mt_select.attrib["class"] = f"form-select {mt_pattern_name}"\n             mt_select.attrib[f"data-{mt_pattern_name}"] = json.dumps(\n                 {\n                     "textareaName": self.name,\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:10:44+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/4376d97885299d55a5cf05c1cde2400aff7a810f

fix: isort is configured in pyproject.toml now

Files changed:
D .isort.cfg

b'diff --git a/.isort.cfg b/.isort.cfg\ndeleted file mode 100644\nindex dd9f25d..0000000\n--- a/.isort.cfg\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-[settings]\n-force_alphabetical_sort = True\n-force_single_line = True\n-lines_after_imports = 2\n-line_length = 200\n-not_skip = __init__.py\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:10:44+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/8395f06bcdc766c720965760f24ec9af2ef66804

chore: isort

Files changed:
M plone/app/z3cform/converters.py
M plone/app/z3cform/interfaces.py
M plone/app/z3cform/tests/test_widgets.py

b'diff --git a/plone/app/z3cform/converters.py b/plone/app/z3cform/converters.py\nindex cf3dabe..5cb72c2 100644\n--- a/plone/app/z3cform/converters.py\n+++ b/plone/app/z3cform/converters.py\n@@ -11,9 +11,9 @@\n from plone.app.z3cform.interfaces import ISelectWidget\n from plone.app.z3cform.interfaces import ISingleCheckBoxBoolWidget\n from plone.app.z3cform.interfaces import ITimeWidget\n+from plone.base.utils import safe_callable\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n-from plone.base.utils import safe_callable\n from z3c.form.converter import BaseDataConverter\n from z3c.form.converter import CollectionSequenceDataConverter\n from z3c.form.converter import SequenceDataConverter\ndiff --git a/plone/app/z3cform/interfaces.py b/plone/app/z3cform/interfaces.py\nindex 6ffce27..82f09f4 100644\n--- a/plone/app/z3cform/interfaces.py\n+++ b/plone/app/z3cform/interfaces.py\n@@ -1,6 +1,4 @@\n-from plone.app.textfield.widget import (\n-    IRichTextWidget as patextfield_IRichTextWidget,\n-)  # noqa\n+from plone.app.textfield.widget import IRichTextWidget as patextfield_IRichTextWidget\n from z3c.form.interfaces import IFormLayer\n from z3c.form.interfaces import IRadioWidget\n from z3c.form.interfaces import ISelectWidget as IBaseSelectWidget\ndiff --git a/plone/app/z3cform/tests/test_widgets.py b/plone/app/z3cform/tests/test_widgets.py\nindex 726b7c0..180b20e 100644\n--- a/plone/app/z3cform/tests/test_widgets.py\n+++ b/plone/app/z3cform/tests/test_widgets.py\n@@ -13,12 +13,12 @@\n from plone.app.z3cform.widget import RelatedItemsWidget\n from plone.autoform.directives import widget\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base.interfaces import IMarkupSchema\n from plone.dexterity.fti import DexterityFTI\n from plone.registry.interfaces import IRegistry\n from plone.supermodel.model import Schema\n from plone.testing.zca import UNIT_TESTING\n from plone.uuid.interfaces import IUUID\n-from plone.base.interfaces import IMarkupSchema\n from unittest import mock\n from unittest.mock import Mock\n from z3c.form.form import EditForm\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:10:44+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/192d3bfa8aaf461b2d4b0572bfb299be7fef0b70

chore: black

Files changed:
M plone/app/z3cform/converters.py
M plone/app/z3cform/tests/test_widget.py
M plone/app/z3cform/tests/test_widgets.py
M plone/app/z3cform/widget.py
M plone/app/z3cform/wysiwyg/widget.py
M setup.py

b'diff --git a/plone/app/z3cform/converters.py b/plone/app/z3cform/converters.py\nindex 5cb72c2..715b74d 100644\n--- a/plone/app/z3cform/converters.py\n+++ b/plone/app/z3cform/converters.py\n@@ -126,6 +126,7 @@ def toFieldValue(self, value):\n             ret = tzinfo.localize(ret)\n         return ret\n \n+\n @adapter(IDatetime, IDateWidget)\n class DateWidgetToDatetimeConverter(BaseDataConverter):\n     """Data converter for date widget on datetime fields."""\n@@ -180,6 +181,7 @@ def toFieldValue(self, value):\n             ret = tzinfo.localize(ret)\n         return ret\n \n+\n @adapter(ITime, ITimeWidget)\n class TimeWidgetConverter(BaseDataConverter):\n     """Data converter for datetime fields."""\ndiff --git a/plone/app/z3cform/tests/test_widget.py b/plone/app/z3cform/tests/test_widget.py\nindex 008d63e..264d935 100644\n--- a/plone/app/z3cform/tests/test_widget.py\n+++ b/plone/app/z3cform/tests/test_widget.py\n@@ -23,7 +23,6 @@ class NoAcquisitionAware:\n \n \n class TestWidget(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\ndiff --git a/plone/app/z3cform/tests/test_widgets.py b/plone/app/z3cform/tests/test_widgets.py\nindex 180b20e..adb19a1 100644\n--- a/plone/app/z3cform/tests/test_widgets.py\n+++ b/plone/app/z3cform/tests/test_widgets.py\n@@ -265,7 +265,7 @@ def test_fieldwidget(self):\n \n     def test_dateformatter(self):\n         self.widget.value = "2022-08-17"\n-        self.assertIn(" value=\\"2022-08-17\\" ", self.widget.render())\n+        self.assertIn(\' value="2022-08-17" \', self.widget.render())\n \n         self.widget.mode = "display"\n         self.assertEqual("8/17/22", self.widget.render())\n@@ -440,7 +440,7 @@ def test_fieldwidget(self):\n \n     def test_datetimeformatter(self):\n         self.widget.value = "2022-08-17T12:00"\n-        self.assertIn(" value=\\"2022-08-17T12:00\\" ", self.widget.render())\n+        self.assertIn(\' value="2022-08-17T12:00" \', self.widget.render())\n \n         self.widget.mode = "display"\n         self.assertEqual("8/17/22 12:00 PM", self.widget.render())\n@@ -452,7 +452,9 @@ def test_datetimeformatter(self):\n         self.assertEqual("August 17, 2022 12:00:00 PM +000", self.widget.render())\n \n         self.widget._formater_length = "full"\n-        self.assertEqual("Wednesday, August 17, 2022 12:00:00 PM +000", self.widget.render())\n+        self.assertEqual(\n+            "Wednesday, August 17, 2022 12:00:00 PM +000", self.widget.render()\n+        )\n \n         # unknown formater length\n         self.widget._formater_length = "foo"\n@@ -877,7 +879,6 @@ def test_widget_optgroup(self):\n \n \n class AjaxSelectWidgetTests(unittest.TestCase):\n-\n     layer = UNIT_TESTING\n     maxDiff = None\n \n@@ -1153,7 +1154,6 @@ def test_fieldwidget_sequence(self):\n \n \n class AjaxSelectWidgetIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1234,7 +1234,6 @@ def test_widget(self):\n \n \n class RelatedItemsWidgetIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1324,7 +1323,6 @@ class IRelationsType(Interface):\n \n \n class RelatedItemsWidgetTemplateIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1597,7 +1595,6 @@ def _custom_field_widget(field, request):\n \n \n class RichTextWidgetTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1803,7 +1800,6 @@ def test_use_default_editor_value(self):\n \n \n class LinkWidgetIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1956,17 +1952,14 @@ def test_link_widget__data_converter(self):\n \n \n class WidgetCustomizingIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def test_widget_base_wrapper_css(self):\n         class ITestDateSchema(Schema):\n-\n             widget("my_date", DateWidget, wrapper_css_class="foo")\n             my_date = Date(title="My Date")\n \n         class TestForm(AutoExtensibleForm, EditForm):\n-\n             ignoreContext = True\n             schema = ITestDateSchema\n \ndiff --git a/plone/app/z3cform/widget.py b/plone/app/z3cform/widget.py\nindex c1507a6..bb7d5e4 100644\n--- a/plone/app/z3cform/widget.py\n+++ b/plone/app/z3cform/widget.py\n@@ -139,6 +139,7 @@ class DateWidget(BaseWidget, z3cform_TextWidget):\n     The default_timezone and default_time arguments are only used if a datewidget is\n     used on a datetime field. If used on a date field they are ignored.\n     """\n+\n     _base_type = "date"\n     _converter = DateWidgetConverter\n     _formater = "date"\n@@ -230,7 +231,6 @@ class DatetimeWidget(DateWidget):\n \n @implementer_only(ITimeWidget)\n class TimeWidget(BaseWidget, z3cform_TextWidget):\n-\n     pattern = ""\n \n     def _base(self, **kw):\ndiff --git a/plone/app/z3cform/wysiwyg/widget.py b/plone/app/z3cform/wysiwyg/widget.py\nindex 09bc9d7..e06fa49 100644\n--- a/plone/app/z3cform/wysiwyg/widget.py\n+++ b/plone/app/z3cform/wysiwyg/widget.py\n@@ -22,7 +22,6 @@ class IWysiwygWidget(z3c.form.interfaces.ITextAreaWidget):\n \n @implementer_only(IWysiwygWidget)\n class WysiwygWidget(z3c.form.browser.textarea.TextAreaWidget):\n-\n     klass = "kupu-widget"\n     value = ""\n \ndiff --git a/setup.py b/setup.py\nindex 01cf526..419eb94 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -8,24 +8,24 @@ def read(*rnames):\n     return open(os.path.join(os.path.dirname(__file__), *rnames)).read()\n \n \n-version = \'4.0.2.dev0\'\n+version = "4.0.2.dev0"\n \n long_description = (\n-    read(\'README.rst\') +\n-    \'\\n\' +\n-    read(\'plone\', \'app\', \'z3cform\', \'wysiwyg\', \'README.rst\') +\n-    \'\\n\' +\n-    read(\'plone\', \'app\', \'z3cform\', \'inline_validation.rst\') +\n-    \'\\n\' +\n-    read(\'CHANGES.rst\') +\n-    \'\\n\'\n+    read("README.rst")\n+    + "\\n"\n+    + read("plone", "app", "z3cform", "wysiwyg", "README.rst")\n+    + "\\n"\n+    + read("plone", "app", "z3cform", "inline_validation.rst")\n+    + "\\n"\n+    + read("CHANGES.rst")\n+    + "\\n"\n )\n \n setup(\n-    name=\'plone.app.z3cform\',\n+    name="plone.app.z3cform",\n     version=version,\n     description="A collection of widgets, templates and other components "\n-                "for use with z3c.form and Plone",\n+    "for use with z3c.form and Plone",\n     long_description=long_description,\n     classifiers=[\n         "Development Status :: 5 - Production/Stable",\n@@ -42,38 +42,38 @@ def read(*rnames):\n         "Programming Language :: Python :: 3.10",\n         "Programming Language :: Python :: 3.11",\n     ],\n-    keywords=\'zope plone form widget template\',\n-    author=\'Plone Foundation\',\n-    author_email=\'plone-developers@lists.sourceforge.net\',\n-    url=\'https://pypi.org/project/plone.app.z3cform\',\n-    license=\'GPL\',\n+    keywords="zope plone form widget template",\n+    author="Plone Foundation",\n+    author_email="plone-developers@lists.sourceforge.net",\n+    url="https://pypi.org/project/plone.app.z3cform",\n+    license="GPL",\n     packages=find_packages(),\n-    namespace_packages=[\'plone\', \'plone.app\'],\n+    namespace_packages=["plone", "plone.app"],\n     include_package_data=True,\n     zip_safe=False,\n     python_requires=">=3.8",\n     install_requires=[\n-        \'plone.app.textfield>=1.3.6\',\n-        \'plone.app.widgets>=2.4.2\',\n-        \'plone.base\',\n-        \'plone.protect\',\n-        \'setuptools\',\n-        \'z3c.form >= 4.0\',\n-        \'z3c.formwidget.query\',\n-        \'zope.deprecation\',\n-        \'zope.globalrequest\',\n-        \'Zope\',\n+        "plone.app.textfield>=1.3.6",\n+        "plone.app.widgets>=2.4.2",\n+        "plone.base",\n+        "plone.protect",\n+        "setuptools",\n+        "z3c.form >= 4.0",\n+        "z3c.formwidget.query",\n+        "zope.deprecation",\n+        "zope.globalrequest",\n+        "Zope",\n     ],\n     extras_require={\n-        \'tests\': [\n-            \'mock\',\n-            \'plone.app.robotframework\',\n-            \'plone.app.testing\',\n-            \'plone.browserlayer\',\n-            \'plone.testing\',\n-            \'zope.contentprovider\',\n-            \'zope.publisher\',\n-            \'zope.testing\',\n+        "tests": [\n+            "mock",\n+            "plone.app.robotframework",\n+            "plone.app.testing",\n+            "plone.browserlayer",\n+            "plone.testing",\n+            "zope.contentprovider",\n+            "zope.publisher",\n+            "zope.testing",\n         ]\n     },\n )\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:10:44+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/39bf540978d5ca0ed4d03adeff57ce9dd6c80554

chore: zpretty ZCML

Files changed:
M plone/app/z3cform/configure.zcml
M plone/app/z3cform/overrides.zcml
M plone/app/z3cform/profiles.zcml
M plone/app/z3cform/tests/testing.zcml
M plone/app/z3cform/widget.zcml
M plone/app/z3cform/wysiwyg/configure.zcml

b'diff --git a/plone/app/z3cform/configure.zcml b/plone/app/z3cform/configure.zcml\nindex 9c6e64c..9bd4ec0 100644\n--- a/plone/app/z3cform/configure.zcml\n+++ b/plone/app/z3cform/configure.zcml\n@@ -2,9 +2,10 @@\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:browser="http://namespaces.zope.org/browser"\n     xmlns:i18n="http://namespaces.zope.org/i18n"\n-    xmlns:zcml="http://namespaces.zope.org/zcml"\n     xmlns:z3c="http://namespaces.zope.org/z3c"\n-    i18n_domain="plone">\n+    xmlns:zcml="http://namespaces.zope.org/zcml"\n+    i18n_domain="plone"\n+    >\n \n   <include package="plone.z3cform" />\n   <include package="plone.app.widgets" />\n@@ -19,25 +20,25 @@\n   <browser:page\n       name="ploneform-macros"\n       for="*"\n-      layer=".interfaces.IPloneFormLayer"\n       class=".views.Macros"\n-      template="templates/macros.pt"\n       allowed_interface="zope.interface.common.mapping.IItemMapping"\n+      template="templates/macros.pt"\n       permission="zope.Public"\n+      layer=".interfaces.IPloneFormLayer"\n       />\n   <browser:page\n       name="ploneform-render-widget"\n       for="z3c.form.interfaces.IWidget"\n-      layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n       class=".views.RenderWidget"\n       permission="zope.Public"\n+      layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n       />\n   <browser:page\n       name="ploneform-render-widget"\n       for="zope.contentprovider.interfaces.IContentProvider"\n-      layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n       class=".views.RenderContentProvider"\n       permission="zope.Public"\n+      layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n       />\n \n   <adapter factory=".views.layout_factory" />\n@@ -53,22 +54,22 @@\n   <!-- dexterity add/edit overrides -->\n   <include package="plone.dexterity" />\n   <adapter\n+      factory=".views.AddView"\n+      provides="zope.publisher.interfaces.browser.IBrowserPage"\n       for="Products.CMFCore.interfaces.IFolderish\n            plone.app.z3cform.interfaces.IPloneFormLayer\n            plone.dexterity.interfaces.IDexterityFTI"\n-      provides="zope.publisher.interfaces.browser.IBrowserPage"\n-      factory=".views.AddView"\n       />\n   <class class=".views.AddView">\n-      <require\n-          permission="cmf.AddPortalContent"\n-          interface="zope.publisher.interfaces.browser.IBrowserPage"\n-          />\n+    <require\n+        permission="cmf.AddPortalContent"\n+        interface="zope.publisher.interfaces.browser.IBrowserPage"\n+        />\n   </class>\n \n   <browser:page\n-      for="plone.dexterity.interfaces.IDexterityContent"\n       name="edit"\n+      for="plone.dexterity.interfaces.IDexterityContent"\n       class=".views.EditView"\n       permission="cmf.ModifyPortalContent"\n       layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n@@ -86,12 +87,18 @@\n   <adapter factory=".converters.AjaxSelectWidgetConverter" />\n   <adapter factory=".converters.QueryStringDataConverter" />\n   <adapter factory=".converters.RelationChoiceRelatedItemsWidgetConverter" />\n-  <adapter factory=".converters.RelationChoiceRelatedItemsWidgetConverter"\n-           for="z3c.relationfield.interfaces.IRelationChoice .interfaces.ITextWidget" />\n+  <adapter\n+      factory=".converters.RelationChoiceRelatedItemsWidgetConverter"\n+      for="z3c.relationfield.interfaces.IRelationChoice\n+           .interfaces.ITextWidget"\n+      />\n   <adapter factory=".converters.RelationChoiceSelectWidgetConverter" />\n   <adapter factory=".converters.RelatedItemsDataConverter" />\n-  <adapter factory=".converters.RelatedItemsDataConverter"\n-           for="z3c.relationfield.interfaces.IRelationList .interfaces.ITextWidget" />\n+  <adapter\n+      factory=".converters.RelatedItemsDataConverter"\n+      for="z3c.relationfield.interfaces.IRelationList\n+           .interfaces.ITextWidget"\n+      />\n   <adapter factory=".converters.RelationListSelectWidgetDataConverter" />\n   <adapter factory=".converters.LinkWidgetDataConverter" />\n \n@@ -101,20 +108,21 @@\n   <!-- error snippet -->\n   <adapter\n       factory=".views.ErrorViewTemplate"\n-      for="z3c.form.interfaces.IErrorViewSnippet .interfaces.IPloneFormLayer"\n       provides="zope.pagetemplate.interfaces.IPageTemplate"\n+      for="z3c.form.interfaces.IErrorViewSnippet\n+           .interfaces.IPloneFormLayer"\n       />\n \n   <utility\n-      name="ZPublisher.HTTPRequest.FileUpload"\n-      provides="plone.namedfile.interfaces.IStorage"\n       factory=".factories.Zope2FileUploadStorable"\n+      provides="plone.namedfile.interfaces.IStorage"\n+      name="ZPublisher.HTTPRequest.FileUpload"\n       />\n \n   <utility\n-       component=".widget.tinymce_richtextwidget_render"\n-       provides=".interfaces.IRichTextWidgetInputModeRenderer"\n-       name="tinymce"\n-       />\n+      provides=".interfaces.IRichTextWidgetInputModeRenderer"\n+      name="tinymce"\n+      component=".widget.tinymce_richtextwidget_render"\n+      />\n \n </configure>\ndiff --git a/plone/app/z3cform/overrides.zcml b/plone/app/z3cform/overrides.zcml\nindex ab5befb..198e8b0 100644\n--- a/plone/app/z3cform/overrides.zcml\n+++ b/plone/app/z3cform/overrides.zcml\n@@ -1,3 +1,6 @@\n <configure xmlns="http://namespaces.zope.org/zope">\n-  <includeOverrides package="plone.z3cform" file="overrides.zcml" />\n+  <includeOverrides\n+      package="plone.z3cform"\n+      file="overrides.zcml"\n+      />\n </configure>\ndiff --git a/plone/app/z3cform/profiles.zcml b/plone/app/z3cform/profiles.zcml\nindex b74de44..8961315 100644\n--- a/plone/app/z3cform/profiles.zcml\n+++ b/plone/app/z3cform/profiles.zcml\n@@ -1,17 +1,19 @@\n-<configure xmlns="http://namespaces.zope.org/zope"\n-           xmlns:browser="http://namespaces.zope.org/browser"\n-           xmlns:five="http://namespaces.zope.org/five"\n-           xmlns:genericsetup="http://namespaces.zope.org/genericsetup"\n-           xmlns:plone="http://namespaces.plone.org/plone"\n-           i18n_domain="plone">\n+<configure\n+    xmlns="http://namespaces.zope.org/zope"\n+    xmlns:browser="http://namespaces.zope.org/browser"\n+    xmlns:five="http://namespaces.zope.org/five"\n+    xmlns:genericsetup="http://namespaces.zope.org/genericsetup"\n+    xmlns:plone="http://namespaces.plone.org/plone"\n+    i18n_domain="plone"\n+    >\n \n   <genericsetup:registerProfile\n       name="default"\n       title="Plone z3c.form support"\n       description="Adds support for rendering z3c.form forms in Plone"\n-      directory="profiles/default"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       for="plone.base.interfaces.IPloneSiteRoot"\n+      directory="profiles/default"\n       />\n \n </configure>\ndiff --git a/plone/app/z3cform/tests/testing.zcml b/plone/app/z3cform/tests/testing.zcml\nindex 22c27be..f706b0c 100644\n--- a/plone/app/z3cform/tests/testing.zcml\n+++ b/plone/app/z3cform/tests/testing.zcml\n@@ -2,30 +2,34 @@\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:browser="http://namespaces.zope.org/browser"\n     xmlns:i18n="http://namespaces.zope.org/i18n"\n-    i18n_domain="plone">\n+    i18n_domain="plone"\n+    >\n \n-    <browser:page\n-        name="test-form"\n-        for="*"\n-        class=".example.MyFormWrapper"\n-        permission="zope.Public" />\n+  <browser:page\n+      name="test-form"\n+      for="*"\n+      class=".example.MyFormWrapper"\n+      permission="zope.Public"\n+      />\n \n-    <browser:page\n-        name="test-group-form"\n-        for="*"\n-        class=".example.MyGroupFormWrapper"\n-        permission="zope.Public" />\n+  <browser:page\n+      name="test-group-form"\n+      for="*"\n+      class=".example.MyGroupFormWrapper"\n+      permission="zope.Public"\n+      />\n \n-    <browser:page\n-        name="test-multi-form"\n-        for="*"\n-        class=".example.MyMultiFormWrapper"\n-        permission="zope.Public" />\n+  <browser:page\n+      name="test-multi-form"\n+      for="*"\n+      class=".example.MyMultiFormWrapper"\n+      permission="zope.Public"\n+      />\n \n-    <utility\n-       component=".example.dummy_richtextwidget_render"\n-       provides="..interfaces.IRichTextWidgetInputModeRenderer"\n-       name="dummy"\n-       />\n+  <utility\n+      provides="..interfaces.IRichTextWidgetInputModeRenderer"\n+      name="dummy"\n+      component=".example.dummy_richtextwidget_render"\n+      />\n \n </configure>\ndiff --git a/plone/app/z3cform/widget.zcml b/plone/app/z3cform/widget.zcml\nindex 3e61eef..ed453f0 100644\n--- a/plone/app/z3cform/widget.zcml\n+++ b/plone/app/z3cform/widget.zcml\n@@ -1,7 +1,8 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:z3c="http://namespaces.zope.org/z3c"\n-    i18n_domain="plone">\n+    i18n_domain="plone"\n+    >\n \n   <!-- Make the default widget for sequence-of-text-lines a textlines\n        widget; the default is too confusing -->\n@@ -55,81 +56,84 @@\n       for="zope.schema.interfaces.IBool\n            .interfaces.IPloneFormLayer"\n       />\n-  <adapter\n-      factory=".converters.BoolSingleCheckboxDataConverter"\n-      />\n+  <adapter factory=".converters.BoolSingleCheckboxDataConverter" />\n \n   <z3c:widgetTemplate\n-      mode="display"\n       field="zope.schema.interfaces.IBool"\n       widget=".interfaces.ISingleCheckBoxBoolWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/singlecheckboxbool_display.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="display"\n       />\n   <z3c:widgetTemplate\n-      mode="input"\n       field="zope.schema.interfaces.IBool"\n       widget=".interfaces.ISingleCheckBoxBoolWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/singlecheckboxbool_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n   <z3c:widgetTemplate\n-      mode="display"\n       field="*"\n       widget=".interfaces.IAjaxSelectWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/ajaxselect_display.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="display"\n       />\n   <z3c:widgetTemplate\n-      mode="hidden"\n       field="zope.schema.interfaces.IBool"\n       widget=".interfaces.ISingleCheckBoxBoolWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/singlecheckboxbool_hidden.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="hidden"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IMultiWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/multi_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IObjectWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/object_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget=".interfaces.ILinkWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/link_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="display"\n       widget=".interfaces.IRelatedItemsWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/relateditems_display.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="display"\n       />\n \n   <!-- widget registration stuff -->\n   <class class=".widget.DateWidget">\n-    <require permission="zope.Public"\n-             interface=".interfaces.IDateWidget" />\n+    <require\n+        permission="zope.Public"\n+        interface=".interfaces.IDateWidget"\n+        />\n   </class>\n \n   <adapter\n       factory=".widget.DateFieldWidget"\n       for="zope.schema.interfaces.IDate\n-           plone.app.z3cform.interfaces.IPloneFormLayer" />\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n   <class class=".widget.DatetimeWidget">\n-    <require permission="zope.Public"\n-             interface=".interfaces.IDatetimeWidget" />\n+    <require\n+        permission="zope.Public"\n+        interface=".interfaces.IDatetimeWidget"\n+        />\n   </class>\n \n   <adapter\n@@ -139,8 +143,10 @@\n       />\n \n   <class class=".widget.TimeWidget">\n-    <require permission="zope.Public"\n-             interface=".interfaces.ITimeWidget" />\n+    <require\n+        permission="zope.Public"\n+        interface=".interfaces.ITimeWidget"\n+        />\n   </class>\n \n   <adapter\n@@ -149,134 +155,146 @@\n            plone.app.z3cform.interfaces.IPloneFormLayer"\n       />\n \n-  <adapter factory=".widget.RelatedItemsFieldWidget"\n-           for="z3c.relationfield.interfaces.IRelationChoice\n-                plone.app.z3cform.interfaces.IPloneFormLayer" />\n+  <adapter\n+      factory=".widget.RelatedItemsFieldWidget"\n+      for="z3c.relationfield.interfaces.IRelationChoice\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.RelatedItemsFieldWidget"\n-           for="z3c.relationfield.interfaces.IRelationList\n-                plone.app.z3cform.interfaces.IPloneFormLayer" />\n+  <adapter\n+      factory=".widget.RelatedItemsFieldWidget"\n+      for="z3c.relationfield.interfaces.IRelationList\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.RelatedItemsFieldWidget"\n-           for="zope.schema.interfaces.IChoice\n-                plone.app.vocabularies.catalog.CatalogSource\n-                plone.app.z3cform.interfaces.IPloneFormLayer" />\n+  <adapter\n+      factory=".widget.RelatedItemsFieldWidget"\n+      for="zope.schema.interfaces.IChoice\n+           plone.app.vocabularies.catalog.CatalogSource\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.QueryStringFieldWidget"\n-           for="zope.schema.interfaces.IList\n-                zope.schema.interfaces.IDict\n-                plone.app.z3cform.interfaces.IPloneFormLayer"/>\n+  <adapter\n+      factory=".widget.QueryStringFieldWidget"\n+      for="zope.schema.interfaces.IList\n+           zope.schema.interfaces.IDict\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.RichTextFieldWidget"\n-           for="plone.app.textfield.interfaces.IRichText\n-                plone.app.z3cform.interfaces.IPloneFormLayer"/>\n+  <adapter\n+      factory=".widget.RichTextFieldWidget"\n+      for="plone.app.textfield.interfaces.IRichText\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.LinkFieldWidget"\n-           for="z3c.form.interfaces.ITextWidget\n-                plone.app.z3cform.interfaces.IPloneFormLayer"/>\n+  <adapter\n+      factory=".widget.LinkFieldWidget"\n+      for="z3c.form.interfaces.ITextWidget\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n   <!-- z3c.form overrides -->\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ITextWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/text_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       field="zope.schema.interfaces.IDatetime"\n       widget=".interfaces.IDatetimeWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/text_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ITextAreaWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/textarea_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ISelectWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/select_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IOrderedSelectWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/orderedselect_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IRadioWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/radio_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input_single"\n       widget="z3c.form.interfaces.IRadioWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/radio_input_single.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input_single"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ISubmitWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/submit_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ICheckBoxWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/checkbox_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IPasswordWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/password_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <!-- plone.formwidget.namedfile -->\n   <z3c:widgetTemplate\n-      mode="input"\n       widget="plone.formwidget.namedfile.interfaces.INamedFileWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/file_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="plone.formwidget.namedfile.interfaces.INamedImageWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/image_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <!-- plone.z3cform.textlines -->\n   <z3c:widgetTemplate\n-      mode="input"\n       widget="plone.z3cform.textlines.textlines.ITextLinesWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/textlines_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <!-- plone.app.textfield -->\n   <z3c:widgetTemplate\n-      mode="input"\n       widget="plone.app.textfield.widget.IRichTextWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/textfield_widget_input.pt"\n-  />\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n+      />\n \n </configure>\ndiff --git a/plone/app/z3cform/wysiwyg/configure.zcml b/plone/app/z3cform/wysiwyg/configure.zcml\nindex ed277d6..cc414bd 100644\n--- a/plone/app/z3cform/wysiwyg/configure.zcml\n+++ b/plone/app/z3cform/wysiwyg/configure.zcml\n@@ -1,7 +1,8 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:z3c="http://namespaces.zope.org/z3c"\n-    i18n_domain="plone">\n+    i18n_domain="plone"\n+    >\n \n   <class class=".widget.WysiwygWidget">\n     <require\n@@ -11,17 +12,17 @@\n   </class>\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget=".widget.IWysiwygWidget"\n-      layer="z3c.form.interfaces.IFormLayer"\n       template="wysiwyg_input.pt"\n+      layer="z3c.form.interfaces.IFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="display"\n       widget=".widget.IWysiwygWidget"\n-      layer="z3c.form.interfaces.IFormLayer"\n       template="wysiwyg_display.pt"\n+      layer="z3c.form.interfaces.IFormLayer"\n+      mode="display"\n       />\n \n \n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:11:22+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/491553af595b8192529e78db67dd2b06e6342129

chore: zpretty PT

Files changed:
M plone/app/z3cform/profiles/default/browserlayer.xml
M plone/app/z3cform/profiles/default/metadata.xml
M plone/app/z3cform/templates/ajaxselect_display.pt
M plone/app/z3cform/templates/checkbox_input.pt
M plone/app/z3cform/templates/contentprovider-widget.pt
M plone/app/z3cform/templates/error.pt
M plone/app/z3cform/templates/file_input.pt
M plone/app/z3cform/templates/form.pt
M plone/app/z3cform/templates/image_input.pt
M plone/app/z3cform/templates/layout.pt
M plone/app/z3cform/templates/link_input.pt
M plone/app/z3cform/templates/macros.pt
M plone/app/z3cform/templates/multi_input.pt
M plone/app/z3cform/templates/object_input.pt
M plone/app/z3cform/templates/orderedselect_input.pt
M plone/app/z3cform/templates/password_input.pt
M plone/app/z3cform/templates/radio_input.pt
M plone/app/z3cform/templates/radio_input_single.pt
M plone/app/z3cform/templates/relateditems_display.pt
M plone/app/z3cform/templates/select_input.pt
M plone/app/z3cform/templates/singlecheckbox.pt
M plone/app/z3cform/templates/singlecheckboxbool_display.pt
M plone/app/z3cform/templates/singlecheckboxbool_hidden.pt
M plone/app/z3cform/templates/singlecheckboxbool_input.pt
M plone/app/z3cform/templates/submit_input.pt
M plone/app/z3cform/templates/text_input.pt
M plone/app/z3cform/templates/textarea_input.pt
M plone/app/z3cform/templates/textfield_widget_input.pt
M plone/app/z3cform/templates/textlines_input.pt
M plone/app/z3cform/templates/widget.pt
M plone/app/z3cform/wysiwyg/wysiwyg_display.pt
M plone/app/z3cform/wysiwyg/wysiwyg_input.pt

b'diff --git a/plone/app/z3cform/profiles/default/browserlayer.xml b/plone/app/z3cform/profiles/default/browserlayer.xml\nindex 7047ada0..e63a3c7e 100644\n--- a/plone/app/z3cform/profiles/default/browserlayer.xml\n+++ b/plone/app/z3cform/profiles/default/browserlayer.xml\n@@ -1,3 +1,6 @@\n+<?xml version="1.0" encoding="utf-8"?>\n <layers>\n-    <layer name="plone.app.z3cform" interface="plone.app.z3cform.interfaces.IPloneFormLayer" />\n+  <layer interface="plone.app.z3cform.interfaces.IPloneFormLayer"\n+         name="plone.app.z3cform"\n+  />\n </layers>\ndiff --git a/plone/app/z3cform/profiles/default/metadata.xml b/plone/app/z3cform/profiles/default/metadata.xml\nindex a44cc349..dbfd3b42 100644\n--- a/plone/app/z3cform/profiles/default/metadata.xml\n+++ b/plone/app/z3cform/profiles/default/metadata.xml\n@@ -1,4 +1,4 @@\n-<?xml version="1.0"?>\n+<?xml version="1.0" encoding="utf-8"?>\n <metadata>\n   <version>3</version>\n </metadata>\ndiff --git a/plone/app/z3cform/templates/ajaxselect_display.pt b/plone/app/z3cform/templates/ajaxselect_display.pt\nindex c634dede..c9252807 100644\n--- a/plone/app/z3cform/templates/ajaxselect_display.pt\n+++ b/plone/app/z3cform/templates/ajaxselect_display.pt\n@@ -1,26 +1,31 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-    <span id="" class=""\n-          tal:attributes="id view/id;\n-                          class view/klass;\n-                          style view/style;\n-                          title view/title;\n-                          lang view/lang;\n-                          onclick view/onclick;\n-                          ondblclick view/ondblclick;\n-                          onmousedown view/onmousedown;\n-                          onmouseup view/onmouseup;\n-                          onmouseover view/onmouseover;\n-                          onmousemove view/onmousemove;\n-                          onmouseout view/onmouseout;\n-                          onkeypress view/onkeypress;\n-                          onkeydown view/onkeydown;\n-                          onkeyup view/onkeyup"><tal:block\n-          condition="view/value"\n-    />\n-      <tal:loop tal:repeat="item python:view.display_items()">\n-        <span data-token="${python:item[\'token\']}">${python:item[\'title\']}</span><tal:if tal:condition="python: not repeat.item.end" tal:replace="python:view.separator" />\n-      </tal:loop>\n-    </span>\n+      tal:omit-tag=""\n+>\n+  <span class=""\n+        id=""\n+        tal:attributes="\n+          id view/id;\n+          class view/klass;\n+          style view/style;\n+          title view/title;\n+          lang view/lang;\n+          onclick view/onclick;\n+          ondblclick view/ondblclick;\n+          onmousedown view/onmousedown;\n+          onmouseup view/onmouseup;\n+          onmouseover view/onmouseover;\n+          onmousemove view/onmousemove;\n+          onmouseout view/onmouseout;\n+          onkeypress view/onkeypress;\n+          onkeydown view/onkeydown;\n+          onkeyup view/onkeyup;\n+        "\n+  ><tal:block condition="view/value" />\n+    <tal:loop tal:repeat="item python:view.display_items()">\n+      <span data-token="${python:item[\'token\']}">${python:item[\'title\']}</span><tal:if tal:condition="python: not repeat.item.end"\n+              tal:replace="python:view.separator"\n+      />\n+    </tal:loop>\n+  </span>\n </html>\ndiff --git a/plone/app/z3cform/templates/checkbox_input.pt b/plone/app/z3cform/templates/checkbox_input.pt\nindex 56efa26f..81585fe2 100644\n--- a/plone/app/z3cform/templates/checkbox_input.pt\n+++ b/plone/app/z3cform/templates/checkbox_input.pt\n@@ -1,81 +1,123 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     tal:omit-tag=""\n-     tal:define="items view/items;\n-                 items python:list(items);\n-                 single_checkbox python:len(items) == 1">\n-<div tal:attributes="id view/id"\n-     tal:omit-tag="single_checkbox"\n-     tal:condition="python:len(items) > 0">\n- <div class="form-check"\n-       tal:repeat="item items"\n-       tal:attributes="id python:single_checkbox and view.id or None">\n-  <input type="checkbox" id="" name="" class="" alt="" title=""\n-         tabindex="" disabled="" readonly="" accesskey="" value=""\n-         checked="checked"\n-         tal:condition="item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect"\n-  /><input id="" name="" class="" alt="" title="" tabindex=""\n-           disabled="" readonly="" accesskey="" value=""\n-           type="checkbox"\n-         tal:condition="not:item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect" />\n-  <label class="form-check-label" for=""\n-         tal:attributes="for item/id">\n-    <span class="label" tal:content="item/label">Label</span>\n-  </label>\n- </div>\n-</div>\n-<input name="field-empty-marker" type="hidden" value="1"\n-       tal:attributes="name string:${view/name}-empty-marker" />\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      tal:define="\n+        items view/items;\n+        items python:list(items);\n+        single_checkbox python:len(items) == 1;\n+      "\n+      tal:omit-tag=""\n+>\n+  <div tal:condition="python:len(items) &gt; 0"\n+       tal:omit-tag="single_checkbox"\n+       tal:attributes="\n+         id view/id;\n+       "\n+  >\n+    <div class="form-check"\n+         tal:repeat="item items"\n+         tal:attributes="\n+           id python:single_checkbox and view.id or None;\n+         "\n+    >\n+      <input class=""\n+             id=""\n+             accesskey=""\n+             alt=""\n+             checked="checked"\n+             disabled\n+             name=""\n+             readonly\n+             tabindex=""\n+             title=""\n+             type="checkbox"\n+             value=""\n+             tal:condition="item/checked"\n+             tal:attributes="\n+               id item/id;\n+               name item/name;\n+               class string:form-check-input ${view/klass};\n+               value item/value;\n+               style view/style;\n+               title view/title;\n+               lang view/lang;\n+               onclick view/onclick;\n+               ondblclick view/ondblclick;\n+               onmousedown view/onmousedown;\n+               onmouseup view/onmouseup;\n+               onmouseover view/onmouseover;\n+               onmousemove view/onmousemove;\n+               onmouseout view/onmouseout;\n+               onkeypress view/onkeypress;\n+               onkeydown view/onkeydown;\n+               onkeyup view/onkeyup;\n+               disabled view/disabled;\n+               tabindex view/tabindex;\n+               onfocus view/onfocus;\n+               onblur view/onblur;\n+               onchange view/onchange;\n+               readonly view/readonly;\n+               alt view/alt;\n+               accesskey view/accesskey;\n+               onselect view/onselect;\n+             "\n+      /><input class=""\n+             id=""\n+             accesskey=""\n+             alt=""\n+             disabled\n+             name=""\n+             readonly\n+             tabindex=""\n+             title=""\n+             type="checkbox"\n+             value=""\n+             tal:condition="not:item/checked"\n+             tal:attributes="\n+               id item/id;\n+               name item/name;\n+               class string:form-check-input ${view/klass};\n+               value item/value;\n+               style view/style;\n+               title view/title;\n+               lang view/lang;\n+               onclick view/onclick;\n+               ondblclick view/ondblclick;\n+               onmousedown view/onmousedown;\n+               onmouseup view/onmouseup;\n+               onmouseover view/onmouseover;\n+               onmousemove view/onmousemove;\n+               onmouseout view/onmouseout;\n+               onkeypress view/onkeypress;\n+               onkeydown view/onkeydown;\n+               onkeyup view/onkeyup;\n+               disabled view/disabled;\n+               tabindex view/tabindex;\n+               onfocus view/onfocus;\n+               onblur view/onblur;\n+               onchange view/onchange;\n+               readonly view/readonly;\n+               alt view/alt;\n+               accesskey view/accesskey;\n+               onselect view/onselect;\n+             "\n+      />\n+      <label class="form-check-label"\n+             for=""\n+             tal:attributes="\n+               for item/id;\n+             "\n+      >\n+        <span class="label"\n+              tal:content="item/label"\n+        >Label</span>\n+      </label>\n+    </div>\n+  </div>\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/contentprovider-widget.pt b/plone/app/z3cform/templates/contentprovider-widget.pt\nindex c1143343..537d8d11 100644\n--- a/plone/app/z3cform/templates/contentprovider-widget.pt\n+++ b/plone/app/z3cform/templates/contentprovider-widget.pt\n@@ -1,2 +1,5 @@\n-<tal:provider define="contentprovider context"\n-              replace="structure contentprovider/render" />\n+<tal:provider define="\n+                contentprovider context;\n+              "\n+              replace="structure contentprovider/render"\n+/>\ndiff --git a/plone/app/z3cform/templates/error.pt b/plone/app/z3cform/templates/error.pt\nindex c49d8bec..6e20ea7c 100644\n--- a/plone/app/z3cform/templates/error.pt\n+++ b/plone/app/z3cform/templates/error.pt\n@@ -1,5 +1,8 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-  <div class="invalid-feedback" tal:content="view/message">Error</div>\n+      tal:omit-tag=""\n+>\n+  <div class="invalid-feedback"\n+       tal:content="view/message"\n+  >Error</div>\n </html>\ndiff --git a/plone/app/z3cform/templates/file_input.pt b/plone/app/z3cform/templates/file_input.pt\nindex f2647c4b..58c57443 100644\n--- a/plone/app/z3cform/templates/file_input.pt\n+++ b/plone/app/z3cform/templates/file_input.pt\n@@ -1,112 +1,157 @@\n-<div\n-    i18n:domain="plone"\n-    tal:attributes="id view/id;\n-                    style view/style;\n-                    title view/title;\n-                    lang view/lang;\n-                    onclick view/onclick;\n-                    ondblclick view/ondblclick;\n-                    onmousedown view/onmousedown;\n-                    onmouseup view/onmouseup;\n-                    onmouseover view/onmouseover;\n-                    onmousemove view/onmousemove;\n-                    onmouseout view/onmouseout;\n-                    onkeypress view/onkeypress;\n-                    onkeydown view/onkeydown;\n-                    onkeyup view/onkeyup;\n-                    onfocus view/onfocus;\n-                    onblur view/onblur;\n-                    onchange view/onchange;\n-                    readonly view/readonly;\n-                    accesskey view/accesskey;\n-                    onselect view/onselect;"\n-    tal:define="download_url view/download_url;\n-                exists python: view.value is not None;\n-                action view/action;\n-                allow_nochange view/allow_nochange;\n-                doc_type view/file_content_type;\n-                icon view/file_icon;\n-                filename view/filename;">\n-    <tal:if tal:define="up_id view/file_upload_id" tal:condition="up_id">\n-      <input type="hidden" name="${view/name}.file_upload_id" value="${up_id}"/>\n-      <span>\n-        <tal:i18n i18n:translate="file_already_uploaded">File already uploaded:</tal:i18n>\n+<div tal:define="\n+       download_url view/download_url;\n+       exists python: view.value is not None;\n+       action view/action;\n+       allow_nochange view/allow_nochange;\n+       doc_type view/file_content_type;\n+       icon view/file_icon;\n+       filename view/filename;\n+     "\n+     tal:attributes="\n+       id view/id;\n+       style view/style;\n+       title view/title;\n+       lang view/lang;\n+       onclick view/onclick;\n+       ondblclick view/ondblclick;\n+       onmousedown view/onmousedown;\n+       onmouseup view/onmouseup;\n+       onmouseover view/onmouseover;\n+       onmousemove view/onmousemove;\n+       onmouseout view/onmouseout;\n+       onkeypress view/onkeypress;\n+       onkeydown view/onkeydown;\n+       onkeyup view/onkeyup;\n+       onfocus view/onfocus;\n+       onblur view/onblur;\n+       onchange view/onchange;\n+       readonly view/readonly;\n+       accesskey view/accesskey;\n+       onselect view/onselect;\n+     "\n+     i18n:domain="plone"\n+>\n+  <tal:if tal:define="\n+            up_id view/file_upload_id;\n+          "\n+          tal:condition="up_id"\n+  >\n+    <input name="${view/name}.file_upload_id"\n+           type="hidden"\n+           value="${up_id}"\n+    />\n+    <span>\n+      <tal:i18n i18n:translate="file_already_uploaded">File already uploaded:</tal:i18n>\n         ${view/value/filename}\n-      </span>\n-    </tal:if>\n-    <span tal:condition="python:exists and download_url and action==\'nochange\'">\n-        <img tal:condition="icon" src="" alt=""\n-             tal:attributes="src icon;\n-                             alt doc_type;\n-                             title filename;"/>\n-        <a\n-            tal:content="filename"\n-            tal:attributes="href download_url"\n-            >Filename</a>\n-        <span class="discreet"> &mdash;<tal:doc_type condition="doc_type">\n-            <span tal:replace="doc_type"\n-                  i18n:translate="">ContentType</span>,</tal:doc_type>\n-            <span tal:define="sizekb view/file_size" tal:replace="sizekb"\n-                  i18n:translate="">100</span>\n-        </span>\n     </span>\n-    <tal:block condition="allow_nochange">\n-        <div class="form-check">\n-            <input\n-                type="radio"\n-                value="nochange"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-nochange;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n-                                checked python:\'checked\' if action == \'nochange\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-nochange" i18n:translate="file_keep">Keep existing file</label>\n-        </div>\n-        <div class="form-check" tal:condition="not:view/field/required">\n-            <input\n-                type="radio"\n-                value="remove"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-remove;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n-                                checked python:\'checked\' if action == \'remove\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-remove" i18n:translate="file_remove">Remove existing file</label>\n-        </div>\n-        <div class="form-check">\n-            <input\n-                type="radio"\n-                value="replace"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-replace;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=false;\n-                                checked python:\'checked\' if action == \'replace\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-replace" i18n:translate="file_replace">Replace with new file</label>\n-        </div>\n-    </tal:block>\n+  </tal:if>\n+  <span tal:condition="python:exists and download_url and action==\'nochange\'">\n+    <img alt=""\n+         src=""\n+         tal:condition="icon"\n+         tal:attributes="\n+           src icon;\n+           alt doc_type;\n+           title filename;\n+         "\n+    />\n+    <a tal:content="filename"\n+       tal:attributes="\n+         href download_url;\n+       "\n+    >Filename</a>\n+    <span class="discreet">\n+      &mdash;<tal:doc_type condition="doc_type">\n+        <span tal:replace="doc_type"\n+              i18n:translate=""\n+        >ContentType</span>,</tal:doc_type>\n+      <span tal:define="\n+              sizekb view/file_size;\n+            "\n+            tal:replace="sizekb"\n+            i18n:translate=""\n+      >100</span>\n+    </span>\n+  </span>\n+  <tal:block condition="allow_nochange">\n+    <div class="form-check">\n+      <input class="form-check-input"\n+             type="radio"\n+             value="nochange"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-nochange;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n+               checked python:\'checked\' if action == \'nochange\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-nochange;\n+             "\n+             i18n:translate="file_keep"\n+      >Keep existing file</label>\n+    </div>\n+    <div class="form-check"\n+         tal:condition="not:view/field/required"\n+    >\n+      <input class="form-check-input"\n+             type="radio"\n+             value="remove"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-remove;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n+               checked python:\'checked\' if action == \'remove\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-remove;\n+             "\n+             i18n:translate="file_remove"\n+      >Remove existing file</label>\n+    </div>\n+    <div class="form-check">\n+      <input class="form-check-input"\n+             type="radio"\n+             value="replace"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-replace;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=false;\n+               checked python:\'checked\' if action == \'replace\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-replace;\n+             "\n+             i18n:translate="file_replace"\n+      >Replace with new file</label>\n+    </div>\n+  </tal:block>\n \n-    <input\n-        type="file"\n-        class="form-control"\n-        tal:define="is_invalid python:view.error and \'is-invalid\' or \'\'"\n-        tal:attributes="id string:${view/id}-input;\n-                        name view/name;\n-                        required python:view.required and \'required\' or None;\n-                        size view/size;\n-                        disabled view/disabled;\n-                        maxlength view/maxlength;\n-                        class string:form-control $is_invalid"\n-        />\n+  <input class="form-control"\n+         type="file"\n+         tal:define="\n+           is_invalid python:view.error and \'is-invalid\' or \'\';\n+         "\n+         tal:attributes="\n+           id string:${view/id}-input;\n+           name view/name;\n+           required python:view.required and \'required\' or None;\n+           size view/size;\n+           disabled view/disabled;\n+           maxlength view/maxlength;\n+           class string:form-control $is_invalid;\n+         "\n+  />\n \n-    <script tal:condition="python:allow_nochange and action != \'replace\'" type="text/javascript"\n-        tal:content="string:document.getElementById(\'${view/id}-input\').disabled=true;">\n-    </script>\n+  <script type="text/javascript"\n+          tal:condition="python:allow_nochange and action != \'replace\'"\n+          tal:content="string:document.getElementById(\'${view/id}-input\').disabled=true;"\n+  >\n+  </script>\n \n </div>\ndiff --git a/plone/app/z3cform/templates/form.pt b/plone/app/z3cform/templates/form.pt\nindex e4215a13..1d9fc9d4 100644\n--- a/plone/app/z3cform/templates/form.pt\n+++ b/plone/app/z3cform/templates/form.pt\n@@ -1,21 +1,27 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+<html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n       lang="en"\n       metal:use-macro="here/main_template/macros/master"\n-      i18n:domain="plone">\n+      xml:lang="en"\n+      i18n:domain="plone"\n+>\n \n-<metal:content-title fill-slot="content-title">\n-  <h1 class="documentFirstHeading" tal:content="view/label|nothing" />\n-</metal:content-title>\n+  <metal:content-title fill-slot="content-title">\n+    <h1 class="documentFirstHeading"\n+        tal:content="view/label|nothing"\n+    ></h1>\n+  </metal:content-title>\n \n-<metal:content-title fill-slot="content-description">\n-  <div class="text-muted" tal:content="structure view/description|nothing" />\n-</metal:content-title>\n+  <metal:content-title fill-slot="content-description">\n+    <div class="text-muted"\n+         tal:content="structure view/description|nothing"\n+    ></div>\n+  </metal:content-title>\n \n-<metal:content-core fill-slot="content-core">\n-  <metal:block use-macro="context/@@ploneform-macros/titlelessform" />\n-</metal:content-core>\n+  <metal:content-core fill-slot="content-core">\n+    <metal:block use-macro="context/@@ploneform-macros/titlelessform" />\n+  </metal:content-core>\n \n </html>\ndiff --git a/plone/app/z3cform/templates/image_input.pt b/plone/app/z3cform/templates/image_input.pt\nindex c654fe89..b1ebb4f4 100644\n--- a/plone/app/z3cform/templates/image_input.pt\n+++ b/plone/app/z3cform/templates/image_input.pt\n@@ -1,114 +1,159 @@\n-<div\n-    i18n:domain="plone"\n-    tal:attributes="id view/id;\n-                    style view/style;\n-                    title view/title;\n-                    lang view/lang;\n-                    onclick view/onclick;\n-                    ondblclick view/ondblclick;\n-                    onmousedown view/onmousedown;\n-                    onmouseup view/onmouseup;\n-                    onmouseover view/onmouseover;\n-                    onmousemove view/onmousemove;\n-                    onmouseout view/onmouseout;\n-                    onkeypress view/onkeypress;\n-                    onkeydown view/onkeydown;\n-                    onkeyup view/onkeyup;\n-                    onfocus view/onfocus;\n-                    onblur view/onblur;\n-                    onchange view/onchange;\n-                    readonly view/readonly;\n-                    accesskey view/accesskey;\n-                    onselect view/onselect;"\n-    tal:define="download_url view/download_url;\n-                exists python: view.value is not None;\n-                action view/action;\n-                allow_nochange view/allow_nochange;\n-                doc_type view/file_content_type;\n-                icon view/file_icon;\n-                filename view/filename;">\n-    <tal:if tal:define="up_id view/file_upload_id" tal:condition="up_id">\n-      <input type="hidden" name="${view/name}.file_upload_id" value="${up_id}"/>\n-      <span>\n-        <tal:i18n i18n:translate="image_already_uploaded">Image already uploaded:</tal:i18n>\n+<div tal:define="\n+       download_url view/download_url;\n+       exists python: view.value is not None;\n+       action view/action;\n+       allow_nochange view/allow_nochange;\n+       doc_type view/file_content_type;\n+       icon view/file_icon;\n+       filename view/filename;\n+     "\n+     tal:attributes="\n+       id view/id;\n+       style view/style;\n+       title view/title;\n+       lang view/lang;\n+       onclick view/onclick;\n+       ondblclick view/ondblclick;\n+       onmousedown view/onmousedown;\n+       onmouseup view/onmouseup;\n+       onmouseover view/onmouseover;\n+       onmousemove view/onmousemove;\n+       onmouseout view/onmouseout;\n+       onkeypress view/onkeypress;\n+       onkeydown view/onkeydown;\n+       onkeyup view/onkeyup;\n+       onfocus view/onfocus;\n+       onblur view/onblur;\n+       onchange view/onchange;\n+       readonly view/readonly;\n+       accesskey view/accesskey;\n+       onselect view/onselect;\n+     "\n+     i18n:domain="plone"\n+>\n+  <tal:if tal:define="\n+            up_id view/file_upload_id;\n+          "\n+          tal:condition="up_id"\n+  >\n+    <input name="${view/name}.file_upload_id"\n+           type="hidden"\n+           value="${up_id}"\n+    />\n+    <span>\n+      <tal:i18n i18n:translate="image_already_uploaded">Image already uploaded:</tal:i18n>\n         ${view/value/filename}\n-      </span>\n-    </tal:if>\n-    <span tal:condition="python:exists and download_url and action==\'nochange\'">\n-      <a tal:attributes="href download_url">\n-          <img tal:replace="structure view/thumb_tag"/>\n-      </a><br />\n-        <img tal:condition="icon" src="" alt=""\n-             tal:attributes="src icon;\n-                             alt doc_type;\n-                             title filename;"/>\n-        <a\n-            tal:content="filename"\n-            tal:attributes="href download_url"\n-            >Filename</a>\n-        <span class="discreet"> &mdash;<tal:doc_type condition="doc_type">\n-            <span tal:replace="doc_type"\n-                  i18n:translate="">ContentType</span>,</tal:doc_type>\n-            <span tal:define="sizekb view/file_size" tal:replace="sizekb"\n-                  i18n:translate="">100</span>\n-        </span>\n     </span>\n-    <tal:block condition="allow_nochange">\n-        <div class="form-check">\n-            <input\n-                type="radio"\n-                value="nochange"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-nochange;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n-                                checked python:\'checked\' if action == \'nochange\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-nochange" i18n:translate="image_keep">Keep existing image</label>\n-        </div>\n-        <div class="form-check" tal:condition="not:view/field/required">\n-            <input\n-                type="radio"\n-                value="remove"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-remove;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n-                                checked python:\'checked\' if action == \'remove\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-remove" i18n:translate="image_remove">Remove existing image</label>\n-        </div>\n+  </tal:if>\n+  <span tal:condition="python:exists and download_url and action==\'nochange\'">\n+    <a tal:attributes="\n+         href download_url;\n+       ">\n+      <img tal:replace="structure view/thumb_tag" />\n+    </a><br />\n+    <img alt=""\n+         src=""\n+         tal:condition="icon"\n+         tal:attributes="\n+           src icon;\n+           alt doc_type;\n+           title filename;\n+         "\n+    />\n+    <a tal:content="filename"\n+       tal:attributes="\n+         href download_url;\n+       "\n+    >Filename</a>\n+    <span class="discreet">\n+      &mdash;<tal:doc_type condition="doc_type">\n+        <span tal:replace="doc_type"\n+              i18n:translate=""\n+        >ContentType</span>,</tal:doc_type>\n+      <span tal:define="\n+              sizekb view/file_size;\n+            "\n+            tal:replace="sizekb"\n+            i18n:translate=""\n+      >100</span>\n+    </span>\n+  </span>\n+  <tal:block condition="allow_nochange">\n+    <div class="form-check">\n+      <input class="form-check-input"\n+             type="radio"\n+             value="nochange"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-nochange;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n+               checked python:\'checked\' if action == \'nochange\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-nochange;\n+             "\n+             i18n:translate="image_keep"\n+      >Keep existing image</label>\n+    </div>\n+    <div class="form-check"\n+         tal:condition="not:view/field/required"\n+    >\n+      <input class="form-check-input"\n+             type="radio"\n+             value="remove"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-remove;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n+               checked python:\'checked\' if action == \'remove\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-remove;\n+             "\n+             i18n:translate="image_remove"\n+      >Remove existing image</label>\n+    </div>\n \n-        <div class="form-check">\n-            <input\n-                type="radio"\n-                value="replace"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-replace;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=false;\n-                                checked python:\'checked\' if action == \'replace\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-replace" i18n:translate="image_replace">Replace with new image</label>\n-        </div>\n-    </tal:block>\n+    <div class="form-check">\n+      <input class="form-check-input"\n+             type="radio"\n+             value="replace"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-replace;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=false;\n+               checked python:\'checked\' if action == \'replace\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-replace;\n+             "\n+             i18n:translate="image_replace"\n+      >Replace with new image</label>\n+    </div>\n+  </tal:block>\n \n-    <input\n-        type="file"\n-        class="form-control"\n-        tal:attributes="id string:${view/id}-input;\n-                        name view/name;\n-                        required python:view.required and \'required\' or None;\n-                        size view/size;\n-                        disabled view/disabled;\n-                        maxlength view/maxlength;"\n-        />\n+  <input class="form-control"\n+         type="file"\n+         tal:attributes="\n+           id string:${view/id}-input;\n+           name view/name;\n+           required python:view.required and \'required\' or None;\n+           size view/size;\n+           disabled view/disabled;\n+           maxlength view/maxlength;\n+         "\n+  />\n \n-    <script tal:condition="python:allow_nochange and action != \'replace\'" type="text/javascript"\n-        tal:content="string:document.getElementById(\'${view/id}-input\').disabled=true;">\n-    </script>\n+  <script type="text/javascript"\n+          tal:condition="python:allow_nochange and action != \'replace\'"\n+          tal:content="string:document.getElementById(\'${view/id}-input\').disabled=true;"\n+  >\n+  </script>\n \n </div>\ndiff --git a/plone/app/z3cform/templates/layout.pt b/plone/app/z3cform/templates/layout.pt\nindex 5211b6c5..0bfb98be 100644\n--- a/plone/app/z3cform/templates/layout.pt\n+++ b/plone/app/z3cform/templates/layout.pt\n@@ -1,18 +1,24 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+<html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n       lang="en"\n       metal:use-macro="here/main_template/macros/master"\n-      i18n:domain="plone">\n-<body>\n+      xml:lang="en"\n+      i18n:domain="plone"\n+>\n+  <body>\n \n     <metal:main fill-slot="main">\n-        <metal:main-macro define-macro="main">\n-            <h1 class="documentFirstHeading" tal:content="view/label">Title</h1>\n-            <div id="content-core" tal:content="structure view/contents" />\n-        </metal:main-macro>\n+      <metal:main-macro define-macro="main">\n+        <h1 class="documentFirstHeading"\n+            tal:content="view/label"\n+        >Title</h1>\n+        <div id="content-core"\n+             tal:content="structure view/contents"\n+        ></div>\n+      </metal:main-macro>\n     </metal:main>\n \n-</body>\n+  </body>\n </html>\ndiff --git a/plone/app/z3cform/templates/link_input.pt b/plone/app/z3cform/templates/link_input.pt\nindex 1c747a34..10672186 100644\n--- a/plone/app/z3cform/templates/link_input.pt\n+++ b/plone/app/z3cform/templates/link_input.pt\n@@ -2,51 +2,105 @@\n   <div class="linkModal">\n \n     <div class="pat-autotoc autotabs"\n-         data-pat-autotoc="section:span.linkType;levels:span.linkLabel;">\n+         data-pat-autotoc="section:span.linkType;levels:span.linkLabel;"\n+    >\n \n-      <span class="linkType internal" data-linkType="internal"\n-            tal:define="value view/value/internal | nothing"\n-            tal:attributes="class python:\'linkType internal\' + (\' active\' if value else \'\')">\n-        <span class="linkLabel d-none" i18n:translate="label_internal_url">Internal</span>\n+      <span class="linkType internal"\n+            data-linktype="internal"\n+            tal:define="\n+              value view/value/internal | nothing;\n+            "\n+            tal:attributes="\n+              class python:\'linkType internal\' + (\' active\' if value else \'\');\n+            "\n+      >\n+        <span class="linkLabel d-none"\n+              i18n:translate="label_internal_url"\n+        >Internal</span>\n         <div>\n           <div class="mb-3 main">\n             <!-- this gives the name to the "linkType" -->\n-            <input type="text" name="internal" class="pat-relateditems"\n-                    tal:attributes="data-pat-relateditems view/pattern_data;\n-                                    value value;\n-                                    name string:${view/name}.internal" />\n+            <input class="pat-relateditems"\n+                   name="internal"\n+                   type="text"\n+                   tal:attributes="\n+                     data-pat-relateditems view/pattern_data;\n+                     value value;\n+                     name string:${view/name}.internal;\n+                   "\n+            />\n           </div>\n         </div>\n       </span>\n \n-      <span class="linkType external" data-linkType="external"\n-            tal:define="value view/value/external | nothing"\n-            tal:attributes="class python:\'linkType external\' + (\' active\' if value else \'\')">\n-        <span class="linkLabel d-none" i18n:translate="label_external_url">External</span>\n+      <span class="linkType external"\n+            data-linktype="external"\n+            tal:define="\n+              value view/value/external | nothing;\n+            "\n+            tal:attributes="\n+              class python:\'linkType external\' + (\' active\' if value else \'\');\n+            "\n+      >\n+        <span class="linkLabel d-none"\n+              i18n:translate="label_external_url"\n+        >External</span>\n         <div class="mb-3 main">\n-          <label class="form-label" for="external" i18n:translate="help_external_url">External URL (can be relative within this site or absolute if it starts with http:// or https://)</label>\n-          <input class="form-control" type="text" name="external" placeholder="https://domain.com"\n-                 tal:attributes="name string:${view/name}.external;\n-                                 value value" />\n+          <label class="form-label"\n+                 for="external"\n+                 i18n:translate="help_external_url"\n+          >External URL (can be relative within this site or absolute if it starts with http:// or https://)</label>\n+          <input class="form-control"\n+                 name="external"\n+                 placeholder="https://domain.com"\n+                 type="text"\n+                 tal:attributes="\n+                   name string:${view/name}.external;\n+                   value value;\n+                 "\n+          />\n         </div>\n       </span>\n \n-      <span class="linkType email" data-linkType="email"\n-            tal:define="value view/value/email | nothing"\n-            tal:attributes="class python:\'linkType email\' + (\' active\' if value else \'\')">\n-        <span class="linkLabel d-none" i18n:translate="label_email_url">Email</span>\n+      <span class="linkType email"\n+            data-linktype="email"\n+            tal:define="\n+              value view/value/email | nothing;\n+            "\n+            tal:attributes="\n+              class python:\'linkType email\' + (\' active\' if value else \'\');\n+            "\n+      >\n+        <span class="linkLabel d-none"\n+              i18n:translate="label_email_url"\n+        >Email</span>\n         <div class="form-inline">\n           <div class="mb-3 main">\n-            <label class="form-label" i18n:translate="help_email_url">Email Address</label>\n-            <input class="form-control" type="email" name="email" placeholder="name@domain.com"\n-                   tal:attributes="name string:${view/name}.email;\n-                                   value value" />\n+            <label class="form-label"\n+                   i18n:translate="help_email_url"\n+            >Email Address</label>\n+            <input class="form-control"\n+                   name="email"\n+                   placeholder="name@domain.com"\n+                   type="email"\n+                   tal:attributes="\n+                     name string:${view/name}.email;\n+                     value value;\n+                   "\n+            />\n           </div>\n           <div class="mb-3">\n-            <label class="form-label" i18n:translate="help_email_url_subject">Email Subject (optional)</label>\n-            <input class="form-control" type="text" name="subject"\n-                   tal:attributes="name string:${view/name}.subject;\n-                                   value view/value/email_subject | nothing" />\n+            <label class="form-label"\n+                   i18n:translate="help_email_url_subject"\n+            >Email Subject (optional)</label>\n+            <input class="form-control"\n+                   name="subject"\n+                   type="text"\n+                   tal:attributes="\n+                     name string:${view/name}.subject;\n+                     value view/value/email_subject | nothing;\n+                   "\n+            />\n           </div>\n         </div>\n       </span>\ndiff --git a/plone/app/z3cform/templates/macros.pt b/plone/app/z3cform/templates/macros.pt\nindex 5af3c567..20f2077d 100644\n--- a/plone/app/z3cform/templates/macros.pt\n+++ b/plone/app/z3cform/templates/macros.pt\n@@ -1,177 +1,233 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      i18n:domain="plone">\n-\n-    <body>\n-\n-        <div class="form" metal:define-macro="form">\n-\n-            <metal:title-slot define-slot="title">\n-              <h3 tal:condition="view/label | nothing" tal:content="view/label" />\n-            </metal:title-slot>\n-\n-            <metal:define define-macro="titlelessform"\n-                          i18n:domain="plone">\n-\n-                <tal:status tal:define="status view/status;\n-                                        has_error python:view.widgets.errors or status == getattr(view, \'formErrorsMessage\', None);\n-                                        errors view/widgets/errors;\n-                                        icons nocall: context/@@iconresolver"\n-                            tal:condition="python: status">\n-                    <div tal:condition="python:not (has_error or errors)"\n-                         class="portalMessage statusmessage statusmessage-info alert alert-info"\n-                         role="alert">\n-                        <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-info\', tag_alt=\'Info\', tag_class=\'statusmessage-icon mb-1 me-2\')" i18n:attributes="alt"/>\n-                        <span class="content"\n-                              tal:replace="structure status | nothing"\n-                              i18n:translate="">\n+      i18n:domain="plone"\n+>\n+\n+  <body>\n+\n+    <div class="form"\n+         metal:define-macro="form"\n+    >\n+\n+      <metal:title-slot define-slot="title">\n+        <h3 tal:condition="view/label | nothing"\n+            tal:content="view/label"\n+        ></h3>\n+      </metal:title-slot>\n+\n+      <metal:define define-macro="titlelessform"\n+                    i18n:domain="plone"\n+      >\n+\n+        <tal:status tal:define="\n+                      status view/status;\n+                      has_error python:view.widgets.errors or status == getattr(view, \'formErrorsMessage\', None);\n+                      errors view/widgets/errors;\n+                      icons nocall: context/@@iconresolver;\n+                    "\n+                    tal:condition="python: status"\n+        >\n+          <div class="portalMessage statusmessage statusmessage-info alert alert-info"\n+               role="alert"\n+               tal:condition="python:not (has_error or errors)"\n+          >\n+            <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-info\', tag_alt=\'Info\', tag_class=\'statusmessage-icon mb-1 me-2\')"\n+                      i18n:attributes="alt"\n+            />\n+            <span class="content"\n+                  tal:replace="structure status | nothing"\n+                  i18n:translate=""\n+            >\n                               The info status message.\n-                        </span>\n-                    </div>\n-                    <div tal:condition="python:has_error or errors"\n-                         class="portalMessage statusmessage statusmessage-error alert alert-danger"\n-                         role="alert">\n-                        <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-error\', tag_alt=\'Error\', tag_class=\'statusmessage-icon mb-1 me-2\')" i18n:attributes="alt"/>\n-                        <span class="content"\n-                              tal:replace="structure status | nothing"\n-                              i18n:translate="">\n+            </span>\n+          </div>\n+          <div class="portalMessage statusmessage statusmessage-error alert alert-danger"\n+               role="alert"\n+               tal:condition="python:has_error or errors"\n+          >\n+            <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-error\', tag_alt=\'Error\', tag_class=\'statusmessage-icon mb-1 me-2\')"\n+                      i18n:attributes="alt"\n+            />\n+            <span class="content"\n+                  tal:replace="structure status | nothing"\n+                  i18n:translate=""\n+            >\n                               The error status message.\n-                        </span>\n-                        <div class="mt-2 field error" tal:condition="python:[e for e in errors if not getattr(e, \'widget\', None)]">\n-                            <ul>\n-                                <tal:loop tal:repeat="error errors">\n-                                    <li tal:condition="not:nocall:error/widget"\n-                                        tal:content="structure error/render">\n+            </span>\n+            <div class="mt-2 field error"\n+                 tal:condition="python:[e for e in errors if not getattr(e, \'widget\', None)]"\n+            >\n+              <ul>\n+                <tal:loop tal:repeat="error errors">\n+                  <li tal:condition="not:nocall:error/widget"\n+                      tal:content="structure error/render"\n+                  >\n                                         Error\n-                                    </li>\n-                                </tal:loop>\n-                            </ul>\n-                        </div>\n-                    </div>\n-                </tal:status>\n-\n-\n-                <form data-pat-autotoc="levels: legend; section: fieldset; className: autotabs"\n-                      class="rowlike enableUnloadProtection" action="." method="post"\n-                      tal:define="groups view/groups | nothing;\n-                                  form_name view/form_name | nothing;\n-                                  form_class view/css_class | string:;\n-                                  default_fieldset_label view/default_fieldset_label | form_name;\n-                                  enable_form_tabbing view/enable_form_tabbing | python:True;\n-                                  enable_unload_protection view/enable_unload_protection|python:True;\n-                                  unload_protection python:enable_unload_protection and \'pat-formunloadalert\';\n-                                  enable_autofocus view/enable_autofocus|python:True;\n-                                  autofocus python:enable_autofocus and \'pat-formautofocus\';\n-                                  validation python:\'pat-validation\' if True else \'\';\n-                                  has_groups python:bool(groups);\n-                                  form_tabbing python:(has_groups and enable_form_tabbing) and \'enableFormTabbing pat-autotoc\' or \'\';\n-                                  show_default_label python:has_groups and default_fieldset_label and len(view.widgets);\n-                                  form_view_name_raw python:view.__name__ or request.getURL().split(\'/\')[-1];\n-                                  form_view_name python:\'-\'.join([\'view\', \'name\'] + [x for x in form_view_name_raw.split(\'++\') if x]);\n-                                  "\n-                      tal:attributes="action view/action|request/getURL;\n-                                      enctype view/enctype;\n-                                      class string:rowlike $unload_protection $autofocus $validation $form_tabbing $form_class $form_view_name_raw $form_view_name;\n-                                      id view/id;\n-                                      name form_name;\n-                                      method view/method|string:post">\n-\n-                    <metal:block define-slot="formtop" />\n-\n-                    <metal:fields-slot define-slot="fields">\n-                      <input type="hidden"\n-                          name="fieldset"\n-                          tal:define="current_fieldset request/fieldset | python:None"\n-                          tal:condition="python:has_groups and enable_form_tabbing and current_fieldset is not None"\n-                          tal:attributes="value current_fieldset"\n-                          />\n-\n-                      <!-- Default fieldset -->\n-                      <metal:define\n-                          define-macro="fields"\n-                          tal:define="show_default_label show_default_label|nothing;\n-                                      has_groups has_groups|nothing">\n-\n-                          <fieldset id="fieldset-default" tal:omit-tag="not:show_default_label">\n-\n-                              <legend tal:condition="show_default_label"\n-                                      tal:attributes="id string:fieldsetlegend-default"\n-                                      tal:content="default_fieldset_label">Form name</legend>\n-\n-                              <metal:define define-macro="widget_rendering">\n-                                  <tal:widgets repeat="widget python:view.widgets.values()">\n-                                      <metal:field-slot define-slot="field">\n-                                          <metal:field define-macro="field">\n-                                              <tal:widget tal:replace="structure widget/@@ploneform-render-widget"/>\n-                                          </metal:field>\n-                                      </metal:field-slot>\n-                                  </tal:widgets>\n-                              </metal:define>\n-                          </fieldset>\n-\n-                          <!-- Secondary fieldsets -->\n-                          <tal:block tal:repeat="group groups" condition="has_groups">\n-                              <fieldset\n-                                  tal:define="normalizeString nocall:context/@@plone/normalizeString;\n-                                              fieldset_label group/label;\n-                                              fieldset_name python:getattr(group, \'__name__\', False) or getattr(group.label, \'default\', False) or fieldset_label;\n-                                              fieldset_name python:normalizeString(fieldset_name);"\n-                                  tal:attributes="id string:fieldset-${fieldset_name};\n-                                                  class string:kssattr-fieldset-${fieldset_name};\n-                                                  data-fieldset fieldset_name">\n-\n-                                      <legend \n-                                          i18n:translate=""\n-                                          tal:condition="fieldset_label"\n-                                          tal:attributes="id string:fieldsetlegend-${fieldset_name}"\n-                                          tal:content="fieldset_label">Form name</legend>\n-\n-                                      <p i18n:translate=""\n-                                         tal:define="group_description group/description|nothing"\n-                                         tal:condition="group_description"\n-                                         tal:content="structure group_description">\n+                  </li>\n+                </tal:loop>\n+              </ul>\n+            </div>\n+          </div>\n+        </tal:status>\n+\n+\n+        <form class="rowlike enableUnloadProtection"\n+              action="."\n+              method="post"\n+              data-pat-autotoc="levels: legend; section: fieldset; className: autotabs"\n+              tal:define="\n+                groups view/groups | nothing;\n+                form_name view/form_name | nothing;\n+                form_class view/css_class | string:;\n+                default_fieldset_label view/default_fieldset_label | form_name;\n+                enable_form_tabbing view/enable_form_tabbing | python:True;\n+                enable_unload_protection view/enable_unload_protection|python:True;\n+                unload_protection python:enable_unload_protection and \'pat-formunloadalert\';\n+                enable_autofocus view/enable_autofocus|python:True;\n+                autofocus python:enable_autofocus and \'pat-formautofocus\';\n+                validation python:\'pat-validation\' if True else \'\';\n+                has_groups python:bool(groups);\n+                form_tabbing python:(has_groups and enable_form_tabbing) and \'enableFormTabbing pat-autotoc\' or \'\';\n+                show_default_label python:has_groups and default_fieldset_label and len(view.widgets);\n+                form_view_name_raw python:view.__name__ or request.getURL().split(\'/\')[-1];\n+                form_view_name python:\'-\'.join([\'view\', \'name\'] + [x for x in form_view_name_raw.split(\'++\') if x]);\n+              "\n+              tal:attributes="\n+                action view/action|request/getURL;\n+                enctype view/enctype;\n+                class string:rowlike $unload_protection $autofocus $validation $form_tabbing $form_class $form_view_name_raw $form_view_name;\n+                id view/id;\n+                name form_name;\n+                method view/method|string:post;\n+              "\n+        >\n+\n+          <metal:block define-slot="formtop" />\n+\n+          <metal:fields-slot define-slot="fields">\n+            <input name="fieldset"\n+                   type="hidden"\n+                   tal:define="\n+                     current_fieldset request/fieldset | python:None;\n+                   "\n+                   tal:condition="python:has_groups and enable_form_tabbing and current_fieldset is not None"\n+                   tal:attributes="\n+                     value current_fieldset;\n+                   "\n+            />\n+\n+            <!-- Default fieldset -->\n+            <metal:define define-macro="fields"\n+                          tal:define="\n+                            show_default_label show_default_label|nothing;\n+                            has_groups has_groups|nothing;\n+                          "\n+            >\n+\n+              <fieldset id="fieldset-default"\n+                        tal:omit-tag="not:show_default_label"\n+              >\n+\n+                <legend tal:condition="show_default_label"\n+                        tal:content="default_fieldset_label"\n+                        tal:attributes="\n+                          id string:fieldsetlegend-default;\n+                        "\n+                >Form name</legend>\n+\n+                <metal:define define-macro="widget_rendering">\n+                  <tal:widgets repeat="widget python:view.widgets.values()">\n+                    <metal:field-slot define-slot="field">\n+                      <metal:field define-macro="field">\n+                        <tal:widget tal:replace="structure widget/@@ploneform-render-widget" />\n+                      </metal:field>\n+                    </metal:field-slot>\n+                  </tal:widgets>\n+                </metal:define>\n+              </fieldset>\n+\n+              <!-- Secondary fieldsets -->\n+              <tal:block condition="has_groups"\n+                         tal:repeat="group groups"\n+              >\n+                <fieldset tal:define="\n+                            normalizeString nocall:context/@@plone/normalizeString;\n+                            fieldset_label group/label;\n+                            fieldset_name python:getattr(group, \'__name__\', False) or getattr(group.label, \'default\', False) or fieldset_label;\n+                            fieldset_name python:normalizeString(fieldset_name);\n+                          "\n+                          tal:attributes="\n+                            id string:fieldset-${fieldset_name};\n+                            class string:kssattr-fieldset-${fieldset_name};\n+                            data-fieldset fieldset_name;\n+                          "\n+                >\n+\n+                  <legend tal:condition="fieldset_label"\n+                          tal:content="fieldset_label"\n+                          tal:attributes="\n+                            id string:fieldsetlegend-${fieldset_name};\n+                          "\n+                          i18n:translate=""\n+                  >Form name</legend>\n+\n+                  <p tal:define="\n+                       group_description group/description|nothing;\n+                     "\n+                     tal:condition="group_description"\n+                     tal:content="structure group_description"\n+                     i18n:translate=""\n+                  >\n                                           Description\n-                                      </p>\n-\n-                                      <tal:block tal:define="errors group/widgets/errors"\n-                                                 tal:condition="errors"\n-                                                 tal:repeat="error errors">\n-                                          <div class="field error"\n-                                              tal:condition="not:nocall:error/widget"\n-                                              tal:content="structure error/render"\n-                                              />\n-                                      </tal:block>\n-\n-                                      <tal:block define="view nocall:group">\n-                                          <metal:block use-macro="context/@@ploneform-macros/widget_rendering" />\n-                                      </tal:block>\n-\n-                              </fieldset>\n-                          </tal:block>\n-\n-                      </metal:define>\n-                    </metal:fields-slot>\n-\n-                    <metal:block define-slot="belowfields" />\n-\n-                    <metal:actions define-slot="actions">\n-                      <metal:define define-macro="actions">\n-                        <div class="formControls" tal:condition="view/actions/values|nothing">\n-                          <tal:block repeat="action view/actions/values">\n-                            <input tal:replace="structure action/render" />\n-                          </tal:block>\n-                       </div>\n-                      </metal:define>\n-                    </metal:actions>\n-\n-                    <tal:block tal:condition="view/enableCSRFProtection|nothing"\n-                      tal:replace="structure context/@@authenticator/authenticator" />\n-                    <metal:block define-slot="formbottom" />\n-\n-                </form>\n+                  </p>\n+\n+                  <tal:block tal:define="\n+                               errors group/widgets/errors;\n+                             "\n+                             tal:condition="errors"\n+                             tal:repeat="error errors"\n+                  >\n+                    <div class="field error"\n+                         tal:condition="not:nocall:error/widget"\n+                         tal:content="structure error/render"\n+                    ></div>\n+                  </tal:block>\n+\n+                  <tal:block define="\n+                               view nocall:group;\n+                             ">\n+                    <metal:block use-macro="context/@@ploneform-macros/widget_rendering" />\n+                  </tal:block>\n+\n+                </fieldset>\n+              </tal:block>\n+\n             </metal:define>\n-        </div>\n-    </body>\n+          </metal:fields-slot>\n+\n+          <metal:block define-slot="belowfields" />\n+\n+          <metal:actions define-slot="actions">\n+            <metal:define define-macro="actions">\n+              <div class="formControls"\n+                   tal:condition="view/actions/values|nothing"\n+              >\n+                <tal:block repeat="action view/actions/values">\n+                  <input tal:replace="structure action/render" />\n+                </tal:block>\n+              </div>\n+            </metal:define>\n+          </metal:actions>\n+\n+          <tal:block tal:condition="view/enableCSRFProtection|nothing"\n+                     tal:replace="structure context/@@authenticator/authenticator"\n+          />\n+          <metal:block define-slot="formbottom" />\n+\n+        </form>\n+      </metal:define>\n+    </div>\n+  </body>\n </html>\ndiff --git a/plone/app/z3cform/templates/multi_input.pt b/plone/app/z3cform/templates/multi_input.pt\nindex 19dd2d30..95c833f4 100644\n--- a/plone/app/z3cform/templates/multi_input.pt\n+++ b/plone/app/z3cform/templates/multi_input.pt\n@@ -1,83 +1,128 @@\n-<div i18n:domain="plone" class="multi-widget" tal:attributes="class view/klass">\n-    <tal:block repeat="widget view/widgets">\n-        <div metal:define-macro="widget-row"\n-             tal:define="hidden python:widget.mode == \'hidden\';\n-                         showLabel view/showLabel;\n-                         checkbox_disabled python:not view.allowRemoving and \'disabled\' or nothing;\n-                         index repeat/widget/index;\n-                         key_widget python:view.key_widgets[index];\n-                         error widget/error;\n-                         key_error key_widget/error|nothing;\n-                         error_class python:(error or key_error) and \' error\' or \'\';\n-                         fieldname_class string:kssattr-fieldname-${widget/name};"\n-             tal:attributes="class string:multi-widget-field field ${fieldname_class}${error_class};\n-                             id string:formfield-${widget/id};">\n+<div class="multi-widget"\n+     tal:attributes="\n+       class view/klass;\n+     "\n+     i18n:domain="plone"\n+>\n+  <tal:block repeat="widget view/widgets">\n+    <div metal:define-macro="widget-row"\n+         tal:define="\n+           hidden python:widget.mode == \'hidden\';\n+           showLabel view/showLabel;\n+           checkbox_disabled python:not view.allowRemoving and \'disabled\' or nothing;\n+           index repeat/widget/index;\n+           key_widget python:view.key_widgets[index];\n+           error widget/error;\n+           key_error key_widget/error|nothing;\n+           error_class python:(error or key_error) and \' error\' or \'\';\n+           fieldname_class string:kssattr-fieldname-${widget/name};\n+         "\n+         tal:attributes="\n+           class string:multi-widget-field field ${fieldname_class}${error_class};\n+           id string:formfield-${widget/id};\n+         "\n+    >\n \n-            <input id="" name=""\n-                   class="multi-widget-checkbox checkbox-widget"\n-                   type="checkbox" value="1"\n-                   tal:attributes="id string:${widget/id}-remove;\n-                                   name string:${widget/name}.remove;\n-                                   disabled checkbox_disabled;"/>\n-            <label for="" class="form-label horizontal"\n-                tal:attributes="for key_widget/id"\n-                tal:condition="python:key_widget is not None and showLabel and not hidden"\n-                ><span i18n:translate="" tal:replace="key_widget/label">label</span>\n-                <span class="multi-widget-number" tal:content="repeat/widget/number">1</span>\n-                <span class="required horizontal" title="Required"\n-                      tal:condition="python:key_widget.required and not hidden"\n-                      i18n:attributes="title title_required;">&nbsp;</span>\n-                <span class="formHelp"\n-                    tal:define="description key_widget/field/description"\n-                    i18n:translate=""\n-                    tal:content="description"\n-                    tal:condition="python:description and showLabel and not hidden"\n-                    >field description\n-                </span>\n-            </label>\n+      <input class="multi-widget-checkbox checkbox-widget"\n+             id=""\n+             name=""\n+             type="checkbox"\n+             value="1"\n+             tal:attributes="\n+               id string:${widget/id}-remove;\n+               name string:${widget/name}.remove;\n+               disabled checkbox_disabled;\n+             "\n+      />\n+      <label class="form-label horizontal"\n+             for=""\n+             tal:condition="python:key_widget is not None and showLabel and not hidden"\n+             tal:attributes="\n+               for key_widget/id;\n+             "\n+      ><span tal:replace="key_widget/label"\n+              i18n:translate=""\n+        >label</span>\n+        <span class="multi-widget-number"\n+              tal:content="repeat/widget/number"\n+        >1</span>\n+        <span class="required horizontal"\n+              title="Required"\n+              tal:condition="python:key_widget.required and not hidden"\n+              i18n:attributes="title title_required;"\n+        >&nbsp;</span>\n+        <span class="formHelp"\n+              tal:define="\n+                description key_widget/field/description;\n+              "\n+              tal:condition="python:description and showLabel and not hidden"\n+              tal:content="description"\n+              i18n:translate=""\n+        >field description\n+        </span>\n+      </label>\n \n-            <div class="fieldErrorBox"\n-                tal:content="structure key_error/render|nothing">\n+      <div class="fieldErrorBox"\n+           tal:content="structure key_error/render|nothing"\n+      >\n                 Error\n-            </div>\n+      </div>\n \n-            <input\n-                tal:condition="python:key_widget is not None"\n-                tal:replace="structure key_widget/render"\n-            />\n+      <input tal:condition="python:key_widget is not None"\n+             tal:replace="structure key_widget/render"\n+      />\n \n-            <br/>\n+      <br />\n \n-            <label for="" class="form-label horizontal"\n-                tal:attributes="for widget/id"\n-                tal:condition="python:showLabel and not hidden">\n-                <span i18n:translate="" tal:replace="widget/label">label</span>\n-                <span class="multi-widget-number" tal:content="repeat/widget/number">1</span>\n-                <span class="required horizontal" title="Required"\n-                      tal:condition="python:widget.required and not hidden"\n-                      i18n:attributes="title title_required;">&nbsp;</span>\n-                <span class="formHelp"\n-                    tal:define="description widget/field/description"\n-                    i18n:translate=""\n-                    tal:content="description"\n-                    tal:condition="python:description and showLabel and not hidden"\n-                    >field description\n-                </span>\n-            </label>\n+      <label class="form-label horizontal"\n+             for=""\n+             tal:condition="python:showLabel and not hidden"\n+             tal:attributes="\n+               for widget/id;\n+             "\n+      >\n+        <span tal:replace="widget/label"\n+              i18n:translate=""\n+        >label</span>\n+        <span class="multi-widget-number"\n+              tal:content="repeat/widget/number"\n+        >1</span>\n+        <span class="required horizontal"\n+              title="Required"\n+              tal:condition="python:widget.required and not hidden"\n+              i18n:attributes="title title_required;"\n+        >&nbsp;</span>\n+        <span class="formHelp"\n+              tal:define="\n+                description widget/field/description;\n+              "\n+              tal:condition="python:description and showLabel and not hidden"\n+              tal:content="description"\n+              i18n:translate=""\n+        >field description\n+        </span>\n+      </label>\n \n-            <div class="fieldErrorBox"\n-                tal:content="structure error/render|nothing">\n+      <div class="fieldErrorBox"\n+           tal:content="structure error/render|nothing"\n+      >\n                 Error\n-            </div>\n+      </div>\n \n-            <input tal:replace="structure widget/render" />\n+      <input tal:replace="structure widget/render" />\n \n-        </div>\n-    </tal:block>\n-    <div class="formControls multi-widget-buttons" tal:condition="view/actions/values|nothing">\n-        <tal:block repeat="action view/actions/values">\n-            <input type="submit" tal:replace="structure action/render" />\n-        </tal:block>\n     </div>\n-    <input type="hidden" tal:replace="structure view/counterMarker" />\n+  </tal:block>\n+  <div class="formControls multi-widget-buttons"\n+       tal:condition="view/actions/values|nothing"\n+  >\n+    <tal:block repeat="action view/actions/values">\n+      <input type="submit"\n+             tal:replace="structure action/render"\n+      />\n+    </tal:block>\n+  </div>\n+  <input type="hidden"\n+         tal:replace="structure view/counterMarker"\n+  />\n </div>\ndiff --git a/plone/app/z3cform/templates/object_input.pt b/plone/app/z3cform/templates/object_input.pt\nindex 3138bf9d..dae93600 100644\n--- a/plone/app/z3cform/templates/object_input.pt\n+++ b/plone/app/z3cform/templates/object_input.pt\n@@ -1,39 +1,67 @@\n-<div i18n:domain="plone" class="object-widget" tal:attributes="class view/klass">\n-    <tal:block repeat="widget python:view.widgets.values()">\n-        <div tal:define="hidden python:widget.mode == \'hidden\';\n-                         error widget/error;\n-                         error_class python:error and \' error\' or \'\';\n-                         fieldname_class string:kssattr-fieldname-${widget/name};"\n-             tal:attributes="class string:object-widget-field field ${fieldname_class}${error_class};\n-             data-fieldname widget/name;\n-                             id string:formfield-${widget/id};">\n+<div class="object-widget"\n+     tal:attributes="\n+       class view/klass;\n+     "\n+     i18n:domain="plone"\n+>\n+  <tal:block repeat="widget python:view.widgets.values()">\n+    <div tal:define="\n+           hidden python:widget.mode == \'hidden\';\n+           error widget/error;\n+           error_class python:error and \' error\' or \'\';\n+           fieldname_class string:kssattr-fieldname-${widget/name};\n+         "\n+         tal:attributes="\n+           class string:object-widget-field field ${fieldname_class}${error_class};\n+           data-fieldname widget/name;\n+           id string:formfield-${widget/id};\n+         "\n+    >\n \n-            <label class="form-label horizontal" for=""\n-                tal:attributes="for widget/id"\n-                tal:condition="not:hidden">\n-                <span i18n:translate="" tal:replace="widget/label">label</span>\n+      <label class="form-label horizontal"\n+             for=""\n+             tal:condition="not:hidden"\n+             tal:attributes="\n+               for widget/id;\n+             "\n+      >\n+        <span tal:replace="widget/label"\n+              i18n:translate=""\n+        >label</span>\n \n-              <span class="required horizontal" title="Required"\n-                    tal:condition="python:widget.required and not hidden"\n-                    i18n:attributes="title title_required;">&nbsp;</span>\n+        <span class="required horizontal"\n+              title="Required"\n+              tal:condition="python:widget.required and not hidden"\n+              i18n:attributes="title title_required;"\n+        >&nbsp;</span>\n \n-              <span class="formHelp"\n-                  tal:define="description widget/field/description"\n-                  i18n:translate=""\n-                  tal:content="description"\n-                  tal:condition="python:description and not hidden"\n-                  >field description\n-              </span>\n-            </label>\n+        <span class="formHelp"\n+              tal:define="\n+                description widget/field/description;\n+              "\n+              tal:condition="python:description and not hidden"\n+              tal:content="description"\n+              i18n:translate=""\n+        >field description\n+        </span>\n+      </label>\n \n-            <div class="fieldErrorBox"\n-                tal:content="structure error/render|nothing">\n+      <div class="fieldErrorBox"\n+           tal:content="structure error/render|nothing"\n+      >\n                 Error\n-            </div>\n+      </div>\n \n-            <input type="text" tal:replace="structure widget/render" />\n-        </div>\n-    </tal:block>\n-    <input name="field-empty-marker" type="hidden" value="1"\n-           tal:attributes="name string:${view/name}-empty-marker" />\n+      <input type="text"\n+             tal:replace="structure widget/render"\n+      />\n+    </div>\n+  </tal:block>\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </div>\ndiff --git a/plone/app/z3cform/templates/orderedselect_input.pt b/plone/app/z3cform/templates/orderedselect_input.pt\nindex 7638c935..99a11195 100644\n--- a/plone/app/z3cform/templates/orderedselect_input.pt\n+++ b/plone/app/z3cform/templates/orderedselect_input.pt\n@@ -1,107 +1,164 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      tal:omit-tag="">\n-<script type="text/javascript" src="++resource++orderedselect_input.js"></script>\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      tal:omit-tag=""\n+>\n+  <script src="++resource++orderedselect_input.js"\n+          type="text/javascript"\n+  ></script>\n \n-<table border="0" class="ordered-selection-field"\n-       tal:attributes="id view/id">\n-  <tr>\n-    <td>\n-      <select id="from" name="from" class=""  multiple="" size="5"\n-          tal:attributes="id string:${view/id}-from;\n-                          name string:${view/name}.from;\n-                          class string:form-control ${view/klass};\n-                          style view/style;\n-                          title view/title;\n-                          lang view/lang;\n-                          onclick view/onclick;\n-                          ondblclick view/ondblclick;\n-                          onmousedown view/onmousedown;\n-                          onmouseup view/onmouseup;\n-                          onmouseover view/onmouseover;\n-                          onmousemove view/onmousemove;\n-                          onmouseout view/onmouseout;\n-                          onkeypress view/onkeypress;\n-                          onkeydown view/onkeydown;\n-                          onkeyup view/onkeyup;\n-                          disabled view/disabled;\n-                          tabindex view/tabindex;\n-                          onfocus view/onfocus;\n-                          onblur view/onblur;\n-                          onchange view/onchange;\n-                          multiple view/multiple;\n-                          size view/size">\n-        <option tal:repeat="entry view/notselectedItems"\n-                tal:attributes="value entry/value"\n-                tal:content="nocall:entry/content" i18n:translate=""/>\n-      </select>\n-    </td>\n-    <td>\n-      <button onclick="javascript:from2to()" class="btn btn-sm btn-outline-secondary"\n-              name="from2toButton" type="button" value="&rarr;"\n-              tal:attributes="onClick string:javascript:from2to(\'${view/id}\')"\n-          >&rarr;</button>\n-      <br />\n-      <button onclick="javascript:to2from()" class="btn btn-sm btn-outline-secondary"\n-              name="to2fromButton" type="button" value="&larr;"\n-              tal:attributes="onClick string:javascript:to2from(\'${view/id}\')"\n-          >&larr;</button>\n-    </td>\n-    <td>\n-      <select id="to" name="to" class="" multiple="" size="5"\n-          tal:attributes="id string:${view/id}-to;\n-                          name string:${view/name}.to;\n-                          class string:form-control ${view/klass};\n-                          style view/style;\n-                          title view/title;\n-                          lang view/lang;\n-                          onclick view/onclick;\n-                          ondblclick view/ondblclick;\n-                          onmousedown view/onmousedown;\n-                          onmouseup view/onmouseup;\n-                          onmouseover view/onmouseover;\n-                          onmousemove view/onmousemove;\n-                          onmouseout view/onmouseout;\n-                          onkeypress view/onkeypress;\n-                          onkeydown view/onkeydown;\n-                          onkeyup view/onkeyup;\n-                          disabled view/disabled;\n-                          tabindex view/tabindex;\n-                          onfocus view/onfocus;\n-                          onblur view/onblur;\n-                          onchange view/onchange;\n-                          multiple view/multiple;\n-                          size view/size">\n-        <option tal:repeat="entry view/selectedItems"\n-                tal:attributes="value entry/value"\n-                tal:content="nocall:entry/content" i18n:translate=""/>\n-      </select>\n-      <input name="foo-empty-marker" type="hidden"\n-        tal:attributes="name string:${view/name}-empty-marker"/>\n-      <span id="toDataContainer" style="display: none"\n-            tal:attributes="id string:${view/id}-toDataContainer">\n-        <script type="text/javascript" tal:content="string:copyDataForSubmit(\'${view/id}\');">\n+  <table class="ordered-selection-field"\n+         border="0"\n+         tal:attributes="\n+           id view/id;\n+         "\n+  >\n+    <tr>\n+      <td>\n+        <select class=""\n+                id="from"\n+                multiple\n+                name="from"\n+                size="5"\n+                tal:attributes="\n+                  id string:${view/id}-from;\n+                  name string:${view/name}.from;\n+                  class string:form-control ${view/klass};\n+                  style view/style;\n+                  title view/title;\n+                  lang view/lang;\n+                  onclick view/onclick;\n+                  ondblclick view/ondblclick;\n+                  onmousedown view/onmousedown;\n+                  onmouseup view/onmouseup;\n+                  onmouseover view/onmouseover;\n+                  onmousemove view/onmousemove;\n+                  onmouseout view/onmouseout;\n+                  onkeypress view/onkeypress;\n+                  onkeydown view/onkeydown;\n+                  onkeyup view/onkeyup;\n+                  disabled view/disabled;\n+                  tabindex view/tabindex;\n+                  onfocus view/onfocus;\n+                  onblur view/onblur;\n+                  onchange view/onchange;\n+                  multiple view/multiple;\n+                  size view/size;\n+                "\n+        >\n+          <option tal:repeat="entry view/notselectedItems"\n+                  tal:content="nocall:entry/content"\n+                  tal:attributes="\n+                    value entry/value;\n+                  "\n+                  i18n:translate=""\n+          ></option>\n+        </select>\n+      </td>\n+      <td>\n+        <button class="btn btn-sm btn-outline-secondary"\n+                name="from2toButton"\n+                onclick="javascript:from2to()"\n+                type="button"\n+                value="&rarr;"\n+                tal:attributes="\n+                  onClick string:javascript:from2to(\'${view/id}\');\n+                "\n+        >&rarr;</button>\n+        <br />\n+        <button class="btn btn-sm btn-outline-secondary"\n+                name="to2fromButton"\n+                onclick="javascript:to2from()"\n+                type="button"\n+                value="&larr;"\n+                tal:attributes="\n+                  onClick string:javascript:to2from(\'${view/id}\');\n+                "\n+        >&larr;</button>\n+      </td>\n+      <td>\n+        <select class=""\n+                id="to"\n+                multiple\n+                name="to"\n+                size="5"\n+                tal:attributes="\n+                  id string:${view/id}-to;\n+                  name string:${view/name}.to;\n+                  class string:form-control ${view/klass};\n+                  style view/style;\n+                  title view/title;\n+                  lang view/lang;\n+                  onclick view/onclick;\n+                  ondblclick view/ondblclick;\n+                  onmousedown view/onmousedown;\n+                  onmouseup view/onmouseup;\n+                  onmouseover view/onmouseover;\n+                  onmousemove view/onmousemove;\n+                  onmouseout view/onmouseout;\n+                  onkeypress view/onkeypress;\n+                  onkeydown view/onkeydown;\n+                  onkeyup view/onkeyup;\n+                  disabled view/disabled;\n+                  tabindex view/tabindex;\n+                  onfocus view/onfocus;\n+                  onblur view/onblur;\n+                  onchange view/onchange;\n+                  multiple view/multiple;\n+                  size view/size;\n+                "\n+        >\n+          <option tal:repeat="entry view/selectedItems"\n+                  tal:content="nocall:entry/content"\n+                  tal:attributes="\n+                    value entry/value;\n+                  "\n+                  i18n:translate=""\n+          ></option>\n+        </select>\n+        <input name="foo-empty-marker"\n+               type="hidden"\n+               tal:attributes="\n+                 name string:${view/name}-empty-marker;\n+               "\n+        />\n+        <span id="toDataContainer"\n+              style="display: none"\n+              tal:attributes="\n+                id string:${view/id}-toDataContainer;\n+              "\n+        >\n+          <script type="text/javascript"\n+                  tal:content="string:copyDataForSubmit(\'${view/id}\');"\n+          >\n           /*  <![CDATA[ */\n           // initial copying of field "field.to" --> "field"\n           copyDataForSubmit("<i tal:replace="${view/id}"/>");\n           /* ]]> */\n-        </script>\n-      </span>\n-    </td>\n-    <td>\n-      <button\n-          onclick="javascript:moveUp()" class="btn btn-sm btn-outline-secondary"\n-          name="upButton" type="button" value="&uarr;"\n-          tal:attributes="onClick string:javascript:moveUp(\'${view/id}\')"\n-          >&uarr;</button>\n-      <br />\n-      <button\n-          onclick="javascript:moveDown()" class="btn btn-sm btn-outline-secondary"\n-          name="downButton" type="button" value="&darr;"\n-          tal:attributes="onClick string:javascript:moveDown(\'${view/id}\')"\n-          >&darr;</button>\n-    </td>\n-  </tr>\n-</table>\n+          </script>\n+        </span>\n+      </td>\n+      <td>\n+        <button class="btn btn-sm btn-outline-secondary"\n+                name="upButton"\n+                onclick="javascript:moveUp()"\n+                type="button"\n+                value="&uarr;"\n+                tal:attributes="\n+                  onClick string:javascript:moveUp(\'${view/id}\');\n+                "\n+        >&uarr;</button>\n+        <br />\n+        <button class="btn btn-sm btn-outline-secondary"\n+                name="downButton"\n+                onclick="javascript:moveDown()"\n+                type="button"\n+                value="&darr;"\n+                tal:attributes="\n+                  onClick string:javascript:moveDown(\'${view/id}\');\n+                "\n+        >&darr;</button>\n+      </td>\n+    </tr>\n+  </table>\n </html>\ndiff --git a/plone/app/z3cform/templates/password_input.pt b/plone/app/z3cform/templates/password_input.pt\nindex cc59c668..fe4a6d51 100644\n--- a/plone/app/z3cform/templates/password_input.pt\n+++ b/plone/app/z3cform/templates/password_input.pt\n@@ -1,36 +1,50 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<input id="" name="" class="" title="" lang="" disabled=""\n-       readonly="" alt="" tabindex="" accesskey="" size="" maxlength=""\n-       type="password"\n-       tal:attributes="id view/id;\n-                       name view/name;\n-                       class python:\'form-control {0}{1}\'.format(view.klass, view.error and \' is-invalid\' or \'\');\n-                       style view/style;\n-                       title view/title;\n-                       lang view/lang;\n-                       onclick view/onclick;\n-                       ondblclick view/ondblclick;\n-                       onmousedown view/onmousedown;\n-                       onmouseup view/onmouseup;\n-                       onmouseover view/onmouseover;\n-                       onmousemove view/onmousemove;\n-                       onmouseout view/onmouseout;\n-                       onkeypress view/onkeypress;\n-                       onkeydown view/onkeydown;\n-                       onkeyup view/onkeyup;\n-                       disabled view/disabled;\n-                       tabindex view/tabindex;\n-                       onfocus view/onfocus;\n-                       onblur view/onblur;\n-                       onchange view/onchange;\n-                       readonly view/readonly;\n-                       alt view/alt;\n-                       accesskey view/accesskey;\n-                       onselect view/onselect;\n-                       size view/size;\n-                       maxlength view/maxlength;\n-                       placeholder view/placeholder;\n-                       autocapitalize view/autocapitalize;" />\n+      tal:omit-tag=""\n+>\n+  <input class=""\n+         id=""\n+         accesskey=""\n+         alt=""\n+         disabled\n+         lang=""\n+         maxlength=""\n+         name=""\n+         readonly\n+         size=""\n+         tabindex=""\n+         title=""\n+         type="password"\n+         tal:attributes="\n+           id view/id;\n+           name view/name;\n+           class python:\'form-control {0}{1}\'.format(view.klass, view.error and \' is-invalid\' or \'\');\n+           style view/style;\n+           title view/title;\n+           lang view/lang;\n+           onclick view/onclick;\n+           ondblclick view/ondblclick;\n+           onmousedown view/onmousedown;\n+           onmouseup view/onmouseup;\n+           onmouseover view/onmouseover;\n+           onmousemove view/onmousemove;\n+           onmouseout view/onmouseout;\n+           onkeypress view/onkeypress;\n+           onkeydown view/onkeydown;\n+           onkeyup view/onkeyup;\n+           disabled view/disabled;\n+           tabindex view/tabindex;\n+           onfocus view/onfocus;\n+           onblur view/onblur;\n+           onchange view/onchange;\n+           readonly view/readonly;\n+           alt view/alt;\n+           accesskey view/accesskey;\n+           onselect view/onselect;\n+           size view/size;\n+           maxlength view/maxlength;\n+           placeholder view/placeholder;\n+           autocapitalize view/autocapitalize;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/radio_input.pt b/plone/app/z3cform/templates/radio_input.pt\nindex d32945a2..a2582f7a 100644\n--- a/plone/app/z3cform/templates/radio_input.pt\n+++ b/plone/app/z3cform/templates/radio_input.pt\n@@ -1,10 +1,25 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<div class="form-check" tal:repeat="item view/items">\n-    <input class="form-check-input" tal:replace="structure python:view.renderForValue(item[\'value\'])" />\n-    <label class="form-check-label" tal:attributes="for item/id" tal:content="item/label">Label</label>\n-</div>\n-<input name="field-empty-marker" type="hidden" value="1"\n-       tal:attributes="name string:${view/name}-empty-marker" />\n+      tal:omit-tag=""\n+>\n+  <div class="form-check"\n+       tal:repeat="item view/items"\n+  >\n+    <input class="form-check-input"\n+           tal:replace="structure python:view.renderForValue(item[\'value\'])"\n+    />\n+    <label class="form-check-label"\n+           tal:content="item/label"\n+           tal:attributes="\n+             for item/id;\n+           "\n+    >Label</label>\n+  </div>\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/radio_input_single.pt b/plone/app/z3cform/templates/radio_input_single.pt\nindex e0b5f898..bb62141d 100644\n--- a/plone/app/z3cform/templates/radio_input_single.pt\n+++ b/plone/app/z3cform/templates/radio_input_single.pt\n@@ -1,37 +1,53 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:define="item python:args[0]"\n-      tal:omit-tag="">\n-  <input id="" name="" class="" alt="" title=""\n-         tabindex="" disabled="" readonly="" accesskey="" value=""\n-         checked="" type="radio"\n-         tal:define="checked item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect;\n-                         checked python: checked and \'checked\' or None"\n-         />\n+      tal:define="\n+        item python:args[0];\n+      "\n+      tal:omit-tag=""\n+>\n+  <input class=""\n+         id=""\n+         accesskey=""\n+         alt=""\n+         checked\n+         disabled\n+         name=""\n+         readonly\n+         tabindex=""\n+         title=""\n+         type="radio"\n+         value=""\n+         tal:define="\n+           checked item/checked;\n+         "\n+         tal:attributes="\n+           id item/id;\n+           name item/name;\n+           class string:form-check-input ${view/klass};\n+           value item/value;\n+           style view/style;\n+           title view/title;\n+           lang view/lang;\n+           onclick view/onclick;\n+           ondblclick view/ondblclick;\n+           onmousedown view/onmousedown;\n+           onmouseup view/onmouseup;\n+           onmouseover view/onmouseover;\n+           onmousemove view/onmousemove;\n+           onmouseout view/onmouseout;\n+           onkeypress view/onkeypress;\n+           onkeydown view/onkeydown;\n+           onkeyup view/onkeyup;\n+           disabled view/disabled;\n+           tabindex view/tabindex;\n+           onfocus view/onfocus;\n+           onblur view/onblur;\n+           onchange view/onchange;\n+           readonly view/readonly;\n+           alt view/alt;\n+           accesskey view/accesskey;\n+           onselect view/onselect;\n+           checked python: checked and \'checked\' or None;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/relateditems_display.pt b/plone/app/z3cform/templates/relateditems_display.pt\nindex 23ee643f..930dc572 100644\n--- a/plone/app/z3cform/templates/relateditems_display.pt\n+++ b/plone/app/z3cform/templates/relateditems_display.pt\n@@ -1,41 +1,58 @@\n-<span id="form-widgets-fieldname"\n-      class="relateditems-widget textline-field"\n-      i18n:domain="plone"\n-      tal:define="plone_view nocall:context/@@plone;\n-                  normalizeString python:plone_view.normalizeString;\n-                  items python: view.items();\n-                  "\n+<span class="relateditems-widget textline-field"\n+      id="form-widgets-fieldname"\n+      tal:define="\n+        plone_view nocall:context/@@plone;\n+        normalizeString python:plone_view.normalizeString;\n+        items python: view.items();\n+      "\n       tal:condition="items"\n-      tal:attributes="id python:\'form-widgets-{}\'.format(view.__name__);\n-                      class python: \'relateditems-widget {}-field\'.format(normalizeString(view.field.__class__.__name__));\n-                      ">\n-    <div>\n-        <ul>\n-          <li tal:repeat="item items">\n-            <span tal:define="item_type           python:item.portal_type;\n-                              item_type_class     python:item.ContentTypeClass();\n-                              item_wf_state_class python:item.ReviewStateClass();\n-                              appendViewAction    python:item.appendViewAction();\n-                              item_url            python:item.getURL();\n-                              item_url            python:item_url+\'/view\' if appendViewAction else item_url;"\n-                  tal:attributes="title item_type">\n+      tal:attributes="\n+        id python:\'form-widgets-{}\'.format(view.__name__);\n+        class python: \'relateditems-widget {}-field\'.format(normalizeString(view.field.__class__.__name__));\n+      "\n+      i18n:domain="plone"\n+>\n+  <div>\n+    <ul>\n+      <li tal:repeat="item items">\n+        <span tal:define="\n+                item_type           python:item.portal_type;\n+                item_type_class     python:item.ContentTypeClass();\n+                item_wf_state_class python:item.ReviewStateClass();\n+                appendViewAction    python:item.appendViewAction();\n+                item_url            python:item.getURL();\n+                item_url            python:item_url+\'/view\' if appendViewAction else item_url;\n+              "\n+              tal:attributes="\n+                title item_type;\n+              "\n+        >\n \n-              <a tal:attributes="href item_url">\n-                <img class="mime-icon"\n-                     tal:condition="python:item_type ==\'File\'"\n-                     tal:attributes="src python:item.MimeTypeIcon();">\n+          <a tal:attributes="\n+               href item_url;\n+             ">\n+            <img class="mime-icon"\n+                 tal:condition="python:item_type ==\'File\'"\n+                 tal:attributes="\n+                   src python:item.MimeTypeIcon();\n+                 "\n+            />\n \n-                <span tal:attributes="class string:$item_type_class $item_wf_state_class url;"\n-                      tal:content="python:item.Title()">\n+            <span tal:content="python:item.Title()"\n+                  tal:attributes="\n+                    class string:$item_type_class $item_wf_state_class url;\n+                  "\n+            >\n                     Title\n-                </span>\n-                <span class="discreet"\n-                      tal:content="python:item.Description()">\n+            </span>\n+            <span class="discreet"\n+                  tal:content="python:item.Description()"\n+            >\n                     Description\n-                </span>\n-              </a>\n             </span>\n-          </li>\n-        </ul>\n-    </div>\n+          </a>\n+        </span>\n+      </li>\n+    </ul>\n+  </div>\n </span>\ndiff --git a/plone/app/z3cform/templates/select_input.pt b/plone/app/z3cform/templates/select_input.pt\nindex 45179d9a..2bc69535 100644\n--- a/plone/app/z3cform/templates/select_input.pt\n+++ b/plone/app/z3cform/templates/select_input.pt\n@@ -1,44 +1,65 @@\n <div xmlns="http://www.w3.org/1999/xhtml"\n      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     tal:omit-tag="">\n-<select id="" name="" class="" tabindex="" disabled="" multiple="" size=""\n-        tal:attributes="id view/id;\n-                        name string:${view/name}:list;\n-                        required python:view.required and \'required\' or None;\n-                        class string:form-select ${view/klass};\n-                        style view/style;\n-                        title view/title;\n-                        lang view/lang;\n-                        onclick view/onclick;\n-                        ondblclick view/ondblclick;\n-                        onmousedown view/onmousedown;\n-                        onmouseup view/onmouseup;\n-                        onmouseover view/onmouseover;\n-                        onmousemove view/onmousemove;\n-                        onmouseout view/onmouseout;\n-                        onkeypress view/onkeypress;\n-                        onkeydown view/onkeydown;\n-                        onkeyup view/onkeyup;\n-                        disabled view/disabled;\n-                        tabindex view/tabindex;\n-                        onfocus view/onfocus;\n-                        onblur view/onblur;\n-                        onchange view/onchange;\n-                        multiple view/multiple;\n-                        size view/size">\n-<tal:block repeat="item view/items"\n-  ><option id="" value="" selected="selected"\n-         tal:condition="item/selected"\n-         tal:attributes="id item/id;\n-                         value item/value"\n-         tal:content="item/content">label</option\n-  ><option id="" value=""\n-         tal:condition="not:item/selected"\n-         tal:attributes="id item/id;\n-                         value item/value"\n-         tal:content="item/content">label</option\n-></tal:block>\n-</select>\n-<input name="field-empty-marker" type="hidden" value="1"\n-       tal:attributes="name string:${view/name}-empty-marker" />\n+     tal:omit-tag=""\n+>\n+  <select class=""\n+          id=""\n+          disabled\n+          multiple\n+          name=""\n+          size=""\n+          tabindex=""\n+          tal:attributes="\n+            id view/id;\n+            name string:${view/name}:list;\n+            required python:view.required and \'required\' or None;\n+            class string:form-select ${view/klass};\n+            style view/style;\n+            title view/title;\n+            lang view/lang;\n+            onclick view/onclick;\n+            ondblclick view/ondblclick;\n+            onmousedown view/onmousedown;\n+            onmouseup view/onmouseup;\n+            onmouseover view/onmouseover;\n+            onmousemove view/onmousemove;\n+            onmouseout view/onmouseout;\n+            onkeypress view/onkeypress;\n+            onkeydown view/onkeydown;\n+            onkeyup view/onkeyup;\n+            disabled view/disabled;\n+            tabindex view/tabindex;\n+            onfocus view/onfocus;\n+            onblur view/onblur;\n+            onchange view/onchange;\n+            multiple view/multiple;\n+            size view/size;\n+          "\n+  >\n+    <tal:block repeat="item view/items"><option id=""\n+              selected="selected"\n+              value=""\n+              tal:condition="item/selected"\n+              tal:content="item/content"\n+              tal:attributes="\n+                id item/id;\n+                value item/value;\n+              "\n+      >label</option><option id=""\n+              value=""\n+              tal:condition="not:item/selected"\n+              tal:content="item/content"\n+              tal:attributes="\n+                id item/id;\n+                value item/value;\n+              "\n+      >label</option></tal:block>\n+  </select>\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </div>\ndiff --git a/plone/app/z3cform/templates/singlecheckbox.pt b/plone/app/z3cform/templates/singlecheckbox.pt\nindex 7ff53c5b..06e45d93 100644\n--- a/plone/app/z3cform/templates/singlecheckbox.pt\n+++ b/plone/app/z3cform/templates/singlecheckbox.pt\n@@ -1,28 +1,37 @@\n <!-- DEPRECATED -->\n-<div\n-   i18n:domain="plone"\n-   metal:define-macro="widget-wrapper"\n-   tal:define="widget nocall:context;\n-               hidden python:widget.mode == \'hidden\';\n-               error widget/error;\n-               error_class python:error and \' error\' or \'\';\n-               fieldname_class string:kssattr-fieldname-${widget/name};"\n-   tal:attributes="class string:field ${fieldname_class}${error_class};\n-                   data-fieldname widget/name;\n-                   id string:formfield-${widget/id};">\n-    <input type="text" tal:replace="structure widget/render"\n-           metal:define-slot="widget" />\n+<div metal:define-macro="widget-wrapper"\n+     tal:define="\n+       widget nocall:context;\n+       hidden python:widget.mode == \'hidden\';\n+       error widget/error;\n+       error_class python:error and \' error\' or \'\';\n+       fieldname_class string:kssattr-fieldname-${widget/name};\n+     "\n+     tal:attributes="\n+       class string:field ${fieldname_class}${error_class};\n+       data-fieldname widget/name;\n+       id string:formfield-${widget/id};\n+     "\n+     i18n:domain="plone"\n+>\n+  <input metal:define-slot="widget"\n+         type="text"\n+         tal:replace="structure widget/render"\n+  />\n \n-    <div class="formHelp"\n-        tal:define="description widget/field/description"\n-        i18n:translate=""\n-        tal:content="structure description"\n-        tal:condition="python:description and not hidden"\n-        >field description</div>\n+  <div class="formHelp"\n+       tal:define="\n+         description widget/field/description;\n+       "\n+       tal:condition="python:description and not hidden"\n+       tal:content="structure description"\n+       i18n:translate=""\n+  >field description</div>\n \n-    <div class="fieldErrorBox"\n-        tal:content="structure error/render|nothing">\n+  <div class="fieldErrorBox"\n+       tal:content="structure error/render|nothing"\n+  >\n         Error\n-    </div>\n+  </div>\n \n </div>\ndiff --git a/plone/app/z3cform/templates/singlecheckboxbool_display.pt b/plone/app/z3cform/templates/singlecheckboxbool_display.pt\nindex 11d8004b..4daf57d1 100644\n--- a/plone/app/z3cform/templates/singlecheckboxbool_display.pt\n+++ b/plone/app/z3cform/templates/singlecheckboxbool_display.pt\n@@ -1,21 +1,24 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-  <span tal:attributes="id view/id;\n-                        class view/klass;\n-                        style view/style;\n-                        title view/title;\n-                        lang view/lang;\n-                        onclick view/onclick;\n-                        ondblclick view/ondblclick;\n-                        onmousedown view/onmousedown;\n-                        onmouseup view/onmouseup;\n-                        onmouseover view/onmouseover;\n-                        onmousemove view/onmousemove;\n-                        onmouseout view/onmouseout;\n-                        onkeypress view/onkeypress;\n-                        onkeydown view/onkeydown;\n-                        onkeyup view/onkeyup">\n-    <span tal:content="python:view.displayValue[0] if view.displayValue else \'\'" />\n+      tal:omit-tag=""\n+>\n+  <span tal:attributes="\n+          id view/id;\n+          class view/klass;\n+          style view/style;\n+          title view/title;\n+          lang view/lang;\n+          onclick view/onclick;\n+          ondblclick view/ondblclick;\n+          onmousedown view/onmousedown;\n+          onmouseup view/onmouseup;\n+          onmouseover view/onmouseover;\n+          onmousemove view/onmousemove;\n+          onmouseout view/onmouseout;\n+          onkeypress view/onkeypress;\n+          onkeydown view/onkeydown;\n+          onkeyup view/onkeyup;\n+        ">\n+    <span tal:content="python:view.displayValue[0] if view.displayValue else \'\'"></span>\n   </span>\n </html>\ndiff --git a/plone/app/z3cform/templates/singlecheckboxbool_hidden.pt b/plone/app/z3cform/templates/singlecheckboxbool_hidden.pt\nindex df70d83b..b95bc0e2 100644\n--- a/plone/app/z3cform/templates/singlecheckboxbool_hidden.pt\n+++ b/plone/app/z3cform/templates/singlecheckboxbool_hidden.pt\n@@ -1,36 +1,46 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     tal:omit-tag="">\n-<span class="option"\n-      tal:repeat="item view/items">\n-  <input id="" name="" value="" class="hidden-widget" title=""\n-         tabindex="" accesskey=""\n-         type="hidden"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         class view/klass;\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect" />\n-</span>\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      tal:omit-tag=""\n+>\n+  <span class="option"\n+        tal:repeat="item view/items"\n+  >\n+    <input class="hidden-widget"\n+           id=""\n+           accesskey=""\n+           name=""\n+           tabindex=""\n+           title=""\n+           type="hidden"\n+           value=""\n+           tal:attributes="\n+             id item/id;\n+             name item/name;\n+             class view/klass;\n+             value item/value;\n+             style view/style;\n+             title view/title;\n+             lang view/lang;\n+             onclick view/onclick;\n+             ondblclick view/ondblclick;\n+             onmousedown view/onmousedown;\n+             onmouseup view/onmouseup;\n+             onmouseover view/onmouseover;\n+             onmousemove view/onmousemove;\n+             onmouseout view/onmouseout;\n+             onkeypress view/onkeypress;\n+             onkeydown view/onkeydown;\n+             onkeyup view/onkeyup;\n+             disabled view/disabled;\n+             tabindex view/tabindex;\n+             onfocus view/onfocus;\n+             onblur view/onblur;\n+             onchange view/onchange;\n+             readonly view/readonly;\n+             alt view/alt;\n+             accesskey view/accesskey;\n+             onselect view/onselect;\n+           "\n+    />\n+  </span>\n </html>\ndiff --git a/plone/app/z3cform/templates/singlecheckboxbool_input.pt b/plone/app/z3cform/templates/singlecheckboxbool_input.pt\nindex 122e5da5..3f4f192f 100644\n--- a/plone/app/z3cform/templates/singlecheckboxbool_input.pt\n+++ b/plone/app/z3cform/templates/singlecheckboxbool_input.pt\n@@ -1,90 +1,133 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     tal:omit-tag=""\n-     tal:define="items view/items;\n-                 items python:list(items);\n-                 single_checkbox python:len(items) == 1">\n-<div tal:attributes="id view/id"\n-     tal:omit-tag="single_checkbox"\n-     tal:condition="python:len(items) > 0">\n- <div class="form-check"\n-       tal:repeat="item items"\n-       tal:attributes="id python:single_checkbox and view.id or None">\n-  <input type="checkbox" id="" name="" class="" alt="" title=""\n-         tabindex="" disabled="" readonly="" accesskey="" value=""\n-         checked="checked"\n-         tal:condition="item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         required python:view.required and \'required\' or None;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect"\n-  /><input id="" name="" class="" alt="" title="" tabindex=""\n-           disabled="" readonly="" accesskey="" value=""\n-           type="checkbox"\n-         tal:condition="not:item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         required python:view.required and \'required\' or None;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect" />\n-  <label for="" class="form-check-label"\n-         tal:attributes="for item/id">\n-    <span tal:content="item/label">Label</span>\n-    <span class="required horizontal"\n-          title="Required"\n-          tal:condition="item/required"\n-          i18n:attributes="title title_required;">&nbsp;</span>\n-  </label>\n-  <div class="form-text" tal:content="structure item/description">Description</div>\n- </div>\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      tal:define="\n+        items view/items;\n+        items python:list(items);\n+        single_checkbox python:len(items) == 1;\n+      "\n+      tal:omit-tag=""\n+>\n+  <div tal:condition="python:len(items) &gt; 0"\n+       tal:omit-tag="single_checkbox"\n+       tal:attributes="\n+         id view/id;\n+       "\n+  >\n+    <div class="form-check"\n+         tal:repeat="item items"\n+         tal:attributes="\n+           id python:single_checkbox and view.id or None;\n+         "\n+    >\n+      <input class=""\n+             id=""\n+             accesskey=""\n+             alt=""\n+             checked="checked"\n+             disabled\n+             name=""\n+             readonly\n+             tabindex=""\n+             title=""\n+             type="checkbox"\n+             value=""\n+             tal:condition="item/checked"\n+             tal:attributes="\n+               id item/id;\n+               name item/name;\n+               required python:view.required and \'required\' or None;\n+               class string:form-check-input ${view/klass};\n+               value item/value;\n+               style view/style;\n+               title view/title;\n+               lang view/lang;\n+               onclick view/onclick;\n+               ondblclick view/ondblclick;\n+               onmousedown view/onmousedown;\n+               onmouseup view/onmouseup;\n+               onmouseover view/onmouseover;\n+               onmousemove view/onmousemove;\n+               onmouseout view/onmouseout;\n+               onkeypress view/onkeypress;\n+               onkeydown view/onkeydown;\n+               onkeyup view/onkeyup;\n+               disabled view/disabled;\n+               tabindex view/tabindex;\n+               onfocus view/onfocus;\n+               onblur view/onblur;\n+               onchange view/onchange;\n+               readonly view/readonly;\n+               alt view/alt;\n+               accesskey view/accesskey;\n+               onselect view/onselect;\n+             "\n+      /><input class=""\n+             id=""\n+             accesskey=""\n+             alt=""\n+             disabled\n+             name=""\n+             readonly\n+             tabindex=""\n+             title=""\n+             type="checkbox"\n+             value=""\n+             tal:condition="not:item/checked"\n+             tal:attributes="\n+               id item/id;\n+               name item/name;\n+               required python:view.required and \'required\' or None;\n+               class string:form-check-input ${view/klass};\n+               value item/value;\n+               style view/style;\n+               title view/title;\n+               lang view/lang;\n+               onclick view/onclick;\n+               ondblclick view/ondblclick;\n+               onmousedown view/onmousedown;\n+               onmouseup view/onmouseup;\n+               onmouseover view/onmouseover;\n+               onmousemove view/onmousemove;\n+               onmouseout view/onmouseout;\n+               onkeypress view/onkeypress;\n+               onkeydown view/onkeydown;\n+               onkeyup view/onkeyup;\n+               disabled view/disabled;\n+               tabindex view/tabindex;\n+               onfocus view/onfocus;\n+               onblur view/onblur;\n+               onchange view/onchange;\n+               readonly view/readonly;\n+               alt view/alt;\n+               accesskey view/accesskey;\n+               onselect view/onselect;\n+             "\n+      />\n+      <label class="form-check-label"\n+             for=""\n+             tal:attributes="\n+               for item/id;\n+             "\n+      >\n+        <span tal:content="item/label">Label</span>\n+        <span class="required horizontal"\n+              title="Required"\n+              tal:condition="item/required"\n+              i18n:attributes="title title_required;"\n+        >&nbsp;</span>\n+      </label>\n+      <div class="form-text"\n+           tal:content="structure item/description"\n+      >Description</div>\n+    </div>\n \n-</div>\n+  </div>\n \n-<input name="field-empty-marker" type="hidden" value="1"\n-       tal:attributes="name string:${view/name}-empty-marker" />\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/submit_input.pt b/plone/app/z3cform/templates/submit_input.pt\nindex 096ef1fe..bd74580b 100644\n--- a/plone/app/z3cform/templates/submit_input.pt\n+++ b/plone/app/z3cform/templates/submit_input.pt\n@@ -1,33 +1,39 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<button type="submit"\n-        tal:define="bsFallback python:\'btn-secondary \' if not \'btn-\' in view.klass else \'\'"\n-        tal:attributes="id view/id;\n-                        name view/name;\n-                        class string:btn ${bsFallback}${view/klass};\n-                        value view/value;\n-                        style view/style;\n-                        lang view/lang;\n-                        onclick view/onclick;\n-                        ondblclick view/ondblclick;\n-                        onmousedown view/onmousedown;\n-                        onmouseup view/onmouseup;\n-                        onmouseover view/onmouseover;\n-                        onmousemove view/onmousemove;\n-                        onmouseout view/onmouseout;\n-                        onkeypress view/onkeypress;\n-                        onkeydown view/onkeydown;\n-                        onkeyup view/onkeyup;\n-                        disabled view/disabled;\n-                        tabindex view/tabindex;\n-                        onfocus view/onfocus;\n-                        onblur view/onblur;\n-                        onchange view/onchange;\n-                        readonly view/readonly;\n-                        alt view/alt;\n-                        accesskey view/accesskey;\n-                        onselect view/onselect;\n-                        formnovalidate python:view.ignoreRequiredOnValidation or None"\n-        tal:content="view/value">value</button>\n+      tal:omit-tag=""\n+>\n+  <button type="submit"\n+          tal:define="\n+            bsFallback python:\'btn-secondary \' if not \'btn-\' in view.klass else \'\';\n+          "\n+          tal:content="view/value"\n+          tal:attributes="\n+            id view/id;\n+            name view/name;\n+            class string:btn ${bsFallback}${view/klass};\n+            value view/value;\n+            style view/style;\n+            lang view/lang;\n+            onclick view/onclick;\n+            ondblclick view/ondblclick;\n+            onmousedown view/onmousedown;\n+            onmouseup view/onmouseup;\n+            onmouseover view/onmouseover;\n+            onmousemove view/onmousemove;\n+            onmouseout view/onmouseout;\n+            onkeypress view/onkeypress;\n+            onkeydown view/onkeydown;\n+            onkeyup view/onkeyup;\n+            disabled view/disabled;\n+            tabindex view/tabindex;\n+            onfocus view/onfocus;\n+            onblur view/onblur;\n+            onchange view/onchange;\n+            readonly view/readonly;\n+            alt view/alt;\n+            accesskey view/accesskey;\n+            onselect view/onselect;\n+            formnovalidate python:view.ignoreRequiredOnValidation or None;\n+          "\n+  >value</button>\n </html>\ndiff --git a/plone/app/z3cform/templates/text_input.pt b/plone/app/z3cform/templates/text_input.pt\nindex 29b87259..a44ad190 100644\n--- a/plone/app/z3cform/templates/text_input.pt\n+++ b/plone/app/z3cform/templates/text_input.pt\n@@ -1,38 +1,54 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-    <input id="" name="" class="" title="" lang="" disabled=""\n-           readonly="" alt="" tabindex="" accesskey="" size="" maxlength=""\n-           style="" value="" type="text"\n-           tal:attributes="id view/id;\n-                           name view/name;\n-                           required python:view.required and \'required\' or None;\n-                           class python:\'form-control {0}{1}\'.format(view.klass, view.error and \' is-invalid\' or \'\');\n-                           style view/style;\n-                           title view/title;\n-                           lang view/lang;\n-                           onclick view/onclick;\n-                           ondblclick view/ondblclick;\n-                           onmousedown view/onmousedown;\n-                           onmouseup view/onmouseup;\n-                           onmouseover view/onmouseover;\n-                           onmousemove view/onmousemove;\n-                           onmouseout view/onmouseout;\n-                           onkeypress view/onkeypress;\n-                           onkeydown view/onkeydown;\n-                           onkeyup view/onkeyup;\n-                           value view/value;\n-                           disabled view/disabled;\n-                           tabindex view/tabindex;\n-                           onfocus view/onfocus;\n-                           onblur view/onblur;\n-                           onchange view/onchange;\n-                           readonly view/readonly;\n-                           alt view/alt;\n-                           accesskey view/accesskey;\n-                           onselect view/onselect;\n-                           size view/size;\n-                           maxlength view/maxlength;\n-                           placeholder view/placeholder;\n-                           autocapitalize view/autocapitalize" />\n+      tal:omit-tag=""\n+>\n+  <input class=""\n+         id=""\n+         accesskey=""\n+         alt=""\n+         disabled\n+         lang=""\n+         maxlength=""\n+         name=""\n+         readonly\n+         size=""\n+         style=""\n+         tabindex=""\n+         title=""\n+         type="text"\n+         value=""\n+         tal:attributes="\n+           id view/id;\n+           name view/name;\n+           required python:view.required and \'required\' or None;\n+           class python:\'form-control {0}{1}\'.format(view.klass, view.error and \' is-invalid\' or \'\');\n+           style view/style;\n+           title view/title;\n+           lang view/lang;\n+           onclick view/onclick;\n+           ondblclick view/ondblclick;\n+           onmousedown view/onmousedown;\n+           onmouseup view/onmouseup;\n+           onmouseover view/onmouseover;\n+           onmousemove view/onmousemove;\n+           onmouseout view/onmouseout;\n+           onkeypress view/onkeypress;\n+           onkeydown view/onkeydown;\n+           onkeyup view/onkeyup;\n+           value view/value;\n+           disabled view/disabled;\n+           tabindex view/tabindex;\n+           onfocus view/onfocus;\n+           onblur view/onblur;\n+           onchange view/onchange;\n+           readonly view/readonly;\n+           alt view/alt;\n+           accesskey view/accesskey;\n+           onselect view/onselect;\n+           size view/size;\n+           maxlength view/maxlength;\n+           placeholder view/placeholder;\n+           autocapitalize view/autocapitalize;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/textarea_input.pt b/plone/app/z3cform/templates/textarea_input.pt\nindex 84939c50..12aa6460 100644\n--- a/plone/app/z3cform/templates/textarea_input.pt\n+++ b/plone/app/z3cform/templates/textarea_input.pt\n@@ -1,35 +1,45 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<textarea\n-   id="" name="" class="" cols="" rows=""\n-   tabindex="" disabled="" readonly="" accesskey=""\n-   tal:attributes="id view/id;\n-                   name view/name;\n-\t\t   required python:view.required and \'required\' or None;\n-                   class string:form-control ${view/klass};\n-                   style view/style;\n-                   title view/title;\n-                   lang view/lang;\n-                   onclick view/onclick;\n-                   ondblclick view/ondblclick;\n-                   onmousedown view/onmousedown;\n-                   onmouseup view/onmouseup;\n-                   onmouseover view/onmouseover;\n-                   onmousemove view/onmousemove;\n-                   onmouseout view/onmouseout;\n-                   onkeypress view/onkeypress;\n-                   onkeydown view/onkeydown;\n-                   onkeyup view/onkeyup;\n-                   disabled view/disabled;\n-                   tabindex view/tabindex;\n-                   onfocus view/onfocus;\n-                   onblur view/onblur;\n-                   onchange view/onchange;\n-                   cols view/cols;\n-                   rows view/rows;\n-                   readonly view/readonly;\n-                   accesskey view/accesskey;\n-                   onselect view/onselect"\n-   tal:content="view/value" />\n+      tal:omit-tag=""\n+>\n+  <textarea class=""\n+            id=""\n+            accesskey=""\n+            cols=""\n+            disabled\n+            name=""\n+            readonly\n+            rows=""\n+            tabindex=""\n+            tal:content="view/value"\n+            tal:attributes="\n+              id view/id;\n+              name view/name;\n+              required python:view.required and \'required\' or None;\n+              class string:form-control ${view/klass};\n+              style view/style;\n+              title view/title;\n+              lang view/lang;\n+              onclick view/onclick;\n+              ondblclick view/ondblclick;\n+              onmousedown view/onmousedown;\n+              onmouseup view/onmouseup;\n+              onmouseover view/onmouseover;\n+              onmousemove view/onmousemove;\n+              onmouseout view/onmouseout;\n+              onkeypress view/onkeypress;\n+              onkeydown view/onkeydown;\n+              onkeyup view/onkeyup;\n+              disabled view/disabled;\n+              tabindex view/tabindex;\n+              onfocus view/onfocus;\n+              onblur view/onblur;\n+              onchange view/onchange;\n+              cols view/cols;\n+              rows view/rows;\n+              readonly view/readonly;\n+              accesskey view/accesskey;\n+              onselect view/onselect;\n+            "\n+  ></textarea>\n </html>\ndiff --git a/plone/app/z3cform/templates/textfield_widget_input.pt b/plone/app/z3cform/templates/textfield_widget_input.pt\nindex 512300bd..7115dead 100644\n--- a/plone/app/z3cform/templates/textfield_widget_input.pt\n+++ b/plone/app/z3cform/templates/textfield_widget_input.pt\n@@ -1,75 +1,94 @@\n-<div lang="en"\n-     xml:lang="en"\n-     xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     xmlns:metal="http://xml.zope.org/namespaces/metal"\n+<div xmlns="http://www.w3.org/1999/xhtml"\n      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+     xmlns:metal="http://xml.zope.org/namespaces/metal"\n+     xmlns:tal="http://xml.zope.org/namespaces/tal"\n+     lang="en"\n+     xml:lang="en"\n+     tal:attributes="\n+       class view/klass;\n+       style view/style;\n+       title view/title;\n+       lang view/lang;\n+       onclick view/onclick;\n+       ondblclick view/ondblclick;\n+       onmousedown view/onmousedown;\n+       onmouseup view/onmouseup;\n+       onmouseover view/onmouseover;\n+       onmousemove view/onmousemove;\n+       onmouseout view/onmouseout;\n+       onkeypress view/onkeypress;\n+       onkeydown view/onkeydown;\n+       onkeyup view/onkeyup;\n+     "\n      i18n:domain="plone"\n-     tal:attributes="class view/klass;\n-                     style view/style;\n-                     title view/title;\n-                     lang view/lang;\n-                     onclick view/onclick;\n-                     ondblclick view/ondblclick;\n-                     onmousedown view/onmousedown;\n-                     onmouseup view/onmouseup;\n-                     onmouseover view/onmouseover;\n-                     onmousemove view/onmousemove;\n-                     onmouseout view/onmouseout;\n-                     onkeypress view/onkeypress;\n-                     onkeydown view/onkeydown;\n-                     onkeyup view/onkeyup">\n+>\n \n-    <tal:define define="fieldName view/name;\n-                        mimeType view/value/mimeType | view/field/default_mime_type;\n-                        allowedMimeTypes view/allowedMimeTypes">\n+  <tal:define define="\n+                fieldName view/name;\n+                mimeType view/value/mimeType | view/field/default_mime_type;\n+                allowedMimeTypes view/allowedMimeTypes;\n+              ">\n \n-        <div class="fieldTextFormat" tal:condition="python: len(allowedMimeTypes) > 1">\n-            <label i18n:translate="label_text_format">Text Format</label>\n+    <div class="fieldTextFormat"\n+         tal:condition="python: len(allowedMimeTypes) &gt; 1"\n+    >\n+      <label i18n:translate="label_text_format">Text Format</label>\n \n-            <select class="form-control"\n-                    tal:attributes="id   string:${fieldName}_text_format;\n-                                    name string:${fieldName}.mimeType;">\n-                <option selected=""\n-                    tal:repeat="item allowedMimeTypes"\n-                    tal:attributes="selected python:item == mimeType and \'selected\' or None;\n-                                    value item;"\n-                    tal:content="item" />\n-            </select>\n-        </div>\n+      <select class="form-control"\n+              tal:attributes="\n+                id   string:${fieldName}_text_format;\n+                name string:${fieldName}.mimeType;\n+              "\n+      >\n+        <option selected\n+                tal:repeat="item allowedMimeTypes"\n+                tal:content="item"\n+                tal:attributes="\n+                  selected python:item == mimeType and \'selected\' or None;\n+                  value item;\n+                "\n+        ></option>\n+      </select>\n+    </div>\n \n-        <tal:hidden condition="python: len(allowedMimeTypes) == 1">\n-            <input type="hidden" tal:attributes="id string:${fieldName}_text_format;\n-                                                 name string:${fieldName}.mimeType;\n-                                                 value python:allowedMimeTypes[0]"/>\n-        </tal:hidden>\n-    </tal:define>\n+    <tal:hidden condition="python: len(allowedMimeTypes) == 1">\n+      <input type="hidden"\n+             tal:attributes="\n+               id string:${fieldName}_text_format;\n+               name string:${fieldName}.mimeType;\n+               value python:allowedMimeTypes[0];\n+             "\n+      />\n+    </tal:hidden>\n+  </tal:define>\n \n-    <tal:editor define="context            view/wrapped_context;\n-                        object             python:(not view.ignoreContext) and context or None;\n-                        here               nocall:context;\n-                        portal_url         nocall:context/portal_url;\n-                        portal             portal_url/getPortalObject;\n-                        text_format        view/value/mimeType | view/field/default_mime_type;\n-                        force_wysiwyg      python:True;\n-                        inputname          view/name;\n-                        inputvalue         view/value/raw | nothing;\n-                        here_url           request/getURL;\n-                        member context/portal_membership/getAuthenticatedMember;\n-                        isAnon context/@@plone_portal_state/anonymous;\n-                        member_editor python: not isAnon and member.getProperty(\'wysiwyg_editor\').lower() or \'\';\n-                        default_editor python: context.portal_properties.site_properties.getProperty(\'default_editor\', \'\').lower();\n-                        editor python: member_editor==\'\' and default_editor or member_editor;\n-                        support_path string:nocall:here/@@${editor}_wysiwyg_support|here/${editor}_wysiwyg_support|here/${editor}/wysiwyg_support|here/portal_skins/plone_wysiwyg/wysiwyg_support;\n-                        support python: path(support_path);\n-                        tabindex           nothing;\n-                        rows               python:view.rows or 25;\n-                        cols               python:view.cols or 80;\n-                        maxlength          python:view.field.max_length or None;\n-                        field              view/field;">\n-        <div metal:use-macro="support/macros/wysiwygEditorBox">\n+  <tal:editor define="\n+                context            view/wrapped_context;\n+                object             python:(not view.ignoreContext) and context or None;\n+                here               nocall:context;\n+                portal_url         nocall:context/portal_url;\n+                portal             portal_url/getPortalObject;\n+                text_format        view/value/mimeType | view/field/default_mime_type;\n+                force_wysiwyg      python:True;\n+                inputname          view/name;\n+                inputvalue         view/value/raw | nothing;\n+                here_url           request/getURL;\n+                member context/portal_membership/getAuthenticatedMember;\n+                isAnon context/@@plone_portal_state/anonymous;\n+                member_editor python: not isAnon and member.getProperty(\'wysiwyg_editor\').lower() or \'\';\n+                default_editor python: context.portal_properties.site_properties.getProperty(\'default_editor\', \'\').lower();\n+                editor python: member_editor==\'\' and default_editor or member_editor;\n+                support_path string:nocall:here/@@${editor}_wysiwyg_support|here/${editor}_wysiwyg_support|here/${editor}/wysiwyg_support|here/portal_skins/plone_wysiwyg/wysiwyg_support;\n+                support python: path(support_path);\n+                tabindex           nothing;\n+                rows               python:view.rows or 25;\n+                cols               python:view.cols or 80;\n+                maxlength          python:view.field.max_length or None;\n+                field              view/field;\n+              ">\n+    <div metal:use-macro="support/macros/wysiwygEditorBox">\n             The WYSIWYG code\n-        </div>\n-    </tal:editor>\n+    </div>\n+  </tal:editor>\n \n </div>\ndiff --git a/plone/app/z3cform/templates/textlines_input.pt b/plone/app/z3cform/templates/textlines_input.pt\nindex 0bda236e..6f51167e 100644\n--- a/plone/app/z3cform/templates/textlines_input.pt\n+++ b/plone/app/z3cform/templates/textlines_input.pt\n@@ -1,34 +1,44 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<textarea\n-    id="" name="" class="" cols="" rows=""\n-    tabindex="" disabled="" readonly="" accesskey=""\n-    tal:attributes="id view/id;\n-                    name view/name;\n-                    class string:form-control ${view/klass};\n-                    style view/style;\n-                    title view/title;\n-                    lang view/lang;\n-                    onclick view/onclick;\n-                    ondblclick view/ondblclick;\n-                    onmousedown view/onmousedown;\n-                    onmouseup view/onmouseup;\n-                    onmouseover view/onmouseover;\n-                    onmousemove view/onmousemove;\n-                    onmouseout view/onmouseout;\n-                    onkeypress view/onkeypress;\n-                    onkeydown view/onkeydown;\n-                    onkeyup view/onkeyup;\n-                    disabled view/disabled;\n-                    tabindex view/tabindex;\n-                    onfocus view/onfocus;\n-                    onblur view/onblur;\n-                    onchange view/onchange;\n-                    cols view/cols;\n-                    rows view/rows;\n-                    readonly view/readonly;\n-                    accesskey view/accesskey;\n-                    onselect view/onselect"\n-    tal:content="structure view/value" />\n+      tal:omit-tag=""\n+>\n+  <textarea class=""\n+            id=""\n+            accesskey=""\n+            cols=""\n+            disabled\n+            name=""\n+            readonly\n+            rows=""\n+            tabindex=""\n+            tal:content="structure view/value"\n+            tal:attributes="\n+              id view/id;\n+              name view/name;\n+              class string:form-control ${view/klass};\n+              style view/style;\n+              title view/title;\n+              lang view/lang;\n+              onclick view/onclick;\n+              ondblclick view/ondblclick;\n+              onmousedown view/onmousedown;\n+              onmouseup view/onmouseup;\n+              onmouseover view/onmouseover;\n+              onmousemove view/onmousemove;\n+              onmouseout view/onmouseout;\n+              onkeypress view/onkeypress;\n+              onkeydown view/onkeydown;\n+              onkeyup view/onkeyup;\n+              disabled view/disabled;\n+              tabindex view/tabindex;\n+              onfocus view/onfocus;\n+              onblur view/onblur;\n+              onchange view/onchange;\n+              cols view/cols;\n+              rows view/rows;\n+              readonly view/readonly;\n+              accesskey view/accesskey;\n+              onselect view/onselect;\n+            "\n+  ></textarea>\n </html>\ndiff --git a/plone/app/z3cform/templates/widget.pt b/plone/app/z3cform/templates/widget.pt\nindex 4b266a73..873ebfe7 100644\n--- a/plone/app/z3cform/templates/widget.pt\n+++ b/plone/app/z3cform/templates/widget.pt\n@@ -1,43 +1,58 @@\n-<div\n-   metal:define-macro="widget-wrapper"\n-   i18n:domain="plone"\n-   tal:define="widget nocall:context;\n-               error python:widget.error;\n-               error_class python:error and \' error\' or \'\';\n-               empty_values python: (None, \'\', [], (\'\', \'\', \'\', \'00\', \'00\', \'\'), (\'\', \'\', \'\'));\n-               empty_class python: (widget.value in empty_values) and \' empty\' or \'\';\n-               "\n-   id="formfield-${python:widget.id}"\n-   class="mb-3 field fieldname-${python:widget.name} widget-mode-${python:widget.mode}${error_class}${empty_class} ${python:getattr(widget, \'wrapper_css_class\', False) or False}"\n-   data-fieldname="${widget/name}">\n-    <label for="${python:widget.id}"\n-           class="form-label"\n-           tal:condition="python: widget.mode == \'input\' and widget.label">\n-        <span i18n:translate="" tal:replace="python:widget.label">label</span>\n+<div class="mb-3 field fieldname-${python:widget.name} widget-mode-${python:widget.mode}${error_class}${empty_class} ${python:getattr(widget, \'wrapper_css_class\', False) or False}"\n+     id="formfield-${python:widget.id}"\n+     metal:define-macro="widget-wrapper"\n+     data-fieldname="${widget/name}"\n+     tal:define="\n+       widget nocall:context;\n+       error python:widget.error;\n+       error_class python:error and \' error\' or \'\';\n+       empty_values python: (None, \'\', [], (\'\', \'\', \'\', \'00\', \'00\', \'\'), (\'\', \'\', \'\'));\n+       empty_class python: (widget.value in empty_values) and \' empty\' or \'\';\n+     "\n+     i18n:domain="plone"\n+>\n+  <label class="form-label"\n+         for="${python:widget.id}"\n+         tal:condition="python: widget.mode == \'input\' and widget.label"\n+  >\n+    <span tal:replace="python:widget.label"\n+          i18n:translate=""\n+    >label</span>\n \n-        <span class="required" title="Required"\n-              tal:condition="python:widget.required"\n-              i18n:attributes="title title_required;"></span>\n-    </label>\n-    <b class="widget-label form-label d-block"\n-          tal:condition="python: widget.mode == \'display\' and widget.label">\n-        <span i18n:translate="" tal:replace="python:widget.label">label</span>\n-    </b>\n+    <span class="required"\n+          title="Required"\n+          tal:condition="python:widget.required"\n+          i18n:attributes="title title_required;"\n+    ></span>\n+  </label>\n+  <b class="widget-label form-label d-block"\n+     tal:condition="python: widget.mode == \'display\' and widget.label"\n+  >\n+    <span tal:replace="python:widget.label"\n+          i18n:translate=""\n+    >label</span>\n+  </b>\n \n-    <input type="text" tal:replace="structure python:widget.render()"\n-           metal:define-slot="widget" />\n+  <input metal:define-slot="widget"\n+         type="text"\n+         tal:replace="structure python:widget.render()"\n+  />\n \n-    <div tal:define="description python: getattr(widget, \'description\', widget.field.description)"\n-           i18n:translate=""\n-           tal:content="structure description"\n-           tal:condition="python:description and widget.mode == \'input\'"\n-           class="form-text">\n+  <div class="form-text"\n+       tal:define="\n+         description python: getattr(widget, \'description\', widget.field.description);\n+       "\n+       tal:condition="python:description and widget.mode == \'input\'"\n+       tal:content="structure description"\n+       i18n:translate=""\n+  >\n       help text\n-    </div>\n+  </div>\n \n-    <div tal:condition="error"\n-         tal:replace="structure python:error.render() or False">\n+  <div tal:condition="error"\n+       tal:replace="structure python:error.render() or False"\n+  >\n         Error\n-    </div>\n+  </div>\n \n </div>\ndiff --git a/plone/app/z3cform/wysiwyg/wysiwyg_display.pt b/plone/app/z3cform/wysiwyg/wysiwyg_display.pt\nindex 8333d982..71952720 100644\n--- a/plone/app/z3cform/wysiwyg/wysiwyg_display.pt\n+++ b/plone/app/z3cform/wysiwyg/wysiwyg_display.pt\n@@ -1,18 +1,22 @@\n-<div id="" class=""\n-      tal:attributes="id view/id;\n-                      class view/klass;\n-                      style view/style;\n-                      title view/title;\n-                      lang view/lang;\n-                      onclick view/onclick;\n-                      ondblclick view/ondblclick;\n-                      onmousedown view/onmousedown;\n-                      onmouseup view/onmouseup;\n-                      onmouseover view/onmouseover;\n-                      onmousemove view/onmousemove;\n-                      onmouseout view/onmouseout;\n-                      onkeypress view/onkeypress;\n-                      onkeydown view/onkeydown;\n-                      onkeyup view/onkeyup"><tal:block\n-      condition="view/value" content="structure view/value"\n-/></div>\n+<div class=""\n+     id=""\n+     tal:attributes="\n+       id view/id;\n+       class view/klass;\n+       style view/style;\n+       title view/title;\n+       lang view/lang;\n+       onclick view/onclick;\n+       ondblclick view/ondblclick;\n+       onmousedown view/onmousedown;\n+       onmouseup view/onmouseup;\n+       onmouseover view/onmouseover;\n+       onmousemove view/onmousemove;\n+       onmouseout view/onmouseout;\n+       onkeypress view/onkeypress;\n+       onkeydown view/onkeydown;\n+       onkeyup view/onkeyup;\n+     "\n+><tal:block condition="view/value"\n+             content="structure view/value"\n+  /></div>\ndiff --git a/plone/app/z3cform/wysiwyg/wysiwyg_input.pt b/plone/app/z3cform/wysiwyg/wysiwyg_input.pt\nindex f93e4b17..4edab0c0 100644\n--- a/plone/app/z3cform/wysiwyg/wysiwyg_input.pt\n+++ b/plone/app/z3cform/wysiwyg/wysiwyg_input.pt\n@@ -1,25 +1,28 @@\n-<div lang="en"\n-     xml:lang="en"\n-     xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     xmlns:metal="http://xml.zope.org/namespaces/metal"\n+<div xmlns="http://www.w3.org/1999/xhtml"\n      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-     i18n:domain="plone">\n+     xmlns:metal="http://xml.zope.org/namespaces/metal"\n+     xmlns:tal="http://xml.zope.org/namespaces/tal"\n+     lang="en"\n+     xml:lang="en"\n+     i18n:domain="plone"\n+>\n \n-     <tal:editor define="context            nocall:view/form/context;\n-                         here               nocall:context;\n-                         portal_url         nocall:context/portal_url;\n-                         portal             portal_url/getPortalObject;\n-                         z3c_widget         nocall:view;\n-                         id                 view/id;\n-                         inputname          view/name;\n-                         inputvalue         view/value;\n-                         here_url           request/getURL;\n-                         member             context/portal_membership/getAuthenticatedMember;\n-                         tabindex           nothing">\n-        <div metal:use-macro="context/wysiwyg_support/macros/wysiwygEditorBox">\n+  <tal:editor define="\n+                context            nocall:view/form/context;\n+                here               nocall:context;\n+                portal_url         nocall:context/portal_url;\n+                portal             portal_url/getPortalObject;\n+                z3c_widget         nocall:view;\n+                id                 view/id;\n+                inputname          view/name;\n+                inputvalue         view/value;\n+                here_url           request/getURL;\n+                member             context/portal_membership/getAuthenticatedMember;\n+                tabindex           nothing;\n+              ">\n+    <div metal:use-macro="context/wysiwyg_support/macros/wysiwygEditorBox">\n             The WYSIWYG code\n-        </div>\n-    </tal:editor>\n+    </div>\n+  </tal:editor>\n \n </div>\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:11:23+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/5dc642a92471245b5a0ce9b52c8527d2a6df3e06

feat: flake8

Files changed:
M plone/app/z3cform/interfaces.py
M plone/app/z3cform/tests/test_widgets.py
M plone/app/z3cform/widget.py

b'diff --git a/plone/app/z3cform/interfaces.py b/plone/app/z3cform/interfaces.py\nindex 82f09f4..1db3ad3 100644\n--- a/plone/app/z3cform/interfaces.py\n+++ b/plone/app/z3cform/interfaces.py\n@@ -7,7 +7,6 @@\n from zope.interface import Interface\n from zope.schema.interfaces import IDate\n from zope.schema.interfaces import IDatetime\n-from zope.schema.interfaces import ITime\n \n \n class IPloneFormLayer(IFormLayer):\ndiff --git a/plone/app/z3cform/tests/test_widgets.py b/plone/app/z3cform/tests/test_widgets.py\nindex adb19a1..7117289 100644\n--- a/plone/app/z3cform/tests/test_widgets.py\n+++ b/plone/app/z3cform/tests/test_widgets.py\n@@ -193,7 +193,6 @@ def setUp(self):\n         self.widget.pattern_options = {"date": {"firstDay": 0}}\n \n     def test_widget(self):\n-        current_year = datetime.today().year\n         self.assertEqual(\n             {\n                 "name": None,\n@@ -300,7 +299,6 @@ def setUp(self):\n         }\n \n     def test_widget(self):\n-        current_year = datetime.today().year\n         self.assertEqual(\n             {\n                 "name": None,\ndiff --git a/plone/app/z3cform/widget.py b/plone/app/z3cform/widget.py\nindex bb7d5e4..28d1570 100644\n--- a/plone/app/z3cform/widget.py\n+++ b/plone/app/z3cform/widget.py\n@@ -13,7 +13,6 @@\n from plone.app.widgets.base import TextareaWidget\n from plone.app.widgets.utils import get_context_url\n from plone.app.widgets.utils import get_date_options\n-from plone.app.widgets.utils import get_datetime_options\n from plone.app.widgets.utils import get_querystring_options\n from plone.app.widgets.utils import get_relateditems_options\n from plone.app.widgets.utils import get_tinymce_options\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:11:23+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/5cbe9790d7e6c338ac6c63d1e059b1d8122a7690

feat: configure codespell

Files changed:
M pyproject.toml

b'diff --git a/pyproject.toml b/pyproject.toml\nindex 9eb73f3..7a2d8b0 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -60,3 +60,6 @@ Zope = [\n   \'Products.CMFDynamicViewFTI\', \'zope.deprecation\',\n ]\n python-dateutil = [\'dateutil\']\n+\n+[tool.codespell]\n+ignore-words-list = "discreet"\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:11:23+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/c2c4f920b6fa1e59f96c174bd1e77391a5ad463a

feat: codespell

Files changed:
M CHANGES.rst
M plone/app/z3cform/converters.py
M plone/app/z3cform/tests/test_utils.py
M plone/app/z3cform/tests/test_widget.py
M plone/app/z3cform/tests/test_widgets.py
M plone/app/z3cform/utils.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 9194411..5a0a14f 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -128,7 +128,7 @@ Bug fixes:\n Bug fixes:\n \n \n-- Remove errorneous extra curly bracket in class name of the widget wrapper.\n+- Remove erroneous extra curly bracket in class name of the widget wrapper.\n   [thet] (#136)\n \n \n@@ -399,7 +399,7 @@ Bug fixes:\n - Fixes #64: SingleCheckBoxFieldWidget does not render value in view mode.\n   In order to fix this issue the hacky view was removed.\n   It is replaced by a new widget to render a single checkbox with bool values.\n-  An appropiate data converter was added as well.\n+  An appropriate data converter was added as well.\n   [jensens]\n \n \n@@ -422,7 +422,7 @@ New features:\n \n Bug fixes:\n \n-- Catch TypeError occuring on conflicting subrequests in inline validation\n+- Catch TypeError occurring on conflicting subrequests in inline validation\n   [tomgross]\n \n - Clean up: code-style, zca-decorators, replace lambda.\n@@ -501,7 +501,7 @@ New features:\n   whichever is specified by field.\n   [seanupton]\n \n-- Support functions as values in the ``pattern_options`` dictionary, whch gets then serialized to JSON.\n+- Support functions as values in the ``pattern_options`` dictionary, which gets then serialized to JSON.\n   Before that, walk recursively through ``pattern_options`` and call all functions with the widgets context.\n   This allows for context-specific, runtime evaluated pattern option values.\n   [thet]\ndiff --git a/plone/app/z3cform/converters.py b/plone/app/z3cform/converters.py\nindex 715b74d..9f1d2b3 100644\n--- a/plone/app/z3cform/converters.py\n+++ b/plone/app/z3cform/converters.py\n@@ -493,7 +493,7 @@ def toWidgetValue(self, value):\n             is_same_domain = utils.is_same_domain(value, portal.absolute_url())\n             is_absolute = utils.is_absolute(value)\n             if "/resolveuid/" in value and (not is_absolute or is_same_domain):\n-                # Take the UUID part of a resolveuid url, but onl if it\'s on\n+                # Take the UUID part of a resolveuid url, but only if it\'s on\n                 # the same domain.\n                 uuid = value.rsplit("/", 1)[-1]\n             elif not is_absolute or is_absolute and is_same_domain:\n@@ -502,7 +502,7 @@ def toWidgetValue(self, value):\n                 if parsed.params or parsed.query or parsed.fragment:\n                     # we don\'t want to loose query parameters\n                     # so we don\'t convert URLs pointing to internal\n-                    # objects with params, querys or fragments\n+                    # objects with params, queries or fragments\n                     # to uids\n                     pass\n                 else:\ndiff --git a/plone/app/z3cform/tests/test_utils.py b/plone/app/z3cform/tests/test_utils.py\nindex 91ca2f3..70420a6 100644\n--- a/plone/app/z3cform/tests/test_utils.py\n+++ b/plone/app/z3cform/tests/test_utils.py\n@@ -136,7 +136,7 @@ def test_is_same_domain(self):\n             )\n         )\n \n-        # These are two completly different URLs\n+        # These are two completely different URLs\n         self.assertTrue(\n             not is_same_domain(\n                 "https://domain1.com",\ndiff --git a/plone/app/z3cform/tests/test_widget.py b/plone/app/z3cform/tests/test_widget.py\nindex 264d935..a8af259 100644\n--- a/plone/app/z3cform/tests/test_widget.py\n+++ b/plone/app/z3cform/tests/test_widget.py\n@@ -30,7 +30,7 @@ def setUp(self):\n         setRequest(self.request)\n \n     def test_missing_aq_chain(self):\n-        # testing support for contents witout Acquisiion chain (for avoid\n+        # testing support for contents without Acquisition chain (for avoid\n         # regression)\n         # See\n         # https://github.com/plone/plone.app.z3cform/commit/587e229e267705a4fd48c6c51a76f849196fceba#commitcomment-2630299\ndiff --git a/plone/app/z3cform/tests/test_widgets.py b/plone/app/z3cform/tests/test_widgets.py\nindex 7117289..e14cc56 100644\n--- a/plone/app/z3cform/tests/test_widgets.py\n+++ b/plone/app/z3cform/tests/test_widgets.py\n@@ -278,7 +278,7 @@ def test_dateformatter(self):\n         self.widget._formater_length = "full"\n         self.assertEqual("Wednesday, August 17, 2022", self.widget.render())\n \n-        # unknown formater length\n+        # unknown formatter length\n         self.widget._formater_length = "foo"\n         with self.assertRaises(ValueError):\n             self.widget.render()\n@@ -454,7 +454,7 @@ def test_datetimeformatter(self):\n             "Wednesday, August 17, 2022 12:00:00 PM +000", self.widget.render()\n         )\n \n-        # unknown formater length\n+        # unknown formatter length\n         self.widget._formater_length = "foo"\n         with self.assertRaises(ValueError):\n             self.widget.render()\ndiff --git a/plone/app/z3cform/utils.py b/plone/app/z3cform/utils.py\nindex f420d87..bf2bed6 100644\n--- a/plone/app/z3cform/utils.py\n+++ b/plone/app/z3cform/utils.py\n@@ -8,7 +8,7 @@\n \n \n def closest_content(context=None):\n-    """Try to find a usable context, with increasing agression"""\n+    """Try to find a usable context, with increasing aggression"""\n     # Normally, we should be given a useful context (e.g the page)\n     c = context\n     c = _valid_context(c)\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:11:24+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/41037d6559af52cf2ea7307ec25bf674ea2f2d51

fix(tox): adjust extras name

Files changed:
M tox.ini

b'diff --git a/tox.ini b/tox.ini\nindex 4e18961..0767ab6 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -47,4 +47,4 @@ deps =\n commands =\n     zope-testrunner --test-path={toxinidir} -s plone.app.z3cform\n extras =\n-    test\n+    tests\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:11:24+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/741d41417ac82e84f5bea84d282b8b171344791d

feat: declare dependencies

Files changed:
M setup.py

b'diff --git a/setup.py b/setup.py\nindex 419eb94..6311dd5 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -53,27 +53,42 @@ def read(*rnames):\n     zip_safe=False,\n     python_requires=">=3.8",\n     install_requires=[\n+        "lxml",\n+        "plone.app.contentlisting",\n+        "plone.app.vocabularies",\n         "plone.app.textfield>=1.3.6",\n         "plone.app.widgets>=2.4.2",\n         "plone.base",\n+        "plone.dexterity",\n+        "plone.i18n",\n+        "plone.namedfile",\n         "plone.protect",\n+        "plone.registry",\n+        "plone.uuid",\n+        "plone.z3cform",\n+        "Products.GenericSetup",\n+        "pytz",\n         "setuptools",\n         "z3c.form >= 4.0",\n-        "z3c.formwidget.query",\n-        "zope.deprecation",\n+        "z3c.relationfield",\n+        "zope.browserpage",\n+        "zope.contentprovider",\n         "zope.globalrequest",\n+        "zope.pagetemplate",\n         "Zope",\n     ],\n     extras_require={\n         "tests": [\n-            "mock",\n-            "plone.app.robotframework",\n+            "plone.app.contenttypes[test]",\n+            "plone.app.layout",\n             "plone.app.testing",\n+            "plone.autoform",\n             "plone.browserlayer",\n+            "plone.supermodel",\n             "plone.testing",\n-            "zope.contentprovider",\n+            "zope.annotation",\n+            "zope.intid",\n             "zope.publisher",\n-            "zope.testing",\n         ]\n     },\n )\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-17T16:18:17+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/a3cdc613459838c3e14b00fca6f0edc9ec4800ab

fix: adapt tests to zptlint

Files changed:
M plone/app/z3cform/tests/test_widgets.py

b'diff --git a/plone/app/z3cform/tests/test_widgets.py b/plone/app/z3cform/tests/test_widgets.py\nindex e14cc56..dea2597 100644\n--- a/plone/app/z3cform/tests/test_widgets.py\n+++ b/plone/app/z3cform/tests/test_widgets.py\n@@ -1371,7 +1371,7 @@ def test_related_items_widget_display_template(self):\n         self.assertTrue(template.filename.endswith("relateditems_display.pt"))\n         html = template(single)\n         self.assertIn(\n-            \'<span class="contenttype-relationstype state-missing-value url">A Target</span>\',\n+            \'<span class="contenttype-relationstype state-missing-value url" >A Target</span>\',\n             html,\n         )\n \n@@ -1391,11 +1391,11 @@ def test_related_items_widget_display_template(self):\n         self.assertTrue(template.filename.endswith("relateditems_display.pt"))\n         html = template(multiple)\n         self.assertIn(\n-            \'<span class="contenttype-relationstype state-missing-value url">A Target</span>\',\n+            \'<span class="contenttype-relationstype state-missing-value url" >A Target</span>\',\n             html,\n         )\n         self.assertIn(\n-            \'<span class="contenttype-document state-missing-value url">A Document</span>\',\n+            \'<span class="contenttype-document state-missing-value url" >A Document</span>\',\n             html,\n         )\n \n@@ -1963,6 +1963,6 @@ class TestForm(AutoExtensibleForm, EditForm):\n \n         render = TestForm(self.layer["portal"], self.layer["request"])\n         self.assertIn(\n-            \'empty foo" data-fieldname="form.widgets.my_date"\',\n+            \'empty foo" id="formfield-form-widgets-my_date" data-fieldname="form.widgets.my_date"\',\n             render(),\n         )\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-22T00:45:55+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.z3cform/commit/bbca02271808d4528576af58156d21543e148954

Fixed templates with not working multiple/disabled/readonly.

Fix a few test failures due to empty html attributes.

Files changed:
M plone/app/z3cform/templates/checkbox_input.pt
M plone/app/z3cform/templates/orderedselect_input.pt
M plone/app/z3cform/templates/password_input.pt
M plone/app/z3cform/templates/radio_input_single.pt
M plone/app/z3cform/templates/select_input.pt
M plone/app/z3cform/templates/singlecheckboxbool_input.pt
M plone/app/z3cform/templates/text_input.pt
M plone/app/z3cform/templates/textarea_input.pt
M plone/app/z3cform/templates/textlines_input.pt

b'diff --git a/plone/app/z3cform/templates/checkbox_input.pt b/plone/app/z3cform/templates/checkbox_input.pt\nindex 81585fe..e3dd73b 100644\n--- a/plone/app/z3cform/templates/checkbox_input.pt\n+++ b/plone/app/z3cform/templates/checkbox_input.pt\n@@ -24,9 +24,7 @@\n              accesskey=""\n              alt=""\n              checked="checked"\n-             disabled\n              name=""\n-             readonly\n              tabindex=""\n              title=""\n              type="checkbox"\n@@ -64,9 +62,7 @@\n              id=""\n              accesskey=""\n              alt=""\n-             disabled\n              name=""\n-             readonly\n              tabindex=""\n              title=""\n              type="checkbox"\ndiff --git a/plone/app/z3cform/templates/orderedselect_input.pt b/plone/app/z3cform/templates/orderedselect_input.pt\nindex 99a1119..3e8b7b0 100644\n--- a/plone/app/z3cform/templates/orderedselect_input.pt\n+++ b/plone/app/z3cform/templates/orderedselect_input.pt\n@@ -17,7 +17,6 @@\n       <td>\n         <select class=""\n                 id="from"\n-                multiple\n                 name="from"\n                 size="5"\n                 tal:attributes="\n@@ -79,7 +78,6 @@\n       <td>\n         <select class=""\n                 id="to"\n-                multiple\n                 name="to"\n                 size="5"\n                 tal:attributes="\ndiff --git a/plone/app/z3cform/templates/password_input.pt b/plone/app/z3cform/templates/password_input.pt\nindex fe4a6d5..041533c 100644\n--- a/plone/app/z3cform/templates/password_input.pt\n+++ b/plone/app/z3cform/templates/password_input.pt\n@@ -6,11 +6,9 @@\n          id=""\n          accesskey=""\n          alt=""\n-         disabled\n          lang=""\n          maxlength=""\n          name=""\n-         readonly\n          size=""\n          tabindex=""\n          title=""\ndiff --git a/plone/app/z3cform/templates/radio_input_single.pt b/plone/app/z3cform/templates/radio_input_single.pt\nindex bb62141..077aecc 100644\n--- a/plone/app/z3cform/templates/radio_input_single.pt\n+++ b/plone/app/z3cform/templates/radio_input_single.pt\n@@ -9,10 +9,7 @@\n          id=""\n          accesskey=""\n          alt=""\n-         checked\n-         disabled\n          name=""\n-         readonly\n          tabindex=""\n          title=""\n          type="radio"\ndiff --git a/plone/app/z3cform/templates/select_input.pt b/plone/app/z3cform/templates/select_input.pt\nindex 2bc6953..e571693 100644\n--- a/plone/app/z3cform/templates/select_input.pt\n+++ b/plone/app/z3cform/templates/select_input.pt\n@@ -4,8 +4,6 @@\n >\n   <select class=""\n           id=""\n-          disabled\n-          multiple\n           name=""\n           size=""\n           tabindex=""\ndiff --git a/plone/app/z3cform/templates/singlecheckboxbool_input.pt b/plone/app/z3cform/templates/singlecheckboxbool_input.pt\nindex 3f4f192..7f4bfcc 100644\n--- a/plone/app/z3cform/templates/singlecheckboxbool_input.pt\n+++ b/plone/app/z3cform/templates/singlecheckboxbool_input.pt\n@@ -24,9 +24,7 @@\n              accesskey=""\n              alt=""\n              checked="checked"\n-             disabled\n              name=""\n-             readonly\n              tabindex=""\n              title=""\n              type="checkbox"\n@@ -65,9 +63,7 @@\n              id=""\n              accesskey=""\n              alt=""\n-             disabled\n              name=""\n-             readonly\n              tabindex=""\n              title=""\n              type="checkbox"\ndiff --git a/plone/app/z3cform/templates/text_input.pt b/plone/app/z3cform/templates/text_input.pt\nindex a44ad19..0c53bbd 100644\n--- a/plone/app/z3cform/templates/text_input.pt\n+++ b/plone/app/z3cform/templates/text_input.pt\n@@ -6,11 +6,9 @@\n          id=""\n          accesskey=""\n          alt=""\n-         disabled\n          lang=""\n          maxlength=""\n          name=""\n-         readonly\n          size=""\n          style=""\n          tabindex=""\ndiff --git a/plone/app/z3cform/templates/textarea_input.pt b/plone/app/z3cform/templates/textarea_input.pt\nindex 12aa646..51867b7 100644\n--- a/plone/app/z3cform/templates/textarea_input.pt\n+++ b/plone/app/z3cform/templates/textarea_input.pt\n@@ -6,9 +6,7 @@\n             id=""\n             accesskey=""\n             cols=""\n-            disabled\n             name=""\n-            readonly\n             rows=""\n             tabindex=""\n             tal:content="view/value"\ndiff --git a/plone/app/z3cform/templates/textlines_input.pt b/plone/app/z3cform/templates/textlines_input.pt\nindex 6f51167..5778baa 100644\n--- a/plone/app/z3cform/templates/textlines_input.pt\n+++ b/plone/app/z3cform/templates/textlines_input.pt\n@@ -6,9 +6,7 @@\n             id=""\n             accesskey=""\n             cols=""\n-            disabled\n             name=""\n-            readonly\n             rows=""\n             tabindex=""\n             tal:content="structure view/value"\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-22T13:08:11+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.z3cform/commit/3bddf0cf853b84bd48c06b93c260bab798117e71

Fix tox: use constrain_package_deps=true.

Available since tox 4.4.0.
See https://github.com/plone/plone.app.z3cform/pull/162#issuecomment-1479461619

Files changed:
M tox.ini

b'diff --git a/tox.ini b/tox.ini\nindex 0767ab6..43e9ac4 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -1,6 +1,8 @@\n # Generated from:\n # https://github.com/plone/meta/tree/master/config/default\n [tox]\n+# We need 4.4.0 for constrain_package_deps.\n+min_version = 4.4.0\n envlist =\n     format\n     lint\n@@ -41,6 +43,7 @@ commands =\n \n [testenv:test]\n usedevelop = true\n+constrain_package_deps = true\n deps =\n     zope.testrunner\n     -c https://dist.plone.org/release/6.0-dev/constraints.txt\n'

Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2023-03-22T14:35:06+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.z3cform/commit/c25c803b3ff0c9beafc88b4f47db3f3dee1b9eff

Merge pull request #162 from plone/config-with-default-template-b58883d3

Config with default template

Files changed:
A .editorconfig
A .meta.toml
A .pre-commit-config.yaml
A news/243ca9ec.internal
A tox.ini
M CHANGES.rst
M plone/app/z3cform/configure.zcml
M plone/app/z3cform/converters.py
M plone/app/z3cform/interfaces.py
M plone/app/z3cform/overrides.zcml
M plone/app/z3cform/profiles.zcml
M plone/app/z3cform/profiles/default/browserlayer.xml
M plone/app/z3cform/profiles/default/metadata.xml
M plone/app/z3cform/templates/ajaxselect_display.pt
M plone/app/z3cform/templates/checkbox_input.pt
M plone/app/z3cform/templates/contentprovider-widget.pt
M plone/app/z3cform/templates/error.pt
M plone/app/z3cform/templates/file_input.pt
M plone/app/z3cform/templates/form.pt
M plone/app/z3cform/templates/image_input.pt
M plone/app/z3cform/templates/layout.pt
M plone/app/z3cform/templates/link_input.pt
M plone/app/z3cform/templates/macros.pt
M plone/app/z3cform/templates/multi_input.pt
M plone/app/z3cform/templates/object_input.pt
M plone/app/z3cform/templates/orderedselect_input.pt
M plone/app/z3cform/templates/password_input.pt
M plone/app/z3cform/templates/radio_input.pt
M plone/app/z3cform/templates/radio_input_single.pt
M plone/app/z3cform/templates/relateditems_display.pt
M plone/app/z3cform/templates/select_input.pt
M plone/app/z3cform/templates/singlecheckbox.pt
M plone/app/z3cform/templates/singlecheckboxbool_display.pt
M plone/app/z3cform/templates/singlecheckboxbool_hidden.pt
M plone/app/z3cform/templates/singlecheckboxbool_input.pt
M plone/app/z3cform/templates/submit_input.pt
M plone/app/z3cform/templates/text_input.pt
M plone/app/z3cform/templates/textarea_input.pt
M plone/app/z3cform/templates/textfield_widget_input.pt
M plone/app/z3cform/templates/textlines_input.pt
M plone/app/z3cform/templates/widget.pt
M plone/app/z3cform/tests/test_utils.py
M plone/app/z3cform/tests/test_widget.py
M plone/app/z3cform/tests/test_widgets.py
M plone/app/z3cform/tests/testing.zcml
M plone/app/z3cform/utils.py
M plone/app/z3cform/widget.py
M plone/app/z3cform/widget.zcml
M plone/app/z3cform/wysiwyg/configure.zcml
M plone/app/z3cform/wysiwyg/widget.py
M plone/app/z3cform/wysiwyg/wysiwyg_display.pt
M plone/app/z3cform/wysiwyg/wysiwyg_input.pt
M pyproject.toml
M setup.cfg
M setup.py
D .isort.cfg

b'diff --git a/.editorconfig b/.editorconfig\nnew file mode 100644\nindex 00000000..b4158b89\n--- /dev/null\n+++ b/.editorconfig\n@@ -0,0 +1,39 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+#\n+# EditorConfig Configuration file, for more details see:\n+# http://EditorConfig.org\n+# EditorConfig is a convention description, that could be interpreted\n+# by multiple editors to enforce common coding conventions for specific\n+# file types\n+\n+# top-most EditorConfig file:\n+# Will ignore other EditorConfig files in Home directory or upper tree level.\n+root = true\n+\n+\n+[*]  # For All Files\n+# Unix-style newlines with a newline ending every file\n+end_of_line = lf\n+insert_final_newline = true\n+trim_trailing_whitespace = true\n+# Set default charset\n+charset = utf-8\n+# Indent style default\n+indent_style = space\n+# Max Line Length - a hard line wrap, should be disabled\n+max_line_length = off\n+\n+[*.{py,cfg,ini}]\n+# 4 space indentation\n+indent_size = 4\n+\n+[*.{yml,zpt,pt,dtml,zcml}]\n+# 2 space indentation\n+indent_size = 2\n+\n+[{Makefile,.gitmodules}]\n+# Tab indentation (no size specified, but view as 4 spaces)\n+indent_style = tab\n+indent_size = unset\n+tab_width = unset\ndiff --git a/.isort.cfg b/.isort.cfg\ndeleted file mode 100644\nindex dd9f25db..00000000\n--- a/.isort.cfg\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-[settings]\n-force_alphabetical_sort = True\n-force_single_line = True\n-lines_after_imports = 2\n-line_length = 200\n-not_skip = __init__.py\ndiff --git a/.meta.toml b/.meta.toml\nnew file mode 100644\nindex 00000000..4ed1a1df\n--- /dev/null\n+++ b/.meta.toml\n@@ -0,0 +1,5 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+[meta]\n+template = "default"\n+commit-id = "789b0936"\ndiff --git a/.pre-commit-config.yaml b/.pre-commit-config.yaml\nnew file mode 100644\nindex 00000000..582f8acd\n--- /dev/null\n+++ b/.pre-commit-config.yaml\n@@ -0,0 +1,42 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+ci:\n+    autofix_prs: false\n+    autoupdate_schedule: monthly\n+\n+repos:\n+-   repo: https://github.com/asottile/pyupgrade\n+    rev: v3.3.1\n+    hooks:\n+    -   id: pyupgrade\n+        args: [--py38-plus]\n+-   repo: https://github.com/pycqa/isort\n+    rev: 5.12.0\n+    hooks:\n+    -   id: isort\n+-   repo: https://github.com/psf/black\n+    rev: 23.1.0\n+    hooks:\n+    -   id: black\n+-   repo: https://github.com/collective/zpretty\n+    rev: 3.0.2\n+    hooks:\n+    -   id: zpretty\n+-   repo: https://github.com/PyCQA/flake8\n+    rev: 6.0.0\n+    hooks:\n+    -   id: flake8\n+-   repo: https://github.com/codespell-project/codespell\n+    rev: v2.2.2\n+    hooks:\n+    -   id: codespell\n+        additional_dependencies:\n+          - tomli\n+-   repo: https://github.com/mgedmin/check-manifest\n+    rev: "0.49"\n+    hooks:\n+    -   id: check-manifest\n+-   repo: https://github.com/regebro/pyroma\n+    rev: "4.2"\n+    hooks:\n+    -   id: pyroma\ndiff --git a/CHANGES.rst b/CHANGES.rst\nindex 91944116..5a0a14f1 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -128,7 +128,7 @@ Bug fixes:\n Bug fixes:\n \n \n-- Remove errorneous extra curly bracket in class name of the widget wrapper.\n+- Remove erroneous extra curly bracket in class name of the widget wrapper.\n   [thet] (#136)\n \n \n@@ -399,7 +399,7 @@ Bug fixes:\n - Fixes #64: SingleCheckBoxFieldWidget does not render value in view mode.\n   In order to fix this issue the hacky view was removed.\n   It is replaced by a new widget to render a single checkbox with bool values.\n-  An appropiate data converter was added as well.\n+  An appropriate data converter was added as well.\n   [jensens]\n \n \n@@ -422,7 +422,7 @@ New features:\n \n Bug fixes:\n \n-- Catch TypeError occuring on conflicting subrequests in inline validation\n+- Catch TypeError occurring on conflicting subrequests in inline validation\n   [tomgross]\n \n - Clean up: code-style, zca-decorators, replace lambda.\n@@ -501,7 +501,7 @@ New features:\n   whichever is specified by field.\n   [seanupton]\n \n-- Support functions as values in the ``pattern_options`` dictionary, whch gets then serialized to JSON.\n+- Support functions as values in the ``pattern_options`` dictionary, which gets then serialized to JSON.\n   Before that, walk recursively through ``pattern_options`` and call all functions with the widgets context.\n   This allows for context-specific, runtime evaluated pattern option values.\n   [thet]\ndiff --git a/news/243ca9ec.internal b/news/243ca9ec.internal\nnew file mode 100644\nindex 00000000..c08f5399\n--- /dev/null\n+++ b/news/243ca9ec.internal\n@@ -0,0 +1,2 @@\n+Update configuration files.\n+[plone devs]\ndiff --git a/plone/app/z3cform/configure.zcml b/plone/app/z3cform/configure.zcml\nindex 9c6e64c3..9bd4ec02 100644\n--- a/plone/app/z3cform/configure.zcml\n+++ b/plone/app/z3cform/configure.zcml\n@@ -2,9 +2,10 @@\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:browser="http://namespaces.zope.org/browser"\n     xmlns:i18n="http://namespaces.zope.org/i18n"\n-    xmlns:zcml="http://namespaces.zope.org/zcml"\n     xmlns:z3c="http://namespaces.zope.org/z3c"\n-    i18n_domain="plone">\n+    xmlns:zcml="http://namespaces.zope.org/zcml"\n+    i18n_domain="plone"\n+    >\n \n   <include package="plone.z3cform" />\n   <include package="plone.app.widgets" />\n@@ -19,25 +20,25 @@\n   <browser:page\n       name="ploneform-macros"\n       for="*"\n-      layer=".interfaces.IPloneFormLayer"\n       class=".views.Macros"\n-      template="templates/macros.pt"\n       allowed_interface="zope.interface.common.mapping.IItemMapping"\n+      template="templates/macros.pt"\n       permission="zope.Public"\n+      layer=".interfaces.IPloneFormLayer"\n       />\n   <browser:page\n       name="ploneform-render-widget"\n       for="z3c.form.interfaces.IWidget"\n-      layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n       class=".views.RenderWidget"\n       permission="zope.Public"\n+      layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n       />\n   <browser:page\n       name="ploneform-render-widget"\n       for="zope.contentprovider.interfaces.IContentProvider"\n-      layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n       class=".views.RenderContentProvider"\n       permission="zope.Public"\n+      layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n       />\n \n   <adapter factory=".views.layout_factory" />\n@@ -53,22 +54,22 @@\n   <!-- dexterity add/edit overrides -->\n   <include package="plone.dexterity" />\n   <adapter\n+      factory=".views.AddView"\n+      provides="zope.publisher.interfaces.browser.IBrowserPage"\n       for="Products.CMFCore.interfaces.IFolderish\n            plone.app.z3cform.interfaces.IPloneFormLayer\n            plone.dexterity.interfaces.IDexterityFTI"\n-      provides="zope.publisher.interfaces.browser.IBrowserPage"\n-      factory=".views.AddView"\n       />\n   <class class=".views.AddView">\n-      <require\n-          permission="cmf.AddPortalContent"\n-          interface="zope.publisher.interfaces.browser.IBrowserPage"\n-          />\n+    <require\n+        permission="cmf.AddPortalContent"\n+        interface="zope.publisher.interfaces.browser.IBrowserPage"\n+        />\n   </class>\n \n   <browser:page\n-      for="plone.dexterity.interfaces.IDexterityContent"\n       name="edit"\n+      for="plone.dexterity.interfaces.IDexterityContent"\n       class=".views.EditView"\n       permission="cmf.ModifyPortalContent"\n       layer="plone.app.z3cform.interfaces.IPloneFormLayer"\n@@ -86,12 +87,18 @@\n   <adapter factory=".converters.AjaxSelectWidgetConverter" />\n   <adapter factory=".converters.QueryStringDataConverter" />\n   <adapter factory=".converters.RelationChoiceRelatedItemsWidgetConverter" />\n-  <adapter factory=".converters.RelationChoiceRelatedItemsWidgetConverter"\n-           for="z3c.relationfield.interfaces.IRelationChoice .interfaces.ITextWidget" />\n+  <adapter\n+      factory=".converters.RelationChoiceRelatedItemsWidgetConverter"\n+      for="z3c.relationfield.interfaces.IRelationChoice\n+           .interfaces.ITextWidget"\n+      />\n   <adapter factory=".converters.RelationChoiceSelectWidgetConverter" />\n   <adapter factory=".converters.RelatedItemsDataConverter" />\n-  <adapter factory=".converters.RelatedItemsDataConverter"\n-           for="z3c.relationfield.interfaces.IRelationList .interfaces.ITextWidget" />\n+  <adapter\n+      factory=".converters.RelatedItemsDataConverter"\n+      for="z3c.relationfield.interfaces.IRelationList\n+           .interfaces.ITextWidget"\n+      />\n   <adapter factory=".converters.RelationListSelectWidgetDataConverter" />\n   <adapter factory=".converters.LinkWidgetDataConverter" />\n \n@@ -101,20 +108,21 @@\n   <!-- error snippet -->\n   <adapter\n       factory=".views.ErrorViewTemplate"\n-      for="z3c.form.interfaces.IErrorViewSnippet .interfaces.IPloneFormLayer"\n       provides="zope.pagetemplate.interfaces.IPageTemplate"\n+      for="z3c.form.interfaces.IErrorViewSnippet\n+           .interfaces.IPloneFormLayer"\n       />\n \n   <utility\n-      name="ZPublisher.HTTPRequest.FileUpload"\n-      provides="plone.namedfile.interfaces.IStorage"\n       factory=".factories.Zope2FileUploadStorable"\n+      provides="plone.namedfile.interfaces.IStorage"\n+      name="ZPublisher.HTTPRequest.FileUpload"\n       />\n \n   <utility\n-       component=".widget.tinymce_richtextwidget_render"\n-       provides=".interfaces.IRichTextWidgetInputModeRenderer"\n-       name="tinymce"\n-       />\n+      provides=".interfaces.IRichTextWidgetInputModeRenderer"\n+      name="tinymce"\n+      component=".widget.tinymce_richtextwidget_render"\n+      />\n \n </configure>\ndiff --git a/plone/app/z3cform/converters.py b/plone/app/z3cform/converters.py\nindex cf3dabe6..9f1d2b37 100644\n--- a/plone/app/z3cform/converters.py\n+++ b/plone/app/z3cform/converters.py\n@@ -11,9 +11,9 @@\n from plone.app.z3cform.interfaces import ISelectWidget\n from plone.app.z3cform.interfaces import ISingleCheckBoxBoolWidget\n from plone.app.z3cform.interfaces import ITimeWidget\n+from plone.base.utils import safe_callable\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n-from plone.base.utils import safe_callable\n from z3c.form.converter import BaseDataConverter\n from z3c.form.converter import CollectionSequenceDataConverter\n from z3c.form.converter import SequenceDataConverter\n@@ -126,6 +126,7 @@ def toFieldValue(self, value):\n             ret = tzinfo.localize(ret)\n         return ret\n \n+\n @adapter(IDatetime, IDateWidget)\n class DateWidgetToDatetimeConverter(BaseDataConverter):\n     """Data converter for date widget on datetime fields."""\n@@ -180,6 +181,7 @@ def toFieldValue(self, value):\n             ret = tzinfo.localize(ret)\n         return ret\n \n+\n @adapter(ITime, ITimeWidget)\n class TimeWidgetConverter(BaseDataConverter):\n     """Data converter for datetime fields."""\n@@ -491,7 +493,7 @@ def toWidgetValue(self, value):\n             is_same_domain = utils.is_same_domain(value, portal.absolute_url())\n             is_absolute = utils.is_absolute(value)\n             if "/resolveuid/" in value and (not is_absolute or is_same_domain):\n-                # Take the UUID part of a resolveuid url, but onl if it\'s on\n+                # Take the UUID part of a resolveuid url, but only if it\'s on\n                 # the same domain.\n                 uuid = value.rsplit("/", 1)[-1]\n             elif not is_absolute or is_absolute and is_same_domain:\n@@ -500,7 +502,7 @@ def toWidgetValue(self, value):\n                 if parsed.params or parsed.query or parsed.fragment:\n                     # we don\'t want to loose query parameters\n                     # so we don\'t convert URLs pointing to internal\n-                    # objects with params, querys or fragments\n+                    # objects with params, queries or fragments\n                     # to uids\n                     pass\n                 else:\ndiff --git a/plone/app/z3cform/interfaces.py b/plone/app/z3cform/interfaces.py\nindex 6ffce277..1db3ad36 100644\n--- a/plone/app/z3cform/interfaces.py\n+++ b/plone/app/z3cform/interfaces.py\n@@ -1,6 +1,4 @@\n-from plone.app.textfield.widget import (\n-    IRichTextWidget as patextfield_IRichTextWidget,\n-)  # noqa\n+from plone.app.textfield.widget import IRichTextWidget as patextfield_IRichTextWidget\n from z3c.form.interfaces import IFormLayer\n from z3c.form.interfaces import IRadioWidget\n from z3c.form.interfaces import ISelectWidget as IBaseSelectWidget\n@@ -9,7 +7,6 @@\n from zope.interface import Interface\n from zope.schema.interfaces import IDate\n from zope.schema.interfaces import IDatetime\n-from zope.schema.interfaces import ITime\n \n \n class IPloneFormLayer(IFormLayer):\ndiff --git a/plone/app/z3cform/overrides.zcml b/plone/app/z3cform/overrides.zcml\nindex ab5befb9..198e8b01 100644\n--- a/plone/app/z3cform/overrides.zcml\n+++ b/plone/app/z3cform/overrides.zcml\n@@ -1,3 +1,6 @@\n <configure xmlns="http://namespaces.zope.org/zope">\n-  <includeOverrides package="plone.z3cform" file="overrides.zcml" />\n+  <includeOverrides\n+      package="plone.z3cform"\n+      file="overrides.zcml"\n+      />\n </configure>\ndiff --git a/plone/app/z3cform/profiles.zcml b/plone/app/z3cform/profiles.zcml\nindex b74de448..89613155 100644\n--- a/plone/app/z3cform/profiles.zcml\n+++ b/plone/app/z3cform/profiles.zcml\n@@ -1,17 +1,19 @@\n-<configure xmlns="http://namespaces.zope.org/zope"\n-           xmlns:browser="http://namespaces.zope.org/browser"\n-           xmlns:five="http://namespaces.zope.org/five"\n-           xmlns:genericsetup="http://namespaces.zope.org/genericsetup"\n-           xmlns:plone="http://namespaces.plone.org/plone"\n-           i18n_domain="plone">\n+<configure\n+    xmlns="http://namespaces.zope.org/zope"\n+    xmlns:browser="http://namespaces.zope.org/browser"\n+    xmlns:five="http://namespaces.zope.org/five"\n+    xmlns:genericsetup="http://namespaces.zope.org/genericsetup"\n+    xmlns:plone="http://namespaces.plone.org/plone"\n+    i18n_domain="plone"\n+    >\n \n   <genericsetup:registerProfile\n       name="default"\n       title="Plone z3c.form support"\n       description="Adds support for rendering z3c.form forms in Plone"\n-      directory="profiles/default"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       for="plone.base.interfaces.IPloneSiteRoot"\n+      directory="profiles/default"\n       />\n \n </configure>\ndiff --git a/plone/app/z3cform/profiles/default/browserlayer.xml b/plone/app/z3cform/profiles/default/browserlayer.xml\nindex 7047ada0..e63a3c7e 100644\n--- a/plone/app/z3cform/profiles/default/browserlayer.xml\n+++ b/plone/app/z3cform/profiles/default/browserlayer.xml\n@@ -1,3 +1,6 @@\n+<?xml version="1.0" encoding="utf-8"?>\n <layers>\n-    <layer name="plone.app.z3cform" interface="plone.app.z3cform.interfaces.IPloneFormLayer" />\n+  <layer interface="plone.app.z3cform.interfaces.IPloneFormLayer"\n+         name="plone.app.z3cform"\n+  />\n </layers>\ndiff --git a/plone/app/z3cform/profiles/default/metadata.xml b/plone/app/z3cform/profiles/default/metadata.xml\nindex a44cc349..dbfd3b42 100644\n--- a/plone/app/z3cform/profiles/default/metadata.xml\n+++ b/plone/app/z3cform/profiles/default/metadata.xml\n@@ -1,4 +1,4 @@\n-<?xml version="1.0"?>\n+<?xml version="1.0" encoding="utf-8"?>\n <metadata>\n   <version>3</version>\n </metadata>\ndiff --git a/plone/app/z3cform/templates/ajaxselect_display.pt b/plone/app/z3cform/templates/ajaxselect_display.pt\nindex c634dede..c9252807 100644\n--- a/plone/app/z3cform/templates/ajaxselect_display.pt\n+++ b/plone/app/z3cform/templates/ajaxselect_display.pt\n@@ -1,26 +1,31 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-    <span id="" class=""\n-          tal:attributes="id view/id;\n-                          class view/klass;\n-                          style view/style;\n-                          title view/title;\n-                          lang view/lang;\n-                          onclick view/onclick;\n-                          ondblclick view/ondblclick;\n-                          onmousedown view/onmousedown;\n-                          onmouseup view/onmouseup;\n-                          onmouseover view/onmouseover;\n-                          onmousemove view/onmousemove;\n-                          onmouseout view/onmouseout;\n-                          onkeypress view/onkeypress;\n-                          onkeydown view/onkeydown;\n-                          onkeyup view/onkeyup"><tal:block\n-          condition="view/value"\n-    />\n-      <tal:loop tal:repeat="item python:view.display_items()">\n-        <span data-token="${python:item[\'token\']}">${python:item[\'title\']}</span><tal:if tal:condition="python: not repeat.item.end" tal:replace="python:view.separator" />\n-      </tal:loop>\n-    </span>\n+      tal:omit-tag=""\n+>\n+  <span class=""\n+        id=""\n+        tal:attributes="\n+          id view/id;\n+          class view/klass;\n+          style view/style;\n+          title view/title;\n+          lang view/lang;\n+          onclick view/onclick;\n+          ondblclick view/ondblclick;\n+          onmousedown view/onmousedown;\n+          onmouseup view/onmouseup;\n+          onmouseover view/onmouseover;\n+          onmousemove view/onmousemove;\n+          onmouseout view/onmouseout;\n+          onkeypress view/onkeypress;\n+          onkeydown view/onkeydown;\n+          onkeyup view/onkeyup;\n+        "\n+  ><tal:block condition="view/value" />\n+    <tal:loop tal:repeat="item python:view.display_items()">\n+      <span data-token="${python:item[\'token\']}">${python:item[\'title\']}</span><tal:if tal:condition="python: not repeat.item.end"\n+              tal:replace="python:view.separator"\n+      />\n+    </tal:loop>\n+  </span>\n </html>\ndiff --git a/plone/app/z3cform/templates/checkbox_input.pt b/plone/app/z3cform/templates/checkbox_input.pt\nindex 56efa26f..e3dd73b1 100644\n--- a/plone/app/z3cform/templates/checkbox_input.pt\n+++ b/plone/app/z3cform/templates/checkbox_input.pt\n@@ -1,81 +1,119 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     tal:omit-tag=""\n-     tal:define="items view/items;\n-                 items python:list(items);\n-                 single_checkbox python:len(items) == 1">\n-<div tal:attributes="id view/id"\n-     tal:omit-tag="single_checkbox"\n-     tal:condition="python:len(items) > 0">\n- <div class="form-check"\n-       tal:repeat="item items"\n-       tal:attributes="id python:single_checkbox and view.id or None">\n-  <input type="checkbox" id="" name="" class="" alt="" title=""\n-         tabindex="" disabled="" readonly="" accesskey="" value=""\n-         checked="checked"\n-         tal:condition="item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect"\n-  /><input id="" name="" class="" alt="" title="" tabindex=""\n-           disabled="" readonly="" accesskey="" value=""\n-           type="checkbox"\n-         tal:condition="not:item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect" />\n-  <label class="form-check-label" for=""\n-         tal:attributes="for item/id">\n-    <span class="label" tal:content="item/label">Label</span>\n-  </label>\n- </div>\n-</div>\n-<input name="field-empty-marker" type="hidden" value="1"\n-       tal:attributes="name string:${view/name}-empty-marker" />\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      tal:define="\n+        items view/items;\n+        items python:list(items);\n+        single_checkbox python:len(items) == 1;\n+      "\n+      tal:omit-tag=""\n+>\n+  <div tal:condition="python:len(items) &gt; 0"\n+       tal:omit-tag="single_checkbox"\n+       tal:attributes="\n+         id view/id;\n+       "\n+  >\n+    <div class="form-check"\n+         tal:repeat="item items"\n+         tal:attributes="\n+           id python:single_checkbox and view.id or None;\n+         "\n+    >\n+      <input class=""\n+             id=""\n+             accesskey=""\n+             alt=""\n+             checked="checked"\n+             name=""\n+             tabindex=""\n+             title=""\n+             type="checkbox"\n+             value=""\n+             tal:condition="item/checked"\n+             tal:attributes="\n+               id item/id;\n+               name item/name;\n+               class string:form-check-input ${view/klass};\n+               value item/value;\n+               style view/style;\n+               title view/title;\n+               lang view/lang;\n+               onclick view/onclick;\n+               ondblclick view/ondblclick;\n+               onmousedown view/onmousedown;\n+               onmouseup view/onmouseup;\n+               onmouseover view/onmouseover;\n+               onmousemove view/onmousemove;\n+               onmouseout view/onmouseout;\n+               onkeypress view/onkeypress;\n+               onkeydown view/onkeydown;\n+               onkeyup view/onkeyup;\n+               disabled view/disabled;\n+               tabindex view/tabindex;\n+               onfocus view/onfocus;\n+               onblur view/onblur;\n+               onchange view/onchange;\n+               readonly view/readonly;\n+               alt view/alt;\n+               accesskey view/accesskey;\n+               onselect view/onselect;\n+             "\n+      /><input class=""\n+             id=""\n+             accesskey=""\n+             alt=""\n+             name=""\n+             tabindex=""\n+             title=""\n+             type="checkbox"\n+             value=""\n+             tal:condition="not:item/checked"\n+             tal:attributes="\n+               id item/id;\n+               name item/name;\n+               class string:form-check-input ${view/klass};\n+               value item/value;\n+               style view/style;\n+               title view/title;\n+               lang view/lang;\n+               onclick view/onclick;\n+               ondblclick view/ondblclick;\n+               onmousedown view/onmousedown;\n+               onmouseup view/onmouseup;\n+               onmouseover view/onmouseover;\n+               onmousemove view/onmousemove;\n+               onmouseout view/onmouseout;\n+               onkeypress view/onkeypress;\n+               onkeydown view/onkeydown;\n+               onkeyup view/onkeyup;\n+               disabled view/disabled;\n+               tabindex view/tabindex;\n+               onfocus view/onfocus;\n+               onblur view/onblur;\n+               onchange view/onchange;\n+               readonly view/readonly;\n+               alt view/alt;\n+               accesskey view/accesskey;\n+               onselect view/onselect;\n+             "\n+      />\n+      <label class="form-check-label"\n+             for=""\n+             tal:attributes="\n+               for item/id;\n+             "\n+      >\n+        <span class="label"\n+              tal:content="item/label"\n+        >Label</span>\n+      </label>\n+    </div>\n+  </div>\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/contentprovider-widget.pt b/plone/app/z3cform/templates/contentprovider-widget.pt\nindex c1143343..537d8d11 100644\n--- a/plone/app/z3cform/templates/contentprovider-widget.pt\n+++ b/plone/app/z3cform/templates/contentprovider-widget.pt\n@@ -1,2 +1,5 @@\n-<tal:provider define="contentprovider context"\n-              replace="structure contentprovider/render" />\n+<tal:provider define="\n+                contentprovider context;\n+              "\n+              replace="structure contentprovider/render"\n+/>\ndiff --git a/plone/app/z3cform/templates/error.pt b/plone/app/z3cform/templates/error.pt\nindex c49d8bec..6e20ea7c 100644\n--- a/plone/app/z3cform/templates/error.pt\n+++ b/plone/app/z3cform/templates/error.pt\n@@ -1,5 +1,8 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-  <div class="invalid-feedback" tal:content="view/message">Error</div>\n+      tal:omit-tag=""\n+>\n+  <div class="invalid-feedback"\n+       tal:content="view/message"\n+  >Error</div>\n </html>\ndiff --git a/plone/app/z3cform/templates/file_input.pt b/plone/app/z3cform/templates/file_input.pt\nindex f2647c4b..58c57443 100644\n--- a/plone/app/z3cform/templates/file_input.pt\n+++ b/plone/app/z3cform/templates/file_input.pt\n@@ -1,112 +1,157 @@\n-<div\n-    i18n:domain="plone"\n-    tal:attributes="id view/id;\n-                    style view/style;\n-                    title view/title;\n-                    lang view/lang;\n-                    onclick view/onclick;\n-                    ondblclick view/ondblclick;\n-                    onmousedown view/onmousedown;\n-                    onmouseup view/onmouseup;\n-                    onmouseover view/onmouseover;\n-                    onmousemove view/onmousemove;\n-                    onmouseout view/onmouseout;\n-                    onkeypress view/onkeypress;\n-                    onkeydown view/onkeydown;\n-                    onkeyup view/onkeyup;\n-                    onfocus view/onfocus;\n-                    onblur view/onblur;\n-                    onchange view/onchange;\n-                    readonly view/readonly;\n-                    accesskey view/accesskey;\n-                    onselect view/onselect;"\n-    tal:define="download_url view/download_url;\n-                exists python: view.value is not None;\n-                action view/action;\n-                allow_nochange view/allow_nochange;\n-                doc_type view/file_content_type;\n-                icon view/file_icon;\n-                filename view/filename;">\n-    <tal:if tal:define="up_id view/file_upload_id" tal:condition="up_id">\n-      <input type="hidden" name="${view/name}.file_upload_id" value="${up_id}"/>\n-      <span>\n-        <tal:i18n i18n:translate="file_already_uploaded">File already uploaded:</tal:i18n>\n+<div tal:define="\n+       download_url view/download_url;\n+       exists python: view.value is not None;\n+       action view/action;\n+       allow_nochange view/allow_nochange;\n+       doc_type view/file_content_type;\n+       icon view/file_icon;\n+       filename view/filename;\n+     "\n+     tal:attributes="\n+       id view/id;\n+       style view/style;\n+       title view/title;\n+       lang view/lang;\n+       onclick view/onclick;\n+       ondblclick view/ondblclick;\n+       onmousedown view/onmousedown;\n+       onmouseup view/onmouseup;\n+       onmouseover view/onmouseover;\n+       onmousemove view/onmousemove;\n+       onmouseout view/onmouseout;\n+       onkeypress view/onkeypress;\n+       onkeydown view/onkeydown;\n+       onkeyup view/onkeyup;\n+       onfocus view/onfocus;\n+       onblur view/onblur;\n+       onchange view/onchange;\n+       readonly view/readonly;\n+       accesskey view/accesskey;\n+       onselect view/onselect;\n+     "\n+     i18n:domain="plone"\n+>\n+  <tal:if tal:define="\n+            up_id view/file_upload_id;\n+          "\n+          tal:condition="up_id"\n+  >\n+    <input name="${view/name}.file_upload_id"\n+           type="hidden"\n+           value="${up_id}"\n+    />\n+    <span>\n+      <tal:i18n i18n:translate="file_already_uploaded">File already uploaded:</tal:i18n>\n         ${view/value/filename}\n-      </span>\n-    </tal:if>\n-    <span tal:condition="python:exists and download_url and action==\'nochange\'">\n-        <img tal:condition="icon" src="" alt=""\n-             tal:attributes="src icon;\n-                             alt doc_type;\n-                             title filename;"/>\n-        <a\n-            tal:content="filename"\n-            tal:attributes="href download_url"\n-            >Filename</a>\n-        <span class="discreet"> &mdash;<tal:doc_type condition="doc_type">\n-            <span tal:replace="doc_type"\n-                  i18n:translate="">ContentType</span>,</tal:doc_type>\n-            <span tal:define="sizekb view/file_size" tal:replace="sizekb"\n-                  i18n:translate="">100</span>\n-        </span>\n     </span>\n-    <tal:block condition="allow_nochange">\n-        <div class="form-check">\n-            <input\n-                type="radio"\n-                value="nochange"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-nochange;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n-                                checked python:\'checked\' if action == \'nochange\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-nochange" i18n:translate="file_keep">Keep existing file</label>\n-        </div>\n-        <div class="form-check" tal:condition="not:view/field/required">\n-            <input\n-                type="radio"\n-                value="remove"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-remove;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n-                                checked python:\'checked\' if action == \'remove\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-remove" i18n:translate="file_remove">Remove existing file</label>\n-        </div>\n-        <div class="form-check">\n-            <input\n-                type="radio"\n-                value="replace"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-replace;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=false;\n-                                checked python:\'checked\' if action == \'replace\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-replace" i18n:translate="file_replace">Replace with new file</label>\n-        </div>\n-    </tal:block>\n+  </tal:if>\n+  <span tal:condition="python:exists and download_url and action==\'nochange\'">\n+    <img alt=""\n+         src=""\n+         tal:condition="icon"\n+         tal:attributes="\n+           src icon;\n+           alt doc_type;\n+           title filename;\n+         "\n+    />\n+    <a tal:content="filename"\n+       tal:attributes="\n+         href download_url;\n+       "\n+    >Filename</a>\n+    <span class="discreet">\n+      &mdash;<tal:doc_type condition="doc_type">\n+        <span tal:replace="doc_type"\n+              i18n:translate=""\n+        >ContentType</span>,</tal:doc_type>\n+      <span tal:define="\n+              sizekb view/file_size;\n+            "\n+            tal:replace="sizekb"\n+            i18n:translate=""\n+      >100</span>\n+    </span>\n+  </span>\n+  <tal:block condition="allow_nochange">\n+    <div class="form-check">\n+      <input class="form-check-input"\n+             type="radio"\n+             value="nochange"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-nochange;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n+               checked python:\'checked\' if action == \'nochange\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-nochange;\n+             "\n+             i18n:translate="file_keep"\n+      >Keep existing file</label>\n+    </div>\n+    <div class="form-check"\n+         tal:condition="not:view/field/required"\n+    >\n+      <input class="form-check-input"\n+             type="radio"\n+             value="remove"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-remove;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n+               checked python:\'checked\' if action == \'remove\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-remove;\n+             "\n+             i18n:translate="file_remove"\n+      >Remove existing file</label>\n+    </div>\n+    <div class="form-check">\n+      <input class="form-check-input"\n+             type="radio"\n+             value="replace"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-replace;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=false;\n+               checked python:\'checked\' if action == \'replace\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-replace;\n+             "\n+             i18n:translate="file_replace"\n+      >Replace with new file</label>\n+    </div>\n+  </tal:block>\n \n-    <input\n-        type="file"\n-        class="form-control"\n-        tal:define="is_invalid python:view.error and \'is-invalid\' or \'\'"\n-        tal:attributes="id string:${view/id}-input;\n-                        name view/name;\n-                        required python:view.required and \'required\' or None;\n-                        size view/size;\n-                        disabled view/disabled;\n-                        maxlength view/maxlength;\n-                        class string:form-control $is_invalid"\n-        />\n+  <input class="form-control"\n+         type="file"\n+         tal:define="\n+           is_invalid python:view.error and \'is-invalid\' or \'\';\n+         "\n+         tal:attributes="\n+           id string:${view/id}-input;\n+           name view/name;\n+           required python:view.required and \'required\' or None;\n+           size view/size;\n+           disabled view/disabled;\n+           maxlength view/maxlength;\n+           class string:form-control $is_invalid;\n+         "\n+  />\n \n-    <script tal:condition="python:allow_nochange and action != \'replace\'" type="text/javascript"\n-        tal:content="string:document.getElementById(\'${view/id}-input\').disabled=true;">\n-    </script>\n+  <script type="text/javascript"\n+          tal:condition="python:allow_nochange and action != \'replace\'"\n+          tal:content="string:document.getElementById(\'${view/id}-input\').disabled=true;"\n+  >\n+  </script>\n \n </div>\ndiff --git a/plone/app/z3cform/templates/form.pt b/plone/app/z3cform/templates/form.pt\nindex e4215a13..1d9fc9d4 100644\n--- a/plone/app/z3cform/templates/form.pt\n+++ b/plone/app/z3cform/templates/form.pt\n@@ -1,21 +1,27 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+<html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n       lang="en"\n       metal:use-macro="here/main_template/macros/master"\n-      i18n:domain="plone">\n+      xml:lang="en"\n+      i18n:domain="plone"\n+>\n \n-<metal:content-title fill-slot="content-title">\n-  <h1 class="documentFirstHeading" tal:content="view/label|nothing" />\n-</metal:content-title>\n+  <metal:content-title fill-slot="content-title">\n+    <h1 class="documentFirstHeading"\n+        tal:content="view/label|nothing"\n+    ></h1>\n+  </metal:content-title>\n \n-<metal:content-title fill-slot="content-description">\n-  <div class="text-muted" tal:content="structure view/description|nothing" />\n-</metal:content-title>\n+  <metal:content-title fill-slot="content-description">\n+    <div class="text-muted"\n+         tal:content="structure view/description|nothing"\n+    ></div>\n+  </metal:content-title>\n \n-<metal:content-core fill-slot="content-core">\n-  <metal:block use-macro="context/@@ploneform-macros/titlelessform" />\n-</metal:content-core>\n+  <metal:content-core fill-slot="content-core">\n+    <metal:block use-macro="context/@@ploneform-macros/titlelessform" />\n+  </metal:content-core>\n \n </html>\ndiff --git a/plone/app/z3cform/templates/image_input.pt b/plone/app/z3cform/templates/image_input.pt\nindex c654fe89..b1ebb4f4 100644\n--- a/plone/app/z3cform/templates/image_input.pt\n+++ b/plone/app/z3cform/templates/image_input.pt\n@@ -1,114 +1,159 @@\n-<div\n-    i18n:domain="plone"\n-    tal:attributes="id view/id;\n-                    style view/style;\n-                    title view/title;\n-                    lang view/lang;\n-                    onclick view/onclick;\n-                    ondblclick view/ondblclick;\n-                    onmousedown view/onmousedown;\n-                    onmouseup view/onmouseup;\n-                    onmouseover view/onmouseover;\n-                    onmousemove view/onmousemove;\n-                    onmouseout view/onmouseout;\n-                    onkeypress view/onkeypress;\n-                    onkeydown view/onkeydown;\n-                    onkeyup view/onkeyup;\n-                    onfocus view/onfocus;\n-                    onblur view/onblur;\n-                    onchange view/onchange;\n-                    readonly view/readonly;\n-                    accesskey view/accesskey;\n-                    onselect view/onselect;"\n-    tal:define="download_url view/download_url;\n-                exists python: view.value is not None;\n-                action view/action;\n-                allow_nochange view/allow_nochange;\n-                doc_type view/file_content_type;\n-                icon view/file_icon;\n-                filename view/filename;">\n-    <tal:if tal:define="up_id view/file_upload_id" tal:condition="up_id">\n-      <input type="hidden" name="${view/name}.file_upload_id" value="${up_id}"/>\n-      <span>\n-        <tal:i18n i18n:translate="image_already_uploaded">Image already uploaded:</tal:i18n>\n+<div tal:define="\n+       download_url view/download_url;\n+       exists python: view.value is not None;\n+       action view/action;\n+       allow_nochange view/allow_nochange;\n+       doc_type view/file_content_type;\n+       icon view/file_icon;\n+       filename view/filename;\n+     "\n+     tal:attributes="\n+       id view/id;\n+       style view/style;\n+       title view/title;\n+       lang view/lang;\n+       onclick view/onclick;\n+       ondblclick view/ondblclick;\n+       onmousedown view/onmousedown;\n+       onmouseup view/onmouseup;\n+       onmouseover view/onmouseover;\n+       onmousemove view/onmousemove;\n+       onmouseout view/onmouseout;\n+       onkeypress view/onkeypress;\n+       onkeydown view/onkeydown;\n+       onkeyup view/onkeyup;\n+       onfocus view/onfocus;\n+       onblur view/onblur;\n+       onchange view/onchange;\n+       readonly view/readonly;\n+       accesskey view/accesskey;\n+       onselect view/onselect;\n+     "\n+     i18n:domain="plone"\n+>\n+  <tal:if tal:define="\n+            up_id view/file_upload_id;\n+          "\n+          tal:condition="up_id"\n+  >\n+    <input name="${view/name}.file_upload_id"\n+           type="hidden"\n+           value="${up_id}"\n+    />\n+    <span>\n+      <tal:i18n i18n:translate="image_already_uploaded">Image already uploaded:</tal:i18n>\n         ${view/value/filename}\n-      </span>\n-    </tal:if>\n-    <span tal:condition="python:exists and download_url and action==\'nochange\'">\n-      <a tal:attributes="href download_url">\n-          <img tal:replace="structure view/thumb_tag"/>\n-      </a><br />\n-        <img tal:condition="icon" src="" alt=""\n-             tal:attributes="src icon;\n-                             alt doc_type;\n-                             title filename;"/>\n-        <a\n-            tal:content="filename"\n-            tal:attributes="href download_url"\n-            >Filename</a>\n-        <span class="discreet"> &mdash;<tal:doc_type condition="doc_type">\n-            <span tal:replace="doc_type"\n-                  i18n:translate="">ContentType</span>,</tal:doc_type>\n-            <span tal:define="sizekb view/file_size" tal:replace="sizekb"\n-                  i18n:translate="">100</span>\n-        </span>\n     </span>\n-    <tal:block condition="allow_nochange">\n-        <div class="form-check">\n-            <input\n-                type="radio"\n-                value="nochange"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-nochange;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n-                                checked python:\'checked\' if action == \'nochange\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-nochange" i18n:translate="image_keep">Keep existing image</label>\n-        </div>\n-        <div class="form-check" tal:condition="not:view/field/required">\n-            <input\n-                type="radio"\n-                value="remove"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-remove;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n-                                checked python:\'checked\' if action == \'remove\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-remove" i18n:translate="image_remove">Remove existing image</label>\n-        </div>\n+  </tal:if>\n+  <span tal:condition="python:exists and download_url and action==\'nochange\'">\n+    <a tal:attributes="\n+         href download_url;\n+       ">\n+      <img tal:replace="structure view/thumb_tag" />\n+    </a><br />\n+    <img alt=""\n+         src=""\n+         tal:condition="icon"\n+         tal:attributes="\n+           src icon;\n+           alt doc_type;\n+           title filename;\n+         "\n+    />\n+    <a tal:content="filename"\n+       tal:attributes="\n+         href download_url;\n+       "\n+    >Filename</a>\n+    <span class="discreet">\n+      &mdash;<tal:doc_type condition="doc_type">\n+        <span tal:replace="doc_type"\n+              i18n:translate=""\n+        >ContentType</span>,</tal:doc_type>\n+      <span tal:define="\n+              sizekb view/file_size;\n+            "\n+            tal:replace="sizekb"\n+            i18n:translate=""\n+      >100</span>\n+    </span>\n+  </span>\n+  <tal:block condition="allow_nochange">\n+    <div class="form-check">\n+      <input class="form-check-input"\n+             type="radio"\n+             value="nochange"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-nochange;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n+               checked python:\'checked\' if action == \'nochange\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-nochange;\n+             "\n+             i18n:translate="image_keep"\n+      >Keep existing image</label>\n+    </div>\n+    <div class="form-check"\n+         tal:condition="not:view/field/required"\n+    >\n+      <input class="form-check-input"\n+             type="radio"\n+             value="remove"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-remove;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=true;\n+               checked python:\'checked\' if action == \'remove\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-remove;\n+             "\n+             i18n:translate="image_remove"\n+      >Remove existing image</label>\n+    </div>\n \n-        <div class="form-check">\n-            <input\n-                type="radio"\n-                value="replace"\n-                class="form-check-input"\n-                tal:attributes="name string:${view/name}.action;\n-                                id string:${view/id}-replace;\n-                                onclick string:document.getElementById(\'${view/id}-input\').disabled=false;\n-                                checked python:\'checked\' if action == \'replace\' else None"\n-                />\n-            <label class="form-check-label"\n-                tal:attributes="for string:${view/id}-replace" i18n:translate="image_replace">Replace with new image</label>\n-        </div>\n-    </tal:block>\n+    <div class="form-check">\n+      <input class="form-check-input"\n+             type="radio"\n+             value="replace"\n+             tal:attributes="\n+               name string:${view/name}.action;\n+               id string:${view/id}-replace;\n+               onclick string:document.getElementById(\'${view/id}-input\').disabled=false;\n+               checked python:\'checked\' if action == \'replace\' else None;\n+             "\n+      />\n+      <label class="form-check-label"\n+             tal:attributes="\n+               for string:${view/id}-replace;\n+             "\n+             i18n:translate="image_replace"\n+      >Replace with new image</label>\n+    </div>\n+  </tal:block>\n \n-    <input\n-        type="file"\n-        class="form-control"\n-        tal:attributes="id string:${view/id}-input;\n-                        name view/name;\n-                        required python:view.required and \'required\' or None;\n-                        size view/size;\n-                        disabled view/disabled;\n-                        maxlength view/maxlength;"\n-        />\n+  <input class="form-control"\n+         type="file"\n+         tal:attributes="\n+           id string:${view/id}-input;\n+           name view/name;\n+           required python:view.required and \'required\' or None;\n+           size view/size;\n+           disabled view/disabled;\n+           maxlength view/maxlength;\n+         "\n+  />\n \n-    <script tal:condition="python:allow_nochange and action != \'replace\'" type="text/javascript"\n-        tal:content="string:document.getElementById(\'${view/id}-input\').disabled=true;">\n-    </script>\n+  <script type="text/javascript"\n+          tal:condition="python:allow_nochange and action != \'replace\'"\n+          tal:content="string:document.getElementById(\'${view/id}-input\').disabled=true;"\n+  >\n+  </script>\n \n </div>\ndiff --git a/plone/app/z3cform/templates/layout.pt b/plone/app/z3cform/templates/layout.pt\nindex 5211b6c5..0bfb98be 100644\n--- a/plone/app/z3cform/templates/layout.pt\n+++ b/plone/app/z3cform/templates/layout.pt\n@@ -1,18 +1,24 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+<html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n       lang="en"\n       metal:use-macro="here/main_template/macros/master"\n-      i18n:domain="plone">\n-<body>\n+      xml:lang="en"\n+      i18n:domain="plone"\n+>\n+  <body>\n \n     <metal:main fill-slot="main">\n-        <metal:main-macro define-macro="main">\n-            <h1 class="documentFirstHeading" tal:content="view/label">Title</h1>\n-            <div id="content-core" tal:content="structure view/contents" />\n-        </metal:main-macro>\n+      <metal:main-macro define-macro="main">\n+        <h1 class="documentFirstHeading"\n+            tal:content="view/label"\n+        >Title</h1>\n+        <div id="content-core"\n+             tal:content="structure view/contents"\n+        ></div>\n+      </metal:main-macro>\n     </metal:main>\n \n-</body>\n+  </body>\n </html>\ndiff --git a/plone/app/z3cform/templates/link_input.pt b/plone/app/z3cform/templates/link_input.pt\nindex 1c747a34..10672186 100644\n--- a/plone/app/z3cform/templates/link_input.pt\n+++ b/plone/app/z3cform/templates/link_input.pt\n@@ -2,51 +2,105 @@\n   <div class="linkModal">\n \n     <div class="pat-autotoc autotabs"\n-         data-pat-autotoc="section:span.linkType;levels:span.linkLabel;">\n+         data-pat-autotoc="section:span.linkType;levels:span.linkLabel;"\n+    >\n \n-      <span class="linkType internal" data-linkType="internal"\n-            tal:define="value view/value/internal | nothing"\n-            tal:attributes="class python:\'linkType internal\' + (\' active\' if value else \'\')">\n-        <span class="linkLabel d-none" i18n:translate="label_internal_url">Internal</span>\n+      <span class="linkType internal"\n+            data-linktype="internal"\n+            tal:define="\n+              value view/value/internal | nothing;\n+            "\n+            tal:attributes="\n+              class python:\'linkType internal\' + (\' active\' if value else \'\');\n+            "\n+      >\n+        <span class="linkLabel d-none"\n+              i18n:translate="label_internal_url"\n+        >Internal</span>\n         <div>\n           <div class="mb-3 main">\n             <!-- this gives the name to the "linkType" -->\n-            <input type="text" name="internal" class="pat-relateditems"\n-                    tal:attributes="data-pat-relateditems view/pattern_data;\n-                                    value value;\n-                                    name string:${view/name}.internal" />\n+            <input class="pat-relateditems"\n+                   name="internal"\n+                   type="text"\n+                   tal:attributes="\n+                     data-pat-relateditems view/pattern_data;\n+                     value value;\n+                     name string:${view/name}.internal;\n+                   "\n+            />\n           </div>\n         </div>\n       </span>\n \n-      <span class="linkType external" data-linkType="external"\n-            tal:define="value view/value/external | nothing"\n-            tal:attributes="class python:\'linkType external\' + (\' active\' if value else \'\')">\n-        <span class="linkLabel d-none" i18n:translate="label_external_url">External</span>\n+      <span class="linkType external"\n+            data-linktype="external"\n+            tal:define="\n+              value view/value/external | nothing;\n+            "\n+            tal:attributes="\n+              class python:\'linkType external\' + (\' active\' if value else \'\');\n+            "\n+      >\n+        <span class="linkLabel d-none"\n+              i18n:translate="label_external_url"\n+        >External</span>\n         <div class="mb-3 main">\n-          <label class="form-label" for="external" i18n:translate="help_external_url">External URL (can be relative within this site or absolute if it starts with http:// or https://)</label>\n-          <input class="form-control" type="text" name="external" placeholder="https://domain.com"\n-                 tal:attributes="name string:${view/name}.external;\n-                                 value value" />\n+          <label class="form-label"\n+                 for="external"\n+                 i18n:translate="help_external_url"\n+          >External URL (can be relative within this site or absolute if it starts with http:// or https://)</label>\n+          <input class="form-control"\n+                 name="external"\n+                 placeholder="https://domain.com"\n+                 type="text"\n+                 tal:attributes="\n+                   name string:${view/name}.external;\n+                   value value;\n+                 "\n+          />\n         </div>\n       </span>\n \n-      <span class="linkType email" data-linkType="email"\n-            tal:define="value view/value/email | nothing"\n-            tal:attributes="class python:\'linkType email\' + (\' active\' if value else \'\')">\n-        <span class="linkLabel d-none" i18n:translate="label_email_url">Email</span>\n+      <span class="linkType email"\n+            data-linktype="email"\n+            tal:define="\n+              value view/value/email | nothing;\n+            "\n+            tal:attributes="\n+              class python:\'linkType email\' + (\' active\' if value else \'\');\n+            "\n+      >\n+        <span class="linkLabel d-none"\n+              i18n:translate="label_email_url"\n+        >Email</span>\n         <div class="form-inline">\n           <div class="mb-3 main">\n-            <label class="form-label" i18n:translate="help_email_url">Email Address</label>\n-            <input class="form-control" type="email" name="email" placeholder="name@domain.com"\n-                   tal:attributes="name string:${view/name}.email;\n-                                   value value" />\n+            <label class="form-label"\n+                   i18n:translate="help_email_url"\n+            >Email Address</label>\n+            <input class="form-control"\n+                   name="email"\n+                   placeholder="name@domain.com"\n+                   type="email"\n+                   tal:attributes="\n+                     name string:${view/name}.email;\n+                     value value;\n+                   "\n+            />\n           </div>\n           <div class="mb-3">\n-            <label class="form-label" i18n:translate="help_email_url_subject">Email Subject (optional)</label>\n-            <input class="form-control" type="text" name="subject"\n-                   tal:attributes="name string:${view/name}.subject;\n-                                   value view/value/email_subject | nothing" />\n+            <label class="form-label"\n+                   i18n:translate="help_email_url_subject"\n+            >Email Subject (optional)</label>\n+            <input class="form-control"\n+                   name="subject"\n+                   type="text"\n+                   tal:attributes="\n+                     name string:${view/name}.subject;\n+                     value view/value/email_subject | nothing;\n+                   "\n+            />\n           </div>\n         </div>\n       </span>\ndiff --git a/plone/app/z3cform/templates/macros.pt b/plone/app/z3cform/templates/macros.pt\nindex 5af3c567..20f2077d 100644\n--- a/plone/app/z3cform/templates/macros.pt\n+++ b/plone/app/z3cform/templates/macros.pt\n@@ -1,177 +1,233 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      i18n:domain="plone">\n-\n-    <body>\n-\n-        <div class="form" metal:define-macro="form">\n-\n-            <metal:title-slot define-slot="title">\n-              <h3 tal:condition="view/label | nothing" tal:content="view/label" />\n-            </metal:title-slot>\n-\n-            <metal:define define-macro="titlelessform"\n-                          i18n:domain="plone">\n-\n-                <tal:status tal:define="status view/status;\n-                                        has_error python:view.widgets.errors or status == getattr(view, \'formErrorsMessage\', None);\n-                                        errors view/widgets/errors;\n-                                        icons nocall: context/@@iconresolver"\n-                            tal:condition="python: status">\n-                    <div tal:condition="python:not (has_error or errors)"\n-                         class="portalMessage statusmessage statusmessage-info alert alert-info"\n-                         role="alert">\n-                        <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-info\', tag_alt=\'Info\', tag_class=\'statusmessage-icon mb-1 me-2\')" i18n:attributes="alt"/>\n-                        <span class="content"\n-                              tal:replace="structure status | nothing"\n-                              i18n:translate="">\n+      i18n:domain="plone"\n+>\n+\n+  <body>\n+\n+    <div class="form"\n+         metal:define-macro="form"\n+    >\n+\n+      <metal:title-slot define-slot="title">\n+        <h3 tal:condition="view/label | nothing"\n+            tal:content="view/label"\n+        ></h3>\n+      </metal:title-slot>\n+\n+      <metal:define define-macro="titlelessform"\n+                    i18n:domain="plone"\n+      >\n+\n+        <tal:status tal:define="\n+                      status view/status;\n+                      has_error python:view.widgets.errors or status == getattr(view, \'formErrorsMessage\', None);\n+                      errors view/widgets/errors;\n+                      icons nocall: context/@@iconresolver;\n+                    "\n+                    tal:condition="python: status"\n+        >\n+          <div class="portalMessage statusmessage statusmessage-info alert alert-info"\n+               role="alert"\n+               tal:condition="python:not (has_error or errors)"\n+          >\n+            <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-info\', tag_alt=\'Info\', tag_class=\'statusmessage-icon mb-1 me-2\')"\n+                      i18n:attributes="alt"\n+            />\n+            <span class="content"\n+                  tal:replace="structure status | nothing"\n+                  i18n:translate=""\n+            >\n                               The info status message.\n-                        </span>\n-                    </div>\n-                    <div tal:condition="python:has_error or errors"\n-                         class="portalMessage statusmessage statusmessage-error alert alert-danger"\n-                         role="alert">\n-                        <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-error\', tag_alt=\'Error\', tag_class=\'statusmessage-icon mb-1 me-2\')" i18n:attributes="alt"/>\n-                        <span class="content"\n-                              tal:replace="structure status | nothing"\n-                              i18n:translate="">\n+            </span>\n+          </div>\n+          <div class="portalMessage statusmessage statusmessage-error alert alert-danger"\n+               role="alert"\n+               tal:condition="python:has_error or errors"\n+          >\n+            <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-error\', tag_alt=\'Error\', tag_class=\'statusmessage-icon mb-1 me-2\')"\n+                      i18n:attributes="alt"\n+            />\n+            <span class="content"\n+                  tal:replace="structure status | nothing"\n+                  i18n:translate=""\n+            >\n                               The error status message.\n-                        </span>\n-                        <div class="mt-2 field error" tal:condition="python:[e for e in errors if not getattr(e, \'widget\', None)]">\n-                            <ul>\n-                                <tal:loop tal:repeat="error errors">\n-                                    <li tal:condition="not:nocall:error/widget"\n-                                        tal:content="structure error/render">\n+            </span>\n+            <div class="mt-2 field error"\n+                 tal:condition="python:[e for e in errors if not getattr(e, \'widget\', None)]"\n+            >\n+              <ul>\n+                <tal:loop tal:repeat="error errors">\n+                  <li tal:condition="not:nocall:error/widget"\n+                      tal:content="structure error/render"\n+                  >\n                                         Error\n-                                    </li>\n-                                </tal:loop>\n-                            </ul>\n-                        </div>\n-                    </div>\n-                </tal:status>\n-\n-\n-                <form data-pat-autotoc="levels: legend; section: fieldset; className: autotabs"\n-                      class="rowlike enableUnloadProtection" action="." method="post"\n-                      tal:define="groups view/groups | nothing;\n-                                  form_name view/form_name | nothing;\n-                                  form_class view/css_class | string:;\n-                                  default_fieldset_label view/default_fieldset_label | form_name;\n-                                  enable_form_tabbing view/enable_form_tabbing | python:True;\n-                                  enable_unload_protection view/enable_unload_protection|python:True;\n-                                  unload_protection python:enable_unload_protection and \'pat-formunloadalert\';\n-                                  enable_autofocus view/enable_autofocus|python:True;\n-                                  autofocus python:enable_autofocus and \'pat-formautofocus\';\n-                                  validation python:\'pat-validation\' if True else \'\';\n-                                  has_groups python:bool(groups);\n-                                  form_tabbing python:(has_groups and enable_form_tabbing) and \'enableFormTabbing pat-autotoc\' or \'\';\n-                                  show_default_label python:has_groups and default_fieldset_label and len(view.widgets);\n-                                  form_view_name_raw python:view.__name__ or request.getURL().split(\'/\')[-1];\n-                                  form_view_name python:\'-\'.join([\'view\', \'name\'] + [x for x in form_view_name_raw.split(\'++\') if x]);\n-                                  "\n-                      tal:attributes="action view/action|request/getURL;\n-                                      enctype view/enctype;\n-                                      class string:rowlike $unload_protection $autofocus $validation $form_tabbing $form_class $form_view_name_raw $form_view_name;\n-                                      id view/id;\n-                                      name form_name;\n-                                      method view/method|string:post">\n-\n-                    <metal:block define-slot="formtop" />\n-\n-                    <metal:fields-slot define-slot="fields">\n-                      <input type="hidden"\n-                          name="fieldset"\n-                          tal:define="current_fieldset request/fieldset | python:None"\n-                          tal:condition="python:has_groups and enable_form_tabbing and current_fieldset is not None"\n-                          tal:attributes="value current_fieldset"\n-                          />\n-\n-                      <!-- Default fieldset -->\n-                      <metal:define\n-                          define-macro="fields"\n-                          tal:define="show_default_label show_default_label|nothing;\n-                                      has_groups has_groups|nothing">\n-\n-                          <fieldset id="fieldset-default" tal:omit-tag="not:show_default_label">\n-\n-                              <legend tal:condition="show_default_label"\n-                                      tal:attributes="id string:fieldsetlegend-default"\n-                                      tal:content="default_fieldset_label">Form name</legend>\n-\n-                              <metal:define define-macro="widget_rendering">\n-                                  <tal:widgets repeat="widget python:view.widgets.values()">\n-                                      <metal:field-slot define-slot="field">\n-                                          <metal:field define-macro="field">\n-                                              <tal:widget tal:replace="structure widget/@@ploneform-render-widget"/>\n-                                          </metal:field>\n-                                      </metal:field-slot>\n-                                  </tal:widgets>\n-                              </metal:define>\n-                          </fieldset>\n-\n-                          <!-- Secondary fieldsets -->\n-                          <tal:block tal:repeat="group groups" condition="has_groups">\n-                              <fieldset\n-                                  tal:define="normalizeString nocall:context/@@plone/normalizeString;\n-                                              fieldset_label group/label;\n-                                              fieldset_name python:getattr(group, \'__name__\', False) or getattr(group.label, \'default\', False) or fieldset_label;\n-                                              fieldset_name python:normalizeString(fieldset_name);"\n-                                  tal:attributes="id string:fieldset-${fieldset_name};\n-                                                  class string:kssattr-fieldset-${fieldset_name};\n-                                                  data-fieldset fieldset_name">\n-\n-                                      <legend \n-                                          i18n:translate=""\n-                                          tal:condition="fieldset_label"\n-                                          tal:attributes="id string:fieldsetlegend-${fieldset_name}"\n-                                          tal:content="fieldset_label">Form name</legend>\n-\n-                                      <p i18n:translate=""\n-                                         tal:define="group_description group/description|nothing"\n-                                         tal:condition="group_description"\n-                                         tal:content="structure group_description">\n+                  </li>\n+                </tal:loop>\n+              </ul>\n+            </div>\n+          </div>\n+        </tal:status>\n+\n+\n+        <form class="rowlike enableUnloadProtection"\n+              action="."\n+              method="post"\n+              data-pat-autotoc="levels: legend; section: fieldset; className: autotabs"\n+              tal:define="\n+                groups view/groups | nothing;\n+                form_name view/form_name | nothing;\n+                form_class view/css_class | string:;\n+                default_fieldset_label view/default_fieldset_label | form_name;\n+                enable_form_tabbing view/enable_form_tabbing | python:True;\n+                enable_unload_protection view/enable_unload_protection|python:True;\n+                unload_protection python:enable_unload_protection and \'pat-formunloadalert\';\n+                enable_autofocus view/enable_autofocus|python:True;\n+                autofocus python:enable_autofocus and \'pat-formautofocus\';\n+                validation python:\'pat-validation\' if True else \'\';\n+                has_groups python:bool(groups);\n+                form_tabbing python:(has_groups and enable_form_tabbing) and \'enableFormTabbing pat-autotoc\' or \'\';\n+                show_default_label python:has_groups and default_fieldset_label and len(view.widgets);\n+                form_view_name_raw python:view.__name__ or request.getURL().split(\'/\')[-1];\n+                form_view_name python:\'-\'.join([\'view\', \'name\'] + [x for x in form_view_name_raw.split(\'++\') if x]);\n+              "\n+              tal:attributes="\n+                action view/action|request/getURL;\n+                enctype view/enctype;\n+                class string:rowlike $unload_protection $autofocus $validation $form_tabbing $form_class $form_view_name_raw $form_view_name;\n+                id view/id;\n+                name form_name;\n+                method view/method|string:post;\n+              "\n+        >\n+\n+          <metal:block define-slot="formtop" />\n+\n+          <metal:fields-slot define-slot="fields">\n+            <input name="fieldset"\n+                   type="hidden"\n+                   tal:define="\n+                     current_fieldset request/fieldset | python:None;\n+                   "\n+                   tal:condition="python:has_groups and enable_form_tabbing and current_fieldset is not None"\n+                   tal:attributes="\n+                     value current_fieldset;\n+                   "\n+            />\n+\n+            <!-- Default fieldset -->\n+            <metal:define define-macro="fields"\n+                          tal:define="\n+                            show_default_label show_default_label|nothing;\n+                            has_groups has_groups|nothing;\n+                          "\n+            >\n+\n+              <fieldset id="fieldset-default"\n+                        tal:omit-tag="not:show_default_label"\n+              >\n+\n+                <legend tal:condition="show_default_label"\n+                        tal:content="default_fieldset_label"\n+                        tal:attributes="\n+                          id string:fieldsetlegend-default;\n+                        "\n+                >Form name</legend>\n+\n+                <metal:define define-macro="widget_rendering">\n+                  <tal:widgets repeat="widget python:view.widgets.values()">\n+                    <metal:field-slot define-slot="field">\n+                      <metal:field define-macro="field">\n+                        <tal:widget tal:replace="structure widget/@@ploneform-render-widget" />\n+                      </metal:field>\n+                    </metal:field-slot>\n+                  </tal:widgets>\n+                </metal:define>\n+              </fieldset>\n+\n+              <!-- Secondary fieldsets -->\n+              <tal:block condition="has_groups"\n+                         tal:repeat="group groups"\n+              >\n+                <fieldset tal:define="\n+                            normalizeString nocall:context/@@plone/normalizeString;\n+                            fieldset_label group/label;\n+                            fieldset_name python:getattr(group, \'__name__\', False) or getattr(group.label, \'default\', False) or fieldset_label;\n+                            fieldset_name python:normalizeString(fieldset_name);\n+                          "\n+                          tal:attributes="\n+                            id string:fieldset-${fieldset_name};\n+                            class string:kssattr-fieldset-${fieldset_name};\n+                            data-fieldset fieldset_name;\n+                          "\n+                >\n+\n+                  <legend tal:condition="fieldset_label"\n+                          tal:content="fieldset_label"\n+                          tal:attributes="\n+                            id string:fieldsetlegend-${fieldset_name};\n+                          "\n+                          i18n:translate=""\n+                  >Form name</legend>\n+\n+                  <p tal:define="\n+                       group_description group/description|nothing;\n+                     "\n+                     tal:condition="group_description"\n+                     tal:content="structure group_description"\n+                     i18n:translate=""\n+                  >\n                                           Description\n-                                      </p>\n-\n-                                      <tal:block tal:define="errors group/widgets/errors"\n-                                                 tal:condition="errors"\n-                                                 tal:repeat="error errors">\n-                                          <div class="field error"\n-                                              tal:condition="not:nocall:error/widget"\n-                                              tal:content="structure error/render"\n-                                              />\n-                                      </tal:block>\n-\n-                                      <tal:block define="view nocall:group">\n-                                          <metal:block use-macro="context/@@ploneform-macros/widget_rendering" />\n-                                      </tal:block>\n-\n-                              </fieldset>\n-                          </tal:block>\n-\n-                      </metal:define>\n-                    </metal:fields-slot>\n-\n-                    <metal:block define-slot="belowfields" />\n-\n-                    <metal:actions define-slot="actions">\n-                      <metal:define define-macro="actions">\n-                        <div class="formControls" tal:condition="view/actions/values|nothing">\n-                          <tal:block repeat="action view/actions/values">\n-                            <input tal:replace="structure action/render" />\n-                          </tal:block>\n-                       </div>\n-                      </metal:define>\n-                    </metal:actions>\n-\n-                    <tal:block tal:condition="view/enableCSRFProtection|nothing"\n-                      tal:replace="structure context/@@authenticator/authenticator" />\n-                    <metal:block define-slot="formbottom" />\n-\n-                </form>\n+                  </p>\n+\n+                  <tal:block tal:define="\n+                               errors group/widgets/errors;\n+                             "\n+                             tal:condition="errors"\n+                             tal:repeat="error errors"\n+                  >\n+                    <div class="field error"\n+                         tal:condition="not:nocall:error/widget"\n+                         tal:content="structure error/render"\n+                    ></div>\n+                  </tal:block>\n+\n+                  <tal:block define="\n+                               view nocall:group;\n+                             ">\n+                    <metal:block use-macro="context/@@ploneform-macros/widget_rendering" />\n+                  </tal:block>\n+\n+                </fieldset>\n+              </tal:block>\n+\n             </metal:define>\n-        </div>\n-    </body>\n+          </metal:fields-slot>\n+\n+          <metal:block define-slot="belowfields" />\n+\n+          <metal:actions define-slot="actions">\n+            <metal:define define-macro="actions">\n+              <div class="formControls"\n+                   tal:condition="view/actions/values|nothing"\n+              >\n+                <tal:block repeat="action view/actions/values">\n+                  <input tal:replace="structure action/render" />\n+                </tal:block>\n+              </div>\n+            </metal:define>\n+          </metal:actions>\n+\n+          <tal:block tal:condition="view/enableCSRFProtection|nothing"\n+                     tal:replace="structure context/@@authenticator/authenticator"\n+          />\n+          <metal:block define-slot="formbottom" />\n+\n+        </form>\n+      </metal:define>\n+    </div>\n+  </body>\n </html>\ndiff --git a/plone/app/z3cform/templates/multi_input.pt b/plone/app/z3cform/templates/multi_input.pt\nindex 19dd2d30..95c833f4 100644\n--- a/plone/app/z3cform/templates/multi_input.pt\n+++ b/plone/app/z3cform/templates/multi_input.pt\n@@ -1,83 +1,128 @@\n-<div i18n:domain="plone" class="multi-widget" tal:attributes="class view/klass">\n-    <tal:block repeat="widget view/widgets">\n-        <div metal:define-macro="widget-row"\n-             tal:define="hidden python:widget.mode == \'hidden\';\n-                         showLabel view/showLabel;\n-                         checkbox_disabled python:not view.allowRemoving and \'disabled\' or nothing;\n-                         index repeat/widget/index;\n-                         key_widget python:view.key_widgets[index];\n-                         error widget/error;\n-                         key_error key_widget/error|nothing;\n-                         error_class python:(error or key_error) and \' error\' or \'\';\n-                         fieldname_class string:kssattr-fieldname-${widget/name};"\n-             tal:attributes="class string:multi-widget-field field ${fieldname_class}${error_class};\n-                             id string:formfield-${widget/id};">\n+<div class="multi-widget"\n+     tal:attributes="\n+       class view/klass;\n+     "\n+     i18n:domain="plone"\n+>\n+  <tal:block repeat="widget view/widgets">\n+    <div metal:define-macro="widget-row"\n+         tal:define="\n+           hidden python:widget.mode == \'hidden\';\n+           showLabel view/showLabel;\n+           checkbox_disabled python:not view.allowRemoving and \'disabled\' or nothing;\n+           index repeat/widget/index;\n+           key_widget python:view.key_widgets[index];\n+           error widget/error;\n+           key_error key_widget/error|nothing;\n+           error_class python:(error or key_error) and \' error\' or \'\';\n+           fieldname_class string:kssattr-fieldname-${widget/name};\n+         "\n+         tal:attributes="\n+           class string:multi-widget-field field ${fieldname_class}${error_class};\n+           id string:formfield-${widget/id};\n+         "\n+    >\n \n-            <input id="" name=""\n-                   class="multi-widget-checkbox checkbox-widget"\n-                   type="checkbox" value="1"\n-                   tal:attributes="id string:${widget/id}-remove;\n-                                   name string:${widget/name}.remove;\n-                                   disabled checkbox_disabled;"/>\n-            <label for="" class="form-label horizontal"\n-                tal:attributes="for key_widget/id"\n-                tal:condition="python:key_widget is not None and showLabel and not hidden"\n-                ><span i18n:translate="" tal:replace="key_widget/label">label</span>\n-                <span class="multi-widget-number" tal:content="repeat/widget/number">1</span>\n-                <span class="required horizontal" title="Required"\n-                      tal:condition="python:key_widget.required and not hidden"\n-                      i18n:attributes="title title_required;">&nbsp;</span>\n-                <span class="formHelp"\n-                    tal:define="description key_widget/field/description"\n-                    i18n:translate=""\n-                    tal:content="description"\n-                    tal:condition="python:description and showLabel and not hidden"\n-                    >field description\n-                </span>\n-            </label>\n+      <input class="multi-widget-checkbox checkbox-widget"\n+             id=""\n+             name=""\n+             type="checkbox"\n+             value="1"\n+             tal:attributes="\n+               id string:${widget/id}-remove;\n+               name string:${widget/name}.remove;\n+               disabled checkbox_disabled;\n+             "\n+      />\n+      <label class="form-label horizontal"\n+             for=""\n+             tal:condition="python:key_widget is not None and showLabel and not hidden"\n+             tal:attributes="\n+               for key_widget/id;\n+             "\n+      ><span tal:replace="key_widget/label"\n+              i18n:translate=""\n+        >label</span>\n+        <span class="multi-widget-number"\n+              tal:content="repeat/widget/number"\n+        >1</span>\n+        <span class="required horizontal"\n+              title="Required"\n+              tal:condition="python:key_widget.required and not hidden"\n+              i18n:attributes="title title_required;"\n+        >&nbsp;</span>\n+        <span class="formHelp"\n+              tal:define="\n+                description key_widget/field/description;\n+              "\n+              tal:condition="python:description and showLabel and not hidden"\n+              tal:content="description"\n+              i18n:translate=""\n+        >field description\n+        </span>\n+      </label>\n \n-            <div class="fieldErrorBox"\n-                tal:content="structure key_error/render|nothing">\n+      <div class="fieldErrorBox"\n+           tal:content="structure key_error/render|nothing"\n+      >\n                 Error\n-            </div>\n+      </div>\n \n-            <input\n-                tal:condition="python:key_widget is not None"\n-                tal:replace="structure key_widget/render"\n-            />\n+      <input tal:condition="python:key_widget is not None"\n+             tal:replace="structure key_widget/render"\n+      />\n \n-            <br/>\n+      <br />\n \n-            <label for="" class="form-label horizontal"\n-                tal:attributes="for widget/id"\n-                tal:condition="python:showLabel and not hidden">\n-                <span i18n:translate="" tal:replace="widget/label">label</span>\n-                <span class="multi-widget-number" tal:content="repeat/widget/number">1</span>\n-                <span class="required horizontal" title="Required"\n-                      tal:condition="python:widget.required and not hidden"\n-                      i18n:attributes="title title_required;">&nbsp;</span>\n-                <span class="formHelp"\n-                    tal:define="description widget/field/description"\n-                    i18n:translate=""\n-                    tal:content="description"\n-                    tal:condition="python:description and showLabel and not hidden"\n-                    >field description\n-                </span>\n-            </label>\n+      <label class="form-label horizontal"\n+             for=""\n+             tal:condition="python:showLabel and not hidden"\n+             tal:attributes="\n+               for widget/id;\n+             "\n+      >\n+        <span tal:replace="widget/label"\n+              i18n:translate=""\n+        >label</span>\n+        <span class="multi-widget-number"\n+              tal:content="repeat/widget/number"\n+        >1</span>\n+        <span class="required horizontal"\n+              title="Required"\n+              tal:condition="python:widget.required and not hidden"\n+              i18n:attributes="title title_required;"\n+        >&nbsp;</span>\n+        <span class="formHelp"\n+              tal:define="\n+                description widget/field/description;\n+              "\n+              tal:condition="python:description and showLabel and not hidden"\n+              tal:content="description"\n+              i18n:translate=""\n+        >field description\n+        </span>\n+      </label>\n \n-            <div class="fieldErrorBox"\n-                tal:content="structure error/render|nothing">\n+      <div class="fieldErrorBox"\n+           tal:content="structure error/render|nothing"\n+      >\n                 Error\n-            </div>\n+      </div>\n \n-            <input tal:replace="structure widget/render" />\n+      <input tal:replace="structure widget/render" />\n \n-        </div>\n-    </tal:block>\n-    <div class="formControls multi-widget-buttons" tal:condition="view/actions/values|nothing">\n-        <tal:block repeat="action view/actions/values">\n-            <input type="submit" tal:replace="structure action/render" />\n-        </tal:block>\n     </div>\n-    <input type="hidden" tal:replace="structure view/counterMarker" />\n+  </tal:block>\n+  <div class="formControls multi-widget-buttons"\n+       tal:condition="view/actions/values|nothing"\n+  >\n+    <tal:block repeat="action view/actions/values">\n+      <input type="submit"\n+             tal:replace="structure action/render"\n+      />\n+    </tal:block>\n+  </div>\n+  <input type="hidden"\n+         tal:replace="structure view/counterMarker"\n+  />\n </div>\ndiff --git a/plone/app/z3cform/templates/object_input.pt b/plone/app/z3cform/templates/object_input.pt\nindex 3138bf9d..dae93600 100644\n--- a/plone/app/z3cform/templates/object_input.pt\n+++ b/plone/app/z3cform/templates/object_input.pt\n@@ -1,39 +1,67 @@\n-<div i18n:domain="plone" class="object-widget" tal:attributes="class view/klass">\n-    <tal:block repeat="widget python:view.widgets.values()">\n-        <div tal:define="hidden python:widget.mode == \'hidden\';\n-                         error widget/error;\n-                         error_class python:error and \' error\' or \'\';\n-                         fieldname_class string:kssattr-fieldname-${widget/name};"\n-             tal:attributes="class string:object-widget-field field ${fieldname_class}${error_class};\n-             data-fieldname widget/name;\n-                             id string:formfield-${widget/id};">\n+<div class="object-widget"\n+     tal:attributes="\n+       class view/klass;\n+     "\n+     i18n:domain="plone"\n+>\n+  <tal:block repeat="widget python:view.widgets.values()">\n+    <div tal:define="\n+           hidden python:widget.mode == \'hidden\';\n+           error widget/error;\n+           error_class python:error and \' error\' or \'\';\n+           fieldname_class string:kssattr-fieldname-${widget/name};\n+         "\n+         tal:attributes="\n+           class string:object-widget-field field ${fieldname_class}${error_class};\n+           data-fieldname widget/name;\n+           id string:formfield-${widget/id};\n+         "\n+    >\n \n-            <label class="form-label horizontal" for=""\n-                tal:attributes="for widget/id"\n-                tal:condition="not:hidden">\n-                <span i18n:translate="" tal:replace="widget/label">label</span>\n+      <label class="form-label horizontal"\n+             for=""\n+             tal:condition="not:hidden"\n+             tal:attributes="\n+               for widget/id;\n+             "\n+      >\n+        <span tal:replace="widget/label"\n+              i18n:translate=""\n+        >label</span>\n \n-              <span class="required horizontal" title="Required"\n-                    tal:condition="python:widget.required and not hidden"\n-                    i18n:attributes="title title_required;">&nbsp;</span>\n+        <span class="required horizontal"\n+              title="Required"\n+              tal:condition="python:widget.required and not hidden"\n+              i18n:attributes="title title_required;"\n+        >&nbsp;</span>\n \n-              <span class="formHelp"\n-                  tal:define="description widget/field/description"\n-                  i18n:translate=""\n-                  tal:content="description"\n-                  tal:condition="python:description and not hidden"\n-                  >field description\n-              </span>\n-            </label>\n+        <span class="formHelp"\n+              tal:define="\n+                description widget/field/description;\n+              "\n+              tal:condition="python:description and not hidden"\n+              tal:content="description"\n+              i18n:translate=""\n+        >field description\n+        </span>\n+      </label>\n \n-            <div class="fieldErrorBox"\n-                tal:content="structure error/render|nothing">\n+      <div class="fieldErrorBox"\n+           tal:content="structure error/render|nothing"\n+      >\n                 Error\n-            </div>\n+      </div>\n \n-            <input type="text" tal:replace="structure widget/render" />\n-        </div>\n-    </tal:block>\n-    <input name="field-empty-marker" type="hidden" value="1"\n-           tal:attributes="name string:${view/name}-empty-marker" />\n+      <input type="text"\n+             tal:replace="structure widget/render"\n+      />\n+    </div>\n+  </tal:block>\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </div>\ndiff --git a/plone/app/z3cform/templates/orderedselect_input.pt b/plone/app/z3cform/templates/orderedselect_input.pt\nindex 7638c935..3e8b7b02 100644\n--- a/plone/app/z3cform/templates/orderedselect_input.pt\n+++ b/plone/app/z3cform/templates/orderedselect_input.pt\n@@ -1,107 +1,162 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      tal:omit-tag="">\n-<script type="text/javascript" src="++resource++orderedselect_input.js"></script>\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      tal:omit-tag=""\n+>\n+  <script src="++resource++orderedselect_input.js"\n+          type="text/javascript"\n+  ></script>\n \n-<table border="0" class="ordered-selection-field"\n-       tal:attributes="id view/id">\n-  <tr>\n-    <td>\n-      <select id="from" name="from" class=""  multiple="" size="5"\n-          tal:attributes="id string:${view/id}-from;\n-                          name string:${view/name}.from;\n-                          class string:form-control ${view/klass};\n-                          style view/style;\n-                          title view/title;\n-                          lang view/lang;\n-                          onclick view/onclick;\n-                          ondblclick view/ondblclick;\n-                          onmousedown view/onmousedown;\n-                          onmouseup view/onmouseup;\n-                          onmouseover view/onmouseover;\n-                          onmousemove view/onmousemove;\n-                          onmouseout view/onmouseout;\n-                          onkeypress view/onkeypress;\n-                          onkeydown view/onkeydown;\n-                          onkeyup view/onkeyup;\n-                          disabled view/disabled;\n-                          tabindex view/tabindex;\n-                          onfocus view/onfocus;\n-                          onblur view/onblur;\n-                          onchange view/onchange;\n-                          multiple view/multiple;\n-                          size view/size">\n-        <option tal:repeat="entry view/notselectedItems"\n-                tal:attributes="value entry/value"\n-                tal:content="nocall:entry/content" i18n:translate=""/>\n-      </select>\n-    </td>\n-    <td>\n-      <button onclick="javascript:from2to()" class="btn btn-sm btn-outline-secondary"\n-              name="from2toButton" type="button" value="&rarr;"\n-              tal:attributes="onClick string:javascript:from2to(\'${view/id}\')"\n-          >&rarr;</button>\n-      <br />\n-      <button onclick="javascript:to2from()" class="btn btn-sm btn-outline-secondary"\n-              name="to2fromButton" type="button" value="&larr;"\n-              tal:attributes="onClick string:javascript:to2from(\'${view/id}\')"\n-          >&larr;</button>\n-    </td>\n-    <td>\n-      <select id="to" name="to" class="" multiple="" size="5"\n-          tal:attributes="id string:${view/id}-to;\n-                          name string:${view/name}.to;\n-                          class string:form-control ${view/klass};\n-                          style view/style;\n-                          title view/title;\n-                          lang view/lang;\n-                          onclick view/onclick;\n-                          ondblclick view/ondblclick;\n-                          onmousedown view/onmousedown;\n-                          onmouseup view/onmouseup;\n-                          onmouseover view/onmouseover;\n-                          onmousemove view/onmousemove;\n-                          onmouseout view/onmouseout;\n-                          onkeypress view/onkeypress;\n-                          onkeydown view/onkeydown;\n-                          onkeyup view/onkeyup;\n-                          disabled view/disabled;\n-                          tabindex view/tabindex;\n-                          onfocus view/onfocus;\n-                          onblur view/onblur;\n-                          onchange view/onchange;\n-                          multiple view/multiple;\n-                          size view/size">\n-        <option tal:repeat="entry view/selectedItems"\n-                tal:attributes="value entry/value"\n-                tal:content="nocall:entry/content" i18n:translate=""/>\n-      </select>\n-      <input name="foo-empty-marker" type="hidden"\n-        tal:attributes="name string:${view/name}-empty-marker"/>\n-      <span id="toDataContainer" style="display: none"\n-            tal:attributes="id string:${view/id}-toDataContainer">\n-        <script type="text/javascript" tal:content="string:copyDataForSubmit(\'${view/id}\');">\n+  <table class="ordered-selection-field"\n+         border="0"\n+         tal:attributes="\n+           id view/id;\n+         "\n+  >\n+    <tr>\n+      <td>\n+        <select class=""\n+                id="from"\n+                name="from"\n+                size="5"\n+                tal:attributes="\n+                  id string:${view/id}-from;\n+                  name string:${view/name}.from;\n+                  class string:form-control ${view/klass};\n+                  style view/style;\n+                  title view/title;\n+                  lang view/lang;\n+                  onclick view/onclick;\n+                  ondblclick view/ondblclick;\n+                  onmousedown view/onmousedown;\n+                  onmouseup view/onmouseup;\n+                  onmouseover view/onmouseover;\n+                  onmousemove view/onmousemove;\n+                  onmouseout view/onmouseout;\n+                  onkeypress view/onkeypress;\n+                  onkeydown view/onkeydown;\n+                  onkeyup view/onkeyup;\n+                  disabled view/disabled;\n+                  tabindex view/tabindex;\n+                  onfocus view/onfocus;\n+                  onblur view/onblur;\n+                  onchange view/onchange;\n+                  multiple view/multiple;\n+                  size view/size;\n+                "\n+        >\n+          <option tal:repeat="entry view/notselectedItems"\n+                  tal:content="nocall:entry/content"\n+                  tal:attributes="\n+                    value entry/value;\n+                  "\n+                  i18n:translate=""\n+          ></option>\n+        </select>\n+      </td>\n+      <td>\n+        <button class="btn btn-sm btn-outline-secondary"\n+                name="from2toButton"\n+                onclick="javascript:from2to()"\n+                type="button"\n+                value="&rarr;"\n+                tal:attributes="\n+                  onClick string:javascript:from2to(\'${view/id}\');\n+                "\n+        >&rarr;</button>\n+        <br />\n+        <button class="btn btn-sm btn-outline-secondary"\n+                name="to2fromButton"\n+                onclick="javascript:to2from()"\n+                type="button"\n+                value="&larr;"\n+                tal:attributes="\n+                  onClick string:javascript:to2from(\'${view/id}\');\n+                "\n+        >&larr;</button>\n+      </td>\n+      <td>\n+        <select class=""\n+                id="to"\n+                name="to"\n+                size="5"\n+                tal:attributes="\n+                  id string:${view/id}-to;\n+                  name string:${view/name}.to;\n+                  class string:form-control ${view/klass};\n+                  style view/style;\n+                  title view/title;\n+                  lang view/lang;\n+                  onclick view/onclick;\n+                  ondblclick view/ondblclick;\n+                  onmousedown view/onmousedown;\n+                  onmouseup view/onmouseup;\n+                  onmouseover view/onmouseover;\n+                  onmousemove view/onmousemove;\n+                  onmouseout view/onmouseout;\n+                  onkeypress view/onkeypress;\n+                  onkeydown view/onkeydown;\n+                  onkeyup view/onkeyup;\n+                  disabled view/disabled;\n+                  tabindex view/tabindex;\n+                  onfocus view/onfocus;\n+                  onblur view/onblur;\n+                  onchange view/onchange;\n+                  multiple view/multiple;\n+                  size view/size;\n+                "\n+        >\n+          <option tal:repeat="entry view/selectedItems"\n+                  tal:content="nocall:entry/content"\n+                  tal:attributes="\n+                    value entry/value;\n+                  "\n+                  i18n:translate=""\n+          ></option>\n+        </select>\n+        <input name="foo-empty-marker"\n+               type="hidden"\n+               tal:attributes="\n+                 name string:${view/name}-empty-marker;\n+               "\n+        />\n+        <span id="toDataContainer"\n+              style="display: none"\n+              tal:attributes="\n+                id string:${view/id}-toDataContainer;\n+              "\n+        >\n+          <script type="text/javascript"\n+                  tal:content="string:copyDataForSubmit(\'${view/id}\');"\n+          >\n           /*  <![CDATA[ */\n           // initial copying of field "field.to" --> "field"\n           copyDataForSubmit("<i tal:replace="${view/id}"/>");\n           /* ]]> */\n-        </script>\n-      </span>\n-    </td>\n-    <td>\n-      <button\n-          onclick="javascript:moveUp()" class="btn btn-sm btn-outline-secondary"\n-          name="upButton" type="button" value="&uarr;"\n-          tal:attributes="onClick string:javascript:moveUp(\'${view/id}\')"\n-          >&uarr;</button>\n-      <br />\n-      <button\n-          onclick="javascript:moveDown()" class="btn btn-sm btn-outline-secondary"\n-          name="downButton" type="button" value="&darr;"\n-          tal:attributes="onClick string:javascript:moveDown(\'${view/id}\')"\n-          >&darr;</button>\n-    </td>\n-  </tr>\n-</table>\n+          </script>\n+        </span>\n+      </td>\n+      <td>\n+        <button class="btn btn-sm btn-outline-secondary"\n+                name="upButton"\n+                onclick="javascript:moveUp()"\n+                type="button"\n+                value="&uarr;"\n+                tal:attributes="\n+                  onClick string:javascript:moveUp(\'${view/id}\');\n+                "\n+        >&uarr;</button>\n+        <br />\n+        <button class="btn btn-sm btn-outline-secondary"\n+                name="downButton"\n+                onclick="javascript:moveDown()"\n+                type="button"\n+                value="&darr;"\n+                tal:attributes="\n+                  onClick string:javascript:moveDown(\'${view/id}\');\n+                "\n+        >&darr;</button>\n+      </td>\n+    </tr>\n+  </table>\n </html>\ndiff --git a/plone/app/z3cform/templates/password_input.pt b/plone/app/z3cform/templates/password_input.pt\nindex cc59c668..041533c8 100644\n--- a/plone/app/z3cform/templates/password_input.pt\n+++ b/plone/app/z3cform/templates/password_input.pt\n@@ -1,36 +1,48 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<input id="" name="" class="" title="" lang="" disabled=""\n-       readonly="" alt="" tabindex="" accesskey="" size="" maxlength=""\n-       type="password"\n-       tal:attributes="id view/id;\n-                       name view/name;\n-                       class python:\'form-control {0}{1}\'.format(view.klass, view.error and \' is-invalid\' or \'\');\n-                       style view/style;\n-                       title view/title;\n-                       lang view/lang;\n-                       onclick view/onclick;\n-                       ondblclick view/ondblclick;\n-                       onmousedown view/onmousedown;\n-                       onmouseup view/onmouseup;\n-                       onmouseover view/onmouseover;\n-                       onmousemove view/onmousemove;\n-                       onmouseout view/onmouseout;\n-                       onkeypress view/onkeypress;\n-                       onkeydown view/onkeydown;\n-                       onkeyup view/onkeyup;\n-                       disabled view/disabled;\n-                       tabindex view/tabindex;\n-                       onfocus view/onfocus;\n-                       onblur view/onblur;\n-                       onchange view/onchange;\n-                       readonly view/readonly;\n-                       alt view/alt;\n-                       accesskey view/accesskey;\n-                       onselect view/onselect;\n-                       size view/size;\n-                       maxlength view/maxlength;\n-                       placeholder view/placeholder;\n-                       autocapitalize view/autocapitalize;" />\n+      tal:omit-tag=""\n+>\n+  <input class=""\n+         id=""\n+         accesskey=""\n+         alt=""\n+         lang=""\n+         maxlength=""\n+         name=""\n+         size=""\n+         tabindex=""\n+         title=""\n+         type="password"\n+         tal:attributes="\n+           id view/id;\n+           name view/name;\n+           class python:\'form-control {0}{1}\'.format(view.klass, view.error and \' is-invalid\' or \'\');\n+           style view/style;\n+           title view/title;\n+           lang view/lang;\n+           onclick view/onclick;\n+           ondblclick view/ondblclick;\n+           onmousedown view/onmousedown;\n+           onmouseup view/onmouseup;\n+           onmouseover view/onmouseover;\n+           onmousemove view/onmousemove;\n+           onmouseout view/onmouseout;\n+           onkeypress view/onkeypress;\n+           onkeydown view/onkeydown;\n+           onkeyup view/onkeyup;\n+           disabled view/disabled;\n+           tabindex view/tabindex;\n+           onfocus view/onfocus;\n+           onblur view/onblur;\n+           onchange view/onchange;\n+           readonly view/readonly;\n+           alt view/alt;\n+           accesskey view/accesskey;\n+           onselect view/onselect;\n+           size view/size;\n+           maxlength view/maxlength;\n+           placeholder view/placeholder;\n+           autocapitalize view/autocapitalize;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/radio_input.pt b/plone/app/z3cform/templates/radio_input.pt\nindex d32945a2..a2582f7a 100644\n--- a/plone/app/z3cform/templates/radio_input.pt\n+++ b/plone/app/z3cform/templates/radio_input.pt\n@@ -1,10 +1,25 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<div class="form-check" tal:repeat="item view/items">\n-    <input class="form-check-input" tal:replace="structure python:view.renderForValue(item[\'value\'])" />\n-    <label class="form-check-label" tal:attributes="for item/id" tal:content="item/label">Label</label>\n-</div>\n-<input name="field-empty-marker" type="hidden" value="1"\n-       tal:attributes="name string:${view/name}-empty-marker" />\n+      tal:omit-tag=""\n+>\n+  <div class="form-check"\n+       tal:repeat="item view/items"\n+  >\n+    <input class="form-check-input"\n+           tal:replace="structure python:view.renderForValue(item[\'value\'])"\n+    />\n+    <label class="form-check-label"\n+           tal:content="item/label"\n+           tal:attributes="\n+             for item/id;\n+           "\n+    >Label</label>\n+  </div>\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/radio_input_single.pt b/plone/app/z3cform/templates/radio_input_single.pt\nindex e0b5f898..077aecc0 100644\n--- a/plone/app/z3cform/templates/radio_input_single.pt\n+++ b/plone/app/z3cform/templates/radio_input_single.pt\n@@ -1,37 +1,50 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:define="item python:args[0]"\n-      tal:omit-tag="">\n-  <input id="" name="" class="" alt="" title=""\n-         tabindex="" disabled="" readonly="" accesskey="" value=""\n-         checked="" type="radio"\n-         tal:define="checked item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect;\n-                         checked python: checked and \'checked\' or None"\n-         />\n+      tal:define="\n+        item python:args[0];\n+      "\n+      tal:omit-tag=""\n+>\n+  <input class=""\n+         id=""\n+         accesskey=""\n+         alt=""\n+         name=""\n+         tabindex=""\n+         title=""\n+         type="radio"\n+         value=""\n+         tal:define="\n+           checked item/checked;\n+         "\n+         tal:attributes="\n+           id item/id;\n+           name item/name;\n+           class string:form-check-input ${view/klass};\n+           value item/value;\n+           style view/style;\n+           title view/title;\n+           lang view/lang;\n+           onclick view/onclick;\n+           ondblclick view/ondblclick;\n+           onmousedown view/onmousedown;\n+           onmouseup view/onmouseup;\n+           onmouseover view/onmouseover;\n+           onmousemove view/onmousemove;\n+           onmouseout view/onmouseout;\n+           onkeypress view/onkeypress;\n+           onkeydown view/onkeydown;\n+           onkeyup view/onkeyup;\n+           disabled view/disabled;\n+           tabindex view/tabindex;\n+           onfocus view/onfocus;\n+           onblur view/onblur;\n+           onchange view/onchange;\n+           readonly view/readonly;\n+           alt view/alt;\n+           accesskey view/accesskey;\n+           onselect view/onselect;\n+           checked python: checked and \'checked\' or None;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/relateditems_display.pt b/plone/app/z3cform/templates/relateditems_display.pt\nindex 23ee643f..930dc572 100644\n--- a/plone/app/z3cform/templates/relateditems_display.pt\n+++ b/plone/app/z3cform/templates/relateditems_display.pt\n@@ -1,41 +1,58 @@\n-<span id="form-widgets-fieldname"\n-      class="relateditems-widget textline-field"\n-      i18n:domain="plone"\n-      tal:define="plone_view nocall:context/@@plone;\n-                  normalizeString python:plone_view.normalizeString;\n-                  items python: view.items();\n-                  "\n+<span class="relateditems-widget textline-field"\n+      id="form-widgets-fieldname"\n+      tal:define="\n+        plone_view nocall:context/@@plone;\n+        normalizeString python:plone_view.normalizeString;\n+        items python: view.items();\n+      "\n       tal:condition="items"\n-      tal:attributes="id python:\'form-widgets-{}\'.format(view.__name__);\n-                      class python: \'relateditems-widget {}-field\'.format(normalizeString(view.field.__class__.__name__));\n-                      ">\n-    <div>\n-        <ul>\n-          <li tal:repeat="item items">\n-            <span tal:define="item_type           python:item.portal_type;\n-                              item_type_class     python:item.ContentTypeClass();\n-                              item_wf_state_class python:item.ReviewStateClass();\n-                              appendViewAction    python:item.appendViewAction();\n-                              item_url            python:item.getURL();\n-                              item_url            python:item_url+\'/view\' if appendViewAction else item_url;"\n-                  tal:attributes="title item_type">\n+      tal:attributes="\n+        id python:\'form-widgets-{}\'.format(view.__name__);\n+        class python: \'relateditems-widget {}-field\'.format(normalizeString(view.field.__class__.__name__));\n+      "\n+      i18n:domain="plone"\n+>\n+  <div>\n+    <ul>\n+      <li tal:repeat="item items">\n+        <span tal:define="\n+                item_type           python:item.portal_type;\n+                item_type_class     python:item.ContentTypeClass();\n+                item_wf_state_class python:item.ReviewStateClass();\n+                appendViewAction    python:item.appendViewAction();\n+                item_url            python:item.getURL();\n+                item_url            python:item_url+\'/view\' if appendViewAction else item_url;\n+              "\n+              tal:attributes="\n+                title item_type;\n+              "\n+        >\n \n-              <a tal:attributes="href item_url">\n-                <img class="mime-icon"\n-                     tal:condition="python:item_type ==\'File\'"\n-                     tal:attributes="src python:item.MimeTypeIcon();">\n+          <a tal:attributes="\n+               href item_url;\n+             ">\n+            <img class="mime-icon"\n+                 tal:condition="python:item_type ==\'File\'"\n+                 tal:attributes="\n+                   src python:item.MimeTypeIcon();\n+                 "\n+            />\n \n-                <span tal:attributes="class string:$item_type_class $item_wf_state_class url;"\n-                      tal:content="python:item.Title()">\n+            <span tal:content="python:item.Title()"\n+                  tal:attributes="\n+                    class string:$item_type_class $item_wf_state_class url;\n+                  "\n+            >\n                     Title\n-                </span>\n-                <span class="discreet"\n-                      tal:content="python:item.Description()">\n+            </span>\n+            <span class="discreet"\n+                  tal:content="python:item.Description()"\n+            >\n                     Description\n-                </span>\n-              </a>\n             </span>\n-          </li>\n-        </ul>\n-    </div>\n+          </a>\n+        </span>\n+      </li>\n+    </ul>\n+  </div>\n </span>\ndiff --git a/plone/app/z3cform/templates/select_input.pt b/plone/app/z3cform/templates/select_input.pt\nindex 45179d9a..e5716936 100644\n--- a/plone/app/z3cform/templates/select_input.pt\n+++ b/plone/app/z3cform/templates/select_input.pt\n@@ -1,44 +1,63 @@\n <div xmlns="http://www.w3.org/1999/xhtml"\n      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     tal:omit-tag="">\n-<select id="" name="" class="" tabindex="" disabled="" multiple="" size=""\n-        tal:attributes="id view/id;\n-                        name string:${view/name}:list;\n-                        required python:view.required and \'required\' or None;\n-                        class string:form-select ${view/klass};\n-                        style view/style;\n-                        title view/title;\n-                        lang view/lang;\n-                        onclick view/onclick;\n-                        ondblclick view/ondblclick;\n-                        onmousedown view/onmousedown;\n-                        onmouseup view/onmouseup;\n-                        onmouseover view/onmouseover;\n-                        onmousemove view/onmousemove;\n-                        onmouseout view/onmouseout;\n-                        onkeypress view/onkeypress;\n-                        onkeydown view/onkeydown;\n-                        onkeyup view/onkeyup;\n-                        disabled view/disabled;\n-                        tabindex view/tabindex;\n-                        onfocus view/onfocus;\n-                        onblur view/onblur;\n-                        onchange view/onchange;\n-                        multiple view/multiple;\n-                        size view/size">\n-<tal:block repeat="item view/items"\n-  ><option id="" value="" selected="selected"\n-         tal:condition="item/selected"\n-         tal:attributes="id item/id;\n-                         value item/value"\n-         tal:content="item/content">label</option\n-  ><option id="" value=""\n-         tal:condition="not:item/selected"\n-         tal:attributes="id item/id;\n-                         value item/value"\n-         tal:content="item/content">label</option\n-></tal:block>\n-</select>\n-<input name="field-empty-marker" type="hidden" value="1"\n-       tal:attributes="name string:${view/name}-empty-marker" />\n+     tal:omit-tag=""\n+>\n+  <select class=""\n+          id=""\n+          name=""\n+          size=""\n+          tabindex=""\n+          tal:attributes="\n+            id view/id;\n+            name string:${view/name}:list;\n+            required python:view.required and \'required\' or None;\n+            class string:form-select ${view/klass};\n+            style view/style;\n+            title view/title;\n+            lang view/lang;\n+            onclick view/onclick;\n+            ondblclick view/ondblclick;\n+            onmousedown view/onmousedown;\n+            onmouseup view/onmouseup;\n+            onmouseover view/onmouseover;\n+            onmousemove view/onmousemove;\n+            onmouseout view/onmouseout;\n+            onkeypress view/onkeypress;\n+            onkeydown view/onkeydown;\n+            onkeyup view/onkeyup;\n+            disabled view/disabled;\n+            tabindex view/tabindex;\n+            onfocus view/onfocus;\n+            onblur view/onblur;\n+            onchange view/onchange;\n+            multiple view/multiple;\n+            size view/size;\n+          "\n+  >\n+    <tal:block repeat="item view/items"><option id=""\n+              selected="selected"\n+              value=""\n+              tal:condition="item/selected"\n+              tal:content="item/content"\n+              tal:attributes="\n+                id item/id;\n+                value item/value;\n+              "\n+      >label</option><option id=""\n+              value=""\n+              tal:condition="not:item/selected"\n+              tal:content="item/content"\n+              tal:attributes="\n+                id item/id;\n+                value item/value;\n+              "\n+      >label</option></tal:block>\n+  </select>\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </div>\ndiff --git a/plone/app/z3cform/templates/singlecheckbox.pt b/plone/app/z3cform/templates/singlecheckbox.pt\nindex 7ff53c5b..06e45d93 100644\n--- a/plone/app/z3cform/templates/singlecheckbox.pt\n+++ b/plone/app/z3cform/templates/singlecheckbox.pt\n@@ -1,28 +1,37 @@\n <!-- DEPRECATED -->\n-<div\n-   i18n:domain="plone"\n-   metal:define-macro="widget-wrapper"\n-   tal:define="widget nocall:context;\n-               hidden python:widget.mode == \'hidden\';\n-               error widget/error;\n-               error_class python:error and \' error\' or \'\';\n-               fieldname_class string:kssattr-fieldname-${widget/name};"\n-   tal:attributes="class string:field ${fieldname_class}${error_class};\n-                   data-fieldname widget/name;\n-                   id string:formfield-${widget/id};">\n-    <input type="text" tal:replace="structure widget/render"\n-           metal:define-slot="widget" />\n+<div metal:define-macro="widget-wrapper"\n+     tal:define="\n+       widget nocall:context;\n+       hidden python:widget.mode == \'hidden\';\n+       error widget/error;\n+       error_class python:error and \' error\' or \'\';\n+       fieldname_class string:kssattr-fieldname-${widget/name};\n+     "\n+     tal:attributes="\n+       class string:field ${fieldname_class}${error_class};\n+       data-fieldname widget/name;\n+       id string:formfield-${widget/id};\n+     "\n+     i18n:domain="plone"\n+>\n+  <input metal:define-slot="widget"\n+         type="text"\n+         tal:replace="structure widget/render"\n+  />\n \n-    <div class="formHelp"\n-        tal:define="description widget/field/description"\n-        i18n:translate=""\n-        tal:content="structure description"\n-        tal:condition="python:description and not hidden"\n-        >field description</div>\n+  <div class="formHelp"\n+       tal:define="\n+         description widget/field/description;\n+       "\n+       tal:condition="python:description and not hidden"\n+       tal:content="structure description"\n+       i18n:translate=""\n+  >field description</div>\n \n-    <div class="fieldErrorBox"\n-        tal:content="structure error/render|nothing">\n+  <div class="fieldErrorBox"\n+       tal:content="structure error/render|nothing"\n+  >\n         Error\n-    </div>\n+  </div>\n \n </div>\ndiff --git a/plone/app/z3cform/templates/singlecheckboxbool_display.pt b/plone/app/z3cform/templates/singlecheckboxbool_display.pt\nindex 11d8004b..4daf57d1 100644\n--- a/plone/app/z3cform/templates/singlecheckboxbool_display.pt\n+++ b/plone/app/z3cform/templates/singlecheckboxbool_display.pt\n@@ -1,21 +1,24 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-  <span tal:attributes="id view/id;\n-                        class view/klass;\n-                        style view/style;\n-                        title view/title;\n-                        lang view/lang;\n-                        onclick view/onclick;\n-                        ondblclick view/ondblclick;\n-                        onmousedown view/onmousedown;\n-                        onmouseup view/onmouseup;\n-                        onmouseover view/onmouseover;\n-                        onmousemove view/onmousemove;\n-                        onmouseout view/onmouseout;\n-                        onkeypress view/onkeypress;\n-                        onkeydown view/onkeydown;\n-                        onkeyup view/onkeyup">\n-    <span tal:content="python:view.displayValue[0] if view.displayValue else \'\'" />\n+      tal:omit-tag=""\n+>\n+  <span tal:attributes="\n+          id view/id;\n+          class view/klass;\n+          style view/style;\n+          title view/title;\n+          lang view/lang;\n+          onclick view/onclick;\n+          ondblclick view/ondblclick;\n+          onmousedown view/onmousedown;\n+          onmouseup view/onmouseup;\n+          onmouseover view/onmouseover;\n+          onmousemove view/onmousemove;\n+          onmouseout view/onmouseout;\n+          onkeypress view/onkeypress;\n+          onkeydown view/onkeydown;\n+          onkeyup view/onkeyup;\n+        ">\n+    <span tal:content="python:view.displayValue[0] if view.displayValue else \'\'"></span>\n   </span>\n </html>\ndiff --git a/plone/app/z3cform/templates/singlecheckboxbool_hidden.pt b/plone/app/z3cform/templates/singlecheckboxbool_hidden.pt\nindex df70d83b..b95bc0e2 100644\n--- a/plone/app/z3cform/templates/singlecheckboxbool_hidden.pt\n+++ b/plone/app/z3cform/templates/singlecheckboxbool_hidden.pt\n@@ -1,36 +1,46 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     tal:omit-tag="">\n-<span class="option"\n-      tal:repeat="item view/items">\n-  <input id="" name="" value="" class="hidden-widget" title=""\n-         tabindex="" accesskey=""\n-         type="hidden"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         class view/klass;\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect" />\n-</span>\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      tal:omit-tag=""\n+>\n+  <span class="option"\n+        tal:repeat="item view/items"\n+  >\n+    <input class="hidden-widget"\n+           id=""\n+           accesskey=""\n+           name=""\n+           tabindex=""\n+           title=""\n+           type="hidden"\n+           value=""\n+           tal:attributes="\n+             id item/id;\n+             name item/name;\n+             class view/klass;\n+             value item/value;\n+             style view/style;\n+             title view/title;\n+             lang view/lang;\n+             onclick view/onclick;\n+             ondblclick view/ondblclick;\n+             onmousedown view/onmousedown;\n+             onmouseup view/onmouseup;\n+             onmouseover view/onmouseover;\n+             onmousemove view/onmousemove;\n+             onmouseout view/onmouseout;\n+             onkeypress view/onkeypress;\n+             onkeydown view/onkeydown;\n+             onkeyup view/onkeyup;\n+             disabled view/disabled;\n+             tabindex view/tabindex;\n+             onfocus view/onfocus;\n+             onblur view/onblur;\n+             onchange view/onchange;\n+             readonly view/readonly;\n+             alt view/alt;\n+             accesskey view/accesskey;\n+             onselect view/onselect;\n+           "\n+    />\n+  </span>\n </html>\ndiff --git a/plone/app/z3cform/templates/singlecheckboxbool_input.pt b/plone/app/z3cform/templates/singlecheckboxbool_input.pt\nindex 122e5da5..7f4bfcc2 100644\n--- a/plone/app/z3cform/templates/singlecheckboxbool_input.pt\n+++ b/plone/app/z3cform/templates/singlecheckboxbool_input.pt\n@@ -1,90 +1,129 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     tal:omit-tag=""\n-     tal:define="items view/items;\n-                 items python:list(items);\n-                 single_checkbox python:len(items) == 1">\n-<div tal:attributes="id view/id"\n-     tal:omit-tag="single_checkbox"\n-     tal:condition="python:len(items) > 0">\n- <div class="form-check"\n-       tal:repeat="item items"\n-       tal:attributes="id python:single_checkbox and view.id or None">\n-  <input type="checkbox" id="" name="" class="" alt="" title=""\n-         tabindex="" disabled="" readonly="" accesskey="" value=""\n-         checked="checked"\n-         tal:condition="item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         required python:view.required and \'required\' or None;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect"\n-  /><input id="" name="" class="" alt="" title="" tabindex=""\n-           disabled="" readonly="" accesskey="" value=""\n-           type="checkbox"\n-         tal:condition="not:item/checked"\n-         tal:attributes="id item/id;\n-                         name item/name;\n-                         required python:view.required and \'required\' or None;\n-                         class string:form-check-input ${view/klass};\n-                         value item/value;\n-                         style view/style;\n-                         title view/title;\n-                         lang view/lang;\n-                         onclick view/onclick;\n-                         ondblclick view/ondblclick;\n-                         onmousedown view/onmousedown;\n-                         onmouseup view/onmouseup;\n-                         onmouseover view/onmouseover;\n-                         onmousemove view/onmousemove;\n-                         onmouseout view/onmouseout;\n-                         onkeypress view/onkeypress;\n-                         onkeydown view/onkeydown;\n-                         onkeyup view/onkeyup;\n-                         disabled view/disabled;\n-                         tabindex view/tabindex;\n-                         onfocus view/onfocus;\n-                         onblur view/onblur;\n-                         onchange view/onchange;\n-                         readonly view/readonly;\n-                         alt view/alt;\n-                         accesskey view/accesskey;\n-                         onselect view/onselect" />\n-  <label for="" class="form-check-label"\n-         tal:attributes="for item/id">\n-    <span tal:content="item/label">Label</span>\n-    <span class="required horizontal"\n-          title="Required"\n-          tal:condition="item/required"\n-          i18n:attributes="title title_required;">&nbsp;</span>\n-  </label>\n-  <div class="form-text" tal:content="structure item/description">Description</div>\n- </div>\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      tal:define="\n+        items view/items;\n+        items python:list(items);\n+        single_checkbox python:len(items) == 1;\n+      "\n+      tal:omit-tag=""\n+>\n+  <div tal:condition="python:len(items) &gt; 0"\n+       tal:omit-tag="single_checkbox"\n+       tal:attributes="\n+         id view/id;\n+       "\n+  >\n+    <div class="form-check"\n+         tal:repeat="item items"\n+         tal:attributes="\n+           id python:single_checkbox and view.id or None;\n+         "\n+    >\n+      <input class=""\n+             id=""\n+             accesskey=""\n+             alt=""\n+             checked="checked"\n+             name=""\n+             tabindex=""\n+             title=""\n+             type="checkbox"\n+             value=""\n+             tal:condition="item/checked"\n+             tal:attributes="\n+               id item/id;\n+               name item/name;\n+               required python:view.required and \'required\' or None;\n+               class string:form-check-input ${view/klass};\n+               value item/value;\n+               style view/style;\n+               title view/title;\n+               lang view/lang;\n+               onclick view/onclick;\n+               ondblclick view/ondblclick;\n+               onmousedown view/onmousedown;\n+               onmouseup view/onmouseup;\n+               onmouseover view/onmouseover;\n+               onmousemove view/onmousemove;\n+               onmouseout view/onmouseout;\n+               onkeypress view/onkeypress;\n+               onkeydown view/onkeydown;\n+               onkeyup view/onkeyup;\n+               disabled view/disabled;\n+               tabindex view/tabindex;\n+               onfocus view/onfocus;\n+               onblur view/onblur;\n+               onchange view/onchange;\n+               readonly view/readonly;\n+               alt view/alt;\n+               accesskey view/accesskey;\n+               onselect view/onselect;\n+             "\n+      /><input class=""\n+             id=""\n+             accesskey=""\n+             alt=""\n+             name=""\n+             tabindex=""\n+             title=""\n+             type="checkbox"\n+             value=""\n+             tal:condition="not:item/checked"\n+             tal:attributes="\n+               id item/id;\n+               name item/name;\n+               required python:view.required and \'required\' or None;\n+               class string:form-check-input ${view/klass};\n+               value item/value;\n+               style view/style;\n+               title view/title;\n+               lang view/lang;\n+               onclick view/onclick;\n+               ondblclick view/ondblclick;\n+               onmousedown view/onmousedown;\n+               onmouseup view/onmouseup;\n+               onmouseover view/onmouseover;\n+               onmousemove view/onmousemove;\n+               onmouseout view/onmouseout;\n+               onkeypress view/onkeypress;\n+               onkeydown view/onkeydown;\n+               onkeyup view/onkeyup;\n+               disabled view/disabled;\n+               tabindex view/tabindex;\n+               onfocus view/onfocus;\n+               onblur view/onblur;\n+               onchange view/onchange;\n+               readonly view/readonly;\n+               alt view/alt;\n+               accesskey view/accesskey;\n+               onselect view/onselect;\n+             "\n+      />\n+      <label class="form-check-label"\n+             for=""\n+             tal:attributes="\n+               for item/id;\n+             "\n+      >\n+        <span tal:content="item/label">Label</span>\n+        <span class="required horizontal"\n+              title="Required"\n+              tal:condition="item/required"\n+              i18n:attributes="title title_required;"\n+        >&nbsp;</span>\n+      </label>\n+      <div class="form-text"\n+           tal:content="structure item/description"\n+      >Description</div>\n+    </div>\n \n-</div>\n+  </div>\n \n-<input name="field-empty-marker" type="hidden" value="1"\n-       tal:attributes="name string:${view/name}-empty-marker" />\n+  <input name="field-empty-marker"\n+         type="hidden"\n+         value="1"\n+         tal:attributes="\n+           name string:${view/name}-empty-marker;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/submit_input.pt b/plone/app/z3cform/templates/submit_input.pt\nindex 096ef1fe..bd74580b 100644\n--- a/plone/app/z3cform/templates/submit_input.pt\n+++ b/plone/app/z3cform/templates/submit_input.pt\n@@ -1,33 +1,39 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<button type="submit"\n-        tal:define="bsFallback python:\'btn-secondary \' if not \'btn-\' in view.klass else \'\'"\n-        tal:attributes="id view/id;\n-                        name view/name;\n-                        class string:btn ${bsFallback}${view/klass};\n-                        value view/value;\n-                        style view/style;\n-                        lang view/lang;\n-                        onclick view/onclick;\n-                        ondblclick view/ondblclick;\n-                        onmousedown view/onmousedown;\n-                        onmouseup view/onmouseup;\n-                        onmouseover view/onmouseover;\n-                        onmousemove view/onmousemove;\n-                        onmouseout view/onmouseout;\n-                        onkeypress view/onkeypress;\n-                        onkeydown view/onkeydown;\n-                        onkeyup view/onkeyup;\n-                        disabled view/disabled;\n-                        tabindex view/tabindex;\n-                        onfocus view/onfocus;\n-                        onblur view/onblur;\n-                        onchange view/onchange;\n-                        readonly view/readonly;\n-                        alt view/alt;\n-                        accesskey view/accesskey;\n-                        onselect view/onselect;\n-                        formnovalidate python:view.ignoreRequiredOnValidation or None"\n-        tal:content="view/value">value</button>\n+      tal:omit-tag=""\n+>\n+  <button type="submit"\n+          tal:define="\n+            bsFallback python:\'btn-secondary \' if not \'btn-\' in view.klass else \'\';\n+          "\n+          tal:content="view/value"\n+          tal:attributes="\n+            id view/id;\n+            name view/name;\n+            class string:btn ${bsFallback}${view/klass};\n+            value view/value;\n+            style view/style;\n+            lang view/lang;\n+            onclick view/onclick;\n+            ondblclick view/ondblclick;\n+            onmousedown view/onmousedown;\n+            onmouseup view/onmouseup;\n+            onmouseover view/onmouseover;\n+            onmousemove view/onmousemove;\n+            onmouseout view/onmouseout;\n+            onkeypress view/onkeypress;\n+            onkeydown view/onkeydown;\n+            onkeyup view/onkeyup;\n+            disabled view/disabled;\n+            tabindex view/tabindex;\n+            onfocus view/onfocus;\n+            onblur view/onblur;\n+            onchange view/onchange;\n+            readonly view/readonly;\n+            alt view/alt;\n+            accesskey view/accesskey;\n+            onselect view/onselect;\n+            formnovalidate python:view.ignoreRequiredOnValidation or None;\n+          "\n+  >value</button>\n </html>\ndiff --git a/plone/app/z3cform/templates/text_input.pt b/plone/app/z3cform/templates/text_input.pt\nindex 29b87259..0c53bbd6 100644\n--- a/plone/app/z3cform/templates/text_input.pt\n+++ b/plone/app/z3cform/templates/text_input.pt\n@@ -1,38 +1,52 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-    <input id="" name="" class="" title="" lang="" disabled=""\n-           readonly="" alt="" tabindex="" accesskey="" size="" maxlength=""\n-           style="" value="" type="text"\n-           tal:attributes="id view/id;\n-                           name view/name;\n-                           required python:view.required and \'required\' or None;\n-                           class python:\'form-control {0}{1}\'.format(view.klass, view.error and \' is-invalid\' or \'\');\n-                           style view/style;\n-                           title view/title;\n-                           lang view/lang;\n-                           onclick view/onclick;\n-                           ondblclick view/ondblclick;\n-                           onmousedown view/onmousedown;\n-                           onmouseup view/onmouseup;\n-                           onmouseover view/onmouseover;\n-                           onmousemove view/onmousemove;\n-                           onmouseout view/onmouseout;\n-                           onkeypress view/onkeypress;\n-                           onkeydown view/onkeydown;\n-                           onkeyup view/onkeyup;\n-                           value view/value;\n-                           disabled view/disabled;\n-                           tabindex view/tabindex;\n-                           onfocus view/onfocus;\n-                           onblur view/onblur;\n-                           onchange view/onchange;\n-                           readonly view/readonly;\n-                           alt view/alt;\n-                           accesskey view/accesskey;\n-                           onselect view/onselect;\n-                           size view/size;\n-                           maxlength view/maxlength;\n-                           placeholder view/placeholder;\n-                           autocapitalize view/autocapitalize" />\n+      tal:omit-tag=""\n+>\n+  <input class=""\n+         id=""\n+         accesskey=""\n+         alt=""\n+         lang=""\n+         maxlength=""\n+         name=""\n+         size=""\n+         style=""\n+         tabindex=""\n+         title=""\n+         type="text"\n+         value=""\n+         tal:attributes="\n+           id view/id;\n+           name view/name;\n+           required python:view.required and \'required\' or None;\n+           class python:\'form-control {0}{1}\'.format(view.klass, view.error and \' is-invalid\' or \'\');\n+           style view/style;\n+           title view/title;\n+           lang view/lang;\n+           onclick view/onclick;\n+           ondblclick view/ondblclick;\n+           onmousedown view/onmousedown;\n+           onmouseup view/onmouseup;\n+           onmouseover view/onmouseover;\n+           onmousemove view/onmousemove;\n+           onmouseout view/onmouseout;\n+           onkeypress view/onkeypress;\n+           onkeydown view/onkeydown;\n+           onkeyup view/onkeyup;\n+           value view/value;\n+           disabled view/disabled;\n+           tabindex view/tabindex;\n+           onfocus view/onfocus;\n+           onblur view/onblur;\n+           onchange view/onchange;\n+           readonly view/readonly;\n+           alt view/alt;\n+           accesskey view/accesskey;\n+           onselect view/onselect;\n+           size view/size;\n+           maxlength view/maxlength;\n+           placeholder view/placeholder;\n+           autocapitalize view/autocapitalize;\n+         "\n+  />\n </html>\ndiff --git a/plone/app/z3cform/templates/textarea_input.pt b/plone/app/z3cform/templates/textarea_input.pt\nindex 84939c50..51867b72 100644\n--- a/plone/app/z3cform/templates/textarea_input.pt\n+++ b/plone/app/z3cform/templates/textarea_input.pt\n@@ -1,35 +1,43 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<textarea\n-   id="" name="" class="" cols="" rows=""\n-   tabindex="" disabled="" readonly="" accesskey=""\n-   tal:attributes="id view/id;\n-                   name view/name;\n-\t\t   required python:view.required and \'required\' or None;\n-                   class string:form-control ${view/klass};\n-                   style view/style;\n-                   title view/title;\n-                   lang view/lang;\n-                   onclick view/onclick;\n-                   ondblclick view/ondblclick;\n-                   onmousedown view/onmousedown;\n-                   onmouseup view/onmouseup;\n-                   onmouseover view/onmouseover;\n-                   onmousemove view/onmousemove;\n-                   onmouseout view/onmouseout;\n-                   onkeypress view/onkeypress;\n-                   onkeydown view/onkeydown;\n-                   onkeyup view/onkeyup;\n-                   disabled view/disabled;\n-                   tabindex view/tabindex;\n-                   onfocus view/onfocus;\n-                   onblur view/onblur;\n-                   onchange view/onchange;\n-                   cols view/cols;\n-                   rows view/rows;\n-                   readonly view/readonly;\n-                   accesskey view/accesskey;\n-                   onselect view/onselect"\n-   tal:content="view/value" />\n+      tal:omit-tag=""\n+>\n+  <textarea class=""\n+            id=""\n+            accesskey=""\n+            cols=""\n+            name=""\n+            rows=""\n+            tabindex=""\n+            tal:content="view/value"\n+            tal:attributes="\n+              id view/id;\n+              name view/name;\n+              required python:view.required and \'required\' or None;\n+              class string:form-control ${view/klass};\n+              style view/style;\n+              title view/title;\n+              lang view/lang;\n+              onclick view/onclick;\n+              ondblclick view/ondblclick;\n+              onmousedown view/onmousedown;\n+              onmouseup view/onmouseup;\n+              onmouseover view/onmouseover;\n+              onmousemove view/onmousemove;\n+              onmouseout view/onmouseout;\n+              onkeypress view/onkeypress;\n+              onkeydown view/onkeydown;\n+              onkeyup view/onkeyup;\n+              disabled view/disabled;\n+              tabindex view/tabindex;\n+              onfocus view/onfocus;\n+              onblur view/onblur;\n+              onchange view/onchange;\n+              cols view/cols;\n+              rows view/rows;\n+              readonly view/readonly;\n+              accesskey view/accesskey;\n+              onselect view/onselect;\n+            "\n+  ></textarea>\n </html>\ndiff --git a/plone/app/z3cform/templates/textfield_widget_input.pt b/plone/app/z3cform/templates/textfield_widget_input.pt\nindex 512300bd..7115dead 100644\n--- a/plone/app/z3cform/templates/textfield_widget_input.pt\n+++ b/plone/app/z3cform/templates/textfield_widget_input.pt\n@@ -1,75 +1,94 @@\n-<div lang="en"\n-     xml:lang="en"\n-     xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     xmlns:metal="http://xml.zope.org/namespaces/metal"\n+<div xmlns="http://www.w3.org/1999/xhtml"\n      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+     xmlns:metal="http://xml.zope.org/namespaces/metal"\n+     xmlns:tal="http://xml.zope.org/namespaces/tal"\n+     lang="en"\n+     xml:lang="en"\n+     tal:attributes="\n+       class view/klass;\n+       style view/style;\n+       title view/title;\n+       lang view/lang;\n+       onclick view/onclick;\n+       ondblclick view/ondblclick;\n+       onmousedown view/onmousedown;\n+       onmouseup view/onmouseup;\n+       onmouseover view/onmouseover;\n+       onmousemove view/onmousemove;\n+       onmouseout view/onmouseout;\n+       onkeypress view/onkeypress;\n+       onkeydown view/onkeydown;\n+       onkeyup view/onkeyup;\n+     "\n      i18n:domain="plone"\n-     tal:attributes="class view/klass;\n-                     style view/style;\n-                     title view/title;\n-                     lang view/lang;\n-                     onclick view/onclick;\n-                     ondblclick view/ondblclick;\n-                     onmousedown view/onmousedown;\n-                     onmouseup view/onmouseup;\n-                     onmouseover view/onmouseover;\n-                     onmousemove view/onmousemove;\n-                     onmouseout view/onmouseout;\n-                     onkeypress view/onkeypress;\n-                     onkeydown view/onkeydown;\n-                     onkeyup view/onkeyup">\n+>\n \n-    <tal:define define="fieldName view/name;\n-                        mimeType view/value/mimeType | view/field/default_mime_type;\n-                        allowedMimeTypes view/allowedMimeTypes">\n+  <tal:define define="\n+                fieldName view/name;\n+                mimeType view/value/mimeType | view/field/default_mime_type;\n+                allowedMimeTypes view/allowedMimeTypes;\n+              ">\n \n-        <div class="fieldTextFormat" tal:condition="python: len(allowedMimeTypes) > 1">\n-            <label i18n:translate="label_text_format">Text Format</label>\n+    <div class="fieldTextFormat"\n+         tal:condition="python: len(allowedMimeTypes) &gt; 1"\n+    >\n+      <label i18n:translate="label_text_format">Text Format</label>\n \n-            <select class="form-control"\n-                    tal:attributes="id   string:${fieldName}_text_format;\n-                                    name string:${fieldName}.mimeType;">\n-                <option selected=""\n-                    tal:repeat="item allowedMimeTypes"\n-                    tal:attributes="selected python:item == mimeType and \'selected\' or None;\n-                                    value item;"\n-                    tal:content="item" />\n-            </select>\n-        </div>\n+      <select class="form-control"\n+              tal:attributes="\n+                id   string:${fieldName}_text_format;\n+                name string:${fieldName}.mimeType;\n+              "\n+      >\n+        <option selected\n+                tal:repeat="item allowedMimeTypes"\n+                tal:content="item"\n+                tal:attributes="\n+                  selected python:item == mimeType and \'selected\' or None;\n+                  value item;\n+                "\n+        ></option>\n+      </select>\n+    </div>\n \n-        <tal:hidden condition="python: len(allowedMimeTypes) == 1">\n-            <input type="hidden" tal:attributes="id string:${fieldName}_text_format;\n-                                                 name string:${fieldName}.mimeType;\n-                                                 value python:allowedMimeTypes[0]"/>\n-        </tal:hidden>\n-    </tal:define>\n+    <tal:hidden condition="python: len(allowedMimeTypes) == 1">\n+      <input type="hidden"\n+             tal:attributes="\n+               id string:${fieldName}_text_format;\n+               name string:${fieldName}.mimeType;\n+               value python:allowedMimeTypes[0];\n+             "\n+      />\n+    </tal:hidden>\n+  </tal:define>\n \n-    <tal:editor define="context            view/wrapped_context;\n-                        object             python:(not view.ignoreContext) and context or None;\n-                        here               nocall:context;\n-                        portal_url         nocall:context/portal_url;\n-                        portal             portal_url/getPortalObject;\n-                        text_format        view/value/mimeType | view/field/default_mime_type;\n-                        force_wysiwyg      python:True;\n-                        inputname          view/name;\n-                        inputvalue         view/value/raw | nothing;\n-                        here_url           request/getURL;\n-                        member context/portal_membership/getAuthenticatedMember;\n-                        isAnon context/@@plone_portal_state/anonymous;\n-                        member_editor python: not isAnon and member.getProperty(\'wysiwyg_editor\').lower() or \'\';\n-                        default_editor python: context.portal_properties.site_properties.getProperty(\'default_editor\', \'\').lower();\n-                        editor python: member_editor==\'\' and default_editor or member_editor;\n-                        support_path string:nocall:here/@@${editor}_wysiwyg_support|here/${editor}_wysiwyg_support|here/${editor}/wysiwyg_support|here/portal_skins/plone_wysiwyg/wysiwyg_support;\n-                        support python: path(support_path);\n-                        tabindex           nothing;\n-                        rows               python:view.rows or 25;\n-                        cols               python:view.cols or 80;\n-                        maxlength          python:view.field.max_length or None;\n-                        field              view/field;">\n-        <div metal:use-macro="support/macros/wysiwygEditorBox">\n+  <tal:editor define="\n+                context            view/wrapped_context;\n+                object             python:(not view.ignoreContext) and context or None;\n+                here               nocall:context;\n+                portal_url         nocall:context/portal_url;\n+                portal             portal_url/getPortalObject;\n+                text_format        view/value/mimeType | view/field/default_mime_type;\n+                force_wysiwyg      python:True;\n+                inputname          view/name;\n+                inputvalue         view/value/raw | nothing;\n+                here_url           request/getURL;\n+                member context/portal_membership/getAuthenticatedMember;\n+                isAnon context/@@plone_portal_state/anonymous;\n+                member_editor python: not isAnon and member.getProperty(\'wysiwyg_editor\').lower() or \'\';\n+                default_editor python: context.portal_properties.site_properties.getProperty(\'default_editor\', \'\').lower();\n+                editor python: member_editor==\'\' and default_editor or member_editor;\n+                support_path string:nocall:here/@@${editor}_wysiwyg_support|here/${editor}_wysiwyg_support|here/${editor}/wysiwyg_support|here/portal_skins/plone_wysiwyg/wysiwyg_support;\n+                support python: path(support_path);\n+                tabindex           nothing;\n+                rows               python:view.rows or 25;\n+                cols               python:view.cols or 80;\n+                maxlength          python:view.field.max_length or None;\n+                field              view/field;\n+              ">\n+    <div metal:use-macro="support/macros/wysiwygEditorBox">\n             The WYSIWYG code\n-        </div>\n-    </tal:editor>\n+    </div>\n+  </tal:editor>\n \n </div>\ndiff --git a/plone/app/z3cform/templates/textlines_input.pt b/plone/app/z3cform/templates/textlines_input.pt\nindex 0bda236e..5778baac 100644\n--- a/plone/app/z3cform/templates/textlines_input.pt\n+++ b/plone/app/z3cform/templates/textlines_input.pt\n@@ -1,34 +1,42 @@\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      tal:omit-tag="">\n-<textarea\n-    id="" name="" class="" cols="" rows=""\n-    tabindex="" disabled="" readonly="" accesskey=""\n-    tal:attributes="id view/id;\n-                    name view/name;\n-                    class string:form-control ${view/klass};\n-                    style view/style;\n-                    title view/title;\n-                    lang view/lang;\n-                    onclick view/onclick;\n-                    ondblclick view/ondblclick;\n-                    onmousedown view/onmousedown;\n-                    onmouseup view/onmouseup;\n-                    onmouseover view/onmouseover;\n-                    onmousemove view/onmousemove;\n-                    onmouseout view/onmouseout;\n-                    onkeypress view/onkeypress;\n-                    onkeydown view/onkeydown;\n-                    onkeyup view/onkeyup;\n-                    disabled view/disabled;\n-                    tabindex view/tabindex;\n-                    onfocus view/onfocus;\n-                    onblur view/onblur;\n-                    onchange view/onchange;\n-                    cols view/cols;\n-                    rows view/rows;\n-                    readonly view/readonly;\n-                    accesskey view/accesskey;\n-                    onselect view/onselect"\n-    tal:content="structure view/value" />\n+      tal:omit-tag=""\n+>\n+  <textarea class=""\n+            id=""\n+            accesskey=""\n+            cols=""\n+            name=""\n+            rows=""\n+            tabindex=""\n+            tal:content="structure view/value"\n+            tal:attributes="\n+              id view/id;\n+              name view/name;\n+              class string:form-control ${view/klass};\n+              style view/style;\n+              title view/title;\n+              lang view/lang;\n+              onclick view/onclick;\n+              ondblclick view/ondblclick;\n+              onmousedown view/onmousedown;\n+              onmouseup view/onmouseup;\n+              onmouseover view/onmouseover;\n+              onmousemove view/onmousemove;\n+              onmouseout view/onmouseout;\n+              onkeypress view/onkeypress;\n+              onkeydown view/onkeydown;\n+              onkeyup view/onkeyup;\n+              disabled view/disabled;\n+              tabindex view/tabindex;\n+              onfocus view/onfocus;\n+              onblur view/onblur;\n+              onchange view/onchange;\n+              cols view/cols;\n+              rows view/rows;\n+              readonly view/readonly;\n+              accesskey view/accesskey;\n+              onselect view/onselect;\n+            "\n+  ></textarea>\n </html>\ndiff --git a/plone/app/z3cform/templates/widget.pt b/plone/app/z3cform/templates/widget.pt\nindex 4b266a73..873ebfe7 100644\n--- a/plone/app/z3cform/templates/widget.pt\n+++ b/plone/app/z3cform/templates/widget.pt\n@@ -1,43 +1,58 @@\n-<div\n-   metal:define-macro="widget-wrapper"\n-   i18n:domain="plone"\n-   tal:define="widget nocall:context;\n-               error python:widget.error;\n-               error_class python:error and \' error\' or \'\';\n-               empty_values python: (None, \'\', [], (\'\', \'\', \'\', \'00\', \'00\', \'\'), (\'\', \'\', \'\'));\n-               empty_class python: (widget.value in empty_values) and \' empty\' or \'\';\n-               "\n-   id="formfield-${python:widget.id}"\n-   class="mb-3 field fieldname-${python:widget.name} widget-mode-${python:widget.mode}${error_class}${empty_class} ${python:getattr(widget, \'wrapper_css_class\', False) or False}"\n-   data-fieldname="${widget/name}">\n-    <label for="${python:widget.id}"\n-           class="form-label"\n-           tal:condition="python: widget.mode == \'input\' and widget.label">\n-        <span i18n:translate="" tal:replace="python:widget.label">label</span>\n+<div class="mb-3 field fieldname-${python:widget.name} widget-mode-${python:widget.mode}${error_class}${empty_class} ${python:getattr(widget, \'wrapper_css_class\', False) or False}"\n+     id="formfield-${python:widget.id}"\n+     metal:define-macro="widget-wrapper"\n+     data-fieldname="${widget/name}"\n+     tal:define="\n+       widget nocall:context;\n+       error python:widget.error;\n+       error_class python:error and \' error\' or \'\';\n+       empty_values python: (None, \'\', [], (\'\', \'\', \'\', \'00\', \'00\', \'\'), (\'\', \'\', \'\'));\n+       empty_class python: (widget.value in empty_values) and \' empty\' or \'\';\n+     "\n+     i18n:domain="plone"\n+>\n+  <label class="form-label"\n+         for="${python:widget.id}"\n+         tal:condition="python: widget.mode == \'input\' and widget.label"\n+  >\n+    <span tal:replace="python:widget.label"\n+          i18n:translate=""\n+    >label</span>\n \n-        <span class="required" title="Required"\n-              tal:condition="python:widget.required"\n-              i18n:attributes="title title_required;"></span>\n-    </label>\n-    <b class="widget-label form-label d-block"\n-          tal:condition="python: widget.mode == \'display\' and widget.label">\n-        <span i18n:translate="" tal:replace="python:widget.label">label</span>\n-    </b>\n+    <span class="required"\n+          title="Required"\n+          tal:condition="python:widget.required"\n+          i18n:attributes="title title_required;"\n+    ></span>\n+  </label>\n+  <b class="widget-label form-label d-block"\n+     tal:condition="python: widget.mode == \'display\' and widget.label"\n+  >\n+    <span tal:replace="python:widget.label"\n+          i18n:translate=""\n+    >label</span>\n+  </b>\n \n-    <input type="text" tal:replace="structure python:widget.render()"\n-           metal:define-slot="widget" />\n+  <input metal:define-slot="widget"\n+         type="text"\n+         tal:replace="structure python:widget.render()"\n+  />\n \n-    <div tal:define="description python: getattr(widget, \'description\', widget.field.description)"\n-           i18n:translate=""\n-           tal:content="structure description"\n-           tal:condition="python:description and widget.mode == \'input\'"\n-           class="form-text">\n+  <div class="form-text"\n+       tal:define="\n+         description python: getattr(widget, \'description\', widget.field.description);\n+       "\n+       tal:condition="python:description and widget.mode == \'input\'"\n+       tal:content="structure description"\n+       i18n:translate=""\n+  >\n       help text\n-    </div>\n+  </div>\n \n-    <div tal:condition="error"\n-         tal:replace="structure python:error.render() or False">\n+  <div tal:condition="error"\n+       tal:replace="structure python:error.render() or False"\n+  >\n         Error\n-    </div>\n+  </div>\n \n </div>\ndiff --git a/plone/app/z3cform/tests/test_utils.py b/plone/app/z3cform/tests/test_utils.py\nindex 91ca2f36..70420a63 100644\n--- a/plone/app/z3cform/tests/test_utils.py\n+++ b/plone/app/z3cform/tests/test_utils.py\n@@ -136,7 +136,7 @@ def test_is_same_domain(self):\n             )\n         )\n \n-        # These are two completly different URLs\n+        # These are two completely different URLs\n         self.assertTrue(\n             not is_same_domain(\n                 "https://domain1.com",\ndiff --git a/plone/app/z3cform/tests/test_widget.py b/plone/app/z3cform/tests/test_widget.py\nindex 008d63e1..a8af2595 100644\n--- a/plone/app/z3cform/tests/test_widget.py\n+++ b/plone/app/z3cform/tests/test_widget.py\n@@ -23,7 +23,6 @@ class NoAcquisitionAware:\n \n \n class TestWidget(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -31,7 +30,7 @@ def setUp(self):\n         setRequest(self.request)\n \n     def test_missing_aq_chain(self):\n-        # testing support for contents witout Acquisiion chain (for avoid\n+        # testing support for contents without Acquisition chain (for avoid\n         # regression)\n         # See\n         # https://github.com/plone/plone.app.z3cform/commit/587e229e267705a4fd48c6c51a76f849196fceba#commitcomment-2630299\ndiff --git a/plone/app/z3cform/tests/test_widgets.py b/plone/app/z3cform/tests/test_widgets.py\nindex 726b7c0f..dea25970 100644\n--- a/plone/app/z3cform/tests/test_widgets.py\n+++ b/plone/app/z3cform/tests/test_widgets.py\n@@ -13,12 +13,12 @@\n from plone.app.z3cform.widget import RelatedItemsWidget\n from plone.autoform.directives import widget\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base.interfaces import IMarkupSchema\n from plone.dexterity.fti import DexterityFTI\n from plone.registry.interfaces import IRegistry\n from plone.supermodel.model import Schema\n from plone.testing.zca import UNIT_TESTING\n from plone.uuid.interfaces import IUUID\n-from plone.base.interfaces import IMarkupSchema\n from unittest import mock\n from unittest.mock import Mock\n from z3c.form.form import EditForm\n@@ -193,7 +193,6 @@ def setUp(self):\n         self.widget.pattern_options = {"date": {"firstDay": 0}}\n \n     def test_widget(self):\n-        current_year = datetime.today().year\n         self.assertEqual(\n             {\n                 "name": None,\n@@ -265,7 +264,7 @@ def test_fieldwidget(self):\n \n     def test_dateformatter(self):\n         self.widget.value = "2022-08-17"\n-        self.assertIn(" value=\\"2022-08-17\\" ", self.widget.render())\n+        self.assertIn(\' value="2022-08-17" \', self.widget.render())\n \n         self.widget.mode = "display"\n         self.assertEqual("8/17/22", self.widget.render())\n@@ -279,7 +278,7 @@ def test_dateformatter(self):\n         self.widget._formater_length = "full"\n         self.assertEqual("Wednesday, August 17, 2022", self.widget.render())\n \n-        # unknown formater length\n+        # unknown formatter length\n         self.widget._formater_length = "foo"\n         with self.assertRaises(ValueError):\n             self.widget.render()\n@@ -300,7 +299,6 @@ def setUp(self):\n         }\n \n     def test_widget(self):\n-        current_year = datetime.today().year\n         self.assertEqual(\n             {\n                 "name": None,\n@@ -440,7 +438,7 @@ def test_fieldwidget(self):\n \n     def test_datetimeformatter(self):\n         self.widget.value = "2022-08-17T12:00"\n-        self.assertIn(" value=\\"2022-08-17T12:00\\" ", self.widget.render())\n+        self.assertIn(\' value="2022-08-17T12:00" \', self.widget.render())\n \n         self.widget.mode = "display"\n         self.assertEqual("8/17/22 12:00 PM", self.widget.render())\n@@ -452,9 +450,11 @@ def test_datetimeformatter(self):\n         self.assertEqual("August 17, 2022 12:00:00 PM +000", self.widget.render())\n \n         self.widget._formater_length = "full"\n-        self.assertEqual("Wednesday, August 17, 2022 12:00:00 PM +000", self.widget.render())\n+        self.assertEqual(\n+            "Wednesday, August 17, 2022 12:00:00 PM +000", self.widget.render()\n+        )\n \n-        # unknown formater length\n+        # unknown formatter length\n         self.widget._formater_length = "foo"\n         with self.assertRaises(ValueError):\n             self.widget.render()\n@@ -877,7 +877,6 @@ def test_widget_optgroup(self):\n \n \n class AjaxSelectWidgetTests(unittest.TestCase):\n-\n     layer = UNIT_TESTING\n     maxDiff = None\n \n@@ -1153,7 +1152,6 @@ def test_fieldwidget_sequence(self):\n \n \n class AjaxSelectWidgetIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1234,7 +1232,6 @@ def test_widget(self):\n \n \n class RelatedItemsWidgetIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1324,7 +1321,6 @@ class IRelationsType(Interface):\n \n \n class RelatedItemsWidgetTemplateIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1375,7 +1371,7 @@ def test_related_items_widget_display_template(self):\n         self.assertTrue(template.filename.endswith("relateditems_display.pt"))\n         html = template(single)\n         self.assertIn(\n-            \'<span class="contenttype-relationstype state-missing-value url">A Target</span>\',\n+            \'<span class="contenttype-relationstype state-missing-value url" >A Target</span>\',\n             html,\n         )\n \n@@ -1395,11 +1391,11 @@ def test_related_items_widget_display_template(self):\n         self.assertTrue(template.filename.endswith("relateditems_display.pt"))\n         html = template(multiple)\n         self.assertIn(\n-            \'<span class="contenttype-relationstype state-missing-value url">A Target</span>\',\n+            \'<span class="contenttype-relationstype state-missing-value url" >A Target</span>\',\n             html,\n         )\n         self.assertIn(\n-            \'<span class="contenttype-document state-missing-value url">A Document</span>\',\n+            \'<span class="contenttype-document state-missing-value url" >A Document</span>\',\n             html,\n         )\n \n@@ -1597,7 +1593,6 @@ def _custom_field_widget(field, request):\n \n \n class RichTextWidgetTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1803,7 +1798,6 @@ def test_use_default_editor_value(self):\n \n \n class LinkWidgetIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def setUp(self):\n@@ -1956,22 +1950,19 @@ def test_link_widget__data_converter(self):\n \n \n class WidgetCustomizingIntegrationTests(unittest.TestCase):\n-\n     layer = PAZ3CForm_INTEGRATION_TESTING\n \n     def test_widget_base_wrapper_css(self):\n         class ITestDateSchema(Schema):\n-\n             widget("my_date", DateWidget, wrapper_css_class="foo")\n             my_date = Date(title="My Date")\n \n         class TestForm(AutoExtensibleForm, EditForm):\n-\n             ignoreContext = True\n             schema = ITestDateSchema\n \n         render = TestForm(self.layer["portal"], self.layer["request"])\n         self.assertIn(\n-            \'empty foo" data-fieldname="form.widgets.my_date"\',\n+            \'empty foo" id="formfield-form-widgets-my_date" data-fieldname="form.widgets.my_date"\',\n             render(),\n         )\ndiff --git a/plone/app/z3cform/tests/testing.zcml b/plone/app/z3cform/tests/testing.zcml\nindex 22c27be3..f706b0c0 100644\n--- a/plone/app/z3cform/tests/testing.zcml\n+++ b/plone/app/z3cform/tests/testing.zcml\n@@ -2,30 +2,34 @@\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:browser="http://namespaces.zope.org/browser"\n     xmlns:i18n="http://namespaces.zope.org/i18n"\n-    i18n_domain="plone">\n+    i18n_domain="plone"\n+    >\n \n-    <browser:page\n-        name="test-form"\n-        for="*"\n-        class=".example.MyFormWrapper"\n-        permission="zope.Public" />\n+  <browser:page\n+      name="test-form"\n+      for="*"\n+      class=".example.MyFormWrapper"\n+      permission="zope.Public"\n+      />\n \n-    <browser:page\n-        name="test-group-form"\n-        for="*"\n-        class=".example.MyGroupFormWrapper"\n-        permission="zope.Public" />\n+  <browser:page\n+      name="test-group-form"\n+      for="*"\n+      class=".example.MyGroupFormWrapper"\n+      permission="zope.Public"\n+      />\n \n-    <browser:page\n-        name="test-multi-form"\n-        for="*"\n-        class=".example.MyMultiFormWrapper"\n-        permission="zope.Public" />\n+  <browser:page\n+      name="test-multi-form"\n+      for="*"\n+      class=".example.MyMultiFormWrapper"\n+      permission="zope.Public"\n+      />\n \n-    <utility\n-       component=".example.dummy_richtextwidget_render"\n-       provides="..interfaces.IRichTextWidgetInputModeRenderer"\n-       name="dummy"\n-       />\n+  <utility\n+      provides="..interfaces.IRichTextWidgetInputModeRenderer"\n+      name="dummy"\n+      component=".example.dummy_richtextwidget_render"\n+      />\n \n </configure>\ndiff --git a/plone/app/z3cform/utils.py b/plone/app/z3cform/utils.py\nindex f420d87e..bf2bed63 100644\n--- a/plone/app/z3cform/utils.py\n+++ b/plone/app/z3cform/utils.py\n@@ -8,7 +8,7 @@\n \n \n def closest_content(context=None):\n-    """Try to find a usable context, with increasing agression"""\n+    """Try to find a usable context, with increasing aggression"""\n     # Normally, we should be given a useful context (e.g the page)\n     c = context\n     c = _valid_context(c)\ndiff --git a/plone/app/z3cform/widget.py b/plone/app/z3cform/widget.py\nindex 95e89cb2..28d15706 100644\n--- a/plone/app/z3cform/widget.py\n+++ b/plone/app/z3cform/widget.py\n@@ -13,7 +13,6 @@\n from plone.app.widgets.base import TextareaWidget\n from plone.app.widgets.utils import get_context_url\n from plone.app.widgets.utils import get_date_options\n-from plone.app.widgets.utils import get_datetime_options\n from plone.app.widgets.utils import get_querystring_options\n from plone.app.widgets.utils import get_relateditems_options\n from plone.app.widgets.utils import get_tinymce_options\n@@ -139,6 +138,7 @@ class DateWidget(BaseWidget, z3cform_TextWidget):\n     The default_timezone and default_time arguments are only used if a datewidget is\n     used on a datetime field. If used on a date field they are ignored.\n     """\n+\n     _base_type = "date"\n     _converter = DateWidgetConverter\n     _formater = "date"\n@@ -230,7 +230,6 @@ class DatetimeWidget(DateWidget):\n \n @implementer_only(ITimeWidget)\n class TimeWidget(BaseWidget, z3cform_TextWidget):\n-\n     pattern = ""\n \n     def _base(self, **kw):\n@@ -788,7 +787,7 @@ def render_input_mode(self):\n             mt_select = etree.Element("select")\n             mt_select.attrib["id"] = f"{self.id}_text_format"\n             mt_select.attrib["name"] = f"{self.name}.mimeType"\n-            mt_select.attrib["class"] = "form-select {}".format(mt_pattern_name)\n+            mt_select.attrib["class"] = f"form-select {mt_pattern_name}"\n             mt_select.attrib[f"data-{mt_pattern_name}"] = json.dumps(\n                 {\n                     "textareaName": self.name,\ndiff --git a/plone/app/z3cform/widget.zcml b/plone/app/z3cform/widget.zcml\nindex 3e61eef8..ed453f03 100644\n--- a/plone/app/z3cform/widget.zcml\n+++ b/plone/app/z3cform/widget.zcml\n@@ -1,7 +1,8 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:z3c="http://namespaces.zope.org/z3c"\n-    i18n_domain="plone">\n+    i18n_domain="plone"\n+    >\n \n   <!-- Make the default widget for sequence-of-text-lines a textlines\n        widget; the default is too confusing -->\n@@ -55,81 +56,84 @@\n       for="zope.schema.interfaces.IBool\n            .interfaces.IPloneFormLayer"\n       />\n-  <adapter\n-      factory=".converters.BoolSingleCheckboxDataConverter"\n-      />\n+  <adapter factory=".converters.BoolSingleCheckboxDataConverter" />\n \n   <z3c:widgetTemplate\n-      mode="display"\n       field="zope.schema.interfaces.IBool"\n       widget=".interfaces.ISingleCheckBoxBoolWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/singlecheckboxbool_display.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="display"\n       />\n   <z3c:widgetTemplate\n-      mode="input"\n       field="zope.schema.interfaces.IBool"\n       widget=".interfaces.ISingleCheckBoxBoolWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/singlecheckboxbool_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n   <z3c:widgetTemplate\n-      mode="display"\n       field="*"\n       widget=".interfaces.IAjaxSelectWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/ajaxselect_display.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="display"\n       />\n   <z3c:widgetTemplate\n-      mode="hidden"\n       field="zope.schema.interfaces.IBool"\n       widget=".interfaces.ISingleCheckBoxBoolWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/singlecheckboxbool_hidden.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="hidden"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IMultiWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/multi_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IObjectWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/object_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget=".interfaces.ILinkWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/link_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="display"\n       widget=".interfaces.IRelatedItemsWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/relateditems_display.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="display"\n       />\n \n   <!-- widget registration stuff -->\n   <class class=".widget.DateWidget">\n-    <require permission="zope.Public"\n-             interface=".interfaces.IDateWidget" />\n+    <require\n+        permission="zope.Public"\n+        interface=".interfaces.IDateWidget"\n+        />\n   </class>\n \n   <adapter\n       factory=".widget.DateFieldWidget"\n       for="zope.schema.interfaces.IDate\n-           plone.app.z3cform.interfaces.IPloneFormLayer" />\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n   <class class=".widget.DatetimeWidget">\n-    <require permission="zope.Public"\n-             interface=".interfaces.IDatetimeWidget" />\n+    <require\n+        permission="zope.Public"\n+        interface=".interfaces.IDatetimeWidget"\n+        />\n   </class>\n \n   <adapter\n@@ -139,8 +143,10 @@\n       />\n \n   <class class=".widget.TimeWidget">\n-    <require permission="zope.Public"\n-             interface=".interfaces.ITimeWidget" />\n+    <require\n+        permission="zope.Public"\n+        interface=".interfaces.ITimeWidget"\n+        />\n   </class>\n \n   <adapter\n@@ -149,134 +155,146 @@\n            plone.app.z3cform.interfaces.IPloneFormLayer"\n       />\n \n-  <adapter factory=".widget.RelatedItemsFieldWidget"\n-           for="z3c.relationfield.interfaces.IRelationChoice\n-                plone.app.z3cform.interfaces.IPloneFormLayer" />\n+  <adapter\n+      factory=".widget.RelatedItemsFieldWidget"\n+      for="z3c.relationfield.interfaces.IRelationChoice\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.RelatedItemsFieldWidget"\n-           for="z3c.relationfield.interfaces.IRelationList\n-                plone.app.z3cform.interfaces.IPloneFormLayer" />\n+  <adapter\n+      factory=".widget.RelatedItemsFieldWidget"\n+      for="z3c.relationfield.interfaces.IRelationList\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.RelatedItemsFieldWidget"\n-           for="zope.schema.interfaces.IChoice\n-                plone.app.vocabularies.catalog.CatalogSource\n-                plone.app.z3cform.interfaces.IPloneFormLayer" />\n+  <adapter\n+      factory=".widget.RelatedItemsFieldWidget"\n+      for="zope.schema.interfaces.IChoice\n+           plone.app.vocabularies.catalog.CatalogSource\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.QueryStringFieldWidget"\n-           for="zope.schema.interfaces.IList\n-                zope.schema.interfaces.IDict\n-                plone.app.z3cform.interfaces.IPloneFormLayer"/>\n+  <adapter\n+      factory=".widget.QueryStringFieldWidget"\n+      for="zope.schema.interfaces.IList\n+           zope.schema.interfaces.IDict\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.RichTextFieldWidget"\n-           for="plone.app.textfield.interfaces.IRichText\n-                plone.app.z3cform.interfaces.IPloneFormLayer"/>\n+  <adapter\n+      factory=".widget.RichTextFieldWidget"\n+      for="plone.app.textfield.interfaces.IRichText\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n-  <adapter factory=".widget.LinkFieldWidget"\n-           for="z3c.form.interfaces.ITextWidget\n-                plone.app.z3cform.interfaces.IPloneFormLayer"/>\n+  <adapter\n+      factory=".widget.LinkFieldWidget"\n+      for="z3c.form.interfaces.ITextWidget\n+           plone.app.z3cform.interfaces.IPloneFormLayer"\n+      />\n \n   <!-- z3c.form overrides -->\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ITextWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/text_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       field="zope.schema.interfaces.IDatetime"\n       widget=".interfaces.IDatetimeWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/text_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ITextAreaWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/textarea_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ISelectWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/select_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IOrderedSelectWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/orderedselect_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IRadioWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/radio_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input_single"\n       widget="z3c.form.interfaces.IRadioWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/radio_input_single.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input_single"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ISubmitWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/submit_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.ICheckBoxWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/checkbox_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="z3c.form.interfaces.IPasswordWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/password_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <!-- plone.formwidget.namedfile -->\n   <z3c:widgetTemplate\n-      mode="input"\n       widget="plone.formwidget.namedfile.interfaces.INamedFileWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/file_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget="plone.formwidget.namedfile.interfaces.INamedImageWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/image_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <!-- plone.z3cform.textlines -->\n   <z3c:widgetTemplate\n-      mode="input"\n       widget="plone.z3cform.textlines.textlines.ITextLinesWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/textlines_input.pt"\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n       />\n \n   <!-- plone.app.textfield -->\n   <z3c:widgetTemplate\n-      mode="input"\n       widget="plone.app.textfield.widget.IRichTextWidget"\n-      layer=".interfaces.IPloneFormLayer"\n       template="templates/textfield_widget_input.pt"\n-  />\n+      layer=".interfaces.IPloneFormLayer"\n+      mode="input"\n+      />\n \n </configure>\ndiff --git a/plone/app/z3cform/wysiwyg/configure.zcml b/plone/app/z3cform/wysiwyg/configure.zcml\nindex ed277d61..cc414bde 100644\n--- a/plone/app/z3cform/wysiwyg/configure.zcml\n+++ b/plone/app/z3cform/wysiwyg/configure.zcml\n@@ -1,7 +1,8 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:z3c="http://namespaces.zope.org/z3c"\n-    i18n_domain="plone">\n+    i18n_domain="plone"\n+    >\n \n   <class class=".widget.WysiwygWidget">\n     <require\n@@ -11,17 +12,17 @@\n   </class>\n \n   <z3c:widgetTemplate\n-      mode="input"\n       widget=".widget.IWysiwygWidget"\n-      layer="z3c.form.interfaces.IFormLayer"\n       template="wysiwyg_input.pt"\n+      layer="z3c.form.interfaces.IFormLayer"\n+      mode="input"\n       />\n \n   <z3c:widgetTemplate\n-      mode="display"\n       widget=".widget.IWysiwygWidget"\n-      layer="z3c.form.interfaces.IFormLayer"\n       template="wysiwyg_display.pt"\n+      layer="z3c.form.interfaces.IFormLayer"\n+      mode="display"\n       />\n \n \ndiff --git a/plone/app/z3cform/wysiwyg/widget.py b/plone/app/z3cform/wysiwyg/widget.py\nindex 09bc9d7d..e06fa49a 100644\n--- a/plone/app/z3cform/wysiwyg/widget.py\n+++ b/plone/app/z3cform/wysiwyg/widget.py\n@@ -22,7 +22,6 @@ class IWysiwygWidget(z3c.form.interfaces.ITextAreaWidget):\n \n @implementer_only(IWysiwygWidget)\n class WysiwygWidget(z3c.form.browser.textarea.TextAreaWidget):\n-\n     klass = "kupu-widget"\n     value = ""\n \ndiff --git a/plone/app/z3cform/wysiwyg/wysiwyg_display.pt b/plone/app/z3cform/wysiwyg/wysiwyg_display.pt\nindex 8333d982..71952720 100644\n--- a/plone/app/z3cform/wysiwyg/wysiwyg_display.pt\n+++ b/plone/app/z3cform/wysiwyg/wysiwyg_display.pt\n@@ -1,18 +1,22 @@\n-<div id="" class=""\n-      tal:attributes="id view/id;\n-                      class view/klass;\n-                      style view/style;\n-                      title view/title;\n-                      lang view/lang;\n-                      onclick view/onclick;\n-                      ondblclick view/ondblclick;\n-                      onmousedown view/onmousedown;\n-                      onmouseup view/onmouseup;\n-                      onmouseover view/onmouseover;\n-                      onmousemove view/onmousemove;\n-                      onmouseout view/onmouseout;\n-                      onkeypress view/onkeypress;\n-                      onkeydown view/onkeydown;\n-                      onkeyup view/onkeyup"><tal:block\n-      condition="view/value" content="structure view/value"\n-/></div>\n+<div class=""\n+     id=""\n+     tal:attributes="\n+       id view/id;\n+       class view/klass;\n+       style view/style;\n+       title view/title;\n+       lang view/lang;\n+       onclick view/onclick;\n+       ondblclick view/ondblclick;\n+       onmousedown view/onmousedown;\n+       onmouseup view/onmouseup;\n+       onmouseover view/onmouseover;\n+       onmousemove view/onmousemove;\n+       onmouseout view/onmouseout;\n+       onkeypress view/onkeypress;\n+       onkeydown view/onkeydown;\n+       onkeyup view/onkeyup;\n+     "\n+><tal:block condition="view/value"\n+             content="structure view/value"\n+  /></div>\ndiff --git a/plone/app/z3cform/wysiwyg/wysiwyg_input.pt b/plone/app/z3cform/wysiwyg/wysiwyg_input.pt\nindex f93e4b17..4edab0c0 100644\n--- a/plone/app/z3cform/wysiwyg/wysiwyg_input.pt\n+++ b/plone/app/z3cform/wysiwyg/wysiwyg_input.pt\n@@ -1,25 +1,28 @@\n-<div lang="en"\n-     xml:lang="en"\n-     xmlns="http://www.w3.org/1999/xhtml"\n-     xmlns:tal="http://xml.zope.org/namespaces/tal"\n-     xmlns:metal="http://xml.zope.org/namespaces/metal"\n+<div xmlns="http://www.w3.org/1999/xhtml"\n      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-     i18n:domain="plone">\n+     xmlns:metal="http://xml.zope.org/namespaces/metal"\n+     xmlns:tal="http://xml.zope.org/namespaces/tal"\n+     lang="en"\n+     xml:lang="en"\n+     i18n:domain="plone"\n+>\n \n-     <tal:editor define="context            nocall:view/form/context;\n-                         here               nocall:context;\n-                         portal_url         nocall:context/portal_url;\n-                         portal             portal_url/getPortalObject;\n-                         z3c_widget         nocall:view;\n-                         id                 view/id;\n-                         inputname          view/name;\n-                         inputvalue         view/value;\n-                         here_url           request/getURL;\n-                         member             context/portal_membership/getAuthenticatedMember;\n-                         tabindex           nothing">\n-        <div metal:use-macro="context/wysiwyg_support/macros/wysiwygEditorBox">\n+  <tal:editor define="\n+                context            nocall:view/form/context;\n+                here               nocall:context;\n+                portal_url         nocall:context/portal_url;\n+                portal             portal_url/getPortalObject;\n+                z3c_widget         nocall:view;\n+                id                 view/id;\n+                inputname          view/name;\n+                inputvalue         view/value;\n+                here_url           request/getURL;\n+                member             context/portal_membership/getAuthenticatedMember;\n+                tabindex           nothing;\n+              ">\n+    <div metal:use-macro="context/wysiwyg_support/macros/wysiwygEditorBox">\n             The WYSIWYG code\n-        </div>\n-    </tal:editor>\n+    </div>\n+  </tal:editor>\n \n </div>\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 4dca6482..7a2d8b0e 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -1,3 +1,5 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n [tool.towncrier]\n filename = "CHANGES.rst"\n directory = "news/"\n@@ -19,9 +21,45 @@ directory = "bugfix"\n name = "Bug fixes:"\n showcontent = true\n \n+[[tool.towncrier.type]]\n+directory = "internal"\n+name = "Internal:"\n+showcontent = true\n+\n+[[tool.towncrier.type]]\n+directory = "documentation"\n+name = "Documentation:"\n+showcontent = true\n+\n+[[tool.towncrier.type]]\n+directory = "tests"\n+name = "Tests"\n+showcontent = true\n+\n [tool.isort]\n-# black compatible Plone isort rules:\n-profile = "black"\n-force_alphabetical_sort = true\n-force_single_line = true\n-lines_after_imports = 2\n\\ No newline at end of file\n+profile = "plone"\n+\n+[tool.black]\n+target-version = ["py38"]\n+\n+[tool.dependencychecker]\n+Zope = [\n+  # Zope own provided namespaces\n+  \'App\', \'OFS\', \'Products.Five\', \'Products.OFSP\', \'Products.PageTemplates\',\n+  \'Products.SiteAccess\', \'Shared\', \'Testing\', \'ZPublisher\', \'ZTUtils\',\n+  \'Zope2\', \'webdav\', \'zmi\',\n+  # Zope dependencies\n+  \'Acquisition\', \'DateTime\', \'transaction\', \'zExceptions\', \'ZODB\', \'zope.component\',\n+  \'zope.configuration\', \'zope.container\', \'zope.deferredimport\', \'zope.event\',\n+  \'zope.exceptions\', \'zope.globalrequest\', \'zope.i18n\', \'zope.i18nmessageid\',\n+  \'zope.interface\', \'zope.lifecycleevent\', \'zope.location\', \'zope.publisher\',\n+  \'zope.schema\', \'zope.security\', \'zope.site\', \'zope.traversing\', \'AccessControl\',\n+]\n+\'plone.base\' = [\n+  \'AccessControl\', \'Products.BTreeFolder2\', \'Products.CMFCore\',\n+  \'Products.CMFDynamicViewFTI\', \'zope.deprecation\',\n+]\n+python-dateutil = [\'dateutil\']\n+\n+[tool.codespell]\n+ignore-words-list = "discreet"\ndiff --git a/setup.cfg b/setup.cfg\nindex ffe928aa..4a2916b8 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -1,8 +1,25 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+[bdist_wheel]\n+universal = 0\n+\n+[flake8]\n+doctests = 1\n+ignore =\n+    # black takes care of line length\n+    E501,\n+    # black takes care of where to break lines\n+    W503,\n+    # black takes care of spaces within slicing (list[:])\n+    E203,\n+    # black takes care of spaces after commas\n+    E231,\n+\n [check-manifest]\n ignore =\n+    .editorconfig\n+    .meta.toml\n+    .pre-commit-config.yaml\n+    tox.ini\n     *.cfg\n     requirements.txt\n-\n-\n-[bdist_wheel]\n-universal = 0\ndiff --git a/setup.py b/setup.py\nindex 01cf5262..6311dd5f 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -8,24 +8,24 @@ def read(*rnames):\n     return open(os.path.join(os.path.dirname(__file__), *rnames)).read()\n \n \n-version = \'4.0.2.dev0\'\n+version = "4.0.2.dev0"\n \n long_description = (\n-    read(\'README.rst\') +\n-    \'\\n\' +\n-    read(\'plone\', \'app\', \'z3cform\', \'wysiwyg\', \'README.rst\') +\n-    \'\\n\' +\n-    read(\'plone\', \'app\', \'z3cform\', \'inline_validation.rst\') +\n-    \'\\n\' +\n-    read(\'CHANGES.rst\') +\n-    \'\\n\'\n+    read("README.rst")\n+    + "\\n"\n+    + read("plone", "app", "z3cform", "wysiwyg", "README.rst")\n+    + "\\n"\n+    + read("plone", "app", "z3cform", "inline_validation.rst")\n+    + "\\n"\n+    + read("CHANGES.rst")\n+    + "\\n"\n )\n \n setup(\n-    name=\'plone.app.z3cform\',\n+    name="plone.app.z3cform",\n     version=version,\n     description="A collection of widgets, templates and other components "\n-                "for use with z3c.form and Plone",\n+    "for use with z3c.form and Plone",\n     long_description=long_description,\n     classifiers=[\n         "Development Status :: 5 - Production/Stable",\n@@ -42,38 +42,53 @@ def read(*rnames):\n         "Programming Language :: Python :: 3.10",\n         "Programming Language :: Python :: 3.11",\n     ],\n-    keywords=\'zope plone form widget template\',\n-    author=\'Plone Foundation\',\n-    author_email=\'plone-developers@lists.sourceforge.net\',\n-    url=\'https://pypi.org/project/plone.app.z3cform\',\n-    license=\'GPL\',\n+    keywords="zope plone form widget template",\n+    author="Plone Foundation",\n+    author_email="plone-developers@lists.sourceforge.net",\n+    url="https://pypi.org/project/plone.app.z3cform",\n+    license="GPL",\n     packages=find_packages(),\n-    namespace_packages=[\'plone\', \'plone.app\'],\n+    namespace_packages=["plone", "plone.app"],\n     include_package_data=True,\n     zip_safe=False,\n     python_requires=">=3.8",\n     install_requires=[\n-        \'plone.app.textfield>=1.3.6\',\n-        \'plone.app.widgets>=2.4.2\',\n-        \'plone.base\',\n-        \'plone.protect\',\n-        \'setuptools\',\n-        \'z3c.form >= 4.0\',\n-        \'z3c.formwidget.query\',\n-        \'zope.deprecation\',\n-        \'zope.globalrequest\',\n-        \'Zope\',\n+        "lxml",\n+        "plone.app.contentlisting",\n+        "plone.app.vocabularies",\n+        "plone.app.textfield>=1.3.6",\n+        "plone.app.widgets>=2.4.2",\n+        "plone.base",\n+        "plone.dexterity",\n+        "plone.i18n",\n+        "plone.namedfile",\n+        "plone.protect",\n+        "plone.registry",\n+        "plone.uuid",\n+        "plone.z3cform",\n+        "Products.GenericSetup",\n+        "pytz",\n+        "setuptools",\n+        "z3c.form >= 4.0",\n+        "z3c.relationfield",\n+        "zope.browserpage",\n+        "zope.contentprovider",\n+        "zope.globalrequest",\n+        "zope.pagetemplate",\n+        "Zope",\n     ],\n     extras_require={\n-        \'tests\': [\n-            \'mock\',\n-            \'plone.app.robotframework\',\n-            \'plone.app.testing\',\n-            \'plone.browserlayer\',\n-            \'plone.testing\',\n-            \'zope.contentprovider\',\n-            \'zope.publisher\',\n-            \'zope.testing\',\n+        "tests": [\n+            "plone.app.contenttypes[test]",\n+            "plone.app.layout",\n+            "plone.app.testing",\n+            "plone.autoform",\n+            "plone.browserlayer",\n+            "plone.supermodel",\n+            "plone.testing",\n+            "zope.annotation",\n+            "zope.intid",\n+            "zope.publisher",\n         ]\n     },\n )\ndiff --git a/tox.ini b/tox.ini\nnew file mode 100644\nindex 00000000..43e9ac47\n--- /dev/null\n+++ b/tox.ini\n@@ -0,0 +1,53 @@\n+# Generated from:\n+# https://github.com/plone/meta/tree/master/config/default\n+[tox]\n+# We need 4.4.0 for constrain_package_deps.\n+min_version = 4.4.0\n+envlist =\n+    format\n+    lint\n+    test\n+\n+[testenv]\n+allowlist_externals =\n+    sh\n+\n+[testenv:format]\n+description = automatically reformat code\n+skip_install = true\n+deps =\n+    pre-commit\n+commands =\n+    pre-commit run -a pyupgrade\n+    pre-commit run -a isort\n+    pre-commit run -a black\n+    pre-commit run -a zpretty\n+\n+[testenv:lint]\n+description = run linters that will help improve the code style\n+skip_install = true\n+deps =\n+    pre-commit\n+commands =\n+    pre-commit run -a\n+\n+[testenv:dependencies]\n+description = check if the package defines all its dependencies and generate a graph out of them\n+deps =\n+    z3c.dependencychecker==2.11\n+    pipdeptree==2.5.1\n+    graphviz  # optional dependency of pipdeptree\n+commands =\n+    dependencychecker\n+    sh -c \'pipdeptree --exclude setuptools,wheel,pipdeptree,z3c.dependencychecker,zope.interface,zope.component --graph-output svg > dependencies.svg\'\n+\n+[testenv:test]\n+usedevelop = true\n+constrain_package_deps = true\n+deps =\n+    zope.testrunner\n+    -c https://dist.plone.org/release/6.0-dev/constraints.txt\n+commands =\n+    zope-testrunner --test-path={toxinidir} -s plone.app.z3cform\n+extras =\n+    tests\n'

