Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2022-01-19T18:26:51+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/d458ad1191abf9664fe4dc513e1acce2e81f64c4

Fixed undefined name 'portal_url'.

Seen with a code checker, but you get this when you visit the policy mapping form
without a workflow policy id.
Fixed the code up further so you do not get a traceback with a missing or wrong policy id.

Also made sure to call more views with `@@`, which is a tiny bit faster.

Files changed:
A news/39.bugfix
M Products/CMFPlacefulWorkflow/browser/views.py
M Products/CMFPlacefulWorkflow/tests/test_configlet.py

b'diff --git a/Products/CMFPlacefulWorkflow/browser/views.py b/Products/CMFPlacefulWorkflow/browser/views.py\nindex f12f567..4899c43 100644\n--- a/Products/CMFPlacefulWorkflow/browser/views.py\n+++ b/Products/CMFPlacefulWorkflow/browser/views.py\n@@ -77,17 +77,17 @@ def __call__(self):\n                 if policy_id in pwtool.objectIds():\n                     pwtool.manage_delObjects([policy_id, ])\n             plone_utils.addPortalMessage(_(u\'Deleted Local Workflow Policy.\'), \'info\')\n-            return request.response.redirect(\'prefs_workflow_localpolicies_form\')\n+            return request.response.redirect(\'@@prefs_workflow_localpolicies_form\')\n \n         elif add:\n             if policy_id:\n                 pwtool.manage_addWorkflowPolicy(id=policy_id, duplicate_id=policy_duplicate_id)\n                 plone_utils.addPortalMessage(_(u\'Local Workflow Policy added.\'), \'info\')\n-                return request.response.redirect(\'prefs_workflow_policy_mapping?wfpid=\' + policy_id)\n+                return request.response.redirect(\'@@prefs_workflow_policy_mapping?wfpid=\' + policy_id)\n \n             else:\n                 plone_utils.addPortalMessage(_(u\'The policy Id is required.\'), \'error\')\n-                return request.response.redirect(\'prefs_workflow_localpolicies_form\')\n+                return request.response.redirect(\'@@prefs_workflow_localpolicies_form\')\n \n         return self.index()\n \n@@ -96,20 +96,24 @@ class WorkflowPolicyMapping(BrowserView):\n     """\n \n     def __call__(self):\n+        # First check that we have a policy id and that it exists.\n+        # If we don\'t, return to the overview form.\n         request = self.request\n-        if not request.get(\'submit\', None):\n-            return self.index()\n-\n         context = self.context\n         plone_utils = getToolByName(context, \'plone_utils\')\n-\n         wfpid = request.get(\'wfpid\', None)\n-        if not wfpid:\n+        policy = None\n+        if wfpid:\n+            tool = getToolByName(context, \'portal_placeful_workflow\')\n+            policy = tool.getWorkflowPolicyById(wfpid)\n+        if policy is None:\n+            portal_url = getToolByName(context, \'portal_url\')()\n             plone_utils.addPortalMessage(_(u\'No Policy selected.\'), \'error\')\n             return request.response.redirect(portal_url + \'/@@prefs_workflow_localpolicies_form\')\n \n-        tool = getToolByName(context, \'portal_placeful_workflow\')\n-        policy = tool.getWorkflowPolicyById(wfpid)\n+        if not request.get(\'submit\', None):\n+            return self.index()\n+\n         title = request.get(\'title\', None)\n         description = request.get(\'description\', None)\n         default_workflow_id = request.get(\'default_workflow_id\', None)\n@@ -141,4 +145,4 @@ def __call__(self):\n         wf_tool.updateRoleMappings()\n \n         plone_utils.addPortalMessage(_(u\'Changes to criteria saved.\'))\n-        return request.response.redirect(\'prefs_workflow_policy_mapping?wfpid=%s\' % wfpid)\n+        return request.response.redirect(\'@@prefs_workflow_policy_mapping?wfpid=%s\' % wfpid)\ndiff --git a/Products/CMFPlacefulWorkflow/tests/test_configlet.py b/Products/CMFPlacefulWorkflow/tests/test_configlet.py\nindex e6fa451..db48eb2 100644\n--- a/Products/CMFPlacefulWorkflow/tests/test_configlet.py\n+++ b/Products/CMFPlacefulWorkflow/tests/test_configlet.py\n@@ -70,7 +70,20 @@ def test_local_mapping_select_acquisition_chain(self):\n         commit()\n         browser = self.getBrowser(logged_in=True)\n         browser.handleErrors = False\n-        browser.open(\'http://nohost/plone/prefs_workflow_policy_mapping?\'\n+\n+        # Check that we get no errors when we do not pass the policy id\n+        portal_url = self.portal.absolute_url()\n+        central_form = f\'{portal_url}/@@prefs_workflow_localpolicies_form\'\n+        browser.open(f\'{portal_url}/@@prefs_workflow_policy_mapping\')\n+        self.assertEqual(browser.url, central_form)\n+\n+        # Try a wrong id.\n+        browser.open(f\'{portal_url}/@@prefs_workflow_policy_mapping?\'\n+                     \'wfpid=no_such_policy\')\n+        self.assertEqual(browser.url, central_form)\n+\n+        # Now with a proper policy id.\n+        browser.open(f\'{portal_url}/@@prefs_workflow_policy_mapping?\'\n                      \'wfpid=dummy_policy\')\n         self.assertEqual(browser.getControl(name=\'wf.Document:record\').value,\n                          [\'folder_workflow\', ])\n@@ -78,5 +91,7 @@ def test_local_mapping_select_acquisition_chain(self):\n         browser.getControl(name=\'wf.Document:record\').value = [\'acquisition\', ]\n         browser.getControl(name=\'submit\').click()\n \n+        self.assertEqual(browser.url, f\'{portal_url}/@@prefs_workflow_policy_mapping?\'\n+                        \'wfpid=dummy_policy\')\n         self.assertEqual(browser.getControl(name=\'wf.Document:record\').value,\n                          [\'acquisition\', ])\ndiff --git a/news/39.bugfix b/news/39.bugfix\nnew file mode 100644\nindex 0000000..b1fbcd2\n--- /dev/null\n+++ b/news/39.bugfix\n@@ -0,0 +1,3 @@\n+Fixed undefined name ``portal_url``.\n+Fixed traceback on the policy mapping form when the workflow policy id is missing or wrong.\n+[maurits]\n'

Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2022-01-25T10:21:00+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/00af974ce2386f1b8aeb79d76a5f53bed7f563e7

Merge pull request #39 from plone/fix-undefined-portal-url

Fixed undefined name 'portal_url'.

Files changed:
A news/39.bugfix
M Products/CMFPlacefulWorkflow/browser/views.py
M Products/CMFPlacefulWorkflow/tests/test_configlet.py

b'diff --git a/Products/CMFPlacefulWorkflow/browser/views.py b/Products/CMFPlacefulWorkflow/browser/views.py\nindex f12f567..4899c43 100644\n--- a/Products/CMFPlacefulWorkflow/browser/views.py\n+++ b/Products/CMFPlacefulWorkflow/browser/views.py\n@@ -77,17 +77,17 @@ def __call__(self):\n                 if policy_id in pwtool.objectIds():\n                     pwtool.manage_delObjects([policy_id, ])\n             plone_utils.addPortalMessage(_(u\'Deleted Local Workflow Policy.\'), \'info\')\n-            return request.response.redirect(\'prefs_workflow_localpolicies_form\')\n+            return request.response.redirect(\'@@prefs_workflow_localpolicies_form\')\n \n         elif add:\n             if policy_id:\n                 pwtool.manage_addWorkflowPolicy(id=policy_id, duplicate_id=policy_duplicate_id)\n                 plone_utils.addPortalMessage(_(u\'Local Workflow Policy added.\'), \'info\')\n-                return request.response.redirect(\'prefs_workflow_policy_mapping?wfpid=\' + policy_id)\n+                return request.response.redirect(\'@@prefs_workflow_policy_mapping?wfpid=\' + policy_id)\n \n             else:\n                 plone_utils.addPortalMessage(_(u\'The policy Id is required.\'), \'error\')\n-                return request.response.redirect(\'prefs_workflow_localpolicies_form\')\n+                return request.response.redirect(\'@@prefs_workflow_localpolicies_form\')\n \n         return self.index()\n \n@@ -96,20 +96,24 @@ class WorkflowPolicyMapping(BrowserView):\n     """\n \n     def __call__(self):\n+        # First check that we have a policy id and that it exists.\n+        # If we don\'t, return to the overview form.\n         request = self.request\n-        if not request.get(\'submit\', None):\n-            return self.index()\n-\n         context = self.context\n         plone_utils = getToolByName(context, \'plone_utils\')\n-\n         wfpid = request.get(\'wfpid\', None)\n-        if not wfpid:\n+        policy = None\n+        if wfpid:\n+            tool = getToolByName(context, \'portal_placeful_workflow\')\n+            policy = tool.getWorkflowPolicyById(wfpid)\n+        if policy is None:\n+            portal_url = getToolByName(context, \'portal_url\')()\n             plone_utils.addPortalMessage(_(u\'No Policy selected.\'), \'error\')\n             return request.response.redirect(portal_url + \'/@@prefs_workflow_localpolicies_form\')\n \n-        tool = getToolByName(context, \'portal_placeful_workflow\')\n-        policy = tool.getWorkflowPolicyById(wfpid)\n+        if not request.get(\'submit\', None):\n+            return self.index()\n+\n         title = request.get(\'title\', None)\n         description = request.get(\'description\', None)\n         default_workflow_id = request.get(\'default_workflow_id\', None)\n@@ -141,4 +145,4 @@ def __call__(self):\n         wf_tool.updateRoleMappings()\n \n         plone_utils.addPortalMessage(_(u\'Changes to criteria saved.\'))\n-        return request.response.redirect(\'prefs_workflow_policy_mapping?wfpid=%s\' % wfpid)\n+        return request.response.redirect(\'@@prefs_workflow_policy_mapping?wfpid=%s\' % wfpid)\ndiff --git a/Products/CMFPlacefulWorkflow/tests/test_configlet.py b/Products/CMFPlacefulWorkflow/tests/test_configlet.py\nindex e6fa451..db48eb2 100644\n--- a/Products/CMFPlacefulWorkflow/tests/test_configlet.py\n+++ b/Products/CMFPlacefulWorkflow/tests/test_configlet.py\n@@ -70,7 +70,20 @@ def test_local_mapping_select_acquisition_chain(self):\n         commit()\n         browser = self.getBrowser(logged_in=True)\n         browser.handleErrors = False\n-        browser.open(\'http://nohost/plone/prefs_workflow_policy_mapping?\'\n+\n+        # Check that we get no errors when we do not pass the policy id\n+        portal_url = self.portal.absolute_url()\n+        central_form = f\'{portal_url}/@@prefs_workflow_localpolicies_form\'\n+        browser.open(f\'{portal_url}/@@prefs_workflow_policy_mapping\')\n+        self.assertEqual(browser.url, central_form)\n+\n+        # Try a wrong id.\n+        browser.open(f\'{portal_url}/@@prefs_workflow_policy_mapping?\'\n+                     \'wfpid=no_such_policy\')\n+        self.assertEqual(browser.url, central_form)\n+\n+        # Now with a proper policy id.\n+        browser.open(f\'{portal_url}/@@prefs_workflow_policy_mapping?\'\n                      \'wfpid=dummy_policy\')\n         self.assertEqual(browser.getControl(name=\'wf.Document:record\').value,\n                          [\'folder_workflow\', ])\n@@ -78,5 +91,7 @@ def test_local_mapping_select_acquisition_chain(self):\n         browser.getControl(name=\'wf.Document:record\').value = [\'acquisition\', ]\n         browser.getControl(name=\'submit\').click()\n \n+        self.assertEqual(browser.url, f\'{portal_url}/@@prefs_workflow_policy_mapping?\'\n+                        \'wfpid=dummy_policy\')\n         self.assertEqual(browser.getControl(name=\'wf.Document:record\').value,\n                          [\'acquisition\', ])\ndiff --git a/news/39.bugfix b/news/39.bugfix\nnew file mode 100644\nindex 0000000..b1fbcd2\n--- /dev/null\n+++ b/news/39.bugfix\n@@ -0,0 +1,3 @@\n+Fixed undefined name ``portal_url``.\n+Fixed traceback on the policy mapping form when the workflow policy id is missing or wrong.\n+[maurits]\n'

