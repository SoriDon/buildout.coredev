Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2023-08-10T14:48:45+02:00
Author: gogobd (gogobd) <gogo@bluedynamics.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/521b07e3249076a52c15682ca90444a7e65c43cd

Don't screw up save and cancel button placement

Files changed:
M src/plone/app/multilingual/browser/javascript/babel_helper.js

b'diff --git a/src/plone/app/multilingual/browser/javascript/babel_helper.js b/src/plone/app/multilingual/browser/javascript/babel_helper.js\nindex cae87ed9..d6530a17 100644\n--- a/src/plone/app/multilingual/browser/javascript/babel_helper.js\n+++ b/src/plone/app/multilingual/browser/javascript/babel_helper.js\n@@ -103,16 +103,6 @@\n         });\n     }\n \n-    function sync_elements_vertically() {\n-        // We do NOT calculate padding here again, because we might get\n-        // to high padding because fields might have been shifted, increasing\n-        // the padding.\n-        var i = 0;\n-        $.each(original_fields, function (i) {\n-            sync_element_vertically($(original_fields[i]), $(destination_fields[i]), padding, i === 0);\n-        });\n-    }\n-\n     function update_view() {\n         var order = 1,\n             url_translate = $(\'input#url_translate\').val(),\n@@ -137,11 +127,11 @@\n                 original_field.prepend("<div class=\'translator-widget\' id=\'item_translation_" + order + "\'></div>");\n                 original_field.children(\'.translator-widget\').click(function () {\n                     var field = $(value).attr("rel");\n-                        // Fetch source of text to translate.\n+                    // Fetch source of text to translate.\n                     var jsondata = {\n-                            \'field\': field,\n-                            \'lang_source\': langSource\n-                        };\n+                        \'field\': field,\n+                        \'lang_source\': langSource\n+                    };\n                     var targetelement = destination_field.find(\'textarea\');\n                     var tiny_editor = destination_field.find("textarea.mce_editable");\n                     if (!targetelement.length) {\n@@ -226,6 +216,5 @@\n             update_view();\n         });\n \n-        $(".formTabs, .pat-autotoc a").click(sync_elements_vertically);\n     });\n }(jQuery));\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2023-08-10T15:21:19+02:00
Author: gogobd (gogobd) <gogo@bluedynamics.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/e17c9531a8f397d163fb725df2990e4b1968e14d

Fix 435

Files changed:
A news/435.bugfix

b'diff --git a/news/435.bugfix b/news/435.bugfix\nnew file mode 100644\nindex 000000000..0394acd08\n--- /dev/null\n+++ b/news/435.bugfix\n@@ -0,0 +1 @@\n+Fixing placement of save and cancel buttons by not having javascript screw up their position\n\\ No newline at end of file\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2023-08-10T15:58:04+02:00
Author: gogobd (gogobd) <gogo@bluedynamics.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/c0202b5145e7d57d01e25511c60fcbda192e44d8

Hot fix: just reorganize every second

Files changed:
M src/plone/app/multilingual/browser/javascript/babel_helper.js

b'diff --git a/src/plone/app/multilingual/browser/javascript/babel_helper.js b/src/plone/app/multilingual/browser/javascript/babel_helper.js\nindex d6530a17..33124032 100644\n--- a/src/plone/app/multilingual/browser/javascript/babel_helper.js\n+++ b/src/plone/app/multilingual/browser/javascript/babel_helper.js\n@@ -216,5 +216,9 @@\n             update_view();\n         });\n \n+        var intervalId = window.setInterval(function () {\n+            update_view();\n+        }, 1000);\n+\n     });\n }(jQuery));\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2023-09-19T12:06:03+02:00
Author: Georg Gogo. BERNHARD (gogobd) <g.bernhard@akbild.ac.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/a3e634daf1ad3a56b7995d08e2fc7601e13c41bb

Merge pull request #439 from plone/master

Trying to integrate / rebase "master".

Files changed:
A news/437.bugfix
M CHANGES.rst
M setup.cfg
M src/plone/app/multilingual/browser/switcher.py
M src/plone/app/multilingual/browser/templates/modify_translations.pt
M src/plone/app/multilingual/tests/test_switcher.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex def050b5..8d2b2559 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -8,6 +8,16 @@ Changelog\n \n .. towncrier release notes start\n \n+8.0.1 (2023-08-31)\n+------------------\n+\n+Bug fixes:\n+\n+\n+- Fix setting Indonesian language cookie on site root: must be ``id``, not ``id-id``.\n+  [maurits] (#304)\n+\n+\n 8.0.0 (2023-07-14)\n ------------------\n \ndiff --git a/news/437.bugfix b/news/437.bugfix\nnew file mode 100644\nindex 00000000..339a02fe\n--- /dev/null\n+++ b/news/437.bugfix\n@@ -0,0 +1 @@\n+Fixing disconnection of translations [gogobd]\ndiff --git a/setup.cfg b/setup.cfg\nindex 55cda016..ec9a85d0 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -1,5 +1,5 @@\n [metadata]\n-version = 8.0.1.dev0\n+version = 8.0.2.dev0\n name = plone.app.multilingual\n description = Multilingual Plone Content package\n long_description = file: README.rst, CREDITS.rst, CHANGES.rst\ndiff --git a/src/plone/app/multilingual/browser/switcher.py b/src/plone/app/multilingual/browser/switcher.py\nindex 3820bd32..6d815502 100644\n--- a/src/plone/app/multilingual/browser/switcher.py\n+++ b/src/plone/app/multilingual/browser/switcher.py\n@@ -1,6 +1,8 @@\n from Acquisition import aq_inner\n+from plone.i18n.interfaces import ILanguageUtility\n from Products.CMFCore.utils import getToolByName\n from Products.Five import BrowserView\n+from zope.component import getUtility\n \n \n class LanguageSwitcher(BrowserView):\n@@ -26,8 +28,10 @@ def __call__(self):\n \n         # We need to set the language cookie on the first response or it will\n         # be set on the frontpage itself, making it uncachable\n-        langCookie = self.request.cookies.get("I18N_LANGUAGE")\n-        if not langCookie or langCookie != target:\n-            self.request.response.setCookie("I18N_LANGUAGE", target, path="/")\n+        # In case of Indonesian, we need to use \'id\', not \'id-id\'.\n+        target = "id" if target == "id-id" else target\n+        tool = getUtility(ILanguageUtility)\n+        # setLanguageCookie calls getLanguageCookie, and only sets a cookie when needed.\n+        tool.setLanguageCookie(target, request=self.request)\n \n         self.request.response.redirect(url, status=302)\ndiff --git a/src/plone/app/multilingual/browser/templates/modify_translations.pt b/src/plone/app/multilingual/browser/templates/modify_translations.pt\nindex 8e2e85d9..eb6576b8 100644\n--- a/src/plone/app/multilingual/browser/templates/modify_translations.pt\n+++ b/src/plone/app/multilingual/browser/templates/modify_translations.pt\n@@ -74,7 +74,7 @@\n                      href="#"\n                      title="Disconnect translation"\n                      tal:attributes="\n-                       href string:${context/absolute_url}/disconnect_translation?came_from=${context/UID}&language=${lang};;;\n+                       href python:context.absolute_url() + \'/disconnect_translation?came_from=\' + context.UID() + \'&language=\' + lang;\n                      "\n                      i18n:attributes="title disconnect_translation"\n                   >\ndiff --git a/src/plone/app/multilingual/tests/test_switcher.py b/src/plone/app/multilingual/tests/test_switcher.py\nindex 14a8ac6d..b145f5ba 100644\n--- a/src/plone/app/multilingual/tests/test_switcher.py\n+++ b/src/plone/app/multilingual/tests/test_switcher.py\n@@ -34,12 +34,14 @@ def setUp(self):\n     def test_switcher_redirects_to_default_english(self):\n         self.browser.open(self.portal_url)\n         self.assertEqual(self.browser.url, self.portal_url + "/en")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "en")\n \n     def test_switcher_redirects_to_default_indonesian(self):\n         self.language_tool.setDefaultLanguage("id")\n         transaction.commit()\n         self.browser.open(self.portal_url)\n         self.assertEqual(self.browser.url, self.portal_url + "/id-id")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "id")\n \n     def test_switcher_redirects_to_preferred_catalan(self):\n         # Tell Plone that we prefer Catalan.\n@@ -48,6 +50,7 @@ def test_switcher_redirects_to_preferred_catalan(self):\n         self.browser.open(self.portal_url)\n         # We get redirected to our preferred language root folder.\n         self.assertEqual(self.browser.url, self.portal_url + "/ca")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "ca")\n \n     def test_switcher_redirects_to_preferred_indonesian(self):\n         # Tell Plone that we prefer Indonesian.\n@@ -56,3 +59,4 @@ def test_switcher_redirects_to_preferred_indonesian(self):\n         self.browser.open(self.portal_url)\n         # We get redirected to our preferred language root folder.\n         self.assertEqual(self.browser.url, self.portal_url + "/id-id")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "id")\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2023-10-04T15:16:20+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/855c04f5a52f7a13ac408626fbf713d12592532a

Merge branch 'master' into fix-babel-edit

Files changed:
M .pre-commit-config.yaml
M src/plone/app/multilingual/browser/menu.py
M src/plone/app/multilingual/manager.py

b'diff --git a/.pre-commit-config.yaml b/.pre-commit-config.yaml\nindex f2db38ba..14c1f9c2 100644\n--- a/.pre-commit-config.yaml\n+++ b/.pre-commit-config.yaml\n@@ -6,7 +6,7 @@ ci:\n \n repos:\n -   repo: https://github.com/asottile/pyupgrade\n-    rev: v3.8.0\n+    rev: v3.14.0\n     hooks:\n     -   id: pyupgrade\n         args: [--py38-plus]\n@@ -15,7 +15,7 @@ repos:\n     hooks:\n     -   id: isort\n -   repo: https://github.com/psf/black\n-    rev: 23.3.0\n+    rev: 23.9.1\n     hooks:\n     -   id: black\n -   repo: https://github.com/collective/zpretty\n@@ -23,11 +23,11 @@ repos:\n     hooks:\n     -   id: zpretty\n -   repo: https://github.com/PyCQA/flake8\n-    rev: 6.0.0\n+    rev: 6.1.0\n     hooks:\n     -   id: flake8\n -   repo: https://github.com/codespell-project/codespell\n-    rev: v2.2.5\n+    rev: v2.2.6\n     hooks:\n     -   id: codespell\n         additional_dependencies:\ndiff --git a/src/plone/app/multilingual/browser/menu.py b/src/plone/app/multilingual/browser/menu.py\nindex fcc12ae2..2b3d00c6 100644\n--- a/src/plone/app/multilingual/browser/menu.py\n+++ b/src/plone/app/multilingual/browser/menu.py\n@@ -530,7 +530,6 @@ class TranslateSubMenuItem(BrowserSubMenuItem):\n     )\n     submenuId = "plone_contentmenu_multilingual"\n     order = 5\n-    extra = {"id": "plone-contentmenu-multilingual"}\n \n     @property\n     def action(self):\ndiff --git a/src/plone/app/multilingual/manager.py b/src/plone/app/multilingual/manager.py\nindex 1f32c1cb..37bc9cd9 100644\n--- a/src/plone/app/multilingual/manager.py\n+++ b/src/plone/app/multilingual/manager.py\n@@ -74,7 +74,7 @@ def register_translation(self, language, content):\n         if not language and language != "":\n             raise KeyError("There is no target language")\n \n-        if type(content) == str:\n+        if isinstance(content, str):\n             content = uuidToObject(content)\n \n         # Check if exists and is not myself\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2023-10-04T16:46:59+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/7fcb08777f79b37faf0de5dd233931074f439b74

Merge pull request #434 from plone/fix-babel-edit

Don't screw up save and cancel button placement

Files changed:
A news/435.bugfix
M src/plone/app/multilingual/browser/javascript/babel_helper.js

b'diff --git a/news/435.bugfix b/news/435.bugfix\nnew file mode 100644\nindex 00000000..0394acd0\n--- /dev/null\n+++ b/news/435.bugfix\n@@ -0,0 +1 @@\n+Fixing placement of save and cancel buttons by not having javascript screw up their position\n\\ No newline at end of file\ndiff --git a/src/plone/app/multilingual/browser/javascript/babel_helper.js b/src/plone/app/multilingual/browser/javascript/babel_helper.js\nindex cae87ed9..33124032 100644\n--- a/src/plone/app/multilingual/browser/javascript/babel_helper.js\n+++ b/src/plone/app/multilingual/browser/javascript/babel_helper.js\n@@ -103,16 +103,6 @@\n         });\n     }\n \n-    function sync_elements_vertically() {\n-        // We do NOT calculate padding here again, because we might get\n-        // to high padding because fields might have been shifted, increasing\n-        // the padding.\n-        var i = 0;\n-        $.each(original_fields, function (i) {\n-            sync_element_vertically($(original_fields[i]), $(destination_fields[i]), padding, i === 0);\n-        });\n-    }\n-\n     function update_view() {\n         var order = 1,\n             url_translate = $(\'input#url_translate\').val(),\n@@ -137,11 +127,11 @@\n                 original_field.prepend("<div class=\'translator-widget\' id=\'item_translation_" + order + "\'></div>");\n                 original_field.children(\'.translator-widget\').click(function () {\n                     var field = $(value).attr("rel");\n-                        // Fetch source of text to translate.\n+                    // Fetch source of text to translate.\n                     var jsondata = {\n-                            \'field\': field,\n-                            \'lang_source\': langSource\n-                        };\n+                        \'field\': field,\n+                        \'lang_source\': langSource\n+                    };\n                     var targetelement = destination_field.find(\'textarea\');\n                     var tiny_editor = destination_field.find("textarea.mce_editable");\n                     if (!targetelement.length) {\n@@ -226,6 +216,9 @@\n             update_view();\n         });\n \n-        $(".formTabs, .pat-autotoc a").click(sync_elements_vertically);\n+        var intervalId = window.setInterval(function () {\n+            update_view();\n+        }, 1000);\n+\n     });\n }(jQuery));\n'

