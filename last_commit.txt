Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-11-17T08:56:40+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/6939678d4e8672d5ae9f29ba6ee61bfa3996d0bb

fixes #3352 - p.a.iterate dependency indirection (#3357)

Files changed:
A news/3357.bugfix
M Products/CMFPlone/relationhelper.py

b'diff --git a/Products/CMFPlone/relationhelper.py b/Products/CMFPlone/relationhelper.py\nindex d0ff347abd..0a8f041ce5 100644\n--- a/Products/CMFPlone/relationhelper.py\n+++ b/Products/CMFPlone/relationhelper.py\n@@ -1,8 +1,6 @@\n from collections import Counter\n from collections import defaultdict\n from five.intid.intid import addIntIdSubscriber\n-from plone.app.iterate.dexterity import ITERATE_RELATION_NAME\n-from plone.app.iterate.dexterity.relation import StagingRelationValue\n from plone.app.linkintegrity.handlers import modifiedContent\n from plone.app.linkintegrity.utils import referencedRelationship\n from plone.app.relationfield.event import update_behavior_relations\n@@ -26,6 +24,18 @@\n from zope.intid.interfaces import ObjectMissingError\n \n import logging\n+import pkg_resources\n+\n+try:\n+    # "iterate" is not a dependency of CMFPlone, but a consumer of it\n+    pkg_resources.get_distribution("plone.app.iterate")\n+except pkg_resources.DistributionNotFound:\n+    HAS_ITERATE = False\n+else:\n+    HAS_ITERATE = True\n+    from plone.app.iterate.dexterity import ITERATE_RELATION_NAME\n+    from plone.app.iterate.dexterity.relation import StagingRelationValue\n+\n \n logger = logging.getLogger(__name__)\n \n@@ -183,7 +193,7 @@ def restore_relations(context=None, all_relations=None):\n             update_linkintegrity.add(item[\'from_uuid\'])\n             continue\n \n-        if from_attribute == ITERATE_RELATION_NAME:\n+        if HAS_ITERATE and from_attribute == ITERATE_RELATION_NAME:\n             # Iterate relations are not set as values of fields\n             relation = StagingRelationValue(to_id)\n             event._setRelation(source_obj, ITERATE_RELATION_NAME, relation)\ndiff --git a/news/3357.bugfix b/news/3357.bugfix\nnew file mode 100644\nindex 0000000000..dfb9316305\n--- /dev/null\n+++ b/news/3357.bugfix\n@@ -0,0 +1,2 @@\n+Fixes #3352 - dependency indirection on plone.app.iterate [jensens]\n+\n'

