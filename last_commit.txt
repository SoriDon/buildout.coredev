Repository: plone.restapi


Branch: refs/heads/master
Date: 2022-10-01T16:03:38+02:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/1bd76fbc7c79e67e0cddeb76ab1eac23a834b3a0

The `@controlpanels/usergroup` does not work for Plone 5 since it doe… (#1502)

* The `@controlpanels/usergroup` does not work for Plone 5 since it does not exist there. Bring back the missing `title` just for Plone 5.

* Now much better :)

* Remaining version change in docs

Files changed:
A news/1501.bugfix
M src/plone/restapi/controlpanels/registry.py
M src/plone/restapi/tests/http-examples/translated_messages_addons.resp
M src/plone/restapi/tests/test_services_controlpanels.py

b'diff --git a/news/1501.bugfix b/news/1501.bugfix\nnew file mode 100644\nindex 000000000..957d276cd\n--- /dev/null\n+++ b/news/1501.bugfix\n@@ -0,0 +1,2 @@\n+The ``@controlpanels/usergroup`` does not work for Plone 5 since it does not exist there. Bring back the missing `title` just for Plone 5.\n+[sneridagh]\ndiff --git a/src/plone/restapi/controlpanels/registry.py b/src/plone/restapi/controlpanels/registry.py\nindex 56d9b5e61..4eac5da05 100644\n--- a/src/plone/restapi/controlpanels/registry.py\n+++ b/src/plone/restapi/controlpanels/registry.py\n@@ -1,5 +1,8 @@\n+from importlib import import_module\n from zope.component import adapter\n+from zope.i18n import translate\n from zope.interface import Interface\n+from zope.globalrequest import getRequest\n from Products.CMFPlone.interfaces.controlpanel import IDateAndTimeSchema\n from Products.CMFPlone.interfaces.controlpanel import IEditingSchema\n from Products.CMFPlone.interfaces.controlpanel import IImagingSchema\n@@ -18,6 +21,8 @@\n except ImportError:  # pragma: no cover\n     from Products.CMFPlone.interfaces.controlpanel import ILanguageSchema\n \n+PLONE_6 = getattr(import_module("Products.CMFPlone.factory"), "PLONE60MARKER", False)\n+\n \n # General\n @adapter(Interface, Interface)\n@@ -111,3 +116,16 @@ class UserGroupControlpanel(RegistryConfigletPanel):\n     schema = IUserGroupsSettingsSchema\n     configlet_id = "UsersGroupsSettings"\n     configlet_category_id = "plone-users"\n+    if not PLONE_6:\n+        title = translate(\n+            "User and Group Settings",\n+            default="User and Group Settings",\n+            domain="plone",\n+            context=getRequest(),\n+        )\n+        group = translate(\n+            "Users and Groups",\n+            default="Users and Groups",\n+            domain="plone",\n+            context=getRequest(),\n+        )\ndiff --git a/src/plone/restapi/tests/http-examples/translated_messages_addons.resp b/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\nindex 383d9b595..a0e709a86 100644\n--- a/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\n+++ b/src/plone/restapi/tests/http-examples/translated_messages_addons.resp\n@@ -73,7 +73,7 @@ Content-Type: application/json\n                 "newVersion": "0006",\n                 "required": false\n             },\n-            "version": "8.25.1.dev0"\n+            "version": "8.28.1.dev0"\n         },\n         {\n             "@id": "http://localhost:55001/plone/@addons/plone.session",\ndiff --git a/src/plone/restapi/tests/test_services_controlpanels.py b/src/plone/restapi/tests/test_services_controlpanels.py\nindex 1387bb0ae..f23affcca 100644\n--- a/src/plone/restapi/tests/test_services_controlpanels.py\n+++ b/src/plone/restapi/tests/test_services_controlpanels.py\n@@ -114,3 +114,8 @@ def test_update_required(self):\n         response = response.json()\n         self.assertIn("message", response)\n         self.assertIn("Required input is missing.", response["message"])\n+\n+    def test_get_usergroup_control_panel(self):\n+        # This control panel does not exist in Plone 5\n+        response = self.api_session.get("/@controlpanels/usergroup")\n+        self.assertEqual(200, response.status_code)\n'

