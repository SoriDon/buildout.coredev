Repository: mockup


Branch: refs/heads/master
Date: 2022-06-03T00:47:39+02:00
Author: petschki (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/913b96126d16625a98b2b4658ec265d83f594b4c

start rewriting recurrence pattern

Files changed:
A src/pat/recurrence/recurrence.scss
A src/pat/recurrence/templates/display.xml
A src/pat/recurrence/templates/form.xml
A src/pat/recurrence/templates/occurrence.xml
M src/pat/recurrence/recurrence.js

b'diff --git a/src/pat/recurrence/recurrence.js b/src/pat/recurrence/recurrence.js\nindex 8a90c43f0..c615471a4 100644\n--- a/src/pat/recurrence/recurrence.js\n+++ b/src/pat/recurrence/recurrence.js\n@@ -1,34 +1,804 @@\n import "regenerator-runtime/runtime"; // needed for ``await`` support\n import $ from "jquery";\n+import _ from "underscore";\n import Base from "@patternslib/patternslib/src/core/base";\n+import DisplayTemplate from "./templates/display.xml";\n+import FormTemplate from "./templates/form.xml";\n+import OccurrenceTemplate from "./templates/occurrence.xml";\n+import Modal from "../modal/modal";\n+\n+\n+const RecurrenceInput = function(conf, textarea) {\n+\n+    var self = this;\n+    var form, display;\n+\n+    // Extend conf with non-configurable data used by templates.\n+    var orderedWeekdays = [];\n+    var index, i;\n+    for (i = 0; i < 7; i++) {\n+        index = i + conf.firstDay;\n+        if (index > 6) {\n+            index = index - 7;\n+        }\n+        orderedWeekdays.push(index);\n+    }\n+\n+    $.extend(conf, {\n+        orderIndexes: [\'+1\', \'+2\', \'+3\', \'+4\', \'-1\'],\n+        weekdays: [\'SU\', \'MO\', \'TU\', \'WE\', \'TH\', \'FR\', \'SA\'],\n+        orderedWeekdays: orderedWeekdays\n+    });\n+\n+    // The recurrence type dropdown should show certain fields depending\n+    // on selection:\n+    function displayFields(selector) {\n+        var i;\n+        // First hide all the fields\n+        form.find(\'.rifield\').hide();\n+        // Then show the ones that should be shown.\n+        var value = selector.val();\n+        if (value) {\n+            var rtemplate = conf.rtemplate[value];\n+            for (i = 0; i < rtemplate.fields.length; i++) {\n+                form.find(\'#\' + rtemplate.fields[i]).show();\n+            }\n+        }\n+    }\n+\n+    function occurrenceExclude(event) {\n+        event.preventDefault();\n+        if (form.ical.EXDATE === undefined) {\n+            form.ical.EXDATE = [];\n+        }\n+        form.ical.EXDATE.push(this.attributes.date.value);\n+        var $this = $(this);\n+        $this.attr(\'class\', \'exdate\');\n+        $this.parent().parent().addClass(\'exdate\');\n+        $this.unbind(event);\n+        $this.on("click", occurrenceInclude);\n+    }\n+\n+    function occurrenceInclude(event) {\n+        event.preventDefault();\n+        form.ical.EXDATE.splice($.inArray(this.attributes.date.value, form.ical.EXDATE), 1);\n+        var $this = $(this);\n+        $this.attr(\'class\', \'rrule\');\n+        $this.parent().parent().removeClass(\'exdate\');\n+        $this.unbind(event);\n+        $this.on("click", occurrenceExclude);\n+    }\n+\n+    function occurrenceDelete(event) {\n+        event.preventDefault();\n+        form.ical.RDATE.splice($.inArray(this.attributes.date.value, form.ical.RDATE), 1);\n+        $(this).parent().parent().hide(\'slow\', function () {\n+            $(this).remove();\n+        });\n+    }\n+\n+    function occurrenceAdd(event) {\n+        event.preventDefault();\n+        var datevalue = form\n+            .find(\'.riaddoccurrence input#adddate\')\n+            .val();\n+        if (form.ical.RDATE === undefined) {\n+            form.ical.RDATE = [];\n+        }\n+        var errorarea = form.find(\'.riaddoccurrence div.errorarea\');\n+        errorarea.text(\'\');\n+        errorarea.hide();\n+\n+        // Add date only if it is not already in RDATE\n+        if ($.inArray(datevalue, form.ical.RDATE) === -1) {\n+            form.ical.RDATE.push(datevalue);\n+            var html = [\'<div class="occurrence rdate" style="display: none;">\',\n+                    \'<span class="rdate">\',\n+                        dateinput.getValue(conf.localization.longDateFormat),\n+                        \'<span class="rlabel">\' + conf.localization.additionalDate + \'</span>\',\n+                    \'</span>\',\n+                    \'<span class="action">\',\n+                        \'<a date="\' + datevalue + \'" href="#" class="rdate" >\',\n+                            \'Include\',\n+                        \'</a>\',\n+                    \'</span>\',\n+                    \'</div>\'].join(\'\\n\');\n+            form.find(\'div.rioccurrences\').prepend(html);\n+            $(form.find(\'div.rioccurrences div\')[0]).slideDown();\n+            $(form.find(\'div.rioccurrences .action a.rdate\')[0]).click(occurrenceDelete);\n+        } else {\n+            errorarea.text(conf.localization.alreadyAdded).show();\n+        }\n+    }\n+\n+    // element is where to find the tag in question. Can be the form\n+    // or the display widget. Defaults to the form.\n+    function loadOccurrences(startdate, rfc5545, start, readonly) {\n+        var element, occurrenceDiv;\n+\n+        if (!readonly) {\n+            element = form;\n+        } else {\n+            element = display;\n+        }\n+\n+        occurrenceDiv = element.find(\'.rioccurrences\');\n+        occurrenceDiv.hide();\n+\n+        var year, month, day;\n+        year = startdate.getFullYear();\n+        month = startdate.getMonth() + 1;\n+        day = startdate.getDate();\n+\n+        var data = {year: year,\n+                   month: month, // Sending January as 0? I think not.\n+                   day: day,\n+                   rrule: rfc5545,\n+                   format: conf.localization.longDateFormat,\n+                   start: start};\n+\n+        var dict = {\n+            url: conf.ajaxURL,\n+            async: false, // Can\'t be tested if it\'s asynchronous, annoyingly.\n+            type: \'post\',\n+            dataType: \'json\',\n+            contentType: conf.ajaxContentType,\n+            cache: false,\n+            data: data,\n+            success: function (data, status, jqXHR) {\n+                var result, element;\n+\n+                if (!readonly) {\n+                    element = form;\n+                } else {\n+                    element = display;\n+                }\n+                data.readOnly = readonly;\n+                data.localization = conf.localization;\n+\n+                // Format dates:\n+                var occurrence, date, y, m, d, each;\n+                for (each in data.occurrences) {\n+                    if (data.occurrences.hasOwnProperty(each)) {\n+                        occurrence = data.occurrences[each];\n+                        date = occurrence.date;\n+                        y = parseInt(date.substring(0, 4), 10);\n+                        m = parseInt(date.substring(4, 6), 10) - 1; // jan=0\n+                        d = parseInt(date.substring(6, 8), 10);\n+                        occurrence.formattedDate = format(new Date(y, m, d), conf.localization.longDateFormat, conf);\n+                    }\n+                }\n+\n+                result = _.template(OccurrenceTemplate)(data);\n+                occurrenceDiv = element.find(\'.rioccurrences\');\n+                occurrenceDiv.replaceWith(result);\n+\n+                // Add the batch actions:\n+                element.find(\'.rioccurrences .batching a\').click(\n+                    function (event) {\n+                        event.preventDefault();\n+                        loadOccurrences(startdate, rfc5545, this.attributes.start.value, readonly);\n+                    }\n+                );\n+\n+                // Add the delete/undelete actions:\n+                if (!readonly) {\n+                    element.find(\'.rioccurrences .action a.rrule\').click(occurrenceExclude);\n+                    element.find(\'.rioccurrences .action a.exdate\').click(occurrenceInclude);\n+                    element.find(\'.rioccurrences .action a.rdate\').click(occurrenceDelete);\n+                }\n+                // Show the new div\n+                element.find(\'.rioccurrences\').show();\n+            },\n+            error: function (jqXHR, textStatus, errorThrown) {\n+                alert(textStatus);\n+            }\n+        };\n+\n+        $.ajax(dict);\n+    }\n+\n+    function getField(field) {\n+        // See if it is a field already\n+        var realField = $(field);\n+        if (!realField.length) {\n+            // Otherwise, we assume it\'s an id:\n+            realField = $(\'#\' + field);\n+        }\n+        if (!realField.length) {\n+            // Still not? Then it\'s a name.\n+            realField = $("input[name=\'" + field + "\']");\n+        }\n+        return realField;\n+    }\n+    function findStartDate() {\n+        var startdate = null;\n+        var startField, startFieldYear, startFieldMonth, startFieldDay;\n+\n+        // Find the default byday and bymonthday from the start date, if any:\n+        if (conf.startField) {\n+            startField = getField(conf.startField);\n+            if (!startField.length) {\n+                // Field not found\n+                return null;\n+            }\n+            // Now we have a field, see if it is a dateinput field:\n+            startdate = startField.data(\'dateinput\');\n+            if (!startdate) {\n+                //No, it wasn\'t, just try to interpret it with Date()\n+                startdate = startField.val();\n+                if (startdate === "") {\n+                    // Probably not an input at all. Try to see if it contains a date\n+                    startdate = startField.text();\n+                }\n+            } else {\n+                // Yes it was, get the date:\n+                startdate = startdate.getValue();\n+            }\n+\n+            if (typeof startdate === \'string\') {\n+                // convert human readable, non ISO8601 dates, like\n+                // \'2014-04-24 19:00\', where the \'T\' separator is missing.\n+                startdate = startdate.replace(\' \', \'T\');\n+            }\n+\n+            startdate = new Date(startdate);\n+        } else if (conf.startFieldYear &&\n+                   conf.startFieldMonth &&\n+                   conf.startFieldDay) {\n+            startFieldYear = getField(conf.startFieldYear);\n+            startFieldMonth = getField(conf.startFieldMonth);\n+            startFieldDay = getField(conf.startFieldDay);\n+            if (!startFieldYear.length &&\n+                !startFieldMonth.length &&\n+                !startFieldDay.length) {\n+                // Field not found\n+                return null;\n+            }\n+            startdate = new Date(startFieldYear.val(),\n+                                 startFieldMonth.val() - 1,\n+                                 startFieldDay.val());\n+        }\n+        if (startdate === null) {\n+            return null;\n+        }\n+        // We have some sort of startdate:\n+        if (isNaN(startdate)) {\n+            return null;\n+        }\n+        return startdate;\n+    }\n+    function findEndDate(form) {\n+        var endField, enddate;\n+\n+        endField = form.find(\'input[name=rirangebyenddatecalendar]\');\n+\n+        // Now we have a field, see if it is a dateinput field:\n+        enddate = endField.data(\'dateinput\');\n+        if (!enddate) {\n+            //No, it wasn\'t, just try to interpret it with Date()\n+            enddate = endField.val();\n+        } else {\n+            // Yes it was, get the date:\n+            enddate = enddate.getValue();\n+        }\n+        enddate = new Date(enddate);\n+\n+        // if the end date is incorrect or the field is left empty\n+        if (isNaN(enddate) || endField.val() === "") {\n+            return null;\n+        }\n+        return enddate;\n+    }\n+    function findIntField(fieldName, form) {\n+        var field, num, isInt;\n+\n+        field = form.find(\'input[name=\' + fieldName + \']\');\n+\n+        num = field.val();\n+\n+        // if it\'s not a number or the field is left empty\n+        if (isNaN(num) || (num.toString().indexOf(\'.\') !== -1) || field.val() === "") {\n+            return null;\n+        }\n+        return num;\n+    }\n+\n+    // Loading (populating) display and form widget with\n+    // passed RFC5545 string (data)\n+    function loadData(rfc5545) {\n+        var selector, format, startdate, dayindex, day;\n+\n+        if (rfc5545) {\n+            widgetLoadFromRfc5545(form, conf, rfc5545, true);\n+        }\n+\n+        startdate = findStartDate();\n+\n+        if (startdate !== null) {\n+            // If the date is a real date, set the defaults in the form\n+            form.find(\'select[name=rimonthlydayofmonthday]\').val(startdate.getDate());\n+            dayindex = conf.orderIndexes[Math.floor((startdate.getDate() - 1) / 7)];\n+            day = conf.weekdays[startdate.getDay()];\n+            form.find(\'select[name=rimonthlyweekdayofmonthindex]\').val(dayindex);\n+            form.find(\'select[name=rimonthlyweekdayofmonth]\').val(day);\n+\n+            form.find(\'select[name=riyearlydayofmonthmonth]\').val(startdate.getMonth() + 1);\n+            form.find(\'select[name=riyearlydayofmonthday]\').val(startdate.getDate());\n+            form.find(\'select[name=riyearlyweekdayofmonthindex]\').val(dayindex);\n+            form.find(\'select[name=riyearlyweekdayofmonthday]\').val(day);\n+            form.find(\'select[name=riyearlyweekdayofmonthmonth]\').val(startdate.getMonth() + 1);\n+\n+            // Now when we have a start date, we can also do an ajax call to calculate occurrences:\n+            loadOccurrences(startdate, widgetSaveToRfc5545(form, conf, false).result, 0, false);\n+\n+            // Show the add and refresh buttons:\n+            form.find(\'div.rioccurrencesactions\').show();\n+\n+        } else {\n+            // No EXDATE/RDATE support\n+            form.find(\'div.rioccurrencesactions\').hide();\n+        }\n+\n+\n+        selector = form.find(\'select[name=rirtemplate]\');\n+        displayFields(selector);\n+    }\n+\n+    function recurrenceOn() {\n+        var RFC5545 = widgetSaveToRfc5545(form, conf, false);\n+        var label = display.find(\'label[class=ridisplay]\');\n+        label.text(conf.localization.displayActivate + \' \' + RFC5545.description);\n+        textarea.val(RFC5545.result).change();\n+        var startdate = findStartDate();\n+        if (startdate !== null) {\n+            loadOccurrences(startdate, widgetSaveToRfc5545(form, conf, false).result, 0, true);\n+        }\n+        display.find(\'button[name="riedit"]\').text(conf.localization.edit_rules);\n+        display.find(\'button[name="ridelete"]\').show();\n+    }\n+\n+    function recurrenceOff() {\n+        var label = display.find(\'label[class=ridisplay]\');\n+        label.text(conf.localization.displayUnactivate);\n+        textarea.val(\'\').change();  // Clear the textarea.\n+        display.find(\'.rioccurrences\').hide();\n+        display.find(\'button[name="riedit"]\').text(conf.localization.add_rules);\n+        display.find(\'button[name="ridelete"]\').hide();\n+    }\n+\n+    function checkFields(form) {\n+        var startDate, endDate, num, messagearea;\n+        startDate = findStartDate();\n+\n+        // Hide any error message from before\n+        messagearea = form.find(\'#messagearea\');\n+        messagearea.text(\'\');\n+        messagearea.hide();\n+\n+        // Hide add field errors\n+        form.find(\'.riaddoccurrence div.errorarea\').text(\'\').hide();\n+\n+        // Repeats Daily\n+        if (form.find(\'#ridailyinterval\').css(\'display\') === \'block\') {\n+            // Check repeat every field\n+            num = findIntField(\'ridailyinterval\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noRepeatEvery).show();\n+                return false;\n+            }\n+        }\n+\n+        // Repeats Weekly\n+        if (form.find(\'#riweeklyinterval\').css(\'display\') === \'block\') {\n+            // Check repeat every field\n+            num = findIntField(\'riweeklyinterval\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noRepeatEvery).show();\n+                return false;\n+            }\n+        }\n+\n+        // Repeats Monthly\n+        if (form.find(\'#rimonthlyinterval\').css(\'display\') === \'block\') {\n+            // Check repeat every field\n+            num = findIntField(\'rimonthlyinterval\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noRepeatEvery).show();\n+                return false;\n+            }\n+\n+            // Check repeat on\n+            if (form.find(\'#rimonthlyoptions input:checked\').length === 0) {\n+                messagearea.text(conf.localization.noRepeatOn).show();\n+                return false;\n+            }\n+        }\n+\n+        // Repeats Yearly\n+        if (form.find(\'#riyearlyinterval\').css(\'display\') === \'block\') {\n+            // Check repeat every field\n+            num = findIntField(\'riyearlyinterval\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noRepeatEvery).show();\n+                return false;\n+            }\n+\n+            // Check repeat on\n+            if (form.find(\'#riyearlyoptions input:checked\').length === 0) {\n+                messagearea.text(conf.localization.noRepeatOn).show();\n+                return false;\n+            }\n+        }\n+\n+        // End recurrence fields\n+\n+        // If after N occurences is selected, check its value\n+        if (form.find(\'input[value="BYOCCURRENCES"]:visible:checked\').length > 0) {\n+            num = findIntField(\'rirangebyoccurrencesvalue\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noEndAfterNOccurrences).show();\n+                return false;\n+            }\n+        }\n+\n+        // If end date is selected, check its value\n+        if (form.find(\'input[value="BYENDDATE"]:visible:checked\').length > 0) {\n+            endDate = findEndDate(form);\n+            if (!endDate) {\n+                // if endDate is null that means the field is empty\n+                messagearea.text(conf.localization.noEndDate).show();\n+                return false;\n+            } else if (endDate < startDate) {\n+                // the end date cannot be before start date\n+                messagearea.text(conf.localization.pastEndDate).show();\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    function save(event) {\n+        event.preventDefault();\n+        // if no field errors, process the request\n+        if (checkFields(form)) {\n+            // close overlay\n+            form.overlay().close();\n+            recurrenceOn();\n+        }\n+    }\n+\n+    function cancel(event) {\n+        event.preventDefault();\n+        // close overlay\n+        form.overlay().close();\n+    }\n+\n+    function updateOccurances() {\n+        var startDate;\n+        startDate = findStartDate();\n+\n+        // if no field errors, process the request\n+        if (checkFields(form)) {\n+            loadOccurrences(startDate,\n+                widgetSaveToRfc5545(form, conf, false).result,\n+                0,\n+                false);\n+        }\n+    }\n+\n+    /*\n+      Load the templates\n+    */\n+\n+    var now_date = (new Date()).toISOString().substring(0, 10);\n+    display = $(_.template(DisplayTemplate)(conf));\n+    form = $(_.template(FormTemplate)(conf));\n+\n+    // Make an overlay and hide it\n+    this.modal = new Modal(form);\n+\n+    form.ical = {RDATE: [], EXDATE: []};\n+\n+    // Make the date input into a calendar dateinput()\n+    form.find(\'input[name=rirangebyenddatecalendar]\').val(now_date);\n+\n+    if (textarea.val()) {\n+        var result = widgetLoadFromRfc5545(form, conf, textarea.val(), false);\n+        if (result === -1) {\n+            var label = display.find(\'label[class=ridisplay]\');\n+            label.text(conf.localization.noRule);\n+        } else {\n+            recurrenceOn();\n+        }\n+    }\n+\n+    /*\n+      Do all the GUI stuff:\n+    */\n+\n+    // When you click "Delete...", the recurrence rules should be cleared.\n+    display.find(\'button[name=ridelete]\').click(function (e) {\n+        e.preventDefault();\n+        recurrenceOff();\n+    });\n+\n+    // Show form overlay when you click on the "Edit..." link\n+    display.find(\'button[name=riedit]\').on(\n+        "click",\n+        function (e) {\n+            // Load the form to set up the right fields to show, etc.\n+            loadData(textarea.val());\n+            e.preventDefault();\n+            form.overlay().load();\n+        }\n+    );\n+\n+    // Pop up the little add form when clicking "Add"\n+    form.find(\'div.riaddoccurrence input#adddate\').val(now_date);\n+    form.find(\'input#addaction\').on("click", occurrenceAdd);\n+\n+    // When the reload button is clicked, reload\n+    form.find(\'a.rirefreshbutton\').on(\n+        "click",\n+        function (event) {\n+            event.preventDefault();\n+            updateOccurances();\n+        }\n+    );\n+\n+    // When selecting template, update what fieldsets are visible.\n+    form.find(\'select[name=rirtemplate]\').change(\n+        function (e) {\n+            displayFields($(this));\n+        }\n+    );\n+\n+    // When focus goes to a drop-down, select the relevant radiobutton.\n+    form.find(\'select\').change(\n+        function (e) {\n+            $(this).parent().find(\'> input\').click().change();\n+        }\n+    );\n+    form.find(\'input[name=rirangebyoccurrencesvalue]\').change(\n+        function (e) {\n+            $(this).parent().find(\'input[name=rirangetype]\').click().change();\n+        }\n+    );\n+    form.find(\'input[name=rirangebyenddatecalendar]\').change(function () {\n+        // Update only if the occurances are shown\n+        $(this).parent().find(\'input[name=rirangetype]\').click();\n+        if (form.find(\'.rioccurrencesactions:visible\').length !== 0) {\n+            updateOccurances();\n+        }\n+    });\n+    // Update the selected dates section\n+    form.find(\'input:radio, .riweeklyweekday > input, input[name=ridailyinterval], input[name=riweeklyinterval], input[name=rimonthlyinterval], input[name=riyearlyinterval]\').change(\n+        function (e) {\n+            // Update only if the occurances are shown\n+            if (form.find(\'.rioccurrencesactions:visible\').length !== 0) {\n+                updateOccurances();\n+            }\n+        }\n+    );\n+\n+    /*\n+      Save and cancel methods:\n+    */\n+    form.find(\'.ricancelbutton\').click(cancel);\n+    form.find(\'.risavebutton\').click(save);\n+\n+    /*\n+     * Public API of RecurrenceInput\n+     */\n+\n+    $.extend(self, {\n+        display: display,\n+        form: form,\n+        loadData: loadData, //Used by tests.\n+        save: save //Used by tests.\n+    });\n+\n+}\n \n export default Base.extend({\n     name: "recurrence",\n     trigger: ".pat-recurrence",\n     parser: "mockup",\n     defaults: {\n-        // just passed onto the widget\n-        language: "en",\n-        localization: null,\n-        configuration: {},\n+        localization: {\n+            displayUnactivate: \'Does not repeat\',\n+            displayActivate: \'Repeats every\',\n+            add_rules: \'Add\',\n+            edit_rules: \'Edit\',\n+            delete_rules: \'Delete\',\n+            add:  \'Add\',\n+            refresh: \'Refresh\',\n+\n+            title: \'Repeat\',\n+            preview: \'Selected dates\',\n+            addDate: \'Add date\',\n+\n+            recurrenceType: \'Repeats:\',\n+\n+            dailyInterval1: \'Repeat every:\',\n+            dailyInterval2: \'days\',\n+\n+            weeklyInterval1: \'Repeat every:\',\n+            weeklyInterval2: \'week(s)\',\n+            weeklyWeekdays: \'Repeat on:\',\n+            weeklyWeekdaysHuman: \'on:\',\n+\n+            monthlyInterval1: \'Repeat every:\',\n+            monthlyInterval2: \'month(s)\',\n+            monthlyDayOfMonth1: \'Day\',\n+            monthlyDayOfMonth1Human: \'on day\',\n+            monthlyDayOfMonth2: \'of the month\',\n+            monthlyDayOfMonth3: \'month(s)\',\n+            monthlyWeekdayOfMonth1: \'The\',\n+            monthlyWeekdayOfMonth1Human: \'on the\',\n+            monthlyWeekdayOfMonth2: \'\',\n+            monthlyWeekdayOfMonth3: \'of the month\',\n+            monthlyRepeatOn: \'Repeat on:\',\n+\n+            yearlyInterval1: \'Repeat every:\',\n+            yearlyInterval2: \'year(s)\',\n+            yearlyDayOfMonth1: \'Every\',\n+            yearlyDayOfMonth1Human: \'on\',\n+            yearlyDayOfMonth2: \'\',\n+            yearlyDayOfMonth3: \'\',\n+            yearlyWeekdayOfMonth1: \'The\',\n+            yearlyWeekdayOfMonth1Human: \'on the\',\n+            yearlyWeekdayOfMonth2: \'\',\n+            yearlyWeekdayOfMonth3: \'of\',\n+            yearlyWeekdayOfMonth4: \'\',\n+            yearlyRepeatOn: \'Repeat on:\',\n+\n+            range: \'End recurrence:\',\n+            rangeNoEnd: \'Never\',\n+            rangeByOccurrences1: \'After\',\n+            rangeByOccurrences1Human: \'ends after\',\n+            rangeByOccurrences2: \'occurrence(s)\',\n+            rangeByEndDate: \'On\',\n+            rangeByEndDateHuman: \'ends on\',\n+\n+            including: \', and also\',\n+            except: \', except for\',\n+\n+            cancel: \'Cancel\',\n+            save: \'Save\',\n+\n+            recurrenceStart: \'Start of the recurrence\',\n+            additionalDate: \'Additional date\',\n+            include: \'Include\',\n+            exclude: \'Exclude\',\n+            remove: \'Remove\',\n+\n+            orderIndexes: [\'first\', \'second\', \'third\', \'fourth\', \'last\'],\n+            months: [\n+                \'January\', \'February\', \'March\', \'April\', \'May\', \'June\',\n+                \'July\', \'August\', \'September\', \'October\', \'November\', \'December\'],\n+            shortMonths: [\n+                \'Jan\', \'Feb\', \'Mar\', \'Apr\', \'May\', \'Jun\',\n+                \'Jul\', \'Aug\', \'Sep\', \'Oct\', \'Nov\', \'Dec\'],\n+            weekdays: [\n+                \'Sunday\', \'Monday\', \'Tuesday\', \'Wednesday\', \'Thursday\',\n+                \'Friday\', \'Saturday\'],\n+            shortWeekdays: [\n+                \'Sun\', \'Mon\', \'Tue\', \'Wed\', \'Thu\', \'Fri\', \'Sat\'],\n+\n+            longDateFormat: \'mmmm dd, yyyy\',\n+            shortDateFormat: \'mm/dd/yyyy\',\n+\n+            unsupportedFeatures: \'Warning: This event uses recurrence features not \' +\n+                                  \'supported by this widget. Saving the recurrence \' +\n+                                  \'may change the recurrence in unintended ways:\',\n+            noTemplateMatch: \'No matching recurrence template\',\n+            multipleDayOfMonth: \'This widget does not support multiple days in monthly or yearly recurrence\',\n+            bysetpos: \'BYSETPOS is not supported\',\n+            noRule: \'No RRULE in RRULE data\',\n+            noRepeatEvery: \'Error: The "Repeat every"-field must be between 1 and 1000\',\n+            noEndDate: \'Error: End date is not set. Please set a correct value\',\n+            noRepeatOn: \'Error: "Repeat on"-value must be selected\',\n+            pastEndDate: \'Error: End date cannot be before start date\',\n+            noEndAfterNOccurrences: \'Error: The "After N occurrences"-field must be between 1 and 1000\',\n+            alreadyAdded: \'This date was already added\',\n+\n+            rtemplate: {\n+                daily: \'Daily\',\n+                mondayfriday: \'Monday and Friday\',\n+                weekdays: \'Weekday\',\n+                weekly: \'Weekly\',\n+                monthly: \'Monthly\',\n+                yearly: \'Yearly\'\n+            }\n+        },\n+\n+        readOnly: false,\n+        firstDay: 0,\n+\n+        // "REMOTE" FIELD\n+        startField: null,\n+        startFieldYear: null,\n+        startFieldMonth: null,\n+        startFieldDay: null,\n+        ajaxURL: null,\n+        ajaxContentType: \'application/json; charset=utf8\',\n+        ributtonExtraClass: \'\',\n+\n+        // INPUT CONFIGURATION\n+        hasRepeatForeverButton: true,\n+\n+        // JQUERY TEMPLATE NAMES\n+        template: {\n+            form: \'#jquery-recurrenceinput-form-tmpl\',\n+            display: \'#jquery-recurrenceinput-display-tmpl\'\n+        },\n+\n+        // RECURRENCE TEMPLATES\n+        rtemplate: {\n+            daily: {\n+                rrule: \'FREQ=DAILY\',\n+                fields: [\n+                    \'ridailyinterval\',\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            mondayfriday: {\n+                rrule: \'FREQ=WEEKLY;BYDAY=MO,FR\',\n+                fields: [\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            weekdays: {\n+                rrule: \'FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR\',\n+                fields: [\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            weekly: {\n+                rrule: \'FREQ=WEEKLY\',\n+                fields: [\n+                    \'riweeklyinterval\',\n+                    \'riweeklyweekdays\',\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            monthly: {\n+                rrule: \'FREQ=MONTHLY\',\n+                fields: [\n+                    \'rimonthlyinterval\',\n+                    \'rimonthlyoptions\',\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            yearly: {\n+                rrule: \'FREQ=YEARLY\',\n+                fields: [\n+                    \'riyearlyinterval\',\n+                    \'riyearlyoptions\',\n+                    \'rirangeoptions\'\n+                ]\n+            }\n+        }\n     },\n+\n     init: async function () {\n         // tmpl BEFORE recurrenceinput\n-        import("jquery.recurrenceinput.js/lib/jquery.tools.dateinput.css");\n-        import("jquery.recurrenceinput.js/lib/jquery.tools.overlay.css");\n-        import("jquery.recurrenceinput.js/src/jquery.recurrenceinput.css");\n-        await import("jquery.recurrenceinput.js/lib/jquery.tools.dateinput");\n-        await import("jquery.recurrenceinput.js/lib/jquery.tools.overlay");\n-        await import("jquery.recurrenceinput.js/lib/jquery.tmpl");\n-        await import("jquery.recurrenceinput.js/src/jquery.recurrenceinput");\n+        import("./recurrence.scss");\n \n         this.$el.addClass("recurrence-widget");\n-        if (this.options.localization) {\n-            $.tools.recurrenceinput.localize(\n-                this.options.language,\n-                this.options.localization\n-            );\n-        }\n-        $(this.el).recurrenceinput(this.options.configuration);\n+\n+        // "compile" configuration for widget\n+\n+        // our recurrenceinput widget instance\n+        var recurrenceinput = new RecurrenceInput(this.options, this.$el);\n+        // hide textarea and place display widget after textarea\n+        recurrenceinput.form.appendTo(\'body\');\n+        this.$el.after(recurrenceinput.display);\n+\n+        // hide the textarea\n+        this.$el.hide();\n     },\n });\ndiff --git a/src/pat/recurrence/recurrence.scss b/src/pat/recurrence/recurrence.scss\nnew file mode 100644\nindex 000000000..b0f7fb39f\n--- /dev/null\n+++ b/src/pat/recurrence/recurrence.scss\n@@ -0,0 +1,226 @@\n+div.riform {\n+    padding: 1em;\n+    background-color: white;\n+    box-shadow: 0 0 3em 0.5em #666;\n+    line-height: 2;\n+    -moz-box-shadow: 0 0 3em 0.5em #666;\n+    -webkit-box-shadow: 0 0 3em #666;\n+\n+    h1 {\n+        color: #888888;\n+        border-bottom: 1px solid #DDDDDD;\n+        font-size: 20px;\n+        line-height: 1;\n+        margin: 0;\n+        padding-bottom: 5px;\n+        padding-left: 5px;\n+    }\n+\n+    form {\n+        margin-bottom: 0;\n+    }\n+\n+    .rifield {\n+        clear: both;\n+    }\n+\n+    .rifield .field {\n+        float:left;\n+        clear: none;\n+    }\n+\n+    .label {\n+        display: block;\n+        float: left;\n+        font-weight: bold;\n+        margin-right: 10px;\n+        text-align: right;\n+        width: 130px;\n+    }\n+\n+    #rirtemplate {\n+        margin-top: 6px;\n+    }\n+\n+    div#riformfields {\n+        min-height: 11em;\n+        min-width: 25em;\n+    }\n+\n+    #rirangeoptions input,\n+    #rimonthlyoptions input,\n+    #riyearlyoptions input {\n+        margin: 0;\n+    }\n+\n+    #riweeklyweekdays .riweeklyweekday input {\n+        display:block;\n+        margin: 8px auto 0;\n+    }\n+    #riweeklyweekdays .riweeklyweekday label {\n+        display:block;\n+    }\n+\n+    #riweeklyweekdays .riweeklyweekday {\n+        margin-right: 15px;\n+        float: left;\n+    }\n+\n+    input.ricancelbutton {\n+        // pb_close.png\n+        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAABHVBMVEUAAAAAAAADAwMEBAQFBQUGBgYJCQkKCgoPDw8RERETExMWFhYbGxscHBwfHx8iIiIlJSUoKCgsLCwyMjI1NTU4ODg7OztDQ0NGRkZKSkpLS0tNTU1XV1ddXV1gYGBjY2NkZGRmZmZoaGhsbGxvb291dXV7e3t+fn6BgYGCgoKFhYWLi4uMjIyNjY2Ojo6QkJCTk5OVlZWWlpaXl5eZmZmdnZ2fn5+qqqqurq6vr6+ysrKzs7O5ubnCwsLFxcXHx8fJycnLy8vMzMzR0dHV1dXY2Nja2trc3Nzd3d3f39/g4ODh4eHk5OTl5eXo6Ojr6+vs7Ozt7e3u7u7x8fHy8vLz8/P19fX29vb39/f4+Pj6+vr7+/v8/Pz9/f3////kwcJJAAAAAXRSTlMAQObYZgAAAThJREFUKBXNwWdb2gAYhtH3CVbQFisVlOLWVlHcdeBedXSQqoiR4f3/f4YJF8Gg9psfPMfezL8avvqNvaaCz/2Nr2wvPFBbz8qXXrynZs/AXp9aUidgHRpsOmpz5sEibthzFLVGxZ5wl5Q0MCjfx/G49KGEtf1iRdIXyEufS6xLmuTKQh4ZSX0e5PtLUJDU28BC3CqQ8+AWio58p1iIczXlqkDRUWCHH9bCTzWlroA5NW2zai1cK5ByoQF5BY74bi01kpISLhSHPZiW5JSx0CXfJGWg6CjnsSUpi2uhJdy4pMlpR1I6n5S0z661lSiowxgVezIBY4oYrLNqEWswq7bRKgcW1bMCZyNxBbKHcCDrkJj6C9XTjY3jMlwvyJ6Ja/mCpj+bXbKXupUYmpn5+kmy/4jFFLP34hGuw0GxTwkuWgAAAABJRU5ErkJggg==);\n+        background-color: transparent;\n+        font-size: 0; /* For IE8 */\n+        color: transparent;\n+        border: none;\n+        position: absolute;\n+        left: -14px;\n+        top: -14px;\n+        cursor: pointer;\n+        height: 30px;\n+        width: 30px;\n+    }\n+}\n+\n+div.rioccurrencesactions .riaddoccurrence #adddate {\n+    width: 75%;\n+}\n+\n+div.rioccurrencesactions .rioccurancesheader {\n+    border-bottom: 1px solid #DDDDDD;\n+    line-height: 1.5;\n+    clear: both;\n+    margin-top: 30px;\n+}\n+\n+div.rioccurrencesactions .rioccurancesheader h2 {\n+    color: #888888;\n+    display: inline;\n+    font-size: 18px;\n+    font-weight: bold;\n+    margin: 0px 0px 5px 5px;\n+}\n+\n+\n+div.rioccurrences div.batching {\n+    font-size: 70%;\n+    text-align: center;\n+}\n+\n+div.rioccurrences span.current {\n+    font-weight: bold;\n+}\n+\n+div.riform span.action a {\n+    height: 19px;\n+    width: 19px;\n+    overflow: hidden;\n+    float: right;\n+    text-indent: 9999px;\n+}\n+\n+div.rioccurrences .occurrence {\n+    border-top: 1px solid transparent;\n+    border-bottom: 1px solid transparent;\n+}\n+\n+div.rioccurrences .occurrence:hover {\n+    border-top: 1px solid #DDDDDD;\n+    border-bottom: 1px solid #DDDDDD;\n+}\n+\n+div.rioccurrences .occurrence.start span.rlabel,\n+div.rioccurrences .occurrence.rdate span.rlabel {\n+    color: #9CBA9B;\n+    margin: 0 5px;\n+    font-size: 70%;\n+    font-weight: bold;\n+}\n+\n+div.rioccurrences .occurrence.exdate {\n+    opacity:0.4;\n+    filter:alpha(opacity=40);\n+}\n+\n+div.ridisplay .occurrence.exdate {\n+    display: none;\n+}\n+\n+div.ridisplay label.ridisplay {\n+    font-weight: 300;\n+}\n+\n+div.ridisplay .rimain a {\n+    margin-right: 0.5em;\n+}\n+\n+div.rioccurrences .occurrence.rdate {\n+    background: #FFFFE0;\n+}\n+\n+div.rioccurrences div.occurrence {\n+    margin-left: 5px;\n+}\n+\n+div.rioccurrences a.rrule,\n+div.rioccurrences a.rdate,\n+div.rioccurrences a.exdate {\n+    color: transparent;\n+    margin-top: 6px;\n+    margin-right: 5px;\n+}\n+\n+\n+div.rioccurrences a.rrule,\n+div.rioccurrences a.rdate {\n+    // delete.png\n+    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAMAAABFjsb+AAAAdVBMVEUAAAAAAAACAgIHBwcICAgODg4PDw8QEBASEhIXFxcbGxsdHR0fHx8gICAnJyc2NjY3Nzc4ODg5OTk+Pj5ERERISEhJSUlSUlJYWFhqampvb2/Hx8fPz8/R0dHn5+fs7Ozv7+/x8fHy8vL39/f9/f3+/v7///8jaUCMAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAAOkAAADpAVSSFEsAAAB9SURBVBjTY2BQQwcMDGqyYuxsCMAuJqvGoCbCiApEgGIsECaTEBOEwQIUYwbSbAKCUmqSggKsQDYzVEwGarw0kpiwKlhIhR9JjEVNXFlMWUKNEUWMU4FZgYfGYrxKHEp8KGJM8opqQCgHEwP7l1sUBLhg/sUWLljCD0s4AwBmjBYPljOv7QAAAABJRU5ErkJggg==);\n+}\n+\n+div.rioccurrences a.exdate {\n+    // undelete.png\n+    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAMAAABFjsb+AAAAnFBMVEUCodIAAAABAQEVAAAHBwcICAgKCgoPDw8QEBBTAABVAABZAABaAAAXFxdcBwdhCgodHR2TAAAhISFlDw9nDw8vLy8wMDAxMTH4AAD5AQH6AgL+Bgb/BweDKipBQUFERERJSUlQUFBXV1daWlpmZmb0nZ31nZ36o6P/pqb/qanNzc3R0dHp6ens7Ozt7e3v7+/y8vL39/f8/Pz////TudgfAAAAAXRSTlMAQObYZgAAAKFJREFUGFdt0FsXQkAUhuHZIYfIITTVFJVEiNr//781xoUJ79Ws52KvNR8hOI0QrFJDHzPSCgkmoIBcwk0D3+LP1X41mMZNBZNuozjDLI7W3FRhYJ/K4fxrNDgzgd+LZFAcn7fPHUE2DJnbOhNzcprPrHVZODP9cShm1u7Y5s+8zum8ktqS1Q2+saktagrTeguufQFYvvhvAnKK2GVhv4WdfzaPHhGyo11gAAAAAElFTkSuQmCC);\n+}\n+\n+div.rioccurrencesactions a.rirefreshbutton {\n+    // refresh.png\n+    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAMAAABFjsb+AAAA1VBMVEWbLGwAAAABAQECAgIFBQUGBgYHBwcICAgJCQkKCgoWFhYZGRkaGhoeHh4fHx8gICAkJCQmJiYoKCgrKyssLCwxMTE3Nzc4ODg5OTk+Pj5DQ0NHR0dISEhRUVFUVFRWVlZXV1ddXV1fX19gYGBkZGRoaGhwcHBxcXF6enp/f3+BgYGDg4OEhISJiYmNjY2VlZWampqnp6eoqKirq6uurq62trbCwsLDw8PFxcXIyMjNzc3V1dXW1tbZ2dnb29vv7+/19fX39/f4+Pj6+vr7+/v8/Pz///9okOBsAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAAOkAAADpAVSSFEsAAADYSURBVBjTZdBrk8EwFAbghEprFaulxN2y2HVZ6n5tWX3//0+ScIwZ3g/JmWcmOTlhDK9hDBtpCiEqqYTQMeUGDJLrtBcxfo9UJnSRnKCfbyV1KchKRyDq4Fh6mhchxF8hQOQ9zDpg1V0a3F7hYJE1EdjlD3XMDtAkG8Gnnj5GZDMMyYaYkQ0wJ5tjQFbDyVFgec4JNTJji73LY/7vHlvj8T43xLn4gwtC9zlHbo2vf2CdozlMfXlcfvYwjuvSVFalnnz6fduqynaNbEYn7dTVmm3s9Ke+/fMVeXMr/BRXPaEAAAAASUVORK5CYII=);\n+    color: transparent;\n+    margin-top: 4px;\n+    margin-right: 5px;\n+}\n+\n+div#messagearea,\n+div.errorarea {\n+    display: none;\n+    background-color: red;\n+    color: white;\n+    font-weight: bold;\n+    padding: 2px 10px;\n+}\n+\n+div#calroot {\n+    z-index:10000;\n+}\n+\n+div.ributtons .risavebutton {\n+    display: block;\n+    margin: 30px auto 0;\n+}\n+\n+// jQueryTools overrides\n+#calnext,\n+#calprev {\n+    background-image: url(data:image/gif;base64,R0lGODlhDgAOAOZsAPb29vv7+/f39/Ly8vr6+vn5+QCFzfz8/PDw8PPz8wCEzQODzACHzwCFzgCBzCKb1fL7/fHx8aXZ7+r4/F295LXg8pTR6wKCzA2L0J3V7ZnW7T234gaS05bV7v3+/ofN65Tb8JfX7/n+/pff8uv6/YXN60C748/s9wCIz9ry+gKHzgOIzs7r9gF+yx+Z1QKEzSKg2AGP0mG54uf2++b4/AyP0QGCzGG844bN62m95Gm/5Fm95AeQ0vf8/bzl9ACAyxma1rbi9DKm2////weGzpfW7Mvp9QyO0J/Y7qrc8AiJz9jy+mK949Tv+QCDzHLA5geIzgCDzcfr9gqM0Mzv+ACQ0g2Q0sLn9XbM6y+p3L/s96LY706w3sbo9PX19ZXT7PD7/Tis3gyQ0g+R0v7+/gCGzgCHzvj4+ACCzPT09O/v7wCJz+7u7gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAGwALAAAAAAOAA4AAAe0gGyCamlnBAQCCYKLbAMHTVgbJh00BWqLA2QlMQpoCxdAQQGXagc4CmZlRxIWC1ZXZ2xpVBwGZTVIZBlKDllgCAUfaAxTGkNfUAxraydpATloK0VkW0Rmyw1JAAFPDio6EEYuUcsGFQBnIQZmNkwiLA9lZlUpCQMkME4oLzceXRg/KPS4VMDHGDRl0Mjg0kLIDC+DCEgJw2NNAzE7JghgpEYAGS0gRiw5kIbRogjozqRBwCgQADs=);\n+}\n+#calnext {\n+    background-image: url(data:image/gif;base64,R0lGODlhDgAOAOZsAPb29vv7+/f39/Ly8vr6+vn5+QCFzfz8/PDw8PPz8wCEzQODzACHzwCFzgCBzCKb1fL7/fHx8aXZ7+r4/F295LXg8pTR6wKCzA2L0J3V7ZnW7T234gaS05bV7v3+/ofN65Tb8JfX7/n+/pff8uv6/YXN60C748/s9wCIz9ry+gKHzgOIzs7r9gF+yx+Z1QKEzSKg2AGP0mG54uf2++b4/AyP0QGCzGG844bN62m95Gm/5Fm95AeQ0vf8/bzl9ACAyxma1rbi9DKm2////weGzpfW7Mvp9QyO0J/Y7qrc8AiJz9jy+mK949Tv+QCDzHLA5geIzgCDzcfr9gqM0Mzv+ACQ0g2Q0sLn9XbM6y+p3L/s96LY706w3sbo9PX19ZXT7PD7/Tis3gyQ0g+R0v7+/gCGzgCHzvj4+ACCzPT09O/v7wCJz+7u7gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAGwALAAAAAAOAA4AAAe2gGyCbAhpZ2cAEYOLaQdLIyBaZAJqiwITO2INazxhUgSVbF4zQi1cMmhlaGM+BWxqPRQ/GF0eNy8oTjAkAwkpVWZlDywiTDZmBiGIFQZra1EuRhA6Kg5PAQBJm2tmRFtkRStoOQFpJ84MUF9DGlMMaB8FCGBZDkoZZEg1ZQYcVGlszlyxssCChCNlzCjAcaCSmgBBgFxYgEZBjBJkBgxSU4BGBxMbsDQ5oHERmwQCCBA4kyYUm0AAOw==);\n+}\n+div.overlaybg div.close,\n+div.overlay div.close {\n+    // pb_close.png\n+    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAABHVBMVEUAAAAAAAADAwMEBAQFBQUGBgYJCQkKCgoPDw8RERETExMWFhYbGxscHBwfHx8iIiIlJSUoKCgsLCwyMjI1NTU4ODg7OztDQ0NGRkZKSkpLS0tNTU1XV1ddXV1gYGBjY2NkZGRmZmZoaGhsbGxvb291dXV7e3t+fn6BgYGCgoKFhYWLi4uMjIyNjY2Ojo6QkJCTk5OVlZWWlpaXl5eZmZmdnZ2fn5+qqqqurq6vr6+ysrKzs7O5ubnCwsLFxcXHx8fJycnLy8vMzMzR0dHV1dXY2Nja2trc3Nzd3d3f39/g4ODh4eHk5OTl5eXo6Ojr6+vs7Ozt7e3u7u7x8fHy8vLz8/P19fX29vb39/f4+Pj6+vr7+/v8/Pz9/f3////kwcJJAAAAAXRSTlMAQObYZgAAAThJREFUKBXNwWdb2gAYhtH3CVbQFisVlOLWVlHcdeBedXSQqoiR4f3/f4YJF8Gg9psfPMfezL8avvqNvaaCz/2Nr2wvPFBbz8qXXrynZs/AXp9aUidgHRpsOmpz5sEibthzFLVGxZ5wl5Q0MCjfx/G49KGEtf1iRdIXyEufS6xLmuTKQh4ZSX0e5PtLUJDU28BC3CqQ8+AWio58p1iIczXlqkDRUWCHH9bCTzWlroA5NW2zai1cK5ByoQF5BY74bi01kpISLhSHPZiW5JSx0CXfJGWg6CjnsSUpi2uhJdy4pMlpR1I6n5S0z661lSiowxgVezIBY4oYrLNqEWswq7bRKgcW1bMCZyNxBbKHcCDrkJj6C9XTjY3jMlwvyJ6Ja/mCpj+bXbKXupUYmpn5+kmy/4jFFLP34hGuw0GxTwkuWgAAAABJRU5ErkJggg==);\n+}\n+#calroot {\n+\twidth: auto;\n+}\ndiff --git a/src/pat/recurrence/templates/display.xml b/src/pat/recurrence/templates/display.xml\nnew file mode 100644\nindex 000000000..56ddb58df\n--- /dev/null\n+++ b/src/pat/recurrence/templates/display.xml\n@@ -0,0 +1,9 @@\n+<div class="ridisplay">\n+    <div class="rimain">\n+        <% if(!readOnly) { %>\n+            <button class="btn btn-primary" name="riedit"><%= localization.add_rules %></button>\n+            <button class="btn btn-danger" name="ridelete" style="display:none"><%= localization.delete_rules %></button>\n+        <% } %>\n+        <label class="ridisplay"><%= localization.displayUnactivate %></label>\n+    </div>\n+<div class="rioccurrences" style="display:none"></div>\ndiff --git a/src/pat/recurrence/templates/form.xml b/src/pat/recurrence/templates/form.xml\nnew file mode 100644\nindex 000000000..b679877d8\n--- /dev/null\n+++ b/src/pat/recurrence/templates/form.xml\n@@ -0,0 +1,257 @@\n+<div class="riform">\n+    <form>\n+        <h1><%= localization.title %></h1>\n+        <div id="messagearea" style="display: none;">\n+        </div>\n+        <div id="rirtemplate">\n+            <label for="<%= name %>rtemplate" class="label">\n+                <%= localization.recurrenceType %>\n+            </label>\n+            <select id="rirtemplate" name="rirtemplate" class="field">\n+                <% for(const tpl of rtemplate) { %>\n+                    <option value="<%= $index %>"><%= tpl %></value>\n+                <% } %>\n+            </select>\n+        <div>\n+        <div id="riformfields">\n+            <div id="ridailyinterval" class="rifield">\n+                <label for="<%= name %>dailyinterval" class="label">\n+                    <%= localization.dailyInterval1 %>\n+                </label>\n+                <div class="field">\n+                    <input type="text" size="2"\n+                        value="1"\n+                        name="ridailyinterval"\n+                        id="<%= name %>dailyinterval" />\n+                    <%= localization.dailyInterval2 %>\n+                </div>\n+            </div>\n+            <div id="riweeklyinterval" class="rifield">\n+                <label for="<%= name %>weeklyinterval" class="label">\n+                    <%= localization.weeklyInterval1 %>\n+                </label>\n+                <div class="field">\n+                    <input type="text" size="2"\n+                        value="1"\n+                        name="riweeklyinterval"\n+                        id="<%= name %>weeklyinterval"/>\n+                    <%= localization.weeklyInterval2 %>\n+                </div>\n+            </div>\n+            <div id="riweeklyweekdays" class="rifield">\n+                <label for="<%= name %>weeklyinterval" class="label"><%= localization.weeklyWeekdays %></label>\n+                <div class="field">\n+                    <% for(const weekday of orderedWeekdays) { %>\n+                        <div class="riweeklyweekday">\n+                            <input type="checkbox"\n+                                name="riweeklyweekdays<%=weekday %>"\n+                                id="<%= name %>weeklyWeekdays<%=weekday %>"\n+                                value="<%=weekday %>" />\n+                            <label for="<%= name %>weeklyWeekdays<%= weekday %>"><%= localization.shortWeekdays[weekday] %></label>\n+                        </div>\n+                    <% } %>\n+                </div>\n+            </div>\n+            <div id="rimonthlyinterval" class="rifield">\n+                <label for="rimonthlyinterval" class="label"><%= localization.monthlyInterval1 %></label>\n+                <div class="field">\n+                    <input type="text" size="2"\n+                        value="1"\n+                        name="rimonthlyinterval"/>\n+                    <%= localization.monthlyInterval2 %>\n+                </div>\n+            </div>\n+            <div id="rimonthlyoptions" class="rifield">\n+                <label for="rimonthlytype" class="label"><%= localization.monthlyRepeatOn %></label>\n+                <div class="field">\n+                    <div>\n+                        <input\n+                            type="radio"\n+                            value="DAYOFMONTH"\n+                            name="rimonthlytype"\n+                            id="<%= name %>monthlytype:DAYOFMONTH" />\n+                        <label for="<%= name %>monthlytype:DAYOFMONTH">\n+                            <%= localization.monthlyDayOfMonth1 %>\n+                        </label>\n+                        <select name="rimonthlydayofmonthday"\n+                            id="<%= name %>monthlydayofmonthday">\n+                        <% for(const val of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,\n+                                18,19,20,21,22,23,24,25,26,27,28,29,30,31]) { %>\n+                            <option value="<%= val %>"><%= val %></option>\n+                        <% } %>\n+                        </select>\n+                        <%= localization.monthlyDayOfMonth2 %>\n+                    </div>\n+                    <div>\n+                        <input\n+                            type="radio"\n+                            value="WEEKDAYOFMONTH"\n+                            name="rimonthlytype"\n+                            id="<%= name %>monthlytype:WEEKDAYOFMONTH" />\n+                        <label for="<%= name %>monthlytype:WEEKDAYOFMONTH">\n+                            <%= localization.monthlyWeekdayOfMonth1 %>\n+                        </label>\n+                        <select name="rimonthlyweekdayofmonthindex">\n+                            {{each localization.orderIndexes}}\n+                                <option value="<%= orderIndexes[$index]}">${$value %></option>\n+                            {{/each}}\n+                        </select>\n+                        <%= localization.monthlyWeekdayOfMonth2 %>\n+                        <select name="rimonthlyweekdayofmonth">\n+                            {{each orderedWeekdays}}\n+                                <option value="<%= weekdays[$value]}">${localization.weekdays[$value] %></option>\n+                            {{/each}}\n+                        </select>\n+                        <%= localization.monthlyWeekdayOfMonth3 %>\n+                    </div>\n+                </div>\n+            </div>\n+            <div id="riyearlyinterval" class="rifield">\n+                <label for="riyearlyinterval" class="label"><%= localization.yearlyInterval1 %></label>\n+                <div class="field">\n+                    <input type="text" size="2"\n+                        value="1"\n+                        name="riyearlyinterval"/>\n+                    <%= localization.yearlyInterval2 %>\n+                </div>\n+            </div>\n+            <div id="riyearlyoptions" class="rifield">\n+                <label for="riyearlyType" class="label"><%= localization.yearlyRepeatOn %></label>\n+                <div class="field">\n+                    <div>\n+                        <input\n+                            type="radio"\n+                            value="DAYOFMONTH"\n+                            name="riyearlyType"\n+                            id="<%= name %>yearlytype:DAYOFMONTH" />\n+                        <label for="<%= name %>yearlytype:DAYOFMONTH">\n+                            <%= localization.yearlyDayOfMonth1 %>\n+                        </label>\n+                        <select name="riyearlydayofmonthmonth">\n+                        {{each localization.months}}\n+                            <option value="<%= $index+1}">${$value %></option>\n+                        {{/each}}\n+                        </select>\n+                        <%= localization.yearlyDayOfMonth2 %>\n+                        <select name="riyearlydayofmonthday">\n+                        {{each [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,\n+                                18,19,20,21,22,23,24,25,26,27,28,29,30,31]}}\n+                            <option value="<%= $value}">${$value %></option>\n+                        {{/each}}\n+                        </select>\n+                        <%= localization.yearlyDayOfMonth3 %>\n+                    </div>\n+                    <div>\n+                        <input\n+                            type="radio"\n+                            value="WEEKDAYOFMONTH"\n+                            name="riyearlyType"\n+                            id="<%= name %>yearlytype:WEEKDAYOFMONTH"/>\n+                        <label for="<%= name %>yearlytype:WEEKDAYOFMONTH">\n+                            <%= localization.yearlyWeekdayOfMonth1 %>\n+                        </label>\n+                        <select name="riyearlyweekdayofmonthindex">\n+                        {{each localization.orderIndexes}}\n+                            <option value="<%= orderIndexes[$index]}">${$value %></option>\n+                        {{/each}}\n+                        </select>\n+                        <label for="<%= name %>yearlytype:WEEKDAYOFMONTH">\n+                            <%= localization.yearlyWeekdayOfMonth2 %>\n+                        </label>\n+                        <select name="riyearlyweekdayofmonthday">\n+                        {{each orderedWeekdays}}\n+                            <option value="<%= weekdays[$value]}">${localization.weekdays[$value] %></option>\n+                        {{/each}}\n+                        </select>\n+                        <%= localization.yearlyWeekdayOfMonth3 %>\n+                        <select name="riyearlyweekdayofmonthmonth">\n+                        {{each localization.months}}\n+                            <option value="<%= $index+1}">${$value %></option>\n+                        {{/each}}\n+                        </select>\n+                        <%= localization.yearlyWeekdayOfMonth4 %>\n+                    </div>\n+                </div>\n+            </div>\n+            <div id="rirangeoptions" class="rifield">\n+                <label class="label"><%= localization.range %></label>\n+                <div class="field">\n+                    {{if hasRepeatForeverButton}}\n+                    <div>\n+                        <input\n+                            type="radio"\n+                            value="NOENDDATE"\n+                            name="rirangetype"\n+                            id="<%= name %>rangetype:NOENDDATE"/>\n+                        <label for="<%= name %>rangetype:NOENDDATE">\n+                            <%= localization.rangeNoEnd %>\n+                        </label>\n+                    </div>\n+                    {{/if}}\n+                    <div>\n+                        <input\n+                            type="radio"\n+                            checked="checked"\n+                            value="BYOCCURRENCES"\n+                            name="rirangetype"\n+                            id="<%= name %>rangetype:BYOCCURRENCES"/>\n+                        <label for="<%= name %>rangetype:BYOCCURRENCES">\n+                            <%= localization.rangeByOccurrences1 %>\n+                        </label>\n+                        <input\n+                            type="text" size="3"\n+                            value="7"\n+                            name="rirangebyoccurrencesvalue" />\n+                        <%= localization.rangeByOccurrences2 %>\n+                    </div>\n+                    <div>\n+                        <input\n+                            type="radio"\n+                            value="BYENDDATE"\n+                            name="rirangetype"\n+                            id="<%= name %>rangetype:BYENDDATE"/>\n+                        <label for="<%= name %>rangetype:BYENDDATE">\n+                            <%= localization.rangeByEndDate %>\n+                        </label>\n+                        <input\n+                            type="date"\n+                            name="rirangebyenddatecalendar" />\n+                    </div>\n+                </div>\n+            </div>\n+        </div>\n+        <div class="rioccurrencesactions">\n+            <div class="rioccurancesheader">\n+                <h2><%= localization.preview %></h2>\n+                <span class="refreshbutton action">\n+                    <a class="rirefreshbutton" href="#" title="<%= localization.refresh %>">\n+                        <%= localization.refresh %>\n+                    </a>\n+                </span>\n+            </div>\n+        </div>\n+        <div class="rioccurrences">\n+        </div>\n+        <div class="rioccurrencesactions">\n+            <div class="rioccurancesheader">\n+                <h2><%= localization.addDate %></h2>\n+            </div>\n+            <div class="riaddoccurrence">\n+                <div class="errorarea"></div>\n+                <input type="date" name="adddate" id="adddate" />\n+                <input type="button" name="addaction" id="addaction" value="<%= localization.add %>">\n+            </div>\n+        </div>\n+\n+        <div class="ributtons">\n+            <input\n+                type="submit"\n+                class="ricancelbutton <%= ributtonExtraClass %>"\n+                value="<%= localization.cancel %>" />\n+            <input\n+                type="submit"\n+                class="risavebutton <%= ributtonExtraClass %>"\n+                value="<%= localization.save %>" />\n+        </div>\n+    </form>\n+</div>\ndiff --git a/src/pat/recurrence/templates/occurrence.xml b/src/pat/recurrence/templates/occurrence.xml\nnew file mode 100644\nindex 000000000..0317cc9ad\n--- /dev/null\n+++ b/src/pat/recurrence/templates/occurrence.xml\n@@ -0,0 +1,44 @@\n+<div class="rioccurrences">\n+    <% for(const occurrence of occurrences) { %>\n+        <div class="occurrence <%= ocurrence.type %>">\n+            <span>\n+                <%= ocurrence.formattedDate %>\n+                <% if(ocurrence.type === "start") { %>\n+                    <span class="rlabel"><%= localization.recurrenceStart %></span>\n+                <% } %>\n+                <% if(ocurrence.type === "rdate") { %>\n+                    <span class="rlabel"><%= >localization.additionalDate %></span>\n+                <% } %>\n+            </span>\n+            <% if(!readOnly) { %>\n+                <span class="action">\n+                    <% if(ocurrence.type === "rrule") { %>\n+                        <a date="<%= ocurrence.date %>" href="#"\n+                           class="<%= ocurrence.type %>" title="<%= localization.exclude %>">\n+                            <%= localization.exclude %>\n+                        </a>\n+                    <% } %>\n+                    <% if(ocurrence.type === "rdate") { %>\n+                        <a date="<%= ocurrence.date %>" href="#"\n+                           class="<%= ocurrence.type %>" title="<%= localization.remove %>">\n+                            <%= localization.remove %>\n+                        </a>\n+                    <% } %>\n+                    <% if(ocurrence.type === "exdate") { %>\n+                        <a date="<%= ocurrence.date %>" href="#"\n+                           class="<%= ocurrence.type %>" title="<%= localization.include %>">\n+                           <%= localization.include %>\n+                        </a>\n+                    <% } %>\n+                </span>\n+            <% } %>\n+        </div>\n+    <% } %>\n+    <div class="batching">\n+        <% for(var index=0; index < batch.batches.length; index++) { %>\n+            <span <% if(index === batch.currentBatch) { %>class="current"<% } %>>\n+                <a href="#" start="<%= batch.batches[index][0] %>">[<%= batch.batches[index][0] %> - <%= batch.batches[index][1] %>]</a>\n+            </span>\n+        <% } %>\n+    </div>\n+</div>\n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-03T10:43:27+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/e39c4671302f0d87442f4f22596d1628d36b5db2

BS5 recurrence form

Files changed:
M src/pat/recurrence/recurrence.scss
M src/pat/recurrence/templates/form.xml

b'diff --git a/src/pat/recurrence/recurrence.scss b/src/pat/recurrence/recurrence.scss\nindex b0f7fb39f..a8b7c85b0 100644\n--- a/src/pat/recurrence/recurrence.scss\n+++ b/src/pat/recurrence/recurrence.scss\n@@ -1,86 +1,3 @@\n-div.riform {\n-    padding: 1em;\n-    background-color: white;\n-    box-shadow: 0 0 3em 0.5em #666;\n-    line-height: 2;\n-    -moz-box-shadow: 0 0 3em 0.5em #666;\n-    -webkit-box-shadow: 0 0 3em #666;\n-\n-    h1 {\n-        color: #888888;\n-        border-bottom: 1px solid #DDDDDD;\n-        font-size: 20px;\n-        line-height: 1;\n-        margin: 0;\n-        padding-bottom: 5px;\n-        padding-left: 5px;\n-    }\n-\n-    form {\n-        margin-bottom: 0;\n-    }\n-\n-    .rifield {\n-        clear: both;\n-    }\n-\n-    .rifield .field {\n-        float:left;\n-        clear: none;\n-    }\n-\n-    .label {\n-        display: block;\n-        float: left;\n-        font-weight: bold;\n-        margin-right: 10px;\n-        text-align: right;\n-        width: 130px;\n-    }\n-\n-    #rirtemplate {\n-        margin-top: 6px;\n-    }\n-\n-    div#riformfields {\n-        min-height: 11em;\n-        min-width: 25em;\n-    }\n-\n-    #rirangeoptions input,\n-    #rimonthlyoptions input,\n-    #riyearlyoptions input {\n-        margin: 0;\n-    }\n-\n-    #riweeklyweekdays .riweeklyweekday input {\n-        display:block;\n-        margin: 8px auto 0;\n-    }\n-    #riweeklyweekdays .riweeklyweekday label {\n-        display:block;\n-    }\n-\n-    #riweeklyweekdays .riweeklyweekday {\n-        margin-right: 15px;\n-        float: left;\n-    }\n-\n-    input.ricancelbutton {\n-        // pb_close.png\n-        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAABHVBMVEUAAAAAAAADAwMEBAQFBQUGBgYJCQkKCgoPDw8RERETExMWFhYbGxscHBwfHx8iIiIlJSUoKCgsLCwyMjI1NTU4ODg7OztDQ0NGRkZKSkpLS0tNTU1XV1ddXV1gYGBjY2NkZGRmZmZoaGhsbGxvb291dXV7e3t+fn6BgYGCgoKFhYWLi4uMjIyNjY2Ojo6QkJCTk5OVlZWWlpaXl5eZmZmdnZ2fn5+qqqqurq6vr6+ysrKzs7O5ubnCwsLFxcXHx8fJycnLy8vMzMzR0dHV1dXY2Nja2trc3Nzd3d3f39/g4ODh4eHk5OTl5eXo6Ojr6+vs7Ozt7e3u7u7x8fHy8vLz8/P19fX29vb39/f4+Pj6+vr7+/v8/Pz9/f3////kwcJJAAAAAXRSTlMAQObYZgAAAThJREFUKBXNwWdb2gAYhtH3CVbQFisVlOLWVlHcdeBedXSQqoiR4f3/f4YJF8Gg9psfPMfezL8avvqNvaaCz/2Nr2wvPFBbz8qXXrynZs/AXp9aUidgHRpsOmpz5sEibthzFLVGxZ5wl5Q0MCjfx/G49KGEtf1iRdIXyEufS6xLmuTKQh4ZSX0e5PtLUJDU28BC3CqQ8+AWio58p1iIczXlqkDRUWCHH9bCTzWlroA5NW2zai1cK5ByoQF5BY74bi01kpISLhSHPZiW5JSx0CXfJGWg6CjnsSUpi2uhJdy4pMlpR1I6n5S0z661lSiowxgVezIBY4oYrLNqEWswq7bRKgcW1bMCZyNxBbKHcCDrkJj6C9XTjY3jMlwvyJ6Ja/mCpj+bXbKXupUYmpn5+kmy/4jFFLP34hGuw0GxTwkuWgAAAABJRU5ErkJggg==);\n-        background-color: transparent;\n-        font-size: 0; /* For IE8 */\n-        color: transparent;\n-        border: none;\n-        position: absolute;\n-        left: -14px;\n-        top: -14px;\n-        cursor: pointer;\n-        height: 30px;\n-        width: 30px;\n-    }\n-}\n \n div.rioccurrencesactions .riaddoccurrence #adddate {\n     width: 75%;\n@@ -207,20 +124,3 @@ div.ributtons .risavebutton {\n     display: block;\n     margin: 30px auto 0;\n }\n-\n-// jQueryTools overrides\n-#calnext,\n-#calprev {\n-    background-image: url(data:image/gif;base64,R0lGODlhDgAOAOZsAPb29vv7+/f39/Ly8vr6+vn5+QCFzfz8/PDw8PPz8wCEzQODzACHzwCFzgCBzCKb1fL7/fHx8aXZ7+r4/F295LXg8pTR6wKCzA2L0J3V7ZnW7T234gaS05bV7v3+/ofN65Tb8JfX7/n+/pff8uv6/YXN60C748/s9wCIz9ry+gKHzgOIzs7r9gF+yx+Z1QKEzSKg2AGP0mG54uf2++b4/AyP0QGCzGG844bN62m95Gm/5Fm95AeQ0vf8/bzl9ACAyxma1rbi9DKm2////weGzpfW7Mvp9QyO0J/Y7qrc8AiJz9jy+mK949Tv+QCDzHLA5geIzgCDzcfr9gqM0Mzv+ACQ0g2Q0sLn9XbM6y+p3L/s96LY706w3sbo9PX19ZXT7PD7/Tis3gyQ0g+R0v7+/gCGzgCHzvj4+ACCzPT09O/v7wCJz+7u7gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAGwALAAAAAAOAA4AAAe0gGyCamlnBAQCCYKLbAMHTVgbJh00BWqLA2QlMQpoCxdAQQGXagc4CmZlRxIWC1ZXZ2xpVBwGZTVIZBlKDllgCAUfaAxTGkNfUAxraydpATloK0VkW0Rmyw1JAAFPDio6EEYuUcsGFQBnIQZmNkwiLA9lZlUpCQMkME4oLzceXRg/KPS4VMDHGDRl0Mjg0kLIDC+DCEgJw2NNAzE7JghgpEYAGS0gRiw5kIbRogjozqRBwCgQADs=);\n-}\n-#calnext {\n-    background-image: url(data:image/gif;base64,R0lGODlhDgAOAOZsAPb29vv7+/f39/Ly8vr6+vn5+QCFzfz8/PDw8PPz8wCEzQODzACHzwCFzgCBzCKb1fL7/fHx8aXZ7+r4/F295LXg8pTR6wKCzA2L0J3V7ZnW7T234gaS05bV7v3+/ofN65Tb8JfX7/n+/pff8uv6/YXN60C748/s9wCIz9ry+gKHzgOIzs7r9gF+yx+Z1QKEzSKg2AGP0mG54uf2++b4/AyP0QGCzGG844bN62m95Gm/5Fm95AeQ0vf8/bzl9ACAyxma1rbi9DKm2////weGzpfW7Mvp9QyO0J/Y7qrc8AiJz9jy+mK949Tv+QCDzHLA5geIzgCDzcfr9gqM0Mzv+ACQ0g2Q0sLn9XbM6y+p3L/s96LY706w3sbo9PX19ZXT7PD7/Tis3gyQ0g+R0v7+/gCGzgCHzvj4+ACCzPT09O/v7wCJz+7u7gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAGwALAAAAAAOAA4AAAe2gGyCbAhpZ2cAEYOLaQdLIyBaZAJqiwITO2INazxhUgSVbF4zQi1cMmhlaGM+BWxqPRQ/GF0eNy8oTjAkAwkpVWZlDywiTDZmBiGIFQZra1EuRhA6Kg5PAQBJm2tmRFtkRStoOQFpJ84MUF9DGlMMaB8FCGBZDkoZZEg1ZQYcVGlszlyxssCChCNlzCjAcaCSmgBBgFxYgEZBjBJkBgxSU4BGBxMbsDQ5oHERmwQCCBA4kyYUm0AAOw==);\n-}\n-div.overlaybg div.close,\n-div.overlay div.close {\n-    // pb_close.png\n-    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAABHVBMVEUAAAAAAAADAwMEBAQFBQUGBgYJCQkKCgoPDw8RERETExMWFhYbGxscHBwfHx8iIiIlJSUoKCgsLCwyMjI1NTU4ODg7OztDQ0NGRkZKSkpLS0tNTU1XV1ddXV1gYGBjY2NkZGRmZmZoaGhsbGxvb291dXV7e3t+fn6BgYGCgoKFhYWLi4uMjIyNjY2Ojo6QkJCTk5OVlZWWlpaXl5eZmZmdnZ2fn5+qqqqurq6vr6+ysrKzs7O5ubnCwsLFxcXHx8fJycnLy8vMzMzR0dHV1dXY2Nja2trc3Nzd3d3f39/g4ODh4eHk5OTl5eXo6Ojr6+vs7Ozt7e3u7u7x8fHy8vLz8/P19fX29vb39/f4+Pj6+vr7+/v8/Pz9/f3////kwcJJAAAAAXRSTlMAQObYZgAAAThJREFUKBXNwWdb2gAYhtH3CVbQFisVlOLWVlHcdeBedXSQqoiR4f3/f4YJF8Gg9psfPMfezL8avvqNvaaCz/2Nr2wvPFBbz8qXXrynZs/AXp9aUidgHRpsOmpz5sEibthzFLVGxZ5wl5Q0MCjfx/G49KGEtf1iRdIXyEufS6xLmuTKQh4ZSX0e5PtLUJDU28BC3CqQ8+AWio58p1iIczXlqkDRUWCHH9bCTzWlroA5NW2zai1cK5ByoQF5BY74bi01kpISLhSHPZiW5JSx0CXfJGWg6CjnsSUpi2uhJdy4pMlpR1I6n5S0z661lSiowxgVezIBY4oYrLNqEWswq7bRKgcW1bMCZyNxBbKHcCDrkJj6C9XTjY3jMlwvyJ6Ja/mCpj+bXbKXupUYmpn5+kmy/4jFFLP34hGuw0GxTwkuWgAAAABJRU5ErkJggg==);\n-}\n-#calroot {\n-\twidth: auto;\n-}\ndiff --git a/src/pat/recurrence/templates/form.xml b/src/pat/recurrence/templates/form.xml\nindex b679877d8..c6a90acea 100644\n--- a/src/pat/recurrence/templates/form.xml\n+++ b/src/pat/recurrence/templates/form.xml\n@@ -1,225 +1,287 @@\n <div class="riform">\n     <form>\n         <h1><%= localization.title %></h1>\n-        <div id="messagearea" style="display: none;">\n-        </div>\n-        <div id="rirtemplate">\n-            <label for="<%= name %>rtemplate" class="label">\n+        <div id="messagearea" style="display: none;"> </div>\n+        <div id="rirtemplate" class="mb-2 row">\n+            <label class="col-4 col-form-label" for="<%= name %>rtemplate" class="label">\n                 <%= localization.recurrenceType %>\n             </label>\n-            <select id="rirtemplate" name="rirtemplate" class="field">\n-                <% for(const tpl of rtemplate) { %>\n-                    <option value="<%= $index %>"><%= tpl %></value>\n-                <% } %>\n-            </select>\n-        <div>\n-        <div id="riformfields">\n-            <div id="ridailyinterval" class="rifield">\n-                <label for="<%= name %>dailyinterval" class="label">\n+            <div class="col-8">\n+                <select id="rirtemplate" name="rirtemplate" class="form-select form-select-sm">\n+                    <% Object.keys(rtemplate).forEach(function(val, idx) { %>\n+                        <option value="<%= val %>"><%= localization.rtemplate[val] %></value>\n+                    <% }) %>\n+                </select>\n+            </div>\n+        </div>\n+        <div id="riformfields" class="mb-2">\n+            <div id="ridailyinterval" class="rifield row">\n+                <label class="col-4 col-form-label" for="<%= name %>dailyinterval">\n                     <%= localization.dailyInterval1 %>\n                 </label>\n-                <div class="field">\n-                    <input type="text" size="2"\n+                <div class="col-8">\n+                    <input class="form-control form-control-sm w-auto float-start me-3" type="text" size="2"\n                         value="1"\n                         name="ridailyinterval"\n                         id="<%= name %>dailyinterval" />\n                     <%= localization.dailyInterval2 %>\n                 </div>\n             </div>\n-            <div id="riweeklyinterval" class="rifield">\n-                <label for="<%= name %>weeklyinterval" class="label">\n+\n+            <div id="riweeklyinterval" class="rifield row">\n+                <label class="col-4 col-form-label" for="<%= name %>weeklyinterval">\n                     <%= localization.weeklyInterval1 %>\n                 </label>\n-                <div class="field">\n-                    <input type="text" size="2"\n+                <div class="col-8">\n+                    <input class="form-control form-control-sm w-auto float-start me-3" type="text" size="2"\n                         value="1"\n                         name="riweeklyinterval"\n                         id="<%= name %>weeklyinterval"/>\n                     <%= localization.weeklyInterval2 %>\n                 </div>\n             </div>\n-            <div id="riweeklyweekdays" class="rifield">\n-                <label for="<%= name %>weeklyinterval" class="label"><%= localization.weeklyWeekdays %></label>\n-                <div class="field">\n-                    <% for(const weekday of orderedWeekdays) { %>\n-                        <div class="riweeklyweekday">\n-                            <input type="checkbox"\n-                                name="riweeklyweekdays<%=weekday %>"\n-                                id="<%= name %>weeklyWeekdays<%=weekday %>"\n-                                value="<%=weekday %>" />\n-                            <label for="<%= name %>weeklyWeekdays<%= weekday %>"><%= localization.shortWeekdays[weekday] %></label>\n+\n+            <div id="riweeklyweekdays" class="rifield row">\n+                <label class="col-4 col-form-label" for="<%= name %>weeklyinterval"><%= localization.weeklyWeekdays %></label>\n+                <div class="col-8">\n+                    <div class="row">\n+                    <% orderedWeekdays.forEach(function(weekday, idx) { %>\n+                        <div class="riweeklyweekday col-auto">\n+                            <div class="form-check">\n+                                <input class="form-check-input" type="checkbox"\n+                                    name="riweeklyweekdays<%=weekday %>"\n+                                    id="<%= name %>weeklyWeekdays<%=weekday %>"\n+                                    value="<%=weekday %>" />\n+                                <label class="form-check-label" for="<%= name %>weeklyWeekdays<%= weekday %>"><%= localization.shortWeekdays[idx] %></label>\n+                            </div>\n                         </div>\n-                    <% } %>\n+                    <% }) %>\n+                    </div>\n                 </div>\n             </div>\n-            <div id="rimonthlyinterval" class="rifield">\n-                <label for="rimonthlyinterval" class="label"><%= localization.monthlyInterval1 %></label>\n-                <div class="field">\n-                    <input type="text" size="2"\n+\n+            <div id="rimonthlyinterval" class="rifield row">\n+                <label class="col-4 col-form-label" for="rimonthlyinterval"><%= localization.monthlyInterval1 %></label>\n+                <div class="col-8">\n+                    <input class="form-control form-control-sm w-auto float-start me-3" type="text" size="2"\n                         value="1"\n                         name="rimonthlyinterval"/>\n                     <%= localization.monthlyInterval2 %>\n                 </div>\n             </div>\n-            <div id="rimonthlyoptions" class="rifield">\n-                <label for="rimonthlytype" class="label"><%= localization.monthlyRepeatOn %></label>\n-                <div class="field">\n-                    <div>\n-                        <input\n-                            type="radio"\n-                            value="DAYOFMONTH"\n-                            name="rimonthlytype"\n-                            id="<%= name %>monthlytype:DAYOFMONTH" />\n-                        <label for="<%= name %>monthlytype:DAYOFMONTH">\n-                            <%= localization.monthlyDayOfMonth1 %>\n-                        </label>\n-                        <select name="rimonthlydayofmonthday"\n-                            id="<%= name %>monthlydayofmonthday">\n-                        <% for(const val of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,\n-                                18,19,20,21,22,23,24,25,26,27,28,29,30,31]) { %>\n-                            <option value="<%= val %>"><%= val %></option>\n-                        <% } %>\n-                        </select>\n-                        <%= localization.monthlyDayOfMonth2 %>\n+\n+            <div id="rimonthlyoptions" class="rifield row">\n+                <label class="col-4 col-form-label" for="rimonthlytype"><%= localization.monthlyRepeatOn %></label>\n+                <div class="col-8">\n+                    <div class="row">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="DAYOFMONTH"\n+                                    name="rimonthlytype"\n+                                    id="<%= name %>monthlytype:DAYOFMONTH" />\n+                                <label class="form-check-label" for="<%= name %>monthlytype:DAYOFMONTH">\n+                                    <%= localization.monthlyDayOfMonth1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto" name="rimonthlydayofmonthday" id="<%= name %>monthlydayofmonthday">\n+                                <% [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31].forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= val %></option>\n+                                <% }) %>\n+                            </select>\n+                        </div>\n+                        <div class="col-auto">\n+                            <%= localization.monthlyDayOfMonth2 %>\n+                        </div>\n                     </div>\n-                    <div>\n-                        <input\n-                            type="radio"\n-                            value="WEEKDAYOFMONTH"\n-                            name="rimonthlytype"\n-                            id="<%= name %>monthlytype:WEEKDAYOFMONTH" />\n-                        <label for="<%= name %>monthlytype:WEEKDAYOFMONTH">\n-                            <%= localization.monthlyWeekdayOfMonth1 %>\n-                        </label>\n-                        <select name="rimonthlyweekdayofmonthindex">\n-                            {{each localization.orderIndexes}}\n-                                <option value="<%= orderIndexes[$index]}">${$value %></option>\n-                            {{/each}}\n-                        </select>\n-                        <%= localization.monthlyWeekdayOfMonth2 %>\n-                        <select name="rimonthlyweekdayofmonth">\n-                            {{each orderedWeekdays}}\n-                                <option value="<%= weekdays[$value]}">${localization.weekdays[$value] %></option>\n-                            {{/each}}\n-                        </select>\n-                        <%= localization.monthlyWeekdayOfMonth3 %>\n+                    <div class="row">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="WEEKDAYOFMONTH"\n+                                    name="rimonthlytype"\n+                                    id="<%= name %>monthlytype:WEEKDAYOFMONTH" />\n+                                <label class="form-check-label" for="<%= name %>monthlytype:WEEKDAYOFMONTH">\n+                                    <%= localization.monthlyWeekdayOfMonth1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="rimonthlyweekdayofmonthindex">\n+                                <% orderIndexes.forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= localization.orderIndexes[idx] %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.monthlyWeekdayOfMonth2 %>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="rimonthlyweekdayofmonth">\n+                                <% orderedWeekdays.forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= localization.weekdays[idx] %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.monthlyWeekdayOfMonth3 %>\n+                        </div>\n                     </div>\n                 </div>\n             </div>\n-            <div id="riyearlyinterval" class="rifield">\n-                <label for="riyearlyinterval" class="label"><%= localization.yearlyInterval1 %></label>\n-                <div class="field">\n-                    <input type="text" size="2"\n+\n+            <div id="riyearlyinterval" class="rifield row">\n+                <label class="col-4 col-form-label" for="riyearlyinterval"><%= localization.yearlyInterval1 %></label>\n+                <div class="col-8">\n+                    <input class="form-control form-control-sm w-auto float-start me-3" type="text" size="2"\n                         value="1"\n                         name="riyearlyinterval"/>\n                     <%= localization.yearlyInterval2 %>\n                 </div>\n             </div>\n-            <div id="riyearlyoptions" class="rifield">\n-                <label for="riyearlyType" class="label"><%= localization.yearlyRepeatOn %></label>\n-                <div class="field">\n-                    <div>\n-                        <input\n-                            type="radio"\n-                            value="DAYOFMONTH"\n-                            name="riyearlyType"\n-                            id="<%= name %>yearlytype:DAYOFMONTH" />\n-                        <label for="<%= name %>yearlytype:DAYOFMONTH">\n-                            <%= localization.yearlyDayOfMonth1 %>\n-                        </label>\n-                        <select name="riyearlydayofmonthmonth">\n-                        {{each localization.months}}\n-                            <option value="<%= $index+1}">${$value %></option>\n-                        {{/each}}\n-                        </select>\n-                        <%= localization.yearlyDayOfMonth2 %>\n-                        <select name="riyearlydayofmonthday">\n-                        {{each [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,\n-                                18,19,20,21,22,23,24,25,26,27,28,29,30,31]}}\n-                            <option value="<%= $value}">${$value %></option>\n-                        {{/each}}\n-                        </select>\n-                        <%= localization.yearlyDayOfMonth3 %>\n+\n+            <div id="riyearlyoptions" class="rifield row">\n+                <label class="col-4 col-form-label" for="riyearlyType"><%= localization.yearlyRepeatOn %></label>\n+                <div class="col-8">\n+                    <div class="row">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="DAYOFMONTH"\n+                                    name="riyearlyType"\n+                                    id="<%= name %>yearlytype:DAYOFMONTH" />\n+                                <label class="form-check-label" for="<%= name %>yearlytype:DAYOFMONTH">\n+                                    <%= localization.yearlyDayOfMonth1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlydayofmonthmonth">\n+                            <% localization.months.forEach(function(val, idx) { %>\n+                                <option value="<%= idx + 1 %>"><%= val %></option>\n+                            <% }) %>\n+                            </select>\n+                            <%= localization.yearlyDayOfMonth2 %>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlydayofmonthday">\n+                                <% [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31].forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= val %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.yearlyDayOfMonth3 %>\n+                        </div>\n                     </div>\n-                    <div>\n-                        <input\n-                            type="radio"\n-                            value="WEEKDAYOFMONTH"\n-                            name="riyearlyType"\n-                            id="<%= name %>yearlytype:WEEKDAYOFMONTH"/>\n-                        <label for="<%= name %>yearlytype:WEEKDAYOFMONTH">\n-                            <%= localization.yearlyWeekdayOfMonth1 %>\n-                        </label>\n-                        <select name="riyearlyweekdayofmonthindex">\n-                        {{each localization.orderIndexes}}\n-                            <option value="<%= orderIndexes[$index]}">${$value %></option>\n-                        {{/each}}\n-                        </select>\n-                        <label for="<%= name %>yearlytype:WEEKDAYOFMONTH">\n+\n+                    <div class="row">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="WEEKDAYOFMONTH"\n+                                    name="riyearlyType"\n+                                    id="<%= name %>yearlytype:WEEKDAYOFMONTH"/>\n+                                <label class="form-check-label" for="<%= name %>yearlytype:WEEKDAYOFMONTH">\n+                                    <%= localization.yearlyWeekdayOfMonth1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlyweekdayofmonthindex">\n+                                <% orderIndexes.forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= localization.orderIndexes[idx] %></option>\n+                                <% }) %>\n+                            </select>\n                             <%= localization.yearlyWeekdayOfMonth2 %>\n-                        </label>\n-                        <select name="riyearlyweekdayofmonthday">\n-                        {{each orderedWeekdays}}\n-                            <option value="<%= weekdays[$value]}">${localization.weekdays[$value] %></option>\n-                        {{/each}}\n-                        </select>\n-                        <%= localization.yearlyWeekdayOfMonth3 %>\n-                        <select name="riyearlyweekdayofmonthmonth">\n-                        {{each localization.months}}\n-                            <option value="<%= $index+1}">${$value %></option>\n-                        {{/each}}\n-                        </select>\n-                        <%= localization.yearlyWeekdayOfMonth4 %>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlyweekdayofmonthday">\n+                                <% orderedWeekdays.forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= localization.weekdays[idx] %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.yearlyWeekdayOfMonth3 %>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlyweekdayofmonthmonth">\n+                                <% localization.months.forEach(function(val, idx) { %>\n+                                    <option value="<%= idx + 1 %>"><%= val %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.yearlyWeekdayOfMonth4 %>\n+                        </div>\n                     </div>\n                 </div>\n             </div>\n-            <div id="rirangeoptions" class="rifield">\n-                <label class="label"><%= localization.range %></label>\n-                <div class="field">\n-                    {{if hasRepeatForeverButton}}\n-                    <div>\n+\n+            <div id="rirangeoptions" class="rifield row">\n+                <label class="col-4 col-form-label"><%= localization.range %></label>\n+                <div class="col-8 pt-2">\n+                    <% if(hasRepeatForeverButton) { %>\n+                    <div class="form-check">\n                         <input\n+                            class="form-check-input"\n                             type="radio"\n                             value="NOENDDATE"\n                             name="rirangetype"\n                             id="<%= name %>rangetype:NOENDDATE"/>\n-                        <label for="<%= name %>rangetype:NOENDDATE">\n+                        <label class="form-check-label" for="<%= name %>rangetype:NOENDDATE">\n                             <%= localization.rangeNoEnd %>\n                         </label>\n                     </div>\n-                    {{/if}}\n-                    <div>\n-                        <input\n-                            type="radio"\n-                            checked="checked"\n-                            value="BYOCCURRENCES"\n-                            name="rirangetype"\n-                            id="<%= name %>rangetype:BYOCCURRENCES"/>\n-                        <label for="<%= name %>rangetype:BYOCCURRENCES">\n-                            <%= localization.rangeByOccurrences1 %>\n-                        </label>\n-                        <input\n-                            type="text" size="3"\n-                            value="7"\n-                            name="rirangebyoccurrencesvalue" />\n-                        <%= localization.rangeByOccurrences2 %>\n+                    <% } %>\n+                    <div class="row mt-2">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    checked="checked"\n+                                    value="BYOCCURRENCES"\n+                                    name="rirangetype"\n+                                    id="<%= name %>rangetype:BYOCCURRENCES"/>\n+                                <label class="form-check-label" for="<%= name %>rangetype:BYOCCURRENCES">\n+                                    <%= localization.rangeByOccurrences1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <input\n+                                class="form-control form-control-sm w-auto float-start me-3" type="text" size="3"\n+                                value="7"\n+                                name="rirangebyoccurrencesvalue" />\n+                            <%= localization.rangeByOccurrences2 %>\n+                        </div>\n                     </div>\n-                    <div>\n-                        <input\n-                            type="radio"\n-                            value="BYENDDATE"\n-                            name="rirangetype"\n-                            id="<%= name %>rangetype:BYENDDATE"/>\n-                        <label for="<%= name %>rangetype:BYENDDATE">\n-                            <%= localization.rangeByEndDate %>\n-                        </label>\n-                        <input\n-                            type="date"\n-                            name="rirangebyenddatecalendar" />\n+                    <div class="row mt-2">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="BYENDDATE"\n+                                    name="rirangetype"\n+                                    id="<%= name %>rangetype:BYENDDATE"/>\n+                                <label class="form-check-label" for="<%= name %>rangetype:BYENDDATE">\n+                                    <%= localization.rangeByEndDate %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <input\n+                                class="form-control form-control-sm w-auto" type="date"\n+                                name="rirangebyenddatecalendar" />\n+                        </div>\n                     </div>\n                 </div>\n             </div>\n         </div>\n+\n         <div class="rioccurrencesactions">\n             <div class="rioccurancesheader">\n                 <h2><%= localization.preview %></h2>\n@@ -230,8 +292,9 @@\n                 </span>\n             </div>\n         </div>\n-        <div class="rioccurrences">\n-        </div>\n+\n+        <div class="rioccurrences"></div>\n+\n         <div class="rioccurrencesactions">\n             <div class="rioccurancesheader">\n                 <h2><%= localization.addDate %></h2>\n@@ -244,14 +307,12 @@\n         </div>\n \n         <div class="ributtons">\n-            <input\n+            <button\n                 type="submit"\n-                class="ricancelbutton <%= ributtonExtraClass %>"\n-                value="<%= localization.cancel %>" />\n-            <input\n+                class="btn btn-secondary me-2 ricancelbutton <%= ributtonExtraClass %>"><%= localization.cancel %></button>\n+            <button\n                 type="submit"\n-                class="risavebutton <%= ributtonExtraClass %>"\n-                value="<%= localization.save %>" />\n+                class="btn btn-primary risavebutton <%= ributtonExtraClass %>"><%= localization.save %></button>\n         </div>\n     </form>\n </div>\n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-03T10:43:50+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/e8ec1e28c4d7b26d17290e5618ca42019d13c7b5

move jquery.recurrence functionality to pattern

Files changed:
M src/pat/recurrence/recurrence.js

b'diff --git a/src/pat/recurrence/recurrence.js b/src/pat/recurrence/recurrence.js\nindex c615471a4..54fb1b197 100644\n--- a/src/pat/recurrence/recurrence.js\n+++ b/src/pat/recurrence/recurrence.js\n@@ -8,14 +8,538 @@ import OccurrenceTemplate from "./templates/occurrence.xml";\n import Modal from "../modal/modal";\n \n \n+function widgetSaveToRfc5545(form, conf, tz) {\n+    var value = form.find(\'select[name=rirtemplate]\').val();\n+    var rtemplate = conf.rtemplate[value];\n+    var result = rtemplate.rrule;\n+    var human = conf.localization.rtemplate[value];\n+    var field, input, weekdays, i18nweekdays, i, j, index, tmp;\n+    var day, month, year, interval, yearlyType, occurrences, date;\n+\n+    for (i = 0; i < rtemplate.fields.length; i++) {\n+        field = form.find(\'#\' + rtemplate.fields[i]);\n+\n+        switch (field.attr(\'id\')) {\n+\n+        case \'ridailyinterval\':\n+            interval = field.find(\'input[name=ridailyinterval]\').val();\n+            if (interval !== \'1\') {\n+                result += \';INTERVAL=\' + interval;\n+            }\n+            human = interval + \' \' + conf.localization.dailyInterval2;\n+            break;\n+\n+        case \'riweeklyinterval\':\n+            interval = field.find(\'input[name=riweeklyinterval]\').val();\n+            if (interval !== \'1\') {\n+                result += \';INTERVAL=\' + interval;\n+            }\n+            human = interval + \' \' + conf.localization.weeklyInterval2;\n+            break;\n+\n+        case \'riweeklyweekdays\':\n+            weekdays = \'\';\n+            i18nweekdays = \'\';\n+            for (j = 0; j < conf.weekdays.length; j++) {\n+                input = field.find(\'input[name=riweeklyweekdays\' + conf.weekdays[j] + \']\');\n+                if (input.is(\':checked\')) {\n+                    if (weekdays) {\n+                        weekdays += \',\';\n+                        i18nweekdays += \', \';\n+                    }\n+                    weekdays += conf.weekdays[j];\n+                    i18nweekdays += conf.localization.weekdays[j];\n+                }\n+            }\n+            if (weekdays) {\n+                result += \';BYDAY=\' + weekdays;\n+                human += \' \' + conf.localization.weeklyWeekdaysHuman + \' \' + i18nweekdays;\n+            }\n+            break;\n+\n+        case \'rimonthlyinterval\':\n+            interval = field.find(\'input[name=rimonthlyinterval]\').val();\n+            if (interval !== \'1\') {\n+                result += \';INTERVAL=\' + interval;\n+            }\n+            human = interval + \' \' + conf.localization.monthlyInterval2;\n+            break;\n+\n+        case \'rimonthlyoptions\':\n+            var monthlyType = $(\'input[name=rimonthlytype]:checked\', form).val();\n+            switch (monthlyType) {\n+\n+            case \'DAYOFMONTH\':\n+                day = $(\'select[name=rimonthlydayofmonthday]\', form).val();\n+                result += \';BYMONTHDAY=\' + day;\n+                human += \', \' + conf.localization.monthlyDayOfMonth1Human + \' \' + day + \' \' + conf.localization.monthlyDayOfMonth2;\n+                break;\n+            case \'WEEKDAYOFMONTH\':\n+                index = $(\'select[name=rimonthlyweekdayofmonthindex]\', form).val();\n+                day = $(\'select[name=rimonthlyweekdayofmonth]\', form).val();\n+                if ($.inArray(day, [\'MO\', \'TU\', \'WE\', \'TH\', \'FR\', \'SA\', \'SU\']) > -1) {\n+                    result += \';BYDAY=\' + index + day;\n+                    human += \', \' + conf.localization.monthlyWeekdayOfMonth1Human + \' \';\n+                    human += \' \' + conf.localization.orderIndexes[$.inArray(index, conf.orderIndexes)];\n+                    human += \' \' + conf.localization.monthlyWeekdayOfMonth2;\n+                    human += \' \' + conf.localization.weekdays[$.inArray(day, conf.weekdays)];\n+                    human += \' \' + conf.localization.monthlyDayOfMonth2;\n+                }\n+                break;\n+            }\n+            break;\n+\n+        case \'riyearlyinterval\':\n+            interval = field.find(\'input[name=riyearlyinterval]\').val();\n+            if (interval !== \'1\') {\n+                result += \';INTERVAL=\' + interval;\n+            }\n+            human = interval + \' \' + conf.localization.yearlyInterval2;\n+            break;\n+\n+        case \'riyearlyoptions\':\n+            yearlyType = $(\'input[name=riyearlyType]:checked\', form).val();\n+            switch (yearlyType) {\n+\n+            case \'DAYOFMONTH\':\n+                month = $(\'select[name=riyearlydayofmonthmonth]\', form).val();\n+                day = $(\'select[name=riyearlydayofmonthday]\', form).val();\n+                result += \';BYMONTH=\' + month;\n+                result += \';BYMONTHDAY=\' + day;\n+                human += \', \' + conf.localization.yearlyDayOfMonth1Human + \' \' + conf.localization.months[month - 1] + \' \' + day;\n+                break;\n+            case \'WEEKDAYOFMONTH\':\n+                index = $(\'select[name=riyearlyweekdayofmonthindex]\', form).val();\n+                day = $(\'select[name=riyearlyweekdayofmonthday]\', form).val();\n+                month = $(\'select[name=riyearlyweekdayofmonthmonth]\', form).val();\n+                result += \';BYMONTH=\' + month;\n+                if ($.inArray(day, [\'MO\', \'TU\', \'WE\', \'TH\', \'FR\', \'SA\', \'SU\']) > -1) {\n+                    result += \';BYDAY=\' + index + day;\n+                    human += \', \' + conf.localization.yearlyWeekdayOfMonth1Human;\n+                    human += \' \' + conf.localization.orderIndexes[$.inArray(index, conf.orderIndexes)];\n+                    human += \' \' + conf.localization.yearlyWeekdayOfMonth2;\n+                    human += \' \' + conf.localization.weekdays[$.inArray(day, conf.weekdays)];\n+                    human += \' \' + conf.localization.yearlyWeekdayOfMonth3;\n+                    human += \' \' + conf.localization.months[month - 1];\n+                    human += \' \' + conf.localization.yearlyWeekdayOfMonth4;\n+                }\n+                break;\n+            }\n+            break;\n+\n+        case \'rirangeoptions\':\n+            var rangeType = form.find(\'input[name=rirangetype]:checked\').val();\n+            switch (rangeType) {\n+\n+            case \'BYOCCURRENCES\':\n+                occurrences = form.find(\'input[name=rirangebyoccurrencesvalue]\').val();\n+                result += \';COUNT=\' + occurrences;\n+                human += \', \' + conf.localization.rangeByOccurrences1Human;\n+                human += \' \' + occurrences;\n+                human += \' \' + conf.localization.rangeByOccurrences2;\n+                break;\n+            case \'BYENDDATE\':\n+                field = form.find(\'input[name=rirangebyenddatecalendar]\');\n+                date = field.val().replaceAll("-", "");\n+                result += \';UNTIL=\' + date + \'T000000\';\n+                if (tz === true) {\n+                    // Make it UTC:\n+                    result += \'Z\';\n+                }\n+                human += \', \' + conf.localization.rangeByEndDateHuman;\n+                human += \' \' + date;\n+                break;\n+            }\n+            break;\n+        }\n+    }\n+\n+    if (form.ical.RDATE !== undefined && form.ical.RDATE.length > 0) {\n+        form.ical.RDATE.sort();\n+        tmp = [];\n+        for (i = 0; i < form.ical.RDATE.length; i++) {\n+            if (form.ical.RDATE[i] !== \'\') {\n+                year = parseInt(form.ical.RDATE[i].substring(0, 4), 10);\n+                month = parseInt(form.ical.RDATE[i].substring(4, 6), 10) - 1;\n+                day = parseInt(form.ical.RDATE[i].substring(6, 8), 10);\n+                tmp.push(format(new Date(year, month, day), conf.localization.longDateFormat, conf));\n+            }\n+        }\n+        if (tmp.length !== 0) {\n+            human = human + conf.localization.including + \' \' + tmp.join(\'; \');\n+        }\n+    }\n+\n+    if (form.ical.EXDATE !== undefined && form.ical.EXDATE.length > 0) {\n+        form.ical.EXDATE.sort();\n+        tmp = [];\n+        for (i = 0; i < form.ical.EXDATE.length; i++) {\n+            if (form.ical.EXDATE[i] !== \'\') {\n+                year = parseInt(form.ical.EXDATE[i].substring(0, 4), 10);\n+                month = parseInt(form.ical.EXDATE[i].substring(4, 6), 10) - 1;\n+                day = parseInt(form.ical.EXDATE[i].substring(6, 8), 10);\n+                tmp.push(format(new Date(year, month, day), conf.localization.longDateFormat, conf));\n+            }\n+        }\n+        if (tmp.length !== 0) {\n+            human = human + conf.localization.except + \' \' + tmp.join(\'; \');\n+        }\n+    }\n+    result = \'RRULE:\' + result;\n+    if (form.ical.EXDATE !== undefined && form.ical.EXDATE.join() !== "") {\n+        tmp = $.map(form.ical.EXDATE, function (x) {\n+            if (x.length === 8) { // DATE format. Make it DATE-TIME\n+                x += \'T000000\';\n+            }\n+            if (tz === true) {\n+                // Make it UTC:\n+                x += \'Z\';\n+            }\n+            return x;\n+        });\n+        result = result + \'\\nEXDATE:\' + tmp;\n+    }\n+    if (form.ical.RDATE !== undefined && form.ical.RDATE.join() !== "") {\n+        tmp = $.map(form.ical.RDATE, function (x) {\n+            if (x.length === 8) { // DATE format. Make it DATE-TIME\n+                x += \'T000000\';\n+            }\n+            if (tz === true) {\n+                // Make it UTC:\n+                x += \'Z\';\n+            }\n+            return x;\n+        });\n+        result = result + \'\\nRDATE:\' + tmp;\n+    }\n+    return {result: result, description: human};\n+}\n+\n+function parseLine(icalline) {\n+    var result = {};\n+    var pos = icalline.indexOf(\':\');\n+    var property = icalline.substring(0, pos);\n+    result.value = icalline.substring(pos + 1);\n+\n+    if (property.indexOf(\';\') !== -1) {\n+        pos = property.indexOf(\';\');\n+        result.parameters = property.substring(pos + 1);\n+        result.property = property.substring(0, pos);\n+    } else {\n+        result.parameters = null;\n+        result.property = property;\n+    }\n+    return result;\n+}\n+\n+function cleanDates(dates) {\n+    // Get rid of timezones\n+    // TODO: We could parse dates and range here, maybe?\n+    var result = [];\n+    var splitDates = dates.split(\',\');\n+    var date;\n+\n+    for (date in splitDates) {\n+        if (splitDates.hasOwnProperty(date)) {\n+            if (splitDates[date].indexOf(\'Z\') !== -1) {\n+                result.push(splitDates[date].substring(0, 15));\n+            } else {\n+                result.push(splitDates[date]);\n+            }\n+        }\n+    }\n+    return result;\n+}\n+\n+function parseIcal(icaldata) {\n+    var lines = [];\n+    var result = {};\n+    var propAndValue = [];\n+    var line = null;\n+    var nextline;\n+\n+    lines = icaldata.split(\'\\n\');\n+    lines.reverse();\n+    while (true) {\n+        if (lines.length > 0) {\n+            nextline = lines.pop();\n+            if (nextline.charAt(0) === \' \' || nextline.charAt(0) === \'\\t\') {\n+                // Line continuation:\n+                line = line + nextline;\n+                continue;\n+            }\n+        } else {\n+            nextline = \'\';\n+        }\n+\n+        // New line; the current one is finished, add it to the result.\n+        if (line !== null) {\n+            line = parseLine(line);\n+             // We ignore properties for now\n+            if (line.property === \'RDATE\' || line.property === \'EXDATE\') {\n+                result[line.property] = cleanDates(line.value);\n+            } else {\n+                result[line.property] = line.value;\n+            }\n+        }\n+\n+        line = nextline;\n+        if (line === \'\') {\n+            break;\n+        }\n+    }\n+    return result;\n+}\n+\n+function widgetLoadFromRfc5545(form, conf, icaldata, force) {\n+    var unsupportedFeatures = [];\n+    var i, matches, match, matchIndex, rtemplate, d, input, index;\n+    var selector, selectors, field, radiobutton, start, end;\n+    var interval, byday, bymonth, bymonthday, count, until;\n+    var day, month, year, weekday, ical;\n+\n+    form.ical = parseIcal(icaldata);\n+    if (form.ical.RRULE === undefined) {\n+        unsupportedFeatures.push(conf.localization.noRule);\n+        if (!force) {\n+            return -1; // Fail!\n+        }\n+    } else {\n+\n+        matches = /INTERVAL=([0-9]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            interval = matches[1];\n+        } else {\n+            interval = \'1\';\n+        }\n+\n+        matches = /BYDAY=([^;]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            byday = matches[1];\n+        } else {\n+            byday = \'\';\n+        }\n+\n+        matches = /BYMONTHDAY=([^;]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            bymonthday = matches[1].split(",");\n+        } else {\n+            bymonthday = null;\n+        }\n+\n+        matches = /BYMONTH=([^;]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            bymonth = matches[1].split(",");\n+        } else {\n+            bymonth = null;\n+        }\n+\n+        matches = /COUNT=([0-9]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            count = matches[1];\n+        } else {\n+            count = null;\n+        }\n+\n+        matches = /UNTIL=([0-9T]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            until = matches[1];\n+        } else {\n+            until = null;\n+        }\n+\n+        matches = /BYSETPOS=([^;]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            unsupportedFeatures.push(conf.localization.bysetpos);\n+        }\n+\n+        // Find the best rule:\n+        match = \'\';\n+        matchIndex = null;\n+        for (i in conf.rtemplate) {\n+            if (conf.rtemplate.hasOwnProperty(i)) {\n+                rtemplate = conf.rtemplate[i];\n+                if (form.ical.RRULE.indexOf(rtemplate.rrule) === 0) {\n+                    if (form.ical.RRULE.length > match.length) {\n+                        // This is the best match so far\n+                        match = form.ical.RRULE;\n+                        matchIndex = i;\n+                    }\n+                }\n+            }\n+        }\n+\n+        if (match) {\n+            rtemplate = conf.rtemplate[matchIndex];\n+            // Set the selector:\n+            selector = form.find(\'select[name=rirtemplate]\').val(matchIndex);\n+        } else {\n+            for (rtemplate in conf.rtemplate) {\n+                if (conf.rtemplate.hasOwnProperty(rtemplate)) {\n+                    rtemplate = conf.rtemplate[rtemplate];\n+                    break;\n+                }\n+            }\n+            unsupportedFeatures.push(conf.localization.noTemplateMatch);\n+        }\n+\n+        for (i = 0; i < rtemplate.fields.length; i++) {\n+            field = form.find(\'#\' + rtemplate.fields[i]);\n+            switch (field.attr(\'id\')) {\n+\n+            case \'ridailyinterval\':\n+                field.find(\'input[name=ridailyinterval]\').val(interval);\n+                break;\n+\n+            case \'riweeklyinterval\':\n+                field.find(\'input[name=riweeklyinterval]\').val(interval);\n+                break;\n+\n+            case \'riweeklyweekdays\':\n+                byday = byday.split(",");\n+                for (d = 0; d < conf.weekdays.length; d++) {\n+                    day = conf.weekdays[d];\n+                    input = field.find(\'input[name=riweeklyweekdays\' + day + \']\');\n+                    input.attr(\'checked\', $.inArray(day, byday) !== -1);\n+                }\n+                break;\n+\n+            case \'rimonthlyinterval\':\n+                field.find(\'input[name=rimonthlyinterval]\').val(interval);\n+                break;\n+\n+            case \'rimonthlyoptions\':\n+                var monthlyType = \'DAYOFMONTH\'; // Default to using BYMONTHDAY\n+\n+                if (bymonthday) {\n+                    monthlyType = \'DAYOFMONTH\';\n+                    if (bymonthday.length > 1) {\n+                        // No support for multiple days in one month\n+                        unsupportedFeatures.push(conf.localization.multipleDayOfMonth);\n+                        // Just keep the first\n+                        bymonthday = bymonthday[0];\n+                    }\n+                    field.find(\'select[name=rimonthlydayofmonthday]\').val(bymonthday);\n+                }\n+\n+                if (byday) {\n+                    monthlyType = \'WEEKDAYOFMONTH\';\n+\n+                    if (byday.indexOf(\',\') !== -1) {\n+                        // No support for multiple days in one month\n+                        unsupportedFeatures.push(conf.localization.multipleDayOfMonth);\n+                        byday = byday.split(",")[0];\n+                    }\n+                    index = byday.slice(0, -2);\n+                    if (index.charAt(0) !== \'+\' && index.charAt(0) !== \'-\') {\n+                        index = \'+\' + index;\n+                    }\n+                    weekday = byday.slice(-2);\n+                    field.find(\'select[name=rimonthlyweekdayofmonthindex]\').val(index);\n+                    field.find(\'select[name=rimonthlyweekdayofmonth]\').val(weekday);\n+                }\n+\n+                selectors = field.find(\'input[name=rimonthlytype]\');\n+                for (index = 0; index < selectors.length; index++) {\n+                    radiobutton = selectors[index];\n+                    $(radiobutton).attr(\'checked\', radiobutton.value === monthlyType);\n+                }\n+                break;\n+\n+            case \'riyearlyinterval\':\n+                field.find(\'input[name=riyearlyinterval]\').val(interval);\n+                break;\n+\n+            case \'riyearlyoptions\':\n+                var yearlyType = \'DAYOFMONTH\'; // Default to using BYMONTHDAY\n+\n+                if (bymonthday) {\n+                    yearlyType = \'DAYOFMONTH\';\n+                    if (bymonthday.length > 1) {\n+                        // No support for multiple days in one month\n+                        unsupportedFeatures.push(conf.localization.multipleDayOfMonth);\n+                        bymonthday = bymonthday[0];\n+                    }\n+                    field.find(\'select[name=riyearlydayofmonthmonth]\').val(bymonth);\n+                    field.find(\'select[name=riyearlydayofmonthday]\').val(bymonthday);\n+                }\n+\n+                if (byday) {\n+                    yearlyType = \'WEEKDAYOFMONTH\';\n+\n+                    if (byday.indexOf(\',\') !== -1) {\n+                        // No support for multiple days in one month\n+                        unsupportedFeatures.push(conf.localization.multipleDayOfMonth);\n+                        byday = byday.split(",")[0];\n+                    }\n+                    index = byday.slice(0, -2);\n+                    if (index.charAt(0) !== \'+\' && index.charAt(0) !== \'-\') {\n+                        index = \'+\' + index;\n+                    }\n+                    weekday = byday.slice(-2);\n+                    field.find(\'select[name=riyearlyweekdayofmonthindex]\').val(index);\n+                    field.find(\'select[name=riyearlyweekdayofmonthday]\').val(weekday);\n+                    field.find(\'select[name=riyearlyweekdayofmonthmonth]\').val(bymonth);\n+                }\n+\n+                selectors = field.find(\'input[name=riyearlyType]\');\n+                for (index = 0; index < selectors.length; index++) {\n+                    radiobutton = selectors[index];\n+                    $(radiobutton).attr(\'checked\', radiobutton.value === yearlyType);\n+                }\n+                break;\n+\n+            case \'rirangeoptions\':\n+                var rangeType = \'NOENDDATE\';\n+\n+                if (count) {\n+                    rangeType = \'BYOCCURRENCES\';\n+                    field.find(\'input[name=rirangebyoccurrencesvalue]\').val(count);\n+                }\n+\n+                if (until) {\n+                    rangeType = \'BYENDDATE\';\n+                    input = field.find(\'input[name=rirangebyenddatecalendar]\');\n+                    year = until.slice(0, 4);\n+                    month = until.slice(4, 6);\n+                    month = parseInt(month, 10) - 1;\n+                    day = until.slice(6, 8);\n+                    var date_str = new Date(year, month, day).toISOString().substring(0, 10);\n+                    input.val(date_str);\n+                }\n+\n+                selectors = field.find(\'input[name=rirangetype]\');\n+                for (index = 0; index <  selectors.length; index++) {\n+                    radiobutton = selectors[index];\n+                    $(radiobutton).attr(\'checked\', radiobutton.value === rangeType);\n+                }\n+                break;\n+            }\n+        }\n+    }\n+\n+    var messagearea = form.find(\'#messagearea\');\n+    if (unsupportedFeatures.length !== 0) {\n+        messagearea.text(conf.localization.unsupportedFeatures + \' \' + unsupportedFeatures.join(\'; \'));\n+        messagearea.show();\n+        return 1;\n+    } else {\n+        messagearea.text(\'\');\n+        messagearea.hide();\n+        return 0;\n+    }\n+\n+}\n+\n const RecurrenceInput = function(conf, textarea) {\n \n     var self = this;\n-    var form, display;\n \n     // Extend conf with non-configurable data used by templates.\n     var orderedWeekdays = [];\n+    var now_date = (new Date()).toISOString().substring(0, 10);\n     var index, i;\n+\n     for (i = 0; i < 7; i++) {\n         index = i + conf.firstDay;\n         if (index > 6) {\n@@ -24,34 +548,34 @@ const RecurrenceInput = function(conf, textarea) {\n         orderedWeekdays.push(index);\n     }\n \n-    $.extend(conf, {\n+    conf = {\n+        ...conf,\n         orderIndexes: [\'+1\', \'+2\', \'+3\', \'+4\', \'-1\'],\n         weekdays: [\'SU\', \'MO\', \'TU\', \'WE\', \'TH\', \'FR\', \'SA\'],\n         orderedWeekdays: orderedWeekdays\n-    });\n+    }\n \n     // The recurrence type dropdown should show certain fields depending\n     // on selection:\n     function displayFields(selector) {\n         var i;\n         // First hide all the fields\n-        form.find(\'.rifield\').hide();\n+        self.$modalForm.find(\'.rifield\').hide();\n         // Then show the ones that should be shown.\n         var value = selector.val();\n         if (value) {\n-            var rtemplate = conf.rtemplate[value];\n-            for (i = 0; i < rtemplate.fields.length; i++) {\n-                form.find(\'#\' + rtemplate.fields[i]).show();\n+            for (let rtField of conf.rtemplate[value].fields) {\n+                self.$modalForm.find(`#${rtField}`).show();\n             }\n         }\n     }\n \n     function occurrenceExclude(event) {\n         event.preventDefault();\n-        if (form.ical.EXDATE === undefined) {\n-            form.ical.EXDATE = [];\n+        if (self.$modalForm.ical.EXDATE === undefined) {\n+            self.$modalForm.ical.EXDATE = [];\n         }\n-        form.ical.EXDATE.push(this.attributes.date.value);\n+        self.$modalForm.ical.EXDATE.push(this.attributes.date.value);\n         var $this = $(this);\n         $this.attr(\'class\', \'exdate\');\n         $this.parent().parent().addClass(\'exdate\');\n@@ -61,7 +585,7 @@ const RecurrenceInput = function(conf, textarea) {\n \n     function occurrenceInclude(event) {\n         event.preventDefault();\n-        form.ical.EXDATE.splice($.inArray(this.attributes.date.value, form.ical.EXDATE), 1);\n+        self.$modalForm.ical.EXDATE.splice($.inArray(this.attributes.date.value, self.$modalForm.ical.EXDATE), 1);\n         var $this = $(this);\n         $this.attr(\'class\', \'rrule\');\n         $this.parent().parent().removeClass(\'exdate\');\n@@ -71,7 +595,7 @@ const RecurrenceInput = function(conf, textarea) {\n \n     function occurrenceDelete(event) {\n         event.preventDefault();\n-        form.ical.RDATE.splice($.inArray(this.attributes.date.value, form.ical.RDATE), 1);\n+        self.$modalForm.ical.RDATE.splice($.inArray(this.attributes.date.value, self.$modalForm.ical.RDATE), 1);\n         $(this).parent().parent().hide(\'slow\', function () {\n             $(this).remove();\n         });\n@@ -82,19 +606,19 @@ const RecurrenceInput = function(conf, textarea) {\n         var datevalue = form\n             .find(\'.riaddoccurrence input#adddate\')\n             .val();\n-        if (form.ical.RDATE === undefined) {\n-            form.ical.RDATE = [];\n+        if (self.$modalForm.ical.RDATE === undefined) {\n+            self.$modalForm.ical.RDATE = [];\n         }\n-        var errorarea = form.find(\'.riaddoccurrence div.errorarea\');\n+        var errorarea = self.$modalForm.find(\'.riaddoccurrence div.errorarea\');\n         errorarea.text(\'\');\n         errorarea.hide();\n \n         // Add date only if it is not already in RDATE\n-        if ($.inArray(datevalue, form.ical.RDATE) === -1) {\n-            form.ical.RDATE.push(datevalue);\n+        if ($.inArray(datevalue, self.$modalForm.ical.RDATE) === -1) {\n+            self.$modalForm.ical.RDATE.push(datevalue);\n             var html = [\'<div class="occurrence rdate" style="display: none;">\',\n                     \'<span class="rdate">\',\n-                        dateinput.getValue(conf.localization.longDateFormat),\n+                        dateinput.val(),\n                         \'<span class="rlabel">\' + conf.localization.additionalDate + \'</span>\',\n                     \'</span>\',\n                     \'<span class="action">\',\n@@ -103,23 +627,23 @@ const RecurrenceInput = function(conf, textarea) {\n                         \'</a>\',\n                     \'</span>\',\n                     \'</div>\'].join(\'\\n\');\n-            form.find(\'div.rioccurrences\').prepend(html);\n-            $(form.find(\'div.rioccurrences div\')[0]).slideDown();\n-            $(form.find(\'div.rioccurrences .action a.rdate\')[0]).click(occurrenceDelete);\n+            self.$modalForm.find(\'div.rioccurrences\').prepend(html);\n+            self.$modalForm.find(\'div.rioccurrences div\')[0].slideDown();\n+            self.$modalForm.find(\'div.rioccurrences .action a.rdate\')[0].on("click", occurrenceDelete);\n         } else {\n             errorarea.text(conf.localization.alreadyAdded).show();\n         }\n     }\n \n     // element is where to find the tag in question. Can be the form\n-    // or the display widget. Defaults to the form.\n+    // or the display widget. Defaults to the self.$modalForm.\n     function loadOccurrences(startdate, rfc5545, start, readonly) {\n         var element, occurrenceDiv;\n \n         if (!readonly) {\n-            element = form;\n+            element = self.$modalForm;\n         } else {\n-            element = display;\n+            element = self.display;\n         }\n \n         occurrenceDiv = element.find(\'.rioccurrences\');\n@@ -137,7 +661,7 @@ const RecurrenceInput = function(conf, textarea) {\n                    format: conf.localization.longDateFormat,\n                    start: start};\n \n-        var dict = {\n+        $.ajax({\n             url: conf.ajaxURL,\n             async: false, // Can\'t be tested if it\'s asynchronous, annoyingly.\n             type: \'post\',\n@@ -148,11 +672,6 @@ const RecurrenceInput = function(conf, textarea) {\n             success: function (data, status, jqXHR) {\n                 var result, element;\n \n-                if (!readonly) {\n-                    element = form;\n-                } else {\n-                    element = display;\n-                }\n                 data.readOnly = readonly;\n                 data.localization = conf.localization;\n \n@@ -174,7 +693,7 @@ const RecurrenceInput = function(conf, textarea) {\n                 occurrenceDiv.replaceWith(result);\n \n                 // Add the batch actions:\n-                element.find(\'.rioccurrences .batching a\').click(\n+                element.find(\'.rioccurrences .batching a\').on("click",\n                     function (event) {\n                         event.preventDefault();\n                         loadOccurrences(startdate, rfc5545, this.attributes.start.value, readonly);\n@@ -183,9 +702,9 @@ const RecurrenceInput = function(conf, textarea) {\n \n                 // Add the delete/undelete actions:\n                 if (!readonly) {\n-                    element.find(\'.rioccurrences .action a.rrule\').click(occurrenceExclude);\n-                    element.find(\'.rioccurrences .action a.exdate\').click(occurrenceInclude);\n-                    element.find(\'.rioccurrences .action a.rdate\').click(occurrenceDelete);\n+                    element.find(\'.rioccurrences .action a.rrule\').on("click", occurrenceExclude);\n+                    element.find(\'.rioccurrences .action a.exdate\').on("click", occurrenceInclude);\n+                    element.find(\'.rioccurrences .action a.rdate\').on("click", occurrenceDelete);\n                 }\n                 // Show the new div\n                 element.find(\'.rioccurrences\').show();\n@@ -193,9 +712,7 @@ const RecurrenceInput = function(conf, textarea) {\n             error: function (jqXHR, textStatus, errorThrown) {\n                 alert(textStatus);\n             }\n-        };\n-\n-        $.ajax(dict);\n+        });\n     }\n \n     function getField(field) {\n@@ -222,18 +739,10 @@ const RecurrenceInput = function(conf, textarea) {\n                 // Field not found\n                 return null;\n             }\n-            // Now we have a field, see if it is a dateinput field:\n-            startdate = startField.data(\'dateinput\');\n-            if (!startdate) {\n-                //No, it wasn\'t, just try to interpret it with Date()\n-                startdate = startField.val();\n-                if (startdate === "") {\n-                    // Probably not an input at all. Try to see if it contains a date\n-                    startdate = startField.text();\n-                }\n-            } else {\n-                // Yes it was, get the date:\n-                startdate = startdate.getValue();\n+            startdate = startField.val();\n+            if (startdate === "") {\n+                // Probably not an input at all. Try to see if it contains a date\n+                startdate = startField.text();\n             }\n \n             if (typeof startdate === \'string\') {\n@@ -271,17 +780,8 @@ const RecurrenceInput = function(conf, textarea) {\n     function findEndDate(form) {\n         var endField, enddate;\n \n-        endField = form.find(\'input[name=rirangebyenddatecalendar]\');\n-\n-        // Now we have a field, see if it is a dateinput field:\n-        enddate = endField.data(\'dateinput\');\n-        if (!enddate) {\n-            //No, it wasn\'t, just try to interpret it with Date()\n-            enddate = endField.val();\n-        } else {\n-            // Yes it was, get the date:\n-            enddate = enddate.getValue();\n-        }\n+        endField = self.$modalForm.find(\'input[name=rirangebyenddatecalendar]\');\n+        enddate = endField.val();\n         enddate = new Date(enddate);\n \n         // if the end date is incorrect or the field is left empty\n@@ -293,7 +793,7 @@ const RecurrenceInput = function(conf, textarea) {\n     function findIntField(fieldName, form) {\n         var field, num, isInt;\n \n-        field = form.find(\'input[name=\' + fieldName + \']\');\n+        field = self.$modalForm.find(\'input[name=\' + fieldName + \']\');\n \n         num = field.val();\n \n@@ -310,61 +810,61 @@ const RecurrenceInput = function(conf, textarea) {\n         var selector, format, startdate, dayindex, day;\n \n         if (rfc5545) {\n-            widgetLoadFromRfc5545(form, conf, rfc5545, true);\n+            widgetLoadFromRfc5545(self.$modalForm, conf, rfc5545, true);\n         }\n \n         startdate = findStartDate();\n \n         if (startdate !== null) {\n             // If the date is a real date, set the defaults in the form\n-            form.find(\'select[name=rimonthlydayofmonthday]\').val(startdate.getDate());\n+            self.$modalForm.find(\'select[name=rimonthlydayofmonthday]\').val(startdate.getDate());\n             dayindex = conf.orderIndexes[Math.floor((startdate.getDate() - 1) / 7)];\n             day = conf.weekdays[startdate.getDay()];\n-            form.find(\'select[name=rimonthlyweekdayofmonthindex]\').val(dayindex);\n-            form.find(\'select[name=rimonthlyweekdayofmonth]\').val(day);\n+            self.$modalForm.find(\'select[name=rimonthlyweekdayofmonthindex]\').val(dayindex);\n+            self.$modalForm.find(\'select[name=rimonthlyweekdayofmonth]\').val(day);\n \n-            form.find(\'select[name=riyearlydayofmonthmonth]\').val(startdate.getMonth() + 1);\n-            form.find(\'select[name=riyearlydayofmonthday]\').val(startdate.getDate());\n-            form.find(\'select[name=riyearlyweekdayofmonthindex]\').val(dayindex);\n-            form.find(\'select[name=riyearlyweekdayofmonthday]\').val(day);\n-            form.find(\'select[name=riyearlyweekdayofmonthmonth]\').val(startdate.getMonth() + 1);\n+            self.$modalForm.find(\'select[name=riyearlydayofmonthmonth]\').val(startdate.getMonth() + 1);\n+            self.$modalForm.find(\'select[name=riyearlydayofmonthday]\').val(startdate.getDate());\n+            self.$modalForm.find(\'select[name=riyearlyweekdayofmonthindex]\').val(dayindex);\n+            self.$modalForm.find(\'select[name=riyearlyweekdayofmonthday]\').val(day);\n+            self.$modalForm.find(\'select[name=riyearlyweekdayofmonthmonth]\').val(startdate.getMonth() + 1);\n \n             // Now when we have a start date, we can also do an ajax call to calculate occurrences:\n-            loadOccurrences(startdate, widgetSaveToRfc5545(form, conf, false).result, 0, false);\n+            loadOccurrences(startdate, widgetSaveToRfc5545(self.$modalForm, conf, false).result, 0, false);\n \n             // Show the add and refresh buttons:\n-            form.find(\'div.rioccurrencesactions\').show();\n+            self.$modalForm.find(\'div.rioccurrencesactions\').show();\n \n         } else {\n             // No EXDATE/RDATE support\n-            form.find(\'div.rioccurrencesactions\').hide();\n+            self.$modalForm.find(\'div.rioccurrencesactions\').hide();\n         }\n \n \n-        selector = form.find(\'select[name=rirtemplate]\');\n+        selector = self.$modalForm.find(\'select[name=rirtemplate]\');\n         displayFields(selector);\n     }\n \n-    function recurrenceOn() {\n+    function recurrenceOn(form) {\n         var RFC5545 = widgetSaveToRfc5545(form, conf, false);\n-        var label = display.find(\'label[class=ridisplay]\');\n+        var label = self.display.find(\'label[class=ridisplay]\');\n         label.text(conf.localization.displayActivate + \' \' + RFC5545.description);\n-        textarea.val(RFC5545.result).change();\n+        textarea.val(RFC5545.result).trigger("change");\n         var startdate = findStartDate();\n         if (startdate !== null) {\n             loadOccurrences(startdate, widgetSaveToRfc5545(form, conf, false).result, 0, true);\n         }\n-        display.find(\'button[name="riedit"]\').text(conf.localization.edit_rules);\n-        display.find(\'button[name="ridelete"]\').show();\n+        self.display.find(\'button[name="riedit"]\').text(conf.localization.edit_rules);\n+        self.display.find(\'button[name="ridelete"]\').show();\n     }\n \n     function recurrenceOff() {\n-        var label = display.find(\'label[class=ridisplay]\');\n+        var label = self.display.find(\'label[class=ridisplay]\');\n         label.text(conf.localization.displayUnactivate);\n-        textarea.val(\'\').change();  // Clear the textarea.\n-        display.find(\'.rioccurrences\').hide();\n-        display.find(\'button[name="riedit"]\').text(conf.localization.add_rules);\n-        display.find(\'button[name="ridelete"]\').hide();\n+        textarea.val(\'\').trigger("change");  // Clear the textarea.\n+        self.display.find(\'.rioccurrences\').hide();\n+        self.display.find(\'button[name="riedit"]\').text(conf.localization.add_rules);\n+        self.display.find(\'button[name="ridelete"]\').hide();\n     }\n \n     function checkFields(form) {\n@@ -372,15 +872,15 @@ const RecurrenceInput = function(conf, textarea) {\n         startDate = findStartDate();\n \n         // Hide any error message from before\n-        messagearea = form.find(\'#messagearea\');\n+        messagearea = self.$modalForm.find(\'#messagearea\');\n         messagearea.text(\'\');\n         messagearea.hide();\n \n         // Hide add field errors\n-        form.find(\'.riaddoccurrence div.errorarea\').text(\'\').hide();\n+        self.$modalForm.find(\'.riaddoccurrence div.errorarea\').text(\'\').hide();\n \n         // Repeats Daily\n-        if (form.find(\'#ridailyinterval\').css(\'display\') === \'block\') {\n+        if (self.$modalForm.find(\'#ridailyinterval\').css(\'display\') === \'block\') {\n             // Check repeat every field\n             num = findIntField(\'ridailyinterval\', form);\n             if (!num || num < 1 || num > 1000) {\n@@ -390,7 +890,7 @@ const RecurrenceInput = function(conf, textarea) {\n         }\n \n         // Repeats Weekly\n-        if (form.find(\'#riweeklyinterval\').css(\'display\') === \'block\') {\n+        if (self.$modalForm.find(\'#riweeklyinterval\').css(\'display\') === \'block\') {\n             // Check repeat every field\n             num = findIntField(\'riweeklyinterval\', form);\n             if (!num || num < 1 || num > 1000) {\n@@ -400,7 +900,7 @@ const RecurrenceInput = function(conf, textarea) {\n         }\n \n         // Repeats Monthly\n-        if (form.find(\'#rimonthlyinterval\').css(\'display\') === \'block\') {\n+        if (self.$modalForm.find(\'#rimonthlyinterval\').css(\'display\') === \'block\') {\n             // Check repeat every field\n             num = findIntField(\'rimonthlyinterval\', form);\n             if (!num || num < 1 || num > 1000) {\n@@ -409,14 +909,14 @@ const RecurrenceInput = function(conf, textarea) {\n             }\n \n             // Check repeat on\n-            if (form.find(\'#rimonthlyoptions input:checked\').length === 0) {\n+            if (self.$modalForm.find(\'#rimonthlyoptions input:checked\').length === 0) {\n                 messagearea.text(conf.localization.noRepeatOn).show();\n                 return false;\n             }\n         }\n \n         // Repeats Yearly\n-        if (form.find(\'#riyearlyinterval\').css(\'display\') === \'block\') {\n+        if (self.$modalForm.find(\'#riyearlyinterval\').css(\'display\') === \'block\') {\n             // Check repeat every field\n             num = findIntField(\'riyearlyinterval\', form);\n             if (!num || num < 1 || num > 1000) {\n@@ -425,7 +925,7 @@ const RecurrenceInput = function(conf, textarea) {\n             }\n \n             // Check repeat on\n-            if (form.find(\'#riyearlyoptions input:checked\').length === 0) {\n+            if (self.$modalForm.find(\'#riyearlyoptions input:checked\').length === 0) {\n                 messagearea.text(conf.localization.noRepeatOn).show();\n                 return false;\n             }\n@@ -434,7 +934,7 @@ const RecurrenceInput = function(conf, textarea) {\n         // End recurrence fields\n \n         // If after N occurences is selected, check its value\n-        if (form.find(\'input[value="BYOCCURRENCES"]:visible:checked\').length > 0) {\n+        if (self.$modalForm.find(\'input[value="BYOCCURRENCES"]:visible:checked\').length > 0) {\n             num = findIntField(\'rirangebyoccurrencesvalue\', form);\n             if (!num || num < 1 || num > 1000) {\n                 messagearea.text(conf.localization.noEndAfterNOccurrences).show();\n@@ -443,7 +943,7 @@ const RecurrenceInput = function(conf, textarea) {\n         }\n \n         // If end date is selected, check its value\n-        if (form.find(\'input[value="BYENDDATE"]:visible:checked\').length > 0) {\n+        if (self.$modalForm.find(\'input[value="BYENDDATE"]:visible:checked\').length > 0) {\n             endDate = findEndDate(form);\n             if (!endDate) {\n                 // if endDate is null that means the field is empty\n@@ -462,55 +962,129 @@ const RecurrenceInput = function(conf, textarea) {\n     function save(event) {\n         event.preventDefault();\n         // if no field errors, process the request\n-        if (checkFields(form)) {\n-            // close overlay\n-            form.overlay().close();\n-            recurrenceOn();\n+        if (checkFields(self.$modalForm)) {\n+            // close modal\n+            self.modal.hide();\n+            recurrenceOn(self.$modalForm);\n+            self.$modalForm = null;\n         }\n     }\n \n     function cancel(event) {\n         event.preventDefault();\n-        // close overlay\n-        form.overlay().close();\n+        // close modal\n+        self.modal.hide();\n+        self.$modalForm = null;\n     }\n \n-    function updateOccurances() {\n+    function updateOccurrences() {\n         var startDate;\n         startDate = findStartDate();\n \n         // if no field errors, process the request\n         if (checkFields(form)) {\n             loadOccurrences(startDate,\n-                widgetSaveToRfc5545(form, conf, false).result,\n+                widgetSaveToRfc5545(self.$modalForm, conf, false).result,\n                 0,\n                 false);\n         }\n     }\n \n+    function initModalForm() {\n+        self.$modalForm.ical = {RDATE: [], EXDATE: []};\n+        var enddate = self.$modalForm.find(\'input[name=rirangebyenddatecalendar]\');\n+        if(!enddate.val()) {\n+            enddate.val(now_date);\n+        }\n+\n+        self.$modalForm.find(\'input#addaction\').on("click", occurrenceAdd);\n+\n+        // When the reload button is clicked, reload\n+        self.$modalForm.find(\'a.rirefreshbutton\').on(\n+            "click",\n+            function (event) {\n+                event.preventDefault();\n+                updateOccurrences();\n+            }\n+        );\n+\n+        // When selecting template, update what fieldsets are visible.\n+        self.$modalForm.find(\'select[name="rirtemplate"]\').on(\n+            "change",\n+            function (e) {\n+                displayFields($(this));\n+            }\n+        );\n+\n+        // When focus goes to a drop-down, select the relevant radiobutton.\n+        self.$modalForm.find(\'select\').on(\n+            "change",\n+            function (e) {\n+                $(this).parent().find(\'> input\').trigger("click").trigger("change");\n+            }\n+        );\n+        self.$modalForm.find(\'input[name=rirangebyoccurrencesvalue]\').on(\n+            "change",\n+            function (e) {\n+                $(self).parent().find(\'input[name=rirangetype]\').trigger("click").trigger("change");\n+            }\n+        );\n+        self.$modalForm.find(\'input[name=rirangebyenddatecalendar]\').on(\n+            "change",\n+            function () {\n+            // Update only if the occurances are shown\n+            $(this).parent().find(\'input[name=rirangetype]\').on("click", );\n+            if (self.$modalForm.find(\'.rioccurrencesactions:visible\').length !== 0) {\n+                updateOccurrences();\n+            }\n+        });\n+        // Update the selected dates section\n+        self.$modalForm.find(\'input:radio, .riweeklyweekday > input, input[name=ridailyinterval], input[name=riweeklyinterval], input[name=rimonthlyinterval], input[name=riyearlyinterval]\').change(\n+            function (e) {\n+                // Update only if the occurances are shown\n+                if (self.$modalForm.find(\'.rioccurrencesactions:visible\').length !== 0) {\n+                    updateOccurrences();\n+                }\n+            }\n+        );\n+\n+        // initialize occurrence adddate value\n+        self.$modalForm.find(\'div.riaddoccurrence input#adddate\').val(now_date);\n+\n+        /*\n+        Save and cancel methods:\n+        */\n+        self.$modalForm.find(\'.ricancelbutton\').on("click", cancel);\n+        self.$modalForm.find(\'.risavebutton\').on("click", save);\n+    }\n+\n     /*\n       Load the templates\n     */\n \n-    var now_date = (new Date()).toISOString().substring(0, 10);\n-    display = $(_.template(DisplayTemplate)(conf));\n-    form = $(_.template(FormTemplate)(conf));\n-\n-    // Make an overlay and hide it\n-    this.modal = new Modal(form);\n+    self.display = $(_.template(DisplayTemplate)(conf));\n+    var form = $(_.template(FormTemplate)(conf));\n \n-    form.ical = {RDATE: [], EXDATE: []};\n+    form.appendTo("body");\n+    form.hide();\n \n-    // Make the date input into a calendar dateinput()\n-    form.find(\'input[name=rirangebyenddatecalendar]\').val(now_date);\n+    // Make an modal and hide it\n+    self.modal = new Modal(form, {\n+        content: \'div.riform\',\n+        buttons: \'.ributtons > button\',\n+        modalSizeClass: "modal-lg",\n+        backdropOptions: {\n+            opacity: "0.5",\n+        }\n+    });\n \n     if (textarea.val()) {\n         var result = widgetLoadFromRfc5545(form, conf, textarea.val(), false);\n         if (result === -1) {\n-            var label = display.find(\'label[class=ridisplay]\');\n+            var label = self.display.find(\'label[class=ridisplay]\');\n             label.text(conf.localization.noRule);\n         } else {\n-            recurrenceOn();\n+            recurrenceOn(form);\n         }\n     }\n \n@@ -519,87 +1093,24 @@ const RecurrenceInput = function(conf, textarea) {\n     */\n \n     // When you click "Delete...", the recurrence rules should be cleared.\n-    display.find(\'button[name=ridelete]\').click(function (e) {\n+    self.display.find(\'button[name=ridelete]\').on("click", function (e) {\n         e.preventDefault();\n         recurrenceOff();\n     });\n \n-    // Show form overlay when you click on the "Edit..." link\n-    display.find(\'button[name=riedit]\').on(\n+    // Show form modal when you click on the "Edit..." link\n+    self.display.find(\'button[name=riedit]\').on(\n         "click",\n         function (e) {\n             // Load the form to set up the right fields to show, etc.\n-            loadData(textarea.val());\n             e.preventDefault();\n-            form.overlay().load();\n-        }\n-    );\n-\n-    // Pop up the little add form when clicking "Add"\n-    form.find(\'div.riaddoccurrence input#adddate\').val(now_date);\n-    form.find(\'input#addaction\').on("click", occurrenceAdd);\n-\n-    // When the reload button is clicked, reload\n-    form.find(\'a.rirefreshbutton\').on(\n-        "click",\n-        function (event) {\n-            event.preventDefault();\n-            updateOccurances();\n-        }\n-    );\n-\n-    // When selecting template, update what fieldsets are visible.\n-    form.find(\'select[name=rirtemplate]\').change(\n-        function (e) {\n-            displayFields($(this));\n-        }\n-    );\n-\n-    // When focus goes to a drop-down, select the relevant radiobutton.\n-    form.find(\'select\').change(\n-        function (e) {\n-            $(this).parent().find(\'> input\').click().change();\n-        }\n-    );\n-    form.find(\'input[name=rirangebyoccurrencesvalue]\').change(\n-        function (e) {\n-            $(this).parent().find(\'input[name=rirangetype]\').click().change();\n-        }\n-    );\n-    form.find(\'input[name=rirangebyenddatecalendar]\').change(function () {\n-        // Update only if the occurances are shown\n-        $(this).parent().find(\'input[name=rirangetype]\').click();\n-        if (form.find(\'.rioccurrencesactions:visible\').length !== 0) {\n-            updateOccurances();\n-        }\n-    });\n-    // Update the selected dates section\n-    form.find(\'input:radio, .riweeklyweekday > input, input[name=ridailyinterval], input[name=riweeklyinterval], input[name=rimonthlyinterval], input[name=riyearlyinterval]\').change(\n-        function (e) {\n-            // Update only if the occurances are shown\n-            if (form.find(\'.rioccurrencesactions:visible\').length !== 0) {\n-                updateOccurances();\n-            }\n+            self.modal.show();\n+            self.$modalForm = $("form", self.modal.$modalContent);\n+            loadData(textarea.val());\n+            initModalForm();\n         }\n     );\n \n-    /*\n-      Save and cancel methods:\n-    */\n-    form.find(\'.ricancelbutton\').click(cancel);\n-    form.find(\'.risavebutton\').click(save);\n-\n-    /*\n-     * Public API of RecurrenceInput\n-     */\n-\n-    $.extend(self, {\n-        display: display,\n-        form: form,\n-        loadData: loadData, //Used by tests.\n-        save: save //Used by tests.\n-    });\n-\n }\n \n export default Base.extend({\n@@ -790,12 +1301,9 @@ export default Base.extend({\n \n         this.$el.addClass("recurrence-widget");\n \n-        // "compile" configuration for widget\n-\n         // our recurrenceinput widget instance\n         var recurrenceinput = new RecurrenceInput(this.options, this.$el);\n         // hide textarea and place display widget after textarea\n-        recurrenceinput.form.appendTo(\'body\');\n         this.$el.after(recurrenceinput.display);\n \n         // hide the textarea\n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-03T11:53:50+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/3a0b4d4e463d4f46587d322bd66f7e9d94fa165b

occurrence listing add/remove/exclude

Files changed:
M src/pat/recurrence/recurrence.js
M src/pat/recurrence/recurrence.scss
M src/pat/recurrence/templates/form.xml
M src/pat/recurrence/templates/occurrence.xml

b'diff --git a/src/pat/recurrence/recurrence.js b/src/pat/recurrence/recurrence.js\nindex 54fb1b197..9bbed80e7 100644\n--- a/src/pat/recurrence/recurrence.js\n+++ b/src/pat/recurrence/recurrence.js\n@@ -6,7 +6,44 @@ import DisplayTemplate from "./templates/display.xml";\n import FormTemplate from "./templates/form.xml";\n import OccurrenceTemplate from "./templates/occurrence.xml";\n import Modal from "../modal/modal";\n+import utils from "../../core/utils";\n \n+// Formatting function (mostly) from jQueryTools dateinput\n+var Re = /d{1,4}|m{1,4}|yy(?:yy)?|"[^"]*"|\'[^\']*\'/g;\n+\n+function zeropad(val, len) {\n+    val = val.toString();\n+    len = len || 2;\n+    while (val.length < len) { val = "0" + val; }\n+    return val;\n+}\n+\n+function format(date, fmt, conf) {\n+    var d = date.getDate(),\n+        D = date.getDay(),\n+        m = date.getMonth(),\n+        y = date.getFullYear(),\n+\n+        flags = {\n+            d:    d,\n+            dd:   zeropad(d),\n+            ddd:  conf.localization.shortWeekdays[D],\n+            dddd: conf.localization.weekdays[D],\n+            m:    m + 1,\n+            mm:   zeropad(m + 1),\n+            mmm:  conf.localization.shortMonths[m],\n+            mmmm: conf.localization.months[m],\n+            yy:   String(y).slice(2),\n+            yyyy: y\n+        };\n+\n+    var result = fmt.replace(Re, function ($0) {\n+        return flags.hasOwnProperty($0) ? flags[$0] : $0.slice(1, $0.length - 1);\n+    });\n+\n+    return result;\n+\n+}\n \n function widgetSaveToRfc5545(form, conf, tz) {\n     var value = form.find(\'select[name=rirtemplate]\').val();\n@@ -577,20 +614,18 @@ const RecurrenceInput = function(conf, textarea) {\n         }\n         self.$modalForm.ical.EXDATE.push(this.attributes.date.value);\n         var $this = $(this);\n-        $this.attr(\'class\', \'exdate\');\n+        $this.addClass(\'exdate\');\n         $this.parent().parent().addClass(\'exdate\');\n-        $this.unbind(event);\n-        $this.on("click", occurrenceInclude);\n+        $this.off("click").on("click", occurrenceInclude);\n     }\n \n     function occurrenceInclude(event) {\n         event.preventDefault();\n         self.$modalForm.ical.EXDATE.splice($.inArray(this.attributes.date.value, self.$modalForm.ical.EXDATE), 1);\n         var $this = $(this);\n-        $this.attr(\'class\', \'rrule\');\n+        $this.removeClass(\'exdate\');\n         $this.parent().parent().removeClass(\'exdate\');\n-        $this.unbind(event);\n-        $this.on("click", occurrenceExclude);\n+        $this.off("click").on("click", occurrenceExclude);\n     }\n \n     function occurrenceDelete(event) {\n@@ -603,7 +638,7 @@ const RecurrenceInput = function(conf, textarea) {\n \n     function occurrenceAdd(event) {\n         event.preventDefault();\n-        var datevalue = form\n+        var datevalue = self.$modalForm\n             .find(\'.riaddoccurrence input#adddate\')\n             .val();\n         if (self.$modalForm.ical.RDATE === undefined) {\n@@ -616,20 +651,21 @@ const RecurrenceInput = function(conf, textarea) {\n         // Add date only if it is not already in RDATE\n         if ($.inArray(datevalue, self.$modalForm.ical.RDATE) === -1) {\n             self.$modalForm.ical.RDATE.push(datevalue);\n-            var html = [\'<div class="occurrence rdate" style="display: none;">\',\n-                    \'<span class="rdate">\',\n-                        dateinput.val(),\n-                        \'<span class="rlabel">\' + conf.localization.additionalDate + \'</span>\',\n-                    \'</span>\',\n-                    \'<span class="action">\',\n-                        \'<a date="\' + datevalue + \'" href="#" class="rdate" >\',\n-                            \'Include\',\n-                        \'</a>\',\n-                    \'</span>\',\n-                    \'</div>\'].join(\'\\n\');\n-            self.$modalForm.find(\'div.rioccurrences\').prepend(html);\n-            self.$modalForm.find(\'div.rioccurrences div\')[0].slideDown();\n-            self.$modalForm.find(\'div.rioccurrences .action a.rdate\')[0].on("click", occurrenceDelete);\n+            var $newdate = $(`<div class="occurrence rdate">\n+                <span class="rdate">\n+                    ${datevalue},\n+                    <span class="rlabel">${conf.localization.additionalDate}</span>\n+                </span>\n+                <span class="action">\n+                    <a date="${datevalue}" href="#" class="btn btn-sm btn-secondary rdate" >\n+                        ${conf.icons.remove}\n+                    </a>\n+                </span>\n+                </div>`);\n+            $newdate.hide();\n+            self.$modalForm.find(\'div.rioccurrences\').prepend($newdate);\n+            $newdate.slideDown();\n+            $newdate.find(\'a.rdate\').on("click", occurrenceDelete);\n         } else {\n             errorarea.text(conf.localization.alreadyAdded).show();\n         }\n@@ -670,22 +706,20 @@ const RecurrenceInput = function(conf, textarea) {\n             cache: false,\n             data: data,\n             success: function (data, status, jqXHR) {\n-                var result, element;\n+                var result;\n \n                 data.readOnly = readonly;\n                 data.localization = conf.localization;\n+                data.icons = conf.icons;\n \n                 // Format dates:\n-                var occurrence, date, y, m, d, each;\n-                for (each in data.occurrences) {\n-                    if (data.occurrences.hasOwnProperty(each)) {\n-                        occurrence = data.occurrences[each];\n-                        date = occurrence.date;\n-                        y = parseInt(date.substring(0, 4), 10);\n-                        m = parseInt(date.substring(4, 6), 10) - 1; // jan=0\n-                        d = parseInt(date.substring(6, 8), 10);\n-                        occurrence.formattedDate = format(new Date(y, m, d), conf.localization.longDateFormat, conf);\n-                    }\n+                var date, y, m, d;\n+                for (let occurrence of data.occurrences) {\n+                    date = occurrence.date;\n+                    y = parseInt(date.substring(0, 4), 10);\n+                    m = parseInt(date.substring(4, 6), 10) - 1; // jan=0\n+                    d = parseInt(date.substring(6, 8), 10);\n+                    occurrence.formattedDate = format(new Date(y, m, d), conf.localization.longDateFormat, conf);\n                 }\n \n                 result = _.template(OccurrenceTemplate)(data);\n@@ -693,7 +727,8 @@ const RecurrenceInput = function(conf, textarea) {\n                 occurrenceDiv.replaceWith(result);\n \n                 // Add the batch actions:\n-                element.find(\'.rioccurrences .batching a\').on("click",\n+                element.find(\'.rioccurrences .batching a\').on(\n+                    "click",\n                     function (event) {\n                         event.preventDefault();\n                         loadOccurrences(startdate, rfc5545, this.attributes.start.value, readonly);\n@@ -1295,14 +1330,30 @@ export default Base.extend({\n         }\n     },\n \n+    load_icons: async function() {\n+        return {\n+            reload: await utils.resolveIcon("arrow-clockwise"),\n+            remove: await utils.resolveIcon("trash"),\n+            exclude: await utils.resolveIcon("calendar-x"),\n+            include: await utils.resolveIcon("plus-circle"),\n+        }\n+    },\n+\n     init: async function () {\n         // tmpl BEFORE recurrenceinput\n         import("./recurrence.scss");\n \n         this.$el.addClass("recurrence-widget");\n+        var icons = await this.load_icons();\n+\n+        var config = {\n+            ...this.options,\n+            ...this.options.configuration,\n+            icons: icons,\n+        }\n \n         // our recurrenceinput widget instance\n-        var recurrenceinput = new RecurrenceInput(this.options, this.$el);\n+        var recurrenceinput = new RecurrenceInput(config, this.$el);\n         // hide textarea and place display widget after textarea\n         this.$el.after(recurrenceinput.display);\n \ndiff --git a/src/pat/recurrence/recurrence.scss b/src/pat/recurrence/recurrence.scss\nindex a8b7c85b0..c89209bc9 100644\n--- a/src/pat/recurrence/recurrence.scss\n+++ b/src/pat/recurrence/recurrence.scss\n@@ -79,34 +79,6 @@ div.rioccurrences div.occurrence {\n     margin-left: 5px;\n }\n \n-div.rioccurrences a.rrule,\n-div.rioccurrences a.rdate,\n-div.rioccurrences a.exdate {\n-    color: transparent;\n-    margin-top: 6px;\n-    margin-right: 5px;\n-}\n-\n-\n-div.rioccurrences a.rrule,\n-div.rioccurrences a.rdate {\n-    // delete.png\n-    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAMAAABFjsb+AAAAdVBMVEUAAAAAAAACAgIHBwcICAgODg4PDw8QEBASEhIXFxcbGxsdHR0fHx8gICAnJyc2NjY3Nzc4ODg5OTk+Pj5ERERISEhJSUlSUlJYWFhqampvb2/Hx8fPz8/R0dHn5+fs7Ozv7+/x8fHy8vL39/f9/f3+/v7///8jaUCMAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAAOkAAADpAVSSFEsAAAB9SURBVBjTY2BQQwcMDGqyYuxsCMAuJqvGoCbCiApEgGIsECaTEBOEwQIUYwbSbAKCUmqSggKsQDYzVEwGarw0kpiwKlhIhR9JjEVNXFlMWUKNEUWMU4FZgYfGYrxKHEp8KGJM8opqQCgHEwP7l1sUBLhg/sUWLljCD0s4AwBmjBYPljOv7QAAAABJRU5ErkJggg==);\n-}\n-\n-div.rioccurrences a.exdate {\n-    // undelete.png\n-    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAMAAABFjsb+AAAAnFBMVEUCodIAAAABAQEVAAAHBwcICAgKCgoPDw8QEBBTAABVAABZAABaAAAXFxdcBwdhCgodHR2TAAAhISFlDw9nDw8vLy8wMDAxMTH4AAD5AQH6AgL+Bgb/BweDKipBQUFERERJSUlQUFBXV1daWlpmZmb0nZ31nZ36o6P/pqb/qanNzc3R0dHp6ens7Ozt7e3v7+/y8vL39/f8/Pz////TudgfAAAAAXRSTlMAQObYZgAAAKFJREFUGFdt0FsXQkAUhuHZIYfIITTVFJVEiNr//781xoUJ79Ws52KvNR8hOI0QrFJDHzPSCgkmoIBcwk0D3+LP1X41mMZNBZNuozjDLI7W3FRhYJ/K4fxrNDgzgd+LZFAcn7fPHUE2DJnbOhNzcprPrHVZODP9cShm1u7Y5s+8zum8ktqS1Q2+saktagrTeguufQFYvvhvAnKK2GVhv4WdfzaPHhGyo11gAAAAAElFTkSuQmCC);\n-}\n-\n-div.rioccurrencesactions a.rirefreshbutton {\n-    // refresh.png\n-    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAMAAABFjsb+AAAA1VBMVEWbLGwAAAABAQECAgIFBQUGBgYHBwcICAgJCQkKCgoWFhYZGRkaGhoeHh4fHx8gICAkJCQmJiYoKCgrKyssLCwxMTE3Nzc4ODg5OTk+Pj5DQ0NHR0dISEhRUVFUVFRWVlZXV1ddXV1fX19gYGBkZGRoaGhwcHBxcXF6enp/f3+BgYGDg4OEhISJiYmNjY2VlZWampqnp6eoqKirq6uurq62trbCwsLDw8PFxcXIyMjNzc3V1dXW1tbZ2dnb29vv7+/19fX39/f4+Pj6+vr7+/v8/Pz///9okOBsAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAAOkAAADpAVSSFEsAAADYSURBVBjTZdBrk8EwFAbghEprFaulxN2y2HVZ6n5tWX3//0+ScIwZ3g/JmWcmOTlhDK9hDBtpCiEqqYTQMeUGDJLrtBcxfo9UJnSRnKCfbyV1KchKRyDq4Fh6mhchxF8hQOQ9zDpg1V0a3F7hYJE1EdjlD3XMDtAkG8Gnnj5GZDMMyYaYkQ0wJ5tjQFbDyVFgec4JNTJji73LY/7vHlvj8T43xLn4gwtC9zlHbo2vf2CdozlMfXlcfvYwjuvSVFalnnz6fduqynaNbEYn7dTVmm3s9Ke+/fMVeXMr/BRXPaEAAAAASUVORK5CYII=);\n-    color: transparent;\n-    margin-top: 4px;\n-    margin-right: 5px;\n-}\n-\n div#messagearea,\n div.errorarea {\n     display: none;\ndiff --git a/src/pat/recurrence/templates/form.xml b/src/pat/recurrence/templates/form.xml\nindex c6a90acea..1812fb460 100644\n--- a/src/pat/recurrence/templates/form.xml\n+++ b/src/pat/recurrence/templates/form.xml\n@@ -286,8 +286,8 @@\n             <div class="rioccurancesheader">\n                 <h2><%= localization.preview %></h2>\n                 <span class="refreshbutton action">\n-                    <a class="rirefreshbutton" href="#" title="<%= localization.refresh %>">\n-                        <%= localization.refresh %>\n+                    <a class="btn btn-sm btn-secondary rirefreshbutton" href="#" title="<%= localization.refresh %>">\n+                        <%= icons.reload %>\n                     </a>\n                 </span>\n             </div>\n@@ -301,8 +301,8 @@\n             </div>\n             <div class="riaddoccurrence">\n                 <div class="errorarea"></div>\n-                <input type="date" name="adddate" id="adddate" />\n-                <input type="button" name="addaction" id="addaction" value="<%= localization.add %>">\n+                <input class="form-control form-control-sm w-auto" type="date" name="adddate" id="adddate" />\n+                <input class="btn btn-sm btn-success" type="button" name="addaction" id="addaction" value="<%= localization.add %>">\n             </div>\n         </div>\n \ndiff --git a/src/pat/recurrence/templates/occurrence.xml b/src/pat/recurrence/templates/occurrence.xml\nindex 0317cc9ad..f58e6a7b8 100644\n--- a/src/pat/recurrence/templates/occurrence.xml\n+++ b/src/pat/recurrence/templates/occurrence.xml\n@@ -1,39 +1,39 @@\n <div class="rioccurrences">\n-    <% for(const occurrence of occurrences) { %>\n-        <div class="occurrence <%= ocurrence.type %>">\n+    <% occurrences.forEach(function(occurrence) { %>\n+        <div class="occurrence <%= occurrence.type %>">\n             <span>\n-                <%= ocurrence.formattedDate %>\n-                <% if(ocurrence.type === "start") { %>\n+                <%= occurrence.formattedDate %>\n+                <% if(occurrence.type === "start") { %>\n                     <span class="rlabel"><%= localization.recurrenceStart %></span>\n                 <% } %>\n-                <% if(ocurrence.type === "rdate") { %>\n-                    <span class="rlabel"><%= >localization.additionalDate %></span>\n+                <% if(occurrence.type === "rdate") { %>\n+                    <span class="rlabel"><%= localization.additionalDate %></span>\n                 <% } %>\n             </span>\n             <% if(!readOnly) { %>\n                 <span class="action">\n-                    <% if(ocurrence.type === "rrule") { %>\n-                        <a date="<%= ocurrence.date %>" href="#"\n-                           class="<%= ocurrence.type %>" title="<%= localization.exclude %>">\n-                            <%= localization.exclude %>\n+                    <% if(occurrence.type === "rrule") { %>\n+                        <a date="<%= occurrence.date %>" href="#"\n+                           class="btn btn-sm btn-secondary <%= occurrence.type %>" title="<%= localization.exclude %>">\n+                            <%= icons.exclude %>\n                         </a>\n                     <% } %>\n-                    <% if(ocurrence.type === "rdate") { %>\n-                        <a date="<%= ocurrence.date %>" href="#"\n-                           class="<%= ocurrence.type %>" title="<%= localization.remove %>">\n-                            <%= localization.remove %>\n+                    <% if(occurrence.type === "rdate") { %>\n+                        <a date="<%= occurrence.date %>" href="#"\n+                           class="btn btn-sm btn-secondary <%= occurrence.type %>" title="<%= localization.remove %>">\n+                            <%= icons.remove %>\n                         </a>\n                     <% } %>\n-                    <% if(ocurrence.type === "exdate") { %>\n-                        <a date="<%= ocurrence.date %>" href="#"\n-                           class="<%= ocurrence.type %>" title="<%= localization.include %>">\n-                           <%= localization.include %>\n+                    <% if(occurrence.type === "exdate") { %>\n+                        <a date="<%= occurrence.date %>" href="#"\n+                           class="btn btn-sm btn-secondary disabled <%= occurrence.type %>" title="<%= localization.include %>">\n+                           <%= icons.include %>\n                         </a>\n                     <% } %>\n                 </span>\n             <% } %>\n         </div>\n-    <% } %>\n+    <% }) %>\n     <div class="batching">\n         <% for(var index=0; index < batch.batches.length; index++) { %>\n             <span <% if(index === batch.currentBatch) { %>class="current"<% } %>>\n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-03T12:09:50+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/ba3ea30cde27a618e18c3dde8a33de3d49a7c755

remove dependency

Files changed:
M package.json
M src/pat/recurrence/recurrence.js
M src/pat/recurrence/templates/form.xml
M src/pat/recurrence/templates/occurrence.xml

b'diff --git a/package.json b/package.json\nindex b00904261..fc2bfa48f 100644\n--- a/package.json\n+++ b/package.json\n@@ -35,7 +35,6 @@\n         "jquery": "^3.6.0",\n         "jquery-form": "4.3.0",\n         "jquery.browser": "0.1.0",\n-        "jquery.recurrenceinput.js": "git+https://github.com/collective/jquery.recurrenceinput.js.git#master",\n         "js-cookie": "^3.0.1",\n         "select2": "git+https://github.com/ivaynberg/select2.git#3.5.4",\n         "sortablejs": "^1.15.0",\ndiff --git a/src/pat/recurrence/recurrence.js b/src/pat/recurrence/recurrence.js\nindex 9bbed80e7..503b75c71 100644\n--- a/src/pat/recurrence/recurrence.js\n+++ b/src/pat/recurrence/recurrence.js\n@@ -644,7 +644,7 @@ const RecurrenceInput = function(conf, textarea) {\n         if (self.$modalForm.ical.RDATE === undefined) {\n             self.$modalForm.ical.RDATE = [];\n         }\n-        var errorarea = self.$modalForm.find(\'.riaddoccurrence div.errorarea\');\n+        var errorarea = self.$modalForm.find(\'.riaddoccurrence div.alert\');\n         errorarea.text(\'\');\n         errorarea.hide();\n \n@@ -912,7 +912,7 @@ const RecurrenceInput = function(conf, textarea) {\n         messagearea.hide();\n \n         // Hide add field errors\n-        self.$modalForm.find(\'.riaddoccurrence div.errorarea\').text(\'\').hide();\n+        self.$modalForm.find(\'.riaddoccurrence div.alert\').text(\'\').hide();\n \n         // Repeats Daily\n         if (self.$modalForm.find(\'#ridailyinterval\').css(\'display\') === \'block\') {\ndiff --git a/src/pat/recurrence/templates/form.xml b/src/pat/recurrence/templates/form.xml\nindex 1812fb460..b25ce1949 100644\n--- a/src/pat/recurrence/templates/form.xml\n+++ b/src/pat/recurrence/templates/form.xml\n@@ -283,10 +283,10 @@\n         </div>\n \n         <div class="rioccurrencesactions">\n-            <div class="rioccurancesheader">\n+            <div class="rioccurancesheader d-flex justify-content-between">\n                 <h2><%= localization.preview %></h2>\n                 <span class="refreshbutton action">\n-                    <a class="btn btn-sm btn-secondary rirefreshbutton" href="#" title="<%= localization.refresh %>">\n+                    <a class="btn btn-sm btn-outline-secondary rirefreshbutton" href="#" title="<%= localization.refresh %>">\n                         <%= icons.reload %>\n                     </a>\n                 </span>\n@@ -300,7 +300,7 @@\n                 <h2><%= localization.addDate %></h2>\n             </div>\n             <div class="riaddoccurrence">\n-                <div class="errorarea"></div>\n+                <div class="alert alert-danger d-none"></div>\n                 <input class="form-control form-control-sm w-auto" type="date" name="adddate" id="adddate" />\n                 <input class="btn btn-sm btn-success" type="button" name="addaction" id="addaction" value="<%= localization.add %>">\n             </div>\ndiff --git a/src/pat/recurrence/templates/occurrence.xml b/src/pat/recurrence/templates/occurrence.xml\nindex f58e6a7b8..23e972f00 100644\n--- a/src/pat/recurrence/templates/occurrence.xml\n+++ b/src/pat/recurrence/templates/occurrence.xml\n@@ -1,6 +1,6 @@\n <div class="rioccurrences">\n     <% occurrences.forEach(function(occurrence) { %>\n-        <div class="occurrence <%= occurrence.type %>">\n+        <div class="d-flex justify-content-between occurrence <%= occurrence.type %>">\n             <span>\n                 <%= occurrence.formattedDate %>\n                 <% if(occurrence.type === "start") { %>\n@@ -14,19 +14,19 @@\n                 <span class="action">\n                     <% if(occurrence.type === "rrule") { %>\n                         <a date="<%= occurrence.date %>" href="#"\n-                           class="btn btn-sm btn-secondary <%= occurrence.type %>" title="<%= localization.exclude %>">\n+                           class="btn btn-sm btn-outline-secondary <%= occurrence.type %>" title="<%= localization.exclude %>">\n                             <%= icons.exclude %>\n                         </a>\n                     <% } %>\n                     <% if(occurrence.type === "rdate") { %>\n                         <a date="<%= occurrence.date %>" href="#"\n-                           class="btn btn-sm btn-secondary <%= occurrence.type %>" title="<%= localization.remove %>">\n+                           class="btn btn-sm btn-outline-secondary <%= occurrence.type %>" title="<%= localization.remove %>">\n                             <%= icons.remove %>\n                         </a>\n                     <% } %>\n                     <% if(occurrence.type === "exdate") { %>\n                         <a date="<%= occurrence.date %>" href="#"\n-                           class="btn btn-sm btn-secondary disabled <%= occurrence.type %>" title="<%= localization.include %>">\n+                           class="btn btn-sm btn-outline-secondary <%= occurrence.type %>" title="<%= localization.include %>">\n                            <%= icons.include %>\n                         </a>\n                     <% } %>\n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-04T23:27:15+02:00
Author: petschki (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/b494489be06fdc2ef82a5a71e48188c5795ed5e0

yarn install

Files changed:
M yarn.lock

b'diff --git a/yarn.lock b/yarn.lock\nindex 02ad721c7..4271dd862 100644\n--- a/yarn.lock\n+++ b/yarn.lock\n@@ -6709,13 +6709,7 @@ jquery.browser@0.1.0:\n   resolved "https://registry.yarnpkg.com/jquery.browser/-/jquery.browser-0.1.0.tgz#9c72a6095fd2814b44476ea8f716677b72a6a2bb"\n   integrity sha512-5GjtLzzEBzxs/nwSVpCbSdk0acssfKsP7Upp43zmdHVV1Vb6E9VayyqPAQlfLrTeZL3YSWocCbkOvKdAc2CN4g==\n \n-"jquery.recurrenceinput.js@git+https://github.com/collective/jquery.recurrenceinput.js.git#master":\n-  version "1.6.0"\n-  resolved "git+https://github.com/collective/jquery.recurrenceinput.js.git#deaec1116575d81698778f87d8c08f02487aadf9"\n-  dependencies:\n-    jquery ""\n-\n-jquery@, jquery@3.6.0, jquery@>=1.7, jquery@>=1.7.2, jquery@^3.6.0:\n+jquery@3.6.0, jquery@>=1.7, jquery@>=1.7.2, jquery@^3.6.0:\n   version "3.6.0"\n   resolved "https://registry.yarnpkg.com/jquery/-/jquery-3.6.0.tgz#c72a09f15c1bdce142f49dbf1170bdf8adac2470"\n   integrity sha512-JVzAR/AjBvVt2BmYhxRCSYysDsPcssdmTFnzyLEts9qNwmjmu4JTAMYubEfwVOSwpQ1I1sKKFcxhZCI2buerfw==\n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-04T23:28:00+02:00
Author: petschki (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/a014c8658d5f82b5f2de370199329b94e56a9c9a

fix initializing empty recurrence field and change button to link in order to submit form instead of open modal when pressing enter key

Files changed:
M src/pat/recurrence/recurrence.js
M src/pat/recurrence/templates/display.xml

b'diff --git a/src/pat/recurrence/recurrence.js b/src/pat/recurrence/recurrence.js\nindex 503b75c71..cdfc6b80b 100644\n--- a/src/pat/recurrence/recurrence.js\n+++ b/src/pat/recurrence/recurrence.js\n@@ -651,7 +651,7 @@ const RecurrenceInput = function(conf, textarea) {\n         // Add date only if it is not already in RDATE\n         if ($.inArray(datevalue, self.$modalForm.ical.RDATE) === -1) {\n             self.$modalForm.ical.RDATE.push(datevalue);\n-            var $newdate = $(`<div class="occurrence rdate">\n+            var $newdate = $(`<div class="d-flex justify-content-between occurrence rdate">\n                 <span class="rdate">\n                     ${datevalue},\n                     <span class="rlabel">${conf.localization.additionalDate}</span>\n@@ -841,42 +841,44 @@ const RecurrenceInput = function(conf, textarea) {\n \n     // Loading (populating) display and form widget with\n     // passed RFC5545 string (data)\n-    function loadData(rfc5545) {\n+    function loadData(rfc5545, form) {\n         var selector, format, startdate, dayindex, day;\n \n         if (rfc5545) {\n-            widgetLoadFromRfc5545(self.$modalForm, conf, rfc5545, true);\n+            widgetLoadFromRfc5545(form, conf, rfc5545, true);\n+        } else {\n+            form.ical = {RDATE: [], EXDATE: []};\n         }\n \n         startdate = findStartDate();\n \n         if (startdate !== null) {\n             // If the date is a real date, set the defaults in the form\n-            self.$modalForm.find(\'select[name=rimonthlydayofmonthday]\').val(startdate.getDate());\n+            form.find(\'select[name=rimonthlydayofmonthday]\').val(startdate.getDate());\n             dayindex = conf.orderIndexes[Math.floor((startdate.getDate() - 1) / 7)];\n             day = conf.weekdays[startdate.getDay()];\n-            self.$modalForm.find(\'select[name=rimonthlyweekdayofmonthindex]\').val(dayindex);\n-            self.$modalForm.find(\'select[name=rimonthlyweekdayofmonth]\').val(day);\n+            form.find(\'select[name=rimonthlyweekdayofmonthindex]\').val(dayindex);\n+            form.find(\'select[name=rimonthlyweekdayofmonth]\').val(day);\n \n-            self.$modalForm.find(\'select[name=riyearlydayofmonthmonth]\').val(startdate.getMonth() + 1);\n-            self.$modalForm.find(\'select[name=riyearlydayofmonthday]\').val(startdate.getDate());\n-            self.$modalForm.find(\'select[name=riyearlyweekdayofmonthindex]\').val(dayindex);\n-            self.$modalForm.find(\'select[name=riyearlyweekdayofmonthday]\').val(day);\n-            self.$modalForm.find(\'select[name=riyearlyweekdayofmonthmonth]\').val(startdate.getMonth() + 1);\n+            form.find(\'select[name=riyearlydayofmonthmonth]\').val(startdate.getMonth() + 1);\n+            form.find(\'select[name=riyearlydayofmonthday]\').val(startdate.getDate());\n+            form.find(\'select[name=riyearlyweekdayofmonthindex]\').val(dayindex);\n+            form.find(\'select[name=riyearlyweekdayofmonthday]\').val(day);\n+            form.find(\'select[name=riyearlyweekdayofmonthmonth]\').val(startdate.getMonth() + 1);\n \n             // Now when we have a start date, we can also do an ajax call to calculate occurrences:\n-            loadOccurrences(startdate, widgetSaveToRfc5545(self.$modalForm, conf, false).result, 0, false);\n+            loadOccurrences(startdate, widgetSaveToRfc5545(form, conf, false).result, 0, false);\n \n             // Show the add and refresh buttons:\n-            self.$modalForm.find(\'div.rioccurrencesactions\').show();\n+            form.find(\'div.rioccurrencesactions\').show();\n \n         } else {\n             // No EXDATE/RDATE support\n-            self.$modalForm.find(\'div.rioccurrencesactions\').hide();\n+            form.find(\'div.rioccurrencesactions\').hide();\n         }\n \n \n-        selector = self.$modalForm.find(\'select[name=rirtemplate]\');\n+        selector = form.find(\'select[name=rirtemplate]\');\n         displayFields(selector);\n     }\n \n@@ -889,8 +891,8 @@ const RecurrenceInput = function(conf, textarea) {\n         if (startdate !== null) {\n             loadOccurrences(startdate, widgetSaveToRfc5545(form, conf, false).result, 0, true);\n         }\n-        self.display.find(\'button[name="riedit"]\').text(conf.localization.edit_rules);\n-        self.display.find(\'button[name="ridelete"]\').show();\n+        self.display.find(\'a[name="riedit"]\').text(conf.localization.edit_rules);\n+        self.display.find(\'a[name="ridelete"]\').show();\n     }\n \n     function recurrenceOff() {\n@@ -898,8 +900,8 @@ const RecurrenceInput = function(conf, textarea) {\n         label.text(conf.localization.displayUnactivate);\n         textarea.val(\'\').trigger("change");  // Clear the textarea.\n         self.display.find(\'.rioccurrences\').hide();\n-        self.display.find(\'button[name="riedit"]\').text(conf.localization.add_rules);\n-        self.display.find(\'button[name="ridelete"]\').hide();\n+        self.display.find(\'a[name="riedit"]\').text(conf.localization.add_rules);\n+        self.display.find(\'a[name="ridelete"]\').hide();\n     }\n \n     function checkFields(form) {\n@@ -1128,24 +1130,21 @@ const RecurrenceInput = function(conf, textarea) {\n     */\n \n     // When you click "Delete...", the recurrence rules should be cleared.\n-    self.display.find(\'button[name=ridelete]\').on("click", function (e) {\n+    self.display.find(\'a[name="ridelete"]\').on("click", function (e) {\n         e.preventDefault();\n         recurrenceOff();\n     });\n \n     // Show form modal when you click on the "Edit..." link\n-    self.display.find(\'button[name=riedit]\').on(\n-        "click",\n-        function (e) {\n+    self.display.find(\'a[name="riedit"]\')\n+        .on("click", function (e) {\n             // Load the form to set up the right fields to show, etc.\n             e.preventDefault();\n             self.modal.show();\n             self.$modalForm = $("form", self.modal.$modalContent);\n-            loadData(textarea.val());\n+            loadData(textarea.val(), self.$modalForm);\n             initModalForm();\n-        }\n-    );\n-\n+        })\n }\n \n export default Base.extend({\ndiff --git a/src/pat/recurrence/templates/display.xml b/src/pat/recurrence/templates/display.xml\nindex 56ddb58df..7648c244d 100644\n--- a/src/pat/recurrence/templates/display.xml\n+++ b/src/pat/recurrence/templates/display.xml\n@@ -1,8 +1,8 @@\n <div class="ridisplay">\n     <div class="rimain">\n         <% if(!readOnly) { %>\n-            <button class="btn btn-primary" name="riedit"><%= localization.add_rules %></button>\n-            <button class="btn btn-danger" name="ridelete" style="display:none"><%= localization.delete_rules %></button>\n+            <a class="btn btn-primary" name="riedit" href="#"><%= localization.add_rules %></a>\n+            <a class="btn btn-danger" name="ridelete" style="display:none" href="#"><%= localization.delete_rules %></a>\n         <% } %>\n         <label class="ridisplay"><%= localization.displayUnactivate %></label>\n     </div>\n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-04T23:56:21+02:00
Author: petschki (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/fa4c975095c490331fd5a0fc8553870dddfdf5d8

fix human enddate label and date input of enddate

Files changed:
M src/pat/recurrence/recurrence.js
M src/pat/recurrence/recurrence.scss
M src/pat/recurrence/templates/form.xml

b'diff --git a/src/pat/recurrence/recurrence.js b/src/pat/recurrence/recurrence.js\nindex cdfc6b80b..22dab6974 100644\n--- a/src/pat/recurrence/recurrence.js\n+++ b/src/pat/recurrence/recurrence.js\n@@ -177,14 +177,14 @@ function widgetSaveToRfc5545(form, conf, tz) {\n                 break;\n             case \'BYENDDATE\':\n                 field = form.find(\'input[name=rirangebyenddatecalendar]\');\n-                date = field.val().replaceAll("-", "");\n-                result += \';UNTIL=\' + date + \'T000000\';\n+                date = field.val();\n+                result += \';UNTIL=\' + date.replaceAll("-", "") + \'T000000\';\n                 if (tz === true) {\n                     // Make it UTC:\n                     result += \'Z\';\n                 }\n                 human += \', \' + conf.localization.rangeByEndDateHuman;\n-                human += \' \' + date;\n+                human += \' \' + format(new Date(...date.split("-")), conf.localization.longDateFormat, conf);\n                 break;\n             }\n             break;\n@@ -539,10 +539,8 @@ function widgetLoadFromRfc5545(form, conf, icaldata, force) {\n                     input = field.find(\'input[name=rirangebyenddatecalendar]\');\n                     year = until.slice(0, 4);\n                     month = until.slice(4, 6);\n-                    month = parseInt(month, 10) - 1;\n                     day = until.slice(6, 8);\n-                    var date_str = new Date(year, month, day).toISOString().substring(0, 10);\n-                    input.val(date_str);\n+                    input.val(`${year}-${month}-${day}`);\n                 }\n \n                 selectors = field.find(\'input[name=rirangetype]\');\ndiff --git a/src/pat/recurrence/recurrence.scss b/src/pat/recurrence/recurrence.scss\nindex c89209bc9..c1fa436bb 100644\n--- a/src/pat/recurrence/recurrence.scss\n+++ b/src/pat/recurrence/recurrence.scss\n@@ -79,15 +79,6 @@ div.rioccurrences div.occurrence {\n     margin-left: 5px;\n }\n \n-div#messagearea,\n-div.errorarea {\n-    display: none;\n-    background-color: red;\n-    color: white;\n-    font-weight: bold;\n-    padding: 2px 10px;\n-}\n-\n div#calroot {\n     z-index:10000;\n }\ndiff --git a/src/pat/recurrence/templates/form.xml b/src/pat/recurrence/templates/form.xml\nindex b25ce1949..fdef175c5 100644\n--- a/src/pat/recurrence/templates/form.xml\n+++ b/src/pat/recurrence/templates/form.xml\n@@ -1,7 +1,7 @@\n <div class="riform">\n     <form>\n         <h1><%= localization.title %></h1>\n-        <div id="messagearea" style="display: none;"> </div>\n+        <div id="messagearea" class="alert alert-danger d-none"> </div>\n         <div id="rirtemplate" class="mb-2 row">\n             <label class="col-4 col-form-label" for="<%= name %>rtemplate" class="label">\n                 <%= localization.recurrenceType %>\n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-05T00:34:22+02:00
Author: petschki (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/mockup/commit/64215e09b458b656f1e836237674a8c2f957977b

minor styling

Files changed:
M src/pat/recurrence/recurrence.scss
M src/pat/recurrence/templates/form.xml

b'diff --git a/src/pat/recurrence/recurrence.scss b/src/pat/recurrence/recurrence.scss\nindex c1fa436bb..a513b14cb 100644\n--- a/src/pat/recurrence/recurrence.scss\n+++ b/src/pat/recurrence/recurrence.scss\n@@ -1,22 +1,4 @@\n \n-div.rioccurrencesactions .riaddoccurrence #adddate {\n-    width: 75%;\n-}\n-\n-div.rioccurrencesactions .rioccurancesheader {\n-    border-bottom: 1px solid #DDDDDD;\n-    line-height: 1.5;\n-    clear: both;\n-    margin-top: 30px;\n-}\n-\n-div.rioccurrencesactions .rioccurancesheader h2 {\n-    color: #888888;\n-    display: inline;\n-    font-size: 18px;\n-    font-weight: bold;\n-    margin: 0px 0px 5px 5px;\n-}\n \n \n div.rioccurrences div.batching {\n@@ -28,14 +10,6 @@ div.rioccurrences span.current {\n     font-weight: bold;\n }\n \n-div.riform span.action a {\n-    height: 19px;\n-    width: 19px;\n-    overflow: hidden;\n-    float: right;\n-    text-indent: 9999px;\n-}\n-\n div.rioccurrences .occurrence {\n     border-top: 1px solid transparent;\n     border-bottom: 1px solid transparent;\n@@ -74,16 +48,3 @@ div.ridisplay .rimain a {\n div.rioccurrences .occurrence.rdate {\n     background: #FFFFE0;\n }\n-\n-div.rioccurrences div.occurrence {\n-    margin-left: 5px;\n-}\n-\n-div#calroot {\n-    z-index:10000;\n-}\n-\n-div.ributtons .risavebutton {\n-    display: block;\n-    margin: 30px auto 0;\n-}\ndiff --git a/src/pat/recurrence/templates/form.xml b/src/pat/recurrence/templates/form.xml\nindex fdef175c5..0c19677e2 100644\n--- a/src/pat/recurrence/templates/form.xml\n+++ b/src/pat/recurrence/templates/form.xml\n@@ -284,7 +284,7 @@\n \n         <div class="rioccurrencesactions">\n             <div class="rioccurancesheader d-flex justify-content-between">\n-                <h2><%= localization.preview %></h2>\n+                <h6><strong><%= localization.preview %></strong></h6>\n                 <span class="refreshbutton action">\n                     <a class="btn btn-sm btn-outline-secondary rirefreshbutton" href="#" title="<%= localization.refresh %>">\n                         <%= icons.reload %>\n@@ -296,13 +296,13 @@\n         <div class="rioccurrences"></div>\n \n         <div class="rioccurrencesactions">\n-            <div class="rioccurancesheader">\n-                <h2><%= localization.addDate %></h2>\n-            </div>\n-            <div class="riaddoccurrence">\n+            <h6><strong><%= localization.addDate %></strong></h6>\n+            <div class="riaddoccurrence ">\n                 <div class="alert alert-danger d-none"></div>\n-                <input class="form-control form-control-sm w-auto" type="date" name="adddate" id="adddate" />\n-                <input class="btn btn-sm btn-success" type="button" name="addaction" id="addaction" value="<%= localization.add %>">\n+                <div class="input-group">\n+                    <input class="form-control form-control-sm w-auto" type="date" name="adddate" id="adddate" />\n+                    <input class="btn btn-sm btn-success" type="button" name="addaction" id="addaction" value="<%= localization.add %>">\n+                </div>\n             </div>\n         </div>\n \n'

Repository: mockup


Branch: refs/heads/master
Date: 2022-06-20T18:28:17+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/mockup/commit/ce0103ae7cee0fccd027221aeb1f9561dd69d24a

Merge pull request #1174 from plone/pat-recurrence

pat-recurrence classic-ui

Files changed:
A src/pat/recurrence/recurrence.scss
A src/pat/recurrence/templates/display.xml
A src/pat/recurrence/templates/form.xml
A src/pat/recurrence/templates/occurrence.xml
M package.json
M src/pat/recurrence/recurrence.js
M yarn.lock

b'diff --git a/package.json b/package.json\nindex 9e56f8b96..57fe41267 100644\n--- a/package.json\n+++ b/package.json\n@@ -35,7 +35,6 @@\n         "jquery": "^3.6.0",\n         "jquery-form": "4.3.0",\n         "jquery.browser": "0.1.0",\n-        "jquery.recurrenceinput.js": "git+https://github.com/collective/jquery.recurrenceinput.js.git#master",\n         "js-cookie": "^3.0.1",\n         "select2": "git+https://github.com/ivaynberg/select2.git#3.5.4",\n         "sortablejs": "^1.15.0",\ndiff --git a/src/pat/recurrence/recurrence.js b/src/pat/recurrence/recurrence.js\nindex 8a90c43f0..22dab6974 100644\n--- a/src/pat/recurrence/recurrence.js\n+++ b/src/pat/recurrence/recurrence.js\n@@ -1,34 +1,1360 @@\n import "regenerator-runtime/runtime"; // needed for ``await`` support\n import $ from "jquery";\n+import _ from "underscore";\n import Base from "@patternslib/patternslib/src/core/base";\n+import DisplayTemplate from "./templates/display.xml";\n+import FormTemplate from "./templates/form.xml";\n+import OccurrenceTemplate from "./templates/occurrence.xml";\n+import Modal from "../modal/modal";\n+import utils from "../../core/utils";\n+\n+// Formatting function (mostly) from jQueryTools dateinput\n+var Re = /d{1,4}|m{1,4}|yy(?:yy)?|"[^"]*"|\'[^\']*\'/g;\n+\n+function zeropad(val, len) {\n+    val = val.toString();\n+    len = len || 2;\n+    while (val.length < len) { val = "0" + val; }\n+    return val;\n+}\n+\n+function format(date, fmt, conf) {\n+    var d = date.getDate(),\n+        D = date.getDay(),\n+        m = date.getMonth(),\n+        y = date.getFullYear(),\n+\n+        flags = {\n+            d:    d,\n+            dd:   zeropad(d),\n+            ddd:  conf.localization.shortWeekdays[D],\n+            dddd: conf.localization.weekdays[D],\n+            m:    m + 1,\n+            mm:   zeropad(m + 1),\n+            mmm:  conf.localization.shortMonths[m],\n+            mmmm: conf.localization.months[m],\n+            yy:   String(y).slice(2),\n+            yyyy: y\n+        };\n+\n+    var result = fmt.replace(Re, function ($0) {\n+        return flags.hasOwnProperty($0) ? flags[$0] : $0.slice(1, $0.length - 1);\n+    });\n+\n+    return result;\n+\n+}\n+\n+function widgetSaveToRfc5545(form, conf, tz) {\n+    var value = form.find(\'select[name=rirtemplate]\').val();\n+    var rtemplate = conf.rtemplate[value];\n+    var result = rtemplate.rrule;\n+    var human = conf.localization.rtemplate[value];\n+    var field, input, weekdays, i18nweekdays, i, j, index, tmp;\n+    var day, month, year, interval, yearlyType, occurrences, date;\n+\n+    for (i = 0; i < rtemplate.fields.length; i++) {\n+        field = form.find(\'#\' + rtemplate.fields[i]);\n+\n+        switch (field.attr(\'id\')) {\n+\n+        case \'ridailyinterval\':\n+            interval = field.find(\'input[name=ridailyinterval]\').val();\n+            if (interval !== \'1\') {\n+                result += \';INTERVAL=\' + interval;\n+            }\n+            human = interval + \' \' + conf.localization.dailyInterval2;\n+            break;\n+\n+        case \'riweeklyinterval\':\n+            interval = field.find(\'input[name=riweeklyinterval]\').val();\n+            if (interval !== \'1\') {\n+                result += \';INTERVAL=\' + interval;\n+            }\n+            human = interval + \' \' + conf.localization.weeklyInterval2;\n+            break;\n+\n+        case \'riweeklyweekdays\':\n+            weekdays = \'\';\n+            i18nweekdays = \'\';\n+            for (j = 0; j < conf.weekdays.length; j++) {\n+                input = field.find(\'input[name=riweeklyweekdays\' + conf.weekdays[j] + \']\');\n+                if (input.is(\':checked\')) {\n+                    if (weekdays) {\n+                        weekdays += \',\';\n+                        i18nweekdays += \', \';\n+                    }\n+                    weekdays += conf.weekdays[j];\n+                    i18nweekdays += conf.localization.weekdays[j];\n+                }\n+            }\n+            if (weekdays) {\n+                result += \';BYDAY=\' + weekdays;\n+                human += \' \' + conf.localization.weeklyWeekdaysHuman + \' \' + i18nweekdays;\n+            }\n+            break;\n+\n+        case \'rimonthlyinterval\':\n+            interval = field.find(\'input[name=rimonthlyinterval]\').val();\n+            if (interval !== \'1\') {\n+                result += \';INTERVAL=\' + interval;\n+            }\n+            human = interval + \' \' + conf.localization.monthlyInterval2;\n+            break;\n+\n+        case \'rimonthlyoptions\':\n+            var monthlyType = $(\'input[name=rimonthlytype]:checked\', form).val();\n+            switch (monthlyType) {\n+\n+            case \'DAYOFMONTH\':\n+                day = $(\'select[name=rimonthlydayofmonthday]\', form).val();\n+                result += \';BYMONTHDAY=\' + day;\n+                human += \', \' + conf.localization.monthlyDayOfMonth1Human + \' \' + day + \' \' + conf.localization.monthlyDayOfMonth2;\n+                break;\n+            case \'WEEKDAYOFMONTH\':\n+                index = $(\'select[name=rimonthlyweekdayofmonthindex]\', form).val();\n+                day = $(\'select[name=rimonthlyweekdayofmonth]\', form).val();\n+                if ($.inArray(day, [\'MO\', \'TU\', \'WE\', \'TH\', \'FR\', \'SA\', \'SU\']) > -1) {\n+                    result += \';BYDAY=\' + index + day;\n+                    human += \', \' + conf.localization.monthlyWeekdayOfMonth1Human + \' \';\n+                    human += \' \' + conf.localization.orderIndexes[$.inArray(index, conf.orderIndexes)];\n+                    human += \' \' + conf.localization.monthlyWeekdayOfMonth2;\n+                    human += \' \' + conf.localization.weekdays[$.inArray(day, conf.weekdays)];\n+                    human += \' \' + conf.localization.monthlyDayOfMonth2;\n+                }\n+                break;\n+            }\n+            break;\n+\n+        case \'riyearlyinterval\':\n+            interval = field.find(\'input[name=riyearlyinterval]\').val();\n+            if (interval !== \'1\') {\n+                result += \';INTERVAL=\' + interval;\n+            }\n+            human = interval + \' \' + conf.localization.yearlyInterval2;\n+            break;\n+\n+        case \'riyearlyoptions\':\n+            yearlyType = $(\'input[name=riyearlyType]:checked\', form).val();\n+            switch (yearlyType) {\n+\n+            case \'DAYOFMONTH\':\n+                month = $(\'select[name=riyearlydayofmonthmonth]\', form).val();\n+                day = $(\'select[name=riyearlydayofmonthday]\', form).val();\n+                result += \';BYMONTH=\' + month;\n+                result += \';BYMONTHDAY=\' + day;\n+                human += \', \' + conf.localization.yearlyDayOfMonth1Human + \' \' + conf.localization.months[month - 1] + \' \' + day;\n+                break;\n+            case \'WEEKDAYOFMONTH\':\n+                index = $(\'select[name=riyearlyweekdayofmonthindex]\', form).val();\n+                day = $(\'select[name=riyearlyweekdayofmonthday]\', form).val();\n+                month = $(\'select[name=riyearlyweekdayofmonthmonth]\', form).val();\n+                result += \';BYMONTH=\' + month;\n+                if ($.inArray(day, [\'MO\', \'TU\', \'WE\', \'TH\', \'FR\', \'SA\', \'SU\']) > -1) {\n+                    result += \';BYDAY=\' + index + day;\n+                    human += \', \' + conf.localization.yearlyWeekdayOfMonth1Human;\n+                    human += \' \' + conf.localization.orderIndexes[$.inArray(index, conf.orderIndexes)];\n+                    human += \' \' + conf.localization.yearlyWeekdayOfMonth2;\n+                    human += \' \' + conf.localization.weekdays[$.inArray(day, conf.weekdays)];\n+                    human += \' \' + conf.localization.yearlyWeekdayOfMonth3;\n+                    human += \' \' + conf.localization.months[month - 1];\n+                    human += \' \' + conf.localization.yearlyWeekdayOfMonth4;\n+                }\n+                break;\n+            }\n+            break;\n+\n+        case \'rirangeoptions\':\n+            var rangeType = form.find(\'input[name=rirangetype]:checked\').val();\n+            switch (rangeType) {\n+\n+            case \'BYOCCURRENCES\':\n+                occurrences = form.find(\'input[name=rirangebyoccurrencesvalue]\').val();\n+                result += \';COUNT=\' + occurrences;\n+                human += \', \' + conf.localization.rangeByOccurrences1Human;\n+                human += \' \' + occurrences;\n+                human += \' \' + conf.localization.rangeByOccurrences2;\n+                break;\n+            case \'BYENDDATE\':\n+                field = form.find(\'input[name=rirangebyenddatecalendar]\');\n+                date = field.val();\n+                result += \';UNTIL=\' + date.replaceAll("-", "") + \'T000000\';\n+                if (tz === true) {\n+                    // Make it UTC:\n+                    result += \'Z\';\n+                }\n+                human += \', \' + conf.localization.rangeByEndDateHuman;\n+                human += \' \' + format(new Date(...date.split("-")), conf.localization.longDateFormat, conf);\n+                break;\n+            }\n+            break;\n+        }\n+    }\n+\n+    if (form.ical.RDATE !== undefined && form.ical.RDATE.length > 0) {\n+        form.ical.RDATE.sort();\n+        tmp = [];\n+        for (i = 0; i < form.ical.RDATE.length; i++) {\n+            if (form.ical.RDATE[i] !== \'\') {\n+                year = parseInt(form.ical.RDATE[i].substring(0, 4), 10);\n+                month = parseInt(form.ical.RDATE[i].substring(4, 6), 10) - 1;\n+                day = parseInt(form.ical.RDATE[i].substring(6, 8), 10);\n+                tmp.push(format(new Date(year, month, day), conf.localization.longDateFormat, conf));\n+            }\n+        }\n+        if (tmp.length !== 0) {\n+            human = human + conf.localization.including + \' \' + tmp.join(\'; \');\n+        }\n+    }\n+\n+    if (form.ical.EXDATE !== undefined && form.ical.EXDATE.length > 0) {\n+        form.ical.EXDATE.sort();\n+        tmp = [];\n+        for (i = 0; i < form.ical.EXDATE.length; i++) {\n+            if (form.ical.EXDATE[i] !== \'\') {\n+                year = parseInt(form.ical.EXDATE[i].substring(0, 4), 10);\n+                month = parseInt(form.ical.EXDATE[i].substring(4, 6), 10) - 1;\n+                day = parseInt(form.ical.EXDATE[i].substring(6, 8), 10);\n+                tmp.push(format(new Date(year, month, day), conf.localization.longDateFormat, conf));\n+            }\n+        }\n+        if (tmp.length !== 0) {\n+            human = human + conf.localization.except + \' \' + tmp.join(\'; \');\n+        }\n+    }\n+    result = \'RRULE:\' + result;\n+    if (form.ical.EXDATE !== undefined && form.ical.EXDATE.join() !== "") {\n+        tmp = $.map(form.ical.EXDATE, function (x) {\n+            if (x.length === 8) { // DATE format. Make it DATE-TIME\n+                x += \'T000000\';\n+            }\n+            if (tz === true) {\n+                // Make it UTC:\n+                x += \'Z\';\n+            }\n+            return x;\n+        });\n+        result = result + \'\\nEXDATE:\' + tmp;\n+    }\n+    if (form.ical.RDATE !== undefined && form.ical.RDATE.join() !== "") {\n+        tmp = $.map(form.ical.RDATE, function (x) {\n+            if (x.length === 8) { // DATE format. Make it DATE-TIME\n+                x += \'T000000\';\n+            }\n+            if (tz === true) {\n+                // Make it UTC:\n+                x += \'Z\';\n+            }\n+            return x;\n+        });\n+        result = result + \'\\nRDATE:\' + tmp;\n+    }\n+    return {result: result, description: human};\n+}\n+\n+function parseLine(icalline) {\n+    var result = {};\n+    var pos = icalline.indexOf(\':\');\n+    var property = icalline.substring(0, pos);\n+    result.value = icalline.substring(pos + 1);\n+\n+    if (property.indexOf(\';\') !== -1) {\n+        pos = property.indexOf(\';\');\n+        result.parameters = property.substring(pos + 1);\n+        result.property = property.substring(0, pos);\n+    } else {\n+        result.parameters = null;\n+        result.property = property;\n+    }\n+    return result;\n+}\n+\n+function cleanDates(dates) {\n+    // Get rid of timezones\n+    // TODO: We could parse dates and range here, maybe?\n+    var result = [];\n+    var splitDates = dates.split(\',\');\n+    var date;\n+\n+    for (date in splitDates) {\n+        if (splitDates.hasOwnProperty(date)) {\n+            if (splitDates[date].indexOf(\'Z\') !== -1) {\n+                result.push(splitDates[date].substring(0, 15));\n+            } else {\n+                result.push(splitDates[date]);\n+            }\n+        }\n+    }\n+    return result;\n+}\n+\n+function parseIcal(icaldata) {\n+    var lines = [];\n+    var result = {};\n+    var propAndValue = [];\n+    var line = null;\n+    var nextline;\n+\n+    lines = icaldata.split(\'\\n\');\n+    lines.reverse();\n+    while (true) {\n+        if (lines.length > 0) {\n+            nextline = lines.pop();\n+            if (nextline.charAt(0) === \' \' || nextline.charAt(0) === \'\\t\') {\n+                // Line continuation:\n+                line = line + nextline;\n+                continue;\n+            }\n+        } else {\n+            nextline = \'\';\n+        }\n+\n+        // New line; the current one is finished, add it to the result.\n+        if (line !== null) {\n+            line = parseLine(line);\n+             // We ignore properties for now\n+            if (line.property === \'RDATE\' || line.property === \'EXDATE\') {\n+                result[line.property] = cleanDates(line.value);\n+            } else {\n+                result[line.property] = line.value;\n+            }\n+        }\n+\n+        line = nextline;\n+        if (line === \'\') {\n+            break;\n+        }\n+    }\n+    return result;\n+}\n+\n+function widgetLoadFromRfc5545(form, conf, icaldata, force) {\n+    var unsupportedFeatures = [];\n+    var i, matches, match, matchIndex, rtemplate, d, input, index;\n+    var selector, selectors, field, radiobutton, start, end;\n+    var interval, byday, bymonth, bymonthday, count, until;\n+    var day, month, year, weekday, ical;\n+\n+    form.ical = parseIcal(icaldata);\n+    if (form.ical.RRULE === undefined) {\n+        unsupportedFeatures.push(conf.localization.noRule);\n+        if (!force) {\n+            return -1; // Fail!\n+        }\n+    } else {\n+\n+        matches = /INTERVAL=([0-9]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            interval = matches[1];\n+        } else {\n+            interval = \'1\';\n+        }\n+\n+        matches = /BYDAY=([^;]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            byday = matches[1];\n+        } else {\n+            byday = \'\';\n+        }\n+\n+        matches = /BYMONTHDAY=([^;]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            bymonthday = matches[1].split(",");\n+        } else {\n+            bymonthday = null;\n+        }\n+\n+        matches = /BYMONTH=([^;]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            bymonth = matches[1].split(",");\n+        } else {\n+            bymonth = null;\n+        }\n+\n+        matches = /COUNT=([0-9]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            count = matches[1];\n+        } else {\n+            count = null;\n+        }\n+\n+        matches = /UNTIL=([0-9T]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            until = matches[1];\n+        } else {\n+            until = null;\n+        }\n+\n+        matches = /BYSETPOS=([^;]+);?/.exec(form.ical.RRULE);\n+        if (matches) {\n+            unsupportedFeatures.push(conf.localization.bysetpos);\n+        }\n+\n+        // Find the best rule:\n+        match = \'\';\n+        matchIndex = null;\n+        for (i in conf.rtemplate) {\n+            if (conf.rtemplate.hasOwnProperty(i)) {\n+                rtemplate = conf.rtemplate[i];\n+                if (form.ical.RRULE.indexOf(rtemplate.rrule) === 0) {\n+                    if (form.ical.RRULE.length > match.length) {\n+                        // This is the best match so far\n+                        match = form.ical.RRULE;\n+                        matchIndex = i;\n+                    }\n+                }\n+            }\n+        }\n+\n+        if (match) {\n+            rtemplate = conf.rtemplate[matchIndex];\n+            // Set the selector:\n+            selector = form.find(\'select[name=rirtemplate]\').val(matchIndex);\n+        } else {\n+            for (rtemplate in conf.rtemplate) {\n+                if (conf.rtemplate.hasOwnProperty(rtemplate)) {\n+                    rtemplate = conf.rtemplate[rtemplate];\n+                    break;\n+                }\n+            }\n+            unsupportedFeatures.push(conf.localization.noTemplateMatch);\n+        }\n+\n+        for (i = 0; i < rtemplate.fields.length; i++) {\n+            field = form.find(\'#\' + rtemplate.fields[i]);\n+            switch (field.attr(\'id\')) {\n+\n+            case \'ridailyinterval\':\n+                field.find(\'input[name=ridailyinterval]\').val(interval);\n+                break;\n+\n+            case \'riweeklyinterval\':\n+                field.find(\'input[name=riweeklyinterval]\').val(interval);\n+                break;\n+\n+            case \'riweeklyweekdays\':\n+                byday = byday.split(",");\n+                for (d = 0; d < conf.weekdays.length; d++) {\n+                    day = conf.weekdays[d];\n+                    input = field.find(\'input[name=riweeklyweekdays\' + day + \']\');\n+                    input.attr(\'checked\', $.inArray(day, byday) !== -1);\n+                }\n+                break;\n+\n+            case \'rimonthlyinterval\':\n+                field.find(\'input[name=rimonthlyinterval]\').val(interval);\n+                break;\n+\n+            case \'rimonthlyoptions\':\n+                var monthlyType = \'DAYOFMONTH\'; // Default to using BYMONTHDAY\n+\n+                if (bymonthday) {\n+                    monthlyType = \'DAYOFMONTH\';\n+                    if (bymonthday.length > 1) {\n+                        // No support for multiple days in one month\n+                        unsupportedFeatures.push(conf.localization.multipleDayOfMonth);\n+                        // Just keep the first\n+                        bymonthday = bymonthday[0];\n+                    }\n+                    field.find(\'select[name=rimonthlydayofmonthday]\').val(bymonthday);\n+                }\n+\n+                if (byday) {\n+                    monthlyType = \'WEEKDAYOFMONTH\';\n+\n+                    if (byday.indexOf(\',\') !== -1) {\n+                        // No support for multiple days in one month\n+                        unsupportedFeatures.push(conf.localization.multipleDayOfMonth);\n+                        byday = byday.split(",")[0];\n+                    }\n+                    index = byday.slice(0, -2);\n+                    if (index.charAt(0) !== \'+\' && index.charAt(0) !== \'-\') {\n+                        index = \'+\' + index;\n+                    }\n+                    weekday = byday.slice(-2);\n+                    field.find(\'select[name=rimonthlyweekdayofmonthindex]\').val(index);\n+                    field.find(\'select[name=rimonthlyweekdayofmonth]\').val(weekday);\n+                }\n+\n+                selectors = field.find(\'input[name=rimonthlytype]\');\n+                for (index = 0; index < selectors.length; index++) {\n+                    radiobutton = selectors[index];\n+                    $(radiobutton).attr(\'checked\', radiobutton.value === monthlyType);\n+                }\n+                break;\n+\n+            case \'riyearlyinterval\':\n+                field.find(\'input[name=riyearlyinterval]\').val(interval);\n+                break;\n+\n+            case \'riyearlyoptions\':\n+                var yearlyType = \'DAYOFMONTH\'; // Default to using BYMONTHDAY\n+\n+                if (bymonthday) {\n+                    yearlyType = \'DAYOFMONTH\';\n+                    if (bymonthday.length > 1) {\n+                        // No support for multiple days in one month\n+                        unsupportedFeatures.push(conf.localization.multipleDayOfMonth);\n+                        bymonthday = bymonthday[0];\n+                    }\n+                    field.find(\'select[name=riyearlydayofmonthmonth]\').val(bymonth);\n+                    field.find(\'select[name=riyearlydayofmonthday]\').val(bymonthday);\n+                }\n+\n+                if (byday) {\n+                    yearlyType = \'WEEKDAYOFMONTH\';\n+\n+                    if (byday.indexOf(\',\') !== -1) {\n+                        // No support for multiple days in one month\n+                        unsupportedFeatures.push(conf.localization.multipleDayOfMonth);\n+                        byday = byday.split(",")[0];\n+                    }\n+                    index = byday.slice(0, -2);\n+                    if (index.charAt(0) !== \'+\' && index.charAt(0) !== \'-\') {\n+                        index = \'+\' + index;\n+                    }\n+                    weekday = byday.slice(-2);\n+                    field.find(\'select[name=riyearlyweekdayofmonthindex]\').val(index);\n+                    field.find(\'select[name=riyearlyweekdayofmonthday]\').val(weekday);\n+                    field.find(\'select[name=riyearlyweekdayofmonthmonth]\').val(bymonth);\n+                }\n+\n+                selectors = field.find(\'input[name=riyearlyType]\');\n+                for (index = 0; index < selectors.length; index++) {\n+                    radiobutton = selectors[index];\n+                    $(radiobutton).attr(\'checked\', radiobutton.value === yearlyType);\n+                }\n+                break;\n+\n+            case \'rirangeoptions\':\n+                var rangeType = \'NOENDDATE\';\n+\n+                if (count) {\n+                    rangeType = \'BYOCCURRENCES\';\n+                    field.find(\'input[name=rirangebyoccurrencesvalue]\').val(count);\n+                }\n+\n+                if (until) {\n+                    rangeType = \'BYENDDATE\';\n+                    input = field.find(\'input[name=rirangebyenddatecalendar]\');\n+                    year = until.slice(0, 4);\n+                    month = until.slice(4, 6);\n+                    day = until.slice(6, 8);\n+                    input.val(`${year}-${month}-${day}`);\n+                }\n+\n+                selectors = field.find(\'input[name=rirangetype]\');\n+                for (index = 0; index <  selectors.length; index++) {\n+                    radiobutton = selectors[index];\n+                    $(radiobutton).attr(\'checked\', radiobutton.value === rangeType);\n+                }\n+                break;\n+            }\n+        }\n+    }\n+\n+    var messagearea = form.find(\'#messagearea\');\n+    if (unsupportedFeatures.length !== 0) {\n+        messagearea.text(conf.localization.unsupportedFeatures + \' \' + unsupportedFeatures.join(\'; \'));\n+        messagearea.show();\n+        return 1;\n+    } else {\n+        messagearea.text(\'\');\n+        messagearea.hide();\n+        return 0;\n+    }\n+\n+}\n+\n+const RecurrenceInput = function(conf, textarea) {\n+\n+    var self = this;\n+\n+    // Extend conf with non-configurable data used by templates.\n+    var orderedWeekdays = [];\n+    var now_date = (new Date()).toISOString().substring(0, 10);\n+    var index, i;\n+\n+    for (i = 0; i < 7; i++) {\n+        index = i + conf.firstDay;\n+        if (index > 6) {\n+            index = index - 7;\n+        }\n+        orderedWeekdays.push(index);\n+    }\n+\n+    conf = {\n+        ...conf,\n+        orderIndexes: [\'+1\', \'+2\', \'+3\', \'+4\', \'-1\'],\n+        weekdays: [\'SU\', \'MO\', \'TU\', \'WE\', \'TH\', \'FR\', \'SA\'],\n+        orderedWeekdays: orderedWeekdays\n+    }\n+\n+    // The recurrence type dropdown should show certain fields depending\n+    // on selection:\n+    function displayFields(selector) {\n+        var i;\n+        // First hide all the fields\n+        self.$modalForm.find(\'.rifield\').hide();\n+        // Then show the ones that should be shown.\n+        var value = selector.val();\n+        if (value) {\n+            for (let rtField of conf.rtemplate[value].fields) {\n+                self.$modalForm.find(`#${rtField}`).show();\n+            }\n+        }\n+    }\n+\n+    function occurrenceExclude(event) {\n+        event.preventDefault();\n+        if (self.$modalForm.ical.EXDATE === undefined) {\n+            self.$modalForm.ical.EXDATE = [];\n+        }\n+        self.$modalForm.ical.EXDATE.push(this.attributes.date.value);\n+        var $this = $(this);\n+        $this.addClass(\'exdate\');\n+        $this.parent().parent().addClass(\'exdate\');\n+        $this.off("click").on("click", occurrenceInclude);\n+    }\n+\n+    function occurrenceInclude(event) {\n+        event.preventDefault();\n+        self.$modalForm.ical.EXDATE.splice($.inArray(this.attributes.date.value, self.$modalForm.ical.EXDATE), 1);\n+        var $this = $(this);\n+        $this.removeClass(\'exdate\');\n+        $this.parent().parent().removeClass(\'exdate\');\n+        $this.off("click").on("click", occurrenceExclude);\n+    }\n+\n+    function occurrenceDelete(event) {\n+        event.preventDefault();\n+        self.$modalForm.ical.RDATE.splice($.inArray(this.attributes.date.value, self.$modalForm.ical.RDATE), 1);\n+        $(this).parent().parent().hide(\'slow\', function () {\n+            $(this).remove();\n+        });\n+    }\n+\n+    function occurrenceAdd(event) {\n+        event.preventDefault();\n+        var datevalue = self.$modalForm\n+            .find(\'.riaddoccurrence input#adddate\')\n+            .val();\n+        if (self.$modalForm.ical.RDATE === undefined) {\n+            self.$modalForm.ical.RDATE = [];\n+        }\n+        var errorarea = self.$modalForm.find(\'.riaddoccurrence div.alert\');\n+        errorarea.text(\'\');\n+        errorarea.hide();\n+\n+        // Add date only if it is not already in RDATE\n+        if ($.inArray(datevalue, self.$modalForm.ical.RDATE) === -1) {\n+            self.$modalForm.ical.RDATE.push(datevalue);\n+            var $newdate = $(`<div class="d-flex justify-content-between occurrence rdate">\n+                <span class="rdate">\n+                    ${datevalue},\n+                    <span class="rlabel">${conf.localization.additionalDate}</span>\n+                </span>\n+                <span class="action">\n+                    <a date="${datevalue}" href="#" class="btn btn-sm btn-secondary rdate" >\n+                        ${conf.icons.remove}\n+                    </a>\n+                </span>\n+                </div>`);\n+            $newdate.hide();\n+            self.$modalForm.find(\'div.rioccurrences\').prepend($newdate);\n+            $newdate.slideDown();\n+            $newdate.find(\'a.rdate\').on("click", occurrenceDelete);\n+        } else {\n+            errorarea.text(conf.localization.alreadyAdded).show();\n+        }\n+    }\n+\n+    // element is where to find the tag in question. Can be the form\n+    // or the display widget. Defaults to the self.$modalForm.\n+    function loadOccurrences(startdate, rfc5545, start, readonly) {\n+        var element, occurrenceDiv;\n+\n+        if (!readonly) {\n+            element = self.$modalForm;\n+        } else {\n+            element = self.display;\n+        }\n+\n+        occurrenceDiv = element.find(\'.rioccurrences\');\n+        occurrenceDiv.hide();\n+\n+        var year, month, day;\n+        year = startdate.getFullYear();\n+        month = startdate.getMonth() + 1;\n+        day = startdate.getDate();\n+\n+        var data = {year: year,\n+                   month: month, // Sending January as 0? I think not.\n+                   day: day,\n+                   rrule: rfc5545,\n+                   format: conf.localization.longDateFormat,\n+                   start: start};\n+\n+        $.ajax({\n+            url: conf.ajaxURL,\n+            async: false, // Can\'t be tested if it\'s asynchronous, annoyingly.\n+            type: \'post\',\n+            dataType: \'json\',\n+            contentType: conf.ajaxContentType,\n+            cache: false,\n+            data: data,\n+            success: function (data, status, jqXHR) {\n+                var result;\n+\n+                data.readOnly = readonly;\n+                data.localization = conf.localization;\n+                data.icons = conf.icons;\n+\n+                // Format dates:\n+                var date, y, m, d;\n+                for (let occurrence of data.occurrences) {\n+                    date = occurrence.date;\n+                    y = parseInt(date.substring(0, 4), 10);\n+                    m = parseInt(date.substring(4, 6), 10) - 1; // jan=0\n+                    d = parseInt(date.substring(6, 8), 10);\n+                    occurrence.formattedDate = format(new Date(y, m, d), conf.localization.longDateFormat, conf);\n+                }\n+\n+                result = _.template(OccurrenceTemplate)(data);\n+                occurrenceDiv = element.find(\'.rioccurrences\');\n+                occurrenceDiv.replaceWith(result);\n+\n+                // Add the batch actions:\n+                element.find(\'.rioccurrences .batching a\').on(\n+                    "click",\n+                    function (event) {\n+                        event.preventDefault();\n+                        loadOccurrences(startdate, rfc5545, this.attributes.start.value, readonly);\n+                    }\n+                );\n+\n+                // Add the delete/undelete actions:\n+                if (!readonly) {\n+                    element.find(\'.rioccurrences .action a.rrule\').on("click", occurrenceExclude);\n+                    element.find(\'.rioccurrences .action a.exdate\').on("click", occurrenceInclude);\n+                    element.find(\'.rioccurrences .action a.rdate\').on("click", occurrenceDelete);\n+                }\n+                // Show the new div\n+                element.find(\'.rioccurrences\').show();\n+            },\n+            error: function (jqXHR, textStatus, errorThrown) {\n+                alert(textStatus);\n+            }\n+        });\n+    }\n+\n+    function getField(field) {\n+        // See if it is a field already\n+        var realField = $(field);\n+        if (!realField.length) {\n+            // Otherwise, we assume it\'s an id:\n+            realField = $(\'#\' + field);\n+        }\n+        if (!realField.length) {\n+            // Still not? Then it\'s a name.\n+            realField = $("input[name=\'" + field + "\']");\n+        }\n+        return realField;\n+    }\n+    function findStartDate() {\n+        var startdate = null;\n+        var startField, startFieldYear, startFieldMonth, startFieldDay;\n+\n+        // Find the default byday and bymonthday from the start date, if any:\n+        if (conf.startField) {\n+            startField = getField(conf.startField);\n+            if (!startField.length) {\n+                // Field not found\n+                return null;\n+            }\n+            startdate = startField.val();\n+            if (startdate === "") {\n+                // Probably not an input at all. Try to see if it contains a date\n+                startdate = startField.text();\n+            }\n+\n+            if (typeof startdate === \'string\') {\n+                // convert human readable, non ISO8601 dates, like\n+                // \'2014-04-24 19:00\', where the \'T\' separator is missing.\n+                startdate = startdate.replace(\' \', \'T\');\n+            }\n+\n+            startdate = new Date(startdate);\n+        } else if (conf.startFieldYear &&\n+                   conf.startFieldMonth &&\n+                   conf.startFieldDay) {\n+            startFieldYear = getField(conf.startFieldYear);\n+            startFieldMonth = getField(conf.startFieldMonth);\n+            startFieldDay = getField(conf.startFieldDay);\n+            if (!startFieldYear.length &&\n+                !startFieldMonth.length &&\n+                !startFieldDay.length) {\n+                // Field not found\n+                return null;\n+            }\n+            startdate = new Date(startFieldYear.val(),\n+                                 startFieldMonth.val() - 1,\n+                                 startFieldDay.val());\n+        }\n+        if (startdate === null) {\n+            return null;\n+        }\n+        // We have some sort of startdate:\n+        if (isNaN(startdate)) {\n+            return null;\n+        }\n+        return startdate;\n+    }\n+    function findEndDate(form) {\n+        var endField, enddate;\n+\n+        endField = self.$modalForm.find(\'input[name=rirangebyenddatecalendar]\');\n+        enddate = endField.val();\n+        enddate = new Date(enddate);\n+\n+        // if the end date is incorrect or the field is left empty\n+        if (isNaN(enddate) || endField.val() === "") {\n+            return null;\n+        }\n+        return enddate;\n+    }\n+    function findIntField(fieldName, form) {\n+        var field, num, isInt;\n+\n+        field = self.$modalForm.find(\'input[name=\' + fieldName + \']\');\n+\n+        num = field.val();\n+\n+        // if it\'s not a number or the field is left empty\n+        if (isNaN(num) || (num.toString().indexOf(\'.\') !== -1) || field.val() === "") {\n+            return null;\n+        }\n+        return num;\n+    }\n+\n+    // Loading (populating) display and form widget with\n+    // passed RFC5545 string (data)\n+    function loadData(rfc5545, form) {\n+        var selector, format, startdate, dayindex, day;\n+\n+        if (rfc5545) {\n+            widgetLoadFromRfc5545(form, conf, rfc5545, true);\n+        } else {\n+            form.ical = {RDATE: [], EXDATE: []};\n+        }\n+\n+        startdate = findStartDate();\n+\n+        if (startdate !== null) {\n+            // If the date is a real date, set the defaults in the form\n+            form.find(\'select[name=rimonthlydayofmonthday]\').val(startdate.getDate());\n+            dayindex = conf.orderIndexes[Math.floor((startdate.getDate() - 1) / 7)];\n+            day = conf.weekdays[startdate.getDay()];\n+            form.find(\'select[name=rimonthlyweekdayofmonthindex]\').val(dayindex);\n+            form.find(\'select[name=rimonthlyweekdayofmonth]\').val(day);\n+\n+            form.find(\'select[name=riyearlydayofmonthmonth]\').val(startdate.getMonth() + 1);\n+            form.find(\'select[name=riyearlydayofmonthday]\').val(startdate.getDate());\n+            form.find(\'select[name=riyearlyweekdayofmonthindex]\').val(dayindex);\n+            form.find(\'select[name=riyearlyweekdayofmonthday]\').val(day);\n+            form.find(\'select[name=riyearlyweekdayofmonthmonth]\').val(startdate.getMonth() + 1);\n+\n+            // Now when we have a start date, we can also do an ajax call to calculate occurrences:\n+            loadOccurrences(startdate, widgetSaveToRfc5545(form, conf, false).result, 0, false);\n+\n+            // Show the add and refresh buttons:\n+            form.find(\'div.rioccurrencesactions\').show();\n+\n+        } else {\n+            // No EXDATE/RDATE support\n+            form.find(\'div.rioccurrencesactions\').hide();\n+        }\n+\n+\n+        selector = form.find(\'select[name=rirtemplate]\');\n+        displayFields(selector);\n+    }\n+\n+    function recurrenceOn(form) {\n+        var RFC5545 = widgetSaveToRfc5545(form, conf, false);\n+        var label = self.display.find(\'label[class=ridisplay]\');\n+        label.text(conf.localization.displayActivate + \' \' + RFC5545.description);\n+        textarea.val(RFC5545.result).trigger("change");\n+        var startdate = findStartDate();\n+        if (startdate !== null) {\n+            loadOccurrences(startdate, widgetSaveToRfc5545(form, conf, false).result, 0, true);\n+        }\n+        self.display.find(\'a[name="riedit"]\').text(conf.localization.edit_rules);\n+        self.display.find(\'a[name="ridelete"]\').show();\n+    }\n+\n+    function recurrenceOff() {\n+        var label = self.display.find(\'label[class=ridisplay]\');\n+        label.text(conf.localization.displayUnactivate);\n+        textarea.val(\'\').trigger("change");  // Clear the textarea.\n+        self.display.find(\'.rioccurrences\').hide();\n+        self.display.find(\'a[name="riedit"]\').text(conf.localization.add_rules);\n+        self.display.find(\'a[name="ridelete"]\').hide();\n+    }\n+\n+    function checkFields(form) {\n+        var startDate, endDate, num, messagearea;\n+        startDate = findStartDate();\n+\n+        // Hide any error message from before\n+        messagearea = self.$modalForm.find(\'#messagearea\');\n+        messagearea.text(\'\');\n+        messagearea.hide();\n+\n+        // Hide add field errors\n+        self.$modalForm.find(\'.riaddoccurrence div.alert\').text(\'\').hide();\n+\n+        // Repeats Daily\n+        if (self.$modalForm.find(\'#ridailyinterval\').css(\'display\') === \'block\') {\n+            // Check repeat every field\n+            num = findIntField(\'ridailyinterval\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noRepeatEvery).show();\n+                return false;\n+            }\n+        }\n+\n+        // Repeats Weekly\n+        if (self.$modalForm.find(\'#riweeklyinterval\').css(\'display\') === \'block\') {\n+            // Check repeat every field\n+            num = findIntField(\'riweeklyinterval\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noRepeatEvery).show();\n+                return false;\n+            }\n+        }\n+\n+        // Repeats Monthly\n+        if (self.$modalForm.find(\'#rimonthlyinterval\').css(\'display\') === \'block\') {\n+            // Check repeat every field\n+            num = findIntField(\'rimonthlyinterval\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noRepeatEvery).show();\n+                return false;\n+            }\n+\n+            // Check repeat on\n+            if (self.$modalForm.find(\'#rimonthlyoptions input:checked\').length === 0) {\n+                messagearea.text(conf.localization.noRepeatOn).show();\n+                return false;\n+            }\n+        }\n+\n+        // Repeats Yearly\n+        if (self.$modalForm.find(\'#riyearlyinterval\').css(\'display\') === \'block\') {\n+            // Check repeat every field\n+            num = findIntField(\'riyearlyinterval\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noRepeatEvery).show();\n+                return false;\n+            }\n+\n+            // Check repeat on\n+            if (self.$modalForm.find(\'#riyearlyoptions input:checked\').length === 0) {\n+                messagearea.text(conf.localization.noRepeatOn).show();\n+                return false;\n+            }\n+        }\n+\n+        // End recurrence fields\n+\n+        // If after N occurences is selected, check its value\n+        if (self.$modalForm.find(\'input[value="BYOCCURRENCES"]:visible:checked\').length > 0) {\n+            num = findIntField(\'rirangebyoccurrencesvalue\', form);\n+            if (!num || num < 1 || num > 1000) {\n+                messagearea.text(conf.localization.noEndAfterNOccurrences).show();\n+                return false;\n+            }\n+        }\n+\n+        // If end date is selected, check its value\n+        if (self.$modalForm.find(\'input[value="BYENDDATE"]:visible:checked\').length > 0) {\n+            endDate = findEndDate(form);\n+            if (!endDate) {\n+                // if endDate is null that means the field is empty\n+                messagearea.text(conf.localization.noEndDate).show();\n+                return false;\n+            } else if (endDate < startDate) {\n+                // the end date cannot be before start date\n+                messagearea.text(conf.localization.pastEndDate).show();\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    function save(event) {\n+        event.preventDefault();\n+        // if no field errors, process the request\n+        if (checkFields(self.$modalForm)) {\n+            // close modal\n+            self.modal.hide();\n+            recurrenceOn(self.$modalForm);\n+            self.$modalForm = null;\n+        }\n+    }\n+\n+    function cancel(event) {\n+        event.preventDefault();\n+        // close modal\n+        self.modal.hide();\n+        self.$modalForm = null;\n+    }\n+\n+    function updateOccurrences() {\n+        var startDate;\n+        startDate = findStartDate();\n+\n+        // if no field errors, process the request\n+        if (checkFields(form)) {\n+            loadOccurrences(startDate,\n+                widgetSaveToRfc5545(self.$modalForm, conf, false).result,\n+                0,\n+                false);\n+        }\n+    }\n+\n+    function initModalForm() {\n+        self.$modalForm.ical = {RDATE: [], EXDATE: []};\n+        var enddate = self.$modalForm.find(\'input[name=rirangebyenddatecalendar]\');\n+        if(!enddate.val()) {\n+            enddate.val(now_date);\n+        }\n+\n+        self.$modalForm.find(\'input#addaction\').on("click", occurrenceAdd);\n+\n+        // When the reload button is clicked, reload\n+        self.$modalForm.find(\'a.rirefreshbutton\').on(\n+            "click",\n+            function (event) {\n+                event.preventDefault();\n+                updateOccurrences();\n+            }\n+        );\n+\n+        // When selecting template, update what fieldsets are visible.\n+        self.$modalForm.find(\'select[name="rirtemplate"]\').on(\n+            "change",\n+            function (e) {\n+                displayFields($(this));\n+            }\n+        );\n+\n+        // When focus goes to a drop-down, select the relevant radiobutton.\n+        self.$modalForm.find(\'select\').on(\n+            "change",\n+            function (e) {\n+                $(this).parent().find(\'> input\').trigger("click").trigger("change");\n+            }\n+        );\n+        self.$modalForm.find(\'input[name=rirangebyoccurrencesvalue]\').on(\n+            "change",\n+            function (e) {\n+                $(self).parent().find(\'input[name=rirangetype]\').trigger("click").trigger("change");\n+            }\n+        );\n+        self.$modalForm.find(\'input[name=rirangebyenddatecalendar]\').on(\n+            "change",\n+            function () {\n+            // Update only if the occurances are shown\n+            $(this).parent().find(\'input[name=rirangetype]\').on("click", );\n+            if (self.$modalForm.find(\'.rioccurrencesactions:visible\').length !== 0) {\n+                updateOccurrences();\n+            }\n+        });\n+        // Update the selected dates section\n+        self.$modalForm.find(\'input:radio, .riweeklyweekday > input, input[name=ridailyinterval], input[name=riweeklyinterval], input[name=rimonthlyinterval], input[name=riyearlyinterval]\').change(\n+            function (e) {\n+                // Update only if the occurances are shown\n+                if (self.$modalForm.find(\'.rioccurrencesactions:visible\').length !== 0) {\n+                    updateOccurrences();\n+                }\n+            }\n+        );\n+\n+        // initialize occurrence adddate value\n+        self.$modalForm.find(\'div.riaddoccurrence input#adddate\').val(now_date);\n+\n+        /*\n+        Save and cancel methods:\n+        */\n+        self.$modalForm.find(\'.ricancelbutton\').on("click", cancel);\n+        self.$modalForm.find(\'.risavebutton\').on("click", save);\n+    }\n+\n+    /*\n+      Load the templates\n+    */\n+\n+    self.display = $(_.template(DisplayTemplate)(conf));\n+    var form = $(_.template(FormTemplate)(conf));\n+\n+    form.appendTo("body");\n+    form.hide();\n+\n+    // Make an modal and hide it\n+    self.modal = new Modal(form, {\n+        content: \'div.riform\',\n+        buttons: \'.ributtons > button\',\n+        modalSizeClass: "modal-lg",\n+        backdropOptions: {\n+            opacity: "0.5",\n+        }\n+    });\n+\n+    if (textarea.val()) {\n+        var result = widgetLoadFromRfc5545(form, conf, textarea.val(), false);\n+        if (result === -1) {\n+            var label = self.display.find(\'label[class=ridisplay]\');\n+            label.text(conf.localization.noRule);\n+        } else {\n+            recurrenceOn(form);\n+        }\n+    }\n+\n+    /*\n+      Do all the GUI stuff:\n+    */\n+\n+    // When you click "Delete...", the recurrence rules should be cleared.\n+    self.display.find(\'a[name="ridelete"]\').on("click", function (e) {\n+        e.preventDefault();\n+        recurrenceOff();\n+    });\n+\n+    // Show form modal when you click on the "Edit..." link\n+    self.display.find(\'a[name="riedit"]\')\n+        .on("click", function (e) {\n+            // Load the form to set up the right fields to show, etc.\n+            e.preventDefault();\n+            self.modal.show();\n+            self.$modalForm = $("form", self.modal.$modalContent);\n+            loadData(textarea.val(), self.$modalForm);\n+            initModalForm();\n+        })\n+}\n \n export default Base.extend({\n     name: "recurrence",\n     trigger: ".pat-recurrence",\n     parser: "mockup",\n     defaults: {\n-        // just passed onto the widget\n-        language: "en",\n-        localization: null,\n-        configuration: {},\n+        localization: {\n+            displayUnactivate: \'Does not repeat\',\n+            displayActivate: \'Repeats every\',\n+            add_rules: \'Add\',\n+            edit_rules: \'Edit\',\n+            delete_rules: \'Delete\',\n+            add:  \'Add\',\n+            refresh: \'Refresh\',\n+\n+            title: \'Repeat\',\n+            preview: \'Selected dates\',\n+            addDate: \'Add date\',\n+\n+            recurrenceType: \'Repeats:\',\n+\n+            dailyInterval1: \'Repeat every:\',\n+            dailyInterval2: \'days\',\n+\n+            weeklyInterval1: \'Repeat every:\',\n+            weeklyInterval2: \'week(s)\',\n+            weeklyWeekdays: \'Repeat on:\',\n+            weeklyWeekdaysHuman: \'on:\',\n+\n+            monthlyInterval1: \'Repeat every:\',\n+            monthlyInterval2: \'month(s)\',\n+            monthlyDayOfMonth1: \'Day\',\n+            monthlyDayOfMonth1Human: \'on day\',\n+            monthlyDayOfMonth2: \'of the month\',\n+            monthlyDayOfMonth3: \'month(s)\',\n+            monthlyWeekdayOfMonth1: \'The\',\n+            monthlyWeekdayOfMonth1Human: \'on the\',\n+            monthlyWeekdayOfMonth2: \'\',\n+            monthlyWeekdayOfMonth3: \'of the month\',\n+            monthlyRepeatOn: \'Repeat on:\',\n+\n+            yearlyInterval1: \'Repeat every:\',\n+            yearlyInterval2: \'year(s)\',\n+            yearlyDayOfMonth1: \'Every\',\n+            yearlyDayOfMonth1Human: \'on\',\n+            yearlyDayOfMonth2: \'\',\n+            yearlyDayOfMonth3: \'\',\n+            yearlyWeekdayOfMonth1: \'The\',\n+            yearlyWeekdayOfMonth1Human: \'on the\',\n+            yearlyWeekdayOfMonth2: \'\',\n+            yearlyWeekdayOfMonth3: \'of\',\n+            yearlyWeekdayOfMonth4: \'\',\n+            yearlyRepeatOn: \'Repeat on:\',\n+\n+            range: \'End recurrence:\',\n+            rangeNoEnd: \'Never\',\n+            rangeByOccurrences1: \'After\',\n+            rangeByOccurrences1Human: \'ends after\',\n+            rangeByOccurrences2: \'occurrence(s)\',\n+            rangeByEndDate: \'On\',\n+            rangeByEndDateHuman: \'ends on\',\n+\n+            including: \', and also\',\n+            except: \', except for\',\n+\n+            cancel: \'Cancel\',\n+            save: \'Save\',\n+\n+            recurrenceStart: \'Start of the recurrence\',\n+            additionalDate: \'Additional date\',\n+            include: \'Include\',\n+            exclude: \'Exclude\',\n+            remove: \'Remove\',\n+\n+            orderIndexes: [\'first\', \'second\', \'third\', \'fourth\', \'last\'],\n+            months: [\n+                \'January\', \'February\', \'March\', \'April\', \'May\', \'June\',\n+                \'July\', \'August\', \'September\', \'October\', \'November\', \'December\'],\n+            shortMonths: [\n+                \'Jan\', \'Feb\', \'Mar\', \'Apr\', \'May\', \'Jun\',\n+                \'Jul\', \'Aug\', \'Sep\', \'Oct\', \'Nov\', \'Dec\'],\n+            weekdays: [\n+                \'Sunday\', \'Monday\', \'Tuesday\', \'Wednesday\', \'Thursday\',\n+                \'Friday\', \'Saturday\'],\n+            shortWeekdays: [\n+                \'Sun\', \'Mon\', \'Tue\', \'Wed\', \'Thu\', \'Fri\', \'Sat\'],\n+\n+            longDateFormat: \'mmmm dd, yyyy\',\n+            shortDateFormat: \'mm/dd/yyyy\',\n+\n+            unsupportedFeatures: \'Warning: This event uses recurrence features not \' +\n+                                  \'supported by this widget. Saving the recurrence \' +\n+                                  \'may change the recurrence in unintended ways:\',\n+            noTemplateMatch: \'No matching recurrence template\',\n+            multipleDayOfMonth: \'This widget does not support multiple days in monthly or yearly recurrence\',\n+            bysetpos: \'BYSETPOS is not supported\',\n+            noRule: \'No RRULE in RRULE data\',\n+            noRepeatEvery: \'Error: The "Repeat every"-field must be between 1 and 1000\',\n+            noEndDate: \'Error: End date is not set. Please set a correct value\',\n+            noRepeatOn: \'Error: "Repeat on"-value must be selected\',\n+            pastEndDate: \'Error: End date cannot be before start date\',\n+            noEndAfterNOccurrences: \'Error: The "After N occurrences"-field must be between 1 and 1000\',\n+            alreadyAdded: \'This date was already added\',\n+\n+            rtemplate: {\n+                daily: \'Daily\',\n+                mondayfriday: \'Monday and Friday\',\n+                weekdays: \'Weekday\',\n+                weekly: \'Weekly\',\n+                monthly: \'Monthly\',\n+                yearly: \'Yearly\'\n+            }\n+        },\n+\n+        readOnly: false,\n+        firstDay: 0,\n+\n+        // "REMOTE" FIELD\n+        startField: null,\n+        startFieldYear: null,\n+        startFieldMonth: null,\n+        startFieldDay: null,\n+        ajaxURL: null,\n+        ajaxContentType: \'application/json; charset=utf8\',\n+        ributtonExtraClass: \'\',\n+\n+        // INPUT CONFIGURATION\n+        hasRepeatForeverButton: true,\n+\n+        // JQUERY TEMPLATE NAMES\n+        template: {\n+            form: \'#jquery-recurrenceinput-form-tmpl\',\n+            display: \'#jquery-recurrenceinput-display-tmpl\'\n+        },\n+\n+        // RECURRENCE TEMPLATES\n+        rtemplate: {\n+            daily: {\n+                rrule: \'FREQ=DAILY\',\n+                fields: [\n+                    \'ridailyinterval\',\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            mondayfriday: {\n+                rrule: \'FREQ=WEEKLY;BYDAY=MO,FR\',\n+                fields: [\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            weekdays: {\n+                rrule: \'FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR\',\n+                fields: [\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            weekly: {\n+                rrule: \'FREQ=WEEKLY\',\n+                fields: [\n+                    \'riweeklyinterval\',\n+                    \'riweeklyweekdays\',\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            monthly: {\n+                rrule: \'FREQ=MONTHLY\',\n+                fields: [\n+                    \'rimonthlyinterval\',\n+                    \'rimonthlyoptions\',\n+                    \'rirangeoptions\'\n+                ]\n+            },\n+            yearly: {\n+                rrule: \'FREQ=YEARLY\',\n+                fields: [\n+                    \'riyearlyinterval\',\n+                    \'riyearlyoptions\',\n+                    \'rirangeoptions\'\n+                ]\n+            }\n+        }\n     },\n+\n+    load_icons: async function() {\n+        return {\n+            reload: await utils.resolveIcon("arrow-clockwise"),\n+            remove: await utils.resolveIcon("trash"),\n+            exclude: await utils.resolveIcon("calendar-x"),\n+            include: await utils.resolveIcon("plus-circle"),\n+        }\n+    },\n+\n     init: async function () {\n         // tmpl BEFORE recurrenceinput\n-        import("jquery.recurrenceinput.js/lib/jquery.tools.dateinput.css");\n-        import("jquery.recurrenceinput.js/lib/jquery.tools.overlay.css");\n-        import("jquery.recurrenceinput.js/src/jquery.recurrenceinput.css");\n-        await import("jquery.recurrenceinput.js/lib/jquery.tools.dateinput");\n-        await import("jquery.recurrenceinput.js/lib/jquery.tools.overlay");\n-        await import("jquery.recurrenceinput.js/lib/jquery.tmpl");\n-        await import("jquery.recurrenceinput.js/src/jquery.recurrenceinput");\n+        import("./recurrence.scss");\n \n         this.$el.addClass("recurrence-widget");\n-        if (this.options.localization) {\n-            $.tools.recurrenceinput.localize(\n-                this.options.language,\n-                this.options.localization\n-            );\n+        var icons = await this.load_icons();\n+\n+        var config = {\n+            ...this.options,\n+            ...this.options.configuration,\n+            icons: icons,\n         }\n-        $(this.el).recurrenceinput(this.options.configuration);\n+\n+        // our recurrenceinput widget instance\n+        var recurrenceinput = new RecurrenceInput(config, this.$el);\n+        // hide textarea and place display widget after textarea\n+        this.$el.after(recurrenceinput.display);\n+\n+        // hide the textarea\n+        this.$el.hide();\n     },\n });\ndiff --git a/src/pat/recurrence/recurrence.scss b/src/pat/recurrence/recurrence.scss\nnew file mode 100644\nindex 000000000..a513b14cb\n--- /dev/null\n+++ b/src/pat/recurrence/recurrence.scss\n@@ -0,0 +1,50 @@\n+\n+\n+\n+div.rioccurrences div.batching {\n+    font-size: 70%;\n+    text-align: center;\n+}\n+\n+div.rioccurrences span.current {\n+    font-weight: bold;\n+}\n+\n+div.rioccurrences .occurrence {\n+    border-top: 1px solid transparent;\n+    border-bottom: 1px solid transparent;\n+}\n+\n+div.rioccurrences .occurrence:hover {\n+    border-top: 1px solid #DDDDDD;\n+    border-bottom: 1px solid #DDDDDD;\n+}\n+\n+div.rioccurrences .occurrence.start span.rlabel,\n+div.rioccurrences .occurrence.rdate span.rlabel {\n+    color: #9CBA9B;\n+    margin: 0 5px;\n+    font-size: 70%;\n+    font-weight: bold;\n+}\n+\n+div.rioccurrences .occurrence.exdate {\n+    opacity:0.4;\n+    filter:alpha(opacity=40);\n+}\n+\n+div.ridisplay .occurrence.exdate {\n+    display: none;\n+}\n+\n+div.ridisplay label.ridisplay {\n+    font-weight: 300;\n+}\n+\n+div.ridisplay .rimain a {\n+    margin-right: 0.5em;\n+}\n+\n+div.rioccurrences .occurrence.rdate {\n+    background: #FFFFE0;\n+}\ndiff --git a/src/pat/recurrence/templates/display.xml b/src/pat/recurrence/templates/display.xml\nnew file mode 100644\nindex 000000000..7648c244d\n--- /dev/null\n+++ b/src/pat/recurrence/templates/display.xml\n@@ -0,0 +1,9 @@\n+<div class="ridisplay">\n+    <div class="rimain">\n+        <% if(!readOnly) { %>\n+            <a class="btn btn-primary" name="riedit" href="#"><%= localization.add_rules %></a>\n+            <a class="btn btn-danger" name="ridelete" style="display:none" href="#"><%= localization.delete_rules %></a>\n+        <% } %>\n+        <label class="ridisplay"><%= localization.displayUnactivate %></label>\n+    </div>\n+<div class="rioccurrences" style="display:none"></div>\ndiff --git a/src/pat/recurrence/templates/form.xml b/src/pat/recurrence/templates/form.xml\nnew file mode 100644\nindex 000000000..0c19677e2\n--- /dev/null\n+++ b/src/pat/recurrence/templates/form.xml\n@@ -0,0 +1,318 @@\n+<div class="riform">\n+    <form>\n+        <h1><%= localization.title %></h1>\n+        <div id="messagearea" class="alert alert-danger d-none"> </div>\n+        <div id="rirtemplate" class="mb-2 row">\n+            <label class="col-4 col-form-label" for="<%= name %>rtemplate" class="label">\n+                <%= localization.recurrenceType %>\n+            </label>\n+            <div class="col-8">\n+                <select id="rirtemplate" name="rirtemplate" class="form-select form-select-sm">\n+                    <% Object.keys(rtemplate).forEach(function(val, idx) { %>\n+                        <option value="<%= val %>"><%= localization.rtemplate[val] %></value>\n+                    <% }) %>\n+                </select>\n+            </div>\n+        </div>\n+        <div id="riformfields" class="mb-2">\n+            <div id="ridailyinterval" class="rifield row">\n+                <label class="col-4 col-form-label" for="<%= name %>dailyinterval">\n+                    <%= localization.dailyInterval1 %>\n+                </label>\n+                <div class="col-8">\n+                    <input class="form-control form-control-sm w-auto float-start me-3" type="text" size="2"\n+                        value="1"\n+                        name="ridailyinterval"\n+                        id="<%= name %>dailyinterval" />\n+                    <%= localization.dailyInterval2 %>\n+                </div>\n+            </div>\n+\n+            <div id="riweeklyinterval" class="rifield row">\n+                <label class="col-4 col-form-label" for="<%= name %>weeklyinterval">\n+                    <%= localization.weeklyInterval1 %>\n+                </label>\n+                <div class="col-8">\n+                    <input class="form-control form-control-sm w-auto float-start me-3" type="text" size="2"\n+                        value="1"\n+                        name="riweeklyinterval"\n+                        id="<%= name %>weeklyinterval"/>\n+                    <%= localization.weeklyInterval2 %>\n+                </div>\n+            </div>\n+\n+            <div id="riweeklyweekdays" class="rifield row">\n+                <label class="col-4 col-form-label" for="<%= name %>weeklyinterval"><%= localization.weeklyWeekdays %></label>\n+                <div class="col-8">\n+                    <div class="row">\n+                    <% orderedWeekdays.forEach(function(weekday, idx) { %>\n+                        <div class="riweeklyweekday col-auto">\n+                            <div class="form-check">\n+                                <input class="form-check-input" type="checkbox"\n+                                    name="riweeklyweekdays<%=weekday %>"\n+                                    id="<%= name %>weeklyWeekdays<%=weekday %>"\n+                                    value="<%=weekday %>" />\n+                                <label class="form-check-label" for="<%= name %>weeklyWeekdays<%= weekday %>"><%= localization.shortWeekdays[idx] %></label>\n+                            </div>\n+                        </div>\n+                    <% }) %>\n+                    </div>\n+                </div>\n+            </div>\n+\n+            <div id="rimonthlyinterval" class="rifield row">\n+                <label class="col-4 col-form-label" for="rimonthlyinterval"><%= localization.monthlyInterval1 %></label>\n+                <div class="col-8">\n+                    <input class="form-control form-control-sm w-auto float-start me-3" type="text" size="2"\n+                        value="1"\n+                        name="rimonthlyinterval"/>\n+                    <%= localization.monthlyInterval2 %>\n+                </div>\n+            </div>\n+\n+            <div id="rimonthlyoptions" class="rifield row">\n+                <label class="col-4 col-form-label" for="rimonthlytype"><%= localization.monthlyRepeatOn %></label>\n+                <div class="col-8">\n+                    <div class="row">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="DAYOFMONTH"\n+                                    name="rimonthlytype"\n+                                    id="<%= name %>monthlytype:DAYOFMONTH" />\n+                                <label class="form-check-label" for="<%= name %>monthlytype:DAYOFMONTH">\n+                                    <%= localization.monthlyDayOfMonth1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto" name="rimonthlydayofmonthday" id="<%= name %>monthlydayofmonthday">\n+                                <% [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31].forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= val %></option>\n+                                <% }) %>\n+                            </select>\n+                        </div>\n+                        <div class="col-auto">\n+                            <%= localization.monthlyDayOfMonth2 %>\n+                        </div>\n+                    </div>\n+                    <div class="row">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="WEEKDAYOFMONTH"\n+                                    name="rimonthlytype"\n+                                    id="<%= name %>monthlytype:WEEKDAYOFMONTH" />\n+                                <label class="form-check-label" for="<%= name %>monthlytype:WEEKDAYOFMONTH">\n+                                    <%= localization.monthlyWeekdayOfMonth1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="rimonthlyweekdayofmonthindex">\n+                                <% orderIndexes.forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= localization.orderIndexes[idx] %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.monthlyWeekdayOfMonth2 %>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="rimonthlyweekdayofmonth">\n+                                <% orderedWeekdays.forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= localization.weekdays[idx] %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.monthlyWeekdayOfMonth3 %>\n+                        </div>\n+                    </div>\n+                </div>\n+            </div>\n+\n+            <div id="riyearlyinterval" class="rifield row">\n+                <label class="col-4 col-form-label" for="riyearlyinterval"><%= localization.yearlyInterval1 %></label>\n+                <div class="col-8">\n+                    <input class="form-control form-control-sm w-auto float-start me-3" type="text" size="2"\n+                        value="1"\n+                        name="riyearlyinterval"/>\n+                    <%= localization.yearlyInterval2 %>\n+                </div>\n+            </div>\n+\n+            <div id="riyearlyoptions" class="rifield row">\n+                <label class="col-4 col-form-label" for="riyearlyType"><%= localization.yearlyRepeatOn %></label>\n+                <div class="col-8">\n+                    <div class="row">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="DAYOFMONTH"\n+                                    name="riyearlyType"\n+                                    id="<%= name %>yearlytype:DAYOFMONTH" />\n+                                <label class="form-check-label" for="<%= name %>yearlytype:DAYOFMONTH">\n+                                    <%= localization.yearlyDayOfMonth1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlydayofmonthmonth">\n+                            <% localization.months.forEach(function(val, idx) { %>\n+                                <option value="<%= idx + 1 %>"><%= val %></option>\n+                            <% }) %>\n+                            </select>\n+                            <%= localization.yearlyDayOfMonth2 %>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlydayofmonthday">\n+                                <% [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31].forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= val %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.yearlyDayOfMonth3 %>\n+                        </div>\n+                    </div>\n+\n+                    <div class="row">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="WEEKDAYOFMONTH"\n+                                    name="riyearlyType"\n+                                    id="<%= name %>yearlytype:WEEKDAYOFMONTH"/>\n+                                <label class="form-check-label" for="<%= name %>yearlytype:WEEKDAYOFMONTH">\n+                                    <%= localization.yearlyWeekdayOfMonth1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlyweekdayofmonthindex">\n+                                <% orderIndexes.forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= localization.orderIndexes[idx] %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.yearlyWeekdayOfMonth2 %>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlyweekdayofmonthday">\n+                                <% orderedWeekdays.forEach(function(val, idx) { %>\n+                                    <option value="<%= val %>"><%= localization.weekdays[idx] %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.yearlyWeekdayOfMonth3 %>\n+                        </div>\n+                        <div class="col-auto">\n+                            <select class="form-select form-select-sm w-auto float-start me-2" name="riyearlyweekdayofmonthmonth">\n+                                <% localization.months.forEach(function(val, idx) { %>\n+                                    <option value="<%= idx + 1 %>"><%= val %></option>\n+                                <% }) %>\n+                            </select>\n+                            <%= localization.yearlyWeekdayOfMonth4 %>\n+                        </div>\n+                    </div>\n+                </div>\n+            </div>\n+\n+            <div id="rirangeoptions" class="rifield row">\n+                <label class="col-4 col-form-label"><%= localization.range %></label>\n+                <div class="col-8 pt-2">\n+                    <% if(hasRepeatForeverButton) { %>\n+                    <div class="form-check">\n+                        <input\n+                            class="form-check-input"\n+                            type="radio"\n+                            value="NOENDDATE"\n+                            name="rirangetype"\n+                            id="<%= name %>rangetype:NOENDDATE"/>\n+                        <label class="form-check-label" for="<%= name %>rangetype:NOENDDATE">\n+                            <%= localization.rangeNoEnd %>\n+                        </label>\n+                    </div>\n+                    <% } %>\n+                    <div class="row mt-2">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    checked="checked"\n+                                    value="BYOCCURRENCES"\n+                                    name="rirangetype"\n+                                    id="<%= name %>rangetype:BYOCCURRENCES"/>\n+                                <label class="form-check-label" for="<%= name %>rangetype:BYOCCURRENCES">\n+                                    <%= localization.rangeByOccurrences1 %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <input\n+                                class="form-control form-control-sm w-auto float-start me-3" type="text" size="3"\n+                                value="7"\n+                                name="rirangebyoccurrencesvalue" />\n+                            <%= localization.rangeByOccurrences2 %>\n+                        </div>\n+                    </div>\n+                    <div class="row mt-2">\n+                        <div class="col-auto">\n+                            <div class="form-check">\n+                                <input\n+                                    class="form-check-input"\n+                                    type="radio"\n+                                    value="BYENDDATE"\n+                                    name="rirangetype"\n+                                    id="<%= name %>rangetype:BYENDDATE"/>\n+                                <label class="form-check-label" for="<%= name %>rangetype:BYENDDATE">\n+                                    <%= localization.rangeByEndDate %>\n+                                </label>\n+                            </div>\n+                        </div>\n+                        <div class="col-auto">\n+                            <input\n+                                class="form-control form-control-sm w-auto" type="date"\n+                                name="rirangebyenddatecalendar" />\n+                        </div>\n+                    </div>\n+                </div>\n+            </div>\n+        </div>\n+\n+        <div class="rioccurrencesactions">\n+            <div class="rioccurancesheader d-flex justify-content-between">\n+                <h6><strong><%= localization.preview %></strong></h6>\n+                <span class="refreshbutton action">\n+                    <a class="btn btn-sm btn-outline-secondary rirefreshbutton" href="#" title="<%= localization.refresh %>">\n+                        <%= icons.reload %>\n+                    </a>\n+                </span>\n+            </div>\n+        </div>\n+\n+        <div class="rioccurrences"></div>\n+\n+        <div class="rioccurrencesactions">\n+            <h6><strong><%= localization.addDate %></strong></h6>\n+            <div class="riaddoccurrence ">\n+                <div class="alert alert-danger d-none"></div>\n+                <div class="input-group">\n+                    <input class="form-control form-control-sm w-auto" type="date" name="adddate" id="adddate" />\n+                    <input class="btn btn-sm btn-success" type="button" name="addaction" id="addaction" value="<%= localization.add %>">\n+                </div>\n+            </div>\n+        </div>\n+\n+        <div class="ributtons">\n+            <button\n+                type="submit"\n+                class="btn btn-secondary me-2 ricancelbutton <%= ributtonExtraClass %>"><%= localization.cancel %></button>\n+            <button\n+                type="submit"\n+                class="btn btn-primary risavebutton <%= ributtonExtraClass %>"><%= localization.save %></button>\n+        </div>\n+    </form>\n+</div>\ndiff --git a/src/pat/recurrence/templates/occurrence.xml b/src/pat/recurrence/templates/occurrence.xml\nnew file mode 100644\nindex 000000000..23e972f00\n--- /dev/null\n+++ b/src/pat/recurrence/templates/occurrence.xml\n@@ -0,0 +1,44 @@\n+<div class="rioccurrences">\n+    <% occurrences.forEach(function(occurrence) { %>\n+        <div class="d-flex justify-content-between occurrence <%= occurrence.type %>">\n+            <span>\n+                <%= occurrence.formattedDate %>\n+                <% if(occurrence.type === "start") { %>\n+                    <span class="rlabel"><%= localization.recurrenceStart %></span>\n+                <% } %>\n+                <% if(occurrence.type === "rdate") { %>\n+                    <span class="rlabel"><%= localization.additionalDate %></span>\n+                <% } %>\n+            </span>\n+            <% if(!readOnly) { %>\n+                <span class="action">\n+                    <% if(occurrence.type === "rrule") { %>\n+                        <a date="<%= occurrence.date %>" href="#"\n+                           class="btn btn-sm btn-outline-secondary <%= occurrence.type %>" title="<%= localization.exclude %>">\n+                            <%= icons.exclude %>\n+                        </a>\n+                    <% } %>\n+                    <% if(occurrence.type === "rdate") { %>\n+                        <a date="<%= occurrence.date %>" href="#"\n+                           class="btn btn-sm btn-outline-secondary <%= occurrence.type %>" title="<%= localization.remove %>">\n+                            <%= icons.remove %>\n+                        </a>\n+                    <% } %>\n+                    <% if(occurrence.type === "exdate") { %>\n+                        <a date="<%= occurrence.date %>" href="#"\n+                           class="btn btn-sm btn-outline-secondary <%= occurrence.type %>" title="<%= localization.include %>">\n+                           <%= icons.include %>\n+                        </a>\n+                    <% } %>\n+                </span>\n+            <% } %>\n+        </div>\n+    <% }) %>\n+    <div class="batching">\n+        <% for(var index=0; index < batch.batches.length; index++) { %>\n+            <span <% if(index === batch.currentBatch) { %>class="current"<% } %>>\n+                <a href="#" start="<%= batch.batches[index][0] %>">[<%= batch.batches[index][0] %> - <%= batch.batches[index][1] %>]</a>\n+            </span>\n+        <% } %>\n+    </div>\n+</div>\ndiff --git a/yarn.lock b/yarn.lock\nindex 02ad721c7..4271dd862 100644\n--- a/yarn.lock\n+++ b/yarn.lock\n@@ -6709,13 +6709,7 @@ jquery.browser@0.1.0:\n   resolved "https://registry.yarnpkg.com/jquery.browser/-/jquery.browser-0.1.0.tgz#9c72a6095fd2814b44476ea8f716677b72a6a2bb"\n   integrity sha512-5GjtLzzEBzxs/nwSVpCbSdk0acssfKsP7Upp43zmdHVV1Vb6E9VayyqPAQlfLrTeZL3YSWocCbkOvKdAc2CN4g==\n \n-"jquery.recurrenceinput.js@git+https://github.com/collective/jquery.recurrenceinput.js.git#master":\n-  version "1.6.0"\n-  resolved "git+https://github.com/collective/jquery.recurrenceinput.js.git#deaec1116575d81698778f87d8c08f02487aadf9"\n-  dependencies:\n-    jquery ""\n-\n-jquery@, jquery@3.6.0, jquery@>=1.7, jquery@>=1.7.2, jquery@^3.6.0:\n+jquery@3.6.0, jquery@>=1.7, jquery@>=1.7.2, jquery@^3.6.0:\n   version "3.6.0"\n   resolved "https://registry.yarnpkg.com/jquery/-/jquery-3.6.0.tgz#c72a09f15c1bdce142f49dbf1170bdf8adac2470"\n   integrity sha512-JVzAR/AjBvVt2BmYhxRCSYysDsPcssdmTFnzyLEts9qNwmjmu4JTAMYubEfwVOSwpQ1I1sKKFcxhZCI2buerfw==\n'

