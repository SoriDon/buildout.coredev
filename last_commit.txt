Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-07-10T12:42:11+02:00
Author: Carsten Senger (csenger) <senger@rehfisch.de>
Commit: https://github.com/plone/plone.restapi/commit/515f946ea44db892598254cce44602d6abda7ff7

Fix @sharing POST when called on the plone site root #123

Files changed:
A news/123.bugfix
M src/plone/restapi/deserializer/local_roles.py
M src/plone/restapi/tests/test_content_local_roles.py

b'diff --git a/news/123.bugfix b/news/123.bugfix\nnew file mode 100644\nindex 00000000..8ee9211e\n--- /dev/null\n+++ b/news/123.bugfix\n@@ -0,0 +1,2 @@\n+Fix @sharing POST when called on the plone site root\n+[csenger]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/deserializer/local_roles.py b/src/plone/restapi/deserializer/local_roles.py\nindex 375eb062..86f0d65c 100644\n--- a/src/plone/restapi/deserializer/local_roles.py\n+++ b/src/plone/restapi/deserializer/local_roles.py\n@@ -3,6 +3,7 @@\n from plone.restapi.deserializer import json_body\n from plone.restapi.interfaces import IDeserializeFromJson\n from Products.CMFCore.interfaces import ICatalogAware\n+from Products.CMFPlone.interfaces import IPloneSiteRoot\n from zope.component import adapter\n from zope.component import getMultiAdapter\n from zope.event import notify\n@@ -54,7 +55,10 @@ def __call__(self):\n                 user["roles"] = roles_list\n             roles_reindex = sharing_view.update_role_settings(new_roles, reindex=False)\n \n-        if ICatalogAware(self.context) and (inherit_reindex or roles_reindex):\n+        # reindex object security\n+        can_reindex = (ICatalogAware(self.context, None) or\n+                       IPloneSiteRoot.providedBy(self.context))\n+        if can_reindex and (inherit_reindex or roles_reindex):\n             self.context.reindexObjectSecurity()\n             if LOCALROLES_MODIFIED_EVENT_AVAILABLE:\n                 notify(LocalrolesModifiedEvent(self.context, self.request))\ndiff --git a/src/plone/restapi/tests/test_content_local_roles.py b/src/plone/restapi/tests/test_content_local_roles.py\nindex 9e827929..a26e6f38 100644\n--- a/src/plone/restapi/tests/test_content_local_roles.py\n+++ b/src/plone/restapi/tests/test_content_local_roles.py\n@@ -311,6 +311,44 @@ def test_unset_local_roles_for_user(self):\n             ),\n         )\n \n+    def test_set_local_roles_on_site_root(self):\n+\n+        pas = getToolByName(self.portal, "acl_users")\n+        self.assertEqual(\n+            pas.getLocalRolesForDisplay(self.portal),\n+            (("admin", ("Owner",), "user", "admin"),),\n+        )\n+\n+        response = requests.post(\n+            self.portal.absolute_url() + "/@sharing",\n+            headers={"Accept": "application/json"},\n+            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),\n+            json={\n+                "entries": [\n+                    {\n+                        u"id": TEST_USER_ID,\n+                        u"roles": {\n+                            u"Contributor": False,\n+                            u"Editor": False,\n+                            u"Reader": True,\n+                            u"Reviewer": True,\n+                        },\n+                        u"type": u"user",\n+                    }\n+                ]\n+            },\n+        )\n+        transaction.commit()\n+\n+        self.assertEqual(response.status_code, 204)\n+        self.assertEqual(\n+            sorted_roles(pas.getLocalRolesForDisplay(self.portal)),\n+            [\n+                ["admin", ["Owner"], "user", "admin"],\n+                ["test-user", [u"Reader", u"Reviewer"], "user", u"test_user_1_"],\n+            ],\n+        )\n+\n     def test_get_local_roles_inherit_roles(self):\n         # __ac_local_roles_block__ specifies to block inheritance:\n         # https://docs.plone.org/develop/plone/security/local_roles.html\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-07-10T12:43:28+02:00
Author: Carsten Senger (csenger) <senger@rehfisch.de>
Commit: https://github.com/plone/plone.restapi/commit/5f25d9fba17fa2018a6c5ee9c5a5315899c825e1

Updated http-example for types expansion

Files changed:
M src/plone/restapi/tests/http-examples/content_get_folder.resp

b'diff --git a/src/plone/restapi/tests/http-examples/content_get_folder.resp b/src/plone/restapi/tests/http-examples/content_get_folder.resp\nindex 31f65fdd..2ae7b5c7 100644\n--- a/src/plone/restapi/tests/http-examples/content_get_folder.resp\n+++ b/src/plone/restapi/tests/http-examples/content_get_folder.resp\n@@ -12,6 +12,9 @@ Content-Type: application/json\n     "navigation": {\n       "@id": "http://localhost:55001/plone/folder/@navigation"\n     }, \n+    "types": {\n+      "@id": "http://localhost:55001/plone/folder/@types"\n+    }, \n     "workflow": {\n       "@id": "http://localhost:55001/plone/folder/@workflow"\n     }\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-07-10T13:08:52+02:00
Author: Carsten Senger (csenger) <senger@rehfisch.de>
Commit: https://github.com/plone/plone.restapi/commit/548a7ed4df948e8771d46d8094fcc404f353a777

Fix issue number in news file

Files changed:
A news/780.bugfix
D news/123.bugfix

b'diff --git a/news/123.bugfix b/news/780.bugfix\nsimilarity index 100%\nrename from news/123.bugfix\nrename to news/780.bugfix\n'

Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-07-10T16:37:34+02:00
Author: Timo Stollenwerk (tisto) <tisto@users.noreply.github.com>
Commit: https://github.com/plone/plone.restapi/commit/326c54875eb686e822107094f0d705b101d9efd2

Merge pull request #781 from plone/issue-123-sharing-on-site-root

sharing on site root

Files changed:
A news/780.bugfix
M src/plone/restapi/deserializer/local_roles.py
M src/plone/restapi/tests/http-examples/content_get_folder.resp
M src/plone/restapi/tests/test_content_local_roles.py

b'diff --git a/news/780.bugfix b/news/780.bugfix\nnew file mode 100644\nindex 00000000..8ee9211e\n--- /dev/null\n+++ b/news/780.bugfix\n@@ -0,0 +1,2 @@\n+Fix @sharing POST when called on the plone site root\n+[csenger]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/deserializer/local_roles.py b/src/plone/restapi/deserializer/local_roles.py\nindex 375eb062..86f0d65c 100644\n--- a/src/plone/restapi/deserializer/local_roles.py\n+++ b/src/plone/restapi/deserializer/local_roles.py\n@@ -3,6 +3,7 @@\n from plone.restapi.deserializer import json_body\n from plone.restapi.interfaces import IDeserializeFromJson\n from Products.CMFCore.interfaces import ICatalogAware\n+from Products.CMFPlone.interfaces import IPloneSiteRoot\n from zope.component import adapter\n from zope.component import getMultiAdapter\n from zope.event import notify\n@@ -54,7 +55,10 @@ def __call__(self):\n                 user["roles"] = roles_list\n             roles_reindex = sharing_view.update_role_settings(new_roles, reindex=False)\n \n-        if ICatalogAware(self.context) and (inherit_reindex or roles_reindex):\n+        # reindex object security\n+        can_reindex = (ICatalogAware(self.context, None) or\n+                       IPloneSiteRoot.providedBy(self.context))\n+        if can_reindex and (inherit_reindex or roles_reindex):\n             self.context.reindexObjectSecurity()\n             if LOCALROLES_MODIFIED_EVENT_AVAILABLE:\n                 notify(LocalrolesModifiedEvent(self.context, self.request))\ndiff --git a/src/plone/restapi/tests/http-examples/content_get_folder.resp b/src/plone/restapi/tests/http-examples/content_get_folder.resp\nindex 31f65fdd..2ae7b5c7 100644\n--- a/src/plone/restapi/tests/http-examples/content_get_folder.resp\n+++ b/src/plone/restapi/tests/http-examples/content_get_folder.resp\n@@ -12,6 +12,9 @@ Content-Type: application/json\n     "navigation": {\n       "@id": "http://localhost:55001/plone/folder/@navigation"\n     }, \n+    "types": {\n+      "@id": "http://localhost:55001/plone/folder/@types"\n+    }, \n     "workflow": {\n       "@id": "http://localhost:55001/plone/folder/@workflow"\n     }\ndiff --git a/src/plone/restapi/tests/test_content_local_roles.py b/src/plone/restapi/tests/test_content_local_roles.py\nindex 9e827929..a26e6f38 100644\n--- a/src/plone/restapi/tests/test_content_local_roles.py\n+++ b/src/plone/restapi/tests/test_content_local_roles.py\n@@ -311,6 +311,44 @@ def test_unset_local_roles_for_user(self):\n             ),\n         )\n \n+    def test_set_local_roles_on_site_root(self):\n+\n+        pas = getToolByName(self.portal, "acl_users")\n+        self.assertEqual(\n+            pas.getLocalRolesForDisplay(self.portal),\n+            (("admin", ("Owner",), "user", "admin"),),\n+        )\n+\n+        response = requests.post(\n+            self.portal.absolute_url() + "/@sharing",\n+            headers={"Accept": "application/json"},\n+            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),\n+            json={\n+                "entries": [\n+                    {\n+                        u"id": TEST_USER_ID,\n+                        u"roles": {\n+                            u"Contributor": False,\n+                            u"Editor": False,\n+                            u"Reader": True,\n+                            u"Reviewer": True,\n+                        },\n+                        u"type": u"user",\n+                    }\n+                ]\n+            },\n+        )\n+        transaction.commit()\n+\n+        self.assertEqual(response.status_code, 204)\n+        self.assertEqual(\n+            sorted_roles(pas.getLocalRolesForDisplay(self.portal)),\n+            [\n+                ["admin", ["Owner"], "user", "admin"],\n+                ["test-user", [u"Reader", u"Reviewer"], "user", u"test_user_1_"],\n+            ],\n+        )\n+\n     def test_get_local_roles_inherit_roles(self):\n         # __ac_local_roles_block__ specifies to block inheritance:\n         # https://docs.plone.org/develop/plone/security/local_roles.html\n'

