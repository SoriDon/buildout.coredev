Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2017-09-27T09:32:21+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/322ae669eafc6036e2b0dd32409488a7ff077d7b

Use post_handler instead of import_steps

Files changed:
M CHANGES.rst
M plone/app/contenttypes/profiles.zcml
M plone/app/contenttypes/setuphandlers.py
D plone/app/contenttypes/profiles/content/import_steps.xml
D plone/app/contenttypes/profiles/content/plone.app.contenttypes_content.txt
D plone/app/contenttypes/profiles/default/import_steps.xml
D plone/app/contenttypes/profiles/default/plone.app.contenttypes_default.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index b8ad5084..2be6d445 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Use post_handler instead of import_steps.
+  [pbauer]
 
 Bug fixes:
 
diff --git a/plone/app/contenttypes/profiles.zcml b/plone/app/contenttypes/profiles.zcml
index 886bd84c..e1b837a8 100644
--- a/plone/app/contenttypes/profiles.zcml
+++ b/plone/app/contenttypes/profiles.zcml
@@ -9,6 +9,7 @@
     directory="profiles/content"
     description="Plone default content-types (plone.app.contenttypes)"
     provides="Products.GenericSetup.interfaces.EXTENSION"
+    post_handler=".setuphandlers.step_import_content"
     />
 
   <!-- All types, no sample content. -->
@@ -18,6 +19,7 @@
     directory="profiles/default"
     description="Plone default content-types (plone.app.contenttypes)"
     provides="Products.GenericSetup.interfaces.EXTENSION"
+    post_handler=".setuphandlers.step_setup_various"
     />
 
   <!-- Uninstall -->
diff --git a/plone/app/contenttypes/profiles/content/import_steps.xml b/plone/app/contenttypes/profiles/content/import_steps.xml
deleted file mode 100644
index 6444e632..00000000
--- a/plone/app/contenttypes/profiles/content/import_steps.xml
+++ /dev/null
@@ -1,9 +0,0 @@
-<?xml version="1.0"?>
-<import-steps>
- <import-step id="plone.app.contenttypes--plone-content" version="20111108-01"
-              handler="plone.app.contenttypes.setuphandlers.step_import_content"
-              title="plone.app.contenttypes base content-types">
-    plone.app.contenttypes plone-content installation step.
-    <dependency step="typeinfo" />
- </import-step>
-</import-steps>
diff --git a/plone/app/contenttypes/profiles/content/plone.app.contenttypes_content.txt b/plone/app/contenttypes/profiles/content/plone.app.contenttypes_content.txt
deleted file mode 100644
index 7d1c434a..00000000
--- a/plone/app/contenttypes/profiles/content/plone.app.contenttypes_content.txt
+++ /dev/null
@@ -1 +0,0 @@
-This file is used as a marker in setuphandlers.py.
diff --git a/plone/app/contenttypes/profiles/default/import_steps.xml b/plone/app/contenttypes/profiles/default/import_steps.xml
deleted file mode 100644
index e1227b4c..00000000
--- a/plone/app/contenttypes/profiles/default/import_steps.xml
+++ /dev/null
@@ -1,9 +0,0 @@
-<?xml version="1.0"?>
-<import-steps>
- <import-step id="plone.app.contenttypes" version="20140210-01"
-              handler="plone.app.contenttypes.setuphandlers.step_setup_various"
-              title="plone.app.contenttypes base content-types">
-  <dependency step="typeinfo"/>
-    plone.app.contenttypes installation step.
- </import-step>
-</import-steps>
diff --git a/plone/app/contenttypes/profiles/default/plone.app.contenttypes_default.txt b/plone/app/contenttypes/profiles/default/plone.app.contenttypes_default.txt
deleted file mode 100644
index 7d1c434a..00000000
--- a/plone/app/contenttypes/profiles/default/plone.app.contenttypes_default.txt
+++ /dev/null
@@ -1 +0,0 @@
-This file is used as a marker in setuphandlers.py.
diff --git a/plone/app/contenttypes/setuphandlers.py b/plone/app/contenttypes/setuphandlers.py
index 0cdef2e4..6b80966b 100644
--- a/plone/app/contenttypes/setuphandlers.py
+++ b/plone/app/contenttypes/setuphandlers.py
@@ -326,9 +326,7 @@ def configure_members_folder(portal, target_language):
 
 def step_import_content(context):
     """Create default content."""
-    if context.readDataFile('plone.app.contenttypes_content.txt') is None:
-        return
-    portal = context.getSite()
+    portal = context.__parent__
     target_language, is_combined_language, locale = _get_locales_info(portal)
     create_frontpage(portal, target_language)
     create_news_topic(portal, target_language)
@@ -337,9 +335,7 @@ def step_import_content(context):
 
 
 def step_setup_various(context):
-    if context.readDataFile('plone.app.contenttypes_default.txt') is None:
-        return
-    portal = context.getSite()
+    portal = context.__parent__
     target_language, is_combined_language, locale = _get_locales_info(portal)
     _setup_calendar(portal, locale)
     _setup_visible_ids(portal, target_language, locale)


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2017-09-27T11:46:41+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/c80d6f6005aa9052619d9f67daf3918fcb189372

Merge pull request #427 from plone/post_handler

Use post_handler instead of import_steps

Files changed:
M CHANGES.rst
M plone/app/contenttypes/profiles.zcml
M plone/app/contenttypes/setuphandlers.py
D plone/app/contenttypes/profiles/content/import_steps.xml
D plone/app/contenttypes/profiles/content/plone.app.contenttypes_content.txt
D plone/app/contenttypes/profiles/default/import_steps.xml
D plone/app/contenttypes/profiles/default/plone.app.contenttypes_default.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index b8ad5084..2be6d445 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Use post_handler instead of import_steps.
+  [pbauer]
 
 Bug fixes:
 
diff --git a/plone/app/contenttypes/profiles.zcml b/plone/app/contenttypes/profiles.zcml
index 886bd84c..e1b837a8 100644
--- a/plone/app/contenttypes/profiles.zcml
+++ b/plone/app/contenttypes/profiles.zcml
@@ -9,6 +9,7 @@
     directory="profiles/content"
     description="Plone default content-types (plone.app.contenttypes)"
     provides="Products.GenericSetup.interfaces.EXTENSION"
+    post_handler=".setuphandlers.step_import_content"
     />
 
   <!-- All types, no sample content. -->
@@ -18,6 +19,7 @@
     directory="profiles/default"
     description="Plone default content-types (plone.app.contenttypes)"
     provides="Products.GenericSetup.interfaces.EXTENSION"
+    post_handler=".setuphandlers.step_setup_various"
     />
 
   <!-- Uninstall -->
diff --git a/plone/app/contenttypes/profiles/content/import_steps.xml b/plone/app/contenttypes/profiles/content/import_steps.xml
deleted file mode 100644
index 6444e632..00000000
--- a/plone/app/contenttypes/profiles/content/import_steps.xml
+++ /dev/null
@@ -1,9 +0,0 @@
-<?xml version="1.0"?>
-<import-steps>
- <import-step id="plone.app.contenttypes--plone-content" version="20111108-01"
-              handler="plone.app.contenttypes.setuphandlers.step_import_content"
-              title="plone.app.contenttypes base content-types">
-    plone.app.contenttypes plone-content installation step.
-    <dependency step="typeinfo" />
- </import-step>
-</import-steps>
diff --git a/plone/app/contenttypes/profiles/content/plone.app.contenttypes_content.txt b/plone/app/contenttypes/profiles/content/plone.app.contenttypes_content.txt
deleted file mode 100644
index 7d1c434a..00000000
--- a/plone/app/contenttypes/profiles/content/plone.app.contenttypes_content.txt
+++ /dev/null
@@ -1 +0,0 @@
-This file is used as a marker in setuphandlers.py.
diff --git a/plone/app/contenttypes/profiles/default/import_steps.xml b/plone/app/contenttypes/profiles/default/import_steps.xml
deleted file mode 100644
index e1227b4c..00000000
--- a/plone/app/contenttypes/profiles/default/import_steps.xml
+++ /dev/null
@@ -1,9 +0,0 @@
-<?xml version="1.0"?>
-<import-steps>
- <import-step id="plone.app.contenttypes" version="20140210-01"
-              handler="plone.app.contenttypes.setuphandlers.step_setup_various"
-              title="plone.app.contenttypes base content-types">
-  <dependency step="typeinfo"/>
-    plone.app.contenttypes installation step.
- </import-step>
-</import-steps>
diff --git a/plone/app/contenttypes/profiles/default/plone.app.contenttypes_default.txt b/plone/app/contenttypes/profiles/default/plone.app.contenttypes_default.txt
deleted file mode 100644
index 7d1c434a..00000000
--- a/plone/app/contenttypes/profiles/default/plone.app.contenttypes_default.txt
+++ /dev/null
@@ -1 +0,0 @@
-This file is used as a marker in setuphandlers.py.
diff --git a/plone/app/contenttypes/setuphandlers.py b/plone/app/contenttypes/setuphandlers.py
index 0cdef2e4..6b80966b 100644
--- a/plone/app/contenttypes/setuphandlers.py
+++ b/plone/app/contenttypes/setuphandlers.py
@@ -326,9 +326,7 @@ def configure_members_folder(portal, target_language):
 
 def step_import_content(context):
     """Create default content."""
-    if context.readDataFile('plone.app.contenttypes_content.txt') is None:
-        return
-    portal = context.getSite()
+    portal = context.__parent__
     target_language, is_combined_language, locale = _get_locales_info(portal)
     create_frontpage(portal, target_language)
     create_news_topic(portal, target_language)
@@ -337,9 +335,7 @@ def step_import_content(context):
 
 
 def step_setup_various(context):
-    if context.readDataFile('plone.app.contenttypes_default.txt') is None:
-        return
-    portal = context.getSite()
+    portal = context.__parent__
     target_language, is_combined_language, locale = _get_locales_info(portal)
     _setup_calendar(portal, locale)
     _setup_visible_ids(portal, target_language, locale)


