Repository: plone.dexterity


Branch: refs/heads/master
Date: 2017-01-31T13:02:35+01:00
Author: Matthew Wilkes (MatthewWilkes) <git@matthewwilkes.name>
Commit: https://github.com/plone/plone.dexterity/commit/a5e42fc38840d7d549619968929b5f68b0647050

Ensure site_manager is acquisition-unwrapped when unregistering an FTI, to fix caching of component roots in Zope.

Files changed:
M CHANGES.rst
M plone/dexterity/fti.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3e73499..2020716 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -17,7 +17,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- When unregistering FTIs, ensure that the component registry does not have
+  an acquisition wrapper, to allow caching of the registry in zope.interface.
+  [MatthewWilkes]
 
 
 2.4.5 (2016-11-19)
diff --git a/plone/dexterity/fti.py b/plone/dexterity/fti.py
index 8f87db2..132565a 100644
--- a/plone/dexterity/fti.py
+++ b/plone/dexterity/fti.py
@@ -428,6 +428,8 @@ def unregister(fti, old_name=None):
 
     notify(SchemaInvalidatedEvent(portal_type))
 
+    # remove acquisition wrapper
+    site_manager = aq_base(site_manager)
     site_manager.unregisterUtility(provided=IDexterityFTI, name=portal_type)
     unregister_factory(fti.factory, site_manager)
 


