Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2020-12-23T17:26:44-05:00
Author: ewohnlich (ewohnlich) <eric.wohnlich@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/491a1e20b1eb3e3638d9349bce8b96d9dab76298

fixes 3223. Site Administrator does not exist on Zope root so don't rely on assigning permissions to it there

Files changed:
A news/3223.bugfix
M Products/CMFPlone/controlpanel/permissions.zcml
M Products/CMFPlone/profiles/default/rolemap.xml

b'diff --git a/Products/CMFPlone/controlpanel/permissions.zcml b/Products/CMFPlone/controlpanel/permissions.zcml\nindex 7c128c1307..e3012f8828 100644\n--- a/Products/CMFPlone/controlpanel/permissions.zcml\n+++ b/Products/CMFPlone/controlpanel/permissions.zcml\n@@ -2,81 +2,42 @@\n     xmlns="http://namespaces.zope.org/zope">\n \n   <permission id="plone.app.controlpanel.Overview"\n-              title="Plone Site Setup: Overview">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Overview"/>\n \n   <permission id="plone.app.controlpanel.Editing"\n-              title="Plone Site Setup: Editing">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Editing"/>\n \n   <permission id="plone.app.controlpanel.Filtering"\n-              title="Plone Site Setup: Filtering">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Filtering"/>\n \n   <permission id="plone.app.controlpanel.Language"\n-              title="Plone Site Setup: Language">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Language"/>\n \n   <permission id="plone.app.controlpanel.Mail"\n-              title="Plone Site Setup: Mail">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Mail"/>\n \n   <permission id="plone.app.controlpanel.Markup"\n-              title="Plone Site Setup: Markup">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Markup"/>\n \n   <permission id="plone.app.controlpanel.Navigation"\n-              title="Plone Site Setup: Navigation">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Navigation"/>\n \n   <permission id="plone.app.controlpanel.Search"\n-              title="Plone Site Setup: Search">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Search"/>\n \n   <permission id="plone.app.controlpanel.Security"\n-              title="Plone Site Setup: Security">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Security"/>\n \n   <permission id="plone.app.controlpanel.Site"\n-              title="Plone Site Setup: Site">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Site"/>\n \n   <permission id="plone.app.controlpanel.Themes"\n-              title="Plone Site Setup: Themes">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Themes"/>\n \n   <permission id="plone.app.controlpanel.Types"\n-              title="Plone Site Setup: Types">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Types"/>\n \n   <permission id="plone.app.controlpanel.UsersAndGroups"\n-              title="Plone Site Setup: Users and Groups">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+              title="Plone Site Setup: Users and Groups"/>\n \n </configure>\ndiff --git a/Products/CMFPlone/profiles/default/rolemap.xml b/Products/CMFPlone/profiles/default/rolemap.xml\nindex 04c4a47979..58722b1fd5 100644\n--- a/Products/CMFPlone/profiles/default/rolemap.xml\n+++ b/Products/CMFPlone/profiles/default/rolemap.xml\n@@ -8,9 +8,9 @@\n     <role name="Member"/>\n     <role name="Owner"/>\n     <role name="Reviewer"/>\n-    <role name="Reader" />\n-    <role name="Editor" />\n-    <role name="Contributor" />\n+    <role name="Reader"/>\n+    <role name="Editor"/>\n+    <role name="Contributor"/>\n   </roles>\n   <permissions>\n     <permission name="Access inactive portal content"\n@@ -56,9 +56,9 @@\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n       <role name="Owner"/>\n-      <role name="Reviewer" />\n-      <role name="Editor" />\n-      <role name="Contributor" />\n+      <role name="Reviewer"/>\n+      <role name="Editor"/>\n+      <role name="Contributor"/>\n     </permission>\n     <permission name="List portal members" acquire="True">\n       <role name="Manager"/>\n@@ -86,6 +86,58 @@\n       <role name="Owner"/>\n       <role name="Editor"/>\n     </permission>\n+    <permission name="Plone Site Setup: Overview" acquire="True">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Editing">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Filtering">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Language">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Mail">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Markup">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Navigation">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Search">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Security">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Site">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Themes">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Types">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n+    <permission name="Plone Site Setup: Users and Groups">\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+    </permission>\n     <permission name="Request review" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n@@ -170,33 +222,33 @@\n     </permission>\n     <permission name="View"\n                 acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Reader" />\n-        <role name="Editor" />\n-        <role name="Contributor" />\n+      <role name="Site Administrator"/>\n+      <role name="Reader"/>\n+      <role name="Editor"/>\n+      <role name="Contributor"/>\n     </permission>\n     <permission name="Access contents information"\n                 acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Reader" />\n-        <role name="Editor" />\n-        <role name="Contributor" />\n+      <role name="Site Administrator"/>\n+      <role name="Reader"/>\n+      <role name="Editor"/>\n+      <role name="Contributor"/>\n     </permission>\n     <permission name="Modify portal content"\n                 acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Editor" />\n-        <role name="Owner" />\n+      <role name="Site Administrator"/>\n+      <role name="Editor"/>\n+      <role name="Owner"/>\n     </permission>\n     <permission name="Add portal member"\n                 acquire="False">\n-        <role name="Manager" />\n-        <role name="Site Administrator"/>\n-        <role name="Owner" />\n+      <role name="Manager"/>\n+      <role name="Site Administrator"/>\n+      <role name="Owner"/>\n     </permission>\n     <permission name="plone.resourceeditor: Manage Sources"\n                 acquire="False">\n-      <role name="Manager" />\n+      <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n     <permission name="Show Toolbar"\ndiff --git a/news/3223.bugfix b/news/3223.bugfix\nnew file mode 100644\nindex 0000000000..a9c5cbcb5c\n--- /dev/null\n+++ b/news/3223.bugfix\n@@ -0,0 +1,4 @@\n+Moved the assignment of Plone Site Setup permissions from zcml to GenericSetup\n+rolemap.xml. This assigns the permissions on site creation instead of Zope root\n+where the `Site Administrator` role does not actually exist\n+[ewohnlich]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-08-17T16:30:58+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/c54939b59763621b2846bca3fafd2d98ef59ad67

Merge branch 'master' into issue_3223

Files changed:
A .github/SECURITY.md
A Products/CMFPlone/browser/favicon.py
A Products/CMFPlone/browser/icons.py
A Products/CMFPlone/browser/static/favicon.ico
A Products/CMFPlone/browser/static/plone-logo.svg
A Products/CMFPlone/browser/templates/recently_modified.pt
A Products/CMFPlone/browser/templates/recently_published.pt
A Products/CMFPlone/browser/templates/test_rendering.pt
A Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt
A Products/CMFPlone/browser/templates/test_rendering_icons.pt
A Products/CMFPlone/browser/test_rendering.py
A Products/CMFPlone/controlpanel/browser/error_log_form.pt
A Products/CMFPlone/controlpanel/browser/error_log_form.py
A Products/CMFPlone/controlpanel/browser/error_log_show_entry.pt
A Products/CMFPlone/controlpanel/browser/prefsmaintemplate.pt
A Products/CMFPlone/controlpanel/browser/prefsmaintemplate.py
A Products/CMFPlone/controlpanel/browser/relations.py
A Products/CMFPlone/controlpanel/browser/relations_inspect.pt
A Products/CMFPlone/controlpanel/browser/relations_rebuild.pt
A Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py
A Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py
A Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py
A Products/CMFPlone/image_scales/__init__.py
A Products/CMFPlone/image_scales/adapters.py
A Products/CMFPlone/image_scales/configure.zcml
A Products/CMFPlone/image_scales/indexer.py
A Products/CMFPlone/image_scales/tests/__init__.py
A Products/CMFPlone/image_scales/tests/images.xml
A Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py
A Products/CMFPlone/relationhelper.py
A Products/CMFPlone/resources/utils.py
A Products/CMFPlone/resources/webresource.py
A Products/CMFPlone/tests/900.jpg
A Products/CMFPlone/tests/accesscontrol_direct.pt
A Products/CMFPlone/tests/accesscontrol_sm.pt
A Products/CMFPlone/tests/accesscontrol_via_dict.pt
A Products/CMFPlone/tests/accesscontrol_via_modules.pt
A Products/CMFPlone/tests/bad1.pt
A Products/CMFPlone/tests/bad2.pt
A Products/CMFPlone/tests/bad3.pt
A Products/CMFPlone/tests/configure.zcml
A Products/CMFPlone/tests/options_authenticator.pt
A Products/CMFPlone/tests/options_name.pt
A Products/CMFPlone/tests/options_underscore.pt
A Products/CMFPlone/tests/options_view_name.pt
A Products/CMFPlone/tests/robot/plone-logo.png
A Products/CMFPlone/tests/test_expressions.py
A Products/CMFPlone/tests/test_icons.py
A Products/CMFPlone/tests/view_name.pt
A docs/HISTORY.rst
A news/3382.bugfix
A news/3475.bugfix
A news/3536.bugfix
A news/3568.bugfix
A news/3581.bugfix
A news/3582.bugfix
A news/3584.bugfix
A news/3587.bugfix
A news/3605.bugfix
A news/6007.bugfix
M CHANGES.rst
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/MigrationTool.py
M Products/CMFPlone/PasswordResetTool.py
M Products/CMFPlone/PloneBaseTool.py
M Products/CMFPlone/PloneBatch.py
M Products/CMFPlone/PloneControlPanel.py
M Products/CMFPlone/PloneTool.py
M Products/CMFPlone/Portal.py
M Products/CMFPlone/PropertiesTool.py
M Products/CMFPlone/RegistrationTool.py
M Products/CMFPlone/TranslationServiceTool.py
M Products/CMFPlone/WorkflowTool.py
M Products/CMFPlone/__init__.py
M Products/CMFPlone/browser/admin.py
M Products/CMFPlone/browser/admin.zcml
M Products/CMFPlone/browser/atd.py
M Products/CMFPlone/browser/author.py
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/browser/contact_info.py
M Products/CMFPlone/browser/defaultpage.py
M Products/CMFPlone/browser/interfaces.py
M Products/CMFPlone/browser/login/configure.zcml
M Products/CMFPlone/browser/login/login.py
M Products/CMFPlone/browser/login/login_help.py
M Products/CMFPlone/browser/login/password_reset.py
M Products/CMFPlone/browser/login/templates/insufficient_privileges.pt
M Products/CMFPlone/browser/login/templates/login.pt
M Products/CMFPlone/browser/login/templates/login_failsafe.pt
M Products/CMFPlone/browser/login/templates/login_help.pt
M Products/CMFPlone/browser/login/templates/mail_password_form.pt
M Products/CMFPlone/browser/login/templates/mail_password_template.pt
M Products/CMFPlone/browser/login/templates/pwreset_form.pt
M Products/CMFPlone/browser/login/templates/registered_notify_template.pt
M Products/CMFPlone/browser/login/templates/subform_render.pt
M Products/CMFPlone/browser/main_template.py
M Products/CMFPlone/browser/navigation.py
M Products/CMFPlone/browser/navtree.py
M Products/CMFPlone/browser/ploneview.py
M Products/CMFPlone/browser/robots.py
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/browser/sendto.py
M Products/CMFPlone/browser/sitelogo.py
M Products/CMFPlone/browser/static/plone-admin-ui.css
M Products/CMFPlone/browser/syndication/adapters.py
M Products/CMFPlone/browser/syndication/configure.zcml
M Products/CMFPlone/browser/syndication/settings.py
M Products/CMFPlone/browser/syndication/tool.py
M Products/CMFPlone/browser/syndication/utils.py
M Products/CMFPlone/browser/syndication/views.py
M Products/CMFPlone/browser/templates/accessibility-info.pt
M Products/CMFPlone/browser/templates/ajax_main_template.pt
M Products/CMFPlone/browser/templates/author.pt
M Products/CMFPlone/browser/templates/colophon.pt
M Products/CMFPlone/browser/templates/description.pt
M Products/CMFPlone/browser/templates/error_message.pt
M Products/CMFPlone/browser/templates/footer.pt
M Products/CMFPlone/browser/templates/main_template.pt
M Products/CMFPlone/browser/templates/plone-addsite.pt
M Products/CMFPlone/browser/templates/plone-admin-logged-out.pt
M Products/CMFPlone/browser/templates/plone-frontpage.pt
M Products/CMFPlone/browser/templates/plone-overview.pt
M Products/CMFPlone/browser/templates/plone-upgrade.pt
M Products/CMFPlone/browser/templates/search.pt
M Products/CMFPlone/browser/templates/title.pt
M Products/CMFPlone/catalog.zcml
M Products/CMFPlone/configure.zcml
M Products/CMFPlone/controlpanel/README.rst
M Products/CMFPlone/controlpanel/bbb/editing.py
M Products/CMFPlone/controlpanel/bbb/filter.py
M Products/CMFPlone/controlpanel/bbb/language.py
M Products/CMFPlone/controlpanel/bbb/mail.py
M Products/CMFPlone/controlpanel/bbb/maintenance.py
M Products/CMFPlone/controlpanel/bbb/markup.py
M Products/CMFPlone/controlpanel/bbb/navigation.py
M Products/CMFPlone/controlpanel/bbb/search.py
M Products/CMFPlone/controlpanel/bbb/security.py
M Products/CMFPlone/controlpanel/bbb/site.py
M Products/CMFPlone/controlpanel/bbb/usergroups.py
M Products/CMFPlone/controlpanel/browser/actions.pt
M Products/CMFPlone/controlpanel/browser/actions.py
M Products/CMFPlone/controlpanel/browser/configure.zcml
M Products/CMFPlone/controlpanel/browser/controlpanel_usergroups_layout.pt
M Products/CMFPlone/controlpanel/browser/dateandtime.py
M Products/CMFPlone/controlpanel/browser/editing.py
M Products/CMFPlone/controlpanel/browser/emaillogin.pt
M Products/CMFPlone/controlpanel/browser/filter.py
M Products/CMFPlone/controlpanel/browser/filter_controlpanel.pt
M Products/CMFPlone/controlpanel/browser/imaging.py
M Products/CMFPlone/controlpanel/browser/mail.py
M Products/CMFPlone/controlpanel/browser/maintenance.pt
M Products/CMFPlone/controlpanel/browser/maintenance.py
M Products/CMFPlone/controlpanel/browser/markup.py
M Products/CMFPlone/controlpanel/browser/navigation.py
M Products/CMFPlone/controlpanel/browser/overview.pt
M Products/CMFPlone/controlpanel/browser/overview.py
M Products/CMFPlone/controlpanel/browser/quickinstaller.pt
M Products/CMFPlone/controlpanel/browser/quickinstaller.py
M Products/CMFPlone/controlpanel/browser/redirects-controlpanel.pt
M Products/CMFPlone/controlpanel/browser/redirects-manage.pt
M Products/CMFPlone/controlpanel/browser/redirects.py
M Products/CMFPlone/controlpanel/browser/resourceregistry.pt
M Products/CMFPlone/controlpanel/browser/resourceregistry.py
M Products/CMFPlone/controlpanel/browser/search.py
M Products/CMFPlone/controlpanel/browser/security.py
M Products/CMFPlone/controlpanel/browser/site.py
M Products/CMFPlone/controlpanel/browser/socialmedia.py
M Products/CMFPlone/controlpanel/browser/syndication.py
M Products/CMFPlone/controlpanel/browser/tinymce.py
M Products/CMFPlone/controlpanel/browser/types.pt
M Products/CMFPlone/controlpanel/browser/types.py
M Products/CMFPlone/controlpanel/browser/usergroups.py
M Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.pt
M Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt
M Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt
M Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt
M Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt
M Products/CMFPlone/controlpanel/configure.zcml
M Products/CMFPlone/controlpanel/events.py
M Products/CMFPlone/controlpanel/permissions.zcml
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_installer.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py
M Products/CMFPlone/controlpanel/tests/test_upgrades1.zcml
M Products/CMFPlone/controlpanel/tests/test_upgrades2.zcml
M Products/CMFPlone/defaultpage.py
M Products/CMFPlone/events.py
M Products/CMFPlone/exportimport/configure.zcml
M Products/CMFPlone/exportimport/controlpanel.py
M Products/CMFPlone/exportimport/propertiestool.py
M Products/CMFPlone/exportimport/tests/testControlPanel.py
M Products/CMFPlone/exportimport/tests/testPropertiesTool.py
M Products/CMFPlone/factory.py
M Products/CMFPlone/i18nl10n.py
M Products/CMFPlone/interfaces/__init__.py
M Products/CMFPlone/interfaces/atd.py
M Products/CMFPlone/interfaces/basetool.py
M Products/CMFPlone/interfaces/breadcrumbs.py
M Products/CMFPlone/interfaces/constrains.py
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/interfaces/defaultpage.py
M Products/CMFPlone/interfaces/events.py
M Products/CMFPlone/interfaces/installable.py
M Products/CMFPlone/interfaces/interface.py
M Products/CMFPlone/interfaces/language.py
M Products/CMFPlone/interfaces/login.py
M Products/CMFPlone/interfaces/migration.py
M Products/CMFPlone/interfaces/password_reset.py
M Products/CMFPlone/interfaces/patterns.py
M Products/CMFPlone/interfaces/properties.py
M Products/CMFPlone/interfaces/resources.py
M Products/CMFPlone/interfaces/siteroot.py
M Products/CMFPlone/interfaces/structure.py
M Products/CMFPlone/interfaces/syndication.py
M Products/CMFPlone/interfaces/translationservice.py
M Products/CMFPlone/log.py
M Products/CMFPlone/meta.zcml
M Products/CMFPlone/overrides.zcml
M Products/CMFPlone/patches/publishing.py
M Products/CMFPlone/patches/sendmail.py
M Products/CMFPlone/patterns/__init__.py
M Products/CMFPlone/patterns/configure.zcml
M Products/CMFPlone/patterns/settings.py
M Products/CMFPlone/patterns/tinymce.py
M Products/CMFPlone/patterns/utils.py
M Products/CMFPlone/patterns/view.py
M Products/CMFPlone/permissions.py
M Products/CMFPlone/profiles.zcml
M Products/CMFPlone/profiles/default/actions.xml
M Products/CMFPlone/profiles/default/catalog.xml
M Products/CMFPlone/profiles/default/controlpanel.xml
M Products/CMFPlone/profiles/default/metadata.xml
M Products/CMFPlone/profiles/default/skins.xml
M Products/CMFPlone/profiles/default/types.xml
M Products/CMFPlone/profiles/default/types/Plone_Site.xml
M Products/CMFPlone/profiles/default/viewlets.xml
M Products/CMFPlone/profiles/dependencies/metadata.xml
M Products/CMFPlone/profiles/dependencies/registry.xml
M Products/CMFPlone/resources/__init__.py
M Products/CMFPlone/resources/browser/combine.py
M Products/CMFPlone/resources/browser/configure.zcml
M Products/CMFPlone/resources/browser/resource.py
M Products/CMFPlone/setuphandlers.py
M Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py
M Products/CMFPlone/testing.py
M Products/CMFPlone/tests/base_tag_not_present.txt
M Products/CMFPlone/tests/browser.txt
M Products/CMFPlone/tests/browser_collection_views.txt
M Products/CMFPlone/tests/csrf.txt
M Products/CMFPlone/tests/dummy.py
M Products/CMFPlone/tests/pwreset_browser.rst
M Products/CMFPlone/tests/robot/keywords.robot
M Products/CMFPlone/tests/robot/robodoc/README.rst
M Products/CMFPlone/tests/robot/robodoc/collaboration-advanced_control.robot
M Products/CMFPlone/tests/robot/robodoc/config-screens.robot
M Products/CMFPlone/tests/robot/robodoc/managing-working_copy.robot
M Products/CMFPlone/tests/robot/robodoc/managing_content.robot
M Products/CMFPlone/tests/robot/robodoc/working_with_tinymce.robot
M Products/CMFPlone/tests/robot/robot_setup.py
M Products/CMFPlone/tests/robot/test_actionmenu.robot
M Products/CMFPlone/tests/robot/test_controlpanel_actions.robot
M Products/CMFPlone/tests/robot/test_controlpanel_filter.robot
M Products/CMFPlone/tests/robot/test_controlpanel_language.robot
M Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
M Products/CMFPlone/tests/robot/test_controlpanel_search.robot
M Products/CMFPlone/tests/robot/test_controlpanel_security.robot
M Products/CMFPlone/tests/robot/test_controlpanel_site.robot
M Products/CMFPlone/tests/robot/test_controlpanel_social.robot
M Products/CMFPlone/tests/robot/test_controlpanel_types.robot
M Products/CMFPlone/tests/robot/test_controlpanel_usergroups.robot
M Products/CMFPlone/tests/robot/test_edit.robot
M Products/CMFPlone/tests/robot/test_edit_user_schema.robot
M Products/CMFPlone/tests/robot/test_folder_contents.robot
M Products/CMFPlone/tests/robot/test_linkintegrity.robot
M Products/CMFPlone/tests/robot/test_livesearch.robot
M Products/CMFPlone/tests/robot/test_overlays.robot
M Products/CMFPlone/tests/robot/test_portlets.robot
M Products/CMFPlone/tests/robot/test_querystring.robot
M Products/CMFPlone/tests/robot/test_tinymce.robot
M Products/CMFPlone/tests/testActionsTool.py
M Products/CMFPlone/tests/testBatch.py
M Products/CMFPlone/tests/testBrowserDefault.py
M Products/CMFPlone/tests/testCatalogTool.py
M Products/CMFPlone/tests/testCheckId.py
M Products/CMFPlone/tests/testContentSecurity.py
M Products/CMFPlone/tests/testContentTypeScripts.py
M Products/CMFPlone/tests/testControlPanel.py
M Products/CMFPlone/tests/testControlPanelScripts.py
M Products/CMFPlone/tests/testCookieAuth.py
M Products/CMFPlone/tests/testEmailLogin.py
M Products/CMFPlone/tests/testIImagingSchema.py
M Products/CMFPlone/tests/testInterfaces.py
M Products/CMFPlone/tests/testNavTree.py
M Products/CMFPlone/tests/testNavigationView.py
M Products/CMFPlone/tests/testPloneTool.py
M Products/CMFPlone/tests/testPloneView.py
M Products/CMFPlone/tests/testPortalCreation.py
M Products/CMFPlone/tests/testQueryCatalog.py
M Products/CMFPlone/tests/testRegistrationTool.py
M Products/CMFPlone/tests/testResourceRegistries.py
M Products/CMFPlone/tests/testSearch.py
M Products/CMFPlone/tests/testSecurity.py
M Products/CMFPlone/tests/testSyndication.py
M Products/CMFPlone/tests/testURLTool.py
M Products/CMFPlone/tests/testWebDAV.py
M Products/CMFPlone/tests/test_defaultpage.py
M Products/CMFPlone/tests/test_doctests.py
M Products/CMFPlone/tests/test_factory.py
M Products/CMFPlone/tests/test_mails.py
M Products/CMFPlone/tests/test_patternsettings.py
M Products/CMFPlone/tests/test_redirect_after_login.py
M Products/CMFPlone/tests/test_robots_txt.py
M Products/CMFPlone/tests/test_safe_formatter.py
M Products/CMFPlone/tests/test_sitelogo.py
M Products/CMFPlone/tests/test_utils.py
M Products/CMFPlone/tests/test_zmi.py
M Products/CMFPlone/traversal.py
M Products/CMFPlone/utils.py
M Products/CMFPlone/workflow.py
M Products/CMFPlone/www/addPropertySheet.zpt
M README.rst
M setup.cfg
M setup.py
D .github/FUNDING.yml
D DEVELOPING_BUNDLES.rst
D Products/CMFPlone/DublinCore.py
D Products/CMFPlone/PloneFolder.py
D Products/CMFPlone/_compat.py
D Products/CMFPlone/browser/static/search.js
D Products/CMFPlone/deprecated.zcml
D Products/CMFPlone/meta-bbb.zcml
D Products/CMFPlone/profiles/dependencies/controlpanel.xml
D Products/CMFPlone/resources/browser/configjs.py
D Products/CMFPlone/resources/browser/cook.py
D Products/CMFPlone/resources/browser/interfaces.py
D Products/CMFPlone/resources/browser/mixins.py
D Products/CMFPlone/resources/browser/scripts.pt
D Products/CMFPlone/resources/browser/scripts.py
D Products/CMFPlone/resources/browser/styles.pt
D Products/CMFPlone/resources/browser/styles.py
D Products/CMFPlone/resources/bundle.py
D Products/CMFPlone/resources/exportimport/__init__.py
D Products/CMFPlone/resources/exportimport/bundles.py
D Products/CMFPlone/resources/exportimport/resourceregistry.py
D Products/CMFPlone/skins/plone_form_scripts/content_status_modify.cpy
D Products/CMFPlone/skins/plone_form_scripts/content_status_modify.cpy.metadata
D Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py
D Products/CMFPlone/skins/plone_form_scripts/validate_content_status_modify.vpy
D Products/CMFPlone/skins/plone_images/favicon.ico
D Products/CMFPlone/skins/plone_prefs/password_form.pt
D Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata
D Products/CMFPlone/skins/plone_prefs/plone_control_panel.pt
D Products/CMFPlone/skins/plone_prefs/plone_control_panel.pt.metadata
D Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt
D Products/CMFPlone/skins/plone_prefs/prefs_error_log_form.pt
D Products/CMFPlone/skins/plone_prefs/prefs_error_log_form.pt.metadata
D Products/CMFPlone/skins/plone_prefs/prefs_error_log_setProperties.py
D Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt
D Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt.metadata
D Products/CMFPlone/skins/plone_prefs/prefs_error_log_update.py
D Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt
D Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt.metadata
D Products/CMFPlone/skins/plone_templates/index_html.pt
D Products/CMFPlone/skins/plone_templates/index_html.pt.metadata
D Products/CMFPlone/skins/plone_templates/kss_generic_macros.pt
D Products/CMFPlone/skins/plone_templates/recently_modified.pt
D Products/CMFPlone/skins/plone_templates/recently_modified.pt.metadata
D Products/CMFPlone/skins/plone_templates/recently_published.pt
D Products/CMFPlone/skins/plone_templates/recently_published.pt.metadata
D Products/CMFPlone/skins/plone_templates/test_rendering.pt
D Products/CMFPlone/tests/messages.txt
D Products/CMFPlone/tests/robot/test_thememapper.robot
D Products/CMFPlone/tests/testCSSandJSRegistry.py
D Products/CMFPlone/tests/testContentPublishing.py
D Products/CMFPlone/tests/testPloneFolder.py
D Products/CMFPlone/tests/test_l18nl10n.py
D Products/CMFPlone/tests/test_metabundles.py
D docs/HISTORY.txt
D news/1775.breaking
D news/1924.bugfix
D news/3007.bugfix
D news/3021.bugfix.1
D news/3021.bugfix.2
D news/3032.bugfix
D news/3039.bugfix
D news/3041.breaking
D news/3057.breaking
D news/3084.feature
D news/3130.bugfix.1
D news/3130.bugfix.2
D news/3130.bugfix.3
D news/3175.bugfix
D news/3176.bugfix
D news/3178.bugfix
D news/3183.breaking.1
D news/3183.breaking.2
D news/3185.bugfix
D news/3195.bugfix
D news/3208.breaking
D news/3214.bugfix
D news/721.bugfix

b'diff --git a/.github/FUNDING.yml b/.github/FUNDING.yml\ndeleted file mode 100644\nindex 84f022c5ff..0000000000\n--- a/.github/FUNDING.yml\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-# These are supported funding model platforms\n-\n-custom: [\'https://plone.org/sponsors\']\ndiff --git a/.github/SECURITY.md b/.github/SECURITY.md\nnew file mode 100644\nindex 0000000000..368751c557\n--- /dev/null\n+++ b/.github/SECURITY.md\n@@ -0,0 +1,21 @@\n+# Security Policy\n+\n+The most up to date information about Plone security is on https://plone.org/security\n+\n+## Supported Versions\n+\n+For supported versions, see the [security update policy](https://plone.org/security/update-policy)\n+\n+The [release schedule](https://plone.org/download/release-schedule) also has helpful information.\n+\n+There may be hotfixes available to increase the security of your version of Plone. Please check the [available hotfixes](https://plone.org/security/hotfixes).\n+\n+## Reporting a Vulnerability\n+\n+Please do **NOT** create a public bug report if you think this may be a security issue.\n+Instead, please contact the Plone Security Team via email: security@plone.org.\n+See also https://plone.org/security/report\n+\n+Only bug reports submitted directly to the security team email will be treated as responsible disclosure.\n+Any offered for sale to third parties or submitted to public bug bounty programs will be treated as irresponsible public disclosure.\n+We will not confirm any submissions on third party platforms such as "huntr" or "hackerone" and do not give permission for those systems to accept reports on our behalf or to represent themselves as a conduit for vulnerability reports.\ndiff --git a/CHANGES.rst b/CHANGES.rst\nindex a3ae16923b..57fafe41c8 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -1,6 +1,6 @@\n .. This file should contain the changes for the last release only, which\n    will be included on the package\'s page on pypi. All older entries are\n-   kept in HISTORY.txt\n+   kept in docs/HISTORY.rst\n \n Changelog\n =========\n@@ -12,653 +12,478 @@ Changelog\n \n .. towncrier release notes start\n \n-5.2.2 (2020-08-16)\n-------------------\n-\n-Bug fixes:\n-\n-\n-- Release Plone 5.2.2 final.\n-  No changes with last release candidate, except that the versions will contain Products.isurlinportal 1.1.0 with a minor security hardening fix.\n-  [maurits] (#3510)\n-\n-\n-5.2.2rc3 (2020-08-16)\n----------------------\n-\n-Bug fixes:\n-\n-\n-- Return a Zope aware engine for page templates based on ``zope.pagetemplate`` instead of ``Products.PageTemplates``.\n-  Fixes possible problems with such templates, for example z3c.form ones, with Zope 4.4 and higher.\n-  See `issue 3141 <https://github.com/plone/Products.CMFPlone/issues/3141>`_.\n-  [maurits] (#3141)\n-- Depend on new package ``Products.isurlinportal``.\n-  This contains the ``isURLInPortal`` method that was split off from our ``URLTool``.\n-  See `issue 3150 <https://github.com/plone/Products.CMFPlone/issues/3150>`_.\n-  [maurits] (#3150)\n-- Redirection view: refactor our navigation root editing to a separate method ``edit_for_navigation_root``.\n-  Since Plone 5.2 the redirectiontool respects INavigationroot:\n-  with a manual redirect you cannot enter a path starting with ``/`` which \'escapes\' the NavigationRoot to the SiteRoot to link to another part of the Plone instance.\n-  This refactor makes it possible to override this method to return the redirection unchanged, brining back the pre Plone 5.2 behavior of the ``Products.RedirectionTool`` add-on.\n-  [maurits] (#3153)\n-- Control panel configlets: first check visibility, then check condition.\n-  Visibility is cheaper to check.\n-  Also fixes `bug 3154 <https://github.com/plone/Products.CMFPlone/issues/3154>`_.\n-  [maurits] (#3154)\n-\n-\n-5.2.2rc2 (2020-07-17)\n----------------------\n-\n-Bug fixes:\n+6.0.0b1 (2022-07-23)\n+--------------------\n \n+Breaking changes:\n \n-- Fix an issue in mail_password_template.pt in the message showing the ip to really try the request.REMOTE_ADDR variable if request.HTTP_X_FORWARDED_FOR is empty (when you\'re not behind apache or nginx).\n-  [vincentfretin] (#2949)\n-- mail_password form: Do not crash if the userid is not provided or the user doesn\'t have an email configured\n-  [frapell] (#3008)\n \n+- Removed our expressions patch.\n+  This was a patch to avoid some too strict checks by Zope / Products.PageTemplates.\n+  But in Plone 6 it should be fine to be stricter.\n+  The ``STRICT_TRAVERSE_CHECK`` environment variable is no longer read.\n+  [maurits] (#3567)\n \n-5.2.2rc1 (2020-06-28)\n----------------------\n \n New features:\n \n \n-- Image caption support\n-  Allow ``figcaption`` in rich text editor as a valid tag.\n-  Add registry setting for plone.image_caption outputfilter transform.\n-  [thet] (#2887)\n-- Add markdown extension settings to markup control panel.\n-  [thomasmassmann] (#3076)\n-- Insert virtual custom.css bundle into the header after diazo bundle.\n-  Only add this when custom css is set in the theming control panel.\n-  [MrTango] (#3086)\n+- Initially open accordions in resource registry. Hide via JS when no errors occur.\n+  [petschki] (#3560)\n+- Resource bundle dependency on multiple comma separated names.\n+  [petschki] (#3570)\n \n \n Bug fixes:\n \n \n-- Change control panel item sorting and sort them by title\n-  [erral] (#721)\n-- Update HTMLFilter settings to enable TinyMCE styling features. See #2329, #2482, #2535\n-  [petschki] (#2482)\n-- If \'tinymce-content-css\' option is missing in themes manifest.cfg prevent unnecessary loading of a css at nav_root_url while editing a page.  [krissik] (#2861)\n-- Redirect (when possible) also ajax requests and do not return an unuseful body\n-  [ale-rt] (#3014)\n-- Merge Hotfix20200121 Check of the strength of password could be skipped. (#3021)\n-- Merge Hotfix20200121: isURLInPortal could be tricked into accepting malicious links. (#3021)\n-- Improve tests for the workflow tool method listWFStatesByTitle (#3032)\n-- Fix index_html on PortalRoot: ReplaceableWrapper did not work.\n-  [jensens] (#3060)\n-- Allow accessing ``plone_view.patterns_settings``.\n-  This was no problem until now, but a newer ``Zope/zope.tales/Chameleon``  is rightly stricter.\n-  [maurits] (#3066)\n-- Fix Python 3.8 ``time.clock`` removal in CatalogTool [jensens] (#3082)\n-- Fixed TypeError when adding both a group and a user to a group.\n-  [maurits] (#3084)\n-- Make the resource registry scripts output more robust when a bundle resource is missing. This prevents\n-  breaking your whole Plone site and access to the resource registry control panel after inserting\n-  one missing resource.\n-  [fredvd] (#3096)\n-- Bugfix for #3103\n-  [petschki] (#3105)\n-- Fixed saving ignored exception types in Python 3.  [maurits] (#3115)\n-\n-\n-5.2.1 (2020-01-13)\n-------------------\n-\n-New features:\n+- Reduce dependencies in setup.py here, when already fulfilled in the packages where in use.\n+  [jensens] (#3572)\n+- Fix more plone.base related deprecation warnings.\n+  [jensens] (#3573)\n+- Fix adding/renaming resources TTW.\n+  [petschki] (#3574)\n+- More i18n fixes\n+  [erral] (#3575)\n+- Updated metadata version to 6006.\n+  [maurits] (#6006)\n \n \n-- Add plone.staticresources to list of addons which are automatically upgraded if upgrade steps are available.\n-  [thet] (#2976)\n-\n+6.0.0a6 (2022-06-27)\n+--------------------\n \n Bug fixes:\n \n \n-- fix creation of Plone site not adding default Dexterity content types if example content not explicitily selected by user.\n-  [ericof] (#1318)\n-- fix default value for email msgid\n-  [erral] (#2790)\n-- Fix: PasswordResetView::getErrors is called, this ensures password is validated through RegistrationTool before attempting to reset password.\n-  [nazrulword] (#2917)\n-- Breadcrumbs: consider hidden folders when creating urls [ksuess] (#2935)\n-- Add Collection to the default_page_types list\n-  [erral] (#2956)\n-- Fix localization of "Site setup" in some control panels [vincentfretin] (#2958)\n-- Fix TTW Bundle compilation broken.\n-  [thet] (#2969)\n-- Do not save type settings in "content-controlpanel" when switching between types.\n-  [cekk] (#2986)\n-- Correctly fire events when user autologin after the password has been reset.\n-  [ericof] (#2993)\n-\n+- Remove the use of f-strings for translations\n+  [erral] (#3564)\n+- Fix several i18n bugs\n+  [erral] (#3565)\n+- Fix tests for `image_scale` download url update.\n+  [petschki] (#3566)\n \n-5.2.0 (2019-07-10)\n-------------------\n \n-Bug fixes:\n+6.0.0a5 (2022-06-24)\n+--------------------\n \n+Breaking changes:\n \n-- Don\'t activate all sorting tabs when no sort option has been chosen.\n-  [gyst, rodfersou, jensens] (#1789)\n-- Fix test failures exposed in Python 3.8\n-  [pbauer] (#2903)\n \n+- Remove Archtypes specific ``isIDAutoGenerated`` helper.\n+  This was dead code not used anywhere in Plone 6.\n+  [jensens] (#3487)\n+- ``PloneFolder`` was once used with early Archetypes.\n+  This code is dead now and got removed.\n+  [jensens] (#3492)\n+- ``DublinCore.py`` was once used with Archetypes.\n+  This code is dead now and got removed.\n+  [jensens] (#3493)\n+- Move discussion Key to ``plone.app.discussion``.\n+  [jensens] (#3520)\n \n-5.2rc5 (2019-06-27)\n--------------------\n \n New features:\n \n \n-- Add support for Python 3.8 [pbauer] (#2896)\n+- Added customisable batch_size for redirects controlpanel\n+  [iulianpetchesi] (#1178)\n+- Add option to use TinyMCE in inline-mode.\n+  [pbauer] (#3465)\n+- Add image srcset\'s configuration to TinyMCE pattern settings [MrTango] (#3477)\n+- Add support for images in default search page.\n+  [agitator] (#3495)\n+- Enable auto include of styles to the TinyMCE formats menu. The file has to be named ``tinymce-formats.css`` and known by TinyMCE.\n+  [agitator] (#3510)\n+- Add ``image_scales`` to catalog metadata.\n+  [cekk, maurits] (#3521)\n+- Sort addons by title\n+  [erral] (#3523)\n+- Show more information of broken relations\n+  [pbauer] (#3527)\n+- Show link to the Volto-migration (``@@migrate_to_volto``) in the view ``@@plone-upgrade`` when the option is available.\n+  [pbauer] (#3528)\n+- SVG image as default Plone logo.\n+  [petschki] (#3558)\n \n \n Bug fixes:\n \n \n-- Add missing i18n:translate calls\n-  [erral] (#2891)\n-- Fix login-help layout on mobile.\n-  [jensens] (#2893)\n-\n-\n-5.2rc4 (2019-06-20)\n--------------------\n-\n-New features:\n+- Make compatible with robotframework 3-5.\n+  [maurits] (#5)\n+- Explicitly include zcml of more packages.\n+  Reorder the zcml loading.\n+  Require ``plone.resource``.\n+  [maurits] (#3188)\n+- Remove date range search fix, which was done in Products.ZCatalog.\n+  [wesleybl] (#3432)\n+- fix `@@iconresolver` to resolve names with "/" correctly (eg. "contenttype/document")\n+  [petschki] (#3500)\n+- Bugfix: Resource viewlet cache took not enough factors into account (like base url).\n+  [jnsens] (#3503)\n+- Moved ``recently_modified`` and ``recently_published`` skin templates to browser views.\n+  [maurits] (#3515)\n+- Fix for quoted search terms\n+  [petschki] (#3517)\n+- Fix robot tests for updated toolbar\n+  [petschki] (#3522)\n+- Fix rendering viewlet.resourceregistries.js when there are missing resources.\n+  [petschki] (#3533)\n+- Fix tests for updated module federation bundles.\n+  [thet] (#3539)\n+- Remove modal from login and join action.\n+  [agitator] (#3555)\n+- Fix reporting of exceptions in Products.CMFPlone.factory.addPloneSite.\n+  [davisagli] (#3561)\n+- Updated metadata version to 6005.\n+  [maurits] (#6005)\n+\n+\n+6.0.0a4 (2022-04-08)\n+--------------------\n \n+Breaking changes:\n \n-- Remove verifydb, it was moved to standalone package zodbverify.\n-  [jensens] (#2858)\n \n+- PLIP 3211:\n \n-Bug fixes:\n+  - Remove RequireJS.\n+  - Remove default resource jQuery. It is added to the global namespace via the bundle.\n+  - Remove support for conditional comments in script and style tags.\n+    It\'s not supported since IE10.\n+    See: https://en.wikipedia.org/wiki/Conditional_comment\n \n+  [MrTango, thet] (#3247)\n+- Remove dependency on mockup. Mockup is now a npm package only and as such a dependency of plone.staticresources.\n+  [thet] (#3247)\n+- New resource registry to simplify CSS/JS registration.\n \n-- If specified in the registry, let the user autologin after the password has been reset (#2439)\n-- Allow empty ``default_page`` registry setting\n-  [petschki] (#2813)\n-- Always add ``data-default-sort`` attribute to search results.  [maurits] (#2854)\n-- Fix deprecation warnings.\n-  [jensens] (#2862)\n-- Use the shared \'Plone test setup\' and \'Plone test teardown\' keywords in Robot tests.\n-  [Rotonen] (#2864)\n-- Fix script resource parsing error because of self closing tags.\n-  [Netroxen] (#2870)\n+  - Completely (almost) rewritten ResourceRegistry based on the "webresource" project.\n+  - removed >1600LOC.\n+  - Sane dependency resolution using "webresource".\n+  - Only "bundles" are registered - support of "resources" and "bundle resources" is removed.\n+  - Some of the old bundle registry properties are deprecated and unused.\n+  - Removed TTW compilation of bundles via r.js and less.js.\n+  - Property ``merge_with`` is no longer needed in HTTP/2 times and merging here unsupported.\n+  - Unique key for delivery is based on hash of bundle file, ``last_compilation`` property is deprecated.\n+  - A new traverser ensures uniqueness.\n+  - Other related bundle properties are also deprecated.\n+  - Comes with new, server side generated control panel.\n \n+  [jensens] (#3325)\n+- Remove ``deprecated.zcml`` and ``meta-bbb.zcml``.\n+  [jensens, pbauer] (#3485)\n \n-5.2rc3 (2019-05-04)\n--------------------\n \n New features:\n \n \n-- Allow filtering on date and manual/automatic in redirection controlpanel. (#2799)\n-- Add a button to export the alternative urls in redirection controlpanel. (#2799)\n-- Add a button to remove all alternative urls that match the filter.\n-  See `issue 2799 <https://github.com/plone/Products.CMFPlone/issues/2799>`_.\n-  [maurits] (#2799)\n-\n-\n-Bug fixes:\n-\n-\n-- gracefully handle tracebacks during addon installation\n-  [petschki] (#2228)\n-- Add workaround for the case when a inifite recusion in a page-template that uses the main-template crashes the instance instead of raising a RecursionError.\n-  [pbauer, esteele] (#2666)\n-- Fixed unstable Markup Control Panel robot test again.  [maurits] (#2809)\n-- add a missing space in an error message in the redirects control panel and replace "deffered" by "deferred" [vincentfretin] (#2821)\n-- Fixes: Cooking resources with non ASCII resulted in encoding error.\n-  Further, writing legacy resources resulted in ValueError. [jensens] (#2827)\n-- restore ``exclude_from_nav`` combined with ``show_excluded_items`` handling\n-  [petschki] (#2828)\n-- Fix DeprecationWarning in syndication-view. [jensens] (#2831)\n-- Fix malformed url when redirecting to external login. [ericof] (#2842)\n-- Make navigation (CatalogNavigationTabs) subclassing easier. [iham] (#2849)\n+- PLIP #3279: Implement modern images scales. Add huge (1600px), great (1200px), larger (1000px), teaser (600px). Amend preview and mini (remove height constraint).\n+  [tisto] (#3279)\n+- Add TinyMCE template plugin to the plugins vocabulary [MrTango] (#3351)\n+- Implement `PLIP 3395 <https://github.com/plone/Products.CMFPlone/issue/3395>`_.\n+  Moves all interfaces, whole defaultpage, i18nl10, batch, permissions and parts of utils to ``plone.base``.\n+  For all imports are in place with deprecation warnings.\n+  Along with this a bunch of long deprecated functions, imports and similar in above packages were removed.\n+  [jensens] (#3395)\n+- Add TinyMCE alignment classes, to avoid style usage [MrTango] (#3440)\n+- Compatibility with z3c.form >= 4\n+  [petschki] (#3459)\n+- Added support for images in liveSearch results.\n+  [agitator] (#3489)\n \n \n-5.2rc2 (2019-03-21)\n--------------------\n-\n Bug fixes:\n \n \n-- Fix excluded items in navigation [ale-rt] (#2516)\n-- Add basic validators for the portal action controlpanel forms (#2689)\n-- Fix wrong msgids in link management control panel [erral] (#2788)\n-- Fix errors that abort the verification when debugging a DB with ./bin/instance verifydb -D.\n-  [pbauer] (#2792)\n-- Add summary of all errors when verifying a DB with ./bin/instance verifydb.\n-  [pbauer] (#2798)\n-- Fixed unstable SearchableText and Scenario Type querystring robot tests.  [maurits] (#2808)\n-- Fixed unstable Markup Control Panel and other robot tests.   [maurits] (#2809)\n-\n-\n-5.2rc1 (2019-03-04)\n--------------------\n+- Fixed evaluating expressions on resources, and especially loading ``plone.session`` resources.\n+  Fixes `plone.session issue 23 <https://github.com/plone/plone.session/issues/23>`_.\n+  [maurits] (#23)\n+- MigrationTool: use more standard ``listUpgrades`` code from GenericSetup 2.2.0.\n+  I ported our special logic there.\n+  [maurits] (#220)\n+- Handle /favicon.ico accesses on Plone sites. (#282)\n+- Fixed tests when run with ``zope.component`` 5+.\n+  [maurits] (#500)\n+- Remove Configlets, Change Member Password and Member Prefs not needed in Overview Controlpanel\n+  both Views available via User Control Panel\n+\n+  the deleton of "Change Member Password" Configlet remove also the issue #3031\n+  [1letter] (#3031)\n+- Removed no longer used ``password_form.pt`` and ``plone_change_password.py``.\n+  No longer register now empty skin layers ``plone_prefs`` and ``plone_form_scripts``.\n+  [maurits] (#3240)\n+- Fix TinyMCE configuration JSON serialization and cast entity_encoding to a list. (#3247)\n+- Make author template barceloneta/bs5 ready. Add some CSS classes to Markup.\n+  [1letter] (#3290)\n+- Use behavior-names instead of python-paths in types-controlpanel\n+  [pbauer] (#3294)\n+- Fix broken link in the RelationsInspectControlpanel\n+  prepend absolute portal url to links\n+  add RelationsControlPanelFunctionalTest\n+  [1letter] (#3322)\n+- Fix missing closing BODY tag in insufficient_privileges.pt\n+  [1letter] (#3374)\n+- Reorganize viewlets after removing the plone.header viewlet in plone.app.layout\n+  [erral] (#3416)\n+- Fix ``login-help`` validation\n+  [petschki] (#3422)\n+- Fix info message (char left over) in quickinstaller template\n+  [laulaz] (#3430)\n+- Fix overview-controlpanel view for Gunicorn WSGI HTTP Server.\n+  [bsuttor] (#3442)\n+- Fix detection of initial login time [MrTango] (#3447)\n+- Updated the list of core profiles that are upgraded during a Plone upgrade.\n+  Added ``Products.PlonePAS`` and ``plone.session``, and the optional ``plone.restapi`` and ``plone.volto``.\n+  [maurits] (#3453)\n+- Remove obsolete css files previously used in tinymce.\n+  [pbauer] (#3463)\n+- Add missing i18n:translate tags\n+  [erral] (#3467)\n+- Remove obsolte combine_bundles and related code.\n+  [pbauer] (#3468)\n+- Enhanced folder_contents robot tests\n+  [petschki] (#3478)\n+- Updated metadata version to 6004.\n+  [maurits] (#6004)\n+\n+\n+6.0.0a3 (2022-01-28)\n+--------------------\n \n New features:\n \n \n-- Views for title and description. [iham] (#2740)\n-- Display wsgi-state plus name and version of the server in the controlpanel\n-  [pbauer] (#2770)\n-- Enable dropdown-navigation for new sites by default. [pbauer] (#2772)\n+- add a new entry in site-controlpanel to change the favicon and its MIME-type\n+  The favicon can be a .ico/png or SVG-file\n+  [talarias] (plip-barceloneta_lts_favicon)\n+- The @@plone view exposes the human_readable_size helper\n+  [ale-rt] (#3146)\n+- Allow ``from warnings import warn`` and ``warn("message", DeprecationWarning)`` TTW, like in Python Scripts.\n+  [jensens] (#3376)\n+- Customize breadcrumbs hook ``customize_entry`` for subclasses (like already in global navigation).\n+  [jensens] (#3377)\n \n \n Bug fixes:\n \n \n-- Resolve circular dependency between `Products.CMFPlone` and `plone.i18n` by\n-  moving `ILanguageSchema` there. [sallner] (#2049)\n-- Use correct permission for mail controlpanel form so that Site Administrators\n-  can also edit. [fredvd] (#2688)\n-- Make linkintegrity robot test more reliable [MrTango] (#2752)\n-- Check only once if Products.ATContentTypes is available. [gforcada] (#2765)\n-- Fix redirection to `came_from` when url matches LOGIN_TEMPLATE_ID partly\n-  [petschki] (#2771)\n+- Cleanup Error Log Form after Review\n+  [jmevissen] (#3241)\n+- Removed management_page_charset support from usergroup-groupdetails page.\n+  This is related to deprecated unicode property types, like ustring.\n+  Part of `issue 3305 <https://github.com/plone/Products.CMFPlone/issues/3305>`_.\n+  [maurits] (#3305)\n+- Update Controlpanel Error Log Form Layout\n+  Rename ControlPanel Error Log Form View prefs_error_log_form -> error-log-form\n+  [jmevissen] (#3393)\n+- Use label_site_administration instead of label_site_admin in error and mail_password_form templates (#3397)\n+- Updated metadata version to 6003.  [maurits] (#6003)\n \n \n-5.2b1 (2019-02-13)\n-------------------\n+6.0.0a2 (2021-12-03)\n+--------------------\n \n Breaking changes:\n \n \n-- Factor out all static resources and the ``plone-compile-resources`` script\n-  into plone.staticresources. [thet] (#2542)\n+- PLIP 3339: Replace ``z3c.autoinclude`` with ``plone.autoinclude``.\n+  Note: ``includeDependencies`` is no longer supported.\n+  [maurits, tschorr] (#3339)\n \n \n New features:\n \n \n-- PLIP 1486: Merge Products.RedirectionTool into core. Allow users to manage\n-  redirects on their site and aliases to content. See\n-  https://github.com/plone/Products.CMFPlone/issues/1486 [staeff, maurits]\n-  (#1486)\n-- Added multilevel dropdown navigation [agitator] (#2516)\n-- No longer mark special links by default. [pbauer] (#2736)\n+- On Zope root, create Volto site by default.\n+  [maurits] (#3344)\n \n \n Bug fixes:\n \n \n-- Switched allowedRolesAndUsers indexer from \'View\' to the correct permission\n-  \'Access contents information\' for displaying metadata. \'View\' permission\n-  should be used on the item itself. The change should not matter for default\n-  Plone workflows, since they always use those permissions together. [agitator]\n-  (#260)\n-- deprecate catalog_get_all(catalog) in favor of catalog.getAllBrains()\n-  [pbauer] (#2258)\n-- Restore the possibility to sort catalog query results with multiple indexes\n-  (#2464)\n-- Review list portlet showed nothing to review with plone.app.multilingual, As\n-  WorkflowTool bypassed languages only for p.a.m<2.x or linguaplone. fixed and\n-  now compatible to both lang-bypassing methods. [iham] (#2595)\n-- Fixed fallback to default view when selected layout does not exist for\n-  Folder. [gbastien] (#2645)\n-- The patched init method for the class zope.sendmail.mailer.SMTPMailer has\n-  been updated, fixing a bug that was preventing to send emails. [ale-rt,\n-  nazrulworld] (#2665)\n-- a11y: Added role attribute for portalMessage [nzambello] (#2675)\n-- Fix several warnings shown when running tests on Python 3+. [gforcada]\n-  (#2683)\n-- fixed Python 3 related str decoding issue in breadcrumbs (#2694)\n-- Fixed unstable robot test Scenario: A page is opened to edit in TinyMCE.\n-  [maurits] (#2707)\n-\n-\n-5.2a2 (2018-12-30)\n-------------------\n-\n-New features:\n-\n-\n-- New robot tests for querystring in Collection type. Now almost all\n-  querystring types are robot tested. [llisa123] (#2489)\n-- Add ``load_async`` and ``load_defer`` attributes to resource registries\n-  bundle settings. When set, ``<script>`` tags are rendered with\n-  ``async="async"`` resp. ``defer="defer"`` attributes. You also need to empty\n-  the ``merge_with`` property of your bundle, because production bundles\n-  (``default.js`` and ``logged-in.js``) are never loaded with async or defer.\n-  The default.js includes jQuery and requirejs and those are needed at many\n-  places and therefore cannot be loaded asynchronously. Refs: #2649, #2657.\n-  [thet] (#2649)\n-\n+- Move prefs_error_log* from skins to browser views\n+  [jmevissen] (#3241)\n+- The Plone site root is cataloged (#3314)\n+- Fix #3323DX-Site-Root: ZMI Nav-Tree is no longer expandable.\n+  [jensens] (#3323)\n+- Fixes #3337:\n+  Remove dead code that wont work in Py 3 anyway if called (cmp).\n+  [jensens] (#3337)\n+- Remove DYNAMIC_CONTENT from translation files\n+  [erral] (#3342)\n+- Remove adapter for index location. [wesleybl] (#3347)\n+- Use document_view as default for site root.\n+  [agitator] (#3354)\n+- Add missing lxml dependency [MrTango] (#3356)\n+- Fixes #3352 - dependency indirection on plone.app.iterate [jensens] (#3357)\n+- In Portal: use security decorators\n+  [jensens] (#3366)\n+- Updated metadata version to 6002.  [maurits] (#6002)\n+\n+\n+6.0.0a1 (2021-10-22)\n+--------------------\n \n Bug fixes:\n \n \n-- Delete ``fa_ir.js``. Keep ```fa_IR.js``. [maurits] (#2620)\n-- Forward port TinyMCE fixes from 5.1 [vangheem] (#2630)\n-- Fix robot test test_edit_user_schema: Fieldname was set duplicate (first by\n-  JS, then by robot). [jensens] (#2669)\n-\n-5.2a1 (2018-11-08)\n-------------------\n-\n-Breaking changes:\n-\n-- Removed generateUniqueId.py skins script (after it was added to Products.Archetypes).\n-  This script is no longer available outside Archetypes world.\n-  #1801\n-  [jensens]\n+- Release Plone 6.0.0a1.\n+  No changes since previous release.\n+  [maurits] (#3341)\n \n-- Remove all dependencies on plone.app.controlpanel.\n-  Third party code need either to depend on plone.app.controlpanel 4.0,\n-  which is a backward compatibility package only, or also update to not depend on it anymore.\n-  [jensens]\n \n-- Removed check_id.py skin script.  Replaced with utils.check_id function.\n-  #1801 and #2582.\n-  [maurits]\n-\n-- Removed my_worklist.py skin script. #1801\n-  [reinhardt]\n-\n-- Removed getObjectsFromPathList.py skin script. #1801\n-  [reinhardt]\n-\n-- Removed isExpired.py skin script. #1801\n-  [reinhardt]\n-\n-- Removed redirectToReferrer.py skin script. #1801\n-  [tlotze]\n-\n-- Removed enableHTTPCompression.py skin script. #1801\n-  [tlotze]\n-\n-- Removed setAuthCookie.py skin script. #1801\n-  [tlotze]\n-\n-- Stop configuring \'View History\' permission which was removed from Zope.\n-  [davisagli]\n-\n-- Removed legacy resource registries portal_css and portal_javascripts;\n-  no conditional handling.\n-  [ksuess]\n-\n-New features:\n-\n-- Factored out human_readable_size method for replacing getObjSize.py;\n-  removed getObjSize.py. #1801\n-  [reinhardt]\n-\n-- Update TinyMCE to 4.7.13\n-  [erral]\n-\n-- New browser view based login code - merged from plone.login (credits to esteele, pbauer, agitator, jensens, et al).\n-  `portal_skins/plone_login` is now gone, see PLIP #2092.\n-  Also, password reset view moved to login subfolder to keep things together.\n-  Some testbrowser based tests needed changes because of z3c.form based login form .\n-  The Plone specific, rarely used cross site __ac cookie SSO feature/hack was removed.\n-  In case somebody needs this, please make it an addon package.\n-  Better use a field proven, more secure way, like OAuth2, Shibboleth or someting similar.\n-  [jensens, et al]\n-\n-- Upgrade grunt + plugins to same versions as in\n-  mockup https://github.com/plone/mockup/pull/870\n-  [sunew]\n-\n-- Upgrade less in bower.json to the same version as already used\n-  in the generated package.json in compile_resources.py.\n-  [sunew]\n-\n-- Add utility-method safe_nativestring.\n-  [pbauer]\n-\n-- Rename safe_unicode to safe_text and safe_encode to safe_bytes. Keep old aliases.\n-  [pbauer]\n-- Add a ``bin/instance verifydb`` command which can be used to check\n-  that all records in the database can be successfully loaded.\n-  This is intended to help with verifying a database conversion\n-  from Python 2 to Python 3.\n-  [davisagli]\n+6.0.0a1.dev1 (2021-10-16)\n+-------------------------\n \n Bug fixes:\n \n-- Modernize robot keywords that use "Get Element Attribute"\n-  [ale-rt]\n-\n-- remove plone.app.folder dependency\n-  [petschki]\n-\n-- move GopipIndex Class to plone.folder\n-  [petschki]\n-\n-- Fixed getObjSize indexer for Python 3. #2526\n-  [reinhardt]\n-- Fix toolbar menu on mobile #2333.\n-- make groups_modify_roles test more robust.\n-  [tschorr]\n-\n--- Fix wrong CSS property to allow correct word-break.\n-  [tmassman]\n \n- Fix toolbar menu on mobile #2333.\n-  [tmassman]\n+- Use HTML5 meta charset.\n+  [malthe] (#2025)\n+- add icon_expr to view/edit action for @@iconresolver\n+  [petschki] (#3327)\n+- Set the "Show excluded items" (``show_excluded_items``) to False per default.\n+  Setting it to ``True`` can introduce a performance problem.\n+  ``False`` should be the default, also from user expectation for the ``exclude_from_nav`` setting on content items.\n+  No upgrade step!\n+  Previous behavior is just kept, unless you override it manually.\n+  See: #3055, first comment.\n+  Use this registry snippet to set it false::\n+\n+      <?xml version="1.0"?>\n+      <registry>\n+        <records prefix="plone" interface="Products.CMFPlone.interfaces.controlpanel.INavigationSchema">\n+          <value key="show_excluded_items">False</value>\n+        </records>\n+      </registry>\n+\n+  Fixes: #3035\n+  [thet] (#3329)\n+- Remove typo in ajax_main_template\n+  [petschki] (#3333)\n+- Fix some template issues to have properly translated messages (#3334)\n+- Updated metadata version to 6001.\n+  [maurits] (#6001)\n+\n+\n+6.0.0a1.dev0 (2021-09-15)\n+-------------------------\n \n-- Removed the ``raiseUnauthorized`` skin script.\n-  If you use this, please do permission checking in your own Python code instead (likely in a browser view).\n-  Refs `issue 1801 <https://github.com/plone/Products.CMFPlone/issues/1801>`_.\n-  [maurits]\n-\n-- Remove the devdependencies from bower.json - they are just used for running tests in mockup, not here.\n-  [sunew]\n-\n-- Adapt tests to `Products.GenericSetup >= 2.0` thus requiring at least that\n-  version.\n-  [icemac]\n-\n-- Some tools from CMFCore are now utilities\n-  [pbauer]\n-\n-- Fix failing thememapper robot test after rebuild of thememapper bundle in p.a.theming PR 148\n-  [sunew]\n-\n-- Remove five.pt for Zope 4\n-  [jensens]\n-\n-- Changes for Zope 4 compatibility in maintenance controlpanel.\n-  [thet]\n-\n-- Render exceptions using an exception view instead of standard_error_message.\n-  [davisagli]\n-\n-- Remove old PlacelessTranslationService.\n-  [jensens, ksuess]\n-\n-- Fix controlpanel quickinstaller view:\n-  A not yet installed product must not return any upgrade info.\n-  [jensens]\n-\n-- Fix to make plone/plone.session#11 work:\n-  Make test for installation of  plone.session more explicit.\n-  [jensens]\n-\n-- Advanced Catalog Clear And Rebuild feature showed wrong processing time due to new queue processing.\n-  This was fixed bei calling ``processQueue()`` after indexing.\n-  [jensens]\n-\n-- Some nested `section id="edit-bar"` tag in folder_contents page #2322\n-  [terapyon]\n-\n-- Remove ``plone-generate-gruntfile`` (it is all available through ``plone-compile-resources``).\n-  [jensens]\n-\n-- Migrate from ``slimit`` to ``calmjs.parse`` for the JavaScript cooker #2616\n-  [metatoaster]\n-\n-\n-New Features:\n-\n-- Update to latest mockup\n-  [frapell]\n-\n-- Provide an utility ``dump_json_to_text`` that works both on Python 2.7 an Python 3.\n-  [ale-rt]\n-\n-- Prepare for Python 2 / 3 compatibility.\n-  [pbauer]\n-\n-- Fix imports to work with Python 3.\n-  [pbauer]\n-\n-- Mockup update.\n-  [thet]\n-\n-- add link to Plone.org VPAT accessibility statement\n-  [tkimnguyen]\n-\n-Bug Fixes:\n-\n-- Remove last legacy Javascript ``highlight-searchterms.js``.\n-  Removes also the skins folder ``plone_ecmascript``.\n-  It was broken for all (Google, other search engines, own live search);\n-  JS worked only when coming from Plone detailed search.\n-  [jensens]\n-\n-- Fix an undefined variable in a test helper function\n-  [ale-rt]\n-\n-- Let the ``combine-bundles`` import step also work when the ``IBundleRegistry`` keyword is not in ``registry.xml``, but in a ``registry`` directory.\n-  `Issue 2520 <https://github.com/plone/Products.CMFPlone/issues/2502>`_.\n-  [maurits]\n-\n-- Get rid of obsolete ``X-UA-Compatible`` header.\n-  [hvelarde]\n-\n-- Fix registration of ``robots.txt`` browser view to avoid ``AttributeError`` on Zope\'s root (fixes `#2052 <https://github.com/plone/Products.CMFPlone/issues/2052>`_).\n-  [hvelarde]\n-\n-- Get rid of obsolete ``X-UA-Compatible`` header.\n-  [hvelarde]\n-\n-- Add test for issue #2469.\n-  [jensens]\n-\n-- Fixed tests when IRichText behavior is used.\n-  IRichText -> IRichTextBehavior\n-  This is a follow up to `issue 476 <https://github.com/plone/plone.app.contenttypes/issues/476>`_.\n-  [iham]\n-\n-- Remove unused mail_password.py from skins/plone_scripts\n-  [agitator]\n-\n-- Hide ``plone.app.querystring`` from add-ons control panel.\n-  Fixes `issue 2426 <https://github.com/plone/Products.CMFPlone/issues/2426>`_.\n-  [maurits]\n-\n-- Fix tests after changes in disallowed object ids in Zope.\n-  [pbauer]\n-\n-- Do not include too new upgrades when upgrading Plone Site.\n-  Otherwise the Plone Site ends up at a newer version that the filesystem code supports,\n-  giving an error when upgrading, and resulting in possibly missed upgrades later.\n-  Fixes `issue 2377 <https://github.com/plone/Products.CMFPlone/issues/2377>`_.\n-  [maurits]\n-\n-- After site creation, do not render the add-site template: we redirect anyway.\n-  [maurits]\n-\n-- Unflakied a unit test.\n-  [Rotonen]\n-\n-- Do not show TinyMCE menu items with no subitems, Fixes #2245.\n-  [mrsaicharan1]\n-\n-- Fix Exception-View when main_template can\'t be rendered. Fixes #2325.\n-  [pbauer]\n-\n-- Render exceptions as text, not html to fix format of infos after traceback.\n-  Display as <pre> for basic and normal error templates.\n-  [pbauer]\n-\n-- Removed extra methods and tests for CMFQuickInstallerTool.\n-  Moved those to the Products.CMFQuickInstallerTool package.\n-  [maurits]\n-\n-- Added tests for add-ons control panel.\n-  Add a link to the Site Setup.\n-  Let ``get_product_version`` work when you call it with ``CMFPlacefulWorkflow`` too.\n-  [maurits]\n-\n-- Fix bad domain for translating password reset mails.\n-  [allusa]\n-\n-- Ignore invalid ``sort_on`` parameters in catalog ``searchResults``.\n-  Otherwise you get a ``CatalogError``.\n-  I get crazy sort_ons like \'194\' or \'null\'.\n-  [maurits]\n-\n-- Register the ``ExceptionView`` for the unspecific ``zope.interface.Interface`` for easier overloading.\n-  Fixes a problem, where plone.rest couldn\'t overload the ExceptionView with an adapter bound to ``plone.rest.interfaces.IAPIRequest``.\n-  [thet]\n-\n-- Fixed linkintegrity robot tests.  [maurits]\n-\n-- Fixed flaky actions controlpanel tests by waiting longer.  [maurits]\n-\n-- Require AccessControl 4.0b1 so ``guarded_getitem`` is used.\n-  Part of PloneHotfix20171128.  [maurits]\n-\n-- Improved isURLInPortal according to PloneHotfix20171128.\n-  Accept only http/https, and doubly check escaped urls.  [maurits]\n-\n-- Fix exception view when called on Zope-root. Fixes #2203.\n-  [pbauer]\n-\n-- added CSS hyphenation support for toolbar for avoiding ugly text wrapping\n-  Fixes `issue 723 <https://github.com/plone/Products.CMFPlone/issues/723>`_.\n-  [ajung]\n-\n-- Increase compatibility with Python3.\n-  [ale-rt]\n-\n-- Show example for expression in actions control panel.\n-  [maurits]\n-\n-- Fix test where you cannot instanciate a PythonScript with the id script.\n-  [pbauer]\n+Breaking changes:\n \n-- Set the status of an exception view according to the exception type.\n-  Fixes `issue 2187 <https://github.com/plone/Products.CMFPlone/issues/2187>`_.\n-  [maurits]\n \n-- Use absolute imports for Python3 compatibility\n-  [ale-rt]\n+- Removed our CMFQuickInstallerTool code completely.\n+  See `PLIP 1775 <https://github.com/plone/Products.CMFPlone/issues/1775>`_.\n+  [maurits] (#1775)\n+- Use Dexterity for the Plone Site root object.\n+  This is `PLIP 2454 <https://github.com/plone/Products.CMFPlone/issues/2454>`_.\n+  [jaroel, ale-rt] (#2454)\n+- Removed dependency on ``Products.TemporaryFolder``.\n+  Note: in your ``plone.recipe.zope2instance`` buildout part, you must set ``zodb-temporary-storage = off``,\n+  otherwise you get errors when starting Plone.\n+  See `issue 2957 <https://github.com/plone/Products.CMFPlone/issues/2957>`_.\n+  [maurits] (#2957)\n+- A part of "Drop Python 2 Support for Plone 6" #2812:\n+  Reflect dropping of Python 2 support in setup.py.\n+  Bump version to 6.0\n+  [jensens] (#3041)\n+- Removed ``folder_publish.cpy`` script.\n+  Replaced with folder_publish browser view in ``plone.app.content``.\n+  Removed deprecated transitionObjectsByPaths.\n+  [maurits] (#3057)\n+- Removed Products.CMFFormController dependency.\n+  [maurits] (#3057)\n+- Removed ``content_status_modify.cpy`` script and its validator ``validate_content_status_modify.vpy``.\n+  Replaced with ``content_status_modify`` browser view in ``plone.app.content``.\n+  [maurits] (#3057)\n+- Barceloneta LTS theming (#3061)\n+- Remove six at all places where used. [jensens] (#3183)\n+- Remove ``portal_utf8`` and it twin ``utf8_portal`` from ``utils`` and ``PloneTool`` since its never used nowhere. [jensens] (#3183)\n+- Remove `meta_type` index and metadata from catalog.\n+  Both were unused in Plone core and rarely used in addons.\n+  [jensens] (#3208)\n+- Plone 6 with markup update for Bootstrap.\n+  Extensive overhaul of Plone ui elements based on Bootstrap components.\n+  Introduction of icon resolver with use of icon_epr definitions.\n+  [1letter, agitator, ale-rt, balavec, ericof, erral, frapell, fredvd, fulv, gomez, jensens, krissik,\n+  mauritsvanrees,  mrtango, nilshofer, petschki, santonelli, thet, thomasmassmann, tkimngyuen,\n+  tschorr] (#3249)\n \n-- Fallback for missing date in DefaultDublinCoreImpl no longer relies on\n-  bobobase_modification_time.\n-  [pbauer]\n \n-- Display real version of Zope, not of the empty meta-package Zope2.\n-  [pbauer]\n+New features:\n \n-- Add zcml-condition plone-52 for conditional configuration.\n-  [pbauer]\n \n-- Use getSite in set_own_login_name to get the portals acl_users.\n-  [pbauer]\n+- Custom date format strings from registry can be in the ``${}`` format as in the locales files.\n+  If theres a day or month name used, this will be translated.\n+  For bbb the classic strftime ``%`` strings are still behaving like before.\n+  [jensens] (#3084)\n+- Add icon resolver to return url or tag for given icon.\n+  [santonelli] (#3192)\n+- Include a controlpanel to inspect and rebuild relations.\n+  [pbauer] (#3231)\n+- Add PLONE60MARKER (and PLONE52MARKER) Python marker\n+  [sneridagh] (#3257)\n+- Protect @@historyview with Modify portal content permission. Fixes #3297\n+  [pbauer] (#3297)\n \n-- Fix test issue with rarely used multi-site SSO feature.\n-  ``came_from`` on ``@register`` link would point to wrong site.\n-  Completly removed ``came_from`` on ``@@register`` link.\n-  It does not make much sense anyway and we test nowhere if there is a came_from on that link.\n-  [jensens]\n \n-- Remove depricated ``type`` attribute from ``script`` and ``link`` tags.\n-  [newbazz]\n+Bug fixes:\n \n-- Render tinymce attributes correctly in Python3.\n-  [sallner]\n \n-- Remove unresolved dependencies of plone-final to cssregistry and jsregistry.\n-  [pbauer]\n+- Add ``plone.app.caching`` to the list of add-ons that is upgraded when upgrading Plone.\n+  [maurits] (#82)\n+- Change control panel item sorting and sort them by title\n+  [erral] (#721)\n+- No longer doubly undo a response Content-Type change when combining bundles.\n+  [maurits] (#1924)\n+- Removed dependency on Products.Sessions.\n+  It is still pulled in by Products.PluggableAuthService though.\n+  See also `CMFPlacefulWorkflow issue 35 <https://github.com/plone/Products.CMFPlacefulWorkflow/issues/35>`_.\n+  [maurits] (#2957)\n+- Fix issue with @@search view when filtering by creation date\n+  [frapell] (#3007)\n+- Merge Hotfix20200121: isURLInPortal could be tricked into accepting malicious links. (#3021)\n+- Merge Hotfix20200121 Check of the strength of password could be skipped. (#3021)\n+- Improve tests for the workflow tool method listWFStatesByTitle (#3032)\n+- A default WSGI configuration requires Paste which is only installed with the Zope[wsgi] extra..\n+  [tschorr] (#3039)\n+- Fixed deprecation warning for zope.site.hooks.\n+  [maurits] (#3130)\n+- Fixed use of own ``utils.isDefaultPage``, which should be ``defaultpage.check_default_page_via_view``.\n+  [maurits] (#3130)\n+- Fixed invalid escape sequences in regular expressions.\n+  [maurits] (#3130)\n+- PloneBatch: define ``__bool__`` as copy of ``__nonzero__``.\n+  Python 3 calls ``__bool__`` when doing ``bool(batch)``.\n+  [maurits] (#3175)\n+- No longer consider calling ``len(batch)`` as deprecated.\n+  The deprecation warning is unvoidable with current ``Products.PageTemplates`` code.\n+  Fixes `issue 3176 <https://github.com/plone/Products.CMFPlone/issues/3176>`_.\n+  maurits (#3176)\n+- Fix tests with Products.MailHost 4.10.\n+  [maurits] (#3178)\n+- Applied: `find . -name "*.py" |grep -v skins|xargs pyupgrade --py36-plus --py3-only`.\n+  This auto-rewrites Python 2.7 specific syntax and code to Python 3.6+.\n+  [jensens] (#3185)\n+- Robot tests: Do not use jQuery.size() but use ``.length`` instead.\n+  ``.size()`` is deprecated since 1.8.\n+  [thet] (#3195)\n+- Remove traces of Archetypes\n+  [pbauer] (#3214)\n+- Fix problem to remove username and password from email settings if there was already one set.\n+  [jensens] (#3224)\n+- Fix migration when we have broken objects in the app root (e.g. the temp_folder) (#3245)\n+- Fixed tests in combination with Products.PluggableAuthService 2.6.0.\n+  [maurits] (#3251)\n+- Fix closing curly brace in search.pt template.\n+  [balavec] (#3252)\n+- Add the remote code execution fix from the `Products.PloneHotfix20210518 expressions patch <https://plone.org/security/hotfix/20210518/remote-code-execution-via-traversal-in-expressions>`_.\n+  We need this because Zope 4.6.2 is too strict for us.\n+  [maurits] (#3274)\n+- Removed the docstring from various methods to avoid making them available via a url.\n+  From the `Products.PloneHotfix20210518 reflected XSS fix <https://plone.org/security/hotfix/20210518/reflected-xss-in-various-spots>`_.\n+  [maurits] (#3274)\n+- Remove unused imports. [jensens] (#3299)\n+- Fix TypeError when adding a portlet. [daggelpop] (#3303)\n+- The portal catalog will not try to index itself anymore [ale-rt] (#3312)\ndiff --git a/DEVELOPING_BUNDLES.rst b/DEVELOPING_BUNDLES.rst\ndeleted file mode 100644\nindex d2ae1bca79..0000000000\n--- a/DEVELOPING_BUNDLES.rst\n+++ /dev/null\n@@ -1,70 +0,0 @@\n-Introduction\n-============\n-\n-This document is meant to help core developers hack on plone bundles.\n-\n-It\'s a work in progress and right now, it\'ll cover scenarios of working on Plone bundles.\n-\n-\n-Background\n-----------\n-\n-Plone bundle resources are mostly located in the mockup package and Products.CMFPlone/static.\n-\n-Dependency Plone JavaScript resources are defined in Products.CMFPlone/static/bower.json\n-\n-Products.CMFPlone/static/bower.json and mockup/bower.json are very close to the same.\n-If you change a dependency version in mockup/bower.json you\'re going to have to update that version in Products.CMFPlone/static/bower.json.\n-The reason for this is `mockup` does not commit its dependency packages to its repository while Products.CMFPlone does.\n-The difference is due to fact that CMFPlone allows you to develop TTW and mockup is meant to be a simple bower installable package (and when bower installs, it\'ll install the dependency).\n-\n-\n-Updating bundle resources\n--------------------------\n-\n-If you are updating Plone JavaScript resource while in development mode on your Plone instance, you\'ll need to compile those changes in order for Plone to be shipped with your changes in production mode.\n-The general process is:\n-\n-1) Make your updates to JavaScript (could be in mockup project)\n-2) Compile bundle you made changes to::\n-\n-    cd path/to/buildout\n-    ./bin/plone-compile-resources --bundle=bundle-name\n-\n-3) In the ``registry.xml`` file where the bundle is registered, update the bundles ``last_compilation`` date/time value.\n-  Otherwise there might still an old, cached version be delivered.\n-\n-4) If you update one of the core bundles (e.g. ``plone`` or ``plone-logged-in``) don\'t forget to add an registry entry with updated ``last_compilation`` in ``plone.app.upgrade`` too.\n-\n-The final step requires you to have a clean Plone instance available which knows how to build the JavaScript dependencies.\n-You can provide `--instance` parameter to customize which Plone instance is used to build the bundle.\n-\n-\n-Upgrading JavaScript library\n-----------------------------\n-\n-If you need to update a dependent version, the general workflow is:\n-\n-1) Update Products.CMFPlone/static/bower.json\n-2) Run bower in Products.CMFPlone/static::\n-\n-    cd path/to/Products/CMFPlone/static\n-    path/to/bower install\n-\n-3) Then, finally, compile the bundle::\n-\n-    cd path/to/buildout\n-    ./bin/plone-compile-resources --bundle=bundle-name\n-\n-To get it as clean as possible without any unnecessary files, follow a similar process like this::\n-\n-1) Copy ``bower.json``, ``.bowerrc`` and ``.gitignore`` to a new temporary working directory, which is not already managed by git.\n-2) Update ``bower.json`` in there.\n-3) Run ``bower install`` in there.\n-4) Eventually update ``.gitignore`` to ignore any new files not needed to build other bundles.\n-5) Run ``git init .``\n-6) Run ``git add .``\n-7) Remove the ``components`` directory in the temporary working directory.\n-8) Run ``git checkout .`` to checkout the components directory again, but this time only those files which ``.gitignore`` didn\'t ignore.\n-9) Replace ``static/components`` directory from CMFPlone with the ``components`` directory from your temporary working directory.\n-\ndiff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 075934035d..54a24caf45 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -1,33 +1,33 @@\n from AccessControl import ClassSecurityInfo\n+from AccessControl.class_init import InitializeClass\n from AccessControl.PermissionRole import rolesForPermissionOn\n from AccessControl.Permissions import manage_zcatalog_entries as ManageZCatalogEntries  # noqa\n from AccessControl.Permissions import search_zcatalog as SearchZCatalog\n from Acquisition import aq_base\n from Acquisition import aq_inner\n from Acquisition import aq_parent\n-from AccessControl.class_init import InitializeClass\n from App.special_dtml import DTMLFile\n from BTrees.Length import Length\n from DateTime import DateTime\n from OFS.interfaces import IOrderedContainer\n+from plone.app.discussion.interfaces import DISCUSSION_ANNOTATION_KEY\n+from plone.base.interfaces import INonStructuralFolder\n+from plone.base.interfaces import IPloneCatalogTool\n+from plone.base.utils import base_hasattr\n+from plone.base.utils import human_readable_size\n+from plone.base.utils import safe_callable\n+from plone.base.utils import safe_text\n from plone.i18n.normalizer.base import mapUnicode\n from plone.indexer import indexer\n from plone.indexer.interfaces import IIndexableObject\n-from Products.CMFCore.CatalogTool import CatalogTool as BaseTool\n from Products.CMFCore.CatalogTool import _mergedLocalRoles\n+from Products.CMFCore.CatalogTool import CatalogTool as BaseTool\n from Products.CMFCore.indexing import processQueue\n from Products.CMFCore.permissions import AccessInactivePortalContent\n from Products.CMFCore.utils import _checkPermission\n from Products.CMFCore.utils import _getAuthenticatedUser\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import DISCUSSION_ANNOTATION_KEY\n-from Products.CMFPlone.interfaces import INonStructuralFolder\n-from Products.CMFPlone.interfaces import IPloneCatalogTool\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n-from Products.CMFPlone.utils import base_hasattr\n-from Products.CMFPlone.utils import human_readable_size\n-from Products.CMFPlone.utils import safe_callable\n-from Products.CMFPlone.utils import safe_unicode\n from Products.ZCatalog.ZCatalog import ZCatalog\n from time import process_time\n from zExceptions import Unauthorized\n@@ -51,7 +51,7 @@\n _marker = object()\n \n MAX_SORTABLE_TITLE = 40\n-BLACKLISTED_INTERFACES = frozenset((\n+DENIED_INTERFACES = frozenset((\n     \'AccessControl.interfaces.IOwned\',\n     \'AccessControl.interfaces.IPermissionMappingSupport\',\n     \'AccessControl.interfaces.IRoleManager\',\n@@ -74,7 +74,6 @@\n     \'OFS.interfaces.IZopeObject\',\n     \'persistent.interfaces.IPersistent\',\n     \'plone.app.iterate.interfaces.IIterateAware\',\n-    \'plone.app.kss.interfaces.IPortalObject\',\n     \'plone.contentrules.engine.interfaces.IRuleAssignable\',\n     \'plone.folder.interfaces.IFolder\',\n     \'plone.folder.interfaces.IOrderableFolder\',\n@@ -93,8 +92,8 @@\n     \'Products.CMFCore.interfaces._content.IWorkflowAware\',\n     \'Products.CMFDynamicViewFTI.interfaces.IBrowserDefault\',\n     \'Products.CMFDynamicViewFTI.interfaces.ISelectableBrowserDefault\',\n-    \'Products.CMFPlone.interfaces.constrains.IConstrainTypes\',\n-    \'Products.CMFPlone.interfaces.constrains.ISelectableConstrainTypes\',\n+    \'plone.base.interfaces.constrains.IConstrainTypes\',\n+    \'plone.base.interfaces.constrains.ISelectableConstrainTypes\',\n     \'Products.GenericSetup.interfaces.IDAVAware\',\n     \'webdav.EtagSupport.EtagBaseInterface\',\n     \'webdav.interfaces.IDAVCollection\',\n@@ -113,13 +112,8 @@\n     \'zope.interface.Interface\',\n ))\n \n-\n-@deprecate(\'Use catalog.getAllBrains() instead. \' +\n-           \'catalog_get_all will be removed in Plone 6\')\n-def catalog_get_all(catalog, unique_idx=\'UID\'):\n-    """Get all brains from the catalog.\n-    """\n-    return catalog.getAllBrains()\n+# bbb, remove in Plone 7\n+BLACKLISTED_INTERFACES = DENIED_INTERFACES\n \n \n @indexer(Interface)\n@@ -158,7 +152,7 @@ def allowedRolesAndUsers(obj):\n def object_provides(obj):\n     return tuple(\n         [i.__identifier__ for i in providedBy(obj).flattened()\n-         if i.__identifier__ not in BLACKLISTED_INTERFACES]\n+         if i.__identifier__ not in DENIED_INTERFACES]\n     )\n \n \n@@ -179,7 +173,7 @@ def sortable_title(obj):\n \n         if isinstance(title, str):\n             # Ignore case, normalize accents, strip spaces\n-            sortabletitle = mapUnicode(safe_unicode(title)).lower().strip()\n+            sortabletitle = mapUnicode(safe_text(title)).lower().strip()\n             # Replace numbers with zero filled numbers\n             sortabletitle = num_sort_regex.sub(zero_fill, sortabletitle)\n             # Truncate to prevent bloat, take bits from start and end\n@@ -256,11 +250,6 @@ def mime_type(obj):\n     return aq_base(obj).getPrimaryField().getContentType(obj)\n \n \n-@indexer(Interface)\n-def location(obj):\n-    return obj.getField(\'location\').get(obj)\n-\n-\n @implementer(IPloneCatalogTool)\n class CatalogTool(PloneBaseTool, BaseTool):\n     """Plone\'s catalog tool"""\n@@ -466,8 +455,11 @@ def clearFindAndRebuild(self):\n         idxs = list(self.indexes())\n \n         def indexObject(obj, path):\n-            if (base_hasattr(obj, \'reindexObject\') and\n-                    safe_callable(obj.reindexObject)):\n+            if (\n+                obj != self\n+                and base_hasattr(obj, \'reindexObject\')\n+                and safe_callable(obj.reindexObject)\n+            ):\n                 try:\n                     self.reindexObject(obj, idxs=idxs)\n                     # index conversions from plone.app.discussion\n@@ -486,6 +478,7 @@ def indexObject(obj, path):\n                     pass\n         self.manage_catalogClear()\n         portal = aq_parent(aq_inner(self))\n+        indexObject(portal, \'\')\n         portal.ZopeFindAndApply(\n             portal,\n             search_sub=True,\ndiff --git a/Products/CMFPlone/DublinCore.py b/Products/CMFPlone/DublinCore.py\ndeleted file mode 100644\nindex 8e1d12b481..0000000000\n--- a/Products/CMFPlone/DublinCore.py\n+++ /dev/null\n@@ -1,478 +0,0 @@\n-##############################################################################\n-#\n-# Copyright (c) 2001 Zope Foundation and Contributors.\n-#\n-# This software is subject to the provisions of the Zope Public License,\n-# Version 2.1 (ZPL).  A copy of the ZPL should accompany this distribution.\n-# THIS SOFTWARE IS PROVIDED "AS IS" AND ANY AND ALL EXPRESS OR IMPLIED\n-# WARRANTIES ARE DISCLAIMED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n-# WARRANTIES OF TITLE, MERCHANTABILITY, AGAINST INFRINGEMENT, AND FITNESS\n-# FOR A PARTICULAR PURPOSE.\n-#\n-##############################################################################\n-""" Dublin Core support for content types. """\n-\n-from AccessControl.SecurityInfo import ClassSecurityInfo\n-from AccessControl.SecurityManagement import getSecurityManager\n-from Acquisition import aq_base\n-from AccessControl.class_init import InitializeClass\n-from App.special_dtml import DTMLFile\n-from DateTime.DateTime import DateTime\n-from OFS.PropertyManager import PropertyManager\n-from zope.interface import implementer\n-\n-from Products.CMFCore.interfaces import ICatalogableDublinCore\n-from Products.CMFCore.interfaces import IDublinCore\n-from Products.CMFCore.interfaces import IMutableDublinCore\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.permissions import ModifyPortalContent\n-from Products.CMFPlone.permissions import View\n-from Products.CMFPlone.utils import WWW_DIR\n-\n-\n-_marker = []\n-\n-# For http://www.zope.org/Collectors/CMF/325\n-# We only really need this once, at startup.\n-_zone = DateTime().timezone()\n-\n-\n-def seq_strip(seq, stripper=lambda x: x.strip()):\n-    """ Strip a sequence of strings.\n-    """\n-    if isinstance(seq, list):\n-        return map(stripper, seq)\n-\n-    if isinstance(seq, tuple):\n-        return tuple(map(stripper, seq))\n-\n-    raise ValueError("{} of unsupported sequencetype {}".format(seq, type(seq)))\n-\n-\n-def tuplize(valueName, value, splitter=lambda x: x.split()):\n-\n-    if isinstance(value, tuple):\n-        return seq_strip(value)\n-\n-    if isinstance(value, list):\n-        return seq_strip(tuple(value))\n-\n-    if isinstance(value, str):\n-        return seq_strip(tuple(splitter(value)))\n-\n-    raise ValueError("%s of unsupported type" % valueName)\n-\n-\n-@implementer(IDublinCore, ICatalogableDublinCore, IMutableDublinCore)\n-class DefaultDublinCoreImpl(PropertyManager):\n-\n-    """ Mix-in class which provides Dublin Core methods.\n-    """\n-\n-    security = ClassSecurityInfo()\n-\n-    def __init__(self, title=\'\', subject=(), description=\'\', contributors=(), effective_date=None, expiration_date=None, format=\'text/html\', language=\'\', rights=\'\'\n-                 ):\n-        now = DateTime()\n-        self.creation_date = now\n-        self.modification_date = now\n-        self.creators = ()\n-        self._editMetadata(title, subject, description, contributors, effective_date, expiration_date, format, language, rights\n-                           )\n-\n-    #\n-    #  Set-modification-date-related methods.\n-    #  In DefaultDublinCoreImpl for lack of a better place.\n-    #\n-\n-    # Class variable default for an upgrade.\n-    modification_date = None\n-\n-    security.declarePrivate(\'notifyModified\')\n-\n-    def notifyModified(self):\n-        # Take appropriate action after the resource has been modified.\n-        # Update creators and modification_date.\n-        self.addCreator()\n-        self.setModificationDate()\n-\n-    security.declareProtected(ModifyPortalContent, \'addCreator\')\n-\n-    def addCreator(self, creator=None):\n-        # Add creator to Dublin Core creators.\n-        if creator is None:\n-            user = getSecurityManager().getUser()\n-            creator = user and user.getId()\n-\n-        # call self.listCreators() to make sure self.creators exists\n-        if creator and not creator in self.listCreators():\n-            self.creators = self.creators + (creator, )\n-\n-    security.declareProtected(ModifyPortalContent, \'setModificationDate\')\n-\n-    def setModificationDate(self, modification_date=None):\n-        # Set the date when the resource was last modified.\n-        # When called without an argument, sets the date to now.\n-        if modification_date is None:\n-            self.modification_date = DateTime()\n-        else:\n-            self.modification_date = self._datify(modification_date)\n-\n-    #\n-    #  DublinCore interface query methods\n-    #\n-    security.declareProtected(View, \'Title\')\n-\n-    def Title(self):\n-        # Dublin Core Title element - resource name.\n-        return self.title\n-\n-    security.declareProtected(View, \'listCreators\')\n-\n-    def listCreators(self):\n-        # List Dublin Core Creator elements - resource authors.\n-        if not hasattr(aq_base(self), \'creators\'):\n-            # for content created with CMF versions before 1.5\n-            owner_tuple = self.getOwnerTuple()\n-            if owner_tuple:\n-                self.creators = (owner_tuple[1],)\n-            else:\n-                self.creators = ()\n-        return self.creators\n-\n-    security.declareProtected(View, \'Creator\')\n-\n-    def Creator(self):\n-        # Dublin Core Creator element - resource author.\n-        creators = self.listCreators()\n-        return creators and creators[0] or \'\'\n-\n-    security.declareProtected(View, \'Subject\')\n-\n-    def Subject(self):\n-        # Dublin Core Subject element - resource keywords.\n-        return getattr(self, \'subject\', ())  # compensate for *old* content\n-\n-    security.declareProtected(View, \'Description\')\n-\n-    def Description(self):\n-        # Dublin Core Description element - resource summary.\n-        return self.description\n-\n-    security.declareProtected(View, \'Publisher\')\n-\n-    def Publisher(self):\n-        # Dublin Core Publisher element - resource publisher.\n-        tool = getToolByName(self, \'portal_metadata\', None)\n-\n-        if tool is not None:\n-            return tool.getPublisher()\n-\n-        return \'No publisher\'\n-\n-    security.declareProtected(View, \'listContributors\')\n-\n-    def listContributors(self):\n-        # Dublin Core Contributor elements - resource collaborators.\n-        return self.contributors\n-\n-    security.declareProtected(View, \'Contributors\')\n-\n-    def Contributors(self):\n-        # Deprecated alias of listContributors.\n-        return self.listContributors()\n-\n-    security.declareProtected(View, \'Date\')\n-\n-    def Date(self, zone=None):\n-        # Dublin Core Date element - default date.\n-        if zone is None:\n-            zone = _zone\n-        # Return effective_date if set, modification date otherwise\n-        date = getattr(self, \'effective_date\', None)\n-        if date is None:\n-            date = self.modified()\n-        return date.toZone(zone).ISO()\n-\n-    security.declareProtected(View, \'CreationDate\')\n-\n-    def CreationDate(self, zone=None):\n-        # Dublin Core Date element - date resource created.\n-        if zone is None:\n-            zone = _zone\n-        # return unknown if never set properly\n-        if self.creation_date:\n-            return self.creation_date.toZone(zone).ISO()\n-        else:\n-            return \'Unknown\'\n-\n-    security.declareProtected(View, \'EffectiveDate\')\n-\n-    def EffectiveDate(self, zone=None):\n-        # Dublin Core Date element - date resource becomes effective.\n-        if zone is None:\n-            zone = _zone\n-        ed = getattr(self, \'effective_date\', None)\n-        return ed and ed.toZone(zone).ISO() or \'None\'\n-\n-    security.declareProtected(View, \'ExpirationDate\')\n-\n-    def ExpirationDate(self, zone=None):\n-        # Dublin Core Date element - date resource expires.\n-        if zone is None:\n-            zone = _zone\n-        ed = getattr(self, \'expiration_date\', None)\n-        return ed and ed.toZone(zone).ISO() or \'None\'\n-\n-    security.declareProtected(View, \'ModificationDate\')\n-\n-    def ModificationDate(self, zone=None):\n-        # Dublin Core Date element - date resource last modified.\n-        if zone is None:\n-            zone = _zone\n-        return self.modified().toZone(zone).ISO()\n-\n-    security.declareProtected(View, \'Type\')\n-\n-    def Type(self):\n-        # Dublin Core Type element - resource type.\n-        ti = self.getTypeInfo()\n-        return ti is not None and ti.Title() or \'Unknown\'\n-\n-    security.declareProtected(View, \'Format\')\n-\n-    def Format(self):\n-        # Dublin Core Format element - resource format.\n-        return self.format\n-\n-    security.declareProtected(View, \'Identifier\')\n-\n-    def Identifier(self):\n-        # Dublin Core Identifier element - resource ID.\n-        # XXX: fixme using \'portal_metadata\' (we need to prepend the\n-        #      right prefix to self.getPhysicalPath().\n-        return self.absolute_url()\n-\n-    security.declareProtected(View, \'Language\')\n-\n-    def Language(self):\n-        # Dublin Core Language element - resource language.\n-        return self.language\n-\n-    security.declareProtected(View, \'Rights\')\n-\n-    def Rights(self):\n-        # Dublin Core Rights element - resource copyright.\n-        return self.rights\n-\n-    #\n-    #  DublinCore utility methods\n-    #\n-    def content_type(self):\n-        """ WebDAV needs this to do the Right Thing (TM).\n-        """\n-        return self.Format()\n-\n-    __FLOOR_DATE = DateTime(1970, 0)  # always effective\n-\n-    security.declareProtected(View, \'isEffective\')\n-\n-    def isEffective(self, date):\n-        # Is the date within the resource\'s effective range?\n-        pastEffective = (self.effective_date is None\n-                         or self.effective_date <= date)\n-        beforeExpiration = (self.expiration_date is None\n-                            or self.expiration_date >= date)\n-        return pastEffective and beforeExpiration\n-\n-    #\n-    #  CatalogableDublinCore methods\n-    #\n-    security.declareProtected(View, \'created\')\n-\n-    def created(self):\n-        # Dublin Core Date element - date resource created.\n-        # allow for non-existent creation_date, existed always\n-        date = getattr(self, \'creation_date\', None)\n-        return date is None and self.__FLOOR_DATE or date\n-\n-    security.declareProtected(View, \'effective\')\n-\n-    def effective(self):\n-        # Dublin Core Date element - date resource becomes effective.\n-        marker = []\n-        date = getattr(self, \'effective_date\', marker)\n-        if date is marker:\n-            date = getattr(self, \'creation_date\', None)\n-        return date is None and self.__FLOOR_DATE or date\n-\n-    __CEILING_DATE = DateTime(2500, 0)  # never expires\n-\n-    security.declareProtected(View, \'expires\')\n-\n-    def expires(self):\n-        # Dublin Core Date element - date resource expires.\n-        date = getattr(self, \'expiration_date\', None)\n-        return date is None and self.__CEILING_DATE or date\n-\n-    security.declareProtected(View, \'modified\')\n-\n-    def modified(self):\n-        # Dublin Core Date element - date resource last modified.\n-        date = self.modification_date\n-        if date is None:\n-            # Upgrade.\n-            date = DateTime(self._p_mtime)\n-            self.modification_date = date\n-        return date\n-\n-    security.declareProtected(View, \'getMetadataHeaders\')\n-\n-    def getMetadataHeaders(self):\n-        # Return RFC-822-style headers.\n-        hdrlist = []\n-        hdrlist.append((\'Title\', self.Title()))\n-        hdrlist.append((\'Subject\', \', \'.join(self.Subject())))\n-        hdrlist.append((\'Publisher\', self.Publisher()))\n-        hdrlist.append((\'Description\', self.Description()))\n-        hdrlist.append((\'Contributors\', \'; \'.join(self.Contributors())))\n-        hdrlist.append((\'Effective_date\', self.EffectiveDate()))\n-        hdrlist.append((\'Expiration_date\', self.ExpirationDate()))\n-        hdrlist.append((\'Type\', self.Type()))\n-        hdrlist.append((\'Format\', self.Format()))\n-        hdrlist.append((\'Language\', self.Language()))\n-        hdrlist.append((\'Rights\', self.Rights()))\n-        return hdrlist\n-\n-    #\n-    #  MutableDublinCore methods\n-    #\n-    security.declarePrivate(\'_datify\')\n-\n-    def _datify(self, attrib):\n-        if attrib == \'None\':\n-            attrib = None\n-        elif not isinstance(attrib, DateTime):\n-            if attrib is not None:\n-                attrib = DateTime(attrib)\n-        return attrib\n-\n-    security.declareProtected(ModifyPortalContent, \'setTitle\')\n-\n-    def setTitle(self, title):\n-        # Set Dublin Core Title element - resource name.\n-        self.title = title\n-\n-    security.declareProtected(ModifyPortalContent, \'setCreators\')\n-\n-    def setCreators(self, creators):\n-        # Set Dublin Core Creator elements - resource authors.\n-        self.creators = tuplize(\'creators\', creators)\n-\n-    security.declareProtected(ModifyPortalContent, \'setSubject\')\n-\n-    def setSubject(self, subject):\n-        # Set Dublin Core Subject element - resource keywords.\n-        self.subject = tuplize(\'subject\', subject)\n-\n-    security.declareProtected(ModifyPortalContent, \'setDescription\')\n-\n-    def setDescription(self, description):\n-        # Set Dublin Core Description element - resource summary.\n-        self.description = description\n-\n-    security.declareProtected(ModifyPortalContent, \'setContributors\')\n-\n-    def setContributors(self, contributors):\n-        # Set Dublin Core Contributor elements - resource collaborators.\n-        semi_split = lambda s: map(lambda x: x.strip(), s.split(\';\'))\n-        self.contributors = tuplize(\'contributors\', contributors, semi_split)\n-\n-    security.declareProtected(ModifyPortalContent, \'setEffectiveDate\')\n-\n-    def setEffectiveDate(self, effective_date):\n-        # Set Dublin Core Date element - date resource becomes effective.\n-        self.effective_date = self._datify(effective_date)\n-\n-    security.declareProtected(ModifyPortalContent, \'setExpirationDate\')\n-\n-    def setExpirationDate(self, expiration_date):\n-        # Set Dublin Core Date element - date resource expires.\n-        self.expiration_date = self._datify(expiration_date)\n-\n-    security.declareProtected(ModifyPortalContent, \'setFormat\')\n-\n-    def setFormat(self, format):\n-        # Set Dublin Core Format element - resource format.\n-        self.format = format\n-\n-    security.declareProtected(ModifyPortalContent, \'setLanguage\')\n-\n-    def setLanguage(self, language):\n-        # Set Dublin Core Language element - resource language.\n-        self.language = language\n-\n-    security.declareProtected(ModifyPortalContent, \'setRights\')\n-\n-    def setRights(self, rights):\n-        # Set Dublin Core Rights element - resource copyright.\n-        self.rights = rights\n-\n-    #\n-    #  Management tab methods\n-    #\n-\n-    security.declarePrivate(\'_editMetadata\')\n-\n-    def _editMetadata(self, title=_marker, subject=_marker, description=_marker, contributors=_marker, effective_date=_marker, expiration_date=_marker, format=_marker, language=_marker, rights=_marker\n-                      ):\n-        # Update the editable metadata for this resource.\n-        if title is not _marker:\n-            self.setTitle(title)\n-        if subject is not _marker:\n-            self.setSubject(subject)\n-        if description is not _marker:\n-            self.setDescription(description)\n-        if contributors is not _marker:\n-            self.setContributors(contributors)\n-        if effective_date is not _marker:\n-            self.setEffectiveDate(effective_date)\n-        if expiration_date is not _marker:\n-            self.setExpirationDate(expiration_date)\n-        if format is not _marker:\n-            self.setFormat(format)\n-        if language is not _marker:\n-            self.setLanguage(language)\n-        if rights is not _marker:\n-            self.setRights(rights)\n-\n-    security.declareProtected(ModifyPortalContent, \'manage_metadata\')\n-    manage_metadata = DTMLFile(\'zmi_metadata\', WWW_DIR)\n-\n-    security.declareProtected(ModifyPortalContent, \'manage_editMetadata\')\n-\n-    def manage_editMetadata(self, title, subject, description, contributors, effective_date, expiration_date, format, language, rights, REQUEST\n-                            ):\n-        """ Update metadata from the ZMI.\n-        """\n-        self._editMetadata(title, subject, description, contributors, effective_date, expiration_date, format, language, rights\n-                           )\n-        REQUEST[\'RESPONSE\'].redirect(self.absolute_url()\n-                                     + \'/manage_metadata\'\n-                                     + \'?manage_tabs_message=Metadata+updated.\')\n-\n-    security.declareProtected(ModifyPortalContent, \'editMetadata\')\n-\n-    def editMetadata(self, title=\'\', subject=(), description=\'\', contributors=(), effective_date=None, expiration_date=None, format=\'text/html\', language=\'en-US\', rights=\'\'\n-                     ):\n-        # Need to add check for webDAV locked resource for TTW methods.\n-        # As per bug #69, we can\'t assume they use the webdav\n-        # locking interface, and fail gracefully if they don\'t.\n-        if hasattr(self, \'failIfLocked\'):\n-            self.failIfLocked()\n-\n-        self._editMetadata(title=title, subject=subject, description=description, contributors=contributors, effective_date=effective_date, expiration_date=expiration_date, format=format, language=language, rights=rights\n-                           )\n-        self.reindexObject()\n-\n-InitializeClass(DefaultDublinCoreImpl)\ndiff --git a/Products/CMFPlone/MigrationTool.py b/Products/CMFPlone/MigrationTool.py\nindex a7bf17b886..7b56c901ee 100644\n--- a/Products/CMFPlone/MigrationTool.py\n+++ b/Products/CMFPlone/MigrationTool.py\n@@ -8,7 +8,7 @@\n from Products.CMFCore.utils import registerToolInterface\n from Products.CMFCore.utils import UniqueObject\n from Products.CMFPlone.factory import _DEFAULT_PROFILE\n-from Products.CMFPlone.interfaces import IMigrationTool\n+from plone.base.interfaces import IMigrationTool\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from io import StringIO\n from ZODB.POSException import ConflictError\n@@ -79,25 +79,47 @@ def upgrade_all(self, context):\n         setup = getToolByName(context, \'portal_setup\')\n         for addon in self:\n             if addon.safe():\n-                setup.upgradeProfile(addon.profile_id)\n+                setup.upgradeProfile(addon.profile_id, quiet=True)\n \n \n # List of upgradeable packages.  Obvious items to add here, are all\n # core packages that actually have upgrade steps.\n # Good start is portal_setup.listProfilesWithUpgrades()\n+# Please use \'check_module\' for packages that are not direct dependencies\n+# of Products.CMFPlone, but of the Plone package.\n ADDON_LIST = AddonList([\n     Addon(profile_id=\'Products.CMFEditions:CMFEditions\'),\n-    Addon(profile_id=\'Products.CMFPlacefulWorkflow:CMFPlacefulWorkflow\'),\n+    Addon(\n+        profile_id=\'Products.CMFPlacefulWorkflow:CMFPlacefulWorkflow\',\n+        check_module=\'Products.CMFPlacefulWorkflow\'\n+    ),\n+    Addon(profile_id=\'Products.PlonePAS:PlonePAS\'),\n+    Addon(\n+        profile_id=\'plone.app.caching:default\',\n+        check_module=\'plone.app.caching\'\n+    ),\n     Addon(profile_id=\'plone.app.contenttypes:default\'),\n     Addon(profile_id=\'plone.app.dexterity:default\'),\n     Addon(profile_id=\'plone.app.discussion:default\'),\n     Addon(profile_id=\'plone.app.event:default\'),\n-    Addon(profile_id=\'plone.app.iterate:plone.app.iterate\'),\n+    Addon(\n+        profile_id=\'plone.app.iterate:default\',\n+        check_module=\'plone.app.iterate\'\n+    ),\n     Addon(profile_id=\'plone.app.multilingual:default\'),\n     Addon(profile_id=\'plone.app.querystring:default\'),\n     Addon(profile_id=\'plone.app.theming:default\'),\n     Addon(profile_id=\'plone.app.users:default\'),\n+    Addon(\n+        profile_id=\'plone.restapi:default\',\n+        check_module=\'plone.restapi\'\n+    ),\n+    Addon(profile_id=\'plone.session:default\'),\n     Addon(profile_id=\'plone.staticresources:default\'),\n+    Addon(\n+        profile_id=\'plone.volto:default\',\n+        check_module=\'plone.volto\'\n+    ),\n ])\n \n \n@@ -238,22 +260,7 @@ def listUpgrades(self):\n         # using a newer plone.app.upgrade version should not give problems.\n         setup = getToolByName(self, \'portal_setup\')\n         fs_version = self.getFileSystemVersion()\n-        steps = setup.listUpgrades(_DEFAULT_PROFILE)\n-        upgrades = []\n-        for upgrade_step in steps:\n-            if isinstance(upgrade_step, list):\n-                # This is a nested list of upgrade steps,\n-                # which must have the same destination.\n-                # So take the first one.\n-                if not upgrade_step:\n-                    # Empty list, not sure if this can happen in practice.\n-                    continue\n-                dest = upgrade_step[0].get(\'sdest\')\n-            else:\n-                dest = upgrade_step.get(\'sdest\')\n-            if dest > fs_version and dest != \'all\':\n-                break\n-            upgrades.append(upgrade_step)\n+        upgrades = setup.listUpgrades(_DEFAULT_PROFILE, dest=fs_version)\n         return upgrades\n \n     security.declareProtected(ManagePortal, \'upgrade\')\ndiff --git a/Products/CMFPlone/PasswordResetTool.py b/Products/CMFPlone/PasswordResetTool.py\nindex 1a20755edd..2f5f74e4e2 100644\n--- a/Products/CMFPlone/PasswordResetTool.py\n+++ b/Products/CMFPlone/PasswordResetTool.py\n@@ -13,8 +13,8 @@\n from Products.CMFCore.permissions import ManagePortal\n from Products.CMFCore.utils import getToolByName\n from Products.CMFCore.utils import UniqueObject\n-from Products.CMFPlone.interfaces import IPWResetTool\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import IPWResetTool\n+from plone.base.interfaces import ISecuritySchema\n from Products.CMFPlone.RegistrationTool import get_member_by_login_name\n from zope.component import getUtility\n from zope.interface import implementer\n@@ -176,7 +176,7 @@ def clearExpired(self, days=0):\n         Parameter controls how many days past expired it must be to disappear.\n         """\n         now = datetime.datetime.utcnow()\n-        for key, record in self._requests.items():\n+        for key, record in list(self._requests.items()):\n             stored_user, expiry = record\n             if self.expired(expiry, now - datetime.timedelta(days=days)):\n                 del self._requests[key]\ndiff --git a/Products/CMFPlone/PloneBaseTool.py b/Products/CMFPlone/PloneBaseTool.py\nindex 821724d690..d0d0a9860d 100644\n--- a/Products/CMFPlone/PloneBaseTool.py\n+++ b/Products/CMFPlone/PloneBaseTool.py\n@@ -1,6 +1,6 @@\n from AccessControl.class_init import InitializeClass\n from AccessControl import ClassSecurityInfo\n-from Products.CMFPlone.interfaces import IPloneBaseTool\n+from plone.base.interfaces import IPloneBaseTool\n from Acquisition import aq_base\n from Acquisition import aq_parent\n from Acquisition import aq_inner\ndiff --git a/Products/CMFPlone/PloneBatch.py b/Products/CMFPlone/PloneBatch.py\nindex 727a0bebff..f0f2c5eaa2 100644\n--- a/Products/CMFPlone/PloneBatch.py\n+++ b/Products/CMFPlone/PloneBatch.py\n@@ -1,72 +1,3 @@\n-from ZTUtils import make_query\n+from zope.deprecation import moved\n \n-from plone.batching.batch import QuantumBatch\n-from plone.batching.utils import calculate_pagerange\n-\n-from zope.deprecation import deprecated\n-\n-\n-class Batch(QuantumBatch):\n-\n-    b_start_str = \'b_start\'\n-\n-    def __init__(self, sequence, size, start=0, end=0, orphan=0,\n-                 overlap=0, pagerange=7, quantumleap=0,\n-                 b_start_str=\'b_start\'):\n-        super().__init__(sequence, size, start,\n-                                    end, orphan, overlap,\n-                                    pagerange, quantumleap)\n-        self.b_start_str = b_start_str\n-\n-    def __len__(self):\n-        # Note: Using len() was deprecated for several years.\n-        # It was recommended to explicitly either use the `length` attribute\n-        # for the size of the current page, which is what we return now,\n-        # or use the `sequence_length` attribute for the size of the\n-        # entire sequence.\n-        # But the deprecation was reverted for Plone 5.2.3,\n-        # because core code in Products.PageTemplates called `len`\n-        # on batches, making the deprecation warning unavoidable\n-        # and thus unnecessary.\n-        # See https://github.com/plone/Products.CMFPlone/issues/3176\n-        return self.length\n-\n-    def __bool__(self):\n-        # Without __bool__ a bool(self) would call len(self), which\n-        # gives a deprecation warning.\n-        return bool(self.length)\n-\n-    # For Python 2 compatibility:\n-    __nonzero__ = __bool__\n-\n-    def initialize(self, start, end, size):\n-        super().initialize(start, end, size)\n-        self.pagerange, self.pagerangestart, self.pagerangeend = \\\n-            calculate_pagerange(self.pagenumber, self.numpages, self.pagerange)\n-\n-    def pageurl(self, formvariables, pagenumber=-1):\n-        # Makes the url for a given page.\n-        if pagenumber == -1:\n-            pagenumber = self.pagenumber\n-        b_start = pagenumber * (self.pagesize - self.overlap) - self.pagesize\n-        return make_query(formvariables, {self.b_start_str: b_start})\n-\n-    def navurls(self, formvariables, navlist=None):\n-        # Returns the page number and url for the navigation quick links.\n-        if navlist is None:\n-            navlist = []\n-        if not navlist:\n-            navlist = self.navlist\n-        return map(lambda x, formvariables=formvariables:\n-                   (x, self.pageurl(formvariables, x)), navlist)\n-\n-    def prevurls(self, formvariables):\n-        # Helper method to get prev navigation list from templates.\n-        return self.navurls(formvariables, self.previous_pages)\n-\n-    def nexturls(self, formvariables):\n-        # Helper method to get next navigation list from templates.\n-        return self.navurls(formvariables, self.next_pages)\n-\n-    prevlist = QuantumBatch.previous_pages\n-    nextlist = QuantumBatch.next_pages\n+moved(\'plone.base.batch\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/PloneControlPanel.py b/Products/CMFPlone/PloneControlPanel.py\nindex 6b0d4503a7..0748f25765 100644\n--- a/Products/CMFPlone/PloneControlPanel.py\n+++ b/Products/CMFPlone/PloneControlPanel.py\n@@ -12,7 +12,7 @@\n from Products.CMFCore.utils import registerToolInterface\n from Products.CMFCore.utils import UniqueObject\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import IControlPanel\n+from plone.base.interfaces import IControlPanel\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from zope.component.hooks import getSite\n from zope.i18n import translate\ndiff --git a/Products/CMFPlone/PloneFolder.py b/Products/CMFPlone/PloneFolder.py\ndeleted file mode 100644\nindex fb7624ea54..0000000000\n--- a/Products/CMFPlone/PloneFolder.py\n+++ /dev/null\n@@ -1,292 +0,0 @@\n-from AccessControl import ClassSecurityInfo\n-from AccessControl import Permissions\n-from AccessControl import Unauthorized\n-from AccessControl.class_init import InitializeClass\n-from Acquisition import aq_base\n-from Acquisition import aq_inner\n-from Acquisition import aq_parent\n-from ComputedAttribute import ComputedAttribute\n-from OFS.Folder import Folder\n-from OFS.ObjectManager import REPLACEABLE\n-from OFS.OrderSupport import OrderSupport\n-from plone.memoize import view\n-from Products.CMFCore.CMFCatalogAware import CatalogAware\n-from Products.CMFCore.CMFCatalogAware import OpaqueItemManager\n-from Products.CMFCore.CMFCatalogAware import WorkflowAware\n-from Products.CMFCore.permissions import AccessContentsInformation\n-from Products.CMFCore.permissions import AddPortalContent\n-from Products.CMFCore.permissions import AddPortalFolders\n-from Products.CMFCore.permissions import ListFolderContents\n-from Products.CMFCore.permissions import ModifyPortalContent\n-from Products.CMFCore.PortalFolder import PortalFolderBase\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import bbb\n-from Products.CMFPlone.DublinCore import DefaultDublinCoreImpl\n-from zExceptions import NotFound\n-from zope.interface import implementer\n-\n-import warnings\n-\n-\n-if bbb.HAS_ZSERVER:\n-    from webdav.NullResource import NullResource\n-    from webdav.interfaces import IWriteLock\n-else:\n-    from OFS.interfaces import IWriteLock\n-    NullResource = bbb.NullResource\n-\n-\n-class ReplaceableWrapper:\n-    """A wrapper around an object to make it replaceable."""\n-\n-    def __init__(self, ob):\n-        warnings.warn(\n-            \'ReplaceableWrapper is deprecated. Planned removal in Plone 6.0\',\n-            DeprecationWarning,\n-        )\n-        self.__ob = ob\n-\n-    def __getattr__(self, name):\n-        if name == \'__replaceable__\':\n-            return REPLACEABLE\n-        return getattr(self.__ob, name)\n-\n-\n-class OrderedContainer(Folder, OrderSupport):\n-    """Folder with subobject ordering support."""\n-\n-    security = ClassSecurityInfo()\n-\n-    security.declareProtected(ModifyPortalContent, \'moveObject\')\n-\n-    def moveObject(self, id, position):\n-        obj_idx = self.getObjectPosition(id)\n-        if obj_idx == position:\n-            return None\n-        elif position < 0:\n-            position = 0\n-\n-        metadata = list(self._objects)\n-        obj_meta = metadata.pop(obj_idx)\n-        metadata.insert(position, obj_meta)\n-        self._objects = tuple(metadata)\n-\n-    security.declarePrivate(\'getIdsSubset\')\n-\n-    def getIdsSubset(self, objs):\n-        # Get the ids of only cmf objects (used for moveObjectsByDelta).\n-        ttool = getToolByName(self, \'portal_types\')\n-        cmf_meta_types = [ti.Metatype() for ti in ttool.listTypeInfo()]\n-        return [obj[\'id\'] for obj in objs\n-                if obj[\'meta_type\'] in cmf_meta_types]\n-\n-    # BBB\n-    getCMFObjectsSubsetIds = getIdsSubset\n-\n-    security.declareProtected(ModifyPortalContent, \'getObjectPosition\')\n-\n-    def getObjectPosition(self, id):\n-        try:\n-            pos = OrderSupport.getObjectPosition(self, id)\n-        except ValueError:\n-            raise NotFound(\'Object %s was not found\' % str(id))\n-\n-        return pos\n-\n-    def manage_renameObject(self, id, new_id, REQUEST=None):\n-        """Rename a particular sub-object."""\n-        objidx = self.getObjectPosition(id)\n-        method = OrderedContainer.inheritedAttribute(\'manage_renameObject\')\n-        result = method(self, id, new_id, REQUEST)\n-        self.moveObject(new_id, objidx)\n-        putils = getToolByName(self, \'plone_utils\')\n-        putils.reindexOnReorder(self)\n-        return result\n-\n-InitializeClass(OrderedContainer)\n-\n-\n-@implementer(IWriteLock)\n-class BasePloneFolder(CatalogAware, WorkflowAware, OpaqueItemManager,\n-                      PortalFolderBase, DefaultDublinCoreImpl):\n-    """Implements basic Plone folder functionality except ordering support.\n-    """\n-\n-    security = ClassSecurityInfo()\n-\n-    manage_options = Folder.manage_options + \\\n-        WorkflowAware.manage_options\n-\n-    # Fix permissions set by CopySupport.py\n-    __ac_permissions__ = (\n-        (\'Modify portal content\',\n-         (\'manage_cutObjects\', \'manage_pasteObjects\',\n-          \'manage_renameForm\', \'manage_renameObject\',\n-          \'manage_renameObjects\', )),\n-    )\n-\n-    security.declareProtected(Permissions.copy_or_move, \'manage_copyObjects\')\n-\n-    def __init__(self, id, title=\'\'):\n-        DefaultDublinCoreImpl.__init__(self)\n-        self.id = id\n-        self.title = title\n-\n-    def __call__(self):\n-        """Invokes the default view."""\n-        ti = self.getTypeInfo()\n-        method_id = ti and ti.queryMethodId(\'(Default)\', context=self)\n-        if method_id:\n-            method = getattr(self, method_id)\n-            # XXX view is not defined!\n-            if getattr(aq_base(view), \'isDocTemp\', 0):\n-                return method(self, self.REQUEST, self.REQUEST[\'RESPONSE\'])\n-            else:\n-                return method()\n-        else:\n-            raise NotFound(\'Cannot find default view for "%s"\' %\n-                           \'/\'.join(self.getPhysicalPath()))\n-\n-    security.declareProtected(Permissions.view, \'view\')\n-    view = __call__\n-\n-    def index_html(self):\n-        """ Acquire if not present. """\n-        request = getattr(self, \'REQUEST\', None)\n-        if (\n-            request is not None\n-            and \'REQUEST_METHOD\' in request\n-            and request.maybe_webdav_client\n-        ):\n-            method = request[\'REQUEST_METHOD\']\n-            if bbb.HAS_ZSERVER and method in (\'PUT\', ):\n-                # Very likely a WebDAV client trying to create something\n-                result = NullResource(self, \'index_html\')\n-                setattr(result, \'__replaceable__\', REPLACEABLE)\n-                return result\n-            elif method not in (\'GET\', \'HEAD\', \'POST\'):\n-                raise AttributeError(\'index_html\')\n-        # Acquire from skin.\n-        _target = self.__getattr__(\'index_html\')\n-        result = aq_base(_target).__of__(self)\n-        setattr(result, \'__replaceable__\', REPLACEABLE)\n-        return result\n-\n-    index_html = ComputedAttribute(index_html, 1)\n-\n-    security.declareProtected(AddPortalFolders, \'manage_addPloneFolder\')\n-\n-    def manage_addPloneFolder(self, id, title=\'\', REQUEST=None):\n-        """Adds a new PloneFolder."""\n-        ob = PloneFolder(id, title)\n-        self._setObject(id, ob)\n-        if REQUEST is not None:\n-            # TODO HARDCODED FIXME!\n-            return self.folder_contents(self, REQUEST)\n-\n-    manage_addFolder = manage_addPloneFolder\n-    manage_renameObject = PortalFolderBase.manage_renameObject\n-\n-    security.declareProtected(Permissions.delete_objects, \'manage_delObjects\')\n-\n-    def manage_delObjects(self, ids=None, REQUEST=None):\n-        """We need to enforce security."""\n-        if ids is None:\n-            ids = []\n-        mt = getToolByName(self, \'portal_membership\')\n-        if isinstance(ids, str):\n-            ids = [ids]\n-        for id in ids:\n-            item = self._getOb(id)\n-            if not mt.checkPermission(Permissions.delete_objects, item):\n-                raise Unauthorized(\n-                    "Do not have permissions to remove this object")\n-        return PortalFolderBase.manage_delObjects(self, ids, REQUEST=REQUEST)\n-\n-    def __browser_default__(self, request):\n-        """Set default so we can return whatever we want instead\n-        of index_html."""\n-        return getToolByName(self, \'plone_utils\').browserDefault(self)\n-\n-    security.declarePublic(\'contentValues\')\n-\n-    def contentValues(self, filter=None, sort_on=None, reverse=0):\n-        # Able to sort on field.\n-        values = PortalFolderBase.contentValues(self, filter=filter)\n-        if sort_on is not None:\n-            values.sort(lambda x, y,\n-                        sort_on=sort_on: safe_cmp(getattr(x, sort_on),\n-                                                  getattr(y, sort_on)))\n-        if reverse:\n-            values.reverse()\n-\n-        return values\n-\n-    security.declareProtected(ListFolderContents, \'listFolderContents\')\n-\n-    def listFolderContents(self, contentFilter=None,\n-                           suppressHiddenFiles=0):\n-        # Optionally you can suppress "hidden" files, or files that\n-        # begin with \'.\'\n-        contents = PortalFolderBase.listFolderContents(self,\n-                                                       contentFilter=contentFilter)\n-        if suppressHiddenFiles:\n-            contents = [obj for obj in contents if obj.getId()[:1] != \'.\']\n-        return contents\n-\n-    security.declareProtected(AccessContentsInformation,\n-                              \'folderlistingFolderContents\')\n-\n-    def folderlistingFolderContents(self, contentFilter=None,\n-                                    suppressHiddenFiles=0):\n-        # Calls listFolderContents in protected only by ACI so that\n-        # folder_listing can work without the List folder contents permission.\n-        return self.listFolderContents(contentFilter, suppressHiddenFiles)\n-\n-    # Override CMFCore\'s invokeFactory to return the id returned by the\n-    # factory in case the factory modifies the id\n-    security.declareProtected(AddPortalContent, \'invokeFactory\')\n-\n-    def invokeFactory(self, type_name, id, RESPONSE=None, *args, **kw):\n-        # Invokes the portal_types tool.\n-        pt = getToolByName(self, \'portal_types\')\n-        myType = pt.getTypeInfo(self)\n-        if myType is not None:\n-            if not myType.allowType(type_name):\n-                raise ValueError(\'Disallowed subobject type: %s\' % type_name)\n-        args = (type_name, self, id, RESPONSE) + args\n-        new_id = pt.constructContent(*args, **kw)\n-        if new_id is None or new_id == \'\':\n-            new_id = id\n-        return new_id\n-\n-\n-InitializeClass(BasePloneFolder)\n-\n-\n-class PloneFolder(BasePloneFolder, OrderedContainer):\n-    """A Plone Folder."""\n-    meta_type = \'Plone Folder\'\n-    security = ClassSecurityInfo()\n-\n-    manage_renameObject = OrderedContainer.manage_renameObject\n-    security.declareProtected(Permissions.copy_or_move, \'manage_copyObjects\')\n-\n-InitializeClass(PloneFolder)\n-\n-\n-def safe_cmp(x, y):\n-    if callable(x):\n-        x = x()\n-    if callable(y):\n-        y = y()\n-    return cmp(x, y)\n-\n-\n-def addPloneFolder(self, id, title=\'\', description=\'\', REQUEST=None):\n-    """Adds a Plone Folder."""\n-    sf = PloneFolder(id, title=title)\n-    sf.description = description\n-    self._setObject(id, sf)\n-    if REQUEST is not None:\n-        REQUEST[\'RESPONSE\'].redirect(sf.absolute_url() + \'/manage_main\')\ndiff --git a/Products/CMFPlone/PloneTool.py b/Products/CMFPlone/PloneTool.py\nindex 5a8993c504..87f6c09683 100644\n--- a/Products/CMFPlone/PloneTool.py\n+++ b/Products/CMFPlone/PloneTool.py\n@@ -1,16 +1,17 @@\n from AccessControl import ClassSecurityInfo\n from AccessControl import getSecurityManager\n from AccessControl import Unauthorized\n+from AccessControl.class_init import InitializeClass\n from AccessControl.requestmethod import postonly\n from Acquisition import aq_base\n from Acquisition import aq_inner\n from Acquisition import aq_parent\n-from AccessControl.class_init import InitializeClass\n from ComputedAttribute import ComputedAttribute\n from DateTime import DateTime\n from email.utils import getaddresses\n from OFS.ObjectManager import bad_id\n from OFS.SimpleItem import SimpleItem\n+from plone.base.utils import safe_text\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.interfaces import IDublinCore\n from Products.CMFCore.interfaces import IMutableDublinCore\n@@ -24,22 +25,20 @@\n from Products.CMFCore.WorkflowCore import WorkflowException\n from Products.CMFDynamicViewFTI.interfaces import IBrowserDefault\n from Products.CMFPlone import utils\n-from Products.CMFPlone.defaultpage import check_default_page_via_view\n-from Products.CMFPlone.defaultpage import get_default_page_via_view\n+from plone.base.defaultpage import check_default_page_via_view\n+from plone.base.defaultpage import get_default_page_via_view\n from Products.CMFPlone.events import ReorderedEvent\n-from Products.CMFPlone.interfaces import INonStructuralFolder\n-from Products.CMFPlone.interfaces import IPloneTool\n-from Products.CMFPlone.interfaces import ISearchSchema\n-from Products.CMFPlone.interfaces import ISecuritySchema\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import INonStructuralFolder\n+from plone.base.interfaces import IPloneTool\n+from plone.base.interfaces import ISearchSchema\n+from plone.base.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISiteSchema\n+from Products.CMFPlone.log import log\n from Products.CMFPlone.log import log_deprecated\n+from Products.CMFPlone.log import log_exc\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n-from Products.CMFPlone.PloneFolder import ReplaceableWrapper\n from Products.CMFPlone.utils import base_hasattr\n-from Products.CMFPlone.utils import log\n-from Products.CMFPlone.utils import log_exc\n from Products.CMFPlone.utils import safe_hasattr\n-from Products.CMFPlone.utils import safe_unicode\n from Products.CMFPlone.utils import transaction_note\n from Products.statusmessages.interfaces import IStatusMessage\n from urllib import parse\n@@ -262,7 +261,7 @@ def _makeTransactionNote(self, obj, msg=\'\'):\n             msg = relative_path + \'/\' + obj.title_or_id() \\\n                 + \' has been modified.\'\n         if not transaction.get().description:\n-            transaction_note(safe_unicode(msg))\n+            transaction_note(safe_text(msg))\n \n     @security.public\n     def contentEdit(self, obj, **kwargs):\n@@ -324,11 +323,9 @@ def getIconFor(self, category, id, default=_marker, context=None):\n \n     @security.protected(View)\n     def getReviewStateTitleFor(self, obj):\n-        """Utility method that gets the workflow state title for the\n-        object\'s review_state.\n-\n-        Returns None if no review_state found.\n-        """\n+        # Utility method that gets the workflow state title for the\n+        # object\'s review_state.\n+        # Returns None if no review_state found.\n         wf_tool = getToolByName(self, \'portal_workflow\')\n         wfs = ()\n         objstate = None\n@@ -395,18 +392,17 @@ def fixOwnerRole(object, user_id):\n \n     @security.public\n     def urlparse(self, url):\n-        """Returns the pieces of url in a six-part tuple.\n-\n-        Since Python 2.6: urlparse now returns a ParseResult object.\n-        We just need the tuple form which is tuple(result).\n-        """\n+        # Returns the pieces of url in a six-part tuple.\n+        # Since Python 2.6: urlparse now returns a ParseResult object.\n+        # We just need the tuple form which is tuple(result).\n+        # Note: no docstring please, to avoid reflected XSS.\n         return tuple(parse.urlparse(url))\n \n     @security.public\n     def urlunparse(self, url_tuple):\n-        """Puts a url back together again, in the manner that\n-        urlparse breaks it.\n-        """\n+        # Puts a url back together again, in the manner that\n+        # urlparse breaks it.\n+        # Note: no docstring please, to avoid reflected XSS.\n         return parse.urlunparse(url_tuple)\n \n     # Enable scripts to get the string value of an exception even if the\n@@ -528,7 +524,7 @@ def isDefaultPage(self, obj, request=None):\n     @security.public\n     def getDefaultPage(self, obj, request=None):\n         # Given a folderish item, find out if it has a default-page using\n-        # the lookup rules of Plone (see Products.CMFPlone/defaultpage.py).\n+        # the lookup rules of Plone (see plone.base.defaultpage).\n         # Lookup happens over a view, for which in theory a different\n         # implementation may be used.\n         if request is None:\n@@ -539,30 +535,32 @@ def getDefaultPage(self, obj, request=None):\n \n     @security.public\n     def addPortalMessage(self, message, type=\'info\', request=None):\n-        """\\\n-        Call this once or more to add messages to be displayed at the\n-        top of the web page.\n-\n-        The arguments are:\n-            message:   a string, with the text message you want to show,\n-                       or a HTML fragment (see type=\'structure\' below)\n-            type:      optional, defaults to \'info\'. The type determines how\n-                       the message will be rendered, as it is used to select\n-                       the CSS class for the message. Predefined types are:\n-                       \'info\' - for informational messages\n-                       \'warning\' - for warning messages\n-                       \'error\' - for messages about restricted access or\n-                                 errors.\n-\n-        Portal messages are by default rendered by the global_statusmessage.pt\n-        page template.\n-\n-        It is also possible to add messages from page templates, as\n-        long as they are processed before the portal_message macro is\n-        called by the main template. Example:\n-\n-          <tal:block tal:define="temp python:context.plone_utils.addPortalMessage(\'A random info message\')" />  # noqa\n-        """\n+        # Call this once or more to add messages to be displayed at the\n+        # top of the web page.\n+\n+        # Note: no docstring please, to avoid reflected XSS.\n+        # This might not be possible, but type="structure" below sounds dangerous,\n+        # although I find no support for it in code.\n+\n+        # The arguments are:\n+        #     message:   a string, with the text message you want to show,\n+        #                or a HTML fragment (see type=\'structure\' below)\n+        #     type:      optional, defaults to \'info\'. The type determines how\n+        #                the message will be rendered, as it is used to select\n+        #                the CSS class for the message. Predefined types are:\n+        #                \'info\' - for informational messages\n+        #                \'warning\' - for warning messages\n+        #                \'error\' - for messages about restricted access or\n+        #                          errors.\n+\n+        # Portal messages are by default rendered by the global_statusmessage.pt\n+        # page template.\n+\n+        # It is also possible to add messages from page templates, as\n+        # long as they are processed before the portal_message macro is\n+        # called by the main template. Example:\n+\n+        #   <tal:block tal:define="temp python:context.plone_utils.addPortalMessage(\'A random info message\')" />  # noqa\n         if request is None:\n             request = self.REQUEST\n         IStatusMessage(request).add(message, type=type)\n@@ -580,44 +578,45 @@ def showPortalMessages(self, request=None):\n \n     @security.public\n     def browserDefault(self, obj):\n-        """Sets default so we can return whatever we want instead of index_html.\n-\n-        This method is complex, and interacts with mechanisms such as\n-        IBrowserDefault (implemented in CMFDynamicViewFTI), LinguaPlone and\n-        various mechanisms for setting the default page.\n-\n-        The method returns a tuple (obj, [path]) where path is a path to\n-        a template or other object to be acquired and displayed on the object.\n-        The path is determined as follows:\n-\n-        0. If we\'re c oming from WebDAV, make sure we don\'t return a contained\n-            object "default page" ever\n-        1. If there is an index_html attribute (either a contained object or\n-            an explicit attribute) on the object, return that as the\n-            "default page". Note that this may be used by things like\n-            File and Image to return the contents of the file, for example,\n-            not just content-space objects created by the user.\n-        2. If the object implements IBrowserDefault, query this for the\n-            default page.\n-        3. If the object has a property default_page set and this gives a list\n-            of, or single, object id, and that object is is found in the\n-            folder or is the name of a skin template, return that id\n-        4. If the property default_page is set in site_properties and that\n-            property contains a list of ids of which one id is found in the\n-            folder, return that id\n-        5. If the object implements IBrowserDefault, try to get the selected\n-            layout.\n-        6. If the type has a \'folderlisting\' action and no default page is\n-            set, use this action. This permits folders to have the default\n-            \'view\' action be \'string:${object_url}/\' and hence default to\n-            a default page when clicking the \'view\' tab, whilst allowing the\n-            fallback action to be specified TTW in portal_types (this action\n-            is typically hidden)\n-        7. If nothing else is found, fall back on the object\'s \'view\' action.\n-        8. If this is not found, raise an AttributeError\n-        """\n-\n-        # WebDAV in Zope is odd it takes the incoming verb eg: PROPFIND\n+        # Sets default so we can return whatever we want instead of index_html.\n+\n+        # Note: no docstring please, to avoid reflected XSS.\n+\n+        # This method is complex, and interacts with mechanisms such as\n+        # IBrowserDefault (implemented in CMFDynamicViewFTI), LinguaPlone and\n+        # various mechanisms for setting the default page.\n+\n+        # The method returns a tuple (obj, [path]) where path is a path to\n+        # a template or other object to be acquired and displayed on the object.\n+        # The path is determined as follows:\n+\n+        # 0. If we\'re c oming from WebDAV, make sure we don\'t return a contained\n+        #     object "default page" ever\n+        # 1. If there is an index_html attribute (either a contained object or\n+        #     an explicit attribute) on the object, return that as the\n+        #     "default page". Note that this may be used by things like\n+        #     File and Image to return the contents of the file, for example,\n+        #     not just content-space objects created by the user.\n+        # 2. If the object implements IBrowserDefault, query this for the\n+        #     default page.\n+        # 3. If the object has a property default_page set and this gives a list\n+        #     of, or single, object id, and that object is is found in the\n+        #     folder or is the name of a skin template, return that id\n+        # 4. If the property default_page is set in site_properties and that\n+        #     property contains a list of ids of which one id is found in the\n+        #     folder, return that id\n+        # 5. If the object implements IBrowserDefault, try to get the selected\n+        #     layout.\n+        # 6. If the type has a \'folderlisting\' action and no default page is\n+        #     set, use this action. This permits folders to have the default\n+        #     \'view\' action be \'string:${object_url}/\' and hence default to\n+        #     a default page when clicking the \'view\' tab, whilst allowing the\n+        #     fallback action to be specified TTW in portal_types (this action\n+        #     is typically hidden)\n+        # 7. If nothing else is found, fall back on the object\'s \'view\' action.\n+        # 8. If this is not found, raise an AttributeError\n+\n+        # 0. WebDAV in Zope is odd it takes the incoming verb eg: PROPFIND\n         # and then requests that object, for example for: /, with verb PROPFIND\n         # means acquire PROPFIND from the folder and call it\n         # its all very odd and WebDAV\'y\n@@ -630,20 +629,9 @@ def browserDefault(self, obj):\n         #\n         # 1. Get an attribute or contained object index_html\n         #\n-\n-        # Note: The base PloneFolder, as well as ATCT\'s ATCTOrderedFolder\n-        # defines a method index_html() which returns a ReplaceableWrapper.\n-        # This is needed for WebDAV to work properly, and to avoid implicit\n-        # acquisition of index_html\'s, which are generally on-object only.\n-        # For the purposes of determining a default page, we don\'t want to\n-        # use this index_html(), nor the ComputedAttribute which defines it.\n-\n-        if not isinstance(getattr(obj, \'index_html\', None),\n-                          ReplaceableWrapper):\n-            index_obj = getattr(aq_base(obj), \'index_html\', None)\n-            if index_obj is not None \\\n-                    and not isinstance(index_obj, ComputedAttribute):\n-                return obj, [\'index_html\']\n+        index_obj = getattr(aq_base(obj), \'index_html\', None)\n+        if index_obj is not None and not isinstance(index_obj, ComputedAttribute):\n+            return obj, [\'index_html\']\n \n         #\n         # 2. Look for a default_page managed by an IBrowserDefault-implementing\n@@ -777,7 +765,8 @@ def isLocalRoleAcquired(self, obj):\n \n     @security.public\n     def getOwnerName(self, obj):\n-        """ Returns the userid of the owner of an object."""\n+        # Returns the userid of the owner of an object.\n+        # Note: no docstring please, to avoid reflected XSS.\n         mt = getToolByName(self, \'portal_membership\')\n         if not mt.checkPermission(View, obj):\n             raise Unauthorized\n@@ -785,14 +774,14 @@ def getOwnerName(self, obj):\n \n     @security.public\n     def normalizeString(self, text):\n-        """Normalizes a title to an id.\n+        # Normalizes a title to an id.\n+        # Note: no docstring please, to avoid reflected XSS.\n \n-        The relaxed mode was removed in Plone 4.0. You should use either the\n-        url or file name normalizer from the plone.i18n package instead.\n+        # The relaxed mode was removed in Plone 4.0. You should use either the\n+        # url or file name normalizer from the plone.i18n package instead.\n \n-        normalizeString() converts a whole string to a normalized form that\n-        should be safe to use as in a url, as a css id, etc.\n-        """\n+        # normalizeString() converts a whole string to a normalized form that\n+        # should be safe to use as in a url, as a css id, etc.\n         return utils.normalizeString(text, context=self)\n \n     @security.public\n@@ -944,14 +933,10 @@ def reindexOnReorder(self, parent):\n         # but some extensions might need the info anyway. :(\n         notify(ReorderedEvent(parent))\n \n-    @security.public\n-    def isIDAutoGenerated(self, id):\n-        # Determine if an id is autogenerated.\n-        return utils.isIDAutoGenerated(self, id)\n-\n     @security.public\n     def getEmptyTitle(self, translated=True):\n-        """Returns string to be used for objects with no title or id."""\n+        # Returns string to be used for objects with no title or id.\n+        # Note: no docstring please, to avoid reflected XSS.\n         return utils.getEmptyTitle(self, translated)\n \n     @security.public\ndiff --git a/Products/CMFPlone/Portal.py b/Products/CMFPlone/Portal.py\nindex 60477253cb..a3057b0a6a 100644\n--- a/Products/CMFPlone/Portal.py\n+++ b/Products/CMFPlone/Portal.py\n@@ -1,49 +1,97 @@\n from AccessControl import ClassSecurityInfo\n-from AccessControl import Permissions\n from AccessControl import Unauthorized\n from AccessControl.class_init import InitializeClass\n from Acquisition import aq_base\n from ComputedAttribute import ComputedAttribute\n+from five.localsitemanager.registry import PersistentComponents\n from OFS.ObjectManager import REPLACEABLE\n+from plone.base import PloneMessageFactory as _\n+from plone.base.interfaces.siteroot import IPloneSiteRoot\n+from plone.base.interfaces.syndication import ISyndicatable\n+from plone.base.permissions import AddPortalContent\n+from plone.base.permissions import AddPortalFolders\n+from plone.base.permissions import ListPortalMembers\n+from plone.base.permissions import ModifyPortalContent\n+from plone.base.permissions import ReplyToItem\n+from plone.base.permissions import View\n+from plone.dexterity.content import Container\n from Products.CMFCore import permissions\n+from Products.CMFCore.interfaces import IContentish\n+from Products.CMFCore.interfaces import ISiteRoot\n+from Products.CMFCore.permissions import AccessContentsInformation\n+from Products.CMFCore.permissions import AddPortalMember\n+from Products.CMFCore.permissions import MailForgottenPassword\n+from Products.CMFCore.permissions import RequestReview\n+from Products.CMFCore.permissions import ReviewPortalContent\n+from Products.CMFCore.permissions import SetOwnPassword\n+from Products.CMFCore.permissions import SetOwnProperties\n+from Products.CMFCore.PortalFolder import PortalFolderBase\n from Products.CMFCore.PortalObject import PortalObjectBase\n-from Products.CMFCore.utils import UniqueObject\n+from Products.CMFCore.Skinnable import SkinnableObjectManager\n from Products.CMFCore.utils import _checkPermission\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFDynamicViewFTI.browserdefault import BrowserDefaultMixin\n-from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFCore.utils import UniqueObject\n from Products.CMFPlone import bbb\n-from Products.CMFPlone.DublinCore import DefaultDublinCoreImpl\n-from Products.CMFPlone.PloneFolder import OrderedContainer\n-from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot\n-from Products.CMFPlone.interfaces.syndication import ISyndicatable\n-from Products.CMFPlone.permissions import AddPortalContent\n-from Products.CMFPlone.permissions import AddPortalFolders\n-from Products.CMFPlone.permissions import ListPortalMembers\n-from Products.CMFPlone.permissions import ModifyPortalContent\n-from Products.CMFPlone.permissions import ReplyToItem\n-from Products.CMFPlone.permissions import View\n-from plone.i18n.locales.interfaces import IMetadataLanguageAvailability\n-from zope.component import queryUtility\n+from Products.Five.component.interfaces import IObjectManagerSite\n+from zope.event import notify\n+from zope.interface import classImplementsOnly\n+from zope.interface import implementedBy\n from zope.interface import implementer\n+from zope.interface.interfaces import ComponentLookupError\n+from zope.traversing.interfaces import BeforeTraverseEvent\n+\n \n if bbb.HAS_ZSERVER:\n     from webdav.NullResource import NullResource\n \n \n-@implementer(IPloneSiteRoot, ISyndicatable)\n-class PloneSite(PortalObjectBase, DefaultDublinCoreImpl, OrderedContainer,\n-                BrowserDefaultMixin, UniqueObject):\n+@implementer(IPloneSiteRoot, ISiteRoot, ISyndicatable, IObjectManagerSite)\n+class PloneSite(Container, SkinnableObjectManager, UniqueObject):\n     """ The Plone site object. """\n \n     security = ClassSecurityInfo()\n     meta_type = portal_type = \'Plone Site\'\n \n+    # Ensure certain attributes come from the correct base class.\n+    _checkId = SkinnableObjectManager._checkId\n+    manage_main = PortalFolderBase.manage_main\n+\n+    def __getattr__(self, name):\n+        try:\n+            # Try DX\n+            return super().__getattr__(name)\n+        except AttributeError:\n+            # Check portal_skins\n+            return SkinnableObjectManager.__getattr__(self, name)\n+\n+    def __setattr__(self, name, obj):\n+        # handle re setting an item as an attribute\n+        if self._tree is not None and name in self:\n+            del self[name]\n+            self[name] = obj\n+        else:\n+            super().__setattr__(name, obj)\n+\n+    def __delattr__(self, name):\n+        try:\n+            return super().__delattr__(name)\n+        except AttributeError:\n+            return self.__delitem__(name)\n+\n+    # Removes the \'Components Folder\'\n+\n     manage_options = (\n-        PortalObjectBase.manage_options[:2] +\n-        PortalObjectBase.manage_options[3:])\n+        Container.manage_options[:2] +\n+        Container.manage_options[3:])\n \n     __ac_permissions__ = (\n+        (AccessContentsInformation, ()),\n+        (AddPortalMember, ()),\n+        (SetOwnPassword, ()),\n+        (SetOwnProperties, ()),\n+        (MailForgottenPassword, ()),\n+        (RequestReview, ()),\n+        (ReviewPortalContent, ()),\n         (AddPortalContent, ()),\n         (AddPortalFolders, ()),\n         (ListPortalMembers, ()),\n@@ -53,13 +101,6 @@ class PloneSite(PortalObjectBase, DefaultDublinCoreImpl, OrderedContainer,\n                                \'manage_renameForm\', \'manage_renameObject\',\n                                \'manage_renameObjects\')))\n \n-    security.declareProtected(Permissions.copy_or_move, \'manage_copyObjects\')\n-\n-    manage_renameObject = OrderedContainer.manage_renameObject\n-\n-    moveObject = OrderedContainer.moveObject\n-    moveObjectsByDelta = OrderedContainer.moveObjectsByDelta\n-\n     # Switch off ZMI ordering interface as it assumes a slightly\n     # different functionality\n     has_order_support = 0\n@@ -73,9 +114,38 @@ class PloneSite(PortalObjectBase, DefaultDublinCoreImpl, OrderedContainer,\n     description = \'\'\n     icon = \'misc_/CMFPlone/tool.gif\'\n \n+    # From PortalObjectBase\n     def __init__(self, id, title=\'\'):\n-        PortalObjectBase.__init__(self, id, title)\n-        DefaultDublinCoreImpl.__init__(self)\n+        super(PloneSite, self).__init__(id, title=title)\n+        components = PersistentComponents(\'++etc++site\')\n+        components.__parent__ = self\n+        self.setSiteManager(components)\n+\n+    # From PortalObjectBase\n+    def __before_publishing_traverse__(self, arg1, arg2=None):\n+        """ Pre-traversal hook.\n+        """\n+        # XXX hack around a bug(?) in BeforeTraverse.MultiHook\n+        REQUEST = arg2 or arg1\n+\n+        try:\n+            notify(BeforeTraverseEvent(self, REQUEST))\n+        except ComponentLookupError:\n+            # allow ZMI access, even if the portal\'s site manager is missing\n+            pass\n+        self.setupCurrentSkin(REQUEST)\n+\n+        super(PloneSite, self).__before_publishing_traverse__(arg1, arg2)\n+\n+    # Concept from OFS.OrderSupport\n+    @security.protected(permissions.AccessContentsInformation)\n+    def tpValues(self):\n+        # Return a list of subobjects, used by ZMI tree tag (and only there).\n+        # see also https://github.com/plone/Products.CMFPlone/issues/3323\n+        return sorted(\n+            (obj for obj in self.objectValues() if getattr(aq_base(obj), \'isPrincipiaFolderish\', False)),\n+            key=lambda obj: obj.getId(),\n+        )\n \n     def __browser_default__(self, request):\n         """ Set default so we can return whatever we want instead\n@@ -112,8 +182,7 @@ def manage_beforeDelete(self, container, item):\n         PloneSite.inheritedAttribute(\'manage_beforeDelete\')(self, container,\n                                                             item)\n \n-    security.declareProtected(permissions.DeleteObjects, \'manage_delObjects\')\n-\n+    @security.protected(permissions.DeleteObjects)\n     def manage_delObjects(self, ids=None, REQUEST=None):\n         """We need to enforce security."""\n         if ids is None:\n@@ -133,9 +202,7 @@ def view(self):\n         """\n         return self()\n \n-    security.declareProtected(permissions.AccessContentsInformation,\n-                              \'folderlistingFolderContents\')\n-\n+    @security.protected(permissions.AccessContentsInformation)\n     def folderlistingFolderContents(self, contentFilter=None):\n         """Calls listFolderContents in protected only by ACI so that\n         folder_listing can work without the List folder contents permission.\n@@ -145,32 +212,13 @@ def folderlistingFolderContents(self, contentFilter=None):\n         """\n         return self.listFolderContents(contentFilter)\n \n-    security.declarePublic(\'availableLanguages\')\n-\n-    def availableLanguages(self):\n-        util = queryUtility(IMetadataLanguageAvailability)\n-        languages = util.getLanguageListing()\n-        languages.sort(lambda x, y: cmp(x[1], y[1]))\n-        # Put language neutral at the top.\n-        languages.insert(0, (\'\', _(\'Language neutral (site default)\')))\n-\n-        return languages\n-\n     def isEffective(self, date):\n         # Override DefaultDublinCoreImpl\'s test, since we are always viewable.\n         return 1\n \n-    # Ensure portals don\'t get cataloged.\n-    def indexObject(self):\n-        pass\n-\n-    def unindexObject(self):\n-        pass\n-\n-    def reindexObject(self, idxs=None):\n-        pass\n \n-    def reindexObjectSecurity(self, skip_self=False):\n-        pass\n+# Remove the IContentish interface so we don\'t listen to events that won\'t\n+# apply to the site root, ie handleUidAnnotationEvent\n+classImplementsOnly(PloneSite, implementedBy(PloneSite) - IContentish)\n \n InitializeClass(PloneSite)\ndiff --git a/Products/CMFPlone/PropertiesTool.py b/Products/CMFPlone/PropertiesTool.py\nindex 7ceebf2583..d8ce537a1d 100644\n--- a/Products/CMFPlone/PropertiesTool.py\n+++ b/Products/CMFPlone/PropertiesTool.py\n@@ -12,7 +12,7 @@\n from OFS.SimpleItem import SimpleItem\n from AccessControl import ClassSecurityInfo\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n-from Products.CMFPlone.interfaces \\\n+from plone.base.interfaces \\\n     import IPropertiesTool, ISimpleItemWithProperties\n from Products.CMFPlone.utils import WWW_DIR\n from Products.MailHost.interfaces import IMailHost\ndiff --git a/Products/CMFPlone/RegistrationTool.py b/Products/CMFPlone/RegistrationTool.py\nindex 93dc132e4a..fa17f700ad 100644\n--- a/Products/CMFPlone/RegistrationTool.py\n+++ b/Products/CMFPlone/RegistrationTool.py\n@@ -9,18 +9,18 @@\n from Acquisition import aq_chain\n from email import message_from_string\n from hashlib import md5\n+from plone.base import PloneMessageFactory as _\n+from plone.base.interfaces import ISecuritySchema\n+from plone.base.permissions import ManagePortal\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.interfaces import ISiteRoot\n from Products.CMFCore.permissions import AddPortalMember\n from Products.CMFCore.RegistrationTool import RegistrationTool as BaseTool\n from Products.CMFCore.utils import _checkPermission\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import ISecuritySchema\n-from Products.CMFPlone.permissions import ManagePortal\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from Products.CMFPlone.PloneTool import EMAIL_RE\n-from Products.PluggableAuthService.interfaces.authservice import IPluggableAuthService  # noqa: E501\n+from Products.PluggableAuthService.interfaces.authservice import IPluggableAuthService\n from Products.PluggableAuthService.interfaces.plugins import IValidationPlugin\n from Products.PluggableAuthService.permissions import SetOwnPassword\n from smtplib import SMTPException\ndiff --git a/Products/CMFPlone/TranslationServiceTool.py b/Products/CMFPlone/TranslationServiceTool.py\nindex 6298e3b69e..086af2ae6a 100644\n--- a/Products/CMFPlone/TranslationServiceTool.py\n+++ b/Products/CMFPlone/TranslationServiceTool.py\n@@ -15,9 +15,9 @@\n from .i18nl10n import weekdayname_msgid_abbr\n from .i18nl10n import weekdayname_msgid_short\n from OFS.SimpleItem import SimpleItem\n+from plone.base import PloneLocalesMessageFactory as PLMF\n from Products.CMFCore.utils import UniqueObject\n-from Products.CMFPlone import PloneLocalesMessageFactory as PLMF\n-from Products.CMFPlone.interfaces import ITranslationServiceTool\n+from plone.base.interfaces import ITranslationServiceTool\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from zope.i18n import translate\n from zope.interface import implementer\ndiff --git a/Products/CMFPlone/WorkflowTool.py b/Products/CMFPlone/WorkflowTool.py\nindex 31a9cf8203..7085bb42c5 100644\n--- a/Products/CMFPlone/WorkflowTool.py\n+++ b/Products/CMFPlone/WorkflowTool.py\n@@ -2,7 +2,7 @@\n \n from Products.CMFCore.utils import getToolByName\n from Products.CMFCore.WorkflowTool import WorkflowTool as BaseTool\n-from Products.CMFPlone.interfaces import IWorkflowChain\n+from plone.base.interfaces import IWorkflowChain\n from ZODB.POSException import ConflictError\n from Acquisition import aq_base\n \ndiff --git a/Products/CMFPlone/__init__.py b/Products/CMFPlone/__init__.py\nindex 1a53d1856c..207ba2cdec 100644\n--- a/Products/CMFPlone/__init__.py\n+++ b/Products/CMFPlone/__init__.py\n@@ -1,7 +1,9 @@\n from App.ImageFile import ImageFile\n+\n import os\n import sys\n import pkg_resources\n+import zope.deferredimport\n \n __version__ = pkg_resources.require("Products.CMFPlone")[0].version\n \n@@ -15,8 +17,16 @@\n     os.path.join(\'skins\', \'plone_images\', \'logoIcon.png\'),\n     cmfplone_globals)}\n \n-DISCUSSION_ANNOTATION_KEY = \'plone.app.discussion:conversation\'\n-\n+zope.deferredimport.initialize()\n+zope.deferredimport.deprecated(\n+    "Import from plone.base instead (to be removed in Plone 7)",\n+    PloneMessageFactory=\'plone.base:PloneMessageFactory\',\n+    PloneLocalesMessageFactory=\'plone.base:PloneMessageFactory\',\n+)\n+zope.deferredimport.deprecated(\n+    "Import from plone.app.discussion.interfaces instead (to be removed in Plone 7)",\n+    DISCUSSION_ANNOTATION_KEY=\'plone.app.discussion.interfaces:DISCUSSION_ANNOTATION_KEY\',\n+)\n \n def initialize(context):\n \n@@ -61,6 +71,7 @@ def initialize(context):\n     allow_class(ObjectMoved)\n     allow_class(WorkflowException)\n \n+    # bbb - remove in Plone 7\n     from Products.CMFPlone.PloneBatch import Batch\n     allow_class(Batch)\n \n@@ -112,6 +123,9 @@ def initialize(context):\n     # Make cgi.escape available TTW\n     ModuleSecurityInfo(\'cgi\').declarePublic(\'escape\')\n \n+    # Make warnings available TTW\n+    ModuleSecurityInfo(\'warnings\').declarePublic(\'warn\')\n+\n     # Apply monkey patches\n     from Products.CMFPlone import patches  # noqa\n \n@@ -119,14 +133,6 @@ def initialize(context):\n     # pipeline registry\n     from Products.CMFPlone import UnicodeSplitter  # noqa\n \n-    # Plone content\n-\n-    # Usage of PloneFolder is discouraged.\n-    from Products.CMFPlone import PloneFolder\n-\n-    contentClasses = (PloneFolder.PloneFolder, )\n-    contentConstructors = (PloneFolder.addPloneFolder, )\n-\n     # CMFCore tools\n     from Products.CMFCore import CachingPolicyManager\n \n@@ -170,12 +176,6 @@ def initialize(context):\n         icon=\'tool.gif\',\n     ).initialize(context)\n \n-    ContentInit(\n-        \'Plone Content\',\n-        content_types=contentClasses,\n-        permission=ADD_CONTENT_PERMISSION,\n-        extra_constructors=contentConstructors,\n-    ).initialize(context)\n \n     from AccessControl.Permissions import view_management_screens\n     from Products.CMFPlone.Portal import PloneSite\n@@ -196,16 +196,7 @@ def initialize(context):\n         visibility=None\n     )\n \n-\n-# Import PloneMessageFactory to create messages in the plone domain\n-from zope.i18nmessageid import MessageFactory\n-PloneMessageFactory = MessageFactory(\'plone\')\n-\n-# Import PloneLocalesMessageFactory to create messages in the\n-# plonelocales domain\n-from zope.i18nmessageid import MessageFactory\n-PloneLocalesMessageFactory = MessageFactory(\'plonelocales\')\n-\n # Apply early monkey patches.  For these patches, it is too late if we do this\n # in the initialize method.\n from Products.CMFPlone import earlypatches  # noqa\n+\ndiff --git a/Products/CMFPlone/_compat.py b/Products/CMFPlone/_compat.py\ndeleted file mode 100644\nindex 283564f68a..0000000000\n--- a/Products/CMFPlone/_compat.py\n+++ /dev/null\n@@ -1,10 +0,0 @@\n-from json import dumps\n-\n-\n-def dump_json_to_text(obj):\n-    \'\'\' Encode an obj into a text\n-    \'\'\'\n-    text = dumps(obj, indent=4)\n-    if not isinstance(text, str):\n-        text = text.decode(\'utf8\')\n-    return text\ndiff --git a/Products/CMFPlone/browser/admin.py b/Products/CMFPlone/browser/admin.py\nindex 6fab229341..e7728186d3 100644\n--- a/Products/CMFPlone/browser/admin.py\n+++ b/Products/CMFPlone/browser/admin.py\n@@ -1,23 +1,23 @@\n from AccessControl import getSecurityManager\n from AccessControl.Permissions import view as View\n+from collections import OrderedDict\n from OFS.interfaces import IApplication\n+from plone.base.interfaces import INonInstallable\n+from plone.base.interfaces import IPloneSiteRoot\n+from plone.base.utils import get_installer\n+from plone.i18n.locales.interfaces import IContentLanguageAvailability\n+from plone.keyring.interfaces import IKeyManager\n+from plone.protect.authenticator import check as checkCSRF\n+from plone.protect.interfaces import IDisableCSRFProtection\n from Products.CMFCore.permissions import ManagePortal\n from Products.CMFPlone.factory import _DEFAULT_PROFILE\n from Products.CMFPlone.factory import addPloneSite\n-from Products.CMFPlone.interfaces import INonInstallable\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n-from Products.CMFPlone.utils import get_installer\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.GenericSetup import BASE, EXTENSION\n from Products.GenericSetup import profile_registry\n from Products.GenericSetup.upgrade import normalize_version\n-from ZPublisher.BaseRequest import DefaultPublishTraverse\n-from collections import OrderedDict\n-from plone.i18n.locales.interfaces import IContentLanguageAvailability\n-from plone.keyring.interfaces import IKeyManager\n-from plone.protect.authenticator import check as checkCSRF\n-from plone.protect.interfaces import IDisableCSRFProtection\n from urllib import parse\n+from ZODB.broken import Broken\n from zope.component import adapts\n from zope.component import getAllUtilitiesRegisteredFor\n from zope.component import getUtility\n@@ -25,13 +25,22 @@\n from zope.component import queryUtility\n from zope.i18n.interfaces import IUserPreferredLanguages\n from zope.i18n.locales import locales, LoadLocaleError\n-from zope.interface import Interface\n from zope.interface import alsoProvides\n+from zope.interface import Interface\n from zope.publisher.browser import BrowserView\n from zope.publisher.interfaces import IRequest\n from zope.schema.interfaces import IVocabularyFactory\n+from ZPublisher.BaseRequest import DefaultPublishTraverse\n \n import logging\n+import pkg_resources\n+\n+\n+try:\n+    pkg_resources.get_distribution("plone.volto")\n+    HAS_VOLTO = True\n+except pkg_resources.DistributionNotFound:\n+    HAS_VOLTO = False\n LOGGER = logging.getLogger(\'Products.CMFPlone\')\n \n \n@@ -48,6 +57,7 @@ def publishTraverse(self, request, name):\n \n \n class Overview(BrowserView):\n+    has_volto = HAS_VOLTO\n \n     def sites(self, root=None):\n         if root is None:\n@@ -55,7 +65,10 @@ def sites(self, root=None):\n \n         result = []\n         secman = getSecurityManager()\n-        for obj in root.values():\n+        candidates = (\n+            obj for obj in root.values() if not isinstance(obj, Broken)\n+        )\n+        for obj in candidates:\n             if obj.meta_type == \'Folder\':\n                 result = result + self.sites(obj)\n             elif IPloneSiteRoot.providedBy(obj):\n@@ -66,7 +79,12 @@ def sites(self, root=None):\n         return result\n \n     def outdated(self, obj):\n-        mig = obj.get(\'portal_migration\', None)\n+        # Try to pick the portal_migration as an attribute\n+        # (Plone 5 unmigrated site root) or as an item\n+        mig = (\n+            getattr(obj, "portal_migration", None)\n+            or obj.get(\'portal_migration\', None)\n+        )\n         if mig is not None:\n             return mig.needUpgrading()\n         return False\n@@ -137,10 +155,22 @@ class AddPloneSite(BrowserView):\n         \'plone.app.caching:default\',\n         \'plonetheme.barceloneta:default\',\n     )\n+    # Let\'s have a separate list for Volto.\n+    volto_default_extension_profiles = (\n+        \'plone.app.caching:default\',\n+        # We could choose to not install Barceloneta:\n+        \'plonetheme.barceloneta:default\',\n+        \'plone.volto:default\',\n+        \'plone.volto:default-homepage\'\n+    )\n \n     def profiles(self):\n         base_profiles = []\n         extension_profiles = []\n+        if HAS_VOLTO and not self.request.get(\'classic\'):\n+            selected_extension_profiles = self.volto_default_extension_profiles\n+        else:\n+            selected_extension_profiles = self.default_extension_profiles\n \n         # profiles available for install/uninstall, but hidden at the time\n         # the Plone site is created\n@@ -156,7 +186,7 @@ def profiles(self):\n                info.get(\'for\') in (IPloneSiteRoot, None):\n                 profile_id = info.get(\'id\')\n                 if profile_id not in not_installable:\n-                    if profile_id in self.default_extension_profiles:\n+                    if profile_id in selected_extension_profiles:\n                         info[\'selected\'] = \'selected\'\n                     extension_profiles.append(info)\n \n@@ -308,15 +338,21 @@ def __call__(self):\n                 REQUEST=self.request,\n                 dry_run=form.get(\'dry_run\', False),\n             )\n-            qi = get_installer(self.context, self.request)\n-            pac_installed = qi.is_product_installed(\'plone.app.contenttypes\')\n-            pac_installable = qi.is_product_installable(\n-                \'plone.app.contenttypes\')\n-            advertise_dx_migration = pac_installable and not pac_installed\n-\n             return self.index(\n                 report=report,\n-                advertise_dx_migration=advertise_dx_migration\n             )\n \n         return self.index()\n+\n+    def can_migrate_to_volto(self):\n+        if not HAS_VOLTO:\n+            return False\n+        pm = getattr(self.context, \'portal_migration\')\n+        if pm.getInstanceVersion() < "6005":\n+            return False\n+        try:\n+            from plone.volto.browser import migrate_to_volto\n+        except ImportError:\n+            return False\n+        installer = get_installer(self.context, self.request)\n+        return not installer.is_product_installed("plone.volto")\ndiff --git a/Products/CMFPlone/browser/admin.zcml b/Products/CMFPlone/browser/admin.zcml\nindex 12228bfc20..fdde628d17 100644\n--- a/Products/CMFPlone/browser/admin.zcml\n+++ b/Products/CMFPlone/browser/admin.zcml\n@@ -2,7 +2,7 @@\n            xmlns:browser="http://namespaces.zope.org/browser">\n \n   <browser:view\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       name="plone-frontpage-setup"\n       class=".admin.FrontPage"\n       permission="zope.Public"\n@@ -25,7 +25,7 @@\n       />\n \n   <browser:page\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       name="plone-upgrade"\n       class=".admin.Upgrade"\n       permission="cmf.ManagePortal"\ndiff --git a/Products/CMFPlone/browser/atd.py b/Products/CMFPlone/browser/atd.py\nindex 05fe5a35c2..a4dc2d4201 100644\n--- a/Products/CMFPlone/browser/atd.py\n+++ b/Products/CMFPlone/browser/atd.py\n@@ -2,8 +2,8 @@\n from zope.component import getUtility\n from plone.registry.interfaces import IRegistry\n from http import client as http_client\n-from Products.CMFPlone.interfaces import ITinyMCESchema\n-from Products.CMFPlone.interfaces.atd import IATDProxyView\n+from plone.base.interfaces import ITinyMCESchema\n+from plone.base.interfaces.atd import IATDProxyView\n from zope.interface import implementer\n \n \ndiff --git a/Products/CMFPlone/browser/author.py b/Products/CMFPlone/browser/author.py\nindex 3247e3585c..05d92acabf 100644\n--- a/Products/CMFPlone/browser/author.py\n+++ b/Products/CMFPlone/browser/author.py\n@@ -2,8 +2,8 @@\n \n from Products.CMFCore.interfaces import IPropertiesTool\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import ISecuritySchema\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+from plone.base.interfaces import ISecuritySchema\n+from plone.base.interfaces.controlpanel import IMailSchema\n from Products.CMFPlone.utils import getToolByName\n from Products.CMFPlone.utils import pretty_title_or_id\n from Products.Five.browser import BrowserView\ndiff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml\nindex 0e5d916fc8..4c3152dd4f 100644\n--- a/Products/CMFPlone/browser/configure.zcml\n+++ b/Products/CMFPlone/browser/configure.zcml\n@@ -21,8 +21,8 @@\n       title="Allow sendto" />\n \n   <browser:resource\n-      file="static/plone-logo.png"\n-      name="plone-logo.png"\n+      file="static/plone-logo.svg"\n+      name="plone-logo.svg"\n       />\n \n   <browser:page\n@@ -32,6 +32,13 @@\n       permission="zope.Public"\n       />\n \n+  <browser:page\n+      for="plone.app.layout.navigation.interfaces.INavigationRoot"\n+      name="favicon.ico"\n+      class=".favicon.SiteFavicon"\n+      permission="zope.Public"\n+      />\n+\n   <browser:page\n       for="*"\n       name="sendto_form"\n@@ -92,6 +99,7 @@\n       for="*"\n       name="main_template"\n       class=".main_template.MainTemplate"\n+      allowed_interface=".interfaces.IMainTemplate"\n       permission="zope.Public"\n       />\n \n@@ -131,7 +139,7 @@\n       />\n \n   <browser:page\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       name="author"\n       class=".author.AuthorView"\n       permission="zope.Public"\n@@ -139,7 +147,7 @@\n       />\n \n   <browser:page\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       name="author-feedback-template"\n       permission="zope.Public"\n       template="templates/author_feedback_template.pt"\n@@ -210,11 +218,6 @@\n       for="plone.app.layout.navigation.interfaces.INavigationRoot"\n       />\n \n-  <browser:resource\n-      name="search.js"\n-      file="static/search.js"\n-      />\n-\n   <!-- AtD Support -->\n   <browser:page\n       for="*"\n@@ -230,7 +233,7 @@\n       name="default_page"\n       class=".defaultpage.DefaultPage"\n       permission="zope.Public"\n-      allowed_interface="Products.CMFPlone.interfaces.defaultpage.IDefaultPage"\n+      allowed_interface="plone.base.interfaces.defaultpage.IDefaultPage"\n       />\n \n   <browser:page\n@@ -256,4 +259,53 @@\n       layer="zope.interface.Interface"\n       />\n \n+  <browser:page\n+      name="test_rendering"\n+      for="*"\n+      class=".test_rendering.TestRenderingView"\n+      permission="zope2.View"\n+      />\n+\n+  <browser:page\n+      name="test-rendering"\n+      for="*"\n+      class=".test_rendering.TestRenderingView"\n+      permission="zope2.View"\n+      />\n+\n+  <browser:page\n+      name="test-rendering-cheatsheet"\n+      for="*"\n+      class=".test_rendering.TestRenderingCheatsheetView"\n+      permission="zope2.View"\n+      />\n+\n+  <browser:page\n+      name="test-rendering-icons"\n+      for="*"\n+      class=".test_rendering.TestRenderingIconsView"\n+      permission="zope2.View"\n+      />\n+\n+  <browser:page\n+      for="*"\n+      name="iconresolver"\n+      class=".icons.IconsView"\n+      permission="zope.Public"\n+      />\n+\n+  <browser:page\n+      for="*"\n+      name="recently_modified"\n+      template="templates/recently_modified.pt"\n+      permission="zope2.View"\n+      />\n+\n+  <browser:page\n+      for="*"\n+      name="recently_published"\n+      template="templates/recently_published.pt"\n+      permission="zope2.View"\n+      />\n+\n </configure>\ndiff --git a/Products/CMFPlone/browser/contact_info.py b/Products/CMFPlone/browser/contact_info.py\nindex 9d8067f323..1c2dcd3fc5 100644\n--- a/Products/CMFPlone/browser/contact_info.py\n+++ b/Products/CMFPlone/browser/contact_info.py\n@@ -1,7 +1,7 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.browser.interfaces import IContactForm\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+from plone.base.interfaces.controlpanel import IMailSchema\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n from email.mime.text import MIMEText\ndiff --git a/Products/CMFPlone/browser/defaultpage.py b/Products/CMFPlone/browser/defaultpage.py\nindex 57446ec69a..b8523814e3 100644\n--- a/Products/CMFPlone/browser/defaultpage.py\n+++ b/Products/CMFPlone/browser/defaultpage.py\n@@ -1,7 +1,7 @@\n from Acquisition import aq_inner\n-from Products.CMFPlone.interfaces.defaultpage import IDefaultPage\n-from Products.CMFPlone.defaultpage import get_default_page\n-from Products.CMFPlone.defaultpage import is_default_page\n+from plone.base.interfaces.defaultpage import IDefaultPage\n+from plone.base.defaultpage import get_default_page\n+from plone.base.defaultpage import is_default_page\n from Products.Five.browser import BrowserView\n from zope.interface import implementer\n \ndiff --git a/Products/CMFPlone/browser/favicon.py b/Products/CMFPlone/browser/favicon.py\nnew file mode 100644\nindex 0000000000..a6812cfb84\n--- /dev/null\n+++ b/Products/CMFPlone/browser/favicon.py\n@@ -0,0 +1,41 @@\n+from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.formwidget.namedfile.converter import b64decode_file\n+from plone.memoize import ram\n+from plone.namedfile.browser import DisplayFile\n+from plone.namedfile.file import NamedImage\n+from plone.registry.interfaces import IRegistry\n+from zope.component import getUtility\n+\n+import os.path\n+\n+\n+class SiteFavicon(DisplayFile):\n+    # The following attribute disables the use of an allowlist that\n+    # would otherwise cause image/vnd.microsoft.icon MIMEtyped files\n+    # to be served as downloads.  This allowlist list is sadly not\n+    # complete, at the top of the plone.namedfile.browser.py, but\n+    # fixing that is beyond the scope of this pull request.\n+    use_denylist = True\n+\n+    def __init__(self, context, request):\n+        super().__init__(context, request)\n+\n+        mimetype = "image/vnd.microsoft.icon"\n+        settings = getUtility(IRegistry).forInterface(ISiteSchema, prefix="plone")\n+        if getattr(settings, "site_favicon", False):\n+            # The user has customized the favicon via the Site configlet.\n+            filename, data = b64decode_file(settings.site_favicon)\n+            # Retrieve the MIME type auto-set by the configlet, with a\n+            # valid fallback to a well-known MIME type.\n+            mimetype = getattr(settings, "site_favicon_mimetype", mimetype)\n+        else:\n+            # No registry favicon, we use Plone\'s static copy here.\n+            filename = "favicon.ico"\n+            fallback_path = os.path.join(os.path.dirname(__file__), "static", filename)\n+            with open(fallback_path, "rb") as icon:\n+                data = icon.read()\n+        self.data = NamedImage(data=data, contentType=mimetype, filename=filename)\n+        self.filename = filename\n+\n+    def _getFile(self):\n+        return self.data\ndiff --git a/Products/CMFPlone/browser/icons.py b/Products/CMFPlone/browser/icons.py\nnew file mode 100644\nindex 0000000000..572fe3cf1c\n--- /dev/null\n+++ b/Products/CMFPlone/browser/icons.py\n@@ -0,0 +1,138 @@\n+# -*- coding: utf-8 -*-\n+from lxml import etree\n+from OFS.Image import File\n+from plone.registry.interfaces import IRegistry\n+from Products.Five.browser import BrowserView\n+from Products.CMFCore.interfaces import ISiteRoot\n+from zExceptions import NotFound\n+from zope.component import adapter\n+from zope.component import getUtility\n+from zope.component.hooks import getSite\n+from zope.interface import implementer\n+from zope.interface import Interface\n+from zope.location.interfaces import LocationError\n+from zope.traversing.interfaces import ITraversable\n+from zope.publisher.interfaces import IPublishTraverse\n+from zExceptions import NotFound\n+\n+import logging\n+\n+logger = logging.getLogger(__name__)\n+\n+\n+SVG_MODIFER = {}\n+\n+def _add_aria_title(svgtree, cfg):\n+    if not cfg.get("title"):\n+        return\n+    root = svgtree.getroot()\n+    ns = root.nsmap.get(None, "")\n+    # set title tag\n+    title = root.find(f\'{{{ns}}}title\')\n+    if title is None:\n+        title = etree.Element("title")\n+        root.append(title)\n+    title.text = cfg[\'title\']\n+    # add aria attr\n+    root.attrib["aria-labelledby"] = "title"\n+\n+\n+SVG_MODIFER[\'add_aria_title\'] = _add_aria_title\n+\n+ADDITIONAL_CLASSES = [\n+    # this classes are added to all svg root elements\n+    "plone-icon",\n+]\n+\n+def _add_css_class(svgtree, cfg):\n+    cssclass = cfg.get(\'cssclass\', "")\n+    root = svgtree.getroot()\n+    current = root.attrib.get(\'class\', \'\')\n+    root.attrib[\'class\'] = f"{\' \'.join(ADDITIONAL_CLASSES)} {cfg[\'cssclass\']} {current}"\n+\n+SVG_MODIFER[\'add_css_class\'] = _add_css_class\n+\n+def _strip_id(svgtree, cfg):\n+    for el in svgtree.getroot().xpath("//*[@id]"):\n+        del el.attrib["id"]\n+\n+SVG_MODIFER[\'strip_id\'] = _strip_id\n+\n+\n+@implementer(IPublishTraverse)\n+class IconsView(BrowserView):\n+\n+    prefix = "plone.icon."\n+    defaulticon = "++plone++icons/plone.svg"\n+    name = ""\n+\n+    def publishTraverse(self, request, name):\n+        if self.name:\n+            # fix traversing to eg. "contenttype/document"\n+            self.name += "/"\n+        self.name += name\n+        return self\n+\n+    def __call__(self):\n+        name = getattr(self, "name", None)\n+        if name is None:\n+            raise NotFound("No name were given as subpath.")\n+        fileobj = self._iconfile(self.lookup(self.name))\n+        return fileobj(REQUEST=self.request, RESPONSE=self.request.response)\n+\n+    def _iconfile(self, icon):\n+        site = getSite()\n+        try:\n+            return site.restrictedTraverse(icon)\n+        except NotFound:\n+            logger.exception(\n+                f"Icon resolver lookup of \'{icon}\' failed, fallback to Plone icon."\n+            )\n+            return site.restrictedTraverse(self.defaulticon)\n+\n+    def lookup(self, name):\n+        __traceback_info__ = name\n+        registry = getUtility(IRegistry)\n+        regkey = self.prefix + name\n+        try:\n+            return registry[regkey]\n+        except KeyError:\n+            if "/" in name:\n+                main, tail = name.rsplit("/", 1)\n+                return self.lookup(main)\n+            logger.info(\n+                f"Icon resolver lookup of \'{name}\' failed, fallback to Plone icon."\n+            )\n+            return self.defaulticon\n+\n+    def url(self, name):\n+        url = getSite().absolute_url() + "/" + self.lookup(name)\n+        return url\n+\n+    def tag(self, name, tag_class="", tag_alt=""):\n+        icon = self.lookup(name)\n+        if not icon.endswith(".svg"):\n+            return f\'<img src="{self.url(name)}" class="{tag_class}" alt="{tag_alt}" />\'\n+\n+        iconfile = self._iconfile(icon)\n+        if isinstance(iconfile, File):\n+            raise NotImplementedError(\n+                "Resolve icons stored in database is not yet implemented."\n+            )\n+        try:\n+            with open(iconfile.path, "rb") as fh:\n+                svgtree = etree.parse(fh)\n+        except etree.XMLSyntaxError:\n+            logger.exception(f"SVG File: {iconfile.path}")\n+            with open(iconfile.path, "rb") as fh:\n+                return fh.read()\n+        if svgtree.docinfo.root_name.lower() != \'svg\':\n+            raise ValueError(f"SVG file content root tag mismatch (not svg but {svgtree.docinfo.root_name}): {iconfile.path}")\n+        modifier_cfg = {\n+            \'cssclass\': tag_class,\n+            \'title\': tag_alt,\n+        }\n+        for name, modifier in SVG_MODIFER.items():\n+            __traceback_info__ = name\n+            modifier(svgtree, modifier_cfg)\n+        return etree.tostring(svgtree)\ndiff --git a/Products/CMFPlone/browser/interfaces.py b/Products/CMFPlone/browser/interfaces.py\nindex 404b172258..9a09561e91 100644\n--- a/Products/CMFPlone/browser/interfaces.py\n+++ b/Products/CMFPlone/browser/interfaces.py\n@@ -1,4 +1,5 @@\n from zope import schema\n+from zope.interface import Attribute\n from zope.interface import Interface\n \n from plone.schema import Email\n@@ -189,6 +190,9 @@ def createSiteMap():\n class IMainTemplate(Interface):\n     """Interface to the view that generated the main_template"""\n \n+    macros = Attribute("Macros")\n+    template_name = Attribute("Template name")\n+\n \n class IGlobalStatusMessage(Interface):\n     """Interface to the view that generated the main_template"""\ndiff --git a/Products/CMFPlone/browser/login/configure.zcml b/Products/CMFPlone/browser/login/configure.zcml\nindex f576522ac8..a3aeb79489 100644\n--- a/Products/CMFPlone/browser/login/configure.zcml\n+++ b/Products/CMFPlone/browser/login/configure.zcml\n@@ -145,7 +145,7 @@\n \n     <browser:page\n         name="explainPWResetTool"\n-        for="Products.CMFPlone.interfaces.IPWResetTool"\n+        for="plone.base.interfaces.IPWResetTool"\n         class=".password_reset.ExplainPWResetToolView"\n         template="templates/explainPWResetTool.pt"\n         permission="zope2.ViewManagementScreens"\ndiff --git a/Products/CMFPlone/browser/login/login.py b/Products/CMFPlone/browser/login/login.py\nindex 2add8a3122..d655c226ea 100644\n--- a/Products/CMFPlone/browser/login/login.py\n+++ b/Products/CMFPlone/browser/login/login.py\n@@ -3,12 +3,12 @@\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import IForcePasswordChange\n-from Products.CMFPlone.interfaces import IInitialLogin\n-from Products.CMFPlone.interfaces import ILoginForm\n-from Products.CMFPlone.interfaces import ILoginFormSchema\n-from Products.CMFPlone.interfaces import IRedirectAfterLogin\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import IForcePasswordChange\n+from plone.base.interfaces import IInitialLogin\n+from plone.base.interfaces import ILoginForm\n+from plone.base.interfaces import ILoginFormSchema\n+from plone.base.interfaces import IRedirectAfterLogin\n+from plone.base.interfaces import ISecuritySchema\n from Products.Five.browser import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\n from urllib import parse\n@@ -90,22 +90,24 @@ def _get_auth(self):\n                 pass\n \n     def updateWidgets(self):\n+        super().updateWidgets(prefix=\'\')\n+\n         auth = self._get_auth()\n \n         if auth:\n-            fieldname_name = auth.get(\'name_cookie\', \'__ac_name\')\n-            fieldname_password = auth.get(\'pw_cookie\', \'__ac_password\')\n+            widgetname_login = auth.get(\'name_cookie\', \'__ac_name\')\n+            widgetname_password = auth.get(\'pw_cookie\', \'__ac_password\')\n         else:\n-            fieldname_name = \'__ac_name\'\n-            fieldname_password = \'__ac_password\'\n+            widgetname_login = \'__ac_name\'\n+            widgetname_password = \'__ac_password\'\n \n-        self.fields[\'ac_name\'].__name__ = fieldname_name\n-        self.fields[\'ac_password\'].__name__ = fieldname_password\n-\n-        super().updateWidgets(prefix=\'\')\n+        self.widgets[\'ac_name\'].name = widgetname_login\n+        self.widgets[\'ac_name\'].id = widgetname_login\n+        self.widgets[\'ac_password\'].name = widgetname_password\n+        self.widgets[\'ac_password\'].id = widgetname_password\n \n         if self.use_email_as_login():\n-            self.widgets[fieldname_name].label = _(\'label_email\',\n+            self.widgets[\'ac_name\'].label = _(\'label_email\',\n                                                    default=\'Email\')\n         self.widgets[\'came_from\'].mode = HIDDEN_MODE\n         self.widgets[\'came_from\'].value = self.get_came_from()\n@@ -127,7 +129,7 @@ def get_came_from(self):\n \n     def updateActions(self):\n         super().updateActions()\n-        self.actions[\'login\'].addClass(\'context\')\n+        self.actions[\'login\'].addClass(\'btn-primary\')\n \n     def _post_login(self):\n         membership_tool = getToolByName(self.context, \'portal_membership\')\ndiff --git a/Products/CMFPlone/browser/login/login_help.py b/Products/CMFPlone/browser/login/login_help.py\nindex 96d9b5bbbc..7409a585e8 100644\n--- a/Products/CMFPlone/browser/login/login_help.py\n+++ b/Products/CMFPlone/browser/login/login_help.py\n@@ -3,11 +3,11 @@\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import ILoginHelpForm\n-from Products.CMFPlone.interfaces import ILoginHelpFormSchema\n-from Products.CMFPlone.interfaces import ISecuritySchema\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n-from Products.CMFPlone.utils import safe_unicode\n+from plone.base.interfaces import ILoginHelpForm\n+from plone.base.interfaces import ILoginHelpFormSchema\n+from plone.base.interfaces import ISecuritySchema\n+from plone.base.interfaces.controlpanel import IMailSchema\n+from plone.base.utils import safe_text\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n from smtplib import SMTPException\n@@ -53,6 +53,10 @@ class RequestResetPassword(form.Form):\n \n     render = ViewPageTemplateFile(\'templates/subform_render.pt\')\n \n+    def updateActions(self):\n+        super(RequestResetPassword, self).updateActions()\n+        self.actions[\'reset\'].addClass(\'btn-primary\')\n+\n     def updateWidgets(self):\n         super().updateWidgets()\n         if self.use_email_as_login():\n@@ -102,6 +106,10 @@ class RequestUsername(form.Form):\n \n     render = ViewPageTemplateFile(\'templates/subform_render.pt\')\n \n+    def updateActions(self):\n+        super(RequestUsername, self).updateActions()\n+        self.actions[\'get_username\'].addClass(\'btn-primary\')\n+\n     @button.buttonAndHandler(\n         _(\'button_pwreset_get_username\', default=\'Get your username\'),\n         name=\'get_username\'\n@@ -172,7 +180,7 @@ def send_username(self, portal, userinfo):\n \n     def encode_mail_header(self, text):\n         """ Encodes text into correctly encoded email header """\n-        return Header(safe_unicode(text), \'utf-8\')\n+        return Header(safe_text(text), \'utf-8\')\n \n     def encoded_mail_sender(self):\n         """ returns encoded version of Portal name <portal_email> """\ndiff --git a/Products/CMFPlone/browser/login/password_reset.py b/Products/CMFPlone/browser/login/password_reset.py\nindex 7594dc5461..f2369f35d6 100644\n--- a/Products/CMFPlone/browser/login/password_reset.py\n+++ b/Products/CMFPlone/browser/login/password_reset.py\n@@ -1,22 +1,24 @@\n from AccessControl.SecurityManagement import getSecurityManager\n+from DateTime import DateTime\n from email.header import Header\n from plone.app.layout.navigation.interfaces import INavigationRoot\n+from plone.base.interfaces import IPasswordResetToolView\n+from plone.base.interfaces.controlpanel import IMailSchema\n+from plone.base.utils import safe_text\n+from plone.base.utils import safeToInt\n from plone.memoize import view\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import IPasswordResetToolView\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n from Products.CMFPlone.PasswordResetTool import ExpiredRequestError\n from Products.CMFPlone.PasswordResetTool import InvalidRequestError\n from Products.CMFPlone.RegistrationTool import get_member_by_login_name\n-from Products.CMFPlone.utils import safe_unicode\n-from Products.CMFPlone.utils import safeToInt\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.PlonePAS.events import UserInitialLoginInEvent\n from Products.PlonePAS.events import UserLoggedInEvent\n-from Products.PluggableAuthService.interfaces.plugins import ICredentialsUpdatePlugin  # noqa\n+from Products.PluggableAuthService.interfaces.plugins import \\\n+    ICredentialsUpdatePlugin\n from Products.statusmessages.interfaces import IStatusMessage\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n@@ -38,7 +40,7 @@ def portal_state(self):\n \n     def encode_mail_header(self, text):\n         """ Encodes text into correctly encoded email header """\n-        return Header(safe_unicode(text), \'utf-8\')\n+        return Header(safe_text(text), \'utf-8\')\n \n     def encoded_mail_sender(self):\n         """ returns encoded version of Portal name <portal_email> """\n@@ -54,7 +56,7 @@ def registered_notify_subject(self):\n             _(\n                 \'mailtemplate_user_account_info\',\n                 default=\'User Account Information for ${portal_name}\',\n-                mapping={\'portal_name\': safe_unicode(portal_name)},\n+                mapping={\'portal_name\': safe_text(portal_name)},\n             ),\n             context=self.request,\n         )\n@@ -108,8 +110,9 @@ def _auto_login(self, userid, password):\n             # with the given userid\n             user = getSecurityManager().getUser()\n \n-        login_time = user.getProperty(\'login_time\', None)\n-        if login_time is None:\n+        default = DateTime(\'2000/01/01\')\n+        login_time = user.getProperty(\'login_time\', default)\n+        if login_time == default:\n             notify(UserInitialLoginInEvent(user))\n         else:\n             notify(UserLoggedInEvent(user))\n@@ -193,7 +196,7 @@ def getErrors(self):\n         if state:\n             state[\'status\'] = \'failure\'\n             state[\'portal_status_message\'] = _(\n-                \'Please correct the indicated errors.\',\n+                \'Please correct the indicated errors.\'\n             )\n         return state\n \ndiff --git a/Products/CMFPlone/browser/login/templates/insufficient_privileges.pt b/Products/CMFPlone/browser/login/templates/insufficient_privileges.pt\nindex dc0b859b71..5ce1abb146 100644\n--- a/Products/CMFPlone/browser/login/templates/insufficient_privileges.pt\n+++ b/Products/CMFPlone/browser/login/templates/insufficient_privileges.pt\n@@ -29,4 +29,5 @@\n       </div>\n \n    </metal:content>\n-</html>\n+</body>\n+</html>\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/browser/login/templates/login.pt b/Products/CMFPlone/browser/login/templates/login.pt\nindex 5072301286..96bb0257e8 100644\n--- a/Products/CMFPlone/browser/login/templates/login.pt\n+++ b/Products/CMFPlone/browser/login/templates/login.pt\n@@ -10,90 +10,46 @@\n   <metal:main fill-slot="main">\n     <metal:main-macro define-macro="main">\n \n-      <div id="login-form">\n-\n-        <div class="portalMessage error pat-cookietrigger" style="display:none">\n-            <strong i18n:translate="">\n-                Error\n-            </strong>\n-            <span tal:omit-tag=""\n-                i18n:translate="enable_cookies_message_before_login">\n-                Cookies are not enabled. You must enable cookies before you can log in.\n-            </span>\n-        </div>\n-\n-        <form action="." method="post"\n-              tal:attributes="action view/action; enctype view/enctype">\n-\n-            <tal:widgets repeat="widget view/widgets/values">\n-\n-                <tal:block tal:define="hidden python:widget.mode == \'hidden\'">\n-                <div tal:condition="not:hidden">\n-\n-                    <div class="field"\n-                         tal:define="error widget/error"\n-                         tal:attributes="class python:\'field\' + (error and \' error\' or \'\')">\n-\n-                        <label for=""\n-                               tal:attributes="for widget/id"\n-                               tal:condition="not:hidden">\n-                            <span i18n:translate=""\n-                                  tal:content="widget/label">label</span>\n-                            <span class="required horizontal" title="Required"\n-                                  tal:condition="python:widget.required and not hidden"\n-                                  i18n:attributes="title title_required;">&nbsp;</span>\n-                        </label>\n-\n-                        <div class="formHelp"\n-                             tal:define="description widget/field/description"\n-                             i18n:translate=""\n-                             tal:content="description"\n-                             tal:condition="description">\n-                            field description\n-                        </div>\n-\n-                        <div tal:condition="error"\n-                             tal:content="structure error/render">\n-                            Error\n-                        </div>\n-\n-                        <div class="widget">\n-                            <input type="text" tal:replace="structure widget/render" />\n-                        </div>\n-\n-                    </div>\n-\n+      <article id="content" class="login-wrapper">\n+\n+        <div class="card">\n+          <div class="card-body">\n+            <h1 class="card-title h5"\n+                tal:content="view/label | nothing" />\n+\n+            <div id="login-form">\n+\n+              <div class="alert alert-danger pat-cookietrigger" style="display:none">\n+                <strong i18n:translate="">\n+                  Error\n+                </strong>\n+                <span tal:omit-tag=""\n+                  i18n:translate="enable_cookies_message_before_login">\n+                  Cookies are not enabled. You must enable cookies before you can log in.\n+                </span>\n+              </div>\n+              <metal:form use-macro="context/@@ploneform-macros/titlelessform" />\n+\n+              <div class="footer mt-4"\n+                  tal:define="portal_state context/@@plone_portal_state;\n+                              portal_url portal_state/portal_url">\n+                <div>\n+                  <span i18n:translate="trouble_logging_in" tal:omit-tag="">Trouble logging in?</span>\n+                  <a href="@@login-help" tal:attributes="href string:${portal_url}/@@login-help" i18n:translate="footer_login_link_get_help">Get help</a>.\n                 </div>\n+                <div tal:condition="python:view.self_registration_enabled()">\n+                  <span i18n:translate="need_an_account" tal:omit-tag="">Need an account?</span>\n+                  <a href="@@register" tal:attributes="href string:${portal_url}/@@register" class="emph" i18n:translate="footer_login_link_signup">Sign up here</a>.\n+                </div>\n+              </div>\n \n-                <input type="hidden"\n-                       tal:condition="hidden"\n-                       tal:replace="structure widget/render" />\n-                </tal:block>\n-\n-            </tal:widgets>\n-            <span tal:replace="structure context/@@authenticator/authenticator"/>\n-\n-            <div class="formControls">\n-              <tal:actions tal:repeat="action view/actions/values|nothing">\n-                <input type="submit" tal:replace="structure action/render" />\n-              </tal:actions>\n             </div>\n-        </form>\n \n-        <div class="footer"\n-             tal:define="portal_state context/@@plone_portal_state;\n-                         portal_url portal_state/portal_url">\n-          <p>\n-            <span i18n:translate="trouble_logging_in" tal:omit-tag="">Trouble logging in?</span>\n-            <a href="@@login-help" tal:attributes="href string:${portal_url}/@@login-help" i18n:translate="footer_login_link_get_help">Get help</a>.\n-          </p>\n-          <p tal:condition="python:view.self_registration_enabled()">\n-            <span i18n:translate="need_an_account" tal:omit-tag="">Need an account?</span>\n-             <a href="@@register" tal:attributes="href string:${portal_url}/@@register" class="emph" i18n:translate="footer_login_link_signup">Sign up here</a>.\n-          </p>\n+          </div>\n         </div>\n \n-      </div>\n+      </article>\n+\n     </metal:main-macro>\n   </metal:main>\n </body>\ndiff --git a/Products/CMFPlone/browser/login/templates/login_failsafe.pt b/Products/CMFPlone/browser/login/templates/login_failsafe.pt\nindex 7857ecf5ab..4a879cfbe5 100644\n--- a/Products/CMFPlone/browser/login/templates/login_failsafe.pt\n+++ b/Products/CMFPlone/browser/login/templates/login_failsafe.pt\n@@ -11,7 +11,7 @@\n \n   <h1 i18n:translate="">Failsafe Login</h1>\n \n-  <div class="portalMessage error pat-cookietrigger" style="display:none">\n+  <div class="alert alert-danger pat-cookietrigger" style="display:none">\n       <strong i18n:translate="">\n           Error\n       </strong>\n@@ -29,11 +29,11 @@\n             <tal:block tal:define="hidden python:widget.mode == \'hidden\'">\n             <div tal:condition="not:hidden">\n \n-                <div class="field"\n+                <div class="mb-3 field"\n                      tal:define="error widget/error"\n-                     tal:attributes="class python:\'field\' + (error and \' error\' or \'\')">\n+                     tal:attributes="class python:\'mb-3 field\' + (error and \' error\' or \'\')">\n \n-                    <label for=""\n+                    <label class="form-label" for=""\n                            tal:attributes="for widget/id"\n                            tal:condition="not:hidden">\n                         <span i18n:translate=""\ndiff --git a/Products/CMFPlone/browser/login/templates/login_help.pt b/Products/CMFPlone/browser/login/templates/login_help.pt\nindex 224c824f33..07fee80d49 100644\n--- a/Products/CMFPlone/browser/login/templates/login_help.pt\n+++ b/Products/CMFPlone/browser/login/templates/login_help.pt\n@@ -9,45 +9,45 @@\n   <metal:main fill-slot="main">\n     <metal:main-macro define-macro="main">\n \n-      <div>\n-\n-        <h1 tal:condition="view/label | nothing">\n-            <span tal:replace="view/label">Form title</span>\n-        </h1>\n-\n-        <p tal:condition="view/description | nothing"\n-           tal:content="structure view/description">Form description</p>\n-\n-        <form action="." method="post"\n-              tal:attributes="action view/action; enctype view/enctype"\n-              tal:define="subforms view/subforms">\n-\n-          <div class="row">\n-            <div class="col-xs-12 col-sm-6" tal:repeat="subform subforms"\n-                 tal:attributes="class python:\'col-xs-12 col-sm-12\' if len(subforms) == 1 else \'col-xs-12 col-sm-6\'">\n+      <h1 tal:condition="view/label | nothing">\n+        <span tal:replace="view/label">Form title</span>\n+      </h1>\n+\n+      <p class="lead"\n+        tal:condition="view/description | nothing"\n+        tal:content="structure view/description">Form description</p>\n+\n+      <div id="content-core">\n+        <form action="." method="post" novalidate\n+          tal:attributes="action view/action; enctype view/enctype"\n+          tal:define="subforms view/subforms">\n+\n+          <div class="card-deck">\n+            <div class="card" tal:repeat="subform subforms">\n+              <div class="card-body">\n                 <tal:subform replace="structure subform/render"></tal:subform>\n+              </div>\n+              <span tal:replace="structure context/@@authenticator/authenticator"/>\n             </div>\n           </div>\n-\n-          <span tal:replace="structure context/@@authenticator/authenticator"/>\n-\n         </form>\n \n-        <div class="footer"\n-             tal:define="portal_state context/@@plone_portal_state;\n-                         portal_url portal_state/portal_url">\n-          <p class="trouble">\n-            <span i18n:translate="need_more_help" tal:omit-tag="">Need more help?</span>\n+        <div class="footer mt-4"\n+          tal:define="portal_state context/@@plone_portal_state;\n+                      portal_url portal_state/portal_url">\n+          <div class="trouble mb-2">\n+            <div i18n:translate="need_more_help" tal:omit-tag="">Need more help?</div>\n             <a tal:attributes="href string:${portal_url}/contact-info"\n-               href="contact-info" i18n:translate="contact_an_admin">Contact an admin.</a>\n-          </p>\n-          <p class="go_to_login">\n+              href="contact-info" i18n:translate="contact_an_admin">Contact an admin.</a>\n+          </div>\n+          <div class="go_to_login">\n             <span i18n:translate="go_to_login" tal:omit-tag="">Go to</span>\n             <a tal:attributes="href string:${portal_url}/login" class="pat-plone-modal"\n-               i18n:translate="to_login_view" href="login">login</a>.\n-          </p>\n+              i18n:translate="to_login_view" href="login">login</a>.\n+          </div>\n         </div>\n-      </div>\n+\n+    </div>\n     </metal:main-macro>\n   </metal:main>\n </body>\ndiff --git a/Products/CMFPlone/browser/login/templates/mail_password_form.pt b/Products/CMFPlone/browser/login/templates/mail_password_form.pt\nindex da457d9d22..b82d74286b 100644\n--- a/Products/CMFPlone/browser/login/templates/mail_password_form.pt\n+++ b/Products/CMFPlone/browser/login/templates/mail_password_form.pt\n@@ -38,13 +38,15 @@\n             <fieldset>\n                 <legend i18n:translate="heading_lost_password">Lost Password</legend>\n \n-                <div class="field">\n-                    <label i18n:translate="label_my_user_name_is"\n+                <div class="mb-3 field">\n+                    <label class="form-label"\n+                           i18n:translate="label_my_user_name_is"\n                            tal:condition="not:use_email_as_login"\n                            for="userid">\n                         My user name is\n                     </label>\n-                    <label i18n:translate="label_my_email_address_is"\n+                    <label class="form-label"\n+                           i18n:translate="label_my_email_address_is"\n                            tal:condition="use_email_as_login"\n                            for="userid">\n                       My email address is\n@@ -59,7 +61,7 @@\n                 </div>\n \n                 <div class="formControls">\n-                    <input class="context"\n+                    <input class="btn btn-primary"\n                            type="submit"\n                            value="Start password reset"\n                            i18n:attributes="value"\n@@ -74,7 +76,7 @@\n             name or your email address has changed), contact the\n             <span i18n:name="site_admin">\n             <a href="#"\n-               i18n:translate="label_site_admin"\n+               i18n:translate="label_site_administration"\n                tal:attributes="href string:${portal_url}/contact-info">site administration</a></span>.\n         </p>\n \n@@ -84,7 +86,7 @@\n             address has changed), contact the\n             <span i18n:name="site_admin">\n             <a href="#"\n-               i18n:translate="label_site_admin"\n+               i18n:translate="label_site_administration"\n                tal:attributes="href string:${portal_url}/contact-info">site administration</a></span>.\n         </p>\n \ndiff --git a/Products/CMFPlone/browser/login/templates/mail_password_template.pt b/Products/CMFPlone/browser/login/templates/mail_password_template.pt\nindex d5e7ecfd9e..646740709b 100644\n--- a/Products/CMFPlone/browser/login/templates/mail_password_template.pt\n+++ b/Products/CMFPlone/browser/login/templates/mail_password_template.pt\n@@ -33,7 +33,7 @@ The following link will take you to a page where you can reset your password for\n      i18n:translate="mailtemplate_tracking_information"\n      tal:condition="isAnon">\n If you didn\'t expect to receive this email, please ignore it. Your password has not been changed.\n-Request made from IP address <tal:i18n tal:define="host python:request.HTTP_X_FORWARDED_FOR or request.REMOTE_ADDR"\n+Request made from IP address <tal:i18n tal:define="host request/HTTP_X_FORWARDED_FOR|request/REMOTE_ADDR"\n           tal:content="host"\n           i18n:name="ipaddress" />\n </tal:i18n>\ndiff --git a/Products/CMFPlone/browser/login/templates/pwreset_form.pt b/Products/CMFPlone/browser/login/templates/pwreset_form.pt\nindex 5a49dd8058..5ca9f46a39 100644\n--- a/Products/CMFPlone/browser/login/templates/pwreset_form.pt\n+++ b/Products/CMFPlone/browser/login/templates/pwreset_form.pt\n@@ -33,80 +33,102 @@\n                            value=""\n                            tal:attributes="value options/randomstring | request/randomstring | nothing" />\n \n-                    <div class="field"\n+                    <div class="mb-3 field"\n                          tal:define="error errors/userid | nothing;\n                                      use_email_as_login python:context.portal_registry[\'plone.use_email_as_login\'];"\n-                         tal:attributes="class python:error and \'field error\' or \'field\'"\n+                         tal:attributes="class python:error and \'mb-3 field error\' or \'mb-3 field\'"\n                          tal:condition="here/portal_password_reset/checkUser | nothing">\n \n                       <tal:username tal:condition="not:use_email_as_login">\n-                        <label for="userid"\n+                        <label class="form-label" for="userid"\n                                i18n:translate="label_my_user_name_is">My user name is</label>\n-                        <div tal:content="error">Validation error output</div>\n \n-                        <div class="formHelp" i18n:translate="help_userid">\n+                        <input class="form-control"\n+                            name="userid"\n+                            required\n+                            id="userid" />\n+\n+                        <div tal:content="error" class="invalid-feedback">Validation error output</div>\n+\n+                        <small class="formHelp text-muted" i18n:translate="help_userid">\n                             Enter your user name for verification.\n-                        </div>\n+                        </small>\n                       </tal:username>\n+\n                       <tal:email tal:condition="use_email_as_login">\n-                        <label for="userid"\n+                        <label class="form-label required" for="userid"\n                                i18n:translate="label_my_email_address_is">My email address is</label>\n-                        <div tal:content="error">Validation error output</div>\n \n-                        <div class="formHelp" i18n:translate="help_verify_email">\n+                        <input class="form-control"\n+                            name="userid"\n+                            required\n+                            id="userid" />\n+\n+                        <div tal:content="error" class="invalid-feedback">Validation error output</div>\n+\n+                        <small class="formHelp text-muted" i18n:translate="help_verify_email">\n                             Enter your email address for verification.\n-                        </div>\n+                        </small>\n                       </tal:email>\n \n-                        <input name="userid" id="userid" />\n                     </div>\n \n-                    <div class="field"\n+                    <div class="mb-3 field"\n                          tal:define="error errors/password | nothing;"\n-                         tal:attributes="class python:error and \'field error\' or \'field\'">\n+                         tal:attributes="class python:error and \'mb-3 field error\' or \'mb-3 field\'">\n \n-                        <label for="password"\n+                        <label class="form-label required" for="password"\n                                i18n:translate="label_new_password">New password</label>\n-                        <div tal:content="error">Validation error output</div>\n \n-                        <div class="formHelp"\n-                             i18n:translate="help_new_password">\n+                        <input class="form-control"\n+                            type="password"\n+                            id="password"\n+                            name="password"\n+                            required\n+                            size="10" />\n+\n+                        <div tal:content="error" class="invalid-feedback">Validation error output</div>\n+\n+                        <small class="formHelp text-muted"\n+                            i18n:translate="help_new_password">\n                             Enter your new password.\n-                        </div>\n+                        </small>\n \n-                        <input type="password"\n-                               id="password"\n-                               name="password"\n-                               size="10" />\n                     </div>\n \n-                    <div class="field"\n+                    <div class="mb-3 field"\n                          tal:define="error errors/password | nothing;"\n-                         tal:attributes="class python:error and \'field error\' or \'field\'">\n+                         tal:attributes="class python:error and \'mb-3 field error\' or \'mb-3 field\'">\n \n-                        <label for="password2" i18n:translate="label_confirm_password">Confirm password</label>\n-                        <div tal:content="error">Validation error output</div>\n+                        <label class="form-label required" for="password2"\n+                        i18n:translate="label_confirm_password">Confirm password</label>\n \n-                        <div class="formHelp" i18n:translate="help_confirm_password">\n+                        <input class="form-control"\n+                            type="password"\n+                            id="password2"\n+                            name="password2"\n+                            required\n+                            size="10"\n+                            />\n+\n+                        <div tal:content="error" class="invalid-feedback">Validation error output</div>\n+\n+                        <small class="formHelp text-muted" i18n:translate="help_confirm_password">\n                             Re-enter the password. Make sure the passwords are identical.\n-                        </div>\n+                        </small>\n \n-                        <input type="password"\n-                               id="password2"\n-                               name="password2"\n-                               size="10"\n-                               />\n                     </div>\n \n                     <div>\n                         <div class="label">&nbsp;</div>\n \n-                        <div class="field">\n-                            <input class="context"\n-                                   type="submit"\n-                                   value="Set my password"\n-                                   i18n:attributes="value"\n-                                   />\n+                        <div class="mb-3 field">\n+                            <button class="btn btn-primary"\n+                                type="submit"\n+                                value="Set my password"\n+                                i18n:attributes="value">\n+                                <span i18n:translate="">Set my password</span>\n+                            </button>\n                         </div>\n                     </div>\n                     <input type="hidden" name="form.submitted" value="1" />\ndiff --git a/Products/CMFPlone/browser/login/templates/registered_notify_template.pt b/Products/CMFPlone/browser/login/templates/registered_notify_template.pt\nindex f7d0980a0c..41789b7049 100644\n--- a/Products/CMFPlone/browser/login/templates/registered_notify_template.pt\n+++ b/Products/CMFPlone/browser/login/templates/registered_notify_template.pt\n@@ -13,7 +13,7 @@ Precedence: bulk\n      tal:omit-tag=""\n      tal:define="fullname python:member.getProperty(\'fullname\')">\n     Welcome <span i18n:name="fullname" tal:replace="fullname" />,\n-  \n+\n     Your user account has been created.\n   Your username is <span i18n:name="member" tal:replace="python:member.getUserName()" />.\n   Please activate it by visiting\ndiff --git a/Products/CMFPlone/browser/login/templates/subform_render.pt b/Products/CMFPlone/browser/login/templates/subform_render.pt\nindex 0447d3878b..444830e16a 100644\n--- a/Products/CMFPlone/browser/login/templates/subform_render.pt\n+++ b/Products/CMFPlone/browser/login/templates/subform_render.pt\n@@ -7,53 +7,56 @@\n       tal:omit-tag="">\n <body tal:omit-tag="">\n \n-    <h1 tal:condition="view/label | nothing">\n-        <span tal:replace="view/label">Form title</span>\n-    </h1>\n-\n-    <p tal:condition="view/description | nothing"\n-        tal:content="structure view/description">Form description</p>\n-\n-    <tal:widgets repeat="widget view/widgets/values">\n-        <div tal:define="hidden python:widget.mode == \'hidden\'"\n-             tal:omit-tag="hidden">\n-\n-            <div class="field"\n-                tal:define="error widget/error;\n-                            hidden python:widget.mode == \'hidden\';"\n-                tal:attributes="class python:\'field\' + (error and \' error\' or \'\')">\n-                <label for=""\n-                        tal:attributes="for widget/id"\n-                        tal:condition="not:hidden">\n-                    <span tal:content="widget/label">label</span>\n-                    <span class="required horizontal" title="Required"\n-                          tal:condition="python:widget.required and not hidden"\n-                          i18n:attributes="title title_required;">&nbsp;</span>\n-                </label>\n-\n-                <div class="formHelp"\n-                        tal:define="description widget/field/description"\n-                        tal:content="description"\n-                        tal:condition="python:description and not hidden"\n-                        >field description</div>\n-\n-                <div tal:condition="error"\n-                        tal:content="structure error/render">\n-                    Error\n-                </div>\n-\n-                <div class="widget">\n-                    <input type="text" tal:replace="structure widget/render" />\n-                </div>\n-            </div>\n-        </div>\n-    </tal:widgets>\n+  <h1 tal:condition="view/label | nothing">\n+      <span tal:replace="view/label">Form title</span>\n+  </h1>\n+\n+  <p tal:condition="view/description | nothing"\n+     tal:content="structure view/description">Form description</p>\n+\n+  <tal:widgets repeat="widget view/widgets/values">\n+      <tal:widget tal:define="hidden python:widget.mode == \'hidden\'"\n+                  tal:omit-tag="hidden">\n+\n+        <p class="form-text text-muted"\n+          tal:define="description widget/field/description"\n+          tal:content="description"\n+          tal:condition="python:description and not hidden">\n+          field description\n+        </p>\n+\n+        <div class="mb-3 field"\n+          tal:define="error widget/error;\n+                      hidden python:widget.mode == \'hidden\';"\n+          tal:attributes="class python:\'mb-3 field\' + (error and \' error\' or \'\')">\n+\n+          <label class="form-label" for=""\n+                 tal:attributes="for widget/id"\n+                 tal:condition="not:hidden">\n+            <span tal:content="widget/label">label</span>\n+            <span class="required horizontal" title="Required"\n+                  tal:condition="python:widget.required and not hidden"\n+                  i18n:attributes="title title_required;">&nbsp;</span>\n+          </label>\n+\n+          <div tal:condition="error"\n+               tal:content="structure error/render">\n+              Error\n+          </div>\n+\n+          <div class="widget">\n+              <input type="text" tal:replace="structure widget/render" />\n+          </div>\n \n-    <div class="formControls">\n-        <tal:actions tal:repeat="action view/actions/values|nothing">\n-            <input type="submit" tal:replace="structure action/render" />\n-        </tal:actions>\n-    </div>\n+        </div>\n+      </tal:widget>\n+  </tal:widgets>\n+\n+  <div class="formControls">\n+      <tal:actions tal:repeat="action view/actions/values|nothing">\n+          <input type="submit" tal:replace="structure action/render" />\n+      </tal:actions>\n+  </div>\n \n </body>\n </html>\ndiff --git a/Products/CMFPlone/browser/main_template.py b/Products/CMFPlone/browser/main_template.py\nindex 707ca21284..b68867268e 100644\n--- a/Products/CMFPlone/browser/main_template.py\n+++ b/Products/CMFPlone/browser/main_template.py\n@@ -22,9 +22,9 @@ def template_name(self):\n \n     @property\n     def macros(self):\n-        # Reinstanciating the templatefile is a workaround for\n+        # Reinstantiating the templatefile is a workaround for\n         # https://github.com/plone/Products.CMFPlone/issues/2666\n-        # Without this a inifite recusion in a template\n+        # Without this an infinite recursion in a template\n         # (i.e. a template that calls its own view)\n         # kills the instance instead of raising a RecursionError.\n         return ViewPageTemplateFile(self.template_name).macros\ndiff --git a/Products/CMFPlone/browser/navigation.py b/Products/CMFPlone/browser/navigation.py\nindex 2c57508c21..eb76b1d18d 100644\n--- a/Products/CMFPlone/browser/navigation.py\n+++ b/Products/CMFPlone/browser/navigation.py\n@@ -10,9 +10,9 @@\n from Products.CMFPlone.browser.interfaces import INavigationTabs\n from Products.CMFPlone.browser.interfaces import ISiteMap\n from Products.CMFPlone.browser.navtree import SitemapQueryBuilder\n-from Products.CMFPlone.defaultpage import check_default_page_via_view\n-from Products.CMFPlone.interfaces import IHideFromBreadcrumbs\n-from Products.CMFPlone.interfaces import INavigationSchema\n+from plone.base.defaultpage import check_default_page_via_view\n+from plone.base.interfaces import IHideFromBreadcrumbs\n+from plone.base.interfaces import INavigationSchema\n from Products.Five import BrowserView\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n@@ -22,7 +22,7 @@\n def get_url(item):\n     if not item:\n         return None\n-    if hasattr(aq_base(item), \'getURL\'):\n+    if hasattr(aq_base(item), "getURL"):\n         # Looks like a brain\n         return item.getURL()\n     return item.absolute_url()\n@@ -31,7 +31,7 @@ def get_url(item):\n def get_id(item):\n     if not item:\n         return None\n-    getId = getattr(item, \'getId\')\n+    getId = getattr(item, "getId")\n     if not utils.safe_callable(getId):\n         # Looks like a brain\n         return getId\n@@ -40,21 +40,19 @@ def get_id(item):\n \n def get_view_url(context):\n     registry = getUtility(IRegistry)\n-    view_action_types = registry.get(\n-        \'plone.types_use_view_action_in_listings\', [])\n+    view_action_types = registry.get("plone.types_use_view_action_in_listings", [])\n     item_url = get_url(context)\n     name = get_id(context)\n \n-    if getattr(context, \'portal_type\', {}) in view_action_types:\n-        item_url += \'/view\'\n-        name += \'/view\'\n+    if item_url and getattr(context, "portal_type", {}) in view_action_types:\n+        item_url += "/view"\n+        name += "/view"\n \n     return name, item_url\n \n \n @implementer(ISiteMap)\n class CatalogSiteMap(BrowserView):\n-\n     def siteMap(self):\n         context = aq_inner(self.context)\n \n@@ -62,69 +60,60 @@ def siteMap(self):\n         query = queryBuilder()\n         strategy = getMultiAdapter((context, self), INavtreeStrategy)\n \n-        return buildFolderTree(\n-            context, obj=context,\n-            query=query, strategy=strategy\n-        )\n+        return buildFolderTree(context, obj=context, query=query, strategy=strategy)\n \n \n @implementer(INavigationTabs)\n class CatalogNavigationTabs(BrowserView):\n-\n     def _getNavQuery(self):\n         # check whether we only want actions\n         registry = getUtility(IRegistry)\n         navigation_settings = registry.forInterface(\n-            INavigationSchema,\n-            prefix="plone",\n-            check=False\n+            INavigationSchema, prefix="plone", check=False\n         )\n-        customQuery = getattr(self.context, \'getCustomNavQuery\', False)\n+        customQuery = getattr(self.context, "getCustomNavQuery", False)\n         if customQuery is not None and utils.safe_callable(customQuery):\n             query = customQuery()\n         else:\n             query = {}\n \n-        query[\'path\'] = {\n-            \'query\': getNavigationRoot(self.context),\n-            \'depth\': 1\n-        }\n-        query[\'portal_type\'] = [t for t in navigation_settings.displayed_types]\n-        query[\'sort_on\'] = navigation_settings.sort_tabs_on\n+        query["path"] = {"query": getNavigationRoot(self.context), "depth": 1}\n+        query["portal_type"] = [t for t in navigation_settings.displayed_types]\n+        query["sort_on"] = navigation_settings.sort_tabs_on\n         if navigation_settings.sort_tabs_reversed:\n-            query[\'sort_order\'] = \'reverse\'\n+            query["sort_order"] = "reverse"\n         else:\n-            query[\'sort_order\'] = \'ascending\'\n+            query["sort_order"] = "ascending"\n \n         if navigation_settings.filter_on_workflow:\n-            query[\'review_state\'] = navigation_settings.workflow_states_to_show\n+            query["review_state"] = navigation_settings.workflow_states_to_show\n \n-        query[\'is_default_page\'] = False\n+        query["is_default_page"] = False\n \n         if not navigation_settings.show_excluded_items:\n-            query[\'exclude_from_nav\'] = False\n+            # Note:\n+            # Careful with that axe, Eugene!\n+            # This introduces a performance decrease.\n+            query["exclude_from_nav"] = False\n \n         if not navigation_settings.nonfolderish_tabs:\n-            query[\'is_folderish\'] = True\n+            query["is_folderish"] = True\n \n         return query\n \n-    def topLevelTabs(self, actions=None, category=\'portal_tabs\'):\n+    def topLevelTabs(self, actions=None, category="portal_tabs"):\n         context = aq_inner(self.context)\n         registry = getUtility(IRegistry)\n         navigation_settings = registry.forInterface(\n-            INavigationSchema,\n-            prefix="plone",\n-            check=False\n+            INavigationSchema, prefix="plone", check=False\n         )\n-        mtool = getToolByName(context, \'portal_membership\')\n+        mtool = getToolByName(context, "portal_membership")\n         member = mtool.getAuthenticatedMember().id\n-        catalog = getToolByName(context, \'portal_catalog\')\n+        catalog = getToolByName(context, "portal_catalog")\n \n         if actions is None:\n             context_state = getMultiAdapter(\n-                (context, self.request),\n-                name=\'plone_context_state\'\n+                (context, self.request), name="plone_context_state"\n             )\n             actions = context_state.actions(category)\n \n@@ -133,7 +122,7 @@ def topLevelTabs(self, actions=None, category=\'portal_tabs\'):\n         # first the actions\n         for actionInfo in actions:\n             data = actionInfo.copy()\n-            data[\'name\'] = data[\'title\']\n+            data["name"] = data["title"]\n             self.customize_entry(data)\n             result.append(data)\n \n@@ -150,20 +139,22 @@ def _get_url(item):\n                 return (get_id(item), item.getRemoteUrl)\n             return get_view_url(item)\n \n-        context_path = \'/\'.join(context.getPhysicalPath())\n+        context_path = "/".join(context.getPhysicalPath())\n \n         # now add the content to results\n         for item in rawresult:\n-            if item.exclude_from_nav and not context_path.startswith(item.getPath()):  # noqa: E501\n+            if item.exclude_from_nav and not context_path.startswith(\n+                item.getPath()\n+            ):  # noqa: E501\n                 # skip excluded items if they\'re not in our context path\n                 continue\n             cid, item_url = _get_url(item)\n             data = {\n-                \'name\': utils.pretty_title_or_id(context, item),\n-                \'id\': item.getId,\n-                \'url\': item_url,\n-                \'description\': item.Description,\n-                \'review_state\': item.review_state\n+                "name": utils.pretty_title_or_id(context, item),\n+                "id": item.getId,\n+                "url": item_url,\n+                "description": item.Description,\n+                "review_state": item.review_state,\n             }\n             self.customize_entry(data, item)\n             result.append(data)\n@@ -174,21 +165,21 @@ def customize_entry(self, entry, brain=None):\n         """a little helper to enlarge customizability."""\n         pass\n \n+\n @implementer(INavigationBreadcrumbs)\n class CatalogNavigationBreadcrumbs(BrowserView):\n-\n     def breadcrumbs(self):\n         context = aq_inner(self.context)\n-        catalog = getToolByName(context, \'portal_catalog\')\n+        catalog = getToolByName(context, "portal_catalog")\n         query = {}\n \n         # Check to see if the current page is a folder default view, if so\n         # get breadcrumbs from the parent folder\n         if check_default_page_via_view(context, self.request):\n-            currentPath = \'/\'.join(utils.parent(context).getPhysicalPath())\n+            currentPath = "/".join(utils.parent(context).getPhysicalPath())\n         else:\n-            currentPath = \'/\'.join(context.getPhysicalPath())\n-        query[\'path\'] = {\'query\': currentPath, \'navtree\': 1, \'depth\': 0}\n+            currentPath = "/".join(context.getPhysicalPath())\n+        query["path"] = {"query": currentPath, "navtree": 1, "depth": 0}\n \n         rawresult = catalog(**query)\n \n@@ -210,8 +201,8 @@ def breadcrumbs(self):\n \n             cid, item_url = get_view_url(item)\n             data = {\n-                \'Title\': utils.pretty_title_or_id(context, item),\n-                \'absolute_url\': item_url\n+                "Title": utils.pretty_title_or_id(context, item),\n+                "absolute_url": item_url,\n             }\n             result.append(data)\n         return result\n@@ -219,7 +210,6 @@ def breadcrumbs(self):\n \n @implementer(INavigationBreadcrumbs)\n class PhysicalNavigationBreadcrumbs(BrowserView):\n-\n     def breadcrumbs(self):\n         context = aq_inner(self.context)\n         request = self.request\n@@ -228,12 +218,14 @@ def breadcrumbs(self):\n         name, item_url = get_view_url(context)\n \n         if container is None:\n-            return ({\n-                \'absolute_url\': item_url,\n-                \'Title\': utils.pretty_title_or_id(context, context),\n-            },)\n+            return (\n+                {\n+                    "absolute_url": item_url,\n+                    "Title": utils.pretty_title_or_id(context, context),\n+                },\n+            )\n \n-        view = getMultiAdapter((container, request), name=\'breadcrumbs_view\')\n+        view = getMultiAdapter((container, request), name="breadcrumbs_view")\n         base = tuple(view.breadcrumbs())\n \n         # Some things want to be hidden from the breadcrumbs\n@@ -241,22 +233,28 @@ def breadcrumbs(self):\n             return base\n \n         rootPath = getNavigationRoot(context)\n-        itemPath = \'/\'.join(context.getPhysicalPath())\n+        itemPath = "/".join(context.getPhysicalPath())\n \n         # don\'t show default pages in breadcrumbs or pages above the navigation\n         # root\n-        if not check_default_page_via_view(context, request) \\\n-           and not rootPath.startswith(itemPath):\n-            base += ({\n-                \'absolute_url\': item_url,\n-                \'Title\': utils.pretty_title_or_id(context, context),\n-            },)\n+        if not check_default_page_via_view(\n+            context, request\n+        ) and not rootPath.startswith(itemPath):\n+            entry = {\n+                "absolute_url": item_url,\n+                "Title": utils.pretty_title_or_id(context, context),\n+            }\n+            self.customize_entry(entry, context)\n+            base += (entry,)\n         return base\n \n+    def customize_entry(self, entry, context=None):\n+        """a little helper to enlarge customizability."""\n+        pass\n+\n \n @implementer(INavigationBreadcrumbs)\n class RootPhysicalNavigationBreadcrumbs(BrowserView):\n-\n     def breadcrumbs(self):\n         # XXX Root never gets included, it\'s hardcoded as \'Home\' in\n         # the template. We will fix and remove the hardcoding and fix\ndiff --git a/Products/CMFPlone/browser/navtree.py b/Products/CMFPlone/browser/navtree.py\nindex 3a0a0aee34..d066dc4e12 100644\n--- a/Products/CMFPlone/browser/navtree.py\n+++ b/Products/CMFPlone/browser/navtree.py\n@@ -12,7 +12,7 @@\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import utils\n-from Products.CMFPlone.interfaces import INavigationSchema\n+from plone.base.interfaces import INavigationSchema\n from zope.component import getMultiAdapter, queryUtility\n from zope.component import getUtility\n from zope.interface import implementer\ndiff --git a/Products/CMFPlone/browser/ploneview.py b/Products/CMFPlone/browser/ploneview.py\nindex 7bae74eb74..43dab697fb 100644\n--- a/Products/CMFPlone/browser/ploneview.py\n+++ b/Products/CMFPlone/browser/ploneview.py\n@@ -111,7 +111,7 @@ def cropText(self, text, length, ellipsis=\'...\'):\n             return text\n         converted = False\n         if not isinstance(text, str):\n-            text = utils.safe_unicode(text)\n+            text = utils.safe_text(text)\n             converted = True\n         if len(text) > length:\n             text = text[:length]\n@@ -211,3 +211,7 @@ def patterns_settings(self):\n         return getMultiAdapter(\n             (context, self.request),\n             name=\'plone_patterns_settings\')()\n+\n+    @property\n+    def human_readable_size(self):\n+        return utils.human_readable_size\ndiff --git a/Products/CMFPlone/browser/robots.py b/Products/CMFPlone/browser/robots.py\nindex 9c5a0bc290..eb4e2535bb 100644\n--- a/Products/CMFPlone/browser/robots.py\n+++ b/Products/CMFPlone/browser/robots.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces.controlpanel import ISiteSchema\n+from plone.base.interfaces.controlpanel import ISiteSchema\n from Products.Five.browser import BrowserView\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py\nindex 2be9ddf3cc..08709607c8 100644\n--- a/Products/CMFPlone/browser/search.py\n+++ b/Products/CMFPlone/browser/search.py\n@@ -1,10 +1,11 @@\n from DateTime import DateTime\n from plone.app.contentlisting.interfaces import IContentListing\n+from plone.app.layout.navigation.interfaces import INavigationRoot\n+from plone.base.batch import Batch\n+from plone.base.interfaces import ISearchSchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.browser.navtree import getNavigationRoot\n-from Products.CMFPlone.interfaces import ISearchSchema\n-from Products.CMFPlone.PloneBatch import Batch\n from Products.ZCTextIndex.ParseTree import ParseError\n from zope.cachedescriptors.property import Lazy as lazy_property\n from zope.component import getMultiAdapter\n@@ -12,10 +13,10 @@\n from zope.component import queryUtility\n from zope.i18nmessageid import MessageFactory\n from zope.publisher.browser import BrowserView\n-from ZPublisher.HTTPRequest import record\n from ZTUtils import make_query\n \n import json\n+import re\n \n _ = MessageFactory(\'plone\')\n \n@@ -45,18 +46,33 @@ def quote(term):\n     return term\n \n \n+def munge_search_term(query):\n+    for char in BAD_CHARS:\n+        query = query.replace(char, \' \')\n+\n+    # extract quoted phrases first\n+    quoted_phrases = re.findall(r\'"([^"]*)"\', query)\n+    r = []\n+    for qp in quoted_phrases:\n+        # remove from original query\n+        query = query.replace(f\'"{qp}"\', "")\n+        # replace with cleaned leading/trailing whitespaces\n+        # and skip empty phrases\n+        clean_qp = qp.strip()\n+        if not clean_qp:\n+            continue\n+        r.append(f\'"{clean_qp}"\')\n+\n+    r += map(quote, query.strip().split())\n+    r = " AND ".join(r)\n+    r = quote_chars(r) + (\'*\' if r and not r.endswith(\'"\') else \'\')\n+    return r\n+\n+\n class Search(BrowserView):\n \n     valid_keys = (\'sort_on\', \'sort_order\', \'sort_limit\', \'fq\', \'fl\', \'facet\')\n \n-    def munge_search_term(self, q):\n-        for char in BAD_CHARS:\n-            q = q.replace(char, \' \')\n-        r = map(quote, q.split())\n-        r = " AND ".join(r)\n-        r = quote_chars(r) + \'*\'\n-        return r\n-\n     def results(self, query=None, batch=True, b_size=10, b_start=0,\n                 use_content_listing=True):\n         """ Get properly wrapped search results from the catalog.\n@@ -106,23 +122,18 @@ def _filter_query(self, query):\n             if v and ((k in valid_keys) or k.startswith(\'facet.\')):\n                 query[k] = v\n         if text:\n-            query[\'SearchableText\'] = self.munge_search_term(text)\n+            query[\'SearchableText\'] = munge_search_term(text)\n \n         # don\'t filter on created at all if we want all results\n         created = query.get(\'created\')\n         if created:\n             try:\n-                if created.get(\'query\') and created[\'query\'][0] <= EVER:\n+                if created.get(\'query\', EVER) <= EVER:\n                     del query[\'created\']\n             except AttributeError:\n                 # created not a mapping\n                 del query[\'created\']\n \n-        # https://github.com/plone/Products.CMFPlone/issues/3007\n-        # If \'created\' exists and is of type \'record\', then cast it as dict\n-        if \'created\' in query and isinstance(query[\'created\'], record):\n-            query[\'created\'] = dict(query[\'created\'])\n-\n         # respect `types_not_searched` setting\n         types = query.get(\'portal_type\', [])\n         if \'query\' in types:\n@@ -230,6 +241,16 @@ def navroot_url(self):\n             self._navroot_url = state.navigation_root_url()\n         return self._navroot_url\n \n+    @property\n+    def show_images(self):\n+        registry = queryUtility(IRegistry)\n+        return registry.get(\'plone.search_show_images\')\n+\n+    @property\n+    def search_image_scale(self):\n+        registry = queryUtility(IRegistry)\n+        return registry.get(\'plone.search_image_scale\')\n+\n \n class AjaxSearch(Search):\n \n@@ -249,27 +270,37 @@ def __call__(self):\n \n         registry = queryUtility(IRegistry)\n         length = registry.get(\'plone.search_results_description_length\')\n+        show_images = registry.get(\'plone.search_show_images\')\n+        if show_images:\n+            image_scale = registry.get(\'plone.search_image_scale\')\n+            # image_scaling = getMultiAdapter((self.context, self.request), name=\'image_scale\')\n+            self.image_scaling = getMultiAdapter((INavigationRoot(self.context), self.request), name=\'image_scale\')\n         plone_view = getMultiAdapter(\n             (self.context, self.request), name=\'plone\')\n-        registry = getUtility(IRegistry)\n         view_action_types = registry.get(\n             \'plone.types_use_view_action_in_listings\', [])\n         for item in batch:\n             url = item.getURL()\n             if item.portal_type in view_action_types:\n                 url = \'%s/view\' % url\n+            img_tag = None\n+            if show_images:\n+                img_tag = self.get_image_tag(item, image_scale)\n             items.append({\n                 \'id\': item.UID,\n                 \'title\': item.Title,\n                 \'description\': plone_view.cropText(item.Description, length),\n                 \'url\': url,\n                 \'state\': item.review_state if item.review_state else None,\n+                \'img_tag\': img_tag,\n             })\n         return json.dumps({\n             \'total\': len(results),\n             \'items\': items\n         })\n \n+    def get_image_tag(self, item, image_scale):\n+        return self.image_scaling.tag(item, "image", scale=image_scale)\n \n class SortOption:\n \ndiff --git a/Products/CMFPlone/browser/sendto.py b/Products/CMFPlone/browser/sendto.py\nindex 1f11b22084..384d7d5ff3 100644\n--- a/Products/CMFPlone/browser/sendto.py\n+++ b/Products/CMFPlone/browser/sendto.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+from plone.base.interfaces.controlpanel import IMailSchema\n from Products.CMFPlone.utils import pretty_title_or_id\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.MailHost.interfaces import IMailHost\ndiff --git a/Products/CMFPlone/browser/sitelogo.py b/Products/CMFPlone/browser/sitelogo.py\nindex 2d56feebeb..cb816a6b48 100644\n--- a/Products/CMFPlone/browser/sitelogo.py\n+++ b/Products/CMFPlone/browser/sitelogo.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import ISiteSchema\n from plone.formwidget.namedfile.converter import b64decode_file\n from plone.namedfile.browser import Download\n from plone.namedfile.file import NamedImage\ndiff --git a/Products/CMFPlone/skins/plone_images/favicon.ico b/Products/CMFPlone/browser/static/favicon.ico\nsimilarity index 100%\nrename from Products/CMFPlone/skins/plone_images/favicon.ico\nrename to Products/CMFPlone/browser/static/favicon.ico\ndiff --git a/Products/CMFPlone/browser/static/plone-admin-ui.css b/Products/CMFPlone/browser/static/plone-admin-ui.css\nindex 1c2ae4432a..822b02697a 100644\n--- a/Products/CMFPlone/browser/static/plone-admin-ui.css\n+++ b/Products/CMFPlone/browser/static/plone-admin-ui.css\n@@ -1,66 +1,7 @@\n-@font-face {\n-  font-family: "Roboto";\n-  font-style: normal;\n-  font-weight: 300;\n-  src: local(\'Roboto Light\'), local(\'Roboto-Light\'), url("++theme++barceloneta/less/roboto/Roboto-Light.ttf") format(\'truetype\');\n+body {\n+  background: #f4f4f4;\n }\n-@font-face {\n-  font-family: "Roboto";\n-  font-style: normal;\n-  font-weight: 400;\n-  src: local(\'Roboto Regular\'), local(\'Roboto-Regular\'), url("++theme++barceloneta/less/roboto/Roboto-Regular.ttf") format(\'truetype\');\n-}\n-\n-body { font-family: \'Roboto\', sans-serif; line-height: 1.25; clear: both; background: #f4f4f4; padding: 0; margin:0;}\n-#box { max-width: 670px; padding: 40px; background: #fff; background: rgba(255,255,255,.95); box-shadow: 0 0 5px rgba(0,0,0,.15); border-radius: 3px; margin:40px auto;}\n-\n-ul {padding: 0;}\n-ul ul {padding: 1em}\n-pre {background: #fea;padding: 20px;border-radius: 3px; margin:0 0 40px;word-wrap: break-word;}\n-a {color: #0184bf; text-decoration: none;}\n-a:hover, a:active {text-decoration: underline;}\n-p {color: #666; margin:0;}\n-h1 {color: #000; font-weight: 300; font-size: 200%; margin:0; line-height: 1.25}\n-h2 {font-size: 100%; color: #666; font-weight: 400; margin:20px 0; line-height: 1.25}\n-header h1 {margin: 0 0 40px; padding: 0 0 40px; border-bottom: 1px solid #d9d9d9;}\n-footer {border-top:1px solid #d9d9d9; padding-top: 40px; margin-top: 40px;}\n-\n-.circle {width: 150px; height: 150px; text-align:center; border-radius: 50%; margin: -10px 0 20px 40px; float: right; background: #56a1b9;}\n-.circle img {margin-top: 25px}\n-.sites {padding: 0;}\n-.sites li {list-style: none; padding-left: 20px; position: relative; margin-bottom: 10px;}\n-.sites li a:hover:after{content:""; width: 12px; height: 12px; border:2px solid #56a1b9; border-radius: 50%; position: absolute; left: 0; margin-top: 2px;}\n-.sites li:before  {content:"";width: 6px; height: 6px; background:#56a1b9; border-radius: 50%; position: absolute; left: 5px; margin-top: 7px;}\n-.discreet, .formHelp {font-size: 87.5%; color: #767676; font-weight: 300;}\n-.field {margin: 0 0 20px;}\n-.formControls {margin-top: 40px;}\n-.upgrade-warning {color: #b7000d; font-size: 87.5%; padding-left: 30px; margin:10px 0;}\n-.backup-warning {color: #b7000d; padding-left: 30px; margin:10px 0;}\n-.upgrade-warning:before {content:"!"; color:#fff; text-align: center; background: #b7000d; border-radius: 50%; width: 20px; height: 20px; position: absolute; margin-left: -30px;}\n-.upgrade-info {font-size: 87.5%; padding-left: 30px; margin:10px 0;}\n-.upgrade-info:before {content:"i"; color:#fff; text-align: center; background: #56a1b9; border-radius: 50%; width: 20px; height: 20px; position: absolute; margin-left: -30px;}\n-.version-list {font-size: 87.5%; margin-left: 20px;}\n-\n-input, select {background:#fff;outline:0;font-family: \'Roboto\', sans-serif; font-size: 16px; height: 18px; border-radius: 2px; min-width: 180px; display: block; border:1px solid #ccc; padding:10px; margin:5px 0 0;}\n-select {height: 45px; width: 300px;}\n-input:focus, select:focus {border-color: #a2a2a2; background: #fffbea; box-shadow: inset 0 1px 3px rgba(0,0,0,.15);}\n-[type="submit"], .plone-btn {background: #0184bf; color: #fff; font-family: \'Roboto\', sans-serif; font-size: 16px; height: 40px; border: 0; border-radius: 2px; min-width: 200px; display: block; cursor: pointer; margin:10px 10px 10px 0; padding: 0 20px;}\n-.plone-btn-secondary {background: #a2a2a2;}\n-[type="submit"]:hover, .plone-btn:hover {box-shadow: inset 0 0 0 40px rgba(0,0,0,.15), 0 1px 3px rgba(0,0,0,.15);}\n-[type="submit"]:active, .plone-btn:active, [type="submit"]:focus, .plone-btn:focus {box-shadow: inset 0 0 0 40px rgba(0,0,0,.15), 0 2px 6px rgba(0,0,0,.25); outline: 0}\n-a.plone-btn {line-height: 2.5;display: inline-block;text-align: center; text-decoration: none !important; background:#0184bf;}\n-label [type="checkbox"], label [type="radio"] {float: left; min-width:20px; width: 20px; margin:2px 4px 0 0; box-shadow: none !important;}\n-fieldset {border: 0; margin: 40px 0; padding:0;}\n-fieldset fieldset {outline:1px solid #d9d9d9; padding: 20px; font-size: 87.5%; color: #666; margin:20px 0;}\n-legend {font-size: 150%; font-weight: 300; border-top: 1px solid #d9d9d9; width: 100%; padding-top: 20px;}\n-fieldset fieldset legend {border:0; font-size: 100%; color: #000; font-weight: 400;}\n-.addons-group {margin-bottom: 10px;}\n-ul li {list-style: none;}\n-#add-plone-site input[type="submit"] { display: inline; }\n-\n-@media screen and (max-width: 667px){\n-    body, html {background: #fff;}\n-    #box  { box-shadow: none; border-radius: 0; margin: 0; padding: 20px;}\n-    .circle {float:none; margin: 0 auto;}\n-    header h1 {padding: 0 0 20px;}\n+.admin {\n+  background: rgba(255,255,255,.95);\n+  max-width: 800px;\n }\ndiff --git a/Products/CMFPlone/browser/static/plone-logo.svg b/Products/CMFPlone/browser/static/plone-logo.svg\nnew file mode 100644\nindex 0000000000..e49aaa3a25\n--- /dev/null\n+++ b/Products/CMFPlone/browser/static/plone-logo.svg\n@@ -0,0 +1,24 @@\n+<?xml version="1.0" encoding="UTF-8"?>\n+<!-- Generator: Adobe Illustrator 13.0.1, SVG Export Plug-In . SVG Version: 6.00 Build 14948)  -->\n+<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n+<svg version="1.1" id="plone-logo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="215px" height="56px" viewBox="0 0 158.253 40.686" enable-background="new 0 0 158.253 40.686" xml:space="preserve">\n+<g>\n+\t<path fill="#0083BE" d="M65.327,23.208h-6.589v11.388h-4.393V5.638h10.981c5.653,0,9.271,3.742,9.271,8.785   S70.979,23.208,65.327,23.208z M65.082,9.583h-6.345v9.639h6.345c3.05,0,5.124-1.749,5.124-4.799   C70.206,11.372,68.132,9.583,65.082,9.583z"/>\n+\t<path fill="#0083BE" d="M83.969,34.596c-3.904,0-5.652-2.644-5.652-5.693V5.638h4.148v23.021c0,1.587,0.567,2.399,2.235,2.399h1.83   v3.538H83.969z"/>\n+\t<path fill="#0083BE" d="M104.762,32.399c-1.344,1.384-3.377,2.44-6.184,2.44c-2.805,0-4.799-1.058-6.141-2.44   c-1.951-2.032-2.439-4.637-2.439-8.134c0-3.457,0.488-6.061,2.439-8.094c1.342-1.383,3.336-2.44,6.141-2.44   c2.807,0,4.84,1.059,6.184,2.44c1.951,2.033,2.439,4.637,2.439,8.094C107.203,27.763,106.713,30.366,104.762,32.399z    M101.629,18.613c-0.773-0.773-1.83-1.181-3.051-1.181c-1.219,0-2.236,0.406-3.01,1.181c-1.26,1.261-1.422,3.416-1.422,5.652   s0.162,4.393,1.422,5.653c0.773,0.771,1.791,1.22,3.01,1.22c1.221,0,2.277-0.447,3.051-1.22c1.262-1.262,1.424-3.417,1.424-5.653   S102.891,19.873,101.629,18.613z"/>\n+\t<path fill="#0083BE" d="M123.643,34.596V22.029c0-3.214-1.83-4.597-4.147-4.597s-4.271,1.423-4.271,4.597v12.566h-4.147v-20.62   h4.065v2.074c1.425-1.546,3.416-2.318,5.49-2.318c2.115,0,3.865,0.691,5.084,1.871c1.586,1.545,2.074,3.497,2.074,5.815v13.178   L123.643,34.596L123.643,34.596z"/>\n+\t<path fill="#0083BE" d="M135.772,25.486c0,3.537,1.871,5.774,5.246,5.774c2.317,0,3.539-0.649,5.004-2.115l2.643,2.481   c-2.115,2.114-4.107,3.213-7.727,3.213c-5.166,0-9.273-2.725-9.273-10.574c0-6.671,3.457-10.534,8.744-10.534   c5.531,0,8.744,4.067,8.744,9.925v1.83H135.772z M144.475,19.791c-0.65-1.545-2.113-2.604-4.066-2.604   c-1.951,0-3.457,1.059-4.107,2.604c-0.406,0.936-0.488,1.546-0.529,2.807h9.273C145.003,21.337,144.883,20.726,144.475,19.791z"/>\n+\t<circle fill="#0083BE" cx="17.815" cy="11.516" r="4.402"/>\n+\t<path fill="#0083BE" d="M31.167,20.311c0,2.433-1.969,4.401-4.403,4.401c-2.427,0-4.401-1.97-4.401-4.401   c0-2.433,1.975-4.401,4.401-4.401C29.2,15.909,31.167,17.879,31.167,20.311z"/>\n+\t<circle fill="#0083BE" cx="17.801" cy="29.131" r="4.402"/>\n+\t<g>\n+\t\t<path fill="#0083BE" d="M20.441-0.045C9.207-0.044,0.1,9.063,0.099,20.298C0.1,31.532,9.207,40.639,20.441,40.641    c11.235-0.002,20.341-9.107,20.343-20.343C40.783,9.063,31.677-0.044,20.441-0.045z M31.891,31.747    c-2.937,2.934-6.972,4.742-11.45,4.743c-4.478-0.001-8.513-1.811-11.45-4.743C6.058,28.81,4.25,24.775,4.249,20.298    c0.001-4.478,1.809-8.513,4.743-11.45c2.937-2.934,6.972-4.742,11.45-4.743c4.478,0.001,8.513,1.81,11.45,4.743    c2.934,2.938,4.742,6.973,4.743,11.45C36.633,24.775,34.825,28.81,31.891,31.747z"/>\n+\t</g>\n+\t<g>\n+\t\t<path fill="#0083BE" d="M153.985,9.95c-1.195,0-2.164,0.971-2.164,2.168c0.002,1.197,0.969,2.168,2.164,2.168    c1.199,0,2.172-0.971,2.172-2.168S155.184,9.95,153.985,9.95z M153.985,13.968c-1.021-0.002-1.846-0.827-1.846-1.85    c0.002-1.021,0.825-1.849,1.846-1.851c1.023,0.002,1.852,0.828,1.854,1.851C155.836,13.141,155.008,13.966,153.985,13.968z"/>\n+\t</g>\n+\t<g>\n+\t\t<path fill="#0083BE" d="M154.507,13.409l-0.54-1.08h-0.486v1.08h-0.389v-2.564h0.994c0.484,0,0.796,0.313,0.796,0.75    c0,0.367-0.224,0.602-0.513,0.68l0.592,1.136L154.507,13.409L154.507,13.409z M154.056,11.195h-0.575v0.803h0.575    c0.261,0,0.437-0.147,0.437-0.399S154.317,11.195,154.056,11.195z"/>\n+\t</g>\n+</g>\n+</svg>\ndiff --git a/Products/CMFPlone/browser/static/search.js b/Products/CMFPlone/browser/static/search.js\ndeleted file mode 100644\nindex 0540ca94e3..0000000000\n--- a/Products/CMFPlone/browser/static/search.js\n+++ /dev/null\n@@ -1,130 +0,0 @@\n-/* The following line defines global variables defined elsewhere. */\n-/*globals require*/\n-\n-\n-if(require === undefined){\n-  require = function(reqs, torun){\n-    \'use strict\';\n-    return torun(window.jQuery);\n-  };\n-}\n-\n-require([\n-  \'jquery\',\n-], function($) {\n-  \'use strict\';\n-\n-  var $loader = $(\'.plone-loader\');\n-  if($loader.size() === 0){\n-    $loader = $(\'<div class="plone-loader"><div class="loader"/></div>\');\n-    $(\'body\').append($loader);\n-  }\n-\n-  var $filter = $(\'.actionMenu\');\n-  var $filterBtn = $(\'#search-filter-toggle\', $filter);\n-  var $advSearchInput = $(\'#advanced-search-input\');\n-  var $ctSelectAll = $(\'#pt_toggle\');\n-  var $selectAllContainer = $(\'.search-type-options\');\n-  var $sortingContainer = $(\'#sorting-options\');\n-\n-\n-  /* handle history */\n-  if (window.history && window.history.pushState){\n-    $(window).bind(\'popstate\', function () {\n-      /* we\'re just going to cheat and reload the page so\n-         we aren\'t keep moving around state here.. \n-         Here, I\'m lazy, we\'re not using react here... */\n-      window.location = window.location.href;\n-    });\n-  }\n-\n-  var pushHistory = function(){\n-    if(window.history && window.history.pushState){\n-      var url = window.location.origin + window.location.pathname + \'?\' + $(\'#searchform\').serialize();\n-      window.history.pushState(null, null, url);\n-    }\n-  };\n-\n-  var timeout = 0;\n-  var search = function(){\n-    $loader.show();\n-    pushHistory();\n-    $.ajax({\n-      url: window.location.origin + window.location.pathname + \'?ajax_load=1\',\n-      data: $(\'#searchform\').serialize()\n-    }).done(function(html){\n-      var $html = $(html);\n-      $(\'#search-results\').replaceWith($(\'#search-results\', $html));\n-      $(\'#search-term\').replaceWith($(\'#search-term\', $html));\n-      $(\'#results-count\').replaceWith($(\'#results-count\', $html));\n-      $loader.hide();\n-    });\n-  };\n-  var searchDelayed = function(){\n-    clearTimeout(timeout);\n-    timeout = setTimeout(search, 200);\n-  };\n-\n-  // for sorme reason the backend always flag with active class the sorting options\n-  var updateSortingState = function($el){\n-    $(\'a\', $sortingContainer).removeClass(\'active\');\n-    $el.addClass(\'active\');\n-  };\n-  var default_sort = $(\'#search-results\').attr(\'data-default-sort\');\n-  updateSortingState($(\'a[data-sort=\'+default_sort+\']\'));\n-\n-  /* sorting */\n-  $(\'a\', $sortingContainer).click(function(e){\n-    e.preventDefault();\n-    updateSortingState($(this));\n-    var sort = $(this).attr(\'data-sort\');\n-    var order = $(this).attr(\'data-order\');\n-    if(sort){\n-      $(\'[name="sort_on"]\').attr(\'value\', sort);\n-      if(order && order == \'reverse\'){\n-        $(\'[name="sort_order"]\').attr(\'value\', \'reverse\');\n-      }else{\n-        $(\'[name="sort_order"]\').attr(\'value\', \'\');\n-      }\n-    }else{\n-      $(\'[name="sort_on"]\').attr(\'value\', \'\');\n-      $(\'[name="sort_order"]\').attr(\'value\', \'\');\n-    }\n-    search();\n-  });\n-\n-\n-  /* form submission */\n-  $(\'.searchPage\').submit(function(e){\n-    e.preventDefault();\n-    search();\n-  });\n-\n-\n-  /* filters */\n-  $filterBtn.click(function(e){\n-    e.preventDefault();\n-    $filter.toggleClass(\'activated\');\n-    if($filter.hasClass(\'activated\')){\n-      $advSearchInput.attr(\'value\', \'True\');\n-    }else{\n-      $advSearchInput.attr(\'value\', \'False\');\n-    }\n-  });\n-\n-  $ctSelectAll.change(function(){\n-    if($ctSelectAll[0].checked){\n-      $(\'input\', $selectAllContainer).each(function(){\n-        this.checked = true;\n-      });\n-    }else{\n-      $(\'input\', $selectAllContainer).each(function(){\n-        this.checked = false;\n-      });\n-    }\n-  });\n-\n-  $(\'input\', $filter).change(function(){\n-    searchDelayed();\n-  });\n-});\ndiff --git a/Products/CMFPlone/browser/syndication/adapters.py b/Products/CMFPlone/browser/syndication/adapters.py\nindex 2fc6224cf4..8963610609 100644\n--- a/Products/CMFPlone/browser/syndication/adapters.py\n+++ b/Products/CMFPlone/browser/syndication/adapters.py\n@@ -12,10 +12,10 @@\n from Products.CMFCore.utils import getToolByName\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n \n-from Products.CMFPlone.interfaces.syndication import IFeed\n-from Products.CMFPlone.interfaces.syndication import IFeedItem\n-from Products.CMFPlone.interfaces.syndication import ISearchFeed\n-from Products.CMFPlone.interfaces.syndication import IFeedSettings\n+from plone.base.interfaces.syndication import IFeed\n+from plone.base.interfaces.syndication import IFeedItem\n+from plone.base.interfaces.syndication import ISearchFeed\n+from plone.base.interfaces.syndication import IFeedSettings\n from Products.CMFPlone.utils import getSiteLogo\n \n from plone.registry.interfaces import IRegistry\ndiff --git a/Products/CMFPlone/browser/syndication/configure.zcml b/Products/CMFPlone/browser/syndication/configure.zcml\nindex 6715bfa1f3..755ca9f8b6 100644\n--- a/Products/CMFPlone/browser/syndication/configure.zcml\n+++ b/Products/CMFPlone/browser/syndication/configure.zcml\n@@ -6,7 +6,7 @@\n   i18n_domain="Products.CMFPlone">\n \n   <class class="plone.dexterity.content.Container">\n-    <implements interface="Products.CMFPlone.interfaces.syndication.ISyndicatable" />\n+    <implements interface="plone.base.interfaces.syndication.ISyndicatable" />\n   </class>\n \n   <adapter factory=".settings.FeedSettings" />\n@@ -15,15 +15,15 @@\n   <adapter factory=".adapters.CollectionFeed"\n     for="plone.app.contenttypes.interfaces.ICollection" />\n   <adapter factory=".adapters.SearchFeed"\n-    for="Products.CMFPlone.interfaces.siteroot.IPloneSiteRoot"\n-    provides="Products.CMFPlone.interfaces.syndication.ISearchFeed" />\n+    for="plone.base.interfaces.siteroot.IPloneSiteRoot"\n+    provides="plone.base.interfaces.syndication.ISearchFeed" />\n   <adapter factory=".adapters.DexterityItem"\n     for="plone.dexterity.interfaces.IDexterityContent\n-         Products.CMFPlone.interfaces.syndication.IFeed"\n-    provides="Products.CMFPlone.interfaces.syndication.IFeedItem" />\n+         plone.base.interfaces.syndication.IFeed"\n+    provides="plone.base.interfaces.syndication.IFeedItem" />\n \n   <browser:page\n-    for="Products.CMFPlone.interfaces.syndication.ISyndicatable"\n+    for="plone.base.interfaces.syndication.ISyndicatable"\n     name="synPropertiesForm"\n     class=".views.SettingsFormView"\n     permission="cmf.ModifyPortalContent"\n@@ -33,12 +33,12 @@\n     for="*"\n     name="syndication-util"\n     class=".utils.SyndicationUtil"\n-    allowed_interface="Products.CMFPlone.interfaces.syndication.ISyndicationUtil"\n+    allowed_interface="plone.base.interfaces.syndication.ISyndicationUtil"\n     permission="zope2.View"\n     />\n \n   <browser:page\n-    for="Products.CMFPlone.interfaces.syndication.ISyndicatable"\n+    for="plone.base.interfaces.syndication.ISyndicatable"\n     class=".views.FeedView"\n     name="atom.xml"\n     permission="zope2.View"\n@@ -46,14 +46,14 @@\n     />\n \n   <browser:page\n-    for="Products.CMFPlone.interfaces.syndication.ISyndicatable"\n+    for="plone.base.interfaces.syndication.ISyndicatable"\n     class=".views.FeedView"\n     name="rss.xml"\n     permission="zope2.View"\n     template="templates/rss.xml.pt"\n     />\n   <browser:page\n-    for="Products.CMFPlone.interfaces.syndication.ISyndicatable"\n+    for="plone.base.interfaces.syndication.ISyndicatable"\n     class=".views.FeedView"\n     name="RSS"\n     permission="zope2.View"\n@@ -61,7 +61,7 @@\n     />\n \n   <browser:page\n-    for="Products.CMFPlone.interfaces.syndication.ISyndicatable"\n+    for="plone.base.interfaces.syndication.ISyndicatable"\n     class=".views.FeedView"\n     name="itunes.xml"\n     permission="zope2.View"\n@@ -77,7 +77,7 @@\n     />\n \n   <browser:page\n-    for="Products.CMFPlone.interfaces.syndication.ISyndicatable"\n+    for="plone.base.interfaces.syndication.ISyndicatable"\n     class=".views.NewsMLFeedView"\n     name="newsml.xml"\n     permission="zope2.View"\ndiff --git a/Products/CMFPlone/browser/syndication/settings.py b/Products/CMFPlone/browser/syndication/settings.py\nindex d74865d070..9158f83858 100644\n--- a/Products/CMFPlone/browser/syndication/settings.py\n+++ b/Products/CMFPlone/browser/syndication/settings.py\n@@ -1,10 +1,10 @@\n from zope.component import adapts\n from zope.interface import implementer\n-from Products.CMFPlone.interfaces.syndication import IFeedSettings\n-from Products.CMFPlone.interfaces.syndication import ISyndicatable\n+from plone.base.interfaces.syndication import IFeedSettings\n+from plone.base.interfaces.syndication import ISyndicatable\n from zope.annotation.interfaces import IAnnotations\n from persistent.dict import PersistentDict\n-from Products.CMFPlone.interfaces.syndication import ISiteSyndicationSettings\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from zope.component import getUtility\n from plone.registry.interfaces import IRegistry\n \ndiff --git a/Products/CMFPlone/browser/syndication/tool.py b/Products/CMFPlone/browser/syndication/tool.py\nindex d142ebaa61..ba622337e6 100644\n--- a/Products/CMFPlone/browser/syndication/tool.py\n+++ b/Products/CMFPlone/browser/syndication/tool.py\n@@ -11,9 +11,9 @@\n from Products.CMFCore.permissions import ModifyPortalContent\n from Products.CMFCore.permissions import ManagePortal\n \n-from Products.CMFPlone.interfaces.syndication import IFeed\n-from Products.CMFPlone.interfaces.syndication import ISiteSyndicationSettings\n-from Products.CMFPlone.interfaces.syndication import IFeedSettings\n+from plone.base.interfaces.syndication import IFeed\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n+from plone.base.interfaces.syndication import IFeedSettings\n \n from plone.registry.interfaces import IRegistry\n \ndiff --git a/Products/CMFPlone/browser/syndication/utils.py b/Products/CMFPlone/browser/syndication/utils.py\nindex 3115b10976..9e3171ba61 100644\n--- a/Products/CMFPlone/browser/syndication/utils.py\n+++ b/Products/CMFPlone/browser/syndication/utils.py\n@@ -5,10 +5,10 @@\n from zope.interface import implementer\n from zope.component import getUtility\n \n-from Products.CMFPlone.interfaces.syndication import ISyndicationUtil\n-from Products.CMFPlone.interfaces.syndication import IFeedSettings\n-from Products.CMFPlone.interfaces.syndication import ISiteSyndicationSettings\n-from Products.CMFPlone.interfaces.syndication import ISyndicatable\n+from plone.base.interfaces.syndication import ISyndicationUtil\n+from plone.base.interfaces.syndication import IFeedSettings\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n+from plone.base.interfaces.syndication import ISyndicatable\n \n from plone.registry.interfaces import IRegistry\n from plone.memoize.view import memoize\ndiff --git a/Products/CMFPlone/browser/syndication/views.py b/Products/CMFPlone/browser/syndication/views.py\nindex 47c40db01c..cda7137a35 100644\n--- a/Products/CMFPlone/browser/syndication/views.py\n+++ b/Products/CMFPlone/browser/syndication/views.py\n@@ -1,9 +1,9 @@\n from DateTime import DateTime\n from plone.z3cform.layout import wrap_form\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces.syndication import IFeed\n-from Products.CMFPlone.interfaces.syndication import IFeedSettings\n-from Products.CMFPlone.interfaces.syndication import ISearchFeed\n+from plone.base.interfaces.syndication import IFeed\n+from plone.base.interfaces.syndication import IFeedSettings\n+from plone.base.interfaces.syndication import ISearchFeed\n from Products.Five import BrowserView\n from uuid import NAMESPACE_OID\n from uuid import uuid3\ndiff --git a/Products/CMFPlone/browser/templates/accessibility-info.pt b/Products/CMFPlone/browser/templates/accessibility-info.pt\nindex f7b350eab5..1b7a1b15c2 100644\n--- a/Products/CMFPlone/browser/templates/accessibility-info.pt\n+++ b/Products/CMFPlone/browser/templates/accessibility-info.pt\n@@ -16,11 +16,11 @@\n \n \n       <p><tal:i18n i18n:translate="description_accessibility_info">\n-            This site uses the open source Content Management System <a href="https://plone.com" i18n:name="plone">Plone</a>.\n+            This site uses the open source Content Management System <a href="https://plone.org" i18n:name="plone">Plone</a>.\n             It meets the Web Content Accessibility Guidelines\n \t    (<a href="https://www.w3.org/TR/WCAG20/"><acronym i18n:name="wcag"\n                   title="Web Content Accessibility Guidelines"\n-                  i18n:attributes="title title_wcag;">WCAG</acronym> v2.0</a>) level \'AA\' for people with disabilities,\n+                  i18n:attributes="title title_wcag;">WCAG</acronym> v2.1</a>) level \'AA\' for people with disabilities,\n             including blindness and low vision, deafness and hearing loss, learning disabilities,\n             cognitive limitations, limited movement, speech disabilities, photosensitivity,\n             and combinations of these.</tal:i18n></p>\n@@ -54,7 +54,7 @@\n         A number of checkpoints in\n         <acronym i18n:name="wcag"\n                  title="Web Content Accessibility Guidelines"\n-                 i18n:attributes="title title_wcag;">WCAG</acronym> 2.0 and <acronym i18n:name="atag"\n+                 i18n:attributes="title title_wcag;">WCAG</acronym> 2.1 and <acronym i18n:name="atag"\n                  title="Authoring Tool Accessibility Guidelines"\n                  i18n:attributes="title title_atag;">ATAG</acronym> 2.0 guidelines are\n         subjective; there may be instances where interpretations vary.\ndiff --git a/Products/CMFPlone/browser/templates/ajax_main_template.pt b/Products/CMFPlone/browser/templates/ajax_main_template.pt\nindex 41f51e15ab..81eab03a4a 100644\n--- a/Products/CMFPlone/browser/templates/ajax_main_template.pt\n+++ b/Products/CMFPlone/browser/templates/ajax_main_template.pt\n@@ -5,25 +5,26 @@\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-    tal:define="portal_state context/@@plone_portal_state;\n-        context_state context/@@plone_context_state;\n-        plone_view context/@@plone;\n-        plone_layout context/@@plone_layout;\n-        lang portal_state/language;\n-        view nocall:view | nocall: plone_view;\n-        dummy python: plone_layout.mark_view(view);\n-        portal_url portal_state/portal_url;\n-        checkPermission nocall: context/portal_membership/checkPermission;\n-        site_properties context/portal_properties/site_properties;\n-        ajax_include_head request/ajax_include_head | nothing;\n-        ajax_load python:True;"\n-    i18n:domain="plone"\n-    tal:attributes="lang lang;">\n+      tal:define="portal_state python:context.restrictedTraverse(\'@@plone_portal_state\');\n+          context_state python:context.restrictedTraverse(\'@@plone_context_state\');\n+          plone_view python:context.restrictedTraverse(\'@@plone\');\n+          icons python:context.restrictedTraverse(\'@@iconresolver\');\n+          plone_layout python:context.restrictedTraverse(\'@@plone_layout\');\n+          lang python:portal_state.language();\n+          view nocall:view | nocall: plone_view;\n+          dummy python: plone_layout.mark_view(view);\n+          portal_url python:portal_state.portal_url();\n+          checkPermission python:context.restrictedTraverse(\'portal_membership\').checkPermission;\n+          site_properties python:context.restrictedTraverse(\'portal_properties\').site_properties;\n+          ajax_include_head python:request.get(\'ajax_include_head\', False);\n+          ajax_load python:False;"\n+      i18n:domain="plone"\n+      tal:attributes="lang lang;">\n \n     <metal:cache tal:replace="structure provider:plone.httpheaders" />\n \n <head>\n-    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n+    <meta charset="utf-8" />\n \n     <tal:ajaxhead condition="ajax_include_head">\n     <div tal:replace="structure provider:plone.htmlhead" />\n@@ -39,7 +40,7 @@\n     <metal:javascriptslot define-slot="javascript_head_slot" />\n \n     <link tal:replace="structure provider:plone.htmlhead.links" />\n-    <meta name="generator" content="Plone - http://plone.com" />\n+    <meta name="generator" content="Plone - http://plone.org" />\n     </tal:ajaxhead>\n \n </head>\n@@ -74,23 +75,19 @@\n \n                         <header>\n                          <metal:title define-slot="content-title">\n-                             <metal:comment tal:content="nothing">\n-                                 If you write a custom title always use\n-                                 <h1 class="documentFirstHeading"></h1> for it\n-                             </metal:comment>\n-                             <h1 metal:use-macro="context/kss_generic_macros/macros/generic_title_view">\n-                                 Generic KSS Title. Is rendered with class="documentFirstHeading".\n-                             </h1>\n+                            <h1  class="documentFirstHeading">${python:context.Title()}</h1>\n+                            <metal:comment tal:content="nothing">\n+                                If you write a custom title always use\n+                                <h1 class="documentFirstHeading"></h1> for it\n+                            </metal:comment>\n                          </metal:title>\n \n                          <metal:description define-slot="content-description">\n-                             <metal:comment tal:content="nothing">\n-                                 If you write a custom description always use\n-                                 <div class="documentDescription"></div> for it\n-                             </metal:comment>\n-                           <div metal:use-macro="context/kss_generic_macros/macros/generic_description_view">\n-                               Generic KSS Description. Is rendered with class="documentDescription".\n-                           </div>\n+                            <div class="documentDescription">${python:context.Description()}</div>\n+                            <metal:comment tal:content="nothing">\n+                                If you write a custom description always use\n+                                <div class="documentDescription"></div> for it\n+                            </metal:comment>\n                          </metal:description>\n                         </header>\n \ndiff --git a/Products/CMFPlone/browser/templates/author.pt b/Products/CMFPlone/browser/templates/author.pt\nindex 7edf51c991..19cd4b0d6e 100644\n--- a/Products/CMFPlone/browser/templates/author.pt\n+++ b/Products/CMFPlone/browser/templates/author.pt\n@@ -78,11 +78,11 @@\n                 </h1>\n \n                 <div class="autotabs" tal:omit-tag="not:isOwner">\n-                  <nav class="autotoc-nav" tal:condition="isOwner">\n-                    <a class="active"\n+                  <nav class="autotoc-nav nav nav-tabs" tal:condition="isOwner">\n+                    <a class="nav-link active"\n                        href="${portal_url}/author/${view/member_info/url}"\n                        i18n:translate="label_view">View</a>\n-                    <a href="${portal_url}/@@personal-information"\n+                    <a class="nav-link" href="${portal_url}/@@personal-information"\n                        i18n:translate="label_edit">Edit</a>\n                   </nav>\n \n@@ -155,7 +155,7 @@\n                           <div class="formControls" tal:condition="isAnon">\n                           <form\n                             tal:attributes="action string:$portal_url/login">\n-                             <input class="standalone"\n+                             <input class="btn btn-secondary"\n                                  type="submit"\n                                  value="Log in to send feedback"\n                                  i18n:attributes="value label_login_to_send_feedback;"\n@@ -192,7 +192,7 @@\n                           </h2>\n \n                           <div metal:define-macro="user_content_listing">\n-                          <table class="vertical listing"\n+                          <table class="table"\n                                  summary="Lists content written by an author grouped by content type"\n                                  i18n:attributes="summary summary_author_content_list;">\n                               <thead>\ndiff --git a/Products/CMFPlone/browser/templates/colophon.pt b/Products/CMFPlone/browser/templates/colophon.pt\nindex be0cec0c2f..b6f1f68589 100644\n--- a/Products/CMFPlone/browser/templates/colophon.pt\n+++ b/Products/CMFPlone/browser/templates/colophon.pt\n@@ -6,13 +6,13 @@\n       tal:omit-tag=""\n       i18n:domain="plone">\n \n-  <aside class="portlet portletClassic" id="portal-colophon" metal:define-macro="portlet">\n-    <div class="portletContent">\n-      <a href="http://plone.com" target="_blank"\n+  <div class="card card-classic" id="portal-colophon" metal:define-macro="portlet">\n+    <div class="card-body">\n+      <a href="http://plone.org" target="_blank"\n          title="This site was built using the Plone Open Source CMS/WCM."\n          i18n:attributes="title title_built_with_plone;"\n          i18n:translate="label_powered_by_plone">\n-        Powered by Plone &amp; Python</a>\n+        Powered by Plone</a>\n     </div>\n-  </aside>\n+  </div>\n </html>\ndiff --git a/Products/CMFPlone/browser/templates/description.pt b/Products/CMFPlone/browser/templates/description.pt\nindex 159c3534b4..ff12729b8a 100644\n--- a/Products/CMFPlone/browser/templates/description.pt\n+++ b/Products/CMFPlone/browser/templates/description.pt\n@@ -1,6 +1,3 @@\n-<div class="documentDescription description"\n-    tal:define="description context/Description"\n-    tal:content="description"\n-    tal:condition="description">\n+<p class="lead" tal:define="description context/Description" tal:content="description" tal:condition="description">\n   Description\n-</div>\n+</p>\ndiff --git a/Products/CMFPlone/browser/templates/error_message.pt b/Products/CMFPlone/browser/templates/error_message.pt\nindex f68a5d4774..bb375632f7 100644\n--- a/Products/CMFPlone/browser/templates/error_message.pt\n+++ b/Products/CMFPlone/browser/templates/error_message.pt\n@@ -31,7 +31,7 @@\n                         If you are certain you have the correct web address but are encountering an error, please\n                         contact the <span i18n:name="site_admin">\n                         <a href="#"\n-                           i18n:translate="label_site_admin"\n+                           i18n:translate="label_site_administration"\n                            tal:attributes="href string:${context/portal_url}/contact-info">site administration</a></span>.\n                     </p>\n \ndiff --git a/Products/CMFPlone/browser/templates/footer.pt b/Products/CMFPlone/browser/templates/footer.pt\nindex 76628ee08e..2581534645 100644\n--- a/Products/CMFPlone/browser/templates/footer.pt\n+++ b/Products/CMFPlone/browser/templates/footer.pt\n@@ -6,12 +6,13 @@\n       tal:omit-tag=""\n       i18n:domain="plone">\n \n-  <aside class="portlet portletClassic" id="portal-footer-signature" metal:define-macro="portlet">\n-    <div class="portletContent">\n+  <div class="card card-classic" id="portal-footer-signature" metal:define-macro="portlet">\n+\n+    <div class="card-body">\n       <span i18n:translate="description_copyright" tal:omit-tag="">\n       The\n       <span i18n:name="plonecms" tal:omit-tag="">\n-           <a href="http://plone.com" i18n:translate="label_plone_cms">Plone<sup>&reg;</sup> Open Source CMS/WCM</a>\n+           <a href="http://plone.org" i18n:translate="label_plone_cms">Plone<sup>&reg;</sup> Open Source CMS/WCM</a>\n       </span>\n       is\n       <abbr title="Copyright" i18n:name="copyright" i18n:attributes="title title_copyright;">&copy;</abbr>\n@@ -31,5 +32,7 @@\n                 <a href="http://creativecommons.org/licenses/GPL/2.0/" i18n:translate="label_gnu_gpl_licence">GNU GPL license</a></span>.\n       </span>\n     </div>\n-  </aside>\n+\n+  </div>\n+\n </html>\ndiff --git a/Products/CMFPlone/browser/templates/main_template.pt b/Products/CMFPlone/browser/templates/main_template.pt\nindex 4f8a6cce60..50c5be24f0 100644\n--- a/Products/CMFPlone/browser/templates/main_template.pt\n+++ b/Products/CMFPlone/browser/templates/main_template.pt\n@@ -8,6 +8,7 @@\n       tal:define="portal_state python:context.restrictedTraverse(\'@@plone_portal_state\');\n           context_state python:context.restrictedTraverse(\'@@plone_context_state\');\n           plone_view python:context.restrictedTraverse(\'@@plone\');\n+          icons python:context.restrictedTraverse(\'@@iconresolver\');\n           plone_layout python:context.restrictedTraverse(\'@@plone_layout\');\n           lang python:portal_state.language();\n           view nocall:view | nocall: plone_view;\n@@ -23,7 +24,7 @@\n     <metal:cache tal:replace="structure provider:plone.httpheaders" />\n \n   <head>\n-    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n+    <meta charset="utf-8" />\n \n     <div tal:replace="structure provider:plone.htmlhead" />\n \n@@ -38,7 +39,7 @@\n     <metal:javascriptslot define-slot="javascript_head_slot" />\n \n     <link tal:replace="structure provider:plone.htmlhead.links" />\n-    <meta name="generator" content="Plone - http://plone.com" />\n+    <meta name="generator" content="Plone - https://plone.org/" />\n \n   </head>\n \n@@ -55,17 +56,21 @@\n \n     <header id="portal-top" i18n:domain="plone">\n       <div tal:replace="structure provider:plone.portaltop" />\n+      <div id="portal-header">\n+        <div tal:replace="structure provider:plone.portalheader" />\n+      </div>\n+\n     </header>\n \n     <div id="portal-mainnavigation" tal:content="structure provider:plone.mainnavigation">\n       The main navigation\n     </div>\n \n-    <aside id="global_statusmessage">\n+    <section id="global_statusmessage">\n       <tal:message tal:content="structure provider:plone.globalstatusmessage"/>\n       <div metal:define-slot="global_statusmessage">\n       </div>\n-    </aside>\n+    </section>\n \n     <div id="viewlet-above-content" tal:content="structure provider:plone.abovecontent" />\n \n@@ -73,53 +78,52 @@\n \n       <metal:block define-slot="content">\n \n-      <div metal:define-macro="content">\n-\n+      <metal:content metal:define-macro="content">\n \n         <metal:slot define-slot="body">\n \n-        <article id="content">\n+          <article id="content">\n \n-          <metal:bodytext define-slot="main">\n+            <metal:bodytext define-slot="main">\n \n-          <header>\n-            <div id="viewlet-above-content-title" tal:content="structure provider:plone.abovecontenttitle" />\n-            <metal:title define-slot="content-title">\n-              <h1 tal:replace="structure context/@@title" />\n-            </metal:title>\n-            <div id="viewlet-below-content-title" tal:content="structure provider:plone.belowcontenttitle" />\n+              <header>\n \n-            <metal:description define-slot="content-description">\n-              <p tal:replace="structure context/@@description" />\n-            </metal:description>\n-          </header>\n+                <div id="viewlet-above-content-title" tal:content="structure provider:plone.abovecontenttitle" />\n \n-          <div id="viewlet-above-content-body" tal:content="structure provider:plone.abovecontentbody" />\n-          <div id="content-core">\n-            <metal:text define-slot="content-core" tal:content="nothing">\n-              Page body text\n-            </metal:text>\n-          </div>\n-          <div id="viewlet-below-content-body" tal:content="structure provider:plone.belowcontentbody" />\n+                <metal:title define-slot="content-title">\n+                  <h1 tal:replace="structure context/@@title" />\n+                </metal:title>\n \n-          </metal:bodytext>\n-        </article>\n+                <div id="viewlet-below-content-title" tal:content="structure provider:plone.belowcontenttitle" />\n \n-        </metal:slot>\n+                <metal:description define-slot="content-description">\n+                  <p tal:replace="structure context/@@description" />\n+                </metal:description>\n \n-<!--                 <metal:sub define-slot="sub" tal:content="nothing">\n-                   This slot is here for backwards compatibility only.\n-                   Don\'t use it in your custom templates.\n-                </metal:sub> -->\n-      </div>\n+                <div id="viewlet-below-content-description" tal:content="structure provider:plone.belowcontentdescription" />\n \n-      </metal:block>\n-      <footer>\n-        <div id="viewlet-below-content" tal:content="structure provider:plone.belowcontent" />\n-      </footer>\n-    </article>\n+              </header>\n+\n+              <div id="viewlet-above-content-body" tal:content="structure provider:plone.abovecontentbody" />\n \n+              <div id="content-core">\n+                <metal:text define-slot="content-core" tal:content="nothing">\n+                  Page body text\n+                </metal:text>\n+              </div>\n \n+              <div id="viewlet-below-content-body" tal:content="structure provider:plone.belowcontentbody" />\n+\n+            </metal:bodytext>\n+            <footer>\n+              <div id="viewlet-below-content" tal:content="structure provider:plone.belowcontent" />\n+            </footer>\n+          </article>\n+        </metal:slot>\n+      </metal:content>\n+\n+      </metal:block>\n+    </article>\n \n     <aside id="portal-column-one"\n            metal:define-slot="column_one_slot"\ndiff --git a/Products/CMFPlone/browser/templates/plone-addsite.pt b/Products/CMFPlone/browser/templates/plone-addsite.pt\nindex 1d8a602c13..95641ab424 100644\n--- a/Products/CMFPlone/browser/templates/plone-addsite.pt\n+++ b/Products/CMFPlone/browser/templates/plone-addsite.pt\n@@ -1,214 +1,219 @@\n-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"\n-  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      i18n:domain="plone">\n+<!DOCTYPE html\n+  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:tal="http://xml.zope.org/namespaces/tal"\n+  xmlns:metal="http://xml.zope.org/namespaces/metal" xmlns:i18n="http://xml.zope.org/namespaces/i18n" lang="en"\n+  i18n:domain="plone">\n \n <head>\n-  <meta charset="utf-8"/>\n-  <meta name="viewport" content="width=device-width, initial-scale=1"/>\n+  <meta charset="utf-8" />\n+  <meta name="viewport" content="width=device-width, initial-scale=1" />\n   <title i18n:translate="">Create a Plone site</title>\n-  <link rel="stylesheet" type="text/css"\n-        tal:attributes="href string:${context/absolute_url}/++resource++plone-admin-ui.css"\n-        href="/++resource++plone-admin-ui.css" />\n-  <script type="text/javascript" tal:attributes="src string:${context/absolute_url}/++resource++jstz-1.0.4.min.js"></script>\n-  <script type="text/javascript" tal:attributes="src string:${context/absolute_url}/++resource++plone-admin-ui.js"></script>\n+  <link rel="stylesheet"\n+        type="text/css"\n+        href="${string:${context/absolute_url}/++theme++barceloneta/css/barceloneta.min.css}" />\n+  <link rel="stylesheet"\n+        type="text/css"\n+        href="${string:${context/absolute_url}/++resource++plone-admin-ui.css}" />\n+  <script type="text/javascript" tal:attributes="src string:${context/absolute_url}/++resource++jstz-1.0.4.min.js">\n+  </script>\n+  <script type="text/javascript" tal:attributes="src string:${context/absolute_url}/++resource++plone-admin-ui.js">\n+  </script>\n </head>\n \n <body>\n \n-<div id="box">\n-    <header><h1><img src="/++resource++plone-logo.png" width="108" height="28"\n-         tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.png"\n-         alt="Plone logo" i18n:attributes="alt"/></h1>\n+  <div class="container admin mt-5 mb-5 p-4 ">\n+    <header class="row">\n+      <p><img src="/++resource++plone-logo.svg"\n+               width="215" height="56"\n+               tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.svg"\n+               alt="Plone logo"\n+               i18n:attributes="alt" /></p>\n     </header>\n-    <article>\n-  <div class="circle running">\n-            <img alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAACddJREFUeNrsnA1sE9cdwM93F9uxkzi2m2UhEUajnRKjKUK0hGkfTJuKoHyoa8WaFg3URZHWIkQ2aQi28bEMJCATyqRqXdhIQCUDoa6FDfEVCBWofH9UITQCoqQhsY2zOLEdO/66O+//8PNIUdbYd2d8576/9JRLnHu+937v/3////+9d5p4PE4RUY5oCBAChAgBQoAQIUAIECIECAFChAAhQEgvECBECBAChEhWgWg0GlH3qX1ATNfudNtHK73BLpfLEA6H6zmOOw6Nc8GfeChBQRC6otFoUzAYrNaIHQ1EQ1IfQaiTQ6HQz3U63Xa4zIc/+RAIKDE8kHRQTFDMsVjsuNPpbLDZbC61a4gigUBdNGjFewDjDfjVASU6TTUW0BjW5/MttVgs3fFnaAdzHgiCAWbodwaDoR5+/U8aVeUBFN29e/d+VFVV5SJAZACCzNTg4OBLFRUVH8GvbhHVaSORSL9er/8p1MsTINKBMGCqjoGpmoE+EvkoJoD6i5kzZ158FqYrp72sjo6OcoDxQrKtIovfbDa/qQYPciphFeTP0w6H42W4nJBaF0D9Dm4brzYgShpFtFartUkwVU9GGcsid5ghGiIRCM/zLDY7UrWNnzdvXp4agSjKzsKEPiZHPQA2ePPmTYEAkSZxmEPuy1ERxDEDcpi+rzsQobGx8RrHcQEJHtbj4nQ6b6hxQlcckNOnTwf6+/tPSakEAW1ubv43uiRApNirRAQV2bBhw2GYSx6JrefWrVsftLS0uImGyCPc0aNHh1tbW3fBSJ9I11QNDAx01NTUfIz8A+Crykk9o6kTn8/3PARpi+GzojRMDu33+xl4rtKysrLvpXpfJBIZHRoaOme1Whm9Xs/RNJ1qw3j4rp7u7u6T4CrHsp06yRQQGjroDxDo/RquQ2h+EOMFQ/Gm8f8o7rCKeXQU3AuCMOjxeF4tKSl5kGtANF6vt85kMm2nEulztbifetDO6I4dO17cunVrOJeA5EWj0Qt5eXkFKjThukePHv0WTOU/U80UqyHbm8eyrJlSp0QYhnk+m85OJnJZNMolUTLkpLLi5nEcg4FkxW3OxEjQqDVt8Tg6FQRNNgcTTRFRlGQq/a4hXUs0hGhIOhqCUhkQLI6h3SDIJQZPzEC6/9lriOB0Oi8fOnToj3PmzKnNz89/22Aw1AGQNyH4Wnf79u1/hMPhUYIhs4FhIdR5LRgMDu7bt695/fr13Th9EsEplDgeCEg79XPnzjW3t7e/VVVV9ZoS5h6Hw9FeUVGxG9rw9G5Jrd/vLygqKhqnEttZVRMYxgOBwJ3ly5f/CmBcw+kTtDSLGoIWn4L4Gu3VHQUtGbLb7e+fOnUKdYKi1jBGRkbKotFoI7jCn6FnBhjDaGDBczpisdgBGHSL5B5EmQDCbdy48Tfnz58fohLJQZQX4qaITQSsNQjS6JIlS05evXr1b5TE1UI5yqxZs+iJiYm1Vqu1W6vVvkvTNNrF8gWUXij30T5wMLuLjEbjxwCmA8yyTckmi8GFTyXaRd+PjxOg3ezFo6OjfzabzdXZ0oqhoaHDAMIO893LWLuny1QbQYNor9f7Otx39emBp9qtpBiK4dixYz9ZsWJFU7aA8DzPgBjh0p+Otwrt0A0ODv7QZrP15QQQXAdbWlpqgYb9C0yCJUtMGEpcHosBt/6OXq9/ffL9aj9Bxbvd7hB4M3ez+Qxi79PpdPMHBga+K2WiVxQQvAbBwUTpVcLkLqIEi4uLfyalX5WYOhEm+/lqE3AGXpSSAWGV2CiwwyWUShOULMuWUBI2eitRQzQGg6FStakPjSYupV8VpyE3btx4AYKxmdT0Bz0VKXj+o3ICCDrSNj4+vk6tMJAEAoH7lIQV04yYLHCWNCJgoAOfPygoKFhBqVgg0r8owXXOCBCa47imdOt2OBzfnjFjRhuVONKmRpdXE41G3Q0NDceVBgRtA3obota2u3fvFqSiGT6fb1FZWdknNE0zataOK1eu/LWzsxNlsTklAUHzkh8m5lcqKys/DwaDv5wKzLZt21BGtQYmwQ9NJtNR4BLDIyuroxwi7XMw0n3p3tfb23t44cKFJ6lEBlv0HJKpBaquSXBQ6prlef6WIAgo8RaF/7UyDPMS/HyOSiTxgkoZ5T09Pe379+8/t3nz5t/DfPatFOZL7vr16+/X1NQcohLrPl8CooTkIgJy5+mPoWipxIboZDQeoRR4huPhw4f7bTbbX2bPnl105MiRN+x2+6s4UP1yOkEQYm63+9LevXvbQNt78MBKropSSgciuyMH7nGfx+PpBbM3CnMPW1hY+A2r1VoJnVcqpWKn09laXl7+J2zOC3Q6nXHPnj326urq2fAdxaFQKOByudy7d+/+7PLly2NYuyewqx6fQoMUAaQ7Q+40Dzb+TEtLy5GdO3d+gXNeyXkHOQR5Bw4cmLt06dLVAKdaJJB9AGQnnpjZSZqdhyHF8WcxDCH2VZqes0Bgoh09ePBgY11d3XU8IpMmLz7JQUFQ9FCM4PGsnD9//jtojUUMkOQmB7xwRuOS3CaLzJKAstNqedeJrJ4PeGL+Xbt2NQAMFHR5oPigoUEo6OhaBJcQNh8odTGyYMGCg2fOnNmOU/rpfN/THYoEnbKKIUj4J5+pF9uoYediHDp2x5YtW9C8hNzR8P979RLuPA5rkHfx4sUnHjx40K6mWEbxQIaHhz9dtmzZOZQmwqNz2pGZPNGLANbX1/8dzN3I1x2IbObq7NmzrdSTdy2m4wAgKNELFy54+vr6PpRitoiGPJnI3atWrbpNJTanpW2z8dHocGdnZwcxWTIIxBh9UwVbaQq3du3a3im2hhKTRaWfPUWBlySPBmsJ2jjhUbq5UryGsCyro+Q5HidAvKAjJkui6PX6cjnqWb16tR7gWtUARNFH2vLz8+1NTU3otRxh0Q8C0t/f/321vI48IxrCcdy4TOkYzZo1a2rRCzIlVMOUlJS8lYZn5881IMLY2NgVuaJ0i8Wyrq2trUiCdswzGo0/TtEB4C+CUFk81p2R8yHQge/JtR2UYZii2traZjFacuLEicKKioq9OKic9rsAXjvMN+jlM9lbp0EepRxlsomAYtq0aVON0+n8AMDch8+dEosXYpI9K1euZFJ9nq6uLjOYn0/gevir6hYE4eH4+Pinly5dWg/P/U0oOpHtlqV/M3UcATkL6IwFWkvXU9Leofu/vBTOZ/EpPg9axyjERTtN/TGcngngrIAgst1TAkmrHzN4PoTBYFgZTOPj4A53XKqd9XjBCn+/ZhogyQ3enNzzh+oO7OS6ECAECBFZI2oChAAhQoAQIEQIEAKECAFCgBAhQAgQ0gsECBEChAAhQoAQIEQIkByX/wowAMMaJ3rGLu+BAAAAAElFTkSuQmCC" />\n-        </div>\n-  <h1 i18n:translate="">Create a Plone site</h1>\n-\n-  <form action="#"\n-        method="post"\n-        tal:attributes="action string:${context/absolute_url}/@@plone-addsite"\n-        tal:define="profiles view/profiles;\n-                    base_profiles profiles/base;\n-                    default_profile profiles/default;\n-                    extension_profiles profiles/extensions;\n-                    advanced request/advanced|nothing;">\n-\n-      <div class="field">\n-        <label for="site_id" i18n:translate="">\n-          Path identifier\n-        </label>\n-\n-        <div class="formHelp" i18n:translate="">\n-          The ID of the site. This ends up as part of the URL.<br />\n-          No special characters or spaces are allowed.\n+    <form action="#"\n+    method="post"\n+    tal:attributes="action string:${context/absolute_url}/@@plone-addsite"\n+    tal:define="profiles view/profiles;\n+                base_profiles profiles/base;\n+                default_profile profiles/default;\n+                extension_profiles profiles/extensions;\n+                advanced request/advanced|nothing;">\n+      <article class="row">\n+        <div class="col-md-12">\n+          <h1><span i18n:translate="">Create a Plone site</span></h1>\n+          <p class="lead" i18n:translate="">Adds a new Plone content management system site to the underlying application server.</p>\n         </div>\n \n-        <input type="text" name="site_id" size="20" id="site_id"\n-               tal:attributes="value request/site_id|nothing" />\n-      </div>\n+          <div class="col-md-12 mb-3 mb-3">\n+            <label for="site_id" class="form-label" i18n:translate="">\n+              Path identifier\n+            </label>\n \n-      <div class="field">\n-        <label for="title" i18n:translate="label_title">Title</label>\n+            <input type="text"\n+                  name="site_id"\n+                  size="20" id="site_id"\n+                  class="form-control"\n+                  tal:attributes="value request/site_id|nothing" />\n \n-        <div class="formHelp" i18n:translate="">\n-          A short title for the site. This will be shown in the title of the\n-          browser window on each page.\n-        </div>\n+            <div class="form-text" i18n:translate="">\n+              The ID of the site. No special characters or spaces are allowed. This ends up as part of the URL unless hidden by an upstream web server.\n+            </div>\n+\n+          </div>\n \n-        <input type="text" name="title" size="30" value="Site"\n-               i18n:attributes="value text_default_site_title;" />\n-      </div>\n+          <div class="col-md-12 mb-3">\n+            <label for="title" class="form-label" i18n:translate="label_title">Title</label>\n \n-      <div class="field">\n-        <label for="default_language" i18n:translate="">Language</label>\n+            <input type="text" name="title" size="30" value="Site" class="form-control" i18n:attributes="value text_default_site_title;" />\n \n-        <div class="formHelp" i18n:translate="">\n-          The main language of the site.\n-        </div>\n+            <div class="form-text" i18n:translate="">\n+              A short title for the site. This will be shown as part of the title of the browser window on each page.\n+            </div>\n+\n+          </div>\n+\n+          <div class="col-md-12 mb-3">\n+            <label for="default_language" class="form-label" i18n:translate="">Language</label>\n \n-        <select name="default_language"\n-                tal:define="browser_language view/browser_language;\n-                            grouped_languages python:view.grouped_languages(browser_language)">\n-            <optgroup tal:repeat="group grouped_languages" tal:attributes="label group/label">\n+            <select name="default_language" class="form-select"\n+                    tal:define="browser_language view/browser_language;\n+                                grouped_languages python:view.grouped_languages(browser_language)">\n+              <optgroup tal:repeat="group grouped_languages"\n+                        tal:attributes="label group/label">\n \n-              <option value="en"\n-                      tal:repeat="lang group/languages"\n-                      tal:attributes="value python:lang[\'langcode\'];\n-                                      selected python:lang[\'langcode\'] == browser_language"\n-                      tal:content="python: lang[\'label\']">\n+                <option value="en"\n+                        tal:repeat="lang group/languages"\n+                        tal:attributes="value python:lang[\'langcode\'];\n+                                        selected python:lang[\'langcode\'] == browser_language"\n+                        tal:content="python: lang[\'label\']">\n                   English\n-              </option>\n+                </option>\n \n-            </optgroup>\n-        </select>\n-      </div>\n+              </optgroup>\n+            </select>\n \n-      <div class="field">\n-        <label for="portal_timezone" i18n:translate="">\n-          Default timezone\n-        </label>\n+            <div class="form-text" i18n:translate="">\n+              The main language of the site.\n+            </div>\n \n-        <div class="formHelp" i18n:translate="">\n-          The default timezone setting of the portal. Users will be able to set\n-          their own timezone, if available timezones are defined in the date and\n-          time settings.\n-        </div>\n+          </div>\n \n-        <select id="portal_timezone"\n-          name="portal_timezone"\n-          tal:define="tz_list view/timezones">\n-          <optgroup tal:repeat="group tz_list" tal:attributes="label group">\n-          <option value="UTC"\n-                  tal:repeat="tz python:tz_list[group]"\n-                  tal:attributes="value tz/value"\n+          <div class="col-md-12 mb-3 tzx">\n+            <label for="portal_timezone" i18n:translate="" class="form-label">\n+              Default timezone\n+            </label>\n+\n+            <select id="portal_timezone"\n+                    name="portal_timezone"\n+                    class="form-select"\n+                    tal:define="tz_list view/timezones">\n+              <optgroup tal:repeat="group tz_list"\n+                        tal:attributes="label group">\n+                <option value="UTC" tal:repeat="tz python:tz_list[group]" tal:attributes="value tz/value"\n                   tal:content="tz/label">\n-              UTC\n-          </option>\n-          </optgroup>\n-        </select>\n-      </div>\n-\n-      <div class="field" tal:condition="advanced">\n-        <label><input type="checkbox" name="setup_content:boolean" checked="checked" /> <tal:block i18n:translate="">Example content</tal:block></label>\n-        <div class="formHelp" i18n:translate="">\n-            Should the default example content be added to the site?\n-        </div>\n-      </div>\n-\n-      <tal:content tal:condition="not:advanced">\n-        <input type="hidden" name="setup_content:boolean" value="true" />\n-      </tal:content>\n+                  UTC\n+                </option>\n+              </optgroup>\n+            </select>\n+            <div class="form-text" i18n:translate="">\n+              The default timezone setting of the portal.\n+              Users will be able to set their own timezone, if available timezones are defined in the date and time settings.\n+            </div>\n+          </div>\n \n+          <div class="col-md-12 mb-3"\n+               tal:condition="advanced">\n+            <div class="form-check">\n+              <input class="form-check-input"\n+                    id="example-content"\n+                    type="checkbox"\n+                    name="setup_content:boolean"\n+                    checked="checked" />\n+              <label class="form-check-label"\n+                    for="example-content"\n+                    i18n:translate="">Example content</label>\n+              <div class="form-text" i18n:translate="">\n+                Should the default example content be added to the site?\n+              </div>\n+            </div>\n+          </div>\n \n+          <input tal:condition="not:advanced"\n+                  type="hidden" name="setup_content:boolean" value="true" />\n+\n+          <div class="col-md-12"\n+               tal:condition="python: len(base_profiles) > 1">\n+            <div class="mb-3">\n+              <p class="lead" i18n:translate="">Base configuration</p>\n+\n+              <div tal:repeat="info base_profiles"\n+                  class="form-check mb-3">\n+                <input type="radio"\n+                      name="profile_id:string"\n+                      value="profile"\n+                      class="form-check-input"\n+                      tal:attributes="id info/id;\n+                                      value info/id;\n+                                      checked python: default_profile==info[\'id\'] and \'checked\' or nothing" />\n+                <label class="form-check-label" tal:attributes="for info/id">${info/title}</label>\n+                <div class="form-text" tal:content="info/description">${info/description}</div>\n+              </div>\n \n-      <tal:baseprofile condition="python: len(base_profiles) > 1">\n-        <div class="field">\n-          <label for="profile_id" i18n:translate="">\n-            Base configuration\n-          </label>\n+              <div class="form-text" i18n:translate="">\n+                You normally don\'t need to change anything here unless you have specific reasons and know what you are doing.\n+              </div>\n \n-          <div class="formHelp" i18n:translate="">\n-            You normally don\'t need to change anything here unless you have\n-            specific reasons and know what you are doing.\n+            </div>\n           </div>\n \n-            <tal:bases tal:repeat="info base_profiles">\n-              <label>\n-                  <input type="radio"\n-                       name="profile_id:string"\n-                       value="profile"\n-                       tal:attributes="id info/id;\n-                                       value info/id;\n-                                       checked python: default_profile==info[\'id\'] and \'checked\' or nothing"\n-                       />\n-                  <tal tal:attributes="for info/id"\n-                       tal:content="info/title"> Profile title </tal>\n-              </label>\n-              <div class="formHelp" tal:content="info/description">\n-                Profile description\n+\n+          <div class="col-md-12 mt-3"\n+               tal:define="has_selected python:[p for p in extension_profiles if p.get(\'selected\', None)]"\n+               tal:condition="python: extension_profiles or advanced"\n+               tal:omit-tag="python: has_selected and not advanced">\n+            <tal:block condition="python: advanced">\n+              <h2 i18n:translate="">Add-ons</h2>\n+\n+              <div class="lead"\n+                   i18n:translate="" >\n+                Select any add-ons you want to activate immediately.\n+                You can also activate add-ons after the site has been created using the Add-ons control panel.\n               </div>\n-            </tal:bases>\n-        </div>\n-      </tal:baseprofile>\n-\n-      <tal:extensionprofiles condition="python: extension_profiles">\n-        <fieldset id="add-on-list" tal:omit-tag="python: not advanced">\n-          <legend i18n:translate="" tal:condition="python: advanced">\n-            Add-ons\n-          </legend>\n-\n-          <div class="formHelp" i18n:translate="" tal:condition="python: advanced">\n-              Select any add-ons you want to activate immediately. You can\n-              also activate add-ons after the site has been created using the\n-              Add-ons control panel.\n-          </div>\n+            </tal:block>\n \n-          <tal:addons tal:repeat="info extension_profiles">\n-            <div class="addons-group">\n-              <tal:info tal:define="selected info/selected|nothing">\n+            <tal:loop tal:repeat="info extension_profiles">\n+              <tal:set tal:define="selected info/selected|nothing">\n                 <tal:normal tal:condition="python: not selected or advanced">\n-                  <div tal:condition="python: advanced">\n-                    <label>\n-                        <input type="checkbox" name="extension_ids:list" value=""\n-                           tal:attributes="value info/id;\n-                                           id info/id;\n-                                           checked info/selected|nothing;" />\n-                        <span\n-                          tal:attributes="for info/id"\n-                          tal:content="info/title">profile title</span>\n-                    </label>\n+                  <div class="form-check mb-3"\n+                      tal:condition="python: advanced">\n+                    <input type="checkbox"\n+                          name="extension_ids:list"\n+                          value="${info/id}"\n+                          id="${info/id}"\n+                          class="form-check-input"\n+                          tal:attributes="checked info/selected|nothing;" />\n+                    <label class="form-check-label" for="${info/id}" >${info/title}</label>\n+                    <div class="form-text"\n+                        tal:condition="python: advanced and info[\'description\']">\n+                      ${info/description}\n+                    </div>\n                   </div>\n-                  <p class="formHelp" tal:content="info/description" tal:condition="python: advanced">\n-                    profile description\n-                  </p>\n                 </tal:normal>\n                 <tal:hidden tal:condition="python: selected and not advanced">\n-                  <input type="hidden" name="extension_ids:list" value=""\n-                         tal:attributes="value info/id;\n-                                         checked info/selected|nothing;" />\n+                  <input type="hidden"\n+                        name="extension_ids:list"\n+                        value="${info/id}" />\n                 </tal:hidden>\n-              </tal:info>\n-            </div>\n-          </tal:addons>\n-\n-        </fieldset>\n-      </tal:extensionprofiles>\n-\n-      <div class="formControls">\n-        <input type="hidden" name="form.submitted:boolean" value="True" />\n-        <input type="submit" name="submit" value="Create Plone Site"\n-               i18n:attributes="value;" />\n-      </div>\n+              </tal:set>\n+            </tal:loop>\n+          </div>\n+          <div class="col-md-12 mt-3">\n+            <input type="hidden" name="form.submitted:boolean" value="True" />\n+            <button class="btn btn-success mt-3" type="submit" name="submit" i18n:translate="">Create Plone Site</button>\n+          </div>\n+      </article>\n+    </form>\n+  </div>\n+</body>\n \n-  </form>\n-</article>\n-</div>\n-  </body>\n </html>\ndiff --git a/Products/CMFPlone/browser/templates/plone-admin-logged-out.pt b/Products/CMFPlone/browser/templates/plone-admin-logged-out.pt\nindex 011123aeee..da0752d9ba 100644\n--- a/Products/CMFPlone/browser/templates/plone-admin-logged-out.pt\n+++ b/Products/CMFPlone/browser/templates/plone-admin-logged-out.pt\n@@ -8,29 +8,33 @@\n       i18n:domain="plone">\n \n <head>\n-  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>\n-\n-  <title i18n:translate="">Logout</title>\n-\n-  <link rel="stylesheet" type="text/css"\n-        href="/++resource++plone-admin-ui.css"\n-        tal:attributes="href string:${context/absolute_url}/++resource++plone-admin-ui.css" />\n-\n+  <meta charset="utf-8"/>\n+  <meta name="viewport" content="width=device-width, initial-scale=1"/>\n+  <title i18n:translate="">Logged out</title>\n+  <link rel="stylesheet"\n+        type="text/css"\n+        href="${string:${context/absolute_url}/++theme++barceloneta/css/barceloneta.min.css}" />\n+  <link rel="stylesheet"\n+        type="text/css"\n+        href="${string:${context/absolute_url}/++resource++plone-admin-ui.css}" />\n </head>\n-<body>\n-  <img src="/++resource++plone-logo.png" width="215" height="56"\n-    tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.png"/>\n \n-  <h1 i18n:translate="">\n-      You are now logged out.\n-  </h1>\n+<body>\n \n-  <p>\n-      <a tal:attributes="href context/absolute_url"\n-         i18n:translate="">\n-          Go back to your site.\n+  <div class="container admin mt-5 mb-5 p-4">\n+    <div class="row">\n+      <p><img src="/++resource++plone-logo.svg"\n+              width="215" height="56"\n+              tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.svg"\n+              alt="Plone logo"\n+              i18n:attributes="alt" /></p>\n+      <h1 i18n:translate="">You are now logged out.</h1>\n+      <a href="${context/absolute_url}"\n+          class="btn btn-primary"\n+          i18n:translate="">\n+        Go back to your site.\n       </a>\n-  </p>\n-\n+    </div>\n+  </div>\n </body>\n </html>\ndiff --git a/Products/CMFPlone/browser/templates/plone-frontpage.pt b/Products/CMFPlone/browser/templates/plone-frontpage.pt\nindex 71cc3a50da..99f000f8bf 100644\n--- a/Products/CMFPlone/browser/templates/plone-frontpage.pt\n+++ b/Products/CMFPlone/browser/templates/plone-frontpage.pt\n@@ -1,17 +1,18 @@\n+<tal:doctype tal:replace="structure string:&lt;!DOCTYPE html&gt;" />\n <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n       lang="en"\n       i18n:domain="plonefrontpage">\n \n <head>\n-    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n+    <meta charset="utf-8" />\n </head>\n \n <body i18n:translate="front-text">\n \n   <div class="hero">\n     <h1>Welcome!</h1>\n-    <p><a class="context" href="https://plone.com" target="_blank">Learn more about Plone</a></p>\n+    <p><a class="btn btn-primary" href="https://plone.org" target="_blank">Learn more about Plone</a></p>\n   </div>\n \n   <p class="discreet">\n@@ -38,7 +39,7 @@ Before you start exploring your newly created Plone site, please do the followin\n <p>After that, we suggest you do one or more of the following:</p>\n \n <ul>\n-    <li>Find out <a class="link-plain" href="https://plone.com/features/" target="_blank">What\'s new in Plone</a>.</li>\n+    <li>Get the latest <a class="link-plain" href="https://plone.org/what-is-plone/plone" target="_blank">news</a> about Plone.</li>\n     <li>Read the <a class="link-plain" href="https://docs.plone.org" target="_blank">documentation</a>.</li>\n     <li>Follow a <a class="link-plain" href="https://training.plone.org" target="_blank">training</a>.</li>\n     <li>Explore the <a class="link-plain" href="https://plone.org/download/add-ons" target="_blank">available add-ons</a> for Plone.</li>\ndiff --git a/Products/CMFPlone/browser/templates/plone-overview.pt b/Products/CMFPlone/browser/templates/plone-overview.pt\nindex 7115cbe296..9081f153d7 100644\n--- a/Products/CMFPlone/browser/templates/plone-overview.pt\n+++ b/Products/CMFPlone/browser/templates/plone-overview.pt\n@@ -11,128 +11,101 @@\n   <meta charset="utf-8"/>\n   <meta name="viewport" content="width=device-width, initial-scale=1"/>\n   <title>Plone</title>\n-  <link href=\'http://fonts.googleapis.com/css?family=Roboto:400,300,700\' rel=\'stylesheet\' type=\'text/css\'/>\n-  <link rel="stylesheet" type="text/css"\n-        href="/++resource++plone-admin-ui.css"\n-        tal:attributes="href string:${context/absolute_url}/++resource++plone-admin-ui.css" />\n+  <link rel="stylesheet"\n+        type="text/css"\n+        href="${string:${context/absolute_url}/++theme++barceloneta/css/barceloneta.min.css}" />\n+  <link rel="stylesheet"\n+        type="text/css"\n+        href="${string:${context/absolute_url}/++resource++plone-admin-ui.css}" />\n </head>\n \n \n-<body tal:define="sites view/sites">\n-<div id="box">\n-    <header><h1><img src="/++resource++plone-logo.png" width="108" height="28"\n-         tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.png"\n-         alt="Plone"/></h1>\n-    </header>\n-    <article>\n-    <div id="text">\n-        <div class="circle running">\n-            <img alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAD/VJREFUeNrsXXlQlOcZ//Ze7htRlHi1ShMpBGsywTF4Zey0Ha0m2mA7Bqca8Y9m6BgdizPRqUZMxh4enelkplI8knG8kIwkHlUkjcGgSBAEuZFDFJZ7YXfZ3f4eeTdutrD7LezNvjPPsLt8+37v+/ze53yf712BXq/nvM11mtDLAi8g3uYFxAuIt3kB8QLibV5APL+Jbd2hQCCw6np3j4MM87XVPLwS4lVZ1rXu7u4ZarV6r1arLcQq7KPFCOrX6XRF+Hwf/d+jECFRsyXZ6v5FRUW+g4ODhwgEUDPoAeguqIj9fcA+71WpVJmnT5+W2nou1szXVv0JbK3DbWFD6uvro6ZNm5YrEomi8PYpk4pRbwmaNDQ0VFZYWLgmKSmp151tiMsBcuPGDf+FCxdeE4vFgXirtKKrQKiwIplMth596twVELErqU9MTtjX17cHYASRnbDy6z1SqfTVjo6O1ejnrH4MHMK9I4RC4Qt42ezr69s64Y36d999Nx2M+PUYwDA0RUBAwB+tWWgATwDH4GU4DQX+/v4tuH8+qAFOQzUkbmd1dXXghASEpCMmJub3xJ/x9CORSEIePnz4soCH7qRr2traXg0MDLwCexVJawJUASqFpAxC4t6bOXNmkUKheFFgrS72AAkRy+XyRGbABeOggaCgoNf5zC0xMVEcGhp6BLx+xKTSuB81qAXAaIKDg3OuX78e5JaR+njGghVJXpV2vB1BSqYyQLTmpKOysjIB9sqXQDTTnQqg6OPi4t7BVw7Z22FwJQkRYsJ6G6k/Xx5zEwC46RbAMDQ1gIh0BL9cysuCYe2HLvcdbz8wxl1M7ZgFpKenR8PjOoMH1ukIQFzKywIjFbboBxF+u4Vg0iAhEt7um0LxaKIZdV1nZ+cDW3RUUVFxh/qzdB3c3Ci+fRYWFt7n06cnAaL9+uuvvxxvJxqNpjM1NbWYB/OE8Mbi+fSpUqna0tLSmiYaIENvvfVWcXt7+53xuL3wnHJaWloGLTFv//79fggi5/PpE9F/KWHtiJSMS6ks8ngOHjx4FKu8Zywd9Pb21q5Zs+YM84r05oLQd999dyvcWV7zLy8vv0ELZkLZEMZAdWZmZm1WVtY+gGJV+kSpVD7eu3fvh4jSKdLXmLu2qqoqFsHeFj5Mhrp6unr16sIJBwgDhQI55ebNm7/94IMPtnV3d1fxVCllGzdu3PHRRx/R9QPmpCMvLy9w+vTpxyElXXz6rq6uvgTJs6gCbZZCcrX0O8sZUXzkJ5fLg8+cOfN6YmJicmRk5DxomO/dVJ1Op4G9Kbt9+/Y12J58uLrE4H70N+pKXrt2rejEiRPnpVLpHPKOLRq1oaFeSMfvcnNzaSNMbW6+HrsfYtSPCH/kIAoUfWbPnu0P7ykanpEMK1Z9/PjxZuh22oxSMlIxCRsVjOzs7KMAeQXe8rJRJSUln8THx/+b4sLRDPqEAcRIWggYCZMaEVOzOpanGmL2QjuamqI+EGXHyWSyj8Vi8Yv4qIPPuPr7++vnzp2b1tTU9HQ06bAHIC6VOhnF0BPTh4ixp0+flixYsCA6NDQ0CuorEB9JQX4ECIx6DWxOR3h4+M+hzigvFgWK0Wq1r7JNp8d8wSC1B1V5BGBYdBA83oYYGpjhExERkYz+ksDQBJFIFIvXUw3qnUmInkkL3ZSKHLpxjcToGo1BnVkzJqiqY0xVdZuzSR6vslpbW31DQkJ+A9WyEgAsQ186xtABxlSNhRyViBtn+r6hoeEyvLCP8bLTUjzjsSoLbms0oub3oqKiUjFBMTO69WNwNccFBqQy/7XXXvs7u79a74SySqcCwmqv3odNSAcQ5Ia2mzBV4KCh6CorKy8kJCR8MjAwQBnnQb2TalydBYigs7MzLjAw8DPYhzC8b3FU4GXaKFV/7ty5Q+vXr7/FJGPAkWVErmBDyA1N8fX1PYxrFdYaXJuJhE6nrquru7J169bsy5cvkwfWx9SUbizzdVcbIkBQt9nPz+8A2XBnSAWi7wEAcXXPnj1nT5482cyAIKdhSO8CpfiOBIS2TDf4+/t/iNfNDgZB+fjx47vFxcW3du7cebusrKzLyHvTOFNFOQsQwaNHj34GMDLxus2BxvpZq62tvTJnzpx/MhDIeVC7GhCG5pBsb3Z2ti9c2n+xDKvDG+KKFSyu6GR5KZUrguEoQIQrV67cjmDPhxt/EdyYSCqVBkJNxZnLeU0YQHJyciIQ9KUyNcE3UCyDzv/WhsPQREdHr+Lc4AElew9QuGjRojQW9FlcyeSK5ufnHw4PD9+BoPFLW0oJ3OwlnIsnUx0BiBgu7ko+7i15QseOHduVnJx8Fm+fZmRk5NMGka0GIpFIgsrLy18xFE1T3gxR+TSVSjUL3l+oqwBiz8BQQAyIjY09xUddXb169cDy5ctz8ZJAoCSiH5iWCWdgqa3GBuY/EYlEGhBVs0dyzzPGQvBhEBJ6T6vVfoFY6VhYWFizNfN1h6dwhVA9ixlzLe2JFwGMS9zzpB5JlKaqquq6LdWWTCabDufix2AiFVDQ/nstqA5Ug89aAVQMHIB0gFGl0WhONjU1RXuSyhL5+Pi8yOfCkpKSHBYxa4y8oKH09PT/2lJtsUCQYpGR9jh07P+U4GyCilsCR6Ckv79/g6OeDbG7hGBS0yytWjC85+23377JDe+JG8u99s6dO33t7e3fOMFVptZLcRNs4CHYml1Uy+X2gEAFBFu6CCuw9smTJ0rOZC+DgWNQW85qJDVtcrn8ve7u7hRHSIq9AZHzMLQKMwHbUFpaGqmtHs65TUE5uJs3b0a5MyAcH4POqjlHc4u1iLD7naS2TMc5lJCQsN3eqsuunVNsYTFQEYulo/3PRdTW94sDweXK3bt3+7srIPrBwcHHllYegrIGznzhwjO1pVar211ASriNGzcutqctsScgupqamlyziOn1mtzc3M8tRPKktvoqKio+s6HkDnZ1dZUjzriGMX7e1tb2DYJCPjuXOtiShdxwdYvbReoSDD4EE/44MjJy4Uh4wK09NH/+fKp/6jWXDqeCOASZYZWVlYdDQ0MTxjIueHNNjY2N3xQUFNzKyMh4ALukZvEIMUB87dq1FUuWLHnfUj9KpbIUrvA6SuHbI1K352lANFLfKVOmxNy7d28XfPnb+H8NEVzIyzk5Ob/F/yl9IeXRJ/Xlt27dulh8N8/QD1+qr68/gih9NvqYAqKiigBuuGZYzsgvMTGRqhwfWOoLXiE5GD7uehoQqUTaB/FnDA0Dc1SFhYVUotnPonMVnz0KVnztl5SUNPnTTz9NnzZt2jKOx85jSUlJVnx8/DGWllExqdAZ35PZhABI0RkY7llmdZZONwB3/hV8vd8eEuKIqhMChdLeEqZ7DfW6ZoukzYBCKzu4o6PjINTXfEsKIDU19RdZWVmN3HCtlTm16AcH42RAQECcJbsH457IDlNzy6oTHcv2qo1WtH6M6lVLicHk5GRZcHBwoqXrycsDGI8tgWE0Joc8JeVsQEwnPe4+srOzl2OVii14Z2TIazj+xQx6JsFm1SDsjNqeDHLKliYYRPsPYz32SBQREbGB47HppVAoSjkr6n3ZOV2Wxj7oKYBQkdwixAA3uOE0dycMZCMCvozy8nJe0S8Z34aGhsVyufynfK7Pz8//jxWACABICI8YpsdGku5UQOiQsPWIS/Lgoczlhh+eeUR5IalU+n5sbOxDuJPptbW1Zlfo3bt3J8ONPsK8JbNRNdzsmk2bNtXyBWTVqlVSABJqqV92/Id7A/LVV19NhvdykBs+0HLQaEJkRLsAjBZxwp4ZM2bUazSaf8AYJyNolBhLBiLrxfPmzbsKpvnxuWddXd0XHM9aXep/x44dM/lkRDC2VnsC4gijLoQErMVkzaUmaBUrSGIkEsk6UCoCNfL5q8HQHhjSGBjxCG74kTQND7Wi3Ldv3zmOf+mRIDIycg4fRkPt1nN2rEl2BCAiMHom97xIzpKn08dIwB5ViGCAtRllAMw22Jlzp06darfCftC5Jy/x6fvJkyeV7g6IEGpIOYbv6bkxPHAJHd+xbdu2YywDwJdxQqjMl/hceOXKFbsC4ggbor9//34+56C98IKCgr9cuHDhqZVgigDILB4GvXX37t1P3R0Q7dKlSwthlAvtfaP6+vpzy5Yto4pHa5+C4nW8IOxHNWfn50gcAciz8poNGzbs6ujosBso0O0FSUlJf2H2x+oUCKL6akvXYPzFnA0O6XS6yiLVfvHixZbw8PB0qJMMOiXBljdoamrKi4+P/1NLS4uC45k9NpXisrKys5YCwqNHj160NyCO/HUEQ6Y2Ah7NzEuXLm1CsHgF33k0VoKz8AA24w/okyoMKT4RjnHM5NyEV1RU/Hmk+8DtrsJ413HD+yhCe/46gqN/ruL7k36YOzsdq+5XiNCPwmCWWgMEmPdxSkoKZXxpk8tnrGAYbYDRRlVUXl7eOwqF4nMaj0qlKobUZR04cIBKYskFl3jqz1UYgJEwRvgEBgb6ZmZmxi5YsCA+Kipqpr+//2SpVBpmSOiBOZ1gVC08tnvbt2+/9fDhQ8op9XPPnxPUj3PcpL6pAsafSbKEqVsVu49ypPt42tEaAu6HG1hSRobNLCG7Rs90t4ZF3yrODs8Jmpw+JDRK7wyNdvSTx551wpghZGQMhsExMBw0Q4xxmUfTPPZ4JsZgrZEkTMgmdqOxynp6evxgV4Jg1CUikSjIZKWSwf0BkPCOenQ6HZ211QkbZXgk2qWbU1UW7k2Vi7NkMtkMvH6BDhqjQ8dA4aAwIwo2UV36ETKzIyUv/y+1gvt0gRSgdqO/DeS9UV4SzkMtwKvhmx5xaxsC5oeJxeIloKV0KBnoJ7jeh3t+IJmBdCOQLYNhUxIZEx3pB8kqB91FQHgd8dI1eH5PPQYQRNJTJ02a9DcA8UsjV1LDWT6QzGmag3laBs+PMtbn2tvbd06ePLnB3Y067TVsIsnAa4WLAjBiuofRs1/ekUgkK6DKGgBAhj1PgXBELkuwaNGiIwjo9vf19dVyTq5gHwsplcq6srKyzDfeeOOv9uaZoyoXZSwP5Ltly5boN998Mz4mJuZHISEhMwICAl6AUQ/nXOOUBT2MejsWTr1CoaiHqq05f/588eHDh5uYpPRyJhtf7mrUBSbRuMSIxABHlpKSEhUXFzdp6tSpkwBSkFwuD/Lz8wsGWEF0TgpUhg/6ltFjcvSelZUOZy1FomfvKZpGGzDy4nS0v47PqHJRBTswQOdlgek9AwMDnVj53b29vT3Nzc1tpaWlbSdOnGhtbGw01P9qTEjNjbAX4gmRumk0PpKnM5InNNKTsqZ/OSMbpR/FVR7JgzP27rQmn+ss1AR7VupkhHjBHPNHAsC4D/0oBpoziV1GAmm0+MaqFJCnROrGjNByE7h5f+De03NZLn4+mFdCvM0LiBcQb/MC4gXE27yAeAHxNi8g3mbS/ifAAFBczKUFx6EmAAAAAElFTkSuQmCC" />\n-        </div>\n-        <h1 i18n:translate="">\n-            Plone is up and running.\n-        </h1>\n-        <ul>\n-            <tal:block tal:condition="sites">\n-                <tal:one tal:condition="python:len(sites) == 1">\n-                    <tal tal:repeat="site sites">\n-                        <span class="prominent">\n-                            <!--<img tal:attributes="src string:${site/absolute_url}/logoIcon.png"\n-                                 height="16" width="16"/>-->\n-                            <a href="#" class="plone-btn"\n-                               tal:attributes="href site/absolute_url"\n-                               title="Go to your instance"\n-                               i18n:attributes="title;"\n-                               i18n:translate="">View your Plone site</a>\n-                        </span>\n-                        <div class="upgrade-warning"\n-                             tal:condition="python:view.outdated(site)">\n-                            <span i18n:translate="">\n-                            This site configuration is outdated and needs to be\n-                            upgraded:</span>\n-                            <form action=""\n-                                  style="display: inline;"\n-                                  method="get"\n-                                  tal:attributes="action python:view.upgrade_url(site)">\n-                            <input tal:condition="not:view/can_manage"\n-                                   type="hidden" name="came_from"\n-                                   tal:attributes="value python:view.upgrade_url(site, can_manage=True)"/>\n-                            <input type="submit"\n-                                   class="plone-btn-secondary"\n-                                   value="Upgrade&hellip;"\n-                                   i18n:attributes="value label_upgrade_hellip" />\n-                            </form>\n-                            </div>\n-                    </tal>\n-                </tal:one>\n-                <tal:many tal:condition="python:len(sites) &gt; 1">\n-                    <h2 id="multiple-sites" i18n:translate=""> You have multiple Plone sites:</h2>\n-                    <ul class="sites">\n-                        <li tal:repeat="site sites">\n-                            <span class="prominent">\n+<body tal:define="sites view/sites;\n+                  many python:len(sites) > 1;">\n+  <div class="container admin mt-5 mb-5 p-4">\n+    <header class="row">\n+        <p><img src="/++resource++plone-logo.svg"\n+                width="215" height="56"\n+                tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.svg"\n+                alt="Plone logo"\n+                i18n:attributes="alt" /></p>\n+        <h1 i18n:translate="">Plone is up and running.</h1>\n+        <p class="lead">\n+            <span i18n:translate="label_plone_org_description"> For an introduction to Plone, documentation, demos, add-ons, support, and community, visit</span>\n+            <a href="http://plone.org"\n+              title="Plone Community Home"\n+              i18n:attributes="title label_plone_org_title;">plone.org</a>.\n+          </p>\n \n-                                <a href="#"\n-                                   tal:attributes="href site/absolute_url;\n-                                                   title site/Title;"\n-                                   tal:content="site/Title">\n-                                    Site title\n-                                </a>\n-                                <span class="discreet"\n-                                      tal:content="string:\xe2\x80\x93 ${site/getId}"/>\n-                                <img tal:attributes="src string:${site/absolute_url}/logoIcon.png"\n-                                     height="16" width="16"/>\n-                            </span>\n-                            <div class="upgrade-warning"\n-                                 tal:condition="python:view.outdated(site)">\n-                                <span i18n:translate="">\n-                                    This site configuration is outdated and\n-                                    needs to be upgraded:\n-                                </span>\n-                                 <form action=""\n-                                       style="display: inline;"\n-                                       method="get"\n-                                       tal:attributes="action python:view.upgrade_url(site)">\n-                                 <input tal:condition="not:view/can_manage"\n-                                        type="hidden" name="came_from"\n-                                        tal:attributes="value python:view.upgrade_url(site, can_manage=True)"/>\n-                                 <input type="submit"\n-                                        class="plone-btn-secondary"\n-                                        value="Upgrade&hellip;"\n-                                        i18n:attributes="value label_upgrade_hellip" />\n-                                 </form>\n+    </header>\n \n-                            </div>\n-                        </li>\n-                    </ul>\n-                </tal:many>\n-            </tal:block>\n-            <li>\n-                <span i18n:translate="" tal:condition="not:sites">\n-                    Your Plone site has not been added yet:\n-                </span>\n-                <span i18n:translate="" tal:condition="sites">\n-                    You can add another Plone site:\n-                </span>\n-                <form id="add-plone-site"\n-                      method="get"\n-                      action="#"\n-                      tal:define="site_number python: \'\' if not sites else len(sites) + 1"\n-                      tal:attributes="action string:${context/absolute_url}/@@plone-addsite">\n-                    <input type="hidden" name="site_id" value="Plone${site_number}" />\n-                    <input type="submit"\n-                           i18n:attributes="value;"\n-                           value="Create a new Plone site" />\n-                    <a class="discreet"\n-                       i18n:translate=""\n-                       tal:attributes="href string:${context/absolute_url}/@@plone-addsite?site_id=Plone${site_number}&amp;advanced=1"\n-                       >Advanced</a>\n-                </form>\n-            </li>\n+    <article class="row mb-5">\n+        <div class="col-md-12 mb-4"\n+             tal:condition="sites">\n+            <tal:loop tal:repeat="site sites">\n+                <div tal:define="outdated python: view.outdated(site);"\n+                     class="mb-3 ${python: \'p-3 alert-warning\' if outdated else \'\'}">\n+                    <p tal:condition="outdated" i18n:translate="">This site configuration is outdated and needs to be upgraded:</p>\n+                    <a href="#" class="btn btn-primary ${python:\'btn-lg\' if not many and not outdated  else \'\'}"\n+                        tal:attributes="href site/absolute_url"\n+                        title="Go to your instance"\n+                        i18n:attributes="title;">\n+                        <tal:one condition="not: many" i18n:translate="">View your Plone site</tal:one>\n+                        <tal:many condition="many">${python:site.title} <small>(${python:"/".join(site.getPhysicalPath())})</small></tal:many>\n+                    </a>\n+                    <form action=""\n+                            style="display: inline;"\n+                            method="get"\n+                            tal:condition="outdated"\n+                            tal:attributes="action python:view.upgrade_url(site)">\n+                        <input tal:condition="not:view/can_manage"\n+                                type="hidden" name="came_from"\n+                                tal:attributes="value python:view.upgrade_url(site, can_manage=True)"/>\n+                        <button type="submit"\n+                                class="btn btn-warning me-3"\n+                                i18n:translate="label_upgrade_hellip">Upgrade&hellip;</button>\n+                    </form>\n+                </div>\n+            </tal:loop>\n+        </div>\n+        <div class="col-md-12">\n+            <h2 i18n:translate="" >Add Plone site</h2>\n+            <p i18n:translate=""\n+               tal:condition="sites">\n+                You can add another Plone site to the server.\n+            </p>\n+            <p i18n:translate=""\n+               tal:condition="not:sites"\n+               class="alert-warning p-1">\n+                Your Plone site has not been added yet.\n+            </p>\n+            <form id="add-plone-site"\n+                    method="get"\n+                    tal:define="site_number python: \'\' if not sites else len(sites) + 1;\n+                                action string:${context/absolute_url}/@@plone-addsite"\n+                    action="${action}">\n+                <input type="hidden" name="site_id" value="Plone${site_number}" />\n+                <button type="submit"\n+                        class="btn btn-${python:\'success\' if sites else \'primary\'}"\n+                        i18n:translate="">Create a new Plone site</button>\n+                <tal:comment condition="nothing">\n+                  When we have Volto, the button above will create a Volto site,\n+                  and we need an extra button below to create a Classic Plone site.\n+                </tal:comment>\n+                <a class="btn btn-secondary"\n+                    i18n:translate=""\n+                    tal:condition="view/has_volto"\n+                    href="${action}?site_id=Plone${site_number}&amp;classic=1"\n+                    >Create Classic Plone site</a>\n+                <a class="btn btn-secondary"\n+                    i18n:translate=""\n+                    href="${action}?site_id=Plone${site_number}&amp;advanced=1"\n+                    >Advanced</a>\n+            </form>\n+        </div>\n+    </article>\n \n-        </ul>\n-    </div>\n-  </article>\n-  <footer>\n+    <footer class="row">\n     <p>\n       <a href="#"\n         tal:attributes="href string:${context/absolute_url}/manage_main"\n@@ -141,19 +114,6 @@\n         i18n:translate="label_zmi_link">Management Interface</a>\n       <span i18n:translate="label_zmi_link_description"> &#151; low-level technical configuration.</span>\n     </p>\n-    <p>\n-      <span i18n:translate="label_plone_com_description"> For an introduction to Plone, success stories, demos, providers, visit</span>\n-      <a href="http://plone.com"\n-        title="Plone.com"\n-        target="_blank"\n-        i18n:attributes="title label_plone_com_title;">plone.com</a>.\n-    </p>\n-    <p>\n-      <span i18n:translate="label_plone_org_description"> For documentation, add-ons, support, community, visit</span>\n-      <a href="http://plone.org"\n-        title="Plone Community Home"\n-        i18n:attributes="title label_plone_org_title;">plone.org</a>.\n-    </p>\n   </footer>\n </div>\n </body>\ndiff --git a/Products/CMFPlone/browser/templates/plone-upgrade.pt b/Products/CMFPlone/browser/templates/plone-upgrade.pt\nindex 2ac449fd1a..3d899aa99c 100644\n--- a/Products/CMFPlone/browser/templates/plone-upgrade.pt\n+++ b/Products/CMFPlone/browser/templates/plone-upgrade.pt\n@@ -11,126 +11,95 @@\n   <meta charset="utf-8"/>\n   <meta name="viewport" content="width=device-width, initial-scale=1"/>\n   <title i18n:translate="">Upgrade this site</title>\n-  <link href=\'http://fonts.googleapis.com/css?family=Roboto:400,300,700\' rel=\'stylesheet\' type=\'text/css\' />\n-  <link rel="stylesheet" type="text/css"\n-        href="/++resource++plone-admin-ui.css"\n-        tal:attributes="href string:${context/absolute_url}/++resource++plone-admin-ui.css" />\n+  <link rel="stylesheet"\n+        type="text/css"\n+        href="${string:${context/absolute_url}/++theme++barceloneta/css/barceloneta.min.css}" />\n+  <link rel="stylesheet"\n+        type="text/css"\n+        href="${string:${context/absolute_url}/++resource++plone-admin-ui.css}" />\n </head>\n \n <body id="plone-upgrade-screen"\n-      tal:define="versions view/versions; report options/report|nothing;">\n-<div id="box">\n-    <header><h1><img src="/++resource++plone-logo.png" width="108" height="28"\n-         tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.png"\n-         alt="Plone"/></h1>\n-    </header>\n-    <article>\n-  <div class="circle running">\n-            <img alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAADRxJREFUeNrsXAtQU2cWvnlAwisogqsrOLvqqqu2xcpsl611q9M6VduOVWmLzrYKLRVtZ53aKR3c1fqc2aHTqttxkHbaop2pFGx1WUFY10VcnCrt7vCYQh2rFcMzPEIMBEhI9jvmzzZFSG6Sm5DEe2bO3Jub5P435/vPOd8597+RWCwWThT/EaloAhEQUURAREBEEQERARFFBEQERBQREBEQUURARBEBEQERRQQkCETuyZclEgl3r7fvyQYjxRObyMU56TiC9Pb2/kKpVM6AkROkUmk8APgZjiuxnYhtmMlkUmB7Uy6Xv4SteVw9JJiksLBQtmrVqvtlMtnvYPhF2C7Edk50dLQMbw9Ch6BGpmT4Yba1DAwMaJgthzz2OE/cK9BDVnd3d3xERMRTMP4K6GL8HiUO66H9TAf4zHqdTtcA4DKwaxBDloui0WimqFSqVISY1JiYmAfInkxvQU2jzTtn50TYGhBZlguye/duaX9//0oY7kxcXNwPCoXiLXiECm/VQ5ug2jHA4CU4L31fkFAR1CHr2rVrioSEhLSQkJDXkQ8mk4MwbxD0oltaWk5PmzbtLyzXeGSToPSQiooK5eDg4LaZM2degzfsARiUbL9nYNjCkGAK79MIBbI02EITGM+GJUuW1AOIbHiwluWGQS+TgzahAAmKpA7DS3p6eh7YsWNHLpL1bBxqhap9Nf7169d/EKIGCYocUltbGzFnzpxd8IjNeEkztc+X4+P3D02fPn2FWq3W2kDxyKaBCgh5BaropMjIyHzkiAk41CF0suYjyB83UMu8iN3bQrROAjKHIFfIDQbDDtQT5wAGJdZ2d8AwGo23ST25ltu3b6tZ1X5v1iGgsnHIFWeUSuVrePkDS9i8GRFmr6WxsbFk69atr4WGhqaTZmZmvtrQ0PB3vGV2lWF1dXXVC5U/AipkUYjSarWLoqKiCuAVnH2IcCHem4qKinKeffbZKpZrTHbkJrygoODhlJSUNzEUb7Jz4sSJV1JTU//Delweh6yAAITAQGhYi1idi13KFW418eAFRfPmzfuA1SODzCPo/IQwdW2j6urqXl6wYEEKn/Oh1umCp67Dbq+9lwR1DiEw9Hr9diTvPOy2spnocvFGRjp06NAXzHgDNjCYAWmf+lG6nJycQr6hC/VHHfdj9zf4cwhCiwyF3rvwjCxWV7j9w0ECWo4ePdpC3mUZZQqzY0PHjh3rwGdb+ZwTVLfakx5YQBWGBMbx48dzUV+sYoWereXhtrOR8ew9YxRQzPBCI5uoDscaHh427N+/v1JoQPzSQ/Ly8kI+/fTT4wBjBV52CnHOsLCwhO3btyudfW716tUhyAvxzj4HdvXN6dOne4WkvH7pIZRgUWztBR19BC97PPSKn+SirKysVGzet4yRdekz7e3t66VWGucwPII6X2DkwhK0HsIM8jhm8wuc9R6FkGKeNGnSdtQx88f6wM2bN38dGxv7ujMwwK40CKn/Ejpc+R0gX375ZXRMTMx72O3mBG6Rk2LiG2bMmFHe19f3h4qKiv9HB9rHsQ3x8fFU+ZucnQfAncPE6Rc6XPlVHUKhCkY5GB4e/gQnwGIBB0KLFqbiuo1IzHV3DshkCzB+KGdtTjqc9Waz2YhctP7gwYPfU2NR6GVAfgEIhSqEkgdnzpx5itUJvhACxpbkB/mGn1u3bpVOnz59H3UKGCsTFBCfJXW4eER0dPRv8QMW0tomaDQuvBPapdVqa8Fs3mDtEJeTOArHW01NTd9gq1WpVDEJCQlJqF1+7iyncNaVJRxfSk2tl88h9lV+QIUsmvkIQ0+AMb0il8sfZ4xkgMXeYTZL5axt0cVZl+Dwz9Jm89CFCxc+WLFiRRkSrW3JjgyghJWVlT310EMPvehKX4qHd5TAOw5QRY/fPWyzgd97CGsELjSZTIdowRmjr008KKJL3lFeXn6QwGBAGtn5pTqdLiQ5OfmzixcvDixevPhVQSia2Tx4+PDh41T028AICA8hMFBHbAN13cWoa783Lrynp6cGjGwbG+Mn7RCJddqS100AOHlRUVGzPB3vu++++2zu3Ll/Zd5htreBkB4iFdgzaJHBewDjz4yxGLxBX0nVanUV84y7elPsNSVqfUtLS5WnY9FS0bS0tGPMO8ycF0UqJBjwjAMKhSKVc/MOniuC3ESNQuNYVbetWQhp93QshL7cS5cudXN29zy8JXKBwJB0dnY+Dc9IsyvqvCqoqCdwzru/FjA7lSfXA3Z4cfny5ee4ES17v/aQs2fPToS8w8CgaanDDG5G/L4BdydqK3iLIS4ubjEPQ0uQZxa7O4bRaNRmZWUdZKHRxPlA5EKEKiTYF+Ahp7/66qv/Hjly5FtQTp3d7JVMnTo1dPfu3XOTkpLumz179lIeNYJTAbVdXl9fPw+7NQ6KTVqVkuwusaisrHw/Pz9fzY1xD8UvWRbxfoSPcACiZHnDyGoMy4iqOISYDyTsk08+SVq5cuUmGHWGJ9cOWm3RaDRPA/DGkWB0dHQkTpo06QupVOpW3AdpKEGBuZ9YHLVZnNjAf1onLGzI2fbOgywjZxOjoVIGDPWMwhByJuBH56NojPUAlBAMFYMQmQ9wihmzm4YidDXOu55SmzuhBuH2+rJlyzKvXLnSxnKHxVeAeByy2MUaeXzmTnXO7sgNYGabent7GwHMIx4Mb8L5NMTsoC8xwAkAWlFiWzjnUkJH3tCjANwLMDpZi8Sni+983n63WIWMZiguLv6IKmBPT8mKw2bWDWhhDUqLG9dmLi0tPZCdnf2tL2oOn/eynHyXZnNUYWHhsjVr1uxFrFdw4yw1NTUfJCYmfkSAUmvdhbDtn5W6q+0hYj8pKSmVRUVFOwXwFI+kqampBGDkc9aOs3G8rmPcALHLPbrnnnvuAgNlyFutFkcKhnglOTmZ6ijdeOQNf/GQu0BB+PqTrz1Fq9XWr127dldLS0u3M0YV9ICMBOX555+v9CUoOp2uESHzLRSAbeOVxP0OEAegeDV86fX679PS0t48d+4csbN+b97j8HuWBWNMDgkJoWfEleD91yIjIxvsCkiq6FUnTpxYgtm73xvsCzXQlfT09L2g3fT8YZ8nYATsIgcydldX1zyVSpWDSvoxu/aKHN5wY3BwcFd4eHiBrQK3A+WAUKBgHEN1dfVHS5cu/dxgMGg9BcMbgNz5srvK9/uMyTwGg3TjdTv0xghVQ/W0sJr7cV0ttVhiAcqa4eHhxlG+45J2dHQUbtu27WGck/48Jpyqek9+u70NhLSpTzwEs3LKokWLLrPHzxwlThVYzxsTJ0782N5TCgoKfr9u3Tq3PAWe0FZWVvb+M888U8lqDGqrGIViUwFXGFJ7fv78+dl81stSUkdIy964caNilDol2x32RUuMAMY/OOuibbofPmTx47+f8DogX3/9dXxYWFgKA4PPck/lzp07H6GcMwYoLrEveNt9nPUGk8FfmNS4AULeMWvWrM2sw8tXhhUKxa9s1zYSlLy8vNfoUQAGjFMJDQ2dbOtpcgEgXgUkIyNDGRUVtc6GD18F47Lt31WnZGZmXomNjf2jTCZb1draeoGHx4VyAfS0sdSL3iF5++23V8MgEW40+q46Kh4567/6dOzbt+9dorLOPI7zwaILvy8MaQlnX1/fSdQWC105J6hvM8Lck83NzVpHMd/Wvgd4OxMSEtaN9TmTydSDIvRhotVemniBwbJKSkqmIJn/xsWWBnf58uUjAMPpX+sxsAaqqqr+5iT8tXLj8JcbfgUIJfOkpKQ12PJmNWTgmpqaI48++mgpx3+VhzE1NbXWaDT2OKC9Dfc8IFQFI5mv4msIYk25ublbExMTP+ZcWwNFXjSk0+lqx/rA1atXKzgvPOnkLfHK6vdTp05NUSqV9zsyBNHW9vb2qtLS0i/S09O/YUD0ueAddxI9eSGqcfVoiXtoaKht/fr1lzgfLXLzS0AoXMHQT40Fhl6vv97Y2Hh2z549Z4uLi4kt0SI2YkpUVwy7US+Y2Z9QjuYdBW1tbQZOwH9aCEQPkUVGRj5pfwCJtV2tVv+7vLz8n1u2bKljAJAOMipr9qBws7BzjexhNW3YsOEzzoerDv0SkMOHD08Au1pIYYRAOH/+fMXmzZvrmPHtQTAJdIfOAlobMaKQNJ08eXJPbW2tlhvHBQvu/RoB2+9kFOSPhA8//JDa3L+E0hreGGgkZ32ARmarfYRS6o50dnYewX4zUzWo8BY2rlzIsXzRfhccEM7aMicAIrwFwogxFf39/ecJDBCFW9XV1W/i2GQ2tuSeBsQOFIkvjEGak5MzGUC0glE1nDlzZiNnvQGl9NX4fg+IL5WMDhb1skajObpp06YH8TrOl2CIgNw9viwjI4NWz5NGs3Ap8fE1CApIQP9vL1ulYnsUwjQui6P98PkQUQKh2yuKCEhQiHy8XFMU0UNEQEQRAREBEUUERAREFBEQERBRREBEEQERARFFBEQERBQRkOCV/wkwAG3HvBgewMy5AAAAAElFTkSuQmCC" />\n-        </div>\n-  <h1 i18n:translate="">Upgrade this site</h1>\n-  <h1>\n-      <a href="#"\n-         tal:attributes="href context/absolute_url;\n-                         title context/Title;"\n-         tal:content="context/Title">\n-          Site title\n-      </a>\n-      <span class="discreet"\n-            tal:content="string:\xe2\x80\x93 ${context/getId}"/>\n-  </h1>\n-  <p class="upgrade-info" i18n:translate="">\n-    More information about the upgrade procedure can be found in the\n-    documentation section of plone.org in the\n-    <a href="http://docs.plone.org/manage/upgrading"\n-       i18n:name="upgrade_guide"\n-       i18n:translate="">Upgrade Guide</a>.\n-  </p>\n-\n-  <tal:current tal:condition="versions/equal">\n-\n-    <p class="upgrade-info">\n-      <span i18n:translate="" tal:omit-tag="">Your site is up to date.</span>\n-    </p>\n-\n-    <tal:optional tal:condition="options/advertise_dx_migration|nothing">\n-\n-      <h2 i18n:translate="">Optional Migration Steps</h2>\n-\n-      <p>\n-        <a href="@@pac_installer"\n-           target="_parent"\n-           tal:define="pac_installed options/pac_installed|nothing"\n-           tal:attributes="href string:${context/absolute_url}/@@pac_installer"\n-           i18n:translate="">\n-           Upgrade your existing content to use Dexterity.\n-        </a>\n-        <span i18n:translate="">This will install plone.app.contenttypes and redirect you to a form where you can migrate your content.</span>\n-      </p>\n-\n-    </tal:optional>\n-\n-  </tal:current>\n-\n-  <tal:downgrade tal:condition="versions/instance_gt">\n-\n-    <p class="upgrade-warning" >\n-      <span i18n:translate="" tal:omit-tag="">WARNING! Your database requires a newer version of Plone than you are currently using. This is a dangerous situation. Please upgrade your Plone version as soon as possible.</span>\n-    </p>\n-\n-  </tal:downgrade>\n-\n-  <tal:upgrade tal:condition="versions/instance_lt">\n-\n-    <form action="#"\n-          method="post"\n-          tal:attributes="action string:${context/absolute_url}/@@plone-upgrade">\n-\n-      <fieldset id="upgrade-form">\n-\n-        <legend i18n:translate="">\n-          Upgrade\n-        </legend>\n-\n-        <div class="upgrade-warning" i18n:translate="">\n-          The site configuration is outdated and needs to be upgraded.\n-        </div>\n+      tal:define="versions view/versions;\n+                  report options/report|nothing;">\n+\n+    <div class="container admin mt-5 mb-5 p-4">\n+        <header class="row">\n+            <p><img src="/++resource++plone-logo.svg"\n+                    width="215" height="56"\n+                    tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.svg"\n+                    alt="Plone logo"\n+                    i18n:attributes="alt" /></p>\n+            <h1>\n+              <span i18n:translate="">Upgrade this site</span>\n+            </h1>\n+            <h2>${context/Title} <small>(${context/getId})</small></h2>\n+            <p class="lead" i18n:translate="">\n+                More information about the upgrade procedure can be found in the documentation section of plone.org in the\n+                <a href="http://docs.plone.org/manage/upgrading"\n+                   i18n:name="upgrade_guide"\n+                   i18n:translate="">Upgrade Guide</a>.\n+            </p>\n+\n+        </header>\n+        <article class="row mb-4">\n+          <div class="col-md-12 mb-3">\n+            <p class="alert-success p-2" tal:condition="versions/equal">\n+              <span i18n:translate="" tal:omit-tag="">Your site is up to date.</span>\n+            </p>\n+\n+            <p class="alert-danger p-2" tal:condition="versions/instance_gt">\n+              <strong i18n:translate="">Warning!</strong> <span i18n:translate="">Your database requires a newer version of Plone than you are currently using. This is a dangerous situation. Please upgrade your Plone version as soon as possible.</span>\n+            </p>\n+\n+            <p class="alert-warning p-2" tal:condition="versions/instance_lt">\n+              <span i18n:translate="">The site configuration is outdated and needs to be upgraded.</span>\n+            </p>\n+            <dl tal:condition="versions/instance_lt">\n+              <dt i18n:translate="">\n+                Current active configuration\n+              </dt>\n+              <dd tal:content="versions/instance">\n+                instance version\n+              </dd>\n+              <dt i18n:translate="">\n+                Latest available configuration\n+              </dt>\n+              <dd tal:content="versions/fs">\n+                file system version\n+              </dd>\n+            </dl>\n+\n+            <tal:volto tal:condition="python: versions[\'equal\'] and view.can_migrate_to_volto()">\n+              <p class="alert-success p-2" i18n:translate="">\n+                You can prepare your site for Volto, the default frontend of Plone 6!\n+              </p>\n+              <a class="p-2" i18n:translate=""\n+                 tal:attributes="href string:${context/absolute_url}/@@migrate_to_volto">\n+                Click here if you want to learn more.\n+              </a>\n+            </tal:volto>\n+\n+          </div>\n+          <form tal:condition="versions/instance_lt"\n+                action="#"\n+                method="post"\n+                tal:attributes="action string:${context/absolute_url}/@@plone-upgrade">\n+\n+            <h3 i18n:translate="">\n+              Upgrade steps\n+            </h3>\n \n-        <p>\n-          <span class="backup-warning" i18n:translate="">\n-            Please ensure you have a backup of your site before performing the\n-            upgrade.\n-          </span>\n-        </p>\n-\n-        <dl>\n-          <dt i18n:translate="">\n-            Current active configuration\n-          </dt>\n-          <dd tal:content="versions/instance">\n-            instance version\n-          </dd>\n-          <dt i18n:translate="">\n-            Latest available configuration\n-          </dt>\n-          <dd tal:content="versions/fs">\n-            file system version\n-          </dd>\n-        </dl>\n-\n-        <fieldset id="upgrade-steps">\n-\n-          <legend i18n:translate="">\n-            Upgrade steps\n-          </legend>\n-\n-          <p class="formHelp" i18n:translate="">\n+            <p class="alert-danger p-2" i18n:translate="">\n+                Please ensure <strong>you have a backup of your site</strong> before performing the upgrade.\n+            </p>\n+\n+          <p i18n:translate="">\n             The following list shows which upgrade steps are going to be run.\n-            Upgrading sometimes performs a catalog/security update, which may\n-            take a long time on large sites. Be patient.\n+            Upgrading sometimes performs a catalog/security update, which may take a long time on large sites. Be patient.\n           </p>\n \n-          <dl class="upgrade-steps">\n+          <dl class="mb-4">\n             <tal:block tal:repeat="upgrade_info view/upgrades">\n \n                 <tal:single condition="python:not isinstance(upgrade_info, list)"\n@@ -163,50 +132,45 @@\n                 </tal:multiple>\n             </tal:block>\n           </dl>\n-        </fieldset>\n \n-        <div class="field">\n-          <label for="dry_run"><input id="dry_run" name="dry_run" type="checkbox" value="1:int" /> <span i18n:translate="">Dry run mode</span></label>\n+        <div class="form-check mb-3">\n+          <input class="form-check-input" id="dry_run" name="dry_run" type="checkbox" value="1:int" />\n+          <label class="form-check-label" for="dry_run" i18n:translate="">Dry run mode</label>\n \n-          <div class="formHelp"  i18n:translate="">\n-            Run the upgrade and show the result without actually writing\n-            anything to the database.\n+          <div class="form-text"\n+               i18n:translate="">\n+            Run the upgrade and show the result without actually writing anything to the database.\n           </div>\n         </div>\n \n-        <div class="formControls">\n-          <input type="hidden" name="form.submitted:boolean" value="True" />\n-          <input type="submit" name="submit" value="Upgrade"\n-                 i18n:attributes="value;" />\n-        </div>\n-\n-      </fieldset>\n+        <input type="hidden" name="form.submitted:boolean" value="True" />\n+        <button type="submit"\n+                name="submit"\n+                class="btn btn-primary"\n+                i18n:translate="" >Upgrade</button>\n     </form>\n \n-  </tal:upgrade>\n-\n-  <tal:report tal:condition="report">\n-\n-    <h2 i18n:translate="">\n-      Upgrade report\n-    </h2>\n \n-    <pre tal:content="report">\n-      report details\n-    </pre>\n+    <tal:report tal:condition="report">\n \n-  </tal:report>\n+      <h2 class="mt-4" i18n:translate="">\n+        Upgrade report\n+      </h2>\n \n-  <h2 i18n:translate="heading_version_overview">\n-      Version Overview\n-  </h2>\n+      <pre tal:content="report">\n+        report details\n+      </pre>\n \n-  <ul class="version-list" tal:define="corelist versions/corelist">\n-      <li>Plone <span tal:replace="corelist/Plone" /></li>\n-      <li>Zope <span tal:replace="corelist/Zope" /></li>\n-      <li>Python <span tal:replace="corelist/Python" /></li>\n-  </ul>\n+    </tal:report>\n   </article>\n-</div>\n+  <footer class="row"\n+          tal:define="corelist versions/corelist">\n+    <h2 i18n:translate="heading_version_overview">Version Overview</h2>\n+    <div>Plone <span tal:replace="corelist/Plone" /></div>\n+    <div>Zope <span tal:replace="corelist/Zope" /></div>\n+    <div>Python <span tal:replace="corelist/Python" /></div>\n+  </footer>\n+\n+    </div>\n </body>\n </html>\ndiff --git a/Products/CMFPlone/skins/plone_templates/recently_modified.pt b/Products/CMFPlone/browser/templates/recently_modified.pt\nsimilarity index 95%\nrename from Products/CMFPlone/skins/plone_templates/recently_modified.pt\nrename to Products/CMFPlone/browser/templates/recently_modified.pt\nindex 7ee649e256..9393d9cfd7 100644\n--- a/Products/CMFPlone/skins/plone_templates/recently_modified.pt\n+++ b/Products/CMFPlone/browser/templates/recently_modified.pt\n@@ -15,7 +15,6 @@\n      tal:define="path context/@@plone_portal_state/navigation_root_path;\n                  results python:container.portal_catalog(sort_on=\'modified\',sort_order=\'reverse\',path=path);\n                  Batch python:modules[\'Products.CMFPlone\'].Batch;\n-                 DateTime python:modules[\'DateTime\'].DateTime;\n                  b_start python:request.get(\'b_start\',0);\n                  normalizeString nocall:context/@@plone/normalizeString;\n                  toLocalizedTime nocall:context/@@plone/toLocalizedTime;">\n@@ -30,8 +29,7 @@\n     </div>\n \n     <div id="content-core"\n-         tal:define="site_properties context/portal_properties/site_properties;\n-                     isAnon context/@@plone_portal_state/anonymous;\n+         tal:define="isAnon context/@@plone_portal_state/anonymous;\n                      portal context/@@plone_portal_state/portal;\n                      show_about python:not isAnon or context.portal_registry[\'plone.allow_anon_views_about\'];">\n         <form name="searchresults" action="" method="post" tal:condition="results"\ndiff --git a/Products/CMFPlone/skins/plone_templates/recently_published.pt b/Products/CMFPlone/browser/templates/recently_published.pt\nsimilarity index 95%\nrename from Products/CMFPlone/skins/plone_templates/recently_published.pt\nrename to Products/CMFPlone/browser/templates/recently_published.pt\nindex cccd879ec9..07f0eca6c7 100644\n--- a/Products/CMFPlone/skins/plone_templates/recently_published.pt\n+++ b/Products/CMFPlone/browser/templates/recently_published.pt\n@@ -14,7 +14,6 @@\n <metal:main fill-slot="main"\n      tal:define="results python:container.portal_catalog(sort_on=\'modified\',sort_order=\'reverse\',review_state=\'published\');\n                  Batch python:modules[\'Products.CMFPlone\'].Batch;\n-                 DateTime python:modules[\'DateTime\'].DateTime;\n                  b_start python:request.get(\'b_start\',0);\n                  toLocalizedTime nocall:context/@@plone/toLocalizedTime;\n                  normalize nocall:context/@@plone/normalizeString;">\n@@ -29,8 +28,7 @@\n     </div>\n \n     <div id="content-core"\n-         tal:define="site_properties context/portal_properties/site_properties;\n-                     isAnon context/@@plone_portal_state/anonymous;\n+         tal:define="isAnon context/@@plone_portal_state/anonymous;\n                      portal context/@@plone_portal_state/portal;\n                      show_about python:not isAnon or context.portal_registry[\'plone.allow_anon_views_about\'];\n                      image_scale portal/@@image_scale">\ndiff --git a/Products/CMFPlone/browser/templates/search.pt b/Products/CMFPlone/browser/templates/search.pt\nindex 6dbfb124e6..31f2004a97 100644\n--- a/Products/CMFPlone/browser/templates/search.pt\n+++ b/Products/CMFPlone/browser/templates/search.pt\n@@ -9,11 +9,9 @@\n <head>\n   <metal:block metal:fill-slot="head_slot">\n \n-    <link rel="alternate" title="RSS 1.0" type="application/rss+xml"\n-          tal:define="here_url context/@@plone_context_state/object_url;"\n-          tal:condition="request/SearchableText|nothing"\n-          tal:attributes="href string:$here_url/search_rss?${request/QUERY_STRING}"/>\n-    <link rel="home" title="Home" i18n:attributes="title" tal:attributes="href view/navroot_url" />\n+    <link rel="alternate" title="RSS 1.0" type="application/rss+xml" href="${context/@@plone_context_state/object_url}/search_rss?${request/QUERY_STRING}"\n+          tal:condition="request/SearchableText|nothing"/>\n+    <link rel="home" title="Home" i18n:attributes="title" href="${view/navroot_url}" />\n \n   </metal:block>\n \n@@ -24,21 +22,28 @@\n \n <body>\n \n-  <div id="content-core" metal:fill-slot="main">\n+  <div id="content-core" metal:fill-slot="main"\n+       tal:define="b_start python:0;\n+                   b_start request/b_start | b_start;\n+                   batch python: view.results(b_start=b_start);\n+                   normalizeString nocall:context/@@plone/normalizeString;">\n \n     <form name="searchform"\n           id="searchform"\n           action="@@search"\n           role="search"\n-          class="searchPage pat-formautofocus"\n+          class="searchPage pat-formautofocus pat-search"\n           tal:define="portal context/@@plone_portal_state/portal;\n                       first_call not:request/advanced_search|nothing;\n                       st python:request.get(\'SearchableText\', \'\');\n                       DateTime python:modules[\'DateTime\'].DateTime;\n-                      navigation_root_url view/navroot_url;">\n+                      navigation_root_url view/navroot_url;\n+                      icons python:context.restrictedTraverse(\'@@iconresolver\');">\n \n         <input type="hidden" name="sort_on" value="" />\n         <input type="hidden" name="sort_order" value="" />\n+        <input type="hidden" id="search-batch-start" name="b_start:int" value="${request/b_start|string:0}" />\n+        <input type="hidden" id="advanced-search-input" name="advanced_search" value="${python: \'True\' if view.show_advanced_search() else \'False\'}" />\n \n         <div class="input-group">\n           <input class="searchPage form-control"\n@@ -46,8 +51,8 @@\n                  type="text"\n                  size="25"\n                  title="Search Site"\n+                 value="${st}"\n                  i18n:attributes="title title_search_title;"\n-                 tal:attributes="value st;"\n                  />\n           <span class="input-group-btn">\n             <input class="searchPage allowMultiSubmit btn btn-primary" type="submit"\n@@ -56,276 +61,268 @@\n           </span>\n         </div>\n \n-        <dl class="actionMenu"\n-            tal:attributes="class python:view.show_advanced_search() and \'actionMenu activated\' or \'actionMenu\'">\n-\n-          <dt class="actionMenuHeader">\n-            <input type="hidden" id="advanced-search-input" name="advanced_search"\n-                   tal:attributes="value python: view.show_advanced_search() and \'True\' or \'False\'" />\n-            <button\n-                 id="search-filter-toggle"\n-                 i18n:translate="narrow_search_options">\n-                  Filter the results\n-            </button>\n-          </dt>\n-          <dd class="actionMenuContent">\n-            <div id="search-filter" i18n:domain="plone">\n-              <fieldset class="noborder">\n-                <legend i18n:translate="label_item_type">Item type</legend>\n-                  <div class="field"\n-                       tal:define="portal_types portal/portal_types;\n-                                   types_list view/types_list;\n-                                   all_checked python:(len(types_list) == len(request.get(\'portal_type\', []))) or first_call;\n-                                   toggle_select_state python:all_checked and \'true\' or \'false\';">\n-                    <div class="optionsToggle">\n-                      <input type="checkbox" onchange="" name="pt_toggle" value="#" id="pt_toggle" class="noborder" checked="checked"\n-                             tal:attributes="checked python:all_checked and \'checked\' or \'\';" />\n-\n-                      <label for="pt_toggle"\n-                             i18n:translate="label_toggle">Select All/None</label>\n-                    </div>\n-                    <div class="search-type-options">\n-                      <div tal:repeat="type types_list">\n-                        <input type="checkbox" name="portal_type:list" value="#" class="noborder" checked="checked"\n-                               tal:attributes="value type;\n-                                               id string:portal_type_${repeat/type/number};\n-                                               checked python:((type in request.get(\'portal_type\', [])) or first_call) and \'checked\' or \'\'"/>\n-                          <label for="" i18n:translate=""\n-                                 tal:attributes="for string:portal_type_${repeat/type/number}"\n-                                 tal:content="python: portal_types.getTypeInfo(type).Title()" />\n-                      </div>\n-                    </div>\n-                  </div>\n-                </fieldset>\n-                <fieldset class="noborder">\n-                  <legend i18n:translate="label_new_items_since">New items since</legend>\n-                  <div class="field">\n-                    <div class="search-date-options">\n-                      <tal:datetime define="today python:DateTime().earliestTime();\n-                                            yesterday python:(today-1).Date();\n-                                            lastweek python:(today-7).Date();\n-                                            lastmonth python:(today-31).Date();\n-                                            ever string:1970-01-02;\n-                                            checked python:request.get(\'created\', []);\n-                                            checked python:(len(checked) == 1) and checked[0] or ever">\n-                        <div>\n-                          <input type="radio" id="query-date-yesterday" name="created.query:record:list:date"\n-                                 tal:attributes="value yesterday;\n-                                                 checked python:checked==yesterday and \'checked\' or \'\';" />\n-                          <label for="query-date-yesterday" i18n:translate="time_yesterday">Yesterday</label>\n-                        </div>\n-                        <div>\n-                          <input type="radio" id="query-date-lastweek" name="created.query:record:list:date"\n-                                 tal:attributes="value lastweek;\n-                                                 checked python:checked==lastweek and \'checked\' or \'\';" />\n-                          <label for="query-date-lastweek" i18n:translate="time_last_week">Last week</label>\n-                        </div>\n-                        <div>\n-                          <input type="radio" id="query-date-lastmonth" name="created.query:record:list:date"\n-                                 tal:attributes="value lastmonth;\n-                                                 checked python:checked==lastmonth and \'checked\' or \'\';" />\n-                          <label for="query-date-lastmonth" i18n:translate="time_last_month">Last month</label>\n-                        </div>\n-                        <div>\n-                          <input type="radio" id="query-date-ever" name="created.query:record:list:date"\n-                                 tal:attributes="value ever;\n-                                                 checked python:checked==ever and \'checked\' or \'\';" />\n-                          <label for="query-date-ever" i18n:translate="time_ever">Ever</label>\n-                        </div>\n-                      </tal:datetime>\n-                    </div>\n-                    <input type="hidden" name="created.range:record" value="min" />\n-                  </div>\n-                </fieldset>\n-              </div>\n-            </dd>\n-          </dl>\n-\n-        <div>\n-          <div>\n-            <h1 class="documentFirstHeading"\n-                i18n:translate=""\n-                tal:condition="not:st">\n-              Search results\n-            </h1>\n-            <h1 class="documentFirstHeading"\n-                i18n:translate=""\n-                tal:condition="st">\n+        <input type="hidden" name="created.range:record" value="min" />\n+\n+        <div class="mt-3">\n+          <h1 id="search-term">\n+            <span tal:condition="not:st" i18n:translate="">Search results</span>\n+            <span tal:condition="st" i18n:translate="">\n               Search results for\n-              <strong id="search-term" tal:content="st" i18n:name="term">\n+              <span class="text-muted" tal:content="st" i18n:name="term">\n                 Search Term\n-              </strong>\n-            </h1>\n-\n-            <p id="rss-subscription" i18n:domain="plone"\n-               tal:condition="context/@@syndication-util/search_rss_enabled">\n-               <img src="" alt="RSS"\n-                    tal:attributes="src string:${portal_url}/rss.png"/>\n-                <a href=""\n-                   class="link-feed"\n-                   tal:define="here_url context/@@plone_context_state/object_url"\n-                   tal:attributes="href string:$here_url/search_rss?${request/QUERY_STRING}">\n-                    <span i18n:translate="title_subscribe_rss_feed">\n-                      Subscribe to an always-updated RSS feed.\n-                    </span>\n-                </a>\n-              </p>\n-            </div>\n-            <div class="visualClear"><!-- --></div>\n-            <div id="search-results-wrapper"\n-                 tal:define="b_start python:0;\n-                             b_start request/b_start | b_start;\n-                             batch python: view.results(b_start=b_start);\n-                             normalizeString nocall:context/@@plone/normalizeString;">\n-\n-              <div id="search-results-bar">\n-                <span i18n:translate="batch_x_items_matching_your_criteria" i18n:domain="plone" id="results-count">\n-                  <strong i18n:name="number" id="search-results-number"\n-                          tal:content="batch/sequence_length|string:0">234</strong>\n-                    items matching your search terms.\n-                </span>\n+              </span>\n+            </span>\n+          </h1>\n+        </div>\n+\n+        <div class="d-flex mb-2">\n+\n+          <div class="flex-fill">\n+            <a class="nav-link active ps-2" aria-current="page" href="#">\n+              <span i18n:translate="batch_x_items_matching_your_criteria" class="d-flex" i18n:domain="plone" id="results-count" >\n+                <span i18n:name="number" id="search-results-number" class="badge bg-primary me-2 d-flex justify-content-center align-items-center"\n+                      tal:content="batch/sequence_length|string:0">234</span>\n+                  items matching your search terms.\n+              </span>\n+            </a>\n+          </div>\n+\n+          <div class="nav-item dropdown" id="search-filter">\n+            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false" id="search-filter-toggle" i18n:translate="narrow_search_options">\n+              Filter the results\n+            </a>\n+            <div class="dropdown-menu dropdown-menu-md-end">\n+              <div class="d-flex text-nowrap">\n+                <div class="mx-3">\n+                  <span class="fw-bold" i18n:translate="label_item_type">Item type</span>\n+                  <ul class="list-unstyled search-type-options"\n+                      tal:define="portal_types portal/portal_types;\n+                                  types_list view/types_list;\n+                                  all_checked python:(len(types_list) == len(request.get(\'portal_type\', []))) or first_call;\n+                                  toggle_select_state python:all_checked and \'true\' or \'false\';">\n+                    <li>\n+                      <div class="form-check">\n+                        <input type="checkbox"\n+                               name="pt_toggle"\n+                               value="#"\n+                               id="pt_toggle"\n+                               class="form-check-input"\n+                               checked="${python:\'checked\' if all_checked else \'\'}" />\n+                        <label for="pt_toggle" class="form-check-label"\n+                               i18n:translate="label_toggle">Select All/None</label>\n+                      </div>\n+                    </li>\n+                    <li tal:repeat="type types_list">\n+                      <div class="form-check">\n+                        <input type="checkbox" name="portal_type:list" class="form-check-input" checked="checked"\n+                               value="${type}" id="portal_type_${repeat/type/number}" checked="${python:\'checked\' if ((type in request.get(\'portal_type\', [])) or first_call) else \'\'}"/>\n+                        <label for="portal_type_${repeat/type/number}" i18n:translate="" class="form-check-label"\n+                               tal:content="python: portal_types.getTypeInfo(type).Title()" />\n+                      </div>\n+                    </li>\n+                  </ul>\n+                </div>\n+                <div class="mx-3">\n+                  <span class="fw-bold" i18n:translate="label_new_items_since">New items since</span>\n+                  <ul class="list-unstyled"\n+                      tal:define="today python:DateTime().earliestTime();\n+                                  yesterday python:(today-1).ISO();\n+                                  lastweek python:(today-7).ISO();\n+                                  lastmonth python:(today-31).ISO();\n+                                  ever python:DateTime(\'1970-01-02\').ISO();\n+                                  checked python:request.get(\'created\', {}).get(\'query\', ever)">\n+                    <li>\n+                      <div class="form-check">\n+                        <input type="radio" id="query-date-yesterday" name="created.query:record:date" class="form-check-input"\n+                               value="${yesterday}" checked="${python:\'checked\' if checked==yesterday else \'\'}" />\n+                        <label for="query-date-yesterday" i18n:translate="time_yesterday" class="form-check-label">Yesterday</label>\n+                      </div>\n+                    </li>\n+                    <li>\n+                      <div class="form-check">\n+                        <input type="radio" id="query-date-lastweek" name="created.query:record:date" class="form-check-input"\n+                               value="${lastweek}" checked="${python:\'checked\' if checked==lastweek else \'\'}" />\n+                        <label for="query-date-lastweek" i18n:translate="time_last_week" class="form-check-label">Last week</label>\n+                      </div>\n+                    </li>\n+                    <li>\n+                      <div class="form-check">\n+                        <input type="radio" id="query-date-lastmonth" name="created.query:record:date" class="form-check-input"\n+                               value="${lastmonth}" checked="${python:\'checked\' if checked==lastmonth else \'\'}" />\n+                        <label for="query-date-lastmonth" i18n:translate="time_last_month" class="form-check-label">Last month</label>\n+                      </div>\n+                    </li>\n+                    <li>\n+                      <div class="form-check">\n+                        <input type="radio" id="query-date-ever" name="created.query:record:date" class="form-check-input"\n+                               value="${ever}" checked="${python:\'checked\' if checked==ever else \'\'}" />\n+                        <label for="query-date-ever" i18n:translate="time_ever" class="form-check-label">Ever</label>\n+                      </div>\n+                    </li>\n+                  </ul>\n+                </div>\n               </div>\n+            </div>\n+          </div>\n+\n+          <div class="nav-item dropdown">\n+            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false" i18n:translate="sort_by">Sort by</a>\n+            <ul class="dropdown-menu dropdown-menu-md-end" id="sorting-options">\n+              <li tal:repeat="item view/sort_options">\n+                <a class="dropdown-item" href="${item/url}"\n+                   data-sort="${item/sortkey}" data-order="${python:\'reverse\' if item.reverse else \'\'}"\n+                   tal:content="item/title">sort option</a>\n+              </li>\n+            </ul>\n+          </div>\n+\n+        </div>\n+\n+        <div id="search-results-wrapper">\n+\n+          <metal:searchresults define-macro="search_results">\n \n+            <div id="search-results"\n+                 tal:define="navigation_root_url context/@@plone_portal_state/navigation_root_url;\n+                             show_images python:view.show_images;\n+                             search_image_scale python:view.search_image_scale;"\n+                 data-default-sort="${python:request.get(\'sort_on\') or view.default_sort_on}">\n+\n+              <metal:noresults tal:condition="not: batch">\n+                <div class="alert alert-info" i18n:translate="description_no_results_found">No results were found.</div>\n+              </metal:noresults>\n+\n+              <metal:results tal:condition="batch"\n+                             tal:define="isAnon context/@@plone_portal_state/anonymous;\n+                                         toLocalizedTime nocall: context/@@plone/toLocalizedTime;\n+                                         use_view_action python:context.portal_registry.get(\'plone.types_use_view_action_in_listings\', []);\n+                                         allowAnonymousViewAbout python:context.portal_registry[\'plone.allow_anon_views_about\'];\n+                                         show_about python:not isAnon or allowAnonymousViewAbout;\n+                                         image_scale portal/@@image_scale">\n+                <ol class="searchResults list-group list-group-numbered" start="${python:request.get(\'b_start\', 0) + 1}">\n+                  <tal:results repeat="item batch">\n+                    <li tal:define="hasIcon item/getIcon" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start  fs-4">\n+                      <div class="ms-2 me-auto">\n+                        <div class="result-title">\n+                          <a href="${python:(item_url + \'/view\') if item_type in use_view_action else item_url}"\n+                            class="state-${item/review_state}"\n+                            tal:define="item_url item/getURL;\n+                                        item_type item/PortalType">\n+                                        <span tal:replace="python:item.getDataOrigin().pretty_title_or_id()"></span>\n+                          </a>\n+                        </div>\n \n+                        <small class="text-muted small fs-6" i18n:domain="plone"\n+                              tal:condition="show_about">\n+                          <span class="documentAuthor"\n+                                i18n:translate="label_by_author">\n+                            by\n+                            <tal:block tal:condition="item/Creator"\n+                                      tal:define="author python:context.portal_membership.getMemberInfo(item.Creator())">\n+                              <a href="${navigation_root_url}/author/${item/Creator}"\n+                                tal:content="python:author and author[\'fullname\'] or item.Creator()"\n+                                tal:omit-tag="not:item/Creator"\n+                                i18n:name="author">\n+                                  Bob Dobalina\n+                              </a>\n+                            </tal:block>\n+                          </span>\n+                          <span tal:define="publication_date item/EffectiveDate;\n+                                            modification_date item/ModificationDate">\n \n-              <metal:searchresults define-macro="search_results">\n-                <div class="autotabs">\n-                  <nav class="autotoc-nav" id="searchResultsSort">\n-                    <span i18n:translate="sort_by" class="autotab-heading">Sort by</span>\n-                      <span id="sorting-options">\n-                        <metal:sorting define-macro="sorting">\n-                          <tal:block repeat="item view/sort_options">\n-                            <a data-sort="" tal:content="item/title"\n-                               tal:attributes="href item/url;\n-                                               data-sort python:item.sortkey and item.sortkey or None;\n-                                               data-order python: item.reverse and \'reverse\' or \'\';\n-                                               class python: item.selected and \'active\' or \'\'"></a>\n-                          </tal:block>\n-                        </metal:sorting>\n-                      </span>\n-                    </nav>\n-                    <div id="search-results"\n-                         tal:define="navigation_root_url context/@@plone_portal_state/navigation_root_url;"\n-                         tal:attributes="data-default-sort python:request.get(\'sort_on\') or view.default_sort_on">\n-\n-                      <metal:noresults tal:condition="not: batch">\n-                        <p i18n:domain="plone"><strong i18n:translate="description_no_results_found">No results were found.</strong></p>\n-                      </metal:noresults>\n-\n-                      <metal:results tal:condition="batch"\n-                                     tal:define="isAnon context/@@plone_portal_state/anonymous;\n-                                                 toLocalizedTime nocall: context/@@plone/toLocalizedTime;\n-                                                 use_view_action python:context.portal_registry.get(\'plone.types_use_view_action_in_listings\', []);\n-                                                 allowAnonymousViewAbout python:context.portal_registry[\'plone.allow_anon_views_about\'];\n-                                                 show_about python:not isAnon or allowAnonymousViewAbout;\n-                                                 image_scale portal/@@image_scale">\n-                        <ol class="searchResults">\n-                          <tal:results repeat="item batch">\n-                            <li tal:define="hasIcon item/getIcon">\n-                              <span class="result-title">\n-                                <img class="thumb-icon"\n-                                     tal:condition="hasIcon"\n-                                     tal:replace="structure python: image_scale.tag(item, \'image\', scale=\'icon\', css_class=\'thumb-icon\')">\n-                                <a href="#"\n-                                   tal:define="item_url item/getURL;\n-                                               item_type item/PortalType"\n-                                   tal:attributes="href python:item_type in use_view_action and (item_url + \'/view\') or item_url;\n-                                                   class string:state-${item/review_state}"\n-                                   tal:content="python:item.getDataOrigin().pretty_title_or_id()" />\n+                            <span class="documentPublished" tal:condition="python: publication_date != \'None\'">\n+                              &mdash;\n+                              <span i18n:translate="box_published">\n+                                published\n                               </span>\n-                              <span class="discreet" i18n:domain="plone"\n-                                    tal:condition="show_about">\n-                                <span class="documentAuthor"\n-                                      i18n:translate="label_by_author">\n-                                  by\n-                                  <tal:block tal:condition="item/Creator"\n-                                             tal:define="author python:context.portal_membership.getMemberInfo(item.Creator())">\n-                                    <a href="#"\n-                                       tal:attributes="href string:$navigation_root_url/author/${item/Creator}"\n-                                       tal:content="python:author and author[\'fullname\'] or item.Creator()"\n-                                       tal:omit-tag="not:item/Creator"\n-                                       i18n:name="author">\n-                                        Bob Dobalina\n-                                    </a>\n-                                  </tal:block>\n-                                </span>\n-                                <span tal:define="publication_date item/EffectiveDate;\n-                                                  modification_date item/ModificationDate">\n-\n-                                  <span class="documentPublished" tal:condition="python: publication_date != \'None\'">\n-                                    &mdash;\n-                                    <span i18n:translate="box_published">\n-                                      published\n-                                    </span>\n-                                    <span tal:replace="python:toLocalizedTime(publication_date, long_format=0)">\n-                                      August 16, 2001 at 23:35:59\n-                                    </span>\n-                                  </span>\n-\n-                                  <span class="documentModified" tal:condition="python: modification_date != publication_date">\n-                                    &mdash;\n-                                    <span i18n:translate="box_last_modified">\n-                                      last modified\n-                                    </span>\n-                                    <span tal:replace="python:toLocalizedTime(modification_date, long_format=1)">\n-                                      August 16, 2001 at 23:35:59\n-                                    </span>\n-                                  </span>\n-                                </span>\n-                                <span tal:define="categories item/Subject|nothing"\n-                                      tal:condition="categories">\n-                                  &mdash;\n-                                  <tal:filedunder i18n:translate="">filed under:</tal:filedunder>\n-                                  <span tal:repeat="category categories">\n-                                    <a href="" class="link-category" rel="tag" tal:content="category"\n-                                       tal:attributes="href string:$navigation_root_url/@@search?Subject%3Alist=${category}">\n-                                      Category\n-                                    </a><tal:separator condition="not: repeat/category/end">,</tal:separator>\n-                                  </span>\n-                                </span>\n+                              <span tal:replace="python:toLocalizedTime(publication_date, long_format=0)">\n+                                August 16, 2001 at 23:35:59\n                               </span>\n-                              <p class="discreet croppedDescription"\n-                                 tal:condition="item/CroppedDescription" tal:content="item/CroppedDescription">\n-                                Cropped description\n-                              </p>\n-\n-                              <cite class="documentLocation link-location"\n-                                    tal:define="breadcrumbs python: view.breadcrumbs(item);\n-                                                is_rtl context/@@plone_portal_state/is_rtl;"\n-                                    tal:condition=\'breadcrumbs\'>\n-                                <span i18n:translate="text_searchitem_location">\n-                                  Located in\n-                                </span>\n-                                <span tal:repeat="crumb breadcrumbs"\n-                                      tal:attributes="dir python:is_rtl and \'rtl\' or \'ltr\';">\n-                                  <tal:item tal:define="is_last repeat/crumb/end;\n-                                                        url crumb/absolute_url;\n-                                                        title crumb/Title">\n-                                    <a href="#" tal:omit-tag="not: url" tal:attributes="href url" tal:content="title">crumb</a>\n-                                    <span class="breadcrumbSeparator" tal:condition="not: is_last">\n-                                      <tal:ltr condition="not: is_rtl">/</tal:ltr>\n-                                      <tal:rtl condition="is_rtl">/</tal:rtl>\n-                                    </span>\n-                                  </tal:item>\n-                                </span>\n-                              </cite>\n-                            </li>\n-                          </tal:results>\n-                        </ol>\n-                        <div metal:use-macro="context/batch_macros/macros/navigation" />\n-                      </metal:results>\n-                    </div>\n-                  </div>\n-                </metal:searchresults>\n+                            </span>\n+\n+                            <span class="documentModified" tal:condition="python: modification_date != publication_date">\n+                              &mdash;\n+                              <span i18n:translate="box_last_modified">\n+                                last modified\n+                              </span>\n+                              <span tal:replace="python:toLocalizedTime(modification_date, long_format=1)">\n+                                August 16, 2001 at 23:35:59\n+                              </span>\n+                            </span>\n+                          </span>\n+                          <span tal:define="categories item/Subject|nothing"\n+                                tal:condition="categories">\n+                            &mdash;\n+                            <tal:filedunder i18n:translate="">filed under:</tal:filedunder>\n+                            <span tal:repeat="category categories">\n+                              <a href="${navigation_root_url}/@@search?Subject%3Alist=${category}" class="link-category" rel="tag"\n+                                tal:content="category">\n+                                Category\n+                              </a><tal:separator condition="not: repeat/category/end">,</tal:separator>\n+                            </span>\n+                          </span>\n+                        </small>\n+\n+                        <div class="croppedDescription mt-2 mb-2 fs-5 fw-light"\n+                          tal:condition="item/CroppedDescription" tal:content="item/CroppedDescription">\n+                          Cropped description\n+                        </div>\n \n+                        <cite class="d-block small text-muted fs-6"\n+                              tal:define="breadcrumbs python: view.breadcrumbs(item);\n+                                          is_rtl context/@@plone_portal_state/is_rtl;"\n+                              tal:condition=\'breadcrumbs\'>\n+                          <span i18n:translate="text_searchitem_location">\n+                            Located in\n+                          </span>\n+                          <span dir="${python:\'rtl\' if is_rtl else \'ltr\'}"\n+                                tal:repeat="crumb breadcrumbs">\n+                            <tal:item tal:define="is_last repeat/crumb/end;\n+                                                  url crumb/absolute_url;\n+                                                  title crumb/Title">\n+                              <a href="${url}" tal:omit-tag="not: url" tal:content="title">crumb</a>\n+                              <span class="breadcrumbSeparator" tal:condition="not: is_last">\n+                                <tal:ltr condition="not: is_rtl">/</tal:ltr>\n+                                <tal:rtl condition="is_rtl">/</tal:rtl>\n+                              </span>\n+                            </tal:item>\n+                          </span>\n+                        </cite>\n+\n+                      </div>\n+\n+                      <a href="${python:(item_url + \'/view\') if item_type in use_view_action else item_url}"\n+                          class="state-${item/review_state}"\n+                          tal:define="item_url item/getURL;\n+                                    item_type item/PortalType">\n+                          <img class="thumb-icon"\n+                            tal:condition="python: show_images and hasIcon"\n+                            tal:replace="structure python: image_scale.tag(item, \'image\', scale=search_image_scale, css_class=\'thumb-icon\')">\n+                      </a>\n+\n+                    </li>\n+                  </tal:results>\n+                </ol>\n+                <div metal:use-macro="context/batch_macros/macros/navigation" />\n+              </metal:results>\n             </div>\n+\n+          </metal:searchresults>\n+\n         </div>\n \n-        <div class="visualClear"><!-- --></div>\n-    </form>\n+        <div class="my-3" id="rss-subscription" i18n:domain="plone"\n+            tal:condition="context/@@syndication-util/search_rss_enabled">\n+          <a class="mx-2 text-decoration-none -flex  align-items-center"\n+             href="${context/@@plone_context_state/object_url}/search_rss?${request/QUERY_STRING}">\n+              <img tal:replace="structure python:icons.tag(\'rss-fill\')" />\n+              <span i18n:translate="title_subscribe_rss_feed" class="ms-1">\n+                Subscribe to an always-updated RSS feed.\n+              </span>\n+          </a>\n+        </div>\n \n-    <script type="text/javascript" src="${context/portal_url}/++resource++search.js">\n-    </script>\n+    </form>\n   </div>\n \n </body>\ndiff --git a/Products/CMFPlone/browser/templates/test_rendering.pt b/Products/CMFPlone/browser/templates/test_rendering.pt\nnew file mode 100644\nindex 0000000000..55793fa423\n--- /dev/null\n+++ b/Products/CMFPlone/browser/templates/test_rendering.pt\n@@ -0,0 +1,82 @@\n+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:tal="http://xml.zope.org/namespaces/tal"\n+  xmlns:metal="http://xml.zope.org/namespaces/metal" xmlns:i18n="http://xml.zope.org/namespaces/i18n" lang="en"\n+  metal:use-macro="context/@@main_template/macros/master" i18n:domain="plone">\n+\n+<body>\n+\n+  <metal:main fill-slot="main">\n+\n+    <style>\n+\n+    </style>\n+\n+    <ul class="nav nav-tabs mb-3">\n+      <li class="nav-item">\n+        <a class="nav-link active" href="${portal_url}/@@test-rendering">Test Rendering</a>\n+      </li>\n+      <li class="nav-item">\n+        <a class="nav-link" href="${portal_url}/@@test-rendering-cheatsheet">Bootstrap Cheatsheet</a>\n+      </li>\n+      <li class="nav-item">\n+        <a class="nav-link" href="${portal_url}/@@test-rendering-icons">Icons</a>\n+      </li>\n+    </ul>\n+\n+    <h1>Plone User Interface elements test page</h1>\n+\n+    <p class="lead">\n+      This page lists the common user interface elements that exist in Plone, and\n+      shows you how they are rendered. It also tests a couple of common Internet\n+      Explorer rendering bugs, so you can see if your changes have triggered any\n+      bad behaviour on this front.\n+    </p>\n+\n+    <h2 class="mt-5">Alerts</h2>\n+    <p><a href="https://getbootstrap.com/docs/5.1/components/alerts/">https://getbootstrap.com/docs/5.1/components/alerts/</a></p>\n+\n+    <div class="alert alert-primary" role="alert">\n+      <span>Mollit minim ullamco aliqua do culpa amet ullamco eu tempor. <a href="http://localhost:8080/Plone27/docs/edit">nulla proident velit</a></span>\n+    </div>\n+    <div class="alert alert-secondary" role="alert">\n+      <span>Mollit minim ullamco aliqua do culpa amet ullamco eu tempor. <a href="http://localhost:8080/Plone27/docs/edit">nulla proident velit</a></span>\n+    </div>\n+    <div class="alert alert-success" role="alert">\n+      <span>Mollit minim ullamco aliqua do culpa amet ullamco eu tempor. <a href="http://localhost:8080/Plone27/docs/edit">nulla proident velit</a></span>\n+    </div>\n+    <div class="alert alert-info" role="alert">\n+      <span>Mollit minim ullamco aliqua do culpa amet ullamco eu tempor. <a href="http://localhost:8080/Plone27/docs/edit">nulla proident velit</a></span>\n+    </div>\n+    <div class="alert alert-warning" role="alert">\n+      <span>Mollit minim ullamco aliqua do culpa amet ullamco eu tempor. <a href="http://localhost:8080/Plone27/docs/edit">nulla proident velit</a></span>\n+    </div>\n+    <div class="alert alert-danger" role="alert">\n+      <span>Mollit minim ullamco aliqua do culpa amet ullamco eu tempor. <a href="http://localhost:8080/Plone27/docs/edit">nulla proident velit</a></span>\n+    </div>\n+    <div class="alert alert-light" role="alert">\n+      <span>Mollit minim ullamco aliqua do culpa amet ullamco eu tempor. <a href="http://localhost:8080/Plone27/docs/edit">nulla proident velit</a></span>\n+    </div>\n+    <div class="alert alert-dark" role="alert">\n+      <span>Mollit minim ullamco aliqua do culpa amet ullamco eu tempor. <a href="http://localhost:8080/Plone27/docs/edit">nulla proident velit</a></span>\n+    </div>\n+\n+  </metal:main>\n+\n+  <aside id="portal-column-one" metal:fill-slot="column_one_slot">\n+\n+    <div class="card portlet portlet-foobar" i18n:domain="plone">\n+\n+      <div class="card-header">\n+        Portlet Header\n+      </div>\n+\n+      <div class="card-body">\n+        <p>Etiam porta sem malesuada magna mollis euismod. Vivamus sagittis lacus vel augue laoreet rutrum faucibus dolor auctor. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>\n+      </div>\n+\n+      <div class="card-footer">Portlet Footer</div>\n+    </div>\n+  </aside>\n+\n+</body>\n+\n+</html>\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt b/Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt\nnew file mode 100644\nindex 0000000000..d22c353640\n--- /dev/null\n+++ b/Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt\n@@ -0,0 +1,1695 @@\n+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:tal="http://xml.zope.org/namespaces/tal"\n+  xmlns:metal="http://xml.zope.org/namespaces/metal" xmlns:i18n="http://xml.zope.org/namespaces/i18n" lang="en"\n+  metal:use-macro="context/@@main_template/macros/master" i18n:domain="plone">\n+\n+<body>\n+\n+  <metal:main fill-slot="main">\n+\n+    <style>\n+\n+      .bd-cheatsheet h2,\n+      .bd-cheatsheet .bd-heading\n+        {\n+          padding: 1em 0;\n+          background-color: #fff;\n+        }\n+\n+    </style>    \n+\n+    <ul class="nav nav-tabs mb-3">\n+      <li class="nav-item">\n+        <a class="nav-link" href="${portal_url}/@@test-rendering">Test Rendering</a>\n+      </li>\n+      <li class="nav-item">\n+        <a class="nav-link active" href="${portal_url}/@@test-rendering-cheatsheet">Bootstrap Cheatsheet</a>\n+      </li>\n+      <li class="nav-item">\n+        <a class="nav-link" href="${portal_url}/@@test-rendering-icons">Icons</a>\n+      </li>\n+    </ul>\n+\n+    <h1>Bootstrap Cheatsheet</h1>\n+\n+    <p class="lead">\n+      Kitchen sink of Bootstrap components. This page is borrowd from the <a href="https://getbootstrap.com/docs/5.1/examples/cheatsheet/" target="_blank">Bootstrap Examples Cheatsheet"</a>.\n+    </p>\n+\n+    <!--\n+      \n+      Todos to fix markup\n+\n+      Change <div class="bd-cheatsheet container-fluid bg-body"> to <div class="bd-cheatsheet bg-body">\n+      Search and replace /docs/5.1 by https://getbootstrap.com/docs/5.1\n+    \n+    -->\n+\n+    <!-- Bootstrap Cheatsheet -->\n+\n+    <div class="bd-cheatsheet bg-body">\n+      <section id="content">\n+        <h2 class="sticky-xl-top fw-bold pt-3 pt-xl-5 pb-2 pb-xl-3">Contents</h2>\n+\n+        <article class="my-3" id="typography">\n+\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Typography</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/content/typography/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <p class="display-1">Display 1</p>\n+            <p class="display-2">Display 2</p>\n+            <p class="display-3">Display 3</p>\n+            <p class="display-4">Display 4</p>\n+            <p class="display-5">Display 5</p>\n+            <p class="display-6">Display 6</p>\n+            </div>\n+\n+            <div class="bd-example">\n+            <p class="h1">Heading 1</p>\n+            <p class="h2">Heading 2</p>\n+            <p class="h3">Heading 3</p>\n+            <p class="h4">Heading 4</p>\n+            <p class="h5">Heading 5</p>\n+            <p class="h6">Heading 6</p>\n+            </div>\n+\n+            <div class="bd-example">\n+            <p class="lead">\n+              This is a lead paragraph. It stands out from regular paragraphs.\n+            </p>\n+            </div>\n+\n+            <div class="bd-example">\n+            <p>You can use the mark tag to <mark>highlight</mark> text.</p>\n+            <p><del>This line of text is meant to be treated as deleted text.</del></p>\n+            <p><s>This line of text is meant to be treated as no longer accurate.</s></p>\n+            <p><ins>This line of text is meant to be treated as an addition to the document.</ins></p>\n+            <p><u>This line of text will render as underlined.</u></p>\n+            <p><small>This line of text is meant to be treated as fine print.</small></p>\n+            <p><strong>This line rendered as bold text.</strong></p>\n+            <p><em>This line rendered as italicized text.</em></p>\n+            </div>\n+\n+            <div class="bd-example">\n+            <blockquote class="blockquote">\n+              <p>A well-known quote, contained in a blockquote element.</p>\n+              <footer class="blockquote-footer">Someone famous in <cite title="Source Title">Source Title</cite></footer>\n+            </blockquote>\n+            </div>\n+\n+            <div class="bd-example">\n+            <ul class="list-unstyled">\n+              <li>This is a list.</li>\n+              <li>It appears completely unstyled.</li>\n+              <li>Structurally, it\'s still a list.</li>\n+              <li>However, this style only applies to immediate child elements.</li>\n+              <li>Nested lists:\n+                <ul>\n+                  <li>are unaffected by this style</li>\n+                  <li>will still show a bullet</li>\n+                  <li>and have appropriate left margin</li>\n+                </ul>\n+              </li>\n+              <li>This may still come in handy in some situations.</li>\n+            </ul>\n+            </div>\n+\n+            <div class="bd-example">\n+            <ul class="list-inline">\n+              <li class="list-inline-item">This is a list item.</li>\n+              <li class="list-inline-item">And another one.</li>\n+              <li class="list-inline-item">But they\'re displayed inline.</li>\n+            </ul>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="images">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Images</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/content/images/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <svg class="bd-placeholder-img bd-placeholder-img-lg img-fluid" width="100%" height="250" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Responsive image" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#868e96"/><text x="50%" y="50%" fill="#dee2e6" dy=".3em">Responsive image</text></svg>\n+\n+            </div>\n+\n+            <div class="bd-example">\n+            <svg class="bd-placeholder-img img-thumbnail" width="200" height="200" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="A generic square placeholder image with a white border around it, making it resemble a photograph taken with an old instant camera: 200x200" preserveAspectRatio="xMidYMid slice" focusable="false"><title>A generic square placeholder image with a white border around it, making it resemble a photograph taken with an old instant camera</title><rect width="100%" height="100%" fill="#868e96"/><text x="50%" y="50%" fill="#dee2e6" dy=".3em">200x200</text></svg>\n+\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="tables">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Tables</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/content/tables/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <table class="table table-striped">\n+              <thead>\n+              <tr>\n+                <th scope="col">#</th>\n+                <th scope="col">First</th>\n+                <th scope="col">Last</th>\n+                <th scope="col">Handle</th>\n+              </tr>\n+              </thead>\n+              <tbody>\n+              <tr>\n+                <th scope="row">1</th>\n+                <td>Mark</td>\n+                <td>Otto</td>\n+                <td>@mdo</td>\n+              </tr>\n+              <tr>\n+                <th scope="row">2</th>\n+                <td>Jacob</td>\n+                <td>Thornton</td>\n+                <td>@fat</td>\n+              </tr>\n+              <tr>\n+                <th scope="row">3</th>\n+                <td colspan="2">Larry the Bird</td>\n+                <td>@twitter</td>\n+              </tr>\n+              </tbody>\n+            </table>\n+            </div>\n+\n+            <div class="bd-example">\n+            <table class="table table-dark table-borderless">\n+              <thead>\n+              <tr>\n+                <th scope="col">#</th>\n+                <th scope="col">First</th>\n+                <th scope="col">Last</th>\n+                <th scope="col">Handle</th>\n+              </tr>\n+              </thead>\n+              <tbody>\n+              <tr>\n+                <th scope="row">1</th>\n+                <td>Mark</td>\n+                <td>Otto</td>\n+                <td>@mdo</td>\n+              </tr>\n+              <tr>\n+                <th scope="row">2</th>\n+                <td>Jacob</td>\n+                <td>Thornton</td>\n+                <td>@fat</td>\n+              </tr>\n+              <tr>\n+                <th scope="row">3</th>\n+                <td colspan="2">Larry the Bird</td>\n+                <td>@twitter</td>\n+              </tr>\n+              </tbody>\n+            </table>\n+            </div>\n+\n+            <div class="bd-example">\n+            <table class="table table-hover">\n+              <thead>\n+              <tr>\n+                <th scope="col">Class</th>\n+                <th scope="col">Heading</th>\n+                <th scope="col">Heading</th>\n+              </tr>\n+              </thead>\n+              <tbody>\n+              <tr>\n+                <th scope="row">Default</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              \n+              <tr class="table-primary">\n+                <th scope="row">Primary</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              <tr class="table-secondary">\n+                <th scope="row">Secondary</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              <tr class="table-success">\n+                <th scope="row">Success</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              <tr class="table-danger">\n+                <th scope="row">Danger</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              <tr class="table-warning">\n+                <th scope="row">Warning</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              <tr class="table-info">\n+                <th scope="row">Info</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              <tr class="table-light">\n+                <th scope="row">Light</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              <tr class="table-dark">\n+                <th scope="row">Dark</th>\n+                <td>Cell</td>\n+                <td>Cell</td>\n+              </tr>\n+              </tbody>\n+            </table>\n+            </div>\n+\n+            <div class="bd-example">\n+            <table class="table table-sm table-bordered">\n+              <thead>\n+              <tr>\n+                <th scope="col">#</th>\n+                <th scope="col">First</th>\n+                <th scope="col">Last</th>\n+                <th scope="col">Handle</th>\n+              </tr>\n+              </thead>\n+              <tbody>\n+              <tr>\n+                <th scope="row">1</th>\n+                <td>Mark</td>\n+                <td>Otto</td>\n+                <td>@mdo</td>\n+              </tr>\n+              <tr>\n+                <th scope="row">2</th>\n+                <td>Jacob</td>\n+                <td>Thornton</td>\n+                <td>@fat</td>\n+              </tr>\n+              <tr>\n+                <th scope="row">3</th>\n+                <td colspan="2">Larry the Bird</td>\n+                <td>@twitter</td>\n+              </tr>\n+              </tbody>\n+            </table>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="figures">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Figures</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/content/figures/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <figure class="figure">\n+              <svg class="bd-placeholder-img figure-img img-fluid rounded" width="400" height="300" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: 400x300" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#868e96"/><text x="50%" y="50%" fill="#dee2e6" dy=".3em">400x300</text></svg>\n+\n+              <figcaption class="figure-caption">A caption for the above image.</figcaption>\n+            </figure>\n+            </div>\n+          </div>\n+        </article>\n+      </section>\n+\n+      <section id="forms">\n+        <h2 class="sticky-xl-top fw-bold pt-3 pt-xl-5 pb-2 pb-xl-3">Forms</h2>\n+\n+        <article class="my-3" id="overview">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Overview</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/forms/overview/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <form>\n+              <div class="mb-3">\n+                <label for="exampleInputEmail1" class="form-label">Email address</label>\n+                <input type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp">\n+                <div id="emailHelp" class="form-text">We\'ll never share your email with anyone else.</div>\n+              </div>\n+              <div class="mb-3">\n+                <label for="exampleInputPassword1" class="form-label">Password</label>\n+                <input type="password" class="form-control" id="exampleInputPassword1">\n+              </div>\n+              <div class="mb-3 form-check">\n+                <input type="checkbox" class="form-check-input" id="exampleCheck1">\n+                <label class="form-check-label" for="exampleCheck1">Check me out</label>\n+              </div>\n+              <fieldset class="mb-3">\n+                <legend>Radios buttons</legend>\n+                <div class="form-check">\n+                  <input type="radio" name="radios" class="form-check-input" id="exampleRadio1">\n+                  <label class="form-check-label" for="exampleRadio1">Default radio</label>\n+                </div>\n+                <div class="mb-3 form-check">\n+                  <input type="radio" name="radios" class="form-check-input" id="exampleRadio2">\n+                  <label class="form-check-label" for="exampleRadio2">Another radio</label>\n+                </div>\n+              </fieldset>\n+              <div class="mb-3">\n+                <label class="form-label" for="customFile">Upload</label>\n+                <input type="file" class="form-control" id="customFile">\n+              </div>\n+              <div class="mb-3 form-check form-switch">\n+                <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" checked>\n+                <label class="form-check-label" for="flexSwitchCheckChecked">Checked switch checkbox input</label>\n+              </div>\n+              <div class="mb-3">\n+                <label for="customRange3" class="form-label">Example range</label>\n+                <input type="range" class="form-range" min="0" max="5" step="0.5" id="customRange3">\n+              </div>\n+              <button type="submit" class="btn btn-primary">Submit</button>\n+            </form>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="disabled-forms">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Disabled forms</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/forms/overview/#disabled-forms">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <form>\n+              <fieldset disabled aria-label="Disabled fieldset example">\n+                <div class="mb-3">\n+                  <label for="disabledTextInput" class="form-label">Disabled input</label>\n+                  <input type="text" id="disabledTextInput" class="form-control" placeholder="Disabled input">\n+                </div>\n+                <div class="mb-3">\n+                  <label for="disabledSelect" class="form-label">Disabled select menu</label>\n+                  <select id="disabledSelect" class="form-select">\n+                    <option>Disabled select</option>\n+                  </select>\n+                </div>\n+                <div class="mb-3">\n+                  <div class="form-check">\n+                    <input class="form-check-input" type="checkbox" id="disabledFieldsetCheck" disabled>\n+                    <label class="form-check-label" for="disabledFieldsetCheck">\n+                      Can\'t check this\n+                    </label>\n+                  </div>\n+                </div>\n+                <fieldset class="mb-3">\n+                  <legend>Disabled radios buttons</legend>\n+                  <div class="form-check">\n+                    <input type="radio" name="radios" class="form-check-input" id="disabledRadio1" disabled>\n+                    <label class="form-check-label" for="disabledRadio1">Disabled radio</label>\n+                  </div>\n+                  <div class="mb-3 form-check">\n+                    <input type="radio" name="radios" class="form-check-input" id="disabledRadio2" disabled>\n+                    <label class="form-check-label" for="disabledRadio2">Another radio</label>\n+                  </div>\n+                </fieldset>\n+                <div class="mb-3">\n+                  <label class="form-label" for="disabledCustomFile">Upload</label>\n+                  <input type="file" class="form-control" id="disabledCustomFile" disabled>\n+                </div>\n+                <div class="mb-3 form-check form-switch">\n+                  <input class="form-check-input" type="checkbox" role="switch" id="disabledSwitchCheckChecked" checked disabled>\n+                  <label class="form-check-label" for="disabledSwitchCheckChecked">Disabled checked switch checkbox input</label>\n+                </div>\n+                <div class="mb-3">\n+                  <label for="disabledRange" class="form-label">Disabled range</label>\n+                  <input type="range" class="form-range" min="0" max="5" step="0.5" id="disabledRange">\n+                </div>\n+                <button type="submit" class="btn btn-primary">Submit</button>\n+              </fieldset>\n+            </form>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="sizing">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Sizing</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/forms/form-control/#sizing">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div class="mb-3">\n+              <input class="form-control form-control-lg" type="text" placeholder=".form-control-lg" aria-label=".form-control-lg example">\n+            </div>\n+            <div class="mb-3">\n+              <select class="form-select form-select-lg mb-3" aria-label=".form-select-lg example">\n+                <option selected>Open this select menu</option>\n+                <option value="1">One</option>\n+                <option value="2">Two</option>\n+                <option value="3">Three</option>\n+              </select>\n+            </div>\n+            <div class="mb-3">\n+              <input type="file" class="form-control form-control-lg" aria-label="Large file input example">\n+            </div>\n+            </div>\n+\n+            <div class="bd-example">\n+            <div class="mb-3">\n+              <input class="form-control form-control-sm" type="text" placeholder=".form-control-sm" aria-label=".form-control-sm example">\n+            </div>\n+            <div class="mb-3">\n+              <select class="form-select form-select-sm" aria-label=".form-select-sm example">\n+                <option selected>Open this select menu</option>\n+                <option value="1">One</option>\n+                <option value="2">Two</option>\n+                <option value="3">Three</option>\n+              </select>\n+            </div>\n+            <div class="mb-3">\n+              <input type="file" class="form-control form-control-sm" aria-label="Small file input example">\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="input-group">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Input group</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/forms/input-group/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div class="input-group mb-3">\n+              <span class="input-group-text" id="basic-addon1">@</span>\n+              <input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">\n+            </div>\n+            <div class="input-group mb-3">\n+              <input type="text" class="form-control" placeholder="Recipient\'s username" aria-label="Recipient\'s username" aria-describedby="basic-addon2">\n+              <span class="input-group-text" id="basic-addon2">@example.com</span>\n+            </div>\n+            <label for="basic-url" class="form-label">Your vanity URL</label>\n+            <div class="input-group mb-3">\n+              <span class="input-group-text" id="basic-addon3">https://example.com/users/</span>\n+              <input type="text" class="form-control" id="basic-url" aria-describedby="basic-addon3">\n+            </div>\n+            <div class="input-group mb-3">\n+              <span class="input-group-text">$</span>\n+              <input type="text" class="form-control" aria-label="Amount (to the nearest dollar)">\n+              <span class="input-group-text">.00</span>\n+            </div>\n+            <div class="input-group">\n+              <span class="input-group-text">With textarea</span>\n+              <textarea class="form-control" aria-label="With textarea"></textarea>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="floating-labels">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Floating labels</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/forms/floating-labels/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <form>\n+              <div class="form-floating mb-3">\n+                <input type="email" class="form-control" id="floatingInput" placeholder="name@example.com">\n+                <label for="floatingInput">Email address</label>\n+              </div>\n+              <div class="form-floating">\n+                <input type="password" class="form-control" id="floatingPassword" placeholder="Password">\n+                <label for="floatingPassword">Password</label>\n+              </div>\n+            </form>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="validation">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Validation</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/forms/validation/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <form class="row g-3">\n+              <div class="col-md-4">\n+                <label for="validationServer01" class="form-label">First name</label>\n+                <input type="text" class="form-control is-valid" id="validationServer01" value="Mark" required>\n+                <div class="valid-feedback">\n+                  Looks good!\n+                </div>\n+              </div>\n+              <div class="col-md-4">\n+                <label for="validationServer02" class="form-label">Last name</label>\n+                <input type="text" class="form-control is-valid" id="validationServer02" value="Otto" required>\n+                <div class="valid-feedback">\n+                  Looks good!\n+                </div>\n+              </div>\n+              <div class="col-md-4">\n+                <label for="validationServerUsername" class="form-label">Username</label>\n+                <div class="input-group has-validation">\n+                  <span class="input-group-text" id="inputGroupPrepend3">@</span>\n+                  <input type="text" class="form-control is-invalid" id="validationServerUsername" aria-describedby="inputGroupPrepend3" required>\n+                  <div class="invalid-feedback">\n+                    Please choose a username.\n+                  </div>\n+                </div>\n+              </div>\n+              <div class="col-md-6">\n+                <label for="validationServer03" class="form-label">City</label>\n+                <input type="text" class="form-control is-invalid" id="validationServer03" required>\n+                <div class="invalid-feedback">\n+                  Please provide a valid city.\n+                </div>\n+              </div>\n+              <div class="col-md-3">\n+                <label for="validationServer04" class="form-label">State</label>\n+                <select class="form-select is-invalid" id="validationServer04" required>\n+                  <option selected disabled value="">Choose...</option>\n+                  <option>...</option>\n+                </select>\n+                <div class="invalid-feedback">\n+                  Please select a valid state.\n+                </div>\n+              </div>\n+              <div class="col-md-3">\n+                <label for="validationServer05" class="form-label">Zip</label>\n+                <input type="text" class="form-control is-invalid" id="validationServer05" required>\n+                <div class="invalid-feedback">\n+                  Please provide a valid zip.\n+                </div>\n+              </div>\n+              <div class="col-12">\n+                <div class="form-check">\n+                  <input class="form-check-input is-invalid" type="checkbox" value="" id="invalidCheck3" required>\n+                  <label class="form-check-label" for="invalidCheck3">\n+                    Agree to terms and conditions\n+                  </label>\n+                  <div class="invalid-feedback">\n+                    You must agree before submitting.\n+                  </div>\n+                </div>\n+              </div>\n+              <div class="col-12">\n+                <button class="btn btn-primary" type="submit">Submit form</button>\n+              </div>\n+            </form>\n+            </div>\n+          </div>\n+        </article>\n+      </section>\n+\n+      <section id="components">\n+        <h2 class="sticky-xl-top fw-bold pt-3 pt-xl-5 pb-2 pb-xl-3">Components</h2>\n+\n+        <article class="my-3" id="accordion">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Accordion</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/accordion/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div class="accordion" id="accordionExample">\n+              <div class="accordion-item">\n+                <h4 class="accordion-header" id="headingOne">\n+                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">\n+                    Accordion Item #1\n+                  </button>\n+                </h4>\n+                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">\n+                  <div class="accordion-body">\n+                    <strong>This is the first item\'s accordion body.</strong> It is hidden by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It\'s also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.\n+                  </div>\n+                </div>\n+              </div>\n+              <div class="accordion-item">\n+                <h4 class="accordion-header" id="headingTwo">\n+                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">\n+                    Accordion Item #2\n+                  </button>\n+                </h4>\n+                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">\n+                  <div class="accordion-body">\n+                    <strong>This is the second item\'s accordion body.</strong> It is hidden by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It\'s also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.\n+                  </div>\n+                </div>\n+              </div>\n+              <div class="accordion-item">\n+                <h4 class="accordion-header" id="headingThree">\n+                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">\n+                    Accordion Item #3\n+                  </button>\n+                </h4>\n+                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">\n+                  <div class="accordion-body">\n+                    <strong>This is the third item\'s accordion body.</strong> It is hidden by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It\'s also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.\n+                  </div>\n+                </div>\n+              </div>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="alerts">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Alerts</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/alerts/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            \n+            <div class="alert alert-primary alert-dismissible fade show" role="alert">\n+              A simple primary alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n+              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n+            </div>\n+            <div class="alert alert-secondary alert-dismissible fade show" role="alert">\n+              A simple secondary alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n+              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n+            </div>\n+            <div class="alert alert-success alert-dismissible fade show" role="alert">\n+              A simple success alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n+              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n+            </div>\n+            <div class="alert alert-danger alert-dismissible fade show" role="alert">\n+              A simple danger alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n+              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n+            </div>\n+            <div class="alert alert-warning alert-dismissible fade show" role="alert">\n+              A simple warning alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n+              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n+            </div>\n+            <div class="alert alert-info alert-dismissible fade show" role="alert">\n+              A simple info alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n+              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n+            </div>\n+            <div class="alert alert-light alert-dismissible fade show" role="alert">\n+              A simple light alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n+              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n+            </div>\n+            <div class="alert alert-dark alert-dismissible fade show" role="alert">\n+              A simple dark alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n+              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n+            </div>\n+            </div>\n+\n+            <div class="bd-example">\n+            <div class="alert alert-success" role="alert">\n+              <h4 class="alert-heading">Well done!</h4>\n+              <p>Aww yeah, you successfully read this important alert message. This example text is going to run a bit longer so that you can see how spacing within an alert works with this kind of content.</p>\n+              <hr>\n+              <p class="mb-0">Whenever you need to, be sure to use margin utilities to keep things nice and tidy.</p>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="badge">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Badge</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/badge/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <p class="h1">Example heading <span class="badge bg-primary">New</span></p>\n+            <p class="h2">Example heading <span class="badge bg-secondary">New</span></p>\n+            <p class="h3">Example heading <span class="badge bg-success">New</span></p>\n+            <p class="h4">Example heading <span class="badge bg-danger">New</span></p>\n+            <p class="h5">Example heading <span class="badge bg-warning text-dark">New</span></p>\n+            <p class="h6">Example heading <span class="badge bg-info text-dark">New</span></p>\n+            <p class="h6">Example heading <span class="badge bg-light text-dark">New</span></p>\n+            <p class="h6">Example heading <span class="badge bg-dark">New</span></p>\n+            </div>\n+\n+            <div class="bd-example">\n+            \n+            <span class="badge rounded-pill bg-primary">Primary</span>\n+            <span class="badge rounded-pill bg-secondary">Secondary</span>\n+            <span class="badge rounded-pill bg-success">Success</span>\n+            <span class="badge rounded-pill bg-danger">Danger</span>\n+            <span class="badge rounded-pill bg-warning text-dark">Warning</span>\n+            <span class="badge rounded-pill bg-info text-dark">Info</span>\n+            <span class="badge rounded-pill bg-light text-dark">Light</span>\n+            <span class="badge rounded-pill bg-dark">Dark</span>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="breadcrumb">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Breadcrumb</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/breadcrumb/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <nav aria-label="breadcrumb">\n+              <ol class="breadcrumb">\n+                <li class="breadcrumb-item"><a href="#">Home</a></li>\n+                <li class="breadcrumb-item"><a href="#">Library</a></li>\n+                <li class="breadcrumb-item active" aria-current="page">Data</li>\n+              </ol>\n+            </nav>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="buttons">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Buttons</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/buttons/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            \n+            <button type="button" class="btn btn-primary">Primary</button>\n+            <button type="button" class="btn btn-secondary">Secondary</button>\n+            <button type="button" class="btn btn-success">Success</button>\n+            <button type="button" class="btn btn-danger">Danger</button>\n+            <button type="button" class="btn btn-warning">Warning</button>\n+            <button type="button" class="btn btn-info">Info</button>\n+            <button type="button" class="btn btn-light">Light</button>\n+            <button type="button" class="btn btn-dark">Dark</button>\n+\n+            <button type="button" class="btn btn-link">Link</button>\n+            </div>\n+\n+            <div class="bd-example">\n+            \n+            <button type="button" class="btn btn-outline-primary">Primary</button>\n+            <button type="button" class="btn btn-outline-secondary">Secondary</button>\n+            <button type="button" class="btn btn-outline-success">Success</button>\n+            <button type="button" class="btn btn-outline-danger">Danger</button>\n+            <button type="button" class="btn btn-outline-warning">Warning</button>\n+            <button type="button" class="btn btn-outline-info">Info</button>\n+            <button type="button" class="btn btn-outline-light">Light</button>\n+            <button type="button" class="btn btn-outline-dark">Dark</button>\n+            </div>\n+\n+            <div class="bd-example">\n+            <button type="button" class="btn btn-primary btn-sm">Small button</button>\n+            <button type="button" class="btn btn-primary">Standard button</button>\n+            <button type="button" class="btn btn-primary btn-lg">Large button</button>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="button-group">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Button group</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/button-group/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">\n+              <div class="btn-group me-2" role="group" aria-label="First group">\n+                <button type="button" class="btn btn-secondary">1</button>\n+                <button type="button" class="btn btn-secondary">2</button>\n+                <button type="button" class="btn btn-secondary">3</button>\n+                <button type="button" class="btn btn-secondary">4</button>\n+              </div>\n+              <div class="btn-group me-2" role="group" aria-label="Second group">\n+                <button type="button" class="btn btn-secondary">5</button>\n+                <button type="button" class="btn btn-secondary">6</button>\n+                <button type="button" class="btn btn-secondary">7</button>\n+              </div>\n+              <div class="btn-group" role="group" aria-label="Third group">\n+                <button type="button" class="btn btn-secondary">8</button>\n+              </div>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="card">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Card</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/card/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div class="row  row-cols-1 row-cols-md-2 g-4">\n+              <div class="col">\n+                <div class="card">\n+                  <svg class="bd-placeholder-img card-img-top" width="100%" height="180" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Image cap" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#868e96"/><text x="50%" y="50%" fill="#dee2e6" dy=".3em">Image cap</text></svg>\n+\n+                  <div class="card-body">\n+                    <h5 class="card-title">Card title</h5>\n+                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card\'s content.</p>\n+                    <a href="#" class="btn btn-primary">Go somewhere</a>\n+                  </div>\n+                </div>\n+              </div>\n+              <div class="col">\n+                <div class="card">\n+                  <div class="card-header">\n+                    Featured\n+                  </div>\n+                  <div class="card-body">\n+                    <h5 class="card-title">Card title</h5>\n+                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card\'s content.</p>\n+                    <a href="#" class="btn btn-primary">Go somewhere</a>\n+                  </div>\n+                  <div class="card-footer text-muted">\n+                    2 days ago\n+                  </div>\n+                </div>\n+              </div>\n+              <div class="col">\n+                <div class="card">\n+                  <div class="card-body">\n+                    <h5 class="card-title">Card title</h5>\n+                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card\'s content.</p>\n+                  </div>\n+                  <ul class="list-group list-group-flush">\n+                    <li class="list-group-item">An item</li>\n+                    <li class="list-group-item">A second item</li>\n+                    <li class="list-group-item">A third item</li>\n+                  </ul>\n+                  <div class="card-body">\n+                    <a href="#" class="card-link">Card link</a>\n+                    <a href="#" class="card-link">Another link</a>\n+                  </div>\n+                </div>\n+              </div>\n+              <div class="col">\n+                <div class="card">\n+                  <div class="row g-0">\n+                    <div class="col-md-4">\n+                      <svg class="bd-placeholder-img" width="100%" height="250" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Image" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#868e96"/><text x="50%" y="50%" fill="#dee2e6" dy=".3em">Image</text></svg>\n+\n+                    </div>\n+                    <div class="col-md-8">\n+                      <div class="card-body">\n+                        <h5 class="card-title">Card title</h5>\n+                        <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>\n+                        <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>\n+                      </div>\n+                    </div>\n+                  </div>\n+                </div>\n+              </div>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="carousel">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Carousel</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/carousel/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div id="carouselExampleCaptions" class="carousel slide" data-bs-ride="carousel">\n+              <div class="carousel-indicators">\n+                <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>\n+                <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="1" aria-label="Slide 2"></button>\n+                <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="2" aria-label="Slide 3"></button>\n+              </div>\n+              <div class="carousel-inner">\n+                <div class="carousel-item active">\n+                  <svg class="bd-placeholder-img bd-placeholder-img-lg d-block w-100" width="800" height="400" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: First slide" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#777"/><text x="50%" y="50%" fill="#555" dy=".3em">First slide</text></svg>\n+\n+                  <div class="carousel-caption d-none d-md-block">\n+                    <h5>First slide label</h5>\n+                    <p>Some representative placeholder content for the first slide.</p>\n+                  </div>\n+                </div>\n+                <div class="carousel-item">\n+                  <svg class="bd-placeholder-img bd-placeholder-img-lg d-block w-100" width="800" height="400" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Second slide" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#666"/><text x="50%" y="50%" fill="#444" dy=".3em">Second slide</text></svg>\n+\n+                  <div class="carousel-caption d-none d-md-block">\n+                    <h5>Second slide label</h5>\n+                    <p>Some representative placeholder content for the second slide.</p>\n+                  </div>\n+                </div>\n+                <div class="carousel-item">\n+                  <svg class="bd-placeholder-img bd-placeholder-img-lg d-block w-100" width="800" height="400" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Third slide" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#555"/><text x="50%" y="50%" fill="#333" dy=".3em">Third slide</text></svg>\n+\n+                  <div class="carousel-caption d-none d-md-block">\n+                    <h5>Third slide label</h5>\n+                    <p>Some representative placeholder content for the third slide.</p>\n+                  </div>\n+                </div>\n+              </div>\n+              <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleCaptions"  data-bs-slide="prev">\n+                <span class="carousel-control-prev-icon" aria-hidden="true"></span>\n+                <span class="visually-hidden">Previous</span>\n+              </button>\n+              <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleCaptions"  data-bs-slide="next">\n+                <span class="carousel-control-next-icon" aria-hidden="true"></span>\n+                <span class="visually-hidden">Next</span>\n+              </button>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="dropdowns">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Dropdowns</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/dropdowns/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div class="btn-group w-100 align-items-center justify-content-between flex-wrap">\n+              <div class="dropdown">\n+                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButtonSM" data-bs-toggle="dropdown" aria-expanded="false">\n+                  Dropdown button\n+                </button>\n+                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButtonSM">\n+                  <li><h6 class="dropdown-header">Dropdown header</h6></li>\n+                  <li><a class="dropdown-item" href="#">Action</a></li>\n+                  <li><a class="dropdown-item" href="#">Another action</a></li>\n+                  <li><a class="dropdown-item" href="#">Something else here</a></li>\n+                  <li><hr class="dropdown-divider"></li>\n+                  <li><a class="dropdown-item" href="#">Separated link</a></li>\n+                </ul>\n+              </div>\n+              <div class="dropdown">\n+                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">\n+                  Dropdown button\n+                </button>\n+                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">\n+                  <li><h6 class="dropdown-header">Dropdown header</h6></li>\n+                  <li><a class="dropdown-item" href="#">Action</a></li>\n+                  <li><a class="dropdown-item" href="#">Another action</a></li>\n+                  <li><a class="dropdown-item" href="#">Something else here</a></li>\n+                  <li><hr class="dropdown-divider"></li>\n+                  <li><a class="dropdown-item" href="#">Separated link</a></li>\n+                </ul>\n+              </div>\n+              <div class="dropdown">\n+                <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" id="dropdownMenuButtonLG" data-bs-toggle="dropdown" aria-expanded="false">\n+                  Dropdown button\n+                </button>\n+                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButtonLG">\n+                  <li><h6 class="dropdown-header">Dropdown header</h6></li>\n+                  <li><a class="dropdown-item" href="#">Action</a></li>\n+                  <li><a class="dropdown-item" href="#">Another action</a></li>\n+                  <li><a class="dropdown-item" href="#">Something else here</a></li>\n+                  <li><hr class="dropdown-divider"></li>\n+                  <li><a class="dropdown-item" href="#">Separated link</a></li>\n+                </ul>\n+              </div>\n+            </div>\n+            </div>\n+\n+            <div class="bd-example">\n+            <div class="btn-group">\n+              <button type="button" class="btn btn-primary">Primary</button>\n+              <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">\n+                <span class="visually-hidden">Toggle Dropdown</span>\n+              </button>\n+              <ul class="dropdown-menu">\n+                <li><a class="dropdown-item" href="#">Action</a></li>\n+                <li><a class="dropdown-item" href="#">Another action</a></li>\n+                <li><a class="dropdown-item" href="#">Something else here</a></li>\n+              </ul>\n+            </div><!-- /btn-group -->\n+            <div class="btn-group">\n+              <button type="button" class="btn btn-secondary">Secondary</button>\n+              <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">\n+                <span class="visually-hidden">Toggle Dropdown</span>\n+              </button>\n+              <ul class="dropdown-menu">\n+                <li><a class="dropdown-item" href="#">Action</a></li>\n+                <li><a class="dropdown-item" href="#">Another action</a></li>\n+                <li><a class="dropdown-item" href="#">Something else here</a></li>\n+              </ul>\n+            </div><!-- /btn-group -->\n+            <div class="btn-group">\n+              <button type="button" class="btn btn-success">Success</button>\n+              <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">\n+                <span class="visually-hidden">Toggle Dropdown</span>\n+              </button>\n+              <ul class="dropdown-menu">\n+                <li><a class="dropdown-item" href="#">Action</a></li>\n+                <li><a class="dropdown-item" href="#">Another action</a></li>\n+                <li><a class="dropdown-item" href="#">Something else here</a></li>\n+              </ul>\n+            </div><!-- /btn-group -->\n+            <div class="btn-group">\n+              <button type="button" class="btn btn-info">Info</button>\n+              <button type="button" class="btn btn-info dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">\n+                <span class="visually-hidden">Toggle Dropdown</span>\n+              </button>\n+              <ul class="dropdown-menu">\n+                <li><a class="dropdown-item" href="#">Action</a></li>\n+                <li><a class="dropdown-item" href="#">Another action</a></li>\n+                <li><a class="dropdown-item" href="#">Something else here</a></li>\n+              </ul>\n+            </div><!-- /btn-group -->\n+            <div class="btn-group">\n+              <button type="button" class="btn btn-warning">Warning</button>\n+              <button type="button" class="btn btn-warning dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">\n+                <span class="visually-hidden">Toggle Dropdown</span>\n+              </button>\n+              <ul class="dropdown-menu">\n+                <li><a class="dropdown-item" href="#">Action</a></li>\n+                <li><a class="dropdown-item" href="#">Another action</a></li>\n+                <li><a class="dropdown-item" href="#">Something else here</a></li>\n+              </ul>\n+            </div><!-- /btn-group -->\n+            <div class="btn-group">\n+              <button type="button" class="btn btn-danger">Danger</button>\n+              <button type="button" class="btn btn-danger dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">\n+                <span class="visually-hidden">Toggle Dropdown</span>\n+              </button>\n+              <ul class="dropdown-menu">\n+                <li><a class="dropdown-item" href="#">Action</a></li>\n+                <li><a class="dropdown-item" href="#">Another action</a></li>\n+                <li><a class="dropdown-item" href="#">Something else here</a></li>\n+              </ul>\n+            </div><!-- /btn-group -->\n+            </div>\n+\n+            <div class="bd-example">\n+            <div class="btn-group w-100 align-items-center justify-content-between flex-wrap">\n+              <div class="dropend">\n+                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropendMenuButton" data-bs-toggle="dropdown" aria-expanded="false">\n+                  Dropend button\n+                </button>\n+                <ul class="dropdown-menu" aria-labelledby="dropendMenuButton">\n+                  <li><h6 class="dropdown-header">Dropdown header</h6></li>\n+                  <li><a class="dropdown-item" href="#">Action</a></li>\n+                  <li><a class="dropdown-item" href="#">Another action</a></li>\n+                  <li><a class="dropdown-item" href="#">Something else here</a></li>\n+                  <li><hr class="dropdown-divider"></li>\n+                  <li><a class="dropdown-item" href="#">Separated link</a></li>\n+                </ul>\n+              </div>\n+              <div class="dropup">\n+                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropupMenuButton" data-bs-toggle="dropdown" aria-expanded="false">\n+                  Dropup button\n+                </button>\n+                <ul class="dropdown-menu" aria-labelledby="dropupMenuButton">\n+                  <li><h6 class="dropdown-header">Dropdown header</h6></li>\n+                  <li><a class="dropdown-item" href="#">Action</a></li>\n+                  <li><a class="dropdown-item" href="#">Another action</a></li>\n+                  <li><a class="dropdown-item" href="#">Something else here</a></li>\n+                  <li><hr class="dropdown-divider"></li>\n+                  <li><a class="dropdown-item" href="#">Separated link</a></li>\n+                </ul>\n+              </div>\n+              <div class="dropstart">\n+                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropstartMenuButton" data-bs-toggle="dropdown" aria-expanded="false">\n+                  Dropstart button\n+                </button>\n+                <ul class="dropdown-menu" aria-labelledby="dropstartMenuButton">\n+                  <li><h6 class="dropdown-header">Dropdown header</h6></li>\n+                  <li><a class="dropdown-item" href="#">Action</a></li>\n+                  <li><a class="dropdown-item" href="#">Another action</a></li>\n+                  <li><a class="dropdown-item" href="#">Something else here</a></li>\n+                  <li><hr class="dropdown-divider"></li>\n+                  <li><a class="dropdown-item" href="#">Separated link</a></li>\n+                </ul>\n+              </div>\n+            </div>\n+            </div>\n+\n+            <div class="bd-example">\n+            <div class="btn-group">\n+              <div class="dropdown">\n+                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownRightMenuButton" data-bs-toggle="dropdown" aria-expanded="false">\n+                  End-aligned menu\n+                </button>\n+                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownRightMenuButton">\n+                  <li><h6 class="dropdown-header">Dropdown header</h6></li>\n+                  <li><a class="dropdown-item" href="#">Action</a></li>\n+                  <li><a class="dropdown-item" href="#">Another action</a></li>\n+                  <li><hr class="dropdown-divider"></li>\n+                  <li><a class="dropdown-item" href="#">Separated link</a></li>\n+                </ul>\n+              </div>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="list-group">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>List group</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/list-group/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <ul class="list-group">\n+              <li class="list-group-item disabled" aria-disabled="true">A disabled item</li>\n+              <li class="list-group-item">A second item</li>\n+              <li class="list-group-item">A third item</li>\n+              <li class="list-group-item">A fourth item</li>\n+              <li class="list-group-item">And a fifth one</li>\n+            </ul>\n+            </div>\n+\n+            <div class="bd-example">\n+            <ul class="list-group list-group-flush">\n+              <li class="list-group-item">An item</li>\n+              <li class="list-group-item">A second item</li>\n+              <li class="list-group-item">A third item</li>\n+              <li class="list-group-item">A fourth item</li>\n+              <li class="list-group-item">And a fifth one</li>\n+            </ul>\n+            </div>\n+\n+            <div class="bd-example">\n+            <div class="list-group">\n+              <a href="#" class="list-group-item list-group-item-action">A simple default list group item</a>\n+              \n+              <a href="#" class="list-group-item list-group-item-action list-group-item-primary">A simple primary list group item</a>\n+              <a href="#" class="list-group-item list-group-item-action list-group-item-secondary">A simple secondary list group item</a>\n+              <a href="#" class="list-group-item list-group-item-action list-group-item-success">A simple success list group item</a>\n+              <a href="#" class="list-group-item list-group-item-action list-group-item-danger">A simple danger list group item</a>\n+              <a href="#" class="list-group-item list-group-item-action list-group-item-warning">A simple warning list group item</a>\n+              <a href="#" class="list-group-item list-group-item-action list-group-item-info">A simple info list group item</a>\n+              <a href="#" class="list-group-item list-group-item-action list-group-item-light">A simple light list group item</a>\n+              <a href="#" class="list-group-item list-group-item-action list-group-item-dark">A simple dark list group item</a>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="modal">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Modal</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/modal/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div class="d-flex justify-content-between flex-wrap">\n+              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalDefault">\n+                Launch demo modal\n+              </button>\n+              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdropLive">\n+                Launch static backdrop modal\n+              </button>\n+              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalCenteredScrollable">\n+                Vertically centered scrollable modal\n+              </button>\n+              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalFullscreen">\n+                Full screen\n+              </button>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="navs">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Navs</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/navs-tabs/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <nav class="nav">\n+              <a class="nav-link active" aria-current="page" href="#">Active</a>\n+              <a class="nav-link" href="#">Link</a>\n+              <a class="nav-link" href="#">Link</a>\n+              <a class="nav-link disabled">Disabled</a>\n+            </nav>\n+            </div>\n+\n+            <div class="bd-example">\n+            <nav>\n+              <div class="nav nav-tabs mb-3" id="nav-tab" role="tablist">\n+                <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Home</button>\n+                <button class="nav-link" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">Profile</button>\n+                <button class="nav-link" id="nav-contact-tab" data-bs-toggle="tab" data-bs-target="#nav-contact" type="button" role="tab" aria-controls="nav-contact" aria-selected="false">Contact</button>\n+              </div>\n+            </nav>\n+            <div class="tab-content" id="nav-tabContent">\n+              <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">\n+                <p><strong>This is some placeholder content the Home tab\'s associated content.</strong> Clicking another tab will toggle the visibility of this one for the next. The tab JavaScript swaps classes to control the content visibility and styling. You can use it with tabs, pills, and any other <code>.nav</code>-powered navigation.</p>\n+              </div>\n+              <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">\n+                <p><strong>This is some placeholder content the Profile tab\'s associated content.</strong> Clicking another tab will toggle the visibility of this one for the next. The tab JavaScript swaps classes to control the content visibility and styling. You can use it with tabs, pills, and any other <code>.nav</code>-powered navigation.</p>\n+              </div>\n+              <div class="tab-pane fade" id="nav-contact" role="tabpanel" aria-labelledby="nav-contact-tab">\n+                <p><strong>This is some placeholder content the Contact tab\'s associated content.</strong> Clicking another tab will toggle the visibility of this one for the next. The tab JavaScript swaps classes to control the content visibility and styling. You can use it with tabs, pills, and any other <code>.nav</code>-powered navigation.</p>\n+              </div>\n+            </div>\n+            </div>\n+\n+            <div class="bd-example">\n+            <ul class="nav nav-pills">\n+              <li class="nav-item">\n+                <a class="nav-link active" aria-current="page" href="#">Active</a>\n+              </li>\n+              <li class="nav-item">\n+                <a class="nav-link" href="#">Link</a>\n+              </li>\n+              <li class="nav-item">\n+                <a class="nav-link" href="#">Link</a>\n+              </li>\n+              <li class="nav-item">\n+                <a class="nav-link disabled">Disabled</a>\n+              </li>\n+            </ul>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="navbar">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Navbar</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/navbar/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <nav class="navbar navbar-expand-lg navbar-light bg-light">\n+              <div class="container-fluid">\n+                <a class="navbar-brand" href="#">\n+                  <img src="https://getbootstrap.com/docs/5.1/assets/brand/bootstrap-logo-white.svg" width="38" height="30" class="d-inline-block align-top" alt="Bootstrap" loading="lazy"\n+                      style="filter: invert(1) grayscale(100%) brightness(200%);">\n+                </a>\n+                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">\n+                  <span class="navbar-toggler-icon"></span>\n+                </button>\n+                <div class="collapse navbar-collapse" id="navbarSupportedContent">\n+                  <ul class="navbar-nav me-auto mb-2 mb-lg-0">\n+                    <li class="nav-item">\n+                      <a class="nav-link active" aria-current="page" href="#">Home</a>\n+                    </li>\n+                    <li class="nav-item">\n+                      <a class="nav-link" href="#">Link</a>\n+                    </li>\n+                    <li class="nav-item dropdown">\n+                      <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">\n+                        Dropdown\n+                      </a>\n+                      <ul class="dropdown-menu" aria-labelledby="navbarDropdown">\n+                        <li><a class="dropdown-item" href="#">Action</a></li>\n+                        <li><a class="dropdown-item" href="#">Another action</a></li>\n+                        <li><hr class="dropdown-divider"></li>\n+                        <li><a class="dropdown-item" href="#">Something else here</a></li>\n+                      </ul>\n+                    </li>\n+                    <li class="nav-item">\n+                      <a class="nav-link disabled">Disabled</a>\n+                    </li>\n+                  </ul>\n+                  <form class="d-flex">\n+                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">\n+                    <button class="btn btn-outline-dark" type="submit">Search</button>\n+                  </form>\n+                </div>\n+              </div>\n+            </nav>\n+\n+            <nav class="navbar navbar-expand-lg navbar-dark bg-primary mt-5">\n+              <div class="container-fluid">\n+                <a class="navbar-brand" href="#">\n+                  <img src="https://getbootstrap.com/docs/5.1/assets/brand/bootstrap-logo-white.svg" width="38" height="30" class="d-inline-block align-top" alt="Bootstrap" loading="lazy">\n+                </a>\n+                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent2" aria-controls="navbarSupportedContent2" aria-expanded="false" aria-label="Toggle navigation">\n+                  <span class="navbar-toggler-icon"></span>\n+                </button>\n+                <div class="collapse navbar-collapse" id="navbarSupportedContent2">\n+                  <ul class="navbar-nav me-auto mb-2 mb-lg-0">\n+                    <li class="nav-item">\n+                      <a class="nav-link active" aria-current="page" href="#">Home</a>\n+                    </li>\n+                    <li class="nav-item">\n+                      <a class="nav-link" href="#">Link</a>\n+                    </li>\n+                    <li class="nav-item dropdown">\n+                      <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown2" role="button" data-bs-toggle="dropdown" aria-expanded="false">\n+                        Dropdown\n+                      </a>\n+                      <ul class="dropdown-menu" aria-labelledby="navbarDropdown2">\n+                        <li><a class="dropdown-item" href="#">Action</a></li>\n+                        <li><a class="dropdown-item" href="#">Another action</a></li>\n+                        <li><hr class="dropdown-divider"></li>\n+                        <li><a class="dropdown-item" href="#">Something else here</a></li>\n+                      </ul>\n+                    </li>\n+                    <li class="nav-item">\n+                      <a class="nav-link disabled">Disabled</a>\n+                    </li>\n+                  </ul>\n+                  <form class="d-flex">\n+                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">\n+                    <button class="btn btn-outline-light" type="submit">Search</button>\n+                  </form>\n+                </div>\n+              </div>\n+            </nav>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="pagination">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Pagination</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/pagination/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <nav aria-label="Pagination example">\n+              <ul class="pagination pagination-sm">\n+                <li class="page-item"><a class="page-link" href="#">1</a></li>\n+                <li class="page-item active" aria-current="page">\n+                  <a class="page-link" href="#">2</a>\n+                </li>\n+                <li class="page-item"><a class="page-link" href="#">3</a></li>\n+              </ul>\n+            </nav>\n+            </div>\n+\n+            <div class="bd-example">\n+            <nav aria-label="Standard pagination example">\n+              <ul class="pagination">\n+                <li class="page-item">\n+                  <a class="page-link" href="#" aria-label="Previous">\n+                    <span aria-hidden="true">&laquo;</span>\n+                  </a>\n+                </li>\n+                <li class="page-item"><a class="page-link" href="#">1</a></li>\n+                <li class="page-item"><a class="page-link" href="#">2</a></li>\n+                <li class="page-item"><a class="page-link" href="#">3</a></li>\n+                <li class="page-item">\n+                  <a class="page-link" href="#" aria-label="Next">\n+                    <span aria-hidden="true">&raquo;</span>\n+                  </a>\n+                </li>\n+              </ul>\n+            </nav>\n+            </div>\n+\n+            <div class="bd-example">\n+            <nav aria-label="Another pagination example">\n+              <ul class="pagination pagination-lg flex-wrap">\n+                <li class="page-item disabled">\n+                  <a class="page-link">Previous</a>\n+                </li>\n+                <li class="page-item"><a class="page-link" href="#">1</a></li>\n+                <li class="page-item active" aria-current="page">\n+                  <a class="page-link" href="#">2</a>\n+                </li>\n+                <li class="page-item"><a class="page-link" href="#">3</a></li>\n+                <li class="page-item">\n+                  <a class="page-link" href="#">Next</a>\n+                </li>\n+              </ul>\n+            </nav>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="popovers">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Popovers</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/popovers/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <button type="button" class="btn btn-lg btn-danger" data-bs-toggle="popover" title="Popover title" data-bs-content="And here\'s some amazing content. It\'s very engaging. Right?">Click to toggle popover</button>\n+            </div>\n+\n+            <div class="bd-example">\n+            <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-content="Vivamus sagittis lacus vel augue laoreet rutrum faucibus.">\n+              Popover on top\n+            </button>\n+            <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="right" data-bs-content="Vivamus sagittis lacus vel augue laoreet rutrum faucibus.">\n+              Popover on end\n+            </button>\n+            <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-content="Vivamus sagittis lacus vel augue laoreet rutrum faucibus.">\n+              Popover on bottom\n+            </button>\n+            <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="left" data-bs-content="Vivamus sagittis lacus vel augue laoreet rutrum faucibus.">\n+              Popover on start\n+            </button>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="progress">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Progress</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/progress/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            <div class="progress mb-3">\n+              <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>\n+            </div>\n+            <div class="progress mb-3">\n+              <div class="progress-bar bg-success w-25" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>\n+            </div>\n+            <div class="progress mb-3">\n+              <div class="progress-bar bg-info text-dark w-50" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">50%</div>\n+            </div>\n+            <div class="progress mb-3">\n+              <div class="progress-bar bg-warning text-dark w-75" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">75%</div>\n+            </div>\n+            <div class="progress">\n+              <div class="progress-bar bg-danger w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>\n+            </div>\n+            </div>\n+\n+            <div class="bd-example">\n+            <div class="progress">\n+              <div class="progress-bar" role="progressbar" style="width: 15%" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>\n+              <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 40%" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="scrollspy">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Scrollspy</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/scrollspy/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+              <nav id="navbar-example2" class="navbar navbar-light bg-light px-3">\n+                <a class="navbar-brand" href="#">Navbar</a>\n+                <ul class="nav nav-pills">\n+                  <li class="nav-item">\n+                    <a class="nav-link active" href="#scrollspyHeading1">First</a>\n+                  </li>\n+                  <li class="nav-item">\n+                    <a class="nav-link" href="#scrollspyHeading2">Second</a>\n+                  </li>\n+                  <li class="nav-item dropdown">\n+                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Dropdown</a>\n+                    <ul class="dropdown-menu">\n+                      <li><a class="dropdown-item" href="#scrollspyHeading3">Third</a></li>\n+                      <li><a class="dropdown-item" href="#scrollspyHeading4">Fourth</a></li>\n+                      <li><hr class="dropdown-divider"></li>\n+                      <li><a class="dropdown-item" href="#scrollspyHeading5">Fifth</a></li>\n+                    </ul>\n+                  </li>\n+                </ul>\n+              </nav>\n+            <div data-bs-spy="scroll" data-bs-target="#navbar-example2" data-bs-offset="0" class="scrollspy-example" tabindex="0">\n+                <h4 id="scrollspyHeading1">First heading</h4>\n+                <p>This is some placeholder content for the scrollspy page. Note that as you scroll down the page, the appropriate navigation link is highlighted. It\'s repeated throughout the component example. We keep adding some more example copy here to emphasize the scrolling and highlighting.</p>\n+                <h4 id="scrollspyHeading2">Second heading</h4>\n+                <p>This is some placeholder content for the scrollspy page. Note that as you scroll down the page, the appropriate navigation link is highlighted. It\'s repeated throughout the component example. We keep adding some more example copy here to emphasize the scrolling and highlighting.</p>\n+                <h4 id="scrollspyHeading3">Third heading</h4>\n+                <p>This is some placeholder content for the scrollspy page. Note that as you scroll down the page, the appropriate navigation link is highlighted. It\'s repeated throughout the component example. We keep adding some more example copy here to emphasize the scrolling and highlighting.</p>\n+                <h4 id="scrollspyHeading4">Fourth heading</h4>\n+                <p>This is some placeholder content for the scrollspy page. Note that as you scroll down the page, the appropriate navigation link is highlighted. It\'s repeated throughout the component example. We keep adding some more example copy here to emphasize the scrolling and highlighting.</p>\n+                <h4 id="scrollspyHeading5">Fifth heading</h4>\n+                <p>This is some placeholder content for the scrollspy page. Note that as you scroll down the page, the appropriate navigation link is highlighted. It\'s repeated throughout the component example. We keep adding some more example copy here to emphasize the scrolling and highlighting.</p>\n+              </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="spinners">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Spinners</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/spinners/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example">\n+            \n+            <div class="spinner-border text-primary" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-border text-secondary" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-border text-success" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-border text-danger" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-border text-warning" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-border text-info" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-border text-light" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-border text-dark" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            </div>\n+\n+            <div class="bd-example">\n+            \n+            <div class="spinner-grow text-primary" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-grow text-secondary" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-grow text-success" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-grow text-danger" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-grow text-warning" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-grow text-info" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-grow text-light" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            <div class="spinner-grow text-dark" role="status">\n+              <span class="visually-hidden">Loading...</span>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="my-3" id="toasts">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Toasts</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/toasts/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example bg-dark p-5 align-items-center">\n+            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">\n+              <div class="toast-header">\n+                <svg class="bd-placeholder-img rounded me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" preserveAspectRatio="xMidYMid slice" focusable="false"><rect width="100%" height="100%" fill="#007aff"/></svg>\n+\n+                <strong class="me-auto">Bootstrap</strong>\n+                <small class="text-muted">11 mins ago</small>\n+                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>\n+              </div>\n+              <div class="toast-body">\n+                Hello, world! This is a toast message.\n+              </div>\n+            </div>\n+            </div>\n+          </div>\n+        </article>\n+        <article class="mt-3 mb-5 pb-5" id="tooltips">\n+          <div class="bd-heading sticky-xl-top align-self-start mt-5 mb-3 mt-xl-0 mb-xl-2">\n+            <h3>Tooltips</h3>\n+            <a class="d-flex align-items-center" href="https://getbootstrap.com/docs/5.1/components/tooltips/">Documentation</a>\n+          </div>\n+\n+          <div>\n+            <div class="bd-example tooltip-demo">\n+            <button type="button" class="btn btn-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="Tooltip on top">Tooltip on top</button>\n+            <button type="button" class="btn btn-secondary" data-bs-toggle="tooltip" data-bs-placement="right" title="Tooltip on end">Tooltip on end</button>\n+            <button type="button" class="btn btn-secondary" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Tooltip on bottom">Tooltip on bottom</button>\n+            <button type="button" class="btn btn-secondary" data-bs-toggle="tooltip" data-bs-placement="left" title="Tooltip on start">Tooltip on start</button>\n+            <button type="button" class="btn btn-secondary" data-bs-toggle="tooltip" data-bs-html="true" title="<em>Tooltip</em> <u>with</u> <b>HTML</b>">Tooltip with HTML</button>\n+            </div>\n+          </div>\n+        </article>\n+      </section>\n+    </div>\n+\n+    <div class="modal fade" id="exampleModalDefault" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">\n+      <div class="modal-dialog">\n+        <div class="modal-content">\n+          <div class="modal-header">\n+            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>\n+            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n+          </div>\n+          <div class="modal-body">\n+            ...\n+          </div>\n+          <div class="modal-footer">\n+            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n+            <button type="button" class="btn btn-primary">Save changes</button>\n+          </div>\n+        </div>\n+      </div>\n+    </div>\n+    <div class="modal fade" id="staticBackdropLive" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLiveLabel" aria-hidden="true">\n+      <div class="modal-dialog">\n+        <div class="modal-content">\n+          <div class="modal-header">\n+            <h5 class="modal-title" id="staticBackdropLiveLabel">Modal title</h5>\n+            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n+          </div>\n+          <div class="modal-body">\n+            <p>I will not close if you click outside me. Don\'t even try to press escape key.</p>\n+          </div>\n+          <div class="modal-footer">\n+            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n+            <button type="button" class="btn btn-primary">Understood</button>\n+          </div>\n+        </div>\n+      </div>\n+    </div>\n+    <div class="modal fade" id="exampleModalCenteredScrollable" tabindex="-1" aria-labelledby="exampleModalCenteredScrollableTitle" aria-hidden="true">\n+      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">\n+        <div class="modal-content">\n+          <div class="modal-header">\n+            <h5 class="modal-title" id="exampleModalCenteredScrollableTitle">Modal title</h5>\n+            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n+          </div>\n+          <div class="modal-body">\n+            <p>This is some placeholder content to show the scrolling behavior for modals. We use repeated line breaks to demonstrate how content can exceed minimum inner height, thereby showing inner scrolling. When content becomes longer than the predefined max-height of modal, content will be cropped and scrollable within the modal.</p>\n+            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>\n+            <p>This content should appear at the bottom after you scroll.</p>\n+          </div>\n+          <div class="modal-footer">\n+            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n+            <button type="button" class="btn btn-primary">Save changes</button>\n+          </div>\n+        </div>\n+      </div>\n+    </div>\n+    <div class="modal fade" id="exampleModalFullscreen" tabindex="-1" aria-labelledby="exampleModalFullscreenLabel" aria-hidden="true">\n+      <div class="modal-dialog modal-fullscreen">\n+        <div class="modal-content">\n+          <div class="modal-header">\n+            <h5 class="modal-title h4" id="exampleModalFullscreenLabel">Full screen modal</h5>\n+            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n+          </div>\n+          <div class="modal-body">\n+            ...\n+          </div>\n+          <div class="modal-footer">\n+            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n+          </div>\n+        </div>\n+      </div>\n+    </div>\n+\n+    <!-- End Bootstrap Cheatsheet -->\n+\n+  </metal:main>\n+\n+</body>\n+\n+</html>\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/browser/templates/test_rendering_icons.pt b/Products/CMFPlone/browser/templates/test_rendering_icons.pt\nnew file mode 100644\nindex 0000000000..24fe5c5c6a\n--- /dev/null\n+++ b/Products/CMFPlone/browser/templates/test_rendering_icons.pt\n@@ -0,0 +1,91 @@\n+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:tal="http://xml.zope.org/namespaces/tal"\n+  xmlns:metal="http://xml.zope.org/namespaces/metal" xmlns:i18n="http://xml.zope.org/namespaces/i18n" lang="en"\n+  metal:use-macro="context/@@main_template/macros/master" i18n:domain="plone">\n+\n+<body>\n+\n+  <metal:main fill-slot="main">\n+\n+    <style>\n+\n+    </style>\n+\n+    <ul class="nav nav-tabs mb-3">\n+      <li class="nav-item">\n+        <a class="nav-link" href="${portal_url}/@@test-rendering">Test Rendering</a>\n+      </li>\n+      <li class="nav-item">\n+        <a class="nav-link" href="${portal_url}/@@test-rendering-cheatsheet">Bootstrap Cheatsheet</a>\n+      </li>\n+      <li class="nav-item">\n+        <a class="nav-link active" href="${portal_url}/@@test-rendering-icons">Icons</a>\n+      </li>\n+    </ul>\n+\n+    <h1>Plone Icons test page</h1>\n+\n+    <p class="lead">\n+      This page shows the Icon story of Plone 6. We use <a href="https://icons.getbootstrap.com/" target="_blank">Bootstrap Icons</a> by default.\n+    </p>\n+\n+    <h1>Icons</h1>\n+\n+    <p>\n+      Description to explain icon resolver\n+    </p>\n+\n+    <h2>Get Icon URL</h2>\n+\n+    <p>\n+      <code>&lt;img src="" tal:attributes="src python:icons.url(\'alarm\')" class="custom-class" alt="foo" /&gt;</code>\n+    </p>\n+\n+    <p>\n+      <img src="${python:icons.url(\'alarm\')}" class="custom-class" alt="foo" />\n+    </p>\n+\n+    <h2>Get Icon Tag</h2>\n+\n+    <p>\n+      <code>&lt;tal:icon tal:replace="structure python:icons.tag(\'archive\', tag_class=\'custom-class\', tag_alt=\'foobar\')" /&gt;</code>\n+    </p>\n+\n+    <p>\n+      <tal:icon tal:replace="structure python:icons.tag(\'archive\', tag_class=\'custom-class\', tag_alt=\'foobar\')" />\n+    </p>\n+\n+    <h2>Registration</h2>\n+\n+    <p>\n+      Todo: List custom Icons\n+    </p>\n+\n+    <ul>\n+      <li>\n+        <a href="https://github.com/plone/plone.staticresources/blob/master/src/plone/staticresources/profiles/default/registry/icons_bootstrap.xml" target="_blank">Bootstrap</a>\n+      </li>\n+      <li>\n+        <a href="https://github.com/plone/plone.staticresources/blob/master/src/plone/staticresources/profiles/default/registry/icons_contenttype.xml" target="_blank">Content Types</a>\n+      </li>\n+      <li>\n+        <a href="https://github.com/plone/plone.staticresources/blob/master/src/plone/staticresources/profiles/default/registry/icons_country_flags.xml" target="_blank">Country Flags</a>\n+      </li>\n+      <li>\n+        <a href="https://github.com/plone/plone.staticresources/blob/master/src/plone/staticresources/profiles/default/registry/icons_language_flags.xml" target="_blank">Language Flags</a>\n+      </li>\n+      <li>\n+        <a href="https://github.com/plone/plone.staticresources/blob/master/src/plone/staticresources/profiles/default/registry/icons_mimetype.xml" target="_blank">MIME Types</a>\n+      </li>\n+      <li>\n+        <a href="https://github.com/plone/plone.staticresources/blob/master/src/plone/staticresources/profiles/default/registry/icons_plone.xml" target="_blank">Plone</a>\n+      </li>\n+      <li>\n+        <a href="https://github.com/plone/plone.staticresources/blob/master/src/plone/staticresources/profiles/default/registry/icons_toolbar.xml" target="_blank">Toolbar</a>\n+      </li>\n+    </ul>\n+\n+  </metal:main>\n+\n+</body>\n+\n+</html>\ndiff --git a/Products/CMFPlone/browser/templates/title.pt b/Products/CMFPlone/browser/templates/title.pt\nindex 8c6e94193f..ef9745baa3 100644\n--- a/Products/CMFPlone/browser/templates/title.pt\n+++ b/Products/CMFPlone/browser/templates/title.pt\n@@ -1,4 +1,3 @@\n-<h1 class="documentFirstHeading"\n-  tal:define="title context/Title"\n-  tal:condition="title"\n-  tal:content="title">Title or id</h1>\n+<h1 tal:define="title context/Title" tal:condition="title" tal:content="title">\n+  Title or id\n+</h1>\ndiff --git a/Products/CMFPlone/browser/test_rendering.py b/Products/CMFPlone/browser/test_rendering.py\nnew file mode 100644\nindex 0000000000..b3c567068d\n--- /dev/null\n+++ b/Products/CMFPlone/browser/test_rendering.py\n@@ -0,0 +1,33 @@\n+# -*- coding: utf-8 -*-\n+from Products.Five import BrowserView\n+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n+\n+\n+class TestRenderingView(BrowserView):\n+\n+    template = ViewPageTemplateFile(\'templates/test_rendering.pt\')\n+\n+    def __call__(self):\n+        self.request.set(\'disable_plone.rightcolumn\', 1)\n+        self.request.set(\'disable_plone.leftcolumn\', 1)\n+        return self.template()\n+\n+\n+class TestRenderingCheatsheetView(BrowserView):\n+\n+    template = ViewPageTemplateFile(\'templates/test_rendering_cheatsheet.pt\')\n+\n+    def __call__(self):\n+        self.request.set(\'disable_plone.rightcolumn\', 1)\n+        self.request.set(\'disable_plone.leftcolumn\', 1)\n+        return self.template()\n+\n+\n+class TestRenderingIconsView(BrowserView):\n+\n+    template = ViewPageTemplateFile(\'templates/test_rendering_icons.pt\')\n+\n+    def __call__(self):\n+        self.request.set(\'disable_plone.rightcolumn\', 1)\n+        self.request.set(\'disable_plone.leftcolumn\', 1)\n+        return self.template()\ndiff --git a/Products/CMFPlone/catalog.zcml b/Products/CMFPlone/catalog.zcml\nindex 97d2852553..e84d7fed42 100644\n--- a/Products/CMFPlone/catalog.zcml\n+++ b/Products/CMFPlone/catalog.zcml\n@@ -3,7 +3,7 @@\n     <!-- Register the default indexable object wrapper -->\n     <adapter\n         for="Products.CMFCore.interfaces.ICatalogAware\n-             Products.CMFPlone.interfaces.IPloneCatalogTool"\n+             plone.base.interfaces.IPloneCatalogTool"\n         factory="plone.indexer.wrapper.IndexableObjectWrapper"\n         provides="plone.indexer.interfaces.IIndexableObject"\n         />\n@@ -17,7 +17,6 @@\n     <adapter factory=".CatalogTool.is_folderish"           name="is_folderish" />\n     <adapter factory=".CatalogTool.is_default_page"        name="is_default_page" />\n     <adapter factory=".CatalogTool.getIcon"                name="getIcon" />\n-    <adapter factory=".CatalogTool.location"               name="location" />\n     <adapter factory=".CatalogTool.mime_type"              name="mime_type" />\n \n </configure>\ndiff --git a/Products/CMFPlone/configure.zcml b/Products/CMFPlone/configure.zcml\nindex d2cdac1e8c..0433f5a7e7 100644\n--- a/Products/CMFPlone/configure.zcml\n+++ b/Products/CMFPlone/configure.zcml\n@@ -5,55 +5,70 @@\n            xmlns:i18n="http://namespaces.zope.org/i18n"\n            i18n_domain="plone">\n \n+  <!-- basic zope/cmf -->\n   <include package="zope.app.locales" />\n   <include package="Products.CMFCore" />\n   <include package="Products.GenericSetup" />\n-  <include package="plone.app.contentmenu" />\n+\n+  <!-- Our controlpanel config defines several permissions, so load it early. -->\n+  <include package=".controlpanel" />\n+\n+  <!-- plone.* -->\n+  <include package="plone.batching" />\n+  <include package="plone.browserlayer" />\n+  <include package="plone.contentrules" />\n+  <include package="plone.dexterity" />\n+  <include package="plone.folder" />\n+  <include package="plone.i18n" />\n+  <include package="plone.indexer" />\n+  <include package="plone.locking" />\n+  <include package="plone.memoize" />\n+  <include package="plone.outputfilters" />\n+  <include package="plone.portlets" />\n+  <include package="plone.protect" />\n+  <include package="plone.registry" />\n+  <include package="plone.resource" />\n+  <include package="plone.schema" />\n+  <include package="plone.session" />\n+  <include package="plone.staticresources" />\n+  <include package="plone.subrequest" />\n+  <include package="plone.theme" />\n+\n+  <!-- plone.app.* -->\n   <include package="plone.app.content" />\n+  <include package="plone.app.contentlisting" />\n+  <include package="plone.app.contentmenu" />\n   <include package="plone.app.contentrules" />\n   <include package="plone.app.contenttypes" />\n   <include package="plone.app.customerize" />\n+  <include package="plone.app.dexterity" />\n   <include package="plone.app.discussion" />\n   <include package="plone.app.i18n" />\n   <include package="plone.app.layout" />\n   <include package="plone.app.linkintegrity" />\n   <include package="plone.app.locales" />\n+  <include package="plone.app.multilingual" />\n   <include package="plone.app.portlets" />\n   <include package="plone.app.redirector" />\n   <include package="plone.app.registry" />\n   <include package="plone.app.theming" />\n-  <include zcml:condition="installed plone.app.upgrade" package="plone.app.upgrade" />\n   <include package="plone.app.users" />\n   <include package="plone.app.uuid" />\n   <include package="plone.app.viewletmanager" />\n   <include package="plone.app.vocabularies" />\n   <include package="plone.app.workflow" />\n-  <include package="plone.batching" />\n-  <include package="plone.memoize" />\n-  <include package="plone.outputfilters" />\n-  <include package="plone.session" />\n-  <include package="plone.protect" />\n-  <include package="plone.indexer" />\n \n-  <!-- mockup -->\n-  <include package="mockup" />\n-  <include package="plone.staticresources" />\n-\n-  <!-- viewlets zope 3 layers support for themes -->\n-  <include package="plone.browserlayer" />\n-  <include package="plone.theme" />\n+  <!-- plone extra -->\n+  <include package="plone.portlet.static" />\n+  <include package="plone.portlet.collection" />\n+  <include package="plonetheme.barceloneta" />\n \n-  <!-- multilingual -->\n-  <include package="plone.app.multilingual" />\n+  <!-- conditional -->\n+  <include zcml:condition="installed plone.app.upgrade" package="plone.app.upgrade" />\n \n-  <include package=".controlpanel" />\n   <include package=".resources" />\n   <include package=".patterns" />\n \n-  <!-- extra portlets -->\n-  <include package="plone.portlet.static" />\n-  <include package="plone.portlet.collection" />\n-\n   <!-- local role PAS plugin -->\n   <include package="borg.localrole" />\n   <include package="borg.localrole"\n@@ -62,10 +77,12 @@\n   <include package=".browser" />\n   <include package=".exportimport" />\n \n-  <include file="deprecated.zcml"/>\n   <include file="profiles.zcml"/>\n   <include file="catalog.zcml" />\n \n+  <!-- images scales poc -->\n+  <include package=".image_scales" />\n+\n   <cmf:registerDirectory\n       name="skins"\n       directory="skins"\n@@ -73,11 +90,11 @@\n       />\n \n   <class class="Products.PluggableAuthService.PluggableAuthService.PluggableAuthService">\n-    <implements interface=".interfaces.IHideFromBreadcrumbs" />\n+    <implements interface="plone.base.interfaces.IHideFromBreadcrumbs" />\n   </class>\n \n   <class class="Products.PluggableAuthService.plugins.BasePlugin.BasePlugin">\n-    <implements interface=".interfaces.IHideFromBreadcrumbs" />\n+    <implements interface="plone.base.interfaces.IHideFromBreadcrumbs" />\n   </class>\n \n   <utility factory=".factory.NonInstallable"\n@@ -97,10 +114,10 @@\n       trusted="y"\n       />\n \n-  <!-- include plone plugins with z3c.autoinclude -->\n-  <includePlugins\n+  <!-- include plone plugins with plone.autoinclude -->\n+  <autoIncludePlugins\n       zcml:condition="not-have disable-autoinclude"\n-      package="plone"\n+      target="plone"\n       file="configure.zcml"\n       />\n \ndiff --git a/Products/CMFPlone/controlpanel/README.rst b/Products/CMFPlone/controlpanel/README.rst\nindex 428d89614e..cf40792daf 100644\n--- a/Products/CMFPlone/controlpanel/README.rst\n+++ b/Products/CMFPlone/controlpanel/README.rst\n@@ -14,7 +14,7 @@ As an example, let\'s look for search related settings (defined by ISearchSchema)\n We use the schema \'ISearchSchema\' to lookup a RecordProxy object with\n all fields::\n \n-  >>> from Products.CMFPlone.interfaces import ISearchSchema\n+  >>> from plone.base.interfaces import ISearchSchema\n   >>> search_settings = registry.forInterface(ISearchSchema, prefix=\'plone\')\n \n Now we can get and set all fields of the schema above. For example the value for\n@@ -38,7 +38,7 @@ For more information about how to access and manipulate Plone registry entries,\n Editing Control Panel\n ---------------------\n \n-  >>> from Products.CMFPlone.interfaces import IEditingSchema\n+  >>> from plone.base.interfaces import IEditingSchema\n   >>> editing_settings = registry.forInterface(IEditingSchema, prefix=\'plone\')\n \n   >>> editing_settings.default_editor == u\'TinyMCE\'\n@@ -103,7 +103,7 @@ Language Control Panel\n Maintenance Control Panel\n -------------------------\n \n-  >>> from Products.CMFPlone.interfaces import IMaintenanceSchema\n+  >>> from plone.base.interfaces import IMaintenanceSchema\n   >>> maintenance_settings = registry.forInterface(IMaintenanceSchema, prefix=\'plone\')\n \n   >>> maintenance_settings.days\n@@ -113,7 +113,7 @@ Maintenance Control Panel\n Navigation Control Panel\n ------------------------\n \n-  >>> from Products.CMFPlone.interfaces import INavigationSchema\n+  >>> from plone.base.interfaces import INavigationSchema\n   >>> navigation_settings = registry.forInterface(INavigationSchema, prefix=\'plone\')\n \n   >>> navigation_settings.generate_tabs\n@@ -123,7 +123,7 @@ Navigation Control Panel\n   True\n \n   >>> navigation_settings.displayed_types\n-  (\'Image\', \'File\', \'Link\', \'News Item\', \'Folder\', \'Document\', \'Event\')\n+  (\'Link\', \'News Item\', \'Folder\', \'Document\', \'Event\', \'Collection\')\n \n   >>> navigation_settings.filter_on_workflow\n   False\n@@ -132,13 +132,13 @@ Navigation Control Panel\n   ()\n \n   >>> navigation_settings.show_excluded_items\n-  True\n+  False\n \n \n Search Control Panel\n --------------------\n \n-  >>> from Products.CMFPlone.interfaces import ISearchSchema\n+  >>> from plone.base.interfaces import ISearchSchema\n   >>> search_settings = registry.forInterface(ISearchSchema, prefix=\'plone\')\n \n   >>> search_settings.enable_livesearch\n@@ -151,7 +151,7 @@ Search Control Panel\n Site Control Panel\n ------------------\n \n-  >>> from Products.CMFPlone.interfaces import ISiteSchema\n+  >>> from plone.base.interfaces import ISiteSchema\n   >>> site_settings = registry.forInterface(ISiteSchema, prefix=\'plone\')\n \n   >>> site_settings.site_title == u\'Plone site\'\n@@ -170,7 +170,7 @@ Site Control Panel\n Overview Control Panel\n ----------------------\n \n-  >>> from Products.CMFPlone.interfaces.controlpanel import IDateAndTimeSchema\n+  >>> from plone.base.interfaces.controlpanel import IDateAndTimeSchema\n   >>> tz_settings = registry.forInterface(IDateAndTimeSchema, prefix=\'plone\')\n \n   >>> tz_settings.portal_timezone = \'UTC\'\n@@ -179,7 +179,7 @@ Overview Control Panel\n Markup Control Panel\n --------------------\n \n-  >>> from Products.CMFPlone.interfaces import IMarkupSchema\n+  >>> from plone.base.interfaces import IMarkupSchema\n   >>> markup_settings = registry.forInterface(IMarkupSchema, prefix=\'plone\')\n \n   >>> markup_settings.default_type == u\'text/html\'\n@@ -193,7 +193,7 @@ Markup Control Panel\n User and Groups Control Panel\n ------------------------------\n \n-  >>> from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema\n+  >>> from plone.base.interfaces import IUserGroupsSettingsSchema\n   >>> usergroups_settings = registry.forInterface(IUserGroupsSettingsSchema, prefix=\'plone\')\n \n   >>> usergroups_settings.many_groups\ndiff --git a/Products/CMFPlone/controlpanel/bbb/editing.py b/Products/CMFPlone/controlpanel/bbb/editing.py\nindex 54058116a6..41649f4eff 100644\n--- a/Products/CMFPlone/controlpanel/bbb/editing.py\n+++ b/Products/CMFPlone/controlpanel/bbb/editing.py\n@@ -2,9 +2,9 @@\n from zope.interface import implementer\n from zope.component import getUtility\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import IPloneSiteRoot\n \n-from Products.CMFPlone.interfaces import IEditingSchema\n+from plone.base.interfaces import IEditingSchema\n \n \n @implementer(IEditingSchema)\ndiff --git a/Products/CMFPlone/controlpanel/bbb/filter.py b/Products/CMFPlone/controlpanel/bbb/filter.py\nindex f0d6fc7777..2da1d3dcb5 100644\n--- a/Products/CMFPlone/controlpanel/bbb/filter.py\n+++ b/Products/CMFPlone/controlpanel/bbb/filter.py\n@@ -1,5 +1,5 @@\n-from Products.CMFPlone.interfaces import IFilterSchema\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import IFilterSchema\n+from plone.base.interfaces import IPloneSiteRoot\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/bbb/language.py b/Products/CMFPlone/controlpanel/bbb/language.py\nindex 43700a1cd9..1094d8b49c 100644\n--- a/Products/CMFPlone/controlpanel/bbb/language.py\n+++ b/Products/CMFPlone/controlpanel/bbb/language.py\n@@ -2,7 +2,7 @@\n from zope.interface import implementer\n from zope.component import getUtility\n from plone.i18n.interfaces import ILanguageSchema\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import IPloneSiteRoot\n \n from plone.registry.interfaces import IRegistry\n \ndiff --git a/Products/CMFPlone/controlpanel/bbb/mail.py b/Products/CMFPlone/controlpanel/bbb/mail.py\nindex 9fb79f65ba..5ec1135f69 100644\n--- a/Products/CMFPlone/controlpanel/bbb/mail.py\n+++ b/Products/CMFPlone/controlpanel/bbb/mail.py\n@@ -1,5 +1,5 @@\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+from plone.base.interfaces import IPloneSiteRoot\n+from plone.base.interfaces.controlpanel import IMailSchema\n from Products.CMFPlone.utils import safe_hasattr\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\ndiff --git a/Products/CMFPlone/controlpanel/bbb/maintenance.py b/Products/CMFPlone/controlpanel/bbb/maintenance.py\nindex 491f6c5d9a..941fea458b 100644\n--- a/Products/CMFPlone/controlpanel/bbb/maintenance.py\n+++ b/Products/CMFPlone/controlpanel/bbb/maintenance.py\n@@ -1,5 +1,5 @@\n-from Products.CMFPlone.interfaces import IMaintenanceSchema\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import IMaintenanceSchema\n+from plone.base.interfaces import IPloneSiteRoot\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/bbb/markup.py b/Products/CMFPlone/controlpanel/bbb/markup.py\nindex 23b4279955..2434f6b84b 100644\n--- a/Products/CMFPlone/controlpanel/bbb/markup.py\n+++ b/Products/CMFPlone/controlpanel/bbb/markup.py\n@@ -1,5 +1,5 @@\n-from Products.CMFPlone.interfaces import IMarkupSchema\n-from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot\n+from plone.base.interfaces import IMarkupSchema\n+from plone.base.interfaces.siteroot import IPloneSiteRoot\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/bbb/navigation.py b/Products/CMFPlone/controlpanel/bbb/navigation.py\nindex 0cd58b5234..85bf7108b5 100644\n--- a/Products/CMFPlone/controlpanel/bbb/navigation.py\n+++ b/Products/CMFPlone/controlpanel/bbb/navigation.py\n@@ -1,6 +1,6 @@\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import INavigationSchema\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import INavigationSchema\n+from plone.base.interfaces import IPloneSiteRoot\n from zope.component import adapter\n from zope.component import getUtility\n from zope.interface import implementer\ndiff --git a/Products/CMFPlone/controlpanel/bbb/search.py b/Products/CMFPlone/controlpanel/bbb/search.py\nindex c5633ed877..6d0ec1f510 100644\n--- a/Products/CMFPlone/controlpanel/bbb/search.py\n+++ b/Products/CMFPlone/controlpanel/bbb/search.py\n@@ -1,5 +1,5 @@\n-from Products.CMFPlone.interfaces import ISearchSchema\n-from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot\n+from plone.base.interfaces import ISearchSchema\n+from plone.base.interfaces.siteroot import IPloneSiteRoot\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/bbb/security.py b/Products/CMFPlone/controlpanel/bbb/security.py\nindex 977b43f81f..5870b25910 100644\n--- a/Products/CMFPlone/controlpanel/bbb/security.py\n+++ b/Products/CMFPlone/controlpanel/bbb/security.py\n@@ -1,6 +1,6 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces.siteroot import IPloneSiteRoot\n+from plone.base.interfaces import ISecuritySchema\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/bbb/site.py b/Products/CMFPlone/controlpanel/bbb/site.py\nindex 486c2e10c3..9098791b27 100644\n--- a/Products/CMFPlone/controlpanel/bbb/site.py\n+++ b/Products/CMFPlone/controlpanel/bbb/site.py\n@@ -1,6 +1,6 @@\n from zope.schema.fieldproperty import FieldProperty\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import ISiteSchema\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/bbb/usergroups.py b/Products/CMFPlone/controlpanel/bbb/usergroups.py\nindex 7df8393eff..ce88769f52 100644\n--- a/Products/CMFPlone/controlpanel/bbb/usergroups.py\n+++ b/Products/CMFPlone/controlpanel/bbb/usergroups.py\n@@ -3,8 +3,8 @@\n from zope.interface import implementer\n from zope.component.hooks import getSite\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import IUserGroupsSettingsSchema\n+from plone.base.interfaces import IPloneSiteRoot\n \n \n @implementer(IUserGroupsSettingsSchema)\ndiff --git a/Products/CMFPlone/controlpanel/browser/actions.pt b/Products/CMFPlone/controlpanel/browser/actions.pt\nindex 03535ffa6e..ed8c89431a 100644\n--- a/Products/CMFPlone/controlpanel/browser/actions.pt\n+++ b/Products/CMFPlone/controlpanel/browser/actions.pt\n@@ -9,54 +9,63 @@\n \n \n <metal:main metal:fill-slot="prefs_configlet_main" i18n:domain="plone">\n+  <header>\n \n     <h1 class="documentFirstHeading"\n-        i18n:translate="portal_actions_controlpanel_header">Portal actions</h1>\n+      i18n:translate="portal_actions_controlpanel_header">Portal actions</h1>\n \n-    <div class="documentDescription"\n-       i18n:translate="portal_actions_controlpanel_description">\n-      This is the portal actions configuration section, you can manage the\n-      actions contained in the different action categories.\n-    </div>\n-\n-    <div id="content-core">\n-        <p class="addAction">\n-            <a href="@@new-action"\n-                class="context pat-plone-modal pull-right"\n-                i18n:translate="">Add new action</a>\n-        </p>\n-        <section tal:repeat="category view/actions" class="portlet">\n-            <header tal:content="category/title" class="portletHeader" />\n-            <section class="portletContent">\n-                <ol class="configlets">\n-                    <li tal:repeat="action category/actions">\n-                        <span tal:content="action/title" i18n:translate="" />\n-                        <form action="@@actions-controlpanel" class="pull-right"\n-                            method="POST">\n-                            <input type="hidden" name="actionid"\n-                                tal:attributes="value action/id" />\n-                            <input tal:condition="action/visible"\n-                                type="submit" class="standalone" name="hide"\n-                                value="Hide" i18n:attributes="value" />\n-                            <input tal:condition="not:action/visible"\n-                                type="submit" class="standalone" name="show"\n-                                value="Show" i18n:attributes="value" />\n-                            <input type="hidden" name="category"\n-                                tal:attributes="value category/id" />\n-                            <a class="pat-plone-modal standalone"\n-                            tal:attributes="href string:${action/url}/@@action-form"\n-                            i18n:translate="">Edit</a>\n-                            <input type="submit" class="destructive" name="delete"\n-                                value="Delete"\n-                                confirm-message="Delete the action?"\n-                                i18n:attributes="value; confirm-message"\n-                                onclick="return confirm(this.getAttribute(\'confirm-message\'));"/>\n-                        </form>\n-                    </li>\n-                </ol>\n-            </section>\n-        </section>\n+    <div class="text-muted"\n+      i18n:translate="portal_actions_controlpanel_description">\n+        This is the portal actions configuration section, you can manage the\n+        actions contained in the different action categories.\n     </div>\n+  </header>\n+  <div id="content-core">\n+    <p class="addAction">\n+      <a href="@@new-action"\n+        class="context pat-plone-modal btn btn-success"\n+        i18n:translate="">Add new action</a>\n+    </p>\n+    <section class="category" tal:repeat="category view/actions" class="card mb-4">\n+      <header tal:content="category/title" class="card-header" />\n+      <section>\n+        <ol class="configlets list-group list-group-flush">\n+          <li tal:repeat="action category/actions"\n+              class="list-group-item bg-transparent d-flex align-items-center justify-content-between">\n+            <span><span tal:replace="repeat/action/number" />. <span tal:replace="action/title" i18n:translate="" /></span>\n+            <form action="@@actions-controlpanel"\n+                  class="plone-action-${action/id}"\n+                  method="POST">\n+              <input type="hidden" name="actionid"\n+                tal:attributes="value action/id" />\n+              <input type="hidden" name="category"\n+                tal:attributes="value category/id" />\n+              <button tal:condition="not:action/visible"\n+                type="submit" class="btn btn-sm btn-link standalone me-5" name="show"\n+                value="Show" i18n:attributes="value" >\n+                <tal:icon tal:replace="structure python:icons.tag(\'square\', tag_alt=\'Toggle to show\')" /><span class="ms-2" i18n:translate="">visible</span>\n+              </button>\n+              <button tal:condition="action/visible"\n+                type="submit" class="btn  btn-sm btn-link standalone me-5" name="hide"\n+                value="Hide" i18n:attributes="value" >\n+                <tal:icon tal:replace="structure python:icons.tag(\'check-square\', tag_alt=\'Toggle to hide\')" /><span class="ms-2" i18n:translate="">visible</span>\n+              </button>\n+              <a class="pat-plone-modal btn btn-sm btn-primary standalone"\n+                tal:attributes="href string:${action/url}/@@action-form"\n+                ><tal:icon tal:replace="structure python:icons.tag(\'plone-edit\', tag_alt=\'Edit\')" /><span class="ms-2" i18n:translate="">Edit</span></a>\n+              <button type="submit" class="btn btn-sm btn-danger destructive" name="delete"\n+                value="Delete"\n+                confirm-message="Delete the action?"\n+                i18n:attributes="value; confirm-message"\n+                onclick="return confirm(this.getAttribute(\'confirm-message\'));" >\n+                <tal:icon tal:replace="structure python:icons.tag(\'plone-delete\', tag_alt=\'Delete\')" /><span class="ms-2" i18n:translate="">Delete</span>\n+              </button>\n+            </form>\n+          </li>\n+        </ol>\n+      </section>\n+    </section>\n+  </div>\n </metal:main>\n </body>\n-</html>\n\\ No newline at end of file\n+</html>\ndiff --git a/Products/CMFPlone/controlpanel/browser/actions.py b/Products/CMFPlone/controlpanel/browser/actions.py\nindex 35a64900ce..2037fd95cb 100644\n--- a/Products/CMFPlone/controlpanel/browser/actions.py\n+++ b/Products/CMFPlone/controlpanel/browser/actions.py\n@@ -3,7 +3,7 @@\n from Products.CMFCore.interfaces import IAction, IActionCategory\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import IActionSchema, INewActionSchema\n+from plone.base.interfaces import IActionSchema, INewActionSchema\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import form\ndiff --git a/Products/CMFPlone/controlpanel/browser/configure.zcml b/Products/CMFPlone/controlpanel/browser/configure.zcml\nindex a874d41c1c..671c66f1ed 100644\n--- a/Products/CMFPlone/controlpanel/browser/configure.zcml\n+++ b/Products/CMFPlone/controlpanel/browser/configure.zcml\n@@ -14,10 +14,18 @@\n     <role name="Site Administrator"/>\n   </permission>\n \n+  <!-- Control Panel Main Template -->\n+  <browser:page\n+      name="prefs_main_template"\n+      for="*"\n+      class=".prefsmaintemplate.PrefsMainTemplate"\n+      permission="plone.app.controlpanel.Overview"\n+      />\n+\n   <!-- Control Panel Overview -->\n   <browser:page\n       name="overview-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".overview.OverviewControlPanel"\n       permission="plone.app.controlpanel.Overview"\n       />\n@@ -25,7 +33,7 @@\n   <!-- Editing Control Panel -->\n   <browser:page\n       name="editing-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".editing.EditingControlPanel"\n       permission="plone.app.controlpanel.Editing"\n       />\n@@ -33,7 +41,7 @@\n   <!-- Filter Control Panel -->\n   <browser:page\n       name="filter-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".filter.FilterControlPanelView"\n       permission="plone.app.controlpanel.Filtering"\n       />\n@@ -41,7 +49,7 @@\n   <!-- TinyMCE Control Panel -->\n   <browser:page\n       name="tinymce-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".tinymce.TinyMCEControlPanel"\n       permission="plone.app.controlpanel.TinyMCE"\n       />\n@@ -49,7 +57,7 @@\n   <!-- Language Control Panel -->\n   <browser:page\n       name="language-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".language.LanguageControlPanel"\n       permission="plone.app.controlpanel.Language"\n       />\n@@ -57,7 +65,7 @@\n   <!-- Maintenance Control Panel -->\n   <browser:page\n       name="maintenance-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".maintenance.MaintenanceControlPanel"\n       permission="cmf.ManagePortal"\n       />\n@@ -65,7 +73,7 @@\n   <!-- Mail Control Panel -->\n   <browser:page\n       name="mail-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".mail.MailControlPanel"\n       permission="plone.app.controlpanel.Mail"\n       />\n@@ -73,7 +81,7 @@\n   <!-- Navigation Control Panel -->\n   <browser:page\n       name="navigation-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".navigation.NavigationControlPanel"\n       permission="plone.app.controlpanel.Navigation"\n       />\n@@ -81,7 +89,7 @@\n   <!-- Search Control Panel -->\n   <browser:page\n       name="search-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".search.SearchControlPanel"\n       permission="plone.app.controlpanel.Search"\n       />\n@@ -89,7 +97,7 @@\n   <!-- Security Control Panel -->\n   <browser:page\n       name="security-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".security.SecurityControlPanel"\n       permission="plone.app.controlpanel.Security"\n       />\n@@ -97,16 +105,45 @@\n   <!-- Security Control Panel - EMail Login -->\n   <browser:page\n       name="migrate-to-emaillogin"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".security.EmailLogin"\n       template="emaillogin.pt"\n       permission="cmf.ManagePortal"\n       />\n \n+  <!-- Error Log Form Control Panel -->\n+  <browser:page\n+      name="error-log-form"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n+      template="error_log_form.pt"\n+      permission="cmf.ManagePortal"\n+      />\n+\n+  <browser:page\n+      name="error-log-show-entry"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n+      template="error_log_show_entry.pt"\n+      permission="cmf.ManagePortal"\n+      />\n+\n+  <browser:page\n+      name="error-log-update"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n+      class=".error_log_form.ErrorLogUpdate"\n+      permission="cmf.ManagePortal"\n+      />\n+\n+  <browser:page\n+      name="error-log-set-properties"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n+      class=".error_log_form.ErrorLogSetProperties"\n+      permission="cmf.ManagePortal"\n+      />\n+\n   <!-- Site Control Panel -->\n   <browser:page\n       name="site-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".site.SiteControlPanel"\n       permission="plone.app.controlpanel.Site"\n       />\n@@ -114,7 +151,7 @@\n   <!-- Date and Time Control panel -->\n   <browser:page\n       name="dateandtime-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".dateandtime.DateAndTimeControlPanel"\n       permission="plone.app.controlpanel.Site"\n       />\n@@ -122,7 +159,7 @@\n   <!-- Types Control panel -->\n   <browser:page\n       name="content-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".types.TypesControlPanel"\n       permission="plone.app.controlpanel.Types"\n       />\n@@ -130,7 +167,7 @@\n   <!-- Resource Registry -->\n   <browser:page\n       name="resourceregistry-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".resourceregistry.ResourceRegistryControlPanelView"\n       permission="plone.app.controlpanel.Site"\n       template="resourceregistry.pt"\n@@ -139,7 +176,7 @@\n   <!-- Markup Control Panel -->\n   <browser:page\n       name="markup-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".markup.MarkupControlPanel"\n       permission="plone.app.controlpanel.Markup"\n       />\n@@ -147,13 +184,13 @@\n   <!-- Syndication Control Panel -->\n   <browser:page\n       name="syndication-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".syndication.SyndicationControlPanel"\n       permission="cmf.ManagePortal"\n       />\n   <browser:page\n       name="syndication-settings"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".syndication.SyndicationControlPanel"\n       permission="cmf.ManagePortal"\n       />\n@@ -161,14 +198,14 @@\n   <!-- Usergroup Control Panel -->\n   <browser:page\n       name="usergroup-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".usergroups.UserGroupsSettingsPanelView"\n       permission="plone.app.controlpanel.UsersAndGroups"\n       />\n \n   <browser:page\n       name="usergroup-userprefs"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".usergroups_usersoverview.UsersOverviewControlPanel"\n       permission="plone.app.controlpanel.UsersAndGroups"\n       template="usergroups_usersoverview.pt"\n@@ -176,7 +213,7 @@\n \n   <browser:page\n       name="usergroup-groupprefs"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".usergroups_groupsoverview.GroupsOverviewControlPanel"\n       permission="plone.app.controlpanel.UsersAndGroups"\n       template="usergroups_groupsoverview.pt"\n@@ -184,7 +221,7 @@\n \n   <browser:page\n       name="usergroup-groupmembership"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".usergroups_groupmembership.GroupMembershipControlPanel"\n       permission="plone.app.controlpanel.UsersAndGroups"\n       template="usergroups_groupmembership.pt"\n@@ -192,7 +229,7 @@\n \n   <browser:page\n       name="usergroup-usermembership"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".usergroups_usermembership.UserMembershipControlPanel"\n       permission="plone.app.controlpanel.UsersAndGroups"\n       template="usergroups_usermembership.pt"\n@@ -200,7 +237,7 @@\n \n   <browser:page\n       name="usergroup-groupdetails"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".usergroups_groupdetails.GroupDetailsControlPanel"\n       permission="plone.app.controlpanel.UsersAndGroups"\n       template="usergroups_groupdetails.pt"\n@@ -219,7 +256,7 @@\n \n   <browser:page\n       name="prefs_install_products_form"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".quickinstaller.ManageProductsView"\n       permission="cmf.ManagePortal"\n       template="quickinstaller.pt"\n@@ -227,21 +264,21 @@\n \n   <browser:page\n       name="upgrade_products"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".quickinstaller.UpgradeProductsView"\n       permission="cmf.ManagePortal"\n       />\n \n   <browser:page\n       name="install_products"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".quickinstaller.InstallProductsView"\n       permission="cmf.ManagePortal"\n       />\n \n   <browser:page\n       name="uninstall_products"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".quickinstaller.UninstallProductsView"\n       permission="cmf.ManagePortal"\n       />\n@@ -249,7 +286,7 @@\n   <!-- Social Media Control Panel -->\n   <browser:page\n       name="social-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".socialmedia.SocialControlPanel"\n       permission="plone.app.controlpanel.Site"\n       />\n@@ -257,7 +294,7 @@\n   <!-- Imaging Control Panel -->\n   <browser:page\n       name="imaging-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".imaging.ImagingControlPanel"\n       permission="plone.app.controlpanel.Imaging"\n       />\n@@ -265,7 +302,7 @@\n   <!-- Portal actions -->\n   <browser:page\n       name="actions-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".actions.ActionListControlPanel"\n       permission="cmf.ManagePortal"\n       />\n@@ -281,7 +318,7 @@\n \n   <browser:page\n       name="new-action"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".actions.NewActionControlPanel"\n       permission="cmf.ManagePortal"\n       />\n@@ -298,7 +335,7 @@\n \n   <browser:page\n       name="redirection-controlpanel"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       class=".redirects.RedirectsControlPanel"\n       template="redirects-controlpanel.pt"\n       permission="Products.CMFPlone.ManagePortalAliases"\n@@ -313,4 +350,22 @@\n       allowed_attributes="redirects view_url"\n       />\n \n+  <!-- Relations -->\n+\n+  <browser:page\n+      name="inspect-relations"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n+      class=".relations.RelationsInspectControlpanel"\n+      template="relations_inspect.pt"\n+      permission="Products.CMFPlone.InspectRelations"\n+      />\n+\n+  <browser:page\n+      name="rebuild-relations"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n+      class=".relations.RelationsRebuildControlpanel"\n+      template="relations_rebuild.pt"\n+      permission="cmf.ManagePortal"\n+      />\n+\n </configure>\ndiff --git a/Products/CMFPlone/controlpanel/browser/controlpanel_usergroups_layout.pt b/Products/CMFPlone/controlpanel/browser/controlpanel_usergroups_layout.pt\nindex 23e4de1a77..20f24a048e 100644\n--- a/Products/CMFPlone/controlpanel/browser/controlpanel_usergroups_layout.pt\n+++ b/Products/CMFPlone/controlpanel/browser/controlpanel_usergroups_layout.pt\n@@ -10,37 +10,26 @@\n \n <div metal:fill-slot="prefs_configlet_main">\n \n-  <a id="setup-link" class="link-parent"\n-       tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-       i18n:translate="">\n-        Site Setup\n-    </a>\n+  <header>\n+    <h1 class="documentFirstHeading"\n+        i18n:translate="">User and Groups Settings</h1>\n \n-  <h1 class="documentFirstHeading"\n-      i18n:translate="">Users and Groups</h1>\n+    <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n+      Portal status message\n+    </div>\n \n-  <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n-    Portal status message\n-  </div>\n+    <p class="text-muted mt-2"\n+       i18n:translate="">\n+      User and groups settings for this site.\n+    </p>\n \n-  <div id="content-core">\n-\n-    <div class="autotabs">\n-      <div class="autotoc-nav">\n-        <a href="${portal_url}/@@usergroup-userprefs"\n-           i18n:translate="label_users">Users</a>\n-        <a href="${portal_url}/@@usergroup-groupprefs"\n-           i18n:translate="label_groups">Groups</a>\n-        <a class="active"\n-           href="${portal_url}/@@usergroup-controlpanel"\n-           i18n:translate="label_usergroup_settings">Settings</a>\n-        <a href="${portal_url}/@@member-fields"\n-             i18n:translate="label_member_fields">Member fields</a>\n-      </div>\n-      <span tal:replace="structure view/contents" />\n-    </div>\n+  </header>\n+  <div id="content" class="mt-3">\n \n+  <div class="mt-2">\n+    <span tal:replace="structure view/contents" />\n   </div>\n+</div>\n \n </div>\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/dateandtime.py b/Products/CMFPlone/controlpanel/browser/dateandtime.py\nindex 5059ec631f..9eec7408bb 100644\n--- a/Products/CMFPlone/controlpanel/browser/dateandtime.py\n+++ b/Products/CMFPlone/controlpanel/browser/dateandtime.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import IDateAndTimeSchema\n+from plone.base.interfaces import IDateAndTimeSchema\n from plone.app.registry.browser.controlpanel import ControlPanelFormWrapper\n from plone.app.registry.browser.controlpanel import RegistryEditForm\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/editing.py b/Products/CMFPlone/controlpanel/browser/editing.py\nindex 1ea069e011..fef3947988 100644\n--- a/Products/CMFPlone/controlpanel/browser/editing.py\n+++ b/Products/CMFPlone/controlpanel/browser/editing.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import IEditingSchema\n+from plone.base.interfaces import IEditingSchema\n from plone.app.registry.browser import controlpanel\n from z3c.form import interfaces\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/emaillogin.pt b/Products/CMFPlone/controlpanel/browser/emaillogin.pt\nindex 19f23369a8..8eec779af9 100644\n--- a/Products/CMFPlone/controlpanel/browser/emaillogin.pt\n+++ b/Products/CMFPlone/controlpanel/browser/emaillogin.pt\n@@ -1,67 +1,64 @@\n <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      metal:use-macro="context/prefs_main_template/macros/master"\n-      i18n:domain="plone">\n+  xmlns:tal="http://xml.zope.org/namespaces/tal"\n+  xmlns:metal="http://xml.zope.org/namespaces/metal"\n+  xmlns:i18n="http://xml.zope.org/namespaces/i18n" metal:use-macro="context/prefs_main_template/macros/master" i18n:domain="plone">\n \n-<body>\n+  <body>\n \n-  <metal:main metal:fill-slot="prefs_configlet_content">\n-    <h1 class="documentFirstHeading"\n-        i18n:translate="heading_find_duplicate_login_names">\n-      Find duplicate login names\n-    </h1>\n-\n-    <p i18n:translate="help_duplicate_login_names">\n+    <metal:main metal:fill-slot="prefs_configlet_content">\n+      <header>\n+        <a href=""\n+            id="setup-link"\n+            tal:attributes="href string:$portal_url/@@security-controlpanel"\n+            i18n:translate="">\n+            Security Settings\n+        </a>\n+        <h1 class="documentFirstHeading" i18n:translate="heading_find_duplicate_login_names">\n+          Find duplicate login names\n+        </h1>\n+      </header>\n+      <div id="content-core">\n+        <p i18n:translate="help_duplicate_login_names">\n       Switching the email login setting in the\n-      <a i18n:name="link"\n-         tal:attributes="href string:${context/portal_url}/@@security-controlpanel"\n-         i18n:translate="">Security settings</a>\n+          <a i18n:name="link" tal:attributes="href string:${context/portal_url}/@@security-controlpanel" i18n:translate="">Security settings</a>\n       on or off automatically changes the login name for existing users.\n       This may fail when there are duplicates.\n       On this page you can search for duplicates.\n-    </p>\n-\n-    <div tal:condition="request/form/submitted|nothing">\n-      <div tal:condition="view/duplicates">\n-        <p i18n:translate="msg_login_duplicates_found">\n-          The following login names would be used by more than one account:\n         </p>\n-        <ul>\n-          <ol tal:repeat="dup view/duplicates">\n-            <span tal:content="python:dup[0]" />:\n-            <span tal:repeat="account python:dup[1]" tal:content="account" />\n-          </ol>\n-        </ul>\n       </div>\n-      <div tal:condition="not:view/duplicates">\n-        <p i18n:translate="msg_no_login_duplicates_found">\n+      <div class="mb-4" tal:condition="request/form/submitted|nothing">\n+        <div tal:condition="view/duplicates">\n+          <p i18n:translate="msg_login_duplicates_found">\n+          The following login names would be used by more than one account:\n+          </p>\n+          <div clas="list-group">\n+            <div class="list-group-item" tal:repeat="dup view/duplicates">\n+              <span tal:content="python:dup[0]" />:\n+              <span tal:repeat="account python:dup[1]" tal:content="account" />\n+            </div>\n+          </div>\n+        </div>\n+        <div class="mb-4" tal:condition="not:view/duplicates">\n+          <p i18n:translate="msg_no_login_duplicates_found">\n           No login names found that are used by more than one account.\n-        </p>\n+          </p>\n+        </div>\n       </div>\n-    </div>\n \n-    <form action=""\n-          name="emaillogin-migrate"\n-          method="post"\n-          class="pat-formunloadalert pat-formautofocus">\n-      <div class="formControls">\n-        <input type="hidden" name="submitted" value="submitted" id="submitted" />\n-        <input class="context"\n-               type="submit"\n-               name="check_email"\n-               value="Check for duplicate emails"\n-               i18n:attributes="value label_check_duplicate_emails" />\n-        <br />\n-        <input class="context"\n-               type="submit"\n-               name="check_userid"\n-               value="Check for duplicate lower case user ids"\n-               i18n:attributes="value label_check_duplicate_user_ids" />\n-      </div>\n-    </form>\n+      <form action="" name="emaillogin-migrate" method="post" class="pat-formunloadalert pat-formautofocus">\n+        <fieldset class="mb-4">\n+          <input type="hidden" name="submitted" value="submitted" id="submitted" />\n+          <button type="submit" name="check_email" class="btn btn-primary">\n+            <span i18n:translate="label_check_duplicate_emails">Check for duplicate emails</span>\n+          </button>\n+        </fieldset>\n+        <fieldset>\n+          <button type="submit" name="check_userid" class="btn btn-primary">\n+            <span i18n:translate="label_check_duplicate_user_ids">Check for duplicate lower case user ids</span>\n+          </button>\n+        </fieldset>\n+      </form>\n \n-  </metal:main>\n-</body>\n+    </metal:main>\n+  </body>\n </html>\ndiff --git a/Products/CMFPlone/controlpanel/browser/error_log_form.pt b/Products/CMFPlone/controlpanel/browser/error_log_form.pt\nnew file mode 100644\nindex 0000000000..221df55ae8\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/browser/error_log_form.pt\n@@ -0,0 +1,166 @@\n+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      lang="en"\n+      metal:use-macro="context/prefs_main_template/macros/master"\n+      i18n:domain="plone">\n+\n+<body>\n+\n+<metal:main fill-slot="prefs_configlet_main">\n+\n+    <header>\n+      <h1 i18n:translate="heading_error_log">Error log</h1>\n+      <p class="lead" i18n:translate="description_error_log_setup">\n+        This page lists the exceptions that have occurred in this site\n+        recently. You can configure how many exceptions should be kept\n+        and whether the exceptions should be copied to Zope\'s event log\n+        file(s).\n+      </p>\n+      <p class="discreet">\n+        <a href="https://docs.plone.org/appendices/error-reference.html"\n+           i18n:translate="description_error_rerference_link">\n+          Refer to the plone.org error reference for more information about\n+          these exceptions.\n+        </a>\n+      </p>\n+    </header>\n+\n+    <div id="content-core">\n+      <div id="layout-contents">\n+\n+        <form class="mb-4" action="@@error-log-update" method="get">\n+          <fieldset class="mb-3" tal:define="entries context/error_log/getLogEntries">\n+            <div class="field" tal:condition="not:entries" i18n:translate="legend_lognoexceptions">\n+              No exceptions logged.\n+            </div>\n+\n+            <table class="table table-responsive table-bordered table-striped" tal:condition="entries">\n+              <caption i18n:translate="summary_exception_log">Error Log (most recent first)</caption>\n+\n+              <thead>\n+                <tr>\n+                  <th i18n:translate="label_time">Time</th>\n+                  <th i18n:translate="label_user_name">User Name</th>\n+                  <th i18n:translate="label_exception">Exception</th>\n+                </tr>\n+              </thead>\n+\n+              <tbody tal:define="member context/@@plone_portal_state/member;\n+                                 updatetime python:member.getProperty(\'error_log_update\', 0.0);\n+                                 updatetime python:updatetime and updatetime or 0.0;\n+                                 updatetime python:float(updatetime)">\n+\n+                <tal:entry tal:repeat="entry entries">\n+                  <tr tal:define="oddrow repeat/entry/odd;"\n+                      tal:attributes="class python: oddrow and \'odd\' or \'even\'"\n+                      tal:condition="python: entry[\'time\'] > updatetime">\n+\n+                    <td tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;"\n+                        tal:content="python:toLocalizedTime(entry[\'time\'], long_format=True)">13:04:41</td>\n+                    <td tal:content="string:${entry/username} (${entry/userid})">joe</td>\n+                    <td>\n+                      <a href="showEntry"\n+                         tal:attributes="href string:@@error-log-show-entry?id=${entry/id}">\n+                        <span tal:replace="entry/type">AttributeError</span>:\n+                        <span tal:define="value entry/value"\n+                              tal:content="python: len(value) &lt; 70 and value or value[:70] + \'...\'">\n+                          Application object has no attribute "gak"\n+                        </span>\n+                      </a>\n+                    </td>\n+                  </tr>\n+                </tal:entry>\n+              </tbody>\n+            </table>\n+\n+          </fieldset>\n+        </form>\n+\n+        <form class="mb-4" action="@@error-log-update" method="get">\n+          <fieldset class="mb-3">\n+            <legend i18n:translate="label_search_entry">\n+              Search for an error log entry <span class="formHelp"> (such as "1257962690.640.49636048561")\n+            </legend>\n+\n+            <div class="mb-3 field widget-mode-input">\n+              <input type="text"\n+                     name="search_entry"\n+                     id="search_entry"\n+                     class="form-control text-widget textline-field"/>\n+            </div>\n+\n+            <div class="formControls">\n+              <input class="btn btn-primary"\n+                     type="submit"\n+                     name="form.button.search"\n+                     value="Search"\n+                     i18n:attributes="value label_search;" />\n+            </div>\n+\n+          </fieldset>\n+        </form>\n+\n+        <hr />\n+\n+        <form class="mb-4" action="@@error-log-set-properties" method="post">\n+          <fieldset class="mb-3" tal:define="props context/error_log/getProperties">\n+\n+            <legend i18n:translate="legend_logdetails">Log details</legend>\n+\n+            <div class="mb-3 field widget-mode-input">\n+              <label class="form-label" for="keep_entries"\n+                     i18n:translate="label_number_exceptions">Number of exceptions to keep</label>\n+\n+              <input type="text"\n+                     name="keep_entries"\n+                     id="keep_entries"\n+                     class="form-control text-widget textline-field"\n+                     tal:attributes="value props/keep_entries" />\n+            </div>\n+\n+            <div class="mb-3 form-check">\n+              <input type="checkbox"\n+                     class="form-check-input single-checkbox-bool-widget bool-field"\n+                     id="cb_copy_to_zlog"\n+                     name="copy_to_zlog"\n+                     tal:attributes="checked props/copy_to_zlog;\n+                                     disabled not:context/error_log/checkEventLogPermission|nothing" />\n+\n+              <label class="form-check-label" for="cb_copy_to_zlog" i18n:translate="label_copy_exceptions">\n+                Copy exceptions to the event log\n+              </label>\n+            </div>\n+\n+            <div class="mb-3 field widget-mode-input">\n+              <label class="form-label" for="ignored_exceptions"\n+                     i18n:translate="label_ignored_exception">Ignored exception types</label>\n+\n+              <br>\n+              <textarea name="ignored_exceptions:lines"\n+                        id="ignored_exceptions"\n+                        cols="40"\n+                        rows="3"\n+                        class="form-control textarea-widget list-field"\n+                        tal:content="python: \'\\n\'.join(props[\'ignored_exceptions\'])"></textarea>\n+            </div>\n+\n+            <div class="formControls">\n+              <input class="btn btn-primary"\n+                     type="submit"\n+                     name="submit"\n+                     value="Save"\n+                     i18n:attributes="value label_save;" />\n+            </div>\n+\n+          </fieldset>\n+        </form>\n+\n+      </div>\n+    </div>\n+\n+</metal:main>\n+\n+</body>\n+</html>\ndiff --git a/Products/CMFPlone/controlpanel/browser/error_log_form.py b/Products/CMFPlone/controlpanel/browser/error_log_form.py\nnew file mode 100644\nindex 0000000000..c2d2d2f495\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/browser/error_log_form.py\n@@ -0,0 +1,46 @@\n+import plone.api as api\n+from DateTime import DateTime\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.utils import safe_nativestring\n+from Products.Five import BrowserView\n+\n+\n+class ErrorLogUpdate(BrowserView):\n+\n+    def __call__(self):\n+        member = api.user.get_current()\n+\n+        if getattr(self.request, \'form.button.search\', None) is not None:\n+            search = self.request.form.get(\'search_entry\')\n+            if search == \'\':\n+                member.setProperties(error_log_update=0.0)\n+                self.context.plone_utils.addPortalMessage(_(\'Showing all entries\'))\n+                return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\n+            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-show-entry?id=%s\' % search)\n+\n+        elif getattr(self.request, \'form.button.showall\', None) is not None:\n+            member.setProperties(error_log_update=0.0)\n+            self.context.plone_utils.addPortalMessage(_(\'Showing all entries\'))\n+            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\n+\n+        elif getattr(self.request, \'form.button.clear\', None) is not None:\n+            member.setProperties(error_log_update=DateTime().timeTime())\n+            self.context.plone_utils.addPortalMessage(_(\'Entries cleared\'))\n+            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\n+\n+        else:\n+            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\n+\n+\n+class ErrorLogSetProperties(BrowserView):\n+\n+    def __call__(self):\n+        keep_entries = self.request.form.get(\'keep_entries\')\n+        ignored_exceptions = self.request.form.get(\'ignored_exceptions\')\n+        copy_to_zlog = self.request.form.get(\'copy_to_zlog\', 0)\n+\n+        ignored_exceptions = map(safe_nativestring, ignored_exceptions)\n+        self.context.error_log.setProperties(keep_entries, copy_to_zlog, ignored_exceptions)\n+        self.context.plone_utils.addPortalMessage(_(\'Changes made.\'))\n+\n+        return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt b/Products/CMFPlone/controlpanel/browser/error_log_show_entry.pt\nsimilarity index 95%\nrename from Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt\nrename to Products/CMFPlone/controlpanel/browser/error_log_show_entry.pt\nindex ca10e1ed15..2e89da22ba 100644\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt\n+++ b/Products/CMFPlone/controlpanel/browser/error_log_show_entry.pt\n@@ -20,7 +20,7 @@\n     <div id="content-core">\n         <a href=""\n            class="link-parent"\n-           tal:attributes="href string:$portal_url/prefs_error_log_form"\n+           tal:attributes="href string:$portal_url/@@error-log-form"\n            i18n:translate="label_back_to_errorlog">\n         Back to Error Log\n         </a>\n@@ -47,7 +47,7 @@\n                     <dt i18n:translate="label_time">Time</dt>\n                     <dd\n                         tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;"\n-                        tal:content="python:toLocalizedTime(DateTime(entry[\'time\']), long_format=True)"></dd>\n+                        tal:content="python:toLocalizedTime(entry[\'time\'], long_format=True)"></dd>\n \n                     <dt align="left" valign="top"\n                         i18n:translate="label_user_name">User Name</dt>\ndiff --git a/Products/CMFPlone/controlpanel/browser/filter.py b/Products/CMFPlone/controlpanel/browser/filter.py\nindex e867f340ca..ff021fe988 100644\n--- a/Products/CMFPlone/controlpanel/browser/filter.py\n+++ b/Products/CMFPlone/controlpanel/browser/filter.py\n@@ -1,7 +1,7 @@\n from plone.app.registry.browser import controlpanel\n from plone.z3cform import layout\n from Products.CMFPlone import PloneMessageFactory as _  # NOQA\n-from Products.CMFPlone.interfaces import IFilterSchema\n+from plone.base.interfaces import IFilterSchema\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n from z3c.form import button\ndiff --git a/Products/CMFPlone/controlpanel/browser/filter_controlpanel.pt b/Products/CMFPlone/controlpanel/browser/filter_controlpanel.pt\nindex 04f4928b74..71c7146ff8 100644\n--- a/Products/CMFPlone/controlpanel/browser/filter_controlpanel.pt\n+++ b/Products/CMFPlone/controlpanel/browser/filter_controlpanel.pt\n@@ -10,13 +10,6 @@\n \n <div metal:fill-slot="prefs_configlet_main">\n \n-  <a href=""\n-     id="setup-link"\n-     tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-     i18n:translate="">\n-      Site Setup\n-  </a>\n-\n   <h1 class="documentFirstHeading" tal:content="view/label">View Title</h1>\n \n   <div metal:use-macro="context/global_statusmessage/macros/portal_message">\ndiff --git a/Products/CMFPlone/controlpanel/browser/imaging.py b/Products/CMFPlone/controlpanel/browser/imaging.py\nindex 71e7e58c2e..369c78a410 100644\n--- a/Products/CMFPlone/controlpanel/browser/imaging.py\n+++ b/Products/CMFPlone/controlpanel/browser/imaging.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces.controlpanel import IImagingSchema\n+from plone.base.interfaces.controlpanel import IImagingSchema\n from logging import getLogger\n from plone.app.registry.browser import controlpanel\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/mail.py b/Products/CMFPlone/controlpanel/browser/mail.py\nindex ea1769d253..6f09498c3e 100644\n--- a/Products/CMFPlone/controlpanel/browser/mail.py\n+++ b/Products/CMFPlone/controlpanel/browser/mail.py\n@@ -1,6 +1,6 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+from plone.base.interfaces.controlpanel import IMailSchema\n from Products.MailHost.MailHost import MailHostError\n from Products.statusmessages.interfaces import IStatusMessage\n from logging import getLogger\n@@ -37,9 +37,11 @@ def save(self):\n             self.status = self.formErrorsMessage\n             return False\n         # keep password field\n-        if (data.get(\'smtp_userid\') is not None and\n-                data.get(\'smtp_pass\') is None):\n+        smtp_user_id = (data.get(\'smtp_userid\') or \'\').strip()\n+        smtp_pass = (data.get(\'smtp_pass\') or \'\').strip()\n+        if smtp_user_id and not smtp_pass:\n             del data[\'smtp_pass\']\n+\n         self.applyChanges(data)\n         return True\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/maintenance.pt b/Products/CMFPlone/controlpanel/browser/maintenance.pt\nindex 7db55c1da0..ecd8f30279 100644\n--- a/Products/CMFPlone/controlpanel/browser/maintenance.pt\n+++ b/Products/CMFPlone/controlpanel/browser/maintenance.pt\n@@ -14,38 +14,40 @@\n \n          <metal:block define-macro="header">\n \n-             <dl tal:define="status view/status"\n+             <div tal:define="status view/status"\n                  tal:condition="status"\n                  role="status"\n-                 class="portalMessage info">\n-                 <dt i18n:translate="">\n+                 class="alert alert-info">\n+                 <strong i18n:translate="">\n                      Info\n-                 </dt>\n-                 <dd tal:content="view/status" />\n-             </dl>\n+                 </strong>\n+                 <span tal:content="view/status" />\n+                </div>\n \n          </metal:block>\n \n-         <a href=""\n-            id="setup-link"\n-            tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-            i18n:translate="">\n-             Site Setup\n-         </a>\n-\n-         <h1 class="documentFirstHeading"\n-             i18n:translate=""\n-             tal:condition="view/label"\n-             tal:content="view/label"\n-             metal:define-slot="heading">\n-             Do something\n-         </h1>\n-\n-         <div class="documentDescription" i18n:translate=""\n-            tal:condition="view/description"\n-            tal:content="view/description">\n-             Description\n-         </div>\n+         <header>\n+            <a href=""\n+                id="setup-link"\n+                tal:attributes="href string:$portal_url/@@overview-controlpanel"\n+                i18n:translate="">\n+                Site Setup\n+            </a>\n+\n+            <h1 class="documentFirstHeading"\n+                i18n:translate=""\n+                tal:condition="view/label"\n+                tal:content="view/label"\n+                metal:define-slot="heading">\n+                Do something\n+            </h1>\n+\n+            <div class="documentDescription" i18n:translate=""\n+                tal:condition="view/description"\n+                tal:content="view/description">\n+                Description\n+            </div>\n+        </header>\n \n         <div id="content-core">\n \n@@ -55,27 +57,29 @@\n                   class="edit-form"\n                   enctype="multipart/form-data">\n \n-                <fieldset>\n+                <fieldset class="mb-4">\n                     <legend i18n:translate="heading_zope_server">\n                         Zope Server\n                     </legend>\n \n                     <div id="actionsView" class="formControls">\n                         <span class="actionButtons">\n-                            <input type="submit"\n+                            <button type="submit"\n                                    id="form.buttons.shutdown"\n                                    name="form.buttons.shutdown"\n                                    value="Shut down"\n-                                   i18n:attributes="value"\n-                                   class="standalone" />\n+                                   class="btn btn-danger">\n+                                <span i18n:translate="">Shut down</span>\n+                            </button>\n \n-                            <input tal:condition="view/isRestartable"\n+                            <button tal:condition="view/isRestartable"\n                                    type="submit"\n                                    id="form.buttons.restart"\n                                    name="form.buttons.restart"\n                                    value="Restart"\n-                                   i18n:attributes="value"\n-                                   class="standalone" />\n+                                   class="btn btn-danger">\n+                                <span i18n:translate="">Restart</span>\n+                            </button>\n \n                         </span>\n                     </div>\n@@ -97,7 +101,7 @@\n                 <div metal:define-slot="extra_info" tal:replace="nothing">\n                 </div>\n \n-                <fieldset>\n+                <fieldset class="mb-4">\n                     <legend tal:define="form_name view/form_name|nothing"\n                             tal:condition="form_name"\n                             tal:content="form_name">Form name</legend>\n@@ -126,12 +130,12 @@\n \n                     <div id="actionsView" class="formControls">\n                         <span class="actionButtons">\n-                            <input type="submit"\n+                            <button type="submit"\n                                    id="form.buttons.pack"\n                                    name="form.buttons.pack"\n                                    value="Pack"\n-                                   i18n:attributes="value"\n-                                   class="standalone" />\n+                                   class="btn btn-danger">\n+                                <span i18n:translate="">Pack</span>\n                         </span>\n                     </div>\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/maintenance.py b/Products/CMFPlone/controlpanel/browser/maintenance.py\nindex d3b82f96c5..58d1da57fb 100644\n--- a/Products/CMFPlone/controlpanel/browser/maintenance.py\n+++ b/Products/CMFPlone/controlpanel/browser/maintenance.py\n@@ -7,7 +7,7 @@\n from plone.protect import CheckAuthenticator\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import IMaintenanceSchema\n+from plone.base.interfaces import IMaintenanceSchema\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import button\n from z3c.form import form\ndiff --git a/Products/CMFPlone/controlpanel/browser/markup.py b/Products/CMFPlone/controlpanel/browser/markup.py\nindex c78d345d59..dc97a36c8d 100644\n--- a/Products/CMFPlone/controlpanel/browser/markup.py\n+++ b/Products/CMFPlone/controlpanel/browser/markup.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import IMarkupSchema\n+from plone.base.interfaces import IMarkupSchema\n from plone.app.registry.browser import controlpanel\n from z3c.form.browser.checkbox import CheckBoxFieldWidget\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/navigation.py b/Products/CMFPlone/controlpanel/browser/navigation.py\nindex 7e4955f3d5..8149211b00 100644\n--- a/Products/CMFPlone/controlpanel/browser/navigation.py\n+++ b/Products/CMFPlone/controlpanel/browser/navigation.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import INavigationSchema\n+from plone.base.interfaces import INavigationSchema\n from plone.app.registry.browser import controlpanel\n from z3c.form.browser.checkbox import CheckBoxFieldWidget\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/overview.pt b/Products/CMFPlone/controlpanel/browser/overview.pt\nindex f22683fc28..502561674b 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/overview.pt\n@@ -12,127 +12,134 @@\n                 tal:define="disable_column_one python:request.set(\'disable_plone.leftcolumn\',1);\n                             disable_column_two python:request.set(\'disable_plone.rightcolumn\',1);"/>\n \n-<div metal:fill-slot="prefs_configlet_main">\n-\n+<div metal:fill-slot="prefs_configlet_main" class="controlPanel controlPanelOverview">\n+  <header>\n     <h1 class="documentFirstHeading"\n         i18n:translate="">Site Setup</h1>\n \n-    <p class="documentDescription" i18n:translate="description_control_panel">\n+    <p class="lead" i18n:translate="description_control_panel">\n         Configuration area for Plone and add-on Products.\n     </p>\n-\n-    <div class="portalMessage warning"\n-         role="status"\n-         tal:condition="view/upgrade_warning">\n-        <strong i18n:translate="">\n-            Warning\n-        </strong>\n-        <span tal:omit-tag="" i18n:translate="">\n-            The site configuration is outdated and needs to be\n-            upgraded. Please\n-            <a href="#"\n-               tal:attributes="href string:${context/portal_url}/@@plone-upgrade"\n-               title="Go to the upgrade page"\n-               i18n:attributes="title;"\n-               i18n:name="link_continue_with_the_upgrade"\n-               i18n:translate="">\n-              continue with the upgrade\n-            </a>.\n-        </span>\n-    </div>\n-\n-    <div class="portalMessage warning"\n-         role="status"\n-         tal:condition="view/mailhost_warning">\n-        <strong i18n:translate="">\n-            Warning\n-        </strong>\n-        <span tal:omit-tag="" i18n:translate="text_no_mailhost_configured">\n-            You have not configured a mail host or a site \'From\'\n-            address, various features including contact forms, email\n-            notification and password reset will not work. Go to the\n-            <tal:link i18n:name="label_mail_control_panel_link">\n-                <a href=""\n-                   i18n:translate="text_no_mailhost_configured_control_panel_link"\n-                   tal:attributes="href string:${portal_url}/@@mail-controlpanel"\n-                >Mail control panel</a>\n-            </tal:link>\n-            to fix this.\n-        </span>\n-    </div>\n-\n-    <div class="portalMessage warning"\n-         role="status"\n-         tal:condition="view/timezone_warning">\n-        <strong i18n:translate="">\n-            Warning\n-        </strong>\n-        <span tal:omit-tag="" i18n:translate="text_no_timezone_configured">\n-\n-            You have not set the portal timezone. Date/Time handling will not\n-            work properly for timezone aware date/time values.\n-            Go to the\n-            <tal:link i18n:name="label_mail_event_settings_link">\n-                <a href=""\n-                   i18n:translate="text_no_timezone_configured_control_panel_link"\n-                   tal:attributes="href string:${portal_url}/@@dateandtime-controlpanel"\n-                >Date and Time Settings control panel</a>\n-            </tal:link>\n-            to fix this.\n-        </span>\n-    </div>\n-\n-    <div class="portalMessage warning"\n-         role="status"\n-         tal:condition="not:view/pil">\n-        <strong i18n:translate="">\n-            Warning\n-        </strong>\n-        <span tal:omit-tag="" i18n:translate="text_no_pil_installed">\n-            PIL is not installed properly, image scaling will not work.\n-        </span>\n-    </div>\n-\n-    <tal:category tal:repeat="category view/categories">\n-      <tal:defs tal:define="sublist python:view.sublists(category.get(\'id\'))">\n-        <section class="portlet portletNavigationTree portletSiteSetup" tal:condition="sublist">\n-          <header class="portletHeader" tal:content="category/title"\n-            i18n:translate="">Category</header>\n-\n-          <nav class="portletContent" tal:condition="sublist">\n-\n-            <ul class="row configlets"\n-                tal:condition="sublist">\n-              <tal:actions tal:repeat="action sublist">\n-                      <li class="col-xs-4 col-sm-3 col-md-2" tal:condition="action/visible">\n-                        <div class="inner-configlet">\n-                          <a href=""\n-                             tal:define="icon action/icon"\n-                             tal:attributes="href action/url">\n-                             <span tal:attributes="class python:\'icon-controlpanel-\' + action[\'id\'].replace(\'.\', \'_\')"></span>\n-                              <tal:title tal:content="action/title"\n-                                         i18n:translate="">\n-                                  Title\n-                              </tal:title>\n-                          </a>\n-                        </div>\n-                      </li>\n-                  </tal:actions>\n-                </ul>\n-            </nav>\n-\n-            <div class="discreet"\n-                 tal:condition="not:sublist"\n-                 i18n:translate="label_no_prefs_panels_available">\n-                No preference panels available.\n-            </div>\n-\n-        </section>\n-      </tal:defs>\n-    </tal:category>\n-\n-    <div class="visualClear"><!-- --></div>\n-\n+  </header>\n+  <div class="alert alert-warning mb-5"\n+        role="status"\n+        tal:condition="view/upgrade_warning">\n+      <strong i18n:translate="">\n+          Warning\n+      </strong>\n+      <span tal:omit-tag="" i18n:translate="">\n+          The site configuration is outdated and needs to be\n+          upgraded. Please\n+          <a href="#"\n+              tal:attributes="href string:${context/portal_url}/@@plone-upgrade"\n+              title="Go to the upgrade page"\n+              i18n:attributes="title;"\n+              i18n:name="link_continue_with_the_upgrade"\n+              i18n:translate="">\n+            continue with the upgrade\n+          </a>.\n+      </span>\n+  </div>\n+\n+  <div class="alert alert-warning mb-5"\n+        role="status"\n+        tal:condition="view/mailhost_warning">\n+      <strong i18n:translate="">\n+          Warning\n+      </strong>\n+      <span tal:omit-tag="" i18n:translate="text_no_mailhost_configured">\n+          You have not configured a mail host or a site \'From\'\n+          address, various features including contact forms, email\n+          notification and password reset will not work. Go to the\n+          <tal:link i18n:name="label_mail_control_panel_link">\n+              <a href=""\n+                  i18n:translate="text_no_mailhost_configured_control_panel_link"\n+                  tal:attributes="href string:${portal_url}/@@mail-controlpanel"\n+              >Mail control panel</a>\n+          </tal:link>\n+          to fix this.\n+      </span>\n+  </div>\n+\n+  <div class="alert alert-warning mb-5"\n+        role="status"\n+        tal:condition="view/timezone_warning">\n+      <strong i18n:translate="">\n+          Warning\n+      </strong>\n+      <span tal:omit-tag="" i18n:translate="text_no_timezone_configured">\n+\n+          You have not set the portal timezone. Date/Time handling will not\n+          work properly for timezone aware date/time values.\n+          Go to the\n+          <tal:link i18n:name="label_mail_event_settings_link">\n+              <a href=""\n+                  i18n:translate="text_no_timezone_configured_control_panel_link"\n+                  tal:attributes="href string:${portal_url}/@@dateandtime-controlpanel"\n+              >Date and Time Settings control panel</a>\n+          </tal:link>\n+          to fix this.\n+      </span>\n+  </div>\n+\n+  <div class="alert alert-warning mb-5"\n+        role="status"\n+        tal:condition="not:view/pil">\n+      <strong i18n:translate="">\n+          Warning\n+      </strong>\n+      <span tal:omit-tag="" i18n:translate="text_no_pil_installed">\n+          PIL is not installed properly, image scaling will not work.\n+      </span>\n+  </div>\n+\n+  <tal:category tal:repeat="category view/categories">\n+    <tal:defs tal:define="sublist python:view.sublists(category.get(\'id\'))">\n+      <section class="controlPanelSection mb-4" tal:condition="sublist">\n+        <h3 class="" tal:content="category/title"\n+          i18n:translate="">Category</h3>\n+\n+        <nav class="row" tal:condition="sublist">\n+\n+          <ul class="configlets row row-cols-3 row-cols-sm-4 row-cols-lg-6 row-cols-xl-8 list-unstyled list w-100"\n+              tal:condition="sublist">\n+            <tal:actions tal:repeat="action sublist">\n+              <li class="col mb-4" tal:condition="action/visible">\n+                <a href="" class="d-block text-dark text-center py-4 rounded btn btn-light h-100"\n+                    tal:define="icon action/icon;\n+                                icon_url python:\'http\' in action[\'icon\']"\n+                    tal:attributes="href action/url">\n+                    <div class="mb-3">\n+                      <img tal:condition="icon_url"\n+                        src="" alt="" class="icon"\n+                        tal:attributes="src action/icon;\n+                                        alt action/title"\n+                        i18n:attributes="alt">\n+                      <tal:icon tal:condition="not: icon_url"\n+                        tal:replace="structure python:icons.tag(action[\'icon\'] or \'plone-controlpanel\', tag_alt=action[\'title\'], tag_class=\'overview-icon\')" />\n+                    </div>\n+                    <div tal:content="action/title"\n+                                i18n:translate=""\n+                                class="text-decoration-none text-center ">\n+                        Title\n+                    </div>\n+                </a>\n+              </li>\n+            </tal:actions>\n+            </ul>\n+          </nav>\n+\n+          <div class="discreet"\n+                tal:condition="not:sublist"\n+                i18n:translate="label_no_prefs_panels_available">\n+              No preference panels available.\n+          </div>\n+\n+      </section>\n+    </tal:defs>\n+  </tal:category>\n+\n+  <section class="controlPanelSectionFooter">\n     <h2 i18n:translate="heading_version_overview">Version Overview</h2>\n     <ul>\n       <tal:list-versions repeat="version view/version_overview">\n@@ -153,10 +160,9 @@\n       </tal:server>\n     </ul>\n \n-\n     <p tal:condition="not:view/is_dev_mode"\n-       class="discreet"\n-       i18n:translate="description_production_mode">\n+        class=""\n+        i18n:translate="description_production_mode">\n       You are running in "production mode". This is the preferred mode of\n       operation for a live Plone site, but means that some\n       configuration changes will not take effect until your server is\n@@ -167,8 +173,8 @@\n     </p>\n \n     <p tal:condition="view/is_dev_mode"\n-       class="discreet"\n-       i18n:translate="description_debug_mode">\n+        class=""\n+        i18n:translate="description_debug_mode">\n       You are running in "debug mode". This mode is intended for sites that\n       are under development. This allows many configuration changes to be\n       immediately visible, but will make your site run more slowly. To turn\n@@ -176,6 +182,7 @@\n       buildout.cfg, re-run bin/buildout and then restart the server\n       process.\n     </p>\n+  </section>\n \n </div>\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/overview.py b/Products/CMFPlone/controlpanel/browser/overview.py\nindex 208fded1e9..f0e275ce5b 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.py\n+++ b/Products/CMFPlone/controlpanel/browser/overview.py\n@@ -1,7 +1,7 @@\n from AccessControl import getSecurityManager\n from Acquisition import aq_inner\n from App.config import getConfiguration\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+from plone.base.interfaces.controlpanel import IMailSchema\n from Products.CMFCore.permissions import ManagePortal\n from Products.CMFCore.utils import getToolByName\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n@@ -12,9 +12,11 @@\n from ZPublisher.HTTPRequest import WSGIRequest\n \n import pkg_resources\n+import warnings\n \n try:\n     import plone.app.event\n+\n     plone.app.event  # pyflakes\n     HAS_PAE = True\n except ImportError:\n@@ -23,70 +25,76 @@\n \n class OverviewControlPanel(controlpanel.RegistryEditForm):\n \n-    template = ViewPageTemplateFile(\'overview.pt\')\n+    template = ViewPageTemplateFile("overview.pt")\n \n-    base_category = \'controlpanel\'\n-    ignored_categories = (\'controlpanel_user\')\n+    base_category = "controlpanel"\n+    ignored_categories = "controlpanel_user"\n \n     def __call__(self):\n-        self.request.set(\'disable_border\', 1)\n+        self.request.set("disable_border", 1)\n         return self.template()\n \n     @memoize\n     def cptool(self):\n-        return getToolByName(aq_inner(self.context), \'portal_controlpanel\')\n+        return getToolByName(aq_inner(self.context), "portal_controlpanel")\n \n     @memoize\n     def migration(self):\n-        return getToolByName(aq_inner(self.context), \'portal_migration\')\n+        return getToolByName(aq_inner(self.context), "portal_migration")\n \n     @memoize\n     def core_versions(self):\n         return self.migration().coreVersions()\n \n     def pil(self):\n-        return \'PIL\' in self.core_versions()\n+        return "PIL" in self.core_versions()\n \n     def server_info(self):\n         wsgi = isinstance(self.request, WSGIRequest)\n-        server_name = \'unknown\'\n-        server_version = \'\'\n+        server_name = "unknown"\n+        server_version = ""\n \n-        server_name = self.request.get(\'SERVER_SOFTWARE\')\n+        server_name = self.request.get("SERVER_SOFTWARE")\n         if server_name:\n-            if \'ZServer\' in server_name:\n-                server_name = \'ZServer\'\n+            if "ZServer" in server_name:\n+                server_name = "ZServer"\n+            elif "/" in server_name:\n+                server_name = server_name.split("/")[0]\n             try:\n                 server = pkg_resources.get_distribution(server_name)\n                 server_version = server.version\n-            except (pkg_resources.DistributionNotFound,\n-                    pkg_resources.RequirementParseError):\n-                pass\n+            except Exception:\n+                warnings.warn(\n+                    "Cannot find or parse version for %r"\n+                    % self.request.get("SERVER_SOFTWARE"),\n+                )\n         return {\n-            \'wsgi\': wsgi,\n-            \'server_name\': server_name,\n-            \'version\': server_version,\n+            "wsgi": wsgi,\n+            "server_name": server_name,\n+            "version": server_version,\n         }\n \n     def version_overview(self):\n \n         core_versions = self.core_versions()\n         versions = [\n-            \'Plone {} ({})\'.format(core_versions[\'Plone\'],\n-                               core_versions[\'Plone Instance\'])]\n-\n-        for v in (\'CMF\', \'Zope\', \'Python\'):\n-            versions.append(v + \' \' + core_versions.get(v))\n-        pil = core_versions.get(\'PIL\', None)\n+            "Plone {} ({})".format(\n+                core_versions["Plone"], core_versions["Plone Instance"]\n+            )\n+        ]\n+\n+        for v in ("CMF", "Zope", "Python"):\n+            versions.append(v + " " + core_versions.get(v))\n+        pil = core_versions.get("PIL", None)\n         if pil is not None:\n-            versions.append(\'PIL \' + pil)\n+            versions.append("PIL " + pil)\n         return versions\n \n     def is_dev_mode(self):\n         return getConfiguration().debug_mode\n \n     def upgrade_warning(self):\n-        mt = getToolByName(aq_inner(self.context), \'portal_migration\')\n+        mt = getToolByName(aq_inner(self.context), "portal_migration")\n         if mt.needUpgrading():\n             # if the user can\'t run the upgrade, no sense in displaying the\n             # message\n@@ -97,8 +105,7 @@ def upgrade_warning(self):\n \n     def mailhost_warning(self):\n         registry = getUtility(IRegistry)\n-        mail_settings = registry.forInterface(\n-            IMailSchema, prefix=\'plone\', check=False)\n+        mail_settings = registry.forInterface(IMailSchema, prefix="plone", check=False)\n         mailhost = mail_settings.smtp_host\n         email = mail_settings.email_from_address\n         if mailhost and email:\n@@ -106,8 +113,7 @@ def mailhost_warning(self):\n         return True\n \n     def timezone_warning(self):\n-        """Returns true, if the portal_timezone is not set in the registry.\n-        """\n+        """Returns true, if the portal_timezone is not set in the registry."""\n         if not HAS_PAE:\n             # No point of having a portal timezone configured without\n             # plone.app.event installed.\n@@ -121,7 +127,7 @@ def timezone_warning(self):\n         if reg_key not in registry:\n             # else use \'plone.app.event.portal_timezone\'\n             # < Plone 5\n-            reg_key = \'plone.app.event.portal_timezone\'\n+            reg_key = "plone.app.event.portal_timezone"\n         if reg_key not in registry:\n             return True\n         portal_timezone = registry[reg_key]\ndiff --git a/Products/CMFPlone/controlpanel/browser/prefsmaintemplate.pt b/Products/CMFPlone/controlpanel/browser/prefsmaintemplate.pt\nnew file mode 100644\nindex 0000000000..1ca009a775\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/browser/prefsmaintemplate.pt\n@@ -0,0 +1,71 @@\n+<metal:page define-macro="master" i18n:domain="plone">\n+  <tal:block metal:use-macro="context/@@main_template/macros/master">\n+\n+    <metal:block fill-slot="top_slot">\n+        <metal:override define-slot="top_slot">\n+            <tal:defines tal:define="dummy python:request.set(\'disable_border\',1);\n+                                     controlPanel python:modules[\'Products.CMFCore.utils\'].getToolByName(here, \'portal_controlpanel\');\n+                                     disable_column_one python:request.set(\'disable_plone.leftcolumn\', 1);\n+                                     disable_column_two python:request.set(\'disable_plone.rightcolumn\',1);"/>\n+        </metal:override>\n+    </metal:block>\n+\n+    <metal:override fill-slot="content">\n+        <metal:slot define-slot="prefs_configlet_wrapper">\n+          <metal:slot define-slot="prefs_configlet_content">\n+\n+            <metal:block metal:use-macro="context/@@main_template/macros/content">\n+              <metal:override metal:fill-slot="main">\n+\n+                <div class="mb-3"\n+                     tal:define="controlPanel python:modules[\'Products.CMFCore.utils\'].getToolByName(here, \'portal_controlpanel\');\n+                                 groups python:controlPanel.getGroups(\'site\');\n+                                 site_url controlPanel/site_url;\n+                                 current_url request/URL">\n+                  <ul class="nav nav-tabs">\n+                    <li class="nav-item"\n+                        tal:define="overview_url string:$portal_url/@@overview-controlpanel">\n+                      <a class="nav-link ${python:\'active\' if overview_url in current_url else \'\'}" aria-current="page" href="${overview_url}" i18n:translate="">Site Setup</a>\n+                    </li>\n+                    <tal:group tal:repeat="group groups">\n+                      <li tal:define="configlets python:controlPanel.enumConfiglets(group=group[\'id\']);\n+                                      active python:\'active\' if bool([c for c in configlets if current_url.startswith(c[\'url\'])]) else \'inactive\'"\n+                          tal:condition="python:configlets and controlPanel.maySeeSomeConfiglets"\n+                          class="nav-item dropdown">\n+                        <a class="nav-link dropdown-toggle ${active}" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">${group/title}</a>\n+                          <ul class="dropdown-menu">\n+                          <tal:loop tal:repeat="configlet configlets">\n+                            <li tal:condition="configlet/visible">\n+                              <a tal:define="icon_url python:\'http\' in configlet[\'icon\']"\n+                                 class="dropdown-item"\n+                                 href="${configlet/url}">\n+                                <img tal:condition="icon_url"\n+                                    src="" alt="" class="icon"\n+                                    tal:attributes="src configlet/icon;\n+                                                    alt configlet/title"\n+                                    i18n:attributes="alt">\n+                                <tal:icon tal:condition="not: icon_url"\n+                                          tal:replace="structure python:icons.tag(configlet[\'icon\'] or \'plone-controlpanel\', tag_alt=configlet[\'title\'])" />\n+                                ${configlet/title}\n+                              </a>\n+                            </li>\n+                          </tal:loop>\n+                        </ul>\n+                      </li>\n+                    </tal:group>\n+                  </ul>\n+                </div>\n+\n+                <metal:slot metal:define-slot="prefs_configlet_main" tal:content="nothing">\n+                  Page body text\n+                </metal:slot>\n+\n+              </metal:override>\n+            </metal:block>\n+\n+          </metal:slot>\n+        </metal:slot>\n+    </metal:override>\n+\n+  </tal:block>\n+</metal:page>\ndiff --git a/Products/CMFPlone/controlpanel/browser/prefsmaintemplate.py b/Products/CMFPlone/controlpanel/browser/prefsmaintemplate.py\nnew file mode 100644\nindex 0000000000..5423716bc0\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/browser/prefsmaintemplate.py\n@@ -0,0 +1,14 @@\n+from Products.Five import BrowserView\n+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n+\n+\n+class PrefsMainTemplate(BrowserView):\n+\n+    prefs_main_template_name = \'prefsmaintemplate.pt\'\n+\n+    def __call__(self):\n+        return ViewPageTemplateFile(self.prefs_main_template_name)\n+\n+    @property\n+    def macros(self):\n+        return ViewPageTemplateFile(self.prefs_main_template_name).macros\ndiff --git a/Products/CMFPlone/controlpanel/browser/quickinstaller.pt b/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\nindex 1f18ba6bfb..9b694c0a25 100644\n--- a/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\n+++ b/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\n@@ -7,228 +7,217 @@\n \n <body>\n \n-\n <metal:main metal:fill-slot="prefs_configlet_main" i18n:domain="plone">\n-\n-    <a id="setup-link" class="link-parent"\n-       tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-       i18n:translate="">\n-        Site Setup\n-    </a>\n+  <header>\n \n     <h1 class="documentFirstHeading"\n         i18n:translate="">Add-ons</h1>\n \n-    <div class="documentDescription"\n+    <p class="lead"\n        i18n:translate="">\n       This is the Add-on configuration section, you can activate and deactivate\n       add-ons in the lists below.\n-    </div>\n-\n-    <div id="content-core">\n-\n-        <p class="discreet" i18n:translate="">\n-          To make new add-ons show up here, add them to your buildout\n-          configuration, run buildout, and restart the server process.\n-          For detailed instructions see\n-          <span i18n:name="third_party_product">\n-          <a i18n:translate="" href="http://docs.plone.org/manage/installing/installing_addons.html">\n-            Installing a third party add-on\n-          </a>\n-          </span>.\n-        </p>\n-\n-        <section tal:define="products view/get_upgrades;\n-                         num_products python:len(products)"\n-             id="upgrade-products" class="portlet">\n-          <header class="portletHeader" i18n:translate="">Upgrades</header>\n-          <section tal:condition="not:products" class="portletContent">\n-            <div id="up-to-date-message" class="portalMessage info" role="status">\n-                 <strong i18n:translate="">No upgrades in this corner</strong>\n-                 <span i18n:translate="">You are up to date. High fives.</span>\n-             </div>\n-          </section>\n-          <section class="portletContent" tal:condition="products">\n-            <ul class="configlets">\n-              <tal:products  tal:repeat="product products">\n-              <li tal:define="pid product/id;">\n-                <form action="upgrade_products" method="post" class="pull-right">\n-                  <input type="hidden"\n-                                     name="prefs_reinstallProducts:list"\n-                                     tal:attributes="value pid;" />\n-                  <input class="standalone"\n-                         type="submit"\n-                         value="Upgrade ${pid}"\n-                         name="form.submitted"\n-                         i18n:attributes="value"\n-                         tal:attributes="value string:Upgrade ${pid};"/>\n-                </form>\n-                <h3>\n-                  <span tal:replace="product/title" i18n:translate="">\n-                    Add-on Name\n+    </p>\n+    <p class="discreet" i18n:translate="">\n+      To make new add-ons show up here, add them to your buildout\n+      configuration, run buildout, and restart the server process.\n+      For detailed instructions see\n+      <span i18n:name="third_party_product">\n+      <a i18n:translate="" href="http://docs.plone.org/manage/installing/installing_addons.html">\n+        Installing a third party add-on\n+      </a>\n+      </span>.\n+    </p>\n+  </header>\n+  <div id="content-core">\n+\n+\n+      <section tal:define="products view/get_upgrades;\n+                           num_products python:len(products)"\n+            id="upgrade-products" class="card mb-4">\n+        <header class="card-header" i18n:translate="">Upgrades</header>\n+          <div tal:condition="not:products" id="up-to-date-message" class="alert alert-info m-3 mb-0" role="status">\n+            <strong i18n:translate="">No upgrades in this corner.</strong>\n+            <span i18n:translate="">You are up to date. High fives.</span>\n+          </div>\n+        <ul tal:condition="products"\n+            class="configlets list-group list-group-flush">\n+          <tal:products tal:repeat="product products">\n+          <li tal:define="pid product/id;" class="list-group-item mt-2 pb-3">\n+            <form action="upgrade_products" method="post" class="float-end">\n+              <input type="hidden"\n+                      name="prefs_reinstallProducts:list"\n+                      tal:attributes="value pid;" />\n+              <input class="btn btn-secondary"\n+                      type="submit"\n+                      value="Upgrade ${pid}"\n+                      name="form.submitted"\n+                      i18n:attributes="value"\n+                      tal:attributes="value string:Upgrade ${pid};"/>\n+            </form>\n+            <h3>\n+              <span tal:replace="product/title" i18n:translate="">\n+                Add-on Name\n+              </span>\n+            </h3>\n+            <div class="configletDescription discreet">\n+              <tal:span tal:condition="product/description" tal:content="product/description" i18n:translate="">add-on description</tal:span>\n+              <em class="discreet"> \xe2\x80\x93 (<span tal:replace="pid">plugin.app.name</span> <span tal:replace="product/version">1.0</span>)</em>\n+            </div>\n+            <ul class="configletDetails list-group list-group-flush">\n+              <li tal:define="upgrade_info product/upgrade_info" class="list-group-item mt-2 pb-3">\n+                  <span i18n:translate="">\n+                    This addon has been upgraded.\n                   </span>\n-                </h3>\n-                <p class="configletDescription discreet">\n-                  <tal:span tal:condition="product/description" tal:content="product/description" i18n:translate="">add-on description</tal:span>\n-                  <em class="discreet"> \xe2\x80\x93 (<span tal:replace="pid">plugin.app.name</span> <span tal:replace="product/version">1.0</span>)</em>\n-                </p>\n-                <ul class="configletDetails">\n-                  <li tal:define="upgrade_info product/upgrade_info">\n-                      <span i18n:translate="">\n-                        This addon has been upgraded.\n-                      </span>\n-                      <span tal:condition="not:upgrade_info/hasProfile"\n-                            i18n:translate="label_product_upgrade_old_version">\n-                        Old version was <strong i18n:name="version" tal:content="upgrade_info/installedVersion">version</strong>.\n-                      </span>\n-                      <span tal:condition="upgrade_info/hasProfile">\n-                        <tal:span i18n:translate="label_product_upgrade_old_profile_version">\n-                          Old profile version was <strong i18n:name="version" tal:content="upgrade_info/installedVersion">version</strong>.\n-                        </tal:span>\n-                        <tal:span i18n:translate="label_product_upgrade_new_profile_version">\n-                          New profile version is <strong i18n:name="version" tal:content="upgrade_info/newVersion">version</strong>.\n-                        </tal:span>\n-                      </span>\n-\n-                      <div tal:condition="not:upgrade_info/available">\n-                        <strong i18n:translate="">Warning</strong>\n-                        <span i18n:translate="">There is no upgrade procedure defined for this\n-                        addon. Please consult the addon documentation\n-                        for upgrade information, or contact the addon\n-                        author.</span>\n-                      </div>\n-                  </li>\n-                </ul>\n-              </li>\n-              </tal:products>\n-              <li tal:condition="python:num_products > 1">\n-                <form action="upgrade_products" method="post">\n-                   <tal:products  tal:repeat="product products">\n-                   <input type="hidden" value="product"\n-                          name="prefs_reinstallProducts:list"\n-                          tal:attributes="value product/id;" />\n-                   </tal:products>\n-                   <span>\n-                     <div i18n:translate="label_product_upgrade_all_action">This can be risky, are you sure you want to do this?</div>\n-                     <input class="context"\n-                            type="submit"\n-                            i18n:attributes="value"\n-                            value="Upgrade them ALL!"\n-                            name="form.submitted" />\n-                   </span>\n-                </form>\n-               </li>\n-              </ul>\n-          </section>\n-        </section>\n-\n-        <section tal:define="products view/get_available;\n-                         num_products python:len(products)"\n-             id="install-products" class="portlet">\n-          <header class="portletHeader" i18n:translate="">Available add-ons</header>\n-          <section class="portletContent">\n-            <ul class="configlets">\n-              <li tal:repeat="product products">\n-              <tal:product define="pid product/id">\n-                <form action="install_products" method="post" class="pull-right">\n-                   <input type="hidden"\n-                           name="install_product"\n-                           tal:attributes="value pid;" />\n-                   <input class="context"\n-                           type="submit"\n-                           value="Install"\n-                           name="form.submitted"\n-                           i18n:attributes="value"/>\n-                </form>\n-\n-                <h3>\n-                  <span tal:replace="product/title" i18n:translate="">\n-                    Add-on Name\n+                  <span tal:condition="not:upgrade_info/hasProfile"\n+                        i18n:translate="label_product_upgrade_old_version">\n+                    Old version was <strong i18n:name="version" tal:content="upgrade_info/installedVersion">version</strong>.\n                   </span>\n-                </h3>\n-                <p class="configletDescription discreet">\n-                  <tal:span tal:condition="product/description"\n-                    i18n:translate=""\n-                    tal:content="product/description">add-on description</tal:span>\n-                  <em class="discreet"> \xe2\x80\x93 (<span tal:replace="pid">plugin.app.name</span> <span tal:replace="product/version">1.0</span>)</em>\n-                </p>\n-                <dl class="portalMessage warning"\n-                    role="status"\n-                    tal:condition="not:product/uninstall_profile">\n-                  <dt i18n:translate="">Warning</dt>\n-                  <dd i18n:translate="">This product cannot be uninstalled!</dd>\n-                </dl>\n-              </tal:product>\n-              </li>\n-            </ul>\n-          </section>\n-        </section>\n-\n-        <section tal:define="products view/get_installed;\n-                         num_products python:len(products)"\n-             id="activated-products" class="portlet">\n-          <header class="portletHeader" i18n:translate="">Activated add-ons</header>\n-          <section class="portletContent">\n-            <ul class="configlets">\n-                <li tal:repeat="product products">\n-                <tal:product define="pid product/id">\n-                  <form action="uninstall_products" method="post" class="pull-right">\n-                    <input type="hidden"\n-                          name="uninstall_product"\n-                          tal:attributes="value pid;" />\n-                    <input class="destructive"\n-                           type="submit"\n-                           value="Uninstall"\n-                           name="form.submitted"\n-                           tal:condition="product/uninstall_profile"\n-                           i18n:attributes="value"/>\n-                  </form>\n-                    <h3>\n-                      <span tal:replace="product/title" i18n:translate="">\n-                        Add-on Name\n-                      </span>\n-                    </h3>\n-                    <p class="configletDescription discreet">\n-                      <tal:span tal:condition="product/description"\n-                        i18n:translate=""\n-                        tal:content="product/description">add-on description</tal:span>\n-                      <em class="discreet"> \xe2\x80\x93 (<span tal:replace="pid">plugin.app.name</span> <span tal:replace="product/version">1.0</span>)</em>\n-                    </p>\n-                    <dl class="portalMessage info"\n-                        role="status"\n-                        tal:condition="not:product/uninstall_profile">\n-                      <dt i18n:translate="">Info</dt>\n-                      <dd i18n:translate="">This product cannot be uninstalled!</dd>\n-                    </dl>\n-                </tal:product>\n-                </li>\n-              </ul>\n-          </section>\n-        </section>\n-\n-        <section tal:define="products view/get_broken;\n-                             num_products python:len(products);"\n-                 tal:condition="num_products"\n-                 id="broken-products" class="portlet">\n-          <header class="portletHeader" i18n:translate="">Broken add-ons</header>\n-          <section class="portletContent">\n-            <ul class="configlets">\n-              <li tal:repeat="product products">\n-                <h3>\n-                  <span tal:replace="product/product_id" i18n:translate="">\n-                    Add-on Name\n+                  <span tal:condition="upgrade_info/hasProfile">\n+                    <tal:span i18n:translate="label_product_upgrade_old_profile_version">\n+                      Old profile version was <strong i18n:name="version" tal:content="upgrade_info/installedVersion">version</strong>.\n+                    </tal:span>\n+                    <tal:span i18n:translate="label_product_upgrade_new_profile_version">\n+                      New profile version is <strong i18n:name="version" tal:content="upgrade_info/newVersion">version</strong>.\n+                    </tal:span>\n                   </span>\n-                </h3>\n-                <p class="configletDescription discreet">\n-                  <span tal:content="product/type" i18n:translate="">Error Type</span>\n-                  <em class="discreet"> - <tal:span tal:content="product/value" i18n:translate="">Error Reason</tal:span></em>\n-                </p>\n+\n+                  <div tal:condition="not:upgrade_info/available">\n+                    <strong i18n:translate="">Warning</strong>\n+                    <span i18n:translate="">There is no upgrade procedure defined for this\n+                    addon. Please consult the addon documentation\n+                    for upgrade information, or contact the addon\n+                    author.</span>\n+                  </div>\n               </li>\n             </ul>\n-          </section>\n-        </section>\n-\n-    </div>\n+          </li>\n+          </tal:products>\n+          <li tal:condition="python:num_products > 1" class="list-group-item mt-2 pb-3">\n+            <form action="upgrade_products" method="post">\n+                <tal:products  tal:repeat="product products">\n+                <input type="hidden" value="product"\n+                      name="prefs_reinstallProducts:list"\n+                      tal:attributes="value product/id;" />\n+                </tal:products>\n+                <span>\n+                  <div i18n:translate="label_product_upgrade_all_action">This can be risky, are you sure you want to do this?</div>\n+                  <input class="btn btn-primary"\n+                        type="submit"\n+                        i18n:attributes="value"\n+                        value="Upgrade them ALL!"\n+                        name="form.submitted" />\n+                </span>\n+            </form>\n+            </li>\n+          </ul>\n+      </section>\n+\n+      <section tal:define="products view/get_available;\n+                        num_products python:len(products)"\n+            id="install-products" class="card mb-4">\n+        <header class="card-header" i18n:translate="">Available add-ons</header>\n+        <ul class="configlets list-group list-group-flush">\n+          <li tal:repeat="product products" class="list-group-item mt-2 pb-3">\n+          <tal:product define="pid product/id">\n+            <form action="install_products" method="post" class="float-end">\n+                <input type="hidden"\n+                        name="install_product"\n+                        tal:attributes="value pid;" />\n+                <button class="btn btn-sm btn-primary"\n+                        type="submit"\n+                        value="Install"\n+                        name="form.submitted"\n+                        i18n:translate="">\n+                    Install\n+                </button>\n+            </form>\n+\n+            <h3>\n+              <span tal:replace="product/title" i18n:translate="">\n+                Add-on Name\n+              </span>\n+            </h3>\n+            <div class="configletDescription discreet">\n+              <tal:span tal:condition="product/description"\n+                i18n:translate=""\n+                tal:content="product/description">add-on description</tal:span>\n+              <em class="discreet"> \xe2\x80\x93 (<span tal:replace="pid">plugin.app.name</span> <span tal:replace="product/version">1.0</span>)</em>\n+            </div>\n+            <div class="alert alert-warning mt-2 mb-0"\n+                role="status"\n+                tal:condition="not:product/uninstall_profile">\n+              <strong i18n:translate="">Warning</strong>\n+              <span i18n:translate="">This product cannot be uninstalled!</span>\n+            </div>\n+          </tal:product>\n+          </li>\n+        </ul>\n+      </section>\n+\n+      <section tal:define="products view/get_installed;\n+                           num_products python:len(products)"\n+            id="activated-products" class="card mb-4">\n+        <header class="card-header" i18n:translate="">Activated add-ons</header>\n+        <ul class="configlets list-group list-group-flush">\n+          <li tal:repeat="product products" class="list-group-item mt-2 pb-3">\n+          <tal:product define="pid product/id">\n+            <form action="uninstall_products" method="post" class="float-end">\n+              <input type="hidden"\n+                    name="uninstall_product"\n+                    tal:attributes="value pid;" />\n+              <button class="btn btn-sm btn-danger"\n+                      type="submit"\n+                      value="Uninstall"\n+                      name="form.submitted"\n+                      tal:condition="product/uninstall_profile"\n+                      i18n:translate="">\n+                Uninstall\n+              </button>\n+            </form>\n+              <h3>\n+                <span tal:replace="product/title" i18n:translate="">\n+                  Add-on Name\n+                </span>\n+              </h3>\n+              <div class="configletDescription discreet">\n+                <tal:span tal:condition="product/description"\n+                  i18n:translate=""\n+                  tal:content="product/description">add-on description</tal:span>\n+                <em class="discreet"> \xe2\x80\x93 (<span tal:replace="pid">plugin.app.name</span> <span tal:replace="product/version">1.0</span>)</em>\n+              </div>\n+              <div class="alert alert-info mt-2 mb-0"\n+                  role="status"\n+                  tal:condition="not:product/uninstall_profile">\n+                <strong i18n:translate="">Info</strong>\n+                <span i18n:translate="">This product cannot be uninstalled!</span>\n+            </div>\n+          </tal:product>\n+          </li>\n+        </ul>\n+      </section>\n+\n+      <section tal:define="products view/get_broken;\n+                            num_products python:len(products);"\n+                tal:condition="num_products"\n+                id="broken-products" class="card mb-4">\n+        <header class="card-header" i18n:translate="">Broken add-ons</header>\n+        <ul class="configlets list-group list-group-flush">\n+          <li tal:repeat="product products" class="list-group-item mt-2 pb-3">\n+            <h3>\n+              <span tal:replace="product/product_id" i18n:translate="">\n+                Add-on Name\n+              </span>\n+            </h3>\n+            <div class="configletDescription discreet">\n+              <span tal:content="product/type" i18n:translate="">Error Type</span>\n+              <em class="discreet"> - <tal:span tal:content="product/value" i18n:translate="">Error Reason</tal:span></em>\n+            </div>\n+          </li>\n+        </ul>\n+      </section>\n+\n+  </div>\n </metal:main>\n \n </body>\ndiff --git a/Products/CMFPlone/controlpanel/browser/quickinstaller.py b/Products/CMFPlone/controlpanel/browser/quickinstaller.py\nindex 7931ae5839..3a8b574afb 100644\n--- a/Products/CMFPlone/controlpanel/browser/quickinstaller.py\n+++ b/Products/CMFPlone/controlpanel/browser/quickinstaller.py\n@@ -1,12 +1,13 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import INonInstallable\n+from plone.base.interfaces import INonInstallable\n from Products.Five.browser import BrowserView\n from Products.GenericSetup import EXTENSION\n from Products.GenericSetup.tool import UNKNOWN\n from Products.statusmessages.interfaces import IStatusMessage\n from plone.memoize import view\n from zope.component import getAllUtilitiesRegisteredFor\n+from zope.i18n import translate\n import logging\n import pkg_resources\n import transaction\n@@ -487,20 +488,24 @@ def get_addons(self, apply_filter=None, product_name=None):\n \n         return filtered\n \n+    def get_sorted_addon_values(self, apply_filter=None, product_name=None):\n+        values = self.get_addons(apply_filter, product_name).values()\n+        return sorted(values, key=lambda x: translate(x.get(\'title\', \'\'), context=self.request).upper())\n+\n     def get_upgrades(self):\n         """\n         Return a list of products that have upgrades on tap\n         """\n-        return self.get_addons(apply_filter=\'upgrades\').values()\n+        return self.get_sorted_addon_values(apply_filter=\'upgrades\')\n \n     def get_installed(self):\n-        return self.get_addons(apply_filter=\'installed\').values()\n+        return self.get_sorted_addon_values(apply_filter=\'installed\')\n \n     def get_available(self):\n-        return self.get_addons(apply_filter=\'available\').values()\n+        return self.get_sorted_addon_values(apply_filter=\'available\')\n \n     def get_broken(self):\n-        return self.get_addons(apply_filter=\'broken\').values()\n+        return self.get_sorted_addon_values(apply_filter=\'broken\')\n \n \n class UpgradeProductsView(InstallerView):\ndiff --git a/Products/CMFPlone/controlpanel/browser/redirects-controlpanel.pt b/Products/CMFPlone/controlpanel/browser/redirects-controlpanel.pt\nindex 980c57d337..96a4ef99bf 100644\n--- a/Products/CMFPlone/controlpanel/browser/redirects-controlpanel.pt\n+++ b/Products/CMFPlone/controlpanel/browser/redirects-controlpanel.pt\n@@ -7,16 +7,21 @@\n       i18n:domain="plone">\n \n   <body>\n-    <div metal:fill-slot="prefs_configlet_main">\n-      <dl\n-          tal:condition="view/csv_errors|nothing"\n-          class="portalMessage error">\n-        <dt i18n:translate="">Error</dt>\n-        <dd>\n-          <p i18n:translate="error_bulk_upload">\n+    <tal:main metal:fill-slot="prefs_configlet_main">\n+      <header>\n+\n+        <h1 i18n:translate="">\n+          URL Management\n+        </h1>\n+\n+        <div class="alert alert-danger mt-3 mb-4" role="alert"\n+             tal:condition="view/csv_errors|nothing">\n+          <div i18n:translate="" class="font-weight-bold">Error</div>\n+          <span i18n:translate="error_bulk_upload">\n             No alternative urls were added. Please correct these errors in your CSV file and try again:\n-          </p>\n-          <table\n+          </span>\n+          <hr>\n+          <table class="text-break"\n               style="text-align: left; vertical-align: top"\n               border="0"\n               cellpadding="2"\n@@ -40,113 +45,114 @@\n               </td>\n             </tr>\n           </table>\n-        </dd>\n-      </dl>\n \n-      <h1 i18n:translate="">\n-        URL Management\n-      </h1>\n+        </div>\n \n-      <form\n+      </header>\n+      <form class="mb-4"\n           action="${view/view_url}"\n           method="post">\n-        <fieldset>\n+        <fieldset class="mb-3">\n           <legend i18n:translate="add_alias">\n             Add a new alternative url\n           </legend>\n-          <p i18n:translate="description_change_primary_url">To change the primary url of content, use Actions > Rename.</p>\n+          <p class="text-muted" i18n:translate="description_change_primary_url">\n+            To change the primary url of content, use Actions > Rename.\n+          </p>\n \n-          <div class="field"\n+          <div class="field mb-3"\n                tal:define="error view/form_errors/redirection|nothing"\n-               tal:attributes="class python:error and \'field error\' or \'field\'">\n-\n-          <label\n-              for="redirection"\n-              i18n:translate="label_alias">\n-            Alternative url path\n-          </label>\n-\n-          <span\n-              class="fieldRequired"\n-              title="Required"\n-              i18n:attributes="title"\n-              i18n:translate="label_required">\n-            (Required)\n-          </span>\n+               tal:attributes="class python:error and \'field mb-3 error\' or \'field mb-3\'">\n \n-            <div tal:content="error">\n+            <label class="form-label" for="redirection">\n+              <span i18n:translate="label_alias">Alternative url path</span>\n+              <span\n+                class="required fieldRequired"\n+                title="Required"\n+                i18n:attributes="title label_required">\n+              </span>\n+            </label>\n+\n+            <input class="form-control"\n+                type="text"\n+                name="redirection"\n+                value=""\n+                size="40"\n+                required\n+                tal:attributes="value request/redirection | nothing;\n+                                class python:error and \'form-control is-invalid\' or \'form-control\'"/>\n+\n+            <div class="invalid-feedback"\n+              tal:content="error"\n+              tal:condition="error">\n               Validation error output\n             </div>\n \n-          <div class="formHelp" i18n:translate="help_alias">\n-            Enter the absolute path where the alternative url should exist. The path must start with \'/\'.\n-            Only urls that result in a 404 not found page will result in a redirect occurring.\n-          </div>\n+            <small class="formHelp form-text text-muted" i18n:translate="help_alias">\n+              Enter the absolute path where the alternative url should exist. The path must start with \'/\'.\n+              Only urls that result in a 404 not found page will result in a redirect occurring.\n+            </small>\n \n-          <input\n-              type="text"\n-              name="redirection"\n-              value="#"\n-              size="40"\n-              tal:attributes="value request/redirection | nothing;"/>\n           </div>\n \n-          <div class="field"\n+          <div class="field mb-3"\n                tal:define="error view/form_errors/target_path|nothing"\n-               tal:attributes="class python:error and \'field error\' or \'field\'">\n-\n-          <label for="target_path"\n-              i18n:translate="label_target_path">\n-              Target Path\n-          </label>\n-\n-          <span\n-              class="fieldRequired"\n-              title="Required"\n-              i18n:attributes="title"\n-              i18n:translate="label_required">\n-            (Required)\n-          </span>\n+               tal:attributes="class python:error and \'field mb-3 error\' or \'field mb-3\'">\n+\n+            <label class="form-label" for="target_path">\n+              <span i18n:translate="label_target_path">Target Path</span>\n+              <span\n+                  class="required fieldRequired"\n+                  title="Required"\n+                  i18n:attributes="title label_required">\n+              </span>\n+            </label>\n \n-            <div tal:content="error">\n+            <input class="form-control"\n+                type="text"\n+                name="target_path"\n+                value=""\n+                size="40"\n+                required\n+                tal:attributes="value request/target_path | nothing;\n+                                class python:error and \'form-control is-invalid\' or \'form-control\'""/>\n+\n+            <div class="invalid-feedback"\n+              tal:content="error"\n+              tal:condition="error">\n               Validation error output\n             </div>\n \n-          <div class="formHelp" i18n:translate="help_target_path">\n-            Enter the absolute path of the target. The path must start with \'/\'.\n-            Target must exist or be an existing alternative url path to the target.\n-          </div>\n+            <small class="formHelp form-text text-muted" i18n:translate="help_target_path">\n+              Enter the absolute path of the target. The path must start with \'/\'.\n+              Target must exist or be an existing alternative url path to the target.\n+            </small>\n \n-          <input\n-              type="text"\n-              name="target_path"\n-              value="#"\n-              size="40"\n-              tal:attributes="value request/target_path | nothing;"/>\n           </div>\n \n           <div class="formControls">\n-            <input class="context"\n-                   type="submit"\n-                   value="Add"\n-                   name="form.button.Add"\n-                   i18n:attributes="value" />\n+            <button class="btn btn-success"\n+              type="submit"\n+              value="Add"\n+              name="form.button.Add">\n+              <tal:icon tal:replace="structure python:icons.tag(\'plus\', tag_alt=\'Add\')" /> <span i18n:translate="">Add</span>\n+            </button>\n           </div>\n \n         </fieldset>\n       </form>\n \n \n-      <form\n+      <form class="mb-4"\n           action="${view/view_url}"\n           method="post"\n           enctype="multipart/form-data">\n-        <fieldset>\n+        <fieldset class="mb-3">\n           <legend i18n:translate="legend_bulk_upload">\n             Bulk-upload alternative urls\n           </legend>\n \n-          <p i18n:translate="description_bulk_upload">\n+          <p class="text-muted" i18n:translate="description_bulk_upload">\n             Add many alternative urls at once by uploading a CSV file. The first column should be the path to\n             redirect from; the second, the path to redirect to. Both paths must be Plone-site-relative,\n             starting with a slash (/). An optional third colum can contain a date and time.\n@@ -160,132 +166,151 @@\n             </code>\n           </p>\n \n-          <div class="field"\n+          <div class="field mb-3"\n                tal:define="error view/form_errors/file|nothing"\n-               tal:attributes="class python:error and \'field error\' or \'field\'">\n-            <label\n-                for="file"\n-                i18n:translate="label_csv_file">\n-              CSV file\n-            </label>\n+               tal:attributes="class python:error and \'field mb-3 error\' or \'field mb-3\'">\n \n-            <span\n-                class="fieldRequired"\n+            <label class="form-label" for="file" class="form-label">\n+              <span i18n:translate="label_csv_file">CSV file</span>\n+              <span\n+                class="required fieldRequired"\n                 title="Required"\n-                i18n:attributes="title"\n-                i18n:translate="label_required">\n-              (Required)\n-            </span>\n+                i18n:attributes="title label_required">\n+              </span>\n+            </label>\n \n-            <div tal:content="error">\n-              Validation error output\n-            </div>\n-            <input\n+            <input class="form-control"\n               type="file"\n-              name="file" />\n+              name="file"\n+              required\n+              tal:attributes="class python:error and \'form-control is-invalid\' or \'form-control\'" />\n+\n+            <div class="invalid-feedback"\n+              tal:content="error"\n+              tal:condition="error">\n+                Validation error output\n+            </div>\n+\n           </div>\n \n           <div class="formControls">\n-            <input\n-                class="context"\n-                type="submit"\n-                value="Upload"\n-                name="form.button.Upload"\n-                i18n:attributes="value"\n-              />\n+            <button\n+              class="btn btn-success"\n+              type="submit"\n+              value="Upload"\n+              name="form.button.Upload">\n+              <tal:icon tal:replace="structure python:icons.tag(\'upload\', tag_alt=\'Upload\')" /> <span i18n:translate="">Upload</span>\n+            </button>\n           </div>\n \n         </fieldset>\n       </form>\n \n-      <form\n+      <form class="mb-4"\n           action="${view/view_url}#manage-existing-aliases"\n           method="post"\n           id="manage-existing-aliases">\n-        <fieldset\n+        <fieldset class="mb-3"\n           tal:define="batch view/redirects">\n           <legend i18n:translate="legend_all_existing_aliases">\n             All existing alternative urls for this site\n           </legend>\n \n-          <div>\n-            <input\n-                class="context"\n+          <div class="mb-4">\n+            <button\n+                class="btn btn-primary context"\n                 type="submit"\n                 value="Download all as CSV"\n-                name="form.button.Download"\n-                i18n:attributes="value"\n-              />\n+                name="form.button.Download">\n+                <tal:icon tal:replace="structure python:icons.tag(\'download\', tag_alt=\'Download\')" /> <span i18n:translate="">Download all as CSV</span>\n+            </button>\n           </div>\n \n-          <label for="filter-existing-aliases-q" i18n:translate="">Filter by prefix</label>\n-          <input\n-              type="text"\n-              name="q"\n-              value=""\n-              id="filter-existing-aliases-q"\n-               tal:attributes="value python:request.form.get(\'q\', \'/\')"/>\n-          <label for="filter-existing-aliases-manual" i18n:translate="">Manually or automatically added?</label>\n-          <div\n-              id="filter-existing-aliases-manual"\n-              tal:define="chosen python:request.form.get(\'manual\', \'\')">\n-              <input type="radio" name="manual" id="manual-both" value="" tal:attributes="checked python:chosen==\'\'">\n-              <label for="manual-both" i18n:translate="">Both</label><br />\n-              <input type="radio" name="manual" id="manual-no" value="no" tal:attributes="checked python:chosen==\'no\'">\n-              <label for="manual-no" i18n:translate="">Automatically</label><br />\n-              <input type="radio" name="manual" id="manual-yes" value="yes" tal:attributes="checked python:chosen==\'yes\'">\n-              <label for="manual-yes" i18n:translate="">Manually</label>\n+          <div class="mb-3">\n+            <label class="form-label" for="filter-existing-aliases-q" i18n:translate="">Filter by prefix</label>\n+            <input class="form-control"\n+                type="text"\n+                name="q"\n+                value=""\n+                id="filter-existing-aliases-q"\n+                tal:attributes="value python:request.form.get(\'q\', \'/\')"/>\n           </div>\n-          <label for="filter-existing-aliases-date" i18n:translate="">Created before</label>\n-          <input type="date" id="filter-existing-aliases-date" name="datetime"\n-               tal:attributes="value python:request.form.get(\'datetime\', \'\')"/>\n-          <div class="formControls">\n-            <input\n-                class="context"\n-                type="submit"\n-                value="Filter"\n-                name="form.button.filter"\n-                 i18n:attributes="value" />\n+\n+          <div class="mb-3">\n+            <label class="form-label" for="filter-existing-aliases-manual" i18n:translate="">Manually or automatically added?</label>\n+            <div class="form-check"\n+            id="filter-existing-aliases-manual"\n+            tal:define="chosen python:request.form.get(\'manual\', \'\')">\n+            <input type="radio" name="manual" id="manual-both" class="form-check-input" value="" tal:attributes="checked python:chosen==\'\'">\n+            <label for="manual-both" class="form-check-label" i18n:translate="">Both</label><br />\n+            <input type="radio" name="manual" id="manual-no" class="form-check-input" value="no" tal:attributes="checked python:chosen==\'no\'">\n+            <label for="manual-no" class="form-check-label" i18n:translate="">Automatically</label><br />\n+            <input type="radio" name="manual" id="manual-yes" class="form-check-input" value="yes" tal:attributes="checked python:chosen==\'yes\'">\n+            <label for="manual-yes" class="form-check-label" i18n:translate="">Manually</label>\n+          </div>\n+        </div>\n+\n+        <div class="mb-3">\n+          <label class="form-label" for="filter-existing-aliases-date" i18n:translate="">Created before</label>\n+          <input type="date" id="filter-existing-aliases-date" class="form-control" name="datetime"\n+          tal:attributes="value python:request.form.get(\'datetime\', \'\')"/>\n+        </div>\n+\n+          <div class="formControls mb-4">\n+            <button\n+              class="btn btn-primary"\n+              type="submit"\n+              value="Filter"\n+              name="form.button.filter">\n+              <tal:icon tal:replace="structure python:icons.tag(\'filter\', tag_alt=\'Filter\')" /> <span i18n:translate="">Filter</span>\n+            </button>\n           </div>\n \n-          <div class="field"\n+          <div class="field mb-3"\n                tal:define="error view/form_errors/remove_redirects|nothing"\n-               tal:attributes="class python:error and \'field error\' or \'field\'"\n-               tal:content="error" />\n+               tal:attributes="class python:error and \'field mb-3 error\' or \'field mb-3\'"\n+               tal:content="error"\n+               tal:condition="error" />\n \n-          <p i18n:translate="">Alternative url path &rarr; target url path (date and time of creation, manually created yes/no) </p>\n+        <div class="mb-4">\n+          <p><small i18n:translate="">Alternative url path &rarr; target url path <span class="text-muted">(date and time of creation, manually created yes/no)</span></small></p>\n           <tal:redirects repeat="redirect batch">\n-            <div>\n-              <label>\n+            <div class="form-check">\n+              <label class="form-check-label">\n               <input\n                   type="checkbox"\n-                  class="noborder"\n+                  class="form-check-input noborder"\n                   name="redirects:tuple"\n                   value="${redirect/redirect}" />\n-              ${redirect/path} &rarr; ${redirect/redirect-to} (${redirect/datetime}, ${redirect/manual})\n+              ${redirect/path} &rarr; ${redirect/redirect-to} <span class="text-muted">(${redirect/datetime}, ${redirect/manual})</span>\n               </label>\n             </div>\n           </tal:redirects>\n+        </div>\n \n+        <div class="justify-content-center mb-4">\n           <div tal:condition="python:batch.numpages > 1"\n                tal:replace="structure view/batching">\n           </div>\n+        </div>\n \n           <div class="formControls">\n-            <input class="context"\n-                   type="submit"\n-                   value="Remove selected"\n-                   name="form.button.Remove"\n-                   i18n:attributes="value" />\n-            <input class="context"\n-                   type="submit"\n-                   value="Remove all that match filter"\n-                   name="form.button.MatchRemove"\n-                   i18n:attributes="value" />\n+            <button class="btn btn-danger"\n+              type="submit"\n+              value="Remove selected"\n+              name="form.button.Remove">\n+                <tal:icon tal:replace="structure python:icons.tag(\'trash\', tag_alt=\'Trash\')" /> <span i18n:translate="">Remove selected</span>\n+            </button>\n+            <button class="btn btn-danger"\n+              type="submit"\n+              value="Remove all that match filter"\n+              name="form.button.MatchRemove">\n+                <tal:icon tal:replace="structure python:icons.tag(\'trash\', tag_alt=\'Trash\')" /> <span i18n:translate="">Remove all that match filter</span>\n+            </button>\n           </div>\n \n         </fieldset>\n       </form>\n-    </div>\n+    </tal:main>\n   </body>\n </html>\ndiff --git a/Products/CMFPlone/controlpanel/browser/redirects-manage.pt b/Products/CMFPlone/controlpanel/browser/redirects-manage.pt\nindex 90c4c3b4f5..9df9e7d0d5 100644\n--- a/Products/CMFPlone/controlpanel/browser/redirects-manage.pt\n+++ b/Products/CMFPlone/controlpanel/browser/redirects-manage.pt\n@@ -7,125 +7,131 @@\n       i18n:domain="plone">\n \n   <body>\n-    <div\n+    <tal:main\n         metal:fill-slot="main"\n         tal:define="context_state context/@@plone_context_state">\n-      <h1\n-          class="documentFirstHeading"\n-          i18n:translate="">\n-        URL Management\n-      </h1>\n+      <header>\n+        <h1\n+            class="documentFirstHeading"\n+            i18n:translate="">\n+          URL Management\n+        </h1>\n \n-      <dl\n-          class="portalMessage info"\n-          tal:condition="context_state/is_default_page">\n-        <dt i18n:translate="">\n-          Info\n-        </dt>\n-        <dd i18n:translate="help_aliases">\n-          You are managing the alternative urls of a default view in a container.\n-          To manage them for the entire container,\n-          <a\n-              i18n:name="go_here"\n-              i18n:translate="help_aliases_go_here"\n-              tal:define="folder context_state/folder"\n-              tal:attributes="href string:${folder/absolute_url}/@@manage-aliases">\n-            go here\n-          </a>.\n-        </dd>\n-      </dl>\n+        <dl\n+            class="portalMessage info"\n+            tal:condition="context_state/is_default_page">\n+          <dt i18n:translate="">\n+            Info\n+          </dt>\n+          <dd i18n:translate="help_aliases">\n+            You are managing the alternative urls of a default view in a container.\n+            To manage them for the entire container,\n+            <a\n+                i18n:name="go_here"\n+                i18n:translate="help_aliases_go_here"\n+                tal:define="folder context_state/folder"\n+                tal:attributes="href string:${folder/absolute_url}/@@manage-aliases">\n+              go here\n+            </a>.\n+          </dd>\n+        </dl>\n \n-      <p i18n:translate="description_adding_aliases">\n-        Using this form, you can manage alternative urls for an item. This\n-        is an easy way to make an item available under two different URLs.\n-      </p>\n-      <p i18n:translate="description_change_primary_url">To change the primary url of content, use Actions > Rename.</p>\n+        <p i18n:translate="description_adding_aliases">\n+          Using this form, you can manage alternative urls for an item. This\n+          is an easy way to make an item available under two different URLs.\n+        </p>\n+        <p i18n:translate="description_change_primary_url">To change the primary url of content, use Actions > Rename.</p>\n \n-      <form\n+      </header>\n+\n+      <form class="mb-4"\n           action="${view/view_url}"\n           method="post">\n-        <fieldset>\n+        <fieldset class="mb-3">\n           <legend i18n:translate="add_alias">\n             Add a new alternative url\n           </legend>\n \n-          <div class="field"\n+          <div class="field mb-3"\n                tal:define="error options/errors/redirection|nothing"\n-               tal:attributes="class python:error and \'field error\' or \'field\'">\n-            <label\n-                for="redirection"\n-                i18n:translate="label_alias">\n-              Alternative url path\n-            </label>\n-\n-            <span\n-                class="fieldRequired"\n+               tal:attributes="class python:error and \'field mb-3 error\' or \'field mb-3\'">\n+            <label class="form-label" for="redirection">\n+              <span i18n:translate="label_alias">Alternative url path</span>\n+              <span\n+                class="required fieldRequired"\n                 title="Required"\n-                i18n:attributes="title"\n-                i18n:translate="label_required">\n-              (Required)\n-            </span>\n-\n-            <div tal:content="error">\n-              Validation error output\n-            </div>\n+                i18n:attributes="title label_required">\n+              </span>\n+            </label>\n \n-            <div class="formHelp" i18n:translate="help_alias">\n-              Enter the absolute path where the alternative url should exist. The path must start with \'/\'.\n-              Only urls that result in a 404 not found page will result in a redirect occurring.\n+            <div class="invalid-feedback"\n+              tal:content="error"\n+              tal:condition="error">\n+                Validation error output\n             </div>\n \n             <input\n                 type="text"\n                 name="redirection"\n-                value="#"\n+                value=""\n                 size="40"\n                 tal:attributes="value request/redirection | nothing;"/>\n+\n+              <small class="formHelp form-text text-muted" i18n:translate="help_alias">\n+                Enter the absolute path where the alternative url should exist. The path must start with \'/\'.\n+                Only urls that result in a 404 not found page will result in a redirect occurring.\n+              </small>\n           </div>\n+\n           <div class="formControls">\n-            <input\n-                class="context"\n-                type="submit"\n-                value="Add"\n-                name="form.button.Add"\n-                i18n:attributes="value" />\n+            <button\n+              class="btn btn-success"\n+              type="submit"\n+              value="Add"\n+              name="form.button.Add">\n+              <tal:icon tal:replace="structure python:icons.tag(\'plus\', tag_alt=\'Add\')" /> <span i18n:translate="">Add</span>\n+            </button>\n           </div>\n \n         </fieldset>\n       </form>\n \n-      <form\n+      <form class="mb-4"\n           action="${view/view_url}"\n+          tal:condition="python:[x for c, x in enumerate(view.redirects()) if c < 2]"\n           method="post">\n-        <fieldset>\n+        <fieldset class="mb-3">\n           <legend i18n:translate="legend_existing_aliases">\n             Existing alternative urls for this item\n           </legend>\n \n-          <tal:redirects repeat="redirect view/redirects">\n-            <div>\n-              <label>\n-              <input\n-                  type="checkbox"\n-                  class="noborder"\n-                  name="redirects:tuple"\n-                  value="${redirect/redirect}" />\n-                ${redirect/path}\n-              </label>\n-            </div>\n-          </tal:redirects>\n+          <div class="mb-3">\n+            <tal:redirects repeat="redirect view/redirects">\n+              <div class="form-check">\n+                <label class="form-check-label">\n+                <input\n+                    type="checkbox"\n+                    class="form-check-input noborder"\n+                    name="redirects:tuple"\n+                    value="${redirect/redirect}" />\n+                  ${redirect/path}\n+                </label>\n+              </div>\n+            </tal:redirects>\n+          </div>\n \n           <div class="formControls">\n-            <input\n-                class="context"\n-                type="submit"\n-                value="Remove"\n-                name="form.button.Remove"\n-                i18n:attributes="value" />\n+            <button\n+              class="btn btn-danger"\n+              type="submit"\n+              value="Remove"\n+              name="form.button.Remove">\n+              <tal:icon tal:replace="structure python:icons.tag(\'trash\', tag_alt=\'Trash\')" /> <span i18n:translate="">Remove</span>\n+            </button>\n           </div>\n \n         </fieldset>\n       </form>\n-    </div>\n+    </tal:main>\n   </body>\n </html>\ndiff --git a/Products/CMFPlone/controlpanel/browser/redirects.py b/Products/CMFPlone/controlpanel/browser/redirects.py\nindex e4aa52ff7e..e1488abf06 100644\n--- a/Products/CMFPlone/controlpanel/browser/redirects.py\n+++ b/Products/CMFPlone/controlpanel/browser/redirects.py\n@@ -1,15 +1,15 @@\n+from csv import writer\n from DateTime import DateTime\n from DateTime.interfaces import DateTimeError\n-from csv import writer\n+from io import StringIO\n from plone.app.redirector.interfaces import IRedirectionStorage\n+from plone.base.batch import Batch\n+from plone.base.utils import safe_text\n from plone.batching.browser import PloneBatchView\n from plone.memoize.view import memoize\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.PloneBatch import Batch\n-from Products.CMFPlone.utils import safe_text\n from Products.Five.browser import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\n-from io import StringIO\n from urllib.parse import urlparse\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n@@ -271,7 +271,7 @@ def redirects(self):\n                 created=self.request.form.get(\'datetime\', \'\'),\n                 manual=self.request.form.get(\'manual\', \'\'),\n             ),\n-            15,\n+            int(self.request.form.get(\'b_size\', \'15\')),\n             int(self.request.form.get(\'b_start\', \'0\')),\n             orphan=1,\n         )\ndiff --git a/Products/CMFPlone/controlpanel/browser/relations.py b/Products/CMFPlone/controlpanel/browser/relations.py\nnew file mode 100644\nindex 0000000000..03aa2141dc\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/browser/relations.py\n@@ -0,0 +1,93 @@\n+from collections import defaultdict\n+from operator import itemgetter\n+from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.relationhelper import get_relations_stats\n+from Products.CMFPlone.relationhelper import rebuild_relations\n+from Products.Five.browser import BrowserView\n+from Products.statusmessages.interfaces import IStatusMessage\n+from zc.relation.interfaces import ICatalog\n+from zope.annotation.interfaces import IAnnotations\n+from zope.component import getUtility\n+from zope.component import queryUtility\n+from zope.intid.interfaces import IIntIds\n+from zope.intid.interfaces import IntIdMissingError\n+\n+import logging\n+\n+logger = logging.getLogger(__name__)\n+\n+\n+class RelationsRebuildControlpanel(BrowserView):\n+\n+    def __call__(self, rebuild=False, flush_and_rebuild_intids=False):\n+        self.done = False\n+        if rebuild:\n+            rebuild_relations(flush_and_rebuild_intids=flush_and_rebuild_intids)\n+            self.done = True\n+            IStatusMessage(self.request).addStatusMessage(\n+                _(\'Finished! See log for details.\'), \'info\')\n+\n+        self.relations_stats, self.broken = get_relations_stats()\n+        return self.index()\n+\n+\n+class RelationsInspectControlpanel(BrowserView):\n+\n+    def __call__(self, relation=None, inspect_backrelation=False):\n+        self.relation = relation or self.request.get(\'relation\')\n+        self.inspect_backrelation = inspect_backrelation or self.request.get(\'inspect_backrelation\')\n+\n+        self.relations = []\n+        self.relations_stats, self.broken = get_relations_stats()\n+        registry = getUtility(IRegistry)\n+        view_action = registry[\'plone.types_use_view_action_in_listings\']\n+\n+        if not self.relation:\n+            IStatusMessage(self.request).addStatusMessage(\n+                _(\'Please select a relation\'), \'info\')\n+            return self.index()\n+\n+        intids = queryUtility(IIntIds)\n+        relation_catalog = getUtility(ICatalog)\n+        query = {\'from_attribute\': self.relation}\n+        info = defaultdict(list)\n+\n+        # relations: column_1 = source, column_2 = target(s)\n+        # backrelation: column_1 = target, column_2 source(s)\n+        for rel in relation_catalog.findRelations(query):\n+            if rel.isBroken():\n+                continue\n+            try:\n+                hasattr(rel, \'from_id\')\n+                hasattr(rel, \'to_id\')\n+            except IntIdMissingError:\n+                continue\n+            if self.inspect_backrelation:\n+                info[rel.to_id].append(rel.from_id)\n+            else:\n+                info[rel.from_id].append(rel.to_id)\n+\n+        for column_1_intid in info:\n+            obj = intids.getObject(column_1_intid)\n+            use_view_action = obj.portal_type in view_action\n+            url = obj.absolute_url() + \'/view\' if use_view_action else obj.absolute_url()\n+            item = {}\n+            item[\'column_1\'] = {\n+                \'title\': obj.title_or_id(),\n+                \'url\': url,\n+                \'portal_type\': obj.portal_type,\n+            }\n+            item[\'column_2\'] = []\n+            for column_2_intid in info[column_1_intid]:\n+                obj = intids.getObject(column_2_intid)\n+                use_view_action = obj.portal_type in view_action\n+                url = obj.absolute_url() + \'/view\' if use_view_action else obj.absolute_url()\n+                item[\'column_2\'].append({\n+                    \'title\': obj.title_or_id(),\n+                    \'url\': url,\n+                    \'portal_type\': obj.portal_type,\n+                    })\n+            self.relations.append(item)\n+        self.relations.sort(key=lambda x: x[\'column_1\'][\'title\'])\n+        return self.index()\ndiff --git a/Products/CMFPlone/controlpanel/browser/relations_inspect.pt b/Products/CMFPlone/controlpanel/browser/relations_inspect.pt\nnew file mode 100644\nindex 0000000000..c1601d78e0\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/browser/relations_inspect.pt\n@@ -0,0 +1,134 @@\n+<html xmlns="http://www.w3.org/1999/xhtml"\n+      xml:lang="en"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      lang="en"\n+      metal:use-macro="context/prefs_main_template/macros/master"\n+      i18n:domain="plone">\n+\n+<body>\n+\n+  <metal:main metal:fill-slot="prefs_configlet_main" i18n:domain="plone"\n+      tal:define="inspect_backrelation python: view.inspect_backrelation;\n+                  relation python: view.relation;">\n+\n+      <a id="setup-link" class="link-parent"\n+         tal:attributes="href string:$portal_url/@@overview-controlpanel"\n+         i18n:translate="">\n+          Site Setup\n+      </a>\n+\n+    <header>\n+      <h1 class="documentFirstHeading"\n+          tal:condition="python: not inspect_backrelation">\n+        <span i18n:translate="">Inspect relations</span>\n+        <strong tal:content="python: relation">relation</strong>\n+      </h1>\n+\n+      <h1 class="documentFirstHeading"\n+          tal:condition="python: inspect_backrelation">\n+        <span i18n:translate="">Inspect backrelations</span>\n+        <strong tal:content="python: relation">backrelation</strong>\n+      </h1>\n+\n+    </header>\n+\n+    <div id="content-core"\n+         tal:define="relations_stats python: view.relations_stats">\n+\n+      <div tal:condition="python: view.broken"\n+           class="portalMessage warning alert alert-warning" role="alert"\n+           i18n:translate="">\n+             <strong>Warning!</strong> You have broken relations!\n+             You can <a href="${portal_url}/@@rebuild-relations">inspect and rebuild all relations</a>.\n+      </div>\n+\n+      <form id="relationinfo" method="post" action="${portal_url}/@@inspect-relations" enctype="multipart/form-data">\n+\n+        <div class="mb-3 field">\n+          <select class="form-select" i18n:attributes="aria-label label_default_select_example" aria-label="Default select example" name="relation" id="relation">\n+            <option value="" i18n:translate="">Select a relation</option>\n+            <tal:rels tal:repeat="from_attribute python: sorted(relations_stats)">\n+              <option tal:attributes="value python: from_attribute;\n+                                      selected python: relation == from_attribute"\n+                      tal:content="python:\'{} ({})\'.format(from_attribute, relations_stats[from_attribute])">\n+                  relationname (amount)\n+              </option>\n+            </tal:rels>\n+          </select>\n+        </div>\n+\n+        <div class="mb-3 field">\n+          <div class="form-check" id="inspect_backrelation">\n+            <input id="inspect-backrelation"\n+                   name="inspect_backrelation"\n+                   class="form-check-input single-checkbox-bool-widget bool-field"\n+                   value="selected"\n+                   type="checkbox"\n+                   checked="checked"\n+                   tal:attributes="checked python: \'checked\' if inspect_backrelation else \'\'">\n+            <label for="inspect-backrelation"\n+                   class="form-check-label"\n+                   i18n:translate="">\n+              Show backrelations\n+            </label>\n+            <div class="form-text" i18n:translate="">Display relations grouped by their target.</div>\n+          </div>\n+        </div>\n+\n+        <button class="context btn btn-primary" type="submit" name="submit" value="submit" i18n:translate="">Inspect</button>\n+      </form>\n+\n+      <table class="listing table table-striped"\n+             tal:condition="python:view.relations">\n+        <thead>\n+          <tr tal:condition="python: not inspect_backrelation">\n+            <th i18n:translate="">Source</th>\n+            <th>&rarr;</th>\n+            <th i18n:translate="">Target(s)</th>\n+          </tr>\n+\n+          <tr tal:condition="python: inspect_backrelation">\n+            <th i18n:translate="">Target</th>\n+            <th>&larr;</th>\n+            <th i18n:translate="">Source(s)</th>\n+          </tr>\n+        </thead>\n+        <tbody>\n+          <tr tal:repeat="item python:view.relations">\n+            <td>\n+              <a tal:attributes="href python:item[\'column_1\'][\'url\'];\n+                                 title python:item[\'column_1\'][\'portal_type\'];"\n+                 tal:content="python:item[\'column_1\'][\'title\']">\n+                Object\n+              </a>\n+            </td>\n+\n+            <td tal:condition="python: not inspect_backrelation">&rarr;</td>\n+            <td tal:condition="python: inspect_backrelation">&larr;</td>\n+            <td>\n+              <ul>\n+                <li tal:repeat="target python:item[\'column_2\']">\n+                  <a href=""\n+                     tal:attributes="href python:target[\'url\'];\n+                                     title python:target[\'portal_type\']; "\n+                     tal:content="python:target[\'title\']">\n+                    Target\n+                  </a>\n+                </li>\n+              </ul>\n+            </td>\n+          </tr>\n+        </tbody>\n+      </table>\n+\n+      <p><a href="${portal_url}/@@rebuild-relations" i18n:translate="">Inspect and rebuild all relations</a>.</p>\n+\n+    </div>\n+\n+  </metal:main>\n+\n+</body>\n+\n+</html>\ndiff --git a/Products/CMFPlone/controlpanel/browser/relations_rebuild.pt b/Products/CMFPlone/controlpanel/browser/relations_rebuild.pt\nnew file mode 100644\nindex 0000000000..145c2d284c\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/browser/relations_rebuild.pt\n@@ -0,0 +1,124 @@\n+<html xmlns="http://www.w3.org/1999/xhtml"\n+      xml:lang="en"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      lang="en"\n+      metal:use-macro="context/prefs_main_template/macros/master"\n+      i18n:domain="plone">\n+\n+<body>\n+\n+  <metal:main metal:fill-slot="prefs_configlet_main">\n+\n+      <a id="setup-link" class="link-parent"\n+         tal:attributes="href string:$portal_url/@@overview-controlpanel"\n+         i18n:translate="">\n+          Site Setup\n+      </a>\n+\n+    <header>\n+      <h1 class="documentFirstHeading" i18n:translate="">Rebuild relations</h1>\n+    </header>\n+\n+    <div id="content-core">\n+\n+      <span tal:condition="python:view.done" i18n:translate="">Success!</span>\n+      <h3 i18n:translate="">\n+         Current relations in the relation catalog\n+      </h3>\n+\n+      <table class="listing table table-striped"\n+            tal:define="relations_stats python: getattr(view, \'relations_stats\', None)"\n+            tal:condition="python: relations_stats">\n+        <thead>\n+          <tr>\n+            <th i18n:translate="">Relation</th>\n+            <th i18n:translate="">Amount</th>\n+          </tr>\n+        </thead>\n+        <tbody>\n+          <tr tal:repeat="item python: sorted(relations_stats)">\n+            <td>\n+              <a href=""\n+                 target="_blank"\n+                 tal:attributes="href python:\'@@inspect-relations?relation={}\'.format(item)"\n+                 tal:content="python:item"\n+                 title="Inspect relations">\n+               Type\n+              </a>\n+            </td>\n+            <td tal:content="python:relations_stats[item]">Amount</td>\n+          </tr>\n+        </tbody>\n+      </table>\n+\n+      <table class="listing table table-striped"\n+            tal:define="broken python: getattr(view, \'broken\', None)"\n+            tal:condition="python: broken">\n+        <thead>\n+          <tr>\n+            <th i18n:translate="">Broken Relation</th>\n+            <th i18n:translate="">Amount</th>\n+          </tr>\n+        </thead>\n+        <tbody>\n+          <tr tal:repeat="item python: sorted(broken)">\n+            <td tal:content="python:item">\n+               Type\n+            </td>\n+            <td tal:content="python:broken[item]">Amount</td>\n+          </tr>\n+        </tbody>\n+      </table>\n+\n+      <h3 i18n:translate="">Common relations:</h3>\n+      <dl>\n+        <dt>relatedItems</dt>\n+        <dd i18n:translate="">Relations between content using the default "Related items" field</dd>\n+\n+        <dt>isReferencing</dt>\n+        <dd i18n:translate="">Linkintegrity relations (source has a html-link to target)</dd>\n+\n+        <dt>iterate-working-copy</dt>\n+        <dd i18n:translate="">Relation from content to a working copy (using plone.app.iterate)</dd>\n+\n+        <dt>staging-working-copy</dt>\n+        <dd i18n:translate="">Outdated relation from content to a working copy (using plone.app.stagingbehavior)</dd>\n+\n+        <dt>(broken)</dt>\n+        <dd i18n:translate="">Either source or target no longer exist</dd>\n+\n+        <dt><i>all other</i></dt>\n+        <dd i18n:translate="">Custom attribute/fieldname used to describe the relation</dd>\n+      </dl>\n+\n+      <form id="rebuild_relations" method="post" action="@@rebuild-relations" enctype="multipart/form-data">\n+        <h3 i18n:translate="">Purge and rebuild relation-catalog</h3>\n+        <p i18n:translate="">Clicking here will do the following:</p>\n+        <ul>\n+          <li i18n:translate="">Get all relations from zc.relation catalog and store them in a annotation on the portal.</li>\n+          <li i18n:translate="">Remove all entries form zc.relation catalog.</li>\n+          <li i18n:translate="">Clean up or flush and rebuild intids - this depends on your selection below</li>\n+          <li i18n:translate="">Restore relations from the annotation on the portal.</li>\n+        </ul>\n+\n+        <div class="form-check">\n+          <input class="form-check-input" type="checkbox" name="flush_and_rebuild_intids" id="flush_intids">\n+          <label class="form-check-label" for="flush_intids" i18n:translate="">Flush and rebuild intids</label>\n+          <p i18n:translate="">\n+             This will delete all intids and create new one.<br/>\n+             Warning: If you have a lot of relations this can take some time. Check the log for details!<br/>\n+             If you have relations on tiles, flushing and rebuilding intids will destroy them b/c intids changed.\n+          </p>\n+        </div>\n+        <button class="context btn btn-danger" type="submit" name="rebuild" value="rebuild" i18n:translate="">Rebuild</button>\n+\n+      </form>\n+    </div>\n+\n+  </metal:main>\n+\n+</body>\n+\n+</html>\ndiff --git a/Products/CMFPlone/controlpanel/browser/resourceregistry.pt b/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\nindex 0f0800e796..071d03817f 100644\n--- a/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\n+++ b/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\n@@ -10,56 +10,159 @@\n \n \n <metal:main metal:fill-slot="prefs_configlet_main" i18n:domain="plone">\n+  <header>\n \n-    <a href=""\n-       id="setup-link"\n-       tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-       i18n:translate="">\n-       Site Setup\n-    </a>\n     <h1 class="documentFirstHeading"\n-        i18n:translate="">Resource Registries</h1>\n+        i18n:translate="">Resource Registry</h1>\n \n-    <div class="documentDescription"\n+    <div class="text-muted"\n        i18n:translate="">\n-      Configure, enable, disable, debug and build Plone JavaScript/LESS/CSS resources.\n-      Plone utilizes RequireJS and LESS CSS to build its resources.\n-      Re-building a Plone bundle TTW requires a modern web browser.\n+      Configure Plone JavaScript/CSS resource bundles.\n     </div>\n+  </header>\n \n    <div id="content-core">\n-      <span tal:replace="structure context/@@authenticator/authenticator"/>\n-      <div class="pat-resourceregistry" tal:attributes="data-pat-resourceregistry view/config">\n-        <div class="portalMessage info" role="status">\n-          <strong i18n:translate="">Info</strong>\n-          <span i18n:translate="">If you see this, it is because there was an error rendering the resource registry\n-          configuration. It\'s possible you saved a bundle that gives a JavaScript error\n-          and it is preventing the resource registry from loading.</span>\n+    <div class="portalMessage statusmessage statusmessage-error alert alert-danger js-errors">\n+        <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-error\', tag_alt=\'\', tag_class=\'statusmessage-icon mb-1 me-2\')" />\n+        <strong i18n:translate="">Javascript disabled or error(s) occurred</strong>\n+        <span class="content"\n+              i18n:translate="">\n+            If this message persists, a Javascript Error occurred within the\n+            resources below.\n+        </span>\n+    </div>\n+    <div tal:condition="python:view.global_debug_mode()"\n+         class="portalMessage statusmessage statusmessage-info alert alert-info"\n+         role="alert">\n+        <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-info\', tag_alt=\'\', tag_class=\'statusmessage-icon mb-1 me-2\')" />\n+        <strong i18n:translate="">Global Debug Mode Activated</strong>\n+        <span class="content"\n+              i18n:translate="">\n+            This is great for development.\n+            Resource hashes will be recalculated on each request.\n+            This is expensive, do not use use in production!\n+        </span>\n+    </div>\n+    <form tal:condition="python:not view.global_debug_mode() and view.debug_mode()"\n+          method="post" action="${python:context.absolute_url()}/@@resourceregistry-controlpanel">\n+      <div class="portalMessage statusmessage statusmessage-info alert alert-warning"\n+         role="alert">\n+          <button name="action" value="deactivate_cache" type="submit" class="btn btn-primary ms-1 me-1 mb-1 float-end" i18n:translate="">Deactivate</button>\n+        <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-warning\', tag_alt=\'\', tag_class=\'statusmessage-icon mb-1\')" />\n+        <strong i18n:translate="">Resource Debug Mode Activated</strong>\n+        <span class="content"\n+              i18n:translate="">\n+            Resources are not cached in Plone.\n+            Their hashes will be recalculated on each request.\n+            This is expensive, do not use use in production!\n+        </span>\n+      </div>\n+    </form>\n+    <form tal:condition="python:not view.global_debug_mode() and not view.debug_mode()"\n+          method="post" action="${python:context.absolute_url()}/@@resourceregistry-controlpanel">\n+      <div class="portalMessage statusmessage statusmessage-info alert alert-info"\n+         role="alert">\n+          <button name="action" value="activate_cache" type="submit" class="btn btn-primary ms-1 me-1 mb-1 float-end" i18n:translate="">Activate Debug Mode</button>\n+        <tal:icon tal:replace="structure python:icons.tag(\'plone-statusmessage-info\', tag_alt=\'\', tag_class=\'statusmessage-icon mb-1\')" />\n+        <strong i18n:translate="">Production Mode Activated</strong>\n+        <span class="content"\n+              i18n:translate="">\n+            Resources are fast and hashes are cached in Plone.\n+            Changes in resource settings are not applied directly.\n+        </span>\n+      </div>\n+    </form>\n+    <div class="accordion" id="accordionRR" tal:define="dummy python:view.process_form()">\n+      <tal:block tal:repeat="bundle python:view.bundles_data">\n+      <div class="accordion-item ${python:\'active\' if bundle[\'name\'] == request.form.get(\'name\', None) else \'\'}">\n+           <h2 class="accordion-header" id="heading-${python:bundle[\'safe_name\']}">\n+            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${python:bundle[\'safe_name\']}" aria-expanded="false" aria-controls="collapse-${python:bundle[\'safe_name\']}">\n+              <span tal:condition="python:bundle[\'name\'] and bundle[\'enabled\']" i18n:translate="" class="me-2"><tal:icon tal:replace="structure python:icons.tag(\'file-check\', tag_alt=\'Enabled bundle\')" /></span>\n+              <span tal:condition="python:bundle[\'name\'] and not bundle[\'enabled\']" i18n:translate="" class="me-2"><tal:icon tal:replace="structure python:icons.tag(\'file-x\', tag_alt=\'Disabled bundle\')" /></span>\n+              <span tal:condition="python:not bundle[\'name\']" i18n:translate="" class="me-2"><tal:icon tal:replace="structure python:icons.tag(\'file-plus\', tag_alt=\'Add a bundle\')" /></span>\n+              <strong tal:condition="python:bundle[\'name\']">${python:bundle["name"]}</strong>\n+              <strong tal:condition="python:not bundle[\'name\']" i18n:translate="">Add new bundle</strong>\n+            </button>\n+          </h2>\n+          <div id="collapse-${python:bundle[\'safe_name\']}" class="accordion-collapse collapse show" aria-labelledby="heading${python:bundle[\'safe_name\']}" data-bs-parent="#accordionRR">\n+            <div class="accordion-body">\n+              <form method="post" action="${python:context.absolute_url()}/@@resourceregistry-controlpanel">\n+                <input type="hidden" name="original_name" value="${python:bundle[\'name\']}" />\n+                <div class="mb-3">\n+                  <label for="name" class="form-label" i18n:translate="label_bundle_name">Name</label>\n+                  <input type="text" class="form-control" name="name" value="${python:bundle[\'name\']}"/>\n+                </div>\n+                <div class="mb-3">\n+                  <label for="jscompilation" class="form-label">Javascript</label>\n+                  <input type="text" class="form-control" name="jscompilation" value="${python:bundle[\'jscompilation\']}"/>\n+                </div>\n+                <div class="mb-3">\n+                  <label for="csscompilation" class="form-label">CSS</label>\n+                  <input type="text" class="form-control" name="csscompilation" value="${python:bundle[\'csscompilation\']}"/>\n+                </div>\n+                <div class="form-check mb-3">\n+                  <input class="form-check-input" type="checkbox" value="" name="enabled" ${python:"checked" if bundle["enabled"] else \'\'} />\n+                  <label class="form-check-label" for="enabled" i18n:translate="label_bundle_enabled">\n+                    enabled\n+                  </label>\n+                </div>\n+                <div class="mb-3">\n+                  <label for="expression" class="form-label" i18n:translate="label_bundle_condition">Condition</label>\n+                  <input type="text" class="form-control" name="expression" value="${python:bundle[\'expression\']}" placeholder="expression" i18n:attributes="placeholder label_expression_placeholder"/>\n+                </div>\n+                <div class="mb-3">\n+                  <label for="depends" class="form-label" i18n:translate="">Depends on</label>\n+                  <input type="text" class="form-control" name="depends" value="${python:bundle[\'depends\']}" />\n+                </div>\n+                <div class="form-check mb-3">\n+                  <input class="form-check-input" type="checkbox" value="1" name="load_async" ${python:"checked" if bundle["load_async"] else \'\'} />\n+                  <label class="form-check-label" for="load_async" i18n:translate="label_bundle_js_load_async">\n+                    Async\n+                  </label>\n+                </div>\n+                <div class="form-check mb-3">\n+                  <input class="form-check-input" type="checkbox" value="1" name="load_defer" ${python:"checked" if bundle["load_defer"] else \'\'} />\n+                  <label class="form-check-label" for="load_defer" i18n:translate="label_bundle_js_load_defer">\n+                    Defer\n+                  </label>\n+                </div>\n+                <div class="mb-3">\n+                  <button tal:condition="python:bundle[\'name\']" name="action" value="update" type="submit" class="btn btn-primary me-1" i18n:translate="">Save</button>\n+                  <button tal:condition="python:not bundle[\'name\']" name="action" value="add" type="submit" class="btn btn-success me-1" i18n:translate="">Add</button>\n+                  <button tal:condition="python:bundle[\'name\']" name="action" value="delete" type="submit" class="btn btn-danger" i18n:translate="">Delete</button>\n+                </div>\n+              </form>\n+          </div>\n         </div>\n-        <h2 i18n:translate="">Available Options</h2>\n-        <ul>\n-          <li i18n:translate="">Reload the page. There could be a intermittent issue.</li>\n-          <li i18n:translate="">Go to the <a i18n:name="configuration_registry" i18n:translate=""\n-              href="${portal_url}/portal_registry">Configuration Registry</a>\n-              and manually edit the configuration to enable development mode\n-              on the resource registry and try to rebuild.</li>\n-          <li><span i18n:translate="" tal:omit-tag="">You can also attempt to delete your customizations/builds and see if that fixes it.</span>\n-            <ul>\n-              <tal:overrides tal:repeat="override python: view.get_overrides()">\n-                <li>\n-                  <form method="POST">\n-                    <input type="hidden" name="action" value="delete-file" />\n-                    <input type="hidden" name="response" value="html" />\n-                    <input type="hidden" name="filepath" value="${override}" />\n-                    <input type="submit" value="Delete ${override}" i18n:attributes="value" />\n-                  </form>\n-                </li>\n-              </tal:overrides>\n-            </ul>\n-          </li>\n-        </ul>\n       </div>\n+      </tal:block>\n+    </div>\n+    <div class="mt-3">\n+      <h2 i18n:translate="">Additional Resources</h2>\n+      <p i18n:translate="">After the above resources, the following might get loaded:</p>\n+      <dl>\n+        <dt i18n:translate="">Theme CSS and JavaScript</dt>\n+        <dd i18n:translate="">\n+          The activated Plone-Theme usually provides one CSS bundle and sometimes a javascript bundle.\n+        </dd>\n+        <dt i18n:translate="">Custom CSS</dt>\n+        <dd i18n:translate="">\n+          At last a custom CSS is loaded, if non-empty.\n+          It can be used to override the previous loaded CSS.\n+          It is provided for tinkerers and those in need of urgent through-the-web changes.\n+          Hint: <a href="${python:context.absolute_url()}/@@theming-controlpanel#autotoc-item-autotoc-1" i18n:name="link" i18n:translate="">Edit the Custom CSS in the Theming-Control-Panel</a>.\n+        </dd>\n+      </dl>\n     </div>\n+   </div>\n+   <script>\n+     /* collapse accordion via script here, so that it stays open when JS is disabled */\n+     window.addEventListener(\'DOMContentLoaded\', (event) => {\n+      document.querySelector(".alert.js-errors").style.display = "none";\n+      document.querySelectorAll(".accordion-item:not(.active) .accordion-button").forEach(el => el.classList.add("collapsed"));\n+      document.querySelectorAll(".accordion-item:not(.active) .accordion-collapse").forEach(el => el.classList.remove("show"));\n+    });\n+   </script>\n </metal:main>\n \n </body>\ndiff --git a/Products/CMFPlone/controlpanel/browser/resourceregistry.py b/Products/CMFPlone/controlpanel/browser/resourceregistry.py\nindex 2c0dcace27..7f754b993c 100644\n--- a/Products/CMFPlone/controlpanel/browser/resourceregistry.py\n+++ b/Products/CMFPlone/controlpanel/browser/resourceregistry.py\n@@ -1,424 +1,152 @@\n-from datetime import datetime\n-from plone.memoize.view import memoize\n-from plone.registry import field\n+from App.config import getConfiguration\n+from plone.base.interfaces import IBundleRegistry\n from plone.registry.interfaces import IRegistry\n-from plone.registry.record import Record\n-from plone.resource.interfaces import IResourceDirectory\n-from Products.CMFPlone.interfaces import IBundleRegistry\n-from Products.CMFPlone.interfaces import IResourceRegistry\n-from Products.CMFPlone.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME  # noqa\n-from Products.CMFPlone.resources import add_bundle_on_request\n-from Products.CMFPlone.resources import RESOURCE_DEVELOPMENT_MODE\n-from Products.CMFPlone.resources.browser.configjs import RequireJsView\n-from Products.CMFPlone.resources.browser.cook import cookWhenChangingSettings\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.Five.browser import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\n-from urllib import parse\n-from zExceptions import NotFound\n from zope.component import getUtility\n \n-import json\n-import posixpath\n-import re\n+import operator\n \n \n-CSS_URL_REGEX = re.compile(r\'url\\(([^)]+)\\)\')\n-\n-\n-class JSONEncoder(json.JSONEncoder):\n-\n-    def default(self, obj):\n-        if hasattr(obj, \'isoformat\'):\n-            return obj.isoformat()\n-        else:\n-            return json.JSONEncoder.default(self, obj)\n-\n-\n-def recordsToDict(record):\n-    data = {}\n-    for name in record.__schema__.names():\n-        data[name] = getattr(record, name)\n-    return data\n-\n-\n-def updateRecordFromDict(record, data):\n-    for name in record.__schema__.names():\n-        if name in [\'last_compilation\']:\n-            continue\n-        if name in data:\n-            # almost all string data needs to be str, not unicode\n-            val = data[name]\n-            if isinstance(val, list):\n-                newval = []\n-                for item in val:\n-                    newval.append(item)\n-                val = newval\n-\n-            full_name = record.__prefix__ + name\n-            try:\n-                record.__registry__[full_name] = val\n-            except (AttributeError, KeyError):\n-                # upgrade record on the fly, try to at least\n-                if not val:\n-                    continue\n-                if type(val) == bool:\n-                    record.__registry__.records[full_name] = Record(\n-                        field.Bool(title=""), val)\n-                else:\n-                    raise\n-\n-\n-class OverrideFolderManager:\n-\n-    def __init__(self, context):\n-        self.context = context\n-        persistent_directory = getUtility(IResourceDirectory, name="persistent")  # noqa\n-        if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:\n-            persistent_directory.makeDirectory(OVERRIDE_RESOURCE_DIRECTORY_NAME)  # noqa\n-        self.container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-\n-    def save_file(self, filepath, data):\n-        resource_name, resource_filepath = filepath.split(\'/\', 1)\n-        if resource_name not in self.container:\n-            self.container.makeDirectory(resource_name)\n-        folder = self.container[resource_name]\n-        if \'.css\' in resource_filepath:\n-            data = self.make_links_relative(filepath, data)\n-        folder.writeFile(resource_filepath, data)\n-        return folder[resource_filepath]\n-\n-    def _rewrite_url(self, css_url, asset_url):\n-        """\n-        Pulled from:\n-        http://stackoverflow.com/questions/7469573/how-to-construct-relative-url-given-two-absolute-urls-in-python\n-\n-        """\n-        base = parse.urlparse(css_url)\n-        target = parse.urlparse(asset_url)\n-        if base.netloc != target.netloc:\n-            return asset_url\n-        base_dir = \'.\' + posixpath.dirname(base.path)\n-        target = \'.\' + target.path\n-        return posixpath.relpath(target, start=base_dir)\n-\n-    def make_links_relative(self, filepath, data):\n-        """\n-        make sure we don\'t write out any full urls.\n-        filepath will be something like foo/bar.css\n-        and the full real url will be something like http://site-url/++plone++foo/bar.css\n-\n-        So we\'ll be everything relative the resource path.\n-\n-\n-        """\n-        site_url = self.context.absolute_url()\n-        full_resource_url = f\'{site_url}/++plone++{filepath}\'\n-        for css_url in CSS_URL_REGEX.findall(data):\n-            if css_url.startswith("data:"):\n-                continue\n-            if css_url.find("data:image") > 0:\n-                continue\n-\n-            css_url = css_url.lstrip(\'url(\').rstrip(\')\').\\\n-                strip(\'"\').strip("\'")\n-            if css_url.startswith(site_url):\n-                data = data.replace(css_url, self._rewrite_url(\n-                    full_resource_url, css_url))\n-\n-        return data\n-\n-    def delete_file(self, filepath):\n-        resource_name, resource_filepath = filepath.split(\'/\', 1)\n+class ResourceRegistryControlPanelView(BrowserView):\n+    @property\n+    def _bundles(self):\n+        registry = getUtility(IRegistry)\n+        return registry.collectionOfInterface(\n+            IBundleRegistry, prefix="plone.bundles", check=False\n+        )\n \n-        if resource_name not in self.container:\n-            return\n-        folder = self.container[resource_name]\n-        try:\n-            fi = folder[resource_filepath]\n-        except NotFound:\n+    @property\n+    def bundles_data(self):\n+        result = []\n+        for name, record in self._bundles.items():\n+            result.append(\n+                {\n+                    "name": name,\n+                    "safe_name": name.replace(".", "-"),\n+                    "jscompilation": record.jscompilation,\n+                    "csscompilation": record.csscompilation,\n+                    "expression": record.expression,\n+                    "enabled": record.enabled,\n+                    "depends": record.depends,\n+                    "load_async": record.load_async,\n+                    "load_defer": record.load_defer,\n+                }\n+            )\n+        result = list(sorted(result, key=operator.itemgetter("name")))\n+        result.append(\n+            {\n+                "name": "",\n+                "safe_name": "",\n+                "jscompilation": "",\n+                "csscompilation": "",\n+                "expression": "",\n+                "enabled": False,\n+                "depends": "",\n+                "load_async": False,\n+                "load_defer": False,\n+            }\n+        )\n+        return result\n+\n+    def global_debug_mode(self):\n+        return getConfiguration().debug_mode\n+\n+    def debug_mode(self):\n+        registry = getUtility(IRegistry)\n+        return registry["plone.resources.development"]\n+\n+    def _add(self):\n+        name = self.request.form.get("name", None)\n+        if name is None or name == "":\n+            IStatusMessage(self.request).addStatusMessage(\n+                _("Name can not be empty."), "error"\n+            )\n             return\n-        parent = self.get_parent(fi)\n-        del parent[fi.getId()]\n-        if filepath not in self.container:\n+        bundles = self._bundles\n+        if name in bundles:\n+            IStatusMessage(self.request).addStatusMessage(\n+                _("Record ${name} already exists.", mapping=dict(name=name)), "error"\n+            )\n             return\n-        folder = self.container[resource_name]\n-        try:\n-            fi = folder[resource_filepath]\n-        except NotFound:\n+        record = bundles.add(name)\n+        self._set_data_from_form(record)\n+        IStatusMessage(self.request).addStatusMessage(\n+            _("Record ${name} created.", mapping=dict(name=name)), "info"\n+        )\n+\n+    def _update(self):\n+        new_name = self.request.form.get("name", None)\n+        if new_name is None or new_name == "":\n+            IStatusMessage(self.request).addStatusMessage(\n+                _("Name can not be empty."), "error"\n+            )\n             return\n-        parent = self.get_parent(fi)\n-        del parent[fi.getId()]\n-\n-    def get_parent(self, item):\n-        path = \'/\'.join(item.getPhysicalPath()[:-1])\n-        return self.context.restrictedTraverse(path)\n-\n-    def list_dir(self, container):\n-        if hasattr(container, \'listDirectory\'):\n-            return container.listDirectory()\n-        else:\n-            return container.objectIds()\n-\n-\n-class ResourceRegistryControlPanelView(RequireJsView):\n-\n-    def __call__(self):\n-        add_bundle_on_request(self.request, \'resourceregistry\')\n-        req = self.request\n-        if req.REQUEST_METHOD == \'POST\':\n-            action = req.get(\'action\', \'\')\n-            method = action.replace(\'-\', \'_\')\n-            if hasattr(self, method):\n-                return getattr(self, method)()\n-            else:\n-                return json.dumps({\n-                    \'success\': False,\n-                    \'msg\': \'Invalid action: \' + action\n-                })\n+        original_name = self.request.form.get("original_name", None)\n+        bundles = self._bundles\n+        if new_name != original_name:\n+            if original_name not in bundles:\n+                IStatusMessage(self.request).addStatusMessage(\n+                    _("Expected record missing."), "error"\n+                )\n+                return\n+            if new_name in bundles:\n+                IStatusMessage(self.request).addStatusMessage(\n+                    _("Record name ${new_name} already taken.", mapping=dict(new_name=new_name)), "error"\n+                )\n+                return\n+            record = bundles[original_name]\n+            del bundles[original_name]\n+            # update prefix\n+            record.__prefix__ = record.__prefix__.replace(original_name, new_name)\n+            bundles[new_name] = record\n         else:\n-            if RESOURCE_DEVELOPMENT_MODE:\n-                messages = IStatusMessage(self.request)\n-                messages.add("The FEDEV environment variable is set. No matter "\n-                             "what settings are done here, all bundles will "\n-                             "always be in development mode.", type="warn")\n-            return self.index()\n-\n-    @property\n-    @memoize\n-    def registry(self):\n-        return getUtility(IRegistry)\n-\n-    def update_registry_collection(self, itype, prefix, newdata):\n-        rdata = self.registry.collectionOfInterface(\n-            itype, prefix=prefix, check=False)\n-        for key, data in newdata.items():\n-            if key not in rdata:\n-                record = rdata.add(key)\n-            else:\n-                record = rdata[key]\n-            updateRecordFromDict(record, data)\n-        # remove missing ones\n-        for key in set(rdata.keys()) - set(newdata.keys()):\n-            del rdata[key]\n-\n-    def save_registry(self):\n-        req = self.request\n+            record = bundles[original_name]\n+        self._set_data_from_form(record)\n+        IStatusMessage(self.request).addStatusMessage(_("Changes saved."), "info")\n+\n+    def _set_data_from_form(self, record):\n+        names = record.__schema__.names()\n+        data = {k: v for k, v in self.request.form.items() if k in names}\n+        bool_names = ["enabled", "load_async", "load_defer"]\n+        for bool_name in bool_names:\n+            data[bool_name] = bool_name in data\n+        for field_name, value in data.items():\n+            full_name = record.__prefix__ + field_name\n+            record.__registry__[full_name] = value\n+        self._switch_cache(False)\n+\n+    def _delete(self):\n+        name = self.request.form.get("original_name", None)\n+        bundles = self._bundles\n+        if name not in bundles:\n+            IStatusMessage(self.request).addStatusMessage(\n+                _("Expected record ${name} missing.", mapping=dict(name=name)), "error"\n+            )\n+            return\n+        del bundles[name]\n+        self._switch_cache(False)\n+        IStatusMessage(self.request).addStatusMessage(_("Record deleted."), "info")\n \n-        if req.get(\'resources\') and req.get(\'bundles\'):\n-            self.update_registry_collection(\n-                IResourceRegistry, "plone.resources",\n-                json.loads(req.get(\'resources\')))\n-            self.update_registry_collection(\n-                IBundleRegistry, "plone.bundles",\n-                json.loads(req.get(\'bundles\')))\n+    def _switch_cache(self, state):\n+        registry = getUtility(IRegistry)\n+        registry["plone.resources.development"] = state\n \n-        if self.request.form.get(\'development\', \'\').lower() == \'true\':\n-            self.registry[\'plone.resources.development\'] = True\n+    def process_form(self):\n+        if self.request["method"] != "POST":\n+            return\n+        action = self.request.form["action"]\n+        if action == "add":\n+            self._add()\n+        elif action == "update":\n+            self._update()\n+        elif action == "delete":\n+            self._delete()\n+        elif action == "activate_cache":\n+            self._switch_cache(True)\n+        elif action == "deactivate_cache":\n+            self._switch_cache(False)\n         else:\n-            self.registry[\'plone.resources.development\'] = False\n-\n-        # it\'d be difficult to know if the legacy bundle settings\n-        # changed or not so we need to just set the last import date\n-        # back so it gets re-built\n-        self.registry.records[\n-            \'plone.resources.last_legacy_import\'].value = datetime.now()\n-        cookWhenChangingSettings(self.context)\n-\n-        return json.dumps({\n-            \'success\': True\n-        })\n-\n-    def save_file(self):\n-        req = self.request\n-        resource_path = req.form.get(\'filepath\').split(\'++plone++\')[-1]\n-        overrides = OverrideFolderManager(self.context)\n-        overrides.save_file(resource_path, req.form[\'data\'])\n-        return json.dumps({\n-            \'success\': True\n-        })\n-\n-    def delete_file(self):\n-        req = self.request\n-        resource_path = req.form.get(\'filepath\').split(\'++plone++\')[-1]\n-        overrides = OverrideFolderManager(self.context)\n-        overrides.delete_file(resource_path)\n-\n-        if req.form.get(\'response\') == \'html\':\n-            return req.response.redirect(req.URL)\n-        return json.dumps({\n-            \'success\': True\n-        })\n-\n-    def get_bundles(self):\n-        return self.registry.collectionOfInterface(\n-            IBundleRegistry, prefix="plone.bundles", check=False)\n-\n-    def get_resources(self):\n-        return self.registry.collectionOfInterface(\n-            IResourceRegistry, prefix="plone.resources", check=False)\n-\n-    def less_build_config(self):\n-        site_url = self.context.portal_url()\n-        bundles = self.get_bundles()\n-        bundle = self.request.get(\'bundle\', None)\n-        resources = self.get_resources()\n-        less_files = []\n-        if bundle and bundle in bundles:\n-            bundle_obj = bundles[bundle]\n-            for resource in bundle_obj.resources:\n-                if resource in resources:\n-                    for css in resources[resource].css:\n-                        url = parse.urlparse(css)\n-                        if url.netloc == \'\':\n-                            # Local\n-                            src = f"{site_url}/{css}"\n-                        else:\n-                            src = "%s" % (css)\n-\n-                        extension = url.path.split(\'.\')[-1]\n-                        if extension == \'less\':\n-                            less_files.append(src)\n-        return json.dumps({\n-            \'less\': less_files,\n-        })\n-\n-    def js_build_config(self):\n-        (paths, shims) = self.get_requirejs_config()\n-        bundles = self.get_bundles()\n-        resources = self.get_resources()\n-\n-        bundle = self.request.get(\'bundle\', None)\n-        includes = []\n-        if bundle and bundle in bundles:\n-            bundle_obj = bundles[bundle]\n-            for resource_name in bundle_obj.resources:\n-                # need to check if this resource has a js file\n-                # it could just be a css resource\n-                try:\n-                    resource = resources[resource_name]\n-                    if resource.js:\n-                        includes.append(resource_name)\n-                except KeyError:\n-                    # skip if missing\n-                    pass\n-            if bundle_obj.stub_js_modules:\n-                for module in bundle_obj.stub_js_modules:\n-                    paths[module] = \'empty:\'\n-        return json.dumps({\n-            \'include\': includes,\n-            \'shim\': shims,\n-            \'paths\': paths,\n-            \'wrapShim\': True,\n-            \'optimize\': \'none\'\n-        })\n-\n-    def save_js_build(self):\n-        """\n-        \'\xc3\x82\'\n-        """\n-        overrides = OverrideFolderManager(self.context)\n-        req = self.request\n-        filepath = \'static/%s-compiled.js\' % req.form[\'bundle\']\n-\n-        data = req.form[\'data\']\n-        overrides.save_file(filepath, data)\n-        bundle = self.get_bundles().get(req.form[\'bundle\'])\n-        if bundle:\n-            bundle.last_compilation = datetime.now()\n-            bundle.jscompilation = f\'++plone++{filepath}\'\n-        return json.dumps({\n-            \'success\': True,\n-            \'filepath\': \'++plone++\' + filepath\n-        })\n-\n-    def save_less_build(self):\n-        overrides = OverrideFolderManager(self.context)\n-        req = self.request\n-        filepath = \'static/%s-compiled.css\' % req.form[\'bundle\']\n-        data = \'\'\n-        for key, value in req.form.items():\n-            if not key.startswith(\'data-\'):\n-                continue\n-            if isinstance(value, str):\n-                value = [value]\n-            data += \'\\n\'.join(value) + \'\\n\'\n-        overrides.save_file(filepath, data)\n-        bundle = self.get_bundles().get(req.form[\'bundle\'])\n-        if bundle:\n-            bundle.last_compilation = datetime.now()\n-            bundle.csscompilation = f\'++plone++{filepath}\'\n-        return json.dumps({\n-            \'success\': True,\n-            \'filepath\': \'++plone++\' + filepath\n-        })\n-\n-    def save_less_variables(self):\n-        data = {}\n-        for key, val in json.loads(self.request.form.get(\'data\')).items():\n-            data[key] = val\n-        self.registry[\'plone.lessvariables\'] = data\n-        return json.dumps({\n-            \'success\': True\n-        })\n-\n-    def save_pattern_options(self):\n-        data = {}\n-        for key, val in json.loads(self.request.form.get(\'data\')).items():\n-            data[key] = val\n-        self.registry[\'plone.patternoptions\'] = data\n-        return json.dumps({\n-            \'success\': True\n-        })\n-\n-    def get_overrides(self):\n-        overrides = OverrideFolderManager(self.context)\n-\n-        def _read_folder(folder):\n-            files = []\n-            for filename in folder.listDirectory():\n-                try:\n-                    item = folder[filename]\n-                except NotFound:\n-                    continue\n-                if folder.isDirectory(filename):\n-                    files.extend(_read_folder(item))\n-                else:\n-                    files.append(item)\n-            return files\n-        files = _read_folder(overrides.container)\n-        results = []\n-        site_path = self.context.getPhysicalPath()\n-        for fi in files:\n-            path = fi.getPhysicalPath()\n-            rel_path = path[len(site_path) + 2:]\n-            results.append(\'++plone++{}/{}\'.format(\n-                rel_path[0], \'/\'.join(rel_path[1:])))\n-        return results\n-\n-    def config(self):\n-        base_url = self.context.absolute_url()\n-        resources = self.get_resources()\n-\n-        less_url = self.registry[\'plone.resources.lessc\']\n-        rjs_url = self.registry[\'plone.resources.rjs\']\n-\n-        data = {\n-            \'development\': self.registry[\'plone.resources.development\'],\n-            \'lessvariables\': self.registry[\'plone.lessvariables\'],\n-            \'resources\': {},\n-            \'bundles\': {},\n-            \'javascripts\': {},\n-            \'css\': {},\n-            \'baseUrl\': base_url,\n-            \'manageUrl\': \'%s/@@resourceregistry-controlpanel\' % base_url,\n-            \'lessUrl\': f\'{base_url}/{less_url}\',\n-            \'lessConfigUrl\': \'%s/less-variables.js\' % base_url,\n-            \'rjsUrl\': rjs_url,\n-            \'patternoptions\': self.registry[\'plone.patternoptions\']\n-        }\n-        bundles = self.get_bundles()\n-        for key, resource in resources.items():\n-            data[\'resources\'][key] = recordsToDict(resource)\n-        for key, bundle in bundles.items():\n-            data[\'bundles\'][key] = recordsToDict(bundle)\n-        data[\'overrides\'] = self.get_overrides()\n-        return json.dumps(data, cls=JSONEncoder)\n+            raise ValueError("Invalid form data")\n+        self.request.response.redirect(self.request["ACTUAL_URL"])\ndiff --git a/Products/CMFPlone/controlpanel/browser/search.py b/Products/CMFPlone/controlpanel/browser/search.py\nindex ddffdf4151..de2fc54a14 100644\n--- a/Products/CMFPlone/controlpanel/browser/search.py\n+++ b/Products/CMFPlone/controlpanel/browser/search.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import ISearchSchema\n+from plone.base.interfaces import ISearchSchema\n from Products.CMFPlone.controlpanel.widgets import ReverseCheckBoxFieldWidget\n from plone.app.registry.browser import controlpanel\n from zope.component import queryUtility\ndiff --git a/Products/CMFPlone/controlpanel/browser/security.py b/Products/CMFPlone/controlpanel/browser/security.py\nindex 4fb41d1601..ae52e9ac63 100644\n--- a/Products/CMFPlone/controlpanel/browser/security.py\n+++ b/Products/CMFPlone/controlpanel/browser/security.py\n@@ -3,7 +3,7 @@\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.utils import migrate_to_email_login\n from Products.CMFPlone.controlpanel.utils import migrate_from_email_login\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISecuritySchema\n from Products.Five.browser import BrowserView\n from collections import defaultdict\n from plone.app.registry.browser import controlpanel\ndiff --git a/Products/CMFPlone/controlpanel/browser/site.py b/Products/CMFPlone/controlpanel/browser/site.py\nindex 269fe1b029..2bd9e99418 100644\n--- a/Products/CMFPlone/controlpanel/browser/site.py\n+++ b/Products/CMFPlone/controlpanel/browser/site.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import ISiteSchema\n from plone.app.registry.browser import controlpanel\n from plone.formwidget.namedfile.widget import NamedImageFieldWidget\n from z3c.form import interfaces\n@@ -16,6 +16,7 @@ class SiteControlPanelForm(controlpanel.RegistryEditForm):\n     def updateFields(self):\n         super().updateFields()\n         self.fields[\'site_logo\'].widgetFactory = NamedImageFieldWidget\n+        self.fields[\'site_favicon\'].widgetFactory = NamedImageFieldWidget\n \n     def updateWidgets(self):\n         super().updateWidgets()\ndiff --git a/Products/CMFPlone/controlpanel/browser/socialmedia.py b/Products/CMFPlone/controlpanel/browser/socialmedia.py\nindex edb14ca1b8..dc48368a0e 100644\n--- a/Products/CMFPlone/controlpanel/browser/socialmedia.py\n+++ b/Products/CMFPlone/controlpanel/browser/socialmedia.py\n@@ -1,5 +1,5 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import ISocialMediaSchema\n+from plone.base.interfaces import ISocialMediaSchema\n from plone.app.registry.browser import controlpanel\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/syndication.py b/Products/CMFPlone/controlpanel/browser/syndication.py\nindex f9b16303c3..be92de8e60 100644\n--- a/Products/CMFPlone/controlpanel/browser/syndication.py\n+++ b/Products/CMFPlone/controlpanel/browser/syndication.py\n@@ -1,6 +1,6 @@\n from Products.CMFCore.utils import getToolByName\n from zope.i18nmessageid import MessageFactory\n-from Products.CMFPlone.interfaces.syndication import ISiteSyndicationSettings\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from plone.app.registry.browser import controlpanel\n from z3c.form import button\n from Products.statusmessages.interfaces import IStatusMessage\ndiff --git a/Products/CMFPlone/controlpanel/browser/tinymce.py b/Products/CMFPlone/controlpanel/browser/tinymce.py\nindex 4e3d0daf25..e70c93525d 100644\n--- a/Products/CMFPlone/controlpanel/browser/tinymce.py\n+++ b/Products/CMFPlone/controlpanel/browser/tinymce.py\n@@ -1,10 +1,10 @@\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.interfaces import ITinyMCELayoutSchema\n-from Products.CMFPlone.interfaces import ITinyMCESpellCheckerSchema\n-from Products.CMFPlone.interfaces import ITinyMCEResourceTypesSchema\n-from Products.CMFPlone.interfaces import ITinyMCEAdvancedSchema\n-from Products.CMFPlone.interfaces import ITinyMCESchema\n-from Products.CMFPlone.interfaces import ITinyMCEPluginSchema\n+from plone.base.interfaces import ITinyMCELayoutSchema\n+from plone.base.interfaces import ITinyMCESpellCheckerSchema\n+from plone.base.interfaces import ITinyMCEResourceTypesSchema\n+from plone.base.interfaces import ITinyMCEAdvancedSchema\n+from plone.base.interfaces import ITinyMCESchema\n+from plone.base.interfaces import ITinyMCEPluginSchema\n from plone.app.registry.browser import controlpanel\n from z3c.form import field\n from z3c.form import group\ndiff --git a/Products/CMFPlone/controlpanel/browser/types.pt b/Products/CMFPlone/controlpanel/browser/types.pt\nindex 9bc8e87829..2f30312d72 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.pt\n+++ b/Products/CMFPlone/controlpanel/browser/types.pt\n@@ -10,12 +10,12 @@\n \n <metal:main metal:fill-slot="prefs_configlet_main">\n \n-    <h1 class="documentFirstHeading"\n-        i18n:translate="heading_type_settings">Content Settings</h1>\n-\n-    <div class="documentDescription" i18n:translate="description_types_setup">\n-        Workflow, visibility and versioning settings for your content types.\n-    </div>\n+    <header>\n+        <h1 i18n:translate="heading_type_settings">Content Settings</h1>\n+        <p class="lead" i18n:translate="description_types_setup">\n+            Workflow, visibility and versioning settings for your content types.\n+        </p>\n+    </header>\n \n     <div id="content-core"\n          tal:define="token context/@@authenticator/token">\n@@ -27,40 +27,43 @@\n             <input type="hidden" name="old_type_id" tal:attributes="value type_id" />\n \n             <fieldset>\n-                <select name="type_id" onchange="form.submit()">\n-\n-                    <tal:option repeat="selectable view/selectable_types">\n-                        <option tal:content="selectable/title" i18n:translate=""\n-                                tal:attributes="value selectable/id;\n-                                                selected python:type_id == selectable[\'id\'] and \'selected\' or None">\n-                                Content type\n+                <div class="field mb-3">\n+                    <select name="type_id" class="form-select select-widget required choice-field" onchange="form.submit()">\n+\n+                        <tal:option repeat="selectable view/selectable_types">\n+                            <option tal:content="selectable/title" i18n:translate=""\n+                                    tal:attributes="value selectable/id;\n+                                                    selected python:type_id == selectable[\'id\'] and \'selected\' or None">\n+                                    Content type\n+                            </option>\n+                        </tal:option>\n+                        <option\n+                            value=""\n+                            i18n:translate="label_default_type"\n+                            tal:attributes="selected python:type_id == \'\' and \'selected\' or None">\n+                        (Default)\n                         </option>\n-                    </tal:option>\n-                    <option\n-                        value=""\n-                        i18n:translate="label_default_type"\n-                        tal:attributes="selected python:type_id == \'\' and \'selected\' or None">\n-                      (Default)\n-                    </option>\n-                </select>\n-                <noscript>\n-                    <input type="submit"\n-                           name="form.button.SelectContentType"\n-                           class="standalone"\n-                           value="Change"\n-                           i18n:attributes="value label_change;" />\n-                </noscript>\n-\n-               <tal:block tal:condition="python:type_id!=\'\'">\n-\n-                   <p class="discreet"\n-                      tal:content="view/selected_type_description"\n-                      tal:condition="view/selected_type_description"\n-                      i18n:translate="">\n-                       Type description\n-                   </p>\n-\n-                   <div class="field">\n+                    </select>\n+                    <noscript>\n+                        <button type="submit"\n+                            name="form.button.SelectContentType"\n+                            class="btn btn-primary"\n+                            value="Change"\n+                            i18n:translate=""\n+                            i18n:attributes="value label_change;">Change</button>\n+                    </noscript>\n+                </div>\n+\n+                <tal:block tal:condition="python:type_id!=\'\'">\n+\n+                    <p class="text-muted"\n+                        tal:content="view/selected_type_description"\n+                        tal:condition="view/selected_type_description"\n+                        i18n:translate="">\n+                        Type description\n+                    </p>\n+\n+                   <div class="field mb-3">\n                         <input id="addable"\n                                type="checkbox"\n                                class="noborder"\n@@ -117,11 +120,11 @@\n                         </tal:block>\n                     </div>\n \n-                    <div class="field">\n+                    <div class="field mb-3">\n                         <label for="versionpolicy" i18n:translate="types_controlpanel_versionpolicy">\n                             Versioning policy:\n                         </label>\n-                        <select id="versionpolicy" name="versionpolicy"\n+                        <select class="form-select select-widget required choice-field" name="versionpolicy"\n                                 tal:define="current_policy view/current_versioning_policy">\n                             <option tal:repeat="policy view/versioning_policies"\n                                     tal:attributes="value policy/id;\n@@ -130,8 +133,7 @@\n                         </select>\n                     </div>\n \n-\n-                    <div class="field">\n+                    <div class="field mb-3">\n                         <a tal:attributes="href string:${context/absolute_url}/@@manage-content-type-portlets?key=${type_id}&_authenticator=${token}"\n                             i18n:translate="types_controlpanel_manage_portlets">\n                             Manage portlets assigned to this content type\n@@ -141,8 +143,8 @@\n \n                 <tal:workflows define="current_wf view/current_workflow">\n \n-                    <div class="field">\n-                        <label i18n:translate="types_controlpanel_current_workflow">Current workflow:</label>\n+                    <div class="field mb-3">\n+                        <label class="form-label" i18n:translate="types_controlpanel_current_workflow">Current workflow:</label>\n                         <span tal:content="current_wf/title"\n                               i18n:translate="">Community Workflow</span>\n                     </div>\n@@ -156,11 +158,11 @@\n                       </tal:list-type>\n                     </ul>\n \n-                    <div class="field">\n-                        <label for="new_workflow"\n+                    <div class="field mb-3">\n+                        <label class="form-label" for="new_workflow"\n                                i18n:translate="types_controlpanel_new_workflow">New workflow:</label>\n \n-                        <select onchange="form.submit()" id="workflows" name="new_workflow"\n+                        <select onchange="form.submit()" id="workflows" class ="form-select select-widget required choice-field" name="new_workflow"\n                             tal:define="selected_wf view/new_workflow">\n \n                             <tal:wfs repeat="wf view/available_workflows">\n@@ -177,11 +179,11 @@\n                                 i18n:translate="types_controlpanel_no_workflow">No Workflow</option>\n                         </select>\n                         <noscript>\n-                            <input type="submit"\n+                            <button type="submit"\n                                    name="form.button.SelectWorkflow"\n-                                   class="standalone"\n+                                   class="btn btn-primary"\n                                    value="Change"\n-                                   i18n:attributes="value label_change;" />\n+                                   i18n:attributes="value label_change;" i18n:translate="label_change">Change</button>\n                         </noscript>\n                     </div>\n \n@@ -200,38 +202,34 @@\n                     </ul>\n \n                     <div tal:define="new_workflow view/new_workflow"\n-                         tal:condition="python:view.have_new_workflow() and not view.new_workflow_is_none() and view.new_workflow_is_different()">\n+                         tal:condition="python:view.have_new_workflow() and not view.new_workflow_is_none() and view.new_workflow_is_different()"\n+                         class="field mb-3">\n \n-                        <label for="states" i18n:translate="types_controlpanel_state_mapping">\n+                        <label class="form-label" for="states" i18n:translate="types_controlpanel_state_mapping">\n                             State Mapping\n                         </label>\n \n-                        <div class="formHelp" i18n:translate="types_controlpanel_state_mapping_help">\n-                            When changing workflows, you have to select a state equivalent in the\n-                            new workflow.\n-                        </div>\n-\n                         <table id="states"\n-                               class="listing nosort"\n+                               class="table table-bordered table-striped"\n                                tal:define="new_wf_states view/new_workflow_available_states">\n                             <thead>\n                                 <tr>\n-                                    <th i18n:translate="types_controlpanel_old_state">Old State</th>\n-                                    <th i18n:translate="types_controlpanel_new_state">New State</th>\n+                                    <th i18n:translate="types_controlpanel_old_state">Old State:</th>\n+                                    <th i18n:translate="types_controlpanel_new_state">New State:</th>\n                                 </tr>\n                             </thead>\n                             <tbody>\n                                 <tal:states repeat="state_map view/suggested_state_map">\n                                     <tr tal:define="oddrow repeat/state_map/odd;"\n                                         tal:attributes="class python:oddrow and \'odd\' or \'even\'">\n-                                        <td>\n+                                        <td class="align-middle">\n                                             <input type="hidden"\n                                                    tal:attributes="name string:new_wfstates.old_state:records;\n                                                                    value state_map/old_id" />\n                                             <span tal:content="state_map/old_title">Published</span>\n                                         </td>\n-                                        <td>\n-                                            <select tal:attributes="name string:new_wfstates.new_state:records">\n+                                        <td class="align-middle">\n+                                            <select tal:attributes="name string:new_wfstates.new_state:records" class ="form-select select-widget required choice-field">\n                                               <tal:states repeat="new_state new_wf_states">\n                                                 <option\n                                                     tal:attributes="value new_state/id;\n@@ -244,29 +242,36 @@\n                                 </tal:states>\n                             </tbody>\n                         </table>\n+                        <small class="form-text text-muted" i18n:translate="types_controlpanel_state_mapping_help">\n+                            When changing workflows, you have to select a state equivalent in the\n+                            new workflow.\n+                        </small>\n                     </div>\n \n                 </tal:workflows>\n \n-                <div tal:condition="view/have_new_workflow" class="portalMessage info" role="status">\n-                    <strong i18n:translate="">Info</strong>\n+                <div tal:condition="view/have_new_workflow" class="alert alert-primary mb-3" role="status">\n+                    <strong i18n:translate="">Info:</strong>\n                     <span i18n:translate="types_controlpanel_warn_remap">\n                         Changing the workflow of a type will take a while, and may slow down\n                         the site significantly while the content is updated to the new setting.\n                     </span>\n                 </div>\n \n-                <div class="formControls">\n-                  <input type="submit"\n+                <div class="formControls mb-3">\n+                  <button type="submit"\n                          value="Save"\n                          name="form.button.Save"\n-                         class="context"\n-                         i18n:attributes="value Save;" />\n-                  <input type="submit"\n+                         class="btn btn-primary"\n+                         i18n:translate=""\n+                         i18n:attributes="value Save;">Save</button>\n+\n+                  <button type="submit"\n                          value="Cancel"\n                          name="form.button.Cancel"\n-                         class="standalone"\n-                         i18n:attributes="value label_cancel;" />\n+                         class="btn btn-secondary"\n+                         i18n:translate=""\n+                         i18n:attributes="value label_cancel;">Cancel</button>\n                 </div>\n \n             </fieldset>\ndiff --git a/Products/CMFPlone/controlpanel/browser/types.py b/Products/CMFPlone/controlpanel/browser/types.py\nindex 7797b148d4..e534c0318c 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.py\n+++ b/Products/CMFPlone/controlpanel/browser/types.py\n@@ -2,9 +2,9 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.events import ConfigurationChangedEvent\n-from Products.CMFPlone.interfaces import ISearchSchema\n-from Products.CMFPlone.interfaces import ITypesSchema\n-from Products.CMFPlone.utils import safe_unicode\n+from plone.base.interfaces import ISearchSchema\n+from plone.base.interfaces import ITypesSchema\n+from plone.base.utils import safe_text\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n from operator import itemgetter\n@@ -54,7 +54,7 @@ class TypesControlPanel(AutoExtensibleForm, form.EditForm):\n     form_name = _("Types settings")\n     control_panel_view = "content-controlpanel"\n     template = ViewPageTemplateFile(\'types.pt\')\n-    behavior_name = \'plone.app.versioningbehavior.behaviors.IVersionable\'\n+    behavior_name = \'plone.versioning\'\n \n     @button.buttonAndHandler(_(\'Save\'), name=\'save\')\n     def handleSave(self, action):\n@@ -94,7 +94,7 @@ def add_versioning_behavior(self, fti):\n         if self.behavior_name not in behaviors:\n             behaviors.append(self.behavior_name)\n         # locking must be turned on for versioning support on the type\n-        locking = \'plone.app.lockingbehavior.behaviors.ILocking\'\n+        locking = \'plone.locking\'\n         if locking not in behaviors:\n             behaviors.append(locking)\n \n@@ -156,7 +156,7 @@ def __call__(self):\n                     else:\n                         # check if we should add\n                         if type_id not in versionable_types:\n-                            versionable_types.append(safe_unicode(type_id))\n+                            versionable_types.append(safe_text(type_id))\n                         self.add_versioning_behavior(fti)\n \n                     for policy in portal_repository.listPolicies():\n@@ -193,9 +193,9 @@ def __call__(self):\n                 types_settings = registry.forInterface(\n                     ITypesSchema, prefix="plone")\n                 default_page_types = [\n-                    safe_unicode(i) for i in types_settings.default_page_types]\n+                    safe_text(i) for i in types_settings.default_page_types]\n                 if default_page_type and type_id not in default_page_types:\n-                    default_page_types.append(safe_unicode(type_id))\n+                    default_page_types.append(safe_text(type_id))\n                 elif not default_page_type and type_id in default_page_types:\n                     default_page_types.remove(type_id)\n                 types_settings.default_page_types = default_page_types\n@@ -365,7 +365,7 @@ def current_workflow(self):\n                 wf_id = chain[0]\n                 wf = getattr(portal_workflow, wf_id)\n                 title = translate(\n-                    safe_unicode(wf.title),\n+                    safe_text(wf.title),\n                     domain=\'plone\',\n                     context=self.request\n                 )\n@@ -373,7 +373,7 @@ def current_workflow(self):\n                     id=wf.id,\n                     title=title,\n                     description=format_description(\n-                        safe_unicode(wf.description),\n+                        safe_text(wf.description),\n                         self.request\n                     )\n                 )\n@@ -384,7 +384,7 @@ def current_workflow(self):\n             return empty_workflow_dict\n \n         default_title = translate(\n-            safe_unicode(default_workflow.title),\n+            safe_text(default_workflow.title),\n             domain=\'plone\',\n             context=self.request\n         )\n@@ -420,7 +420,7 @@ def available_workflows(self):\n             # Only offer a default workflow option on a real type\n             default_workflow = self.default_workflow(False)\n             default_title = translate(\n-                safe_unicode(default_workflow.title),\n+                safe_text(default_workflow.title),\n                 domain=\'plone\',\n                 context=self.request\n             )\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups.py b/Products/CMFPlone/controlpanel/browser/usergroups.py\nindex 40fb8894bf..2819742a47 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups.py\n@@ -4,7 +4,7 @@\n from Acquisition import aq_inner\n from Products.CMFPlone.utils import normalizeString\n from zope.component import getAdapter\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISecuritySchema\n from zope.component import getMultiAdapter\n from AccessControl import getSecurityManager\n from Products.Five.browser import BrowserView\n@@ -15,7 +15,7 @@\n from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form import form\n \n-from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema\n+from plone.base.interfaces import IUserGroupsSettingsSchema\n from z3c.form import button\n \n \n@@ -23,7 +23,6 @@ class UserGroupsSettingsControlPanel(AutoExtensibleForm, form.EditForm):\n     schema = IUserGroupsSettingsSchema\n     id = "usergroupsettings-control-panel"\n     label = _("Users and Groups")\n-    description = _("User and groups settings for this site.")\n     form_name = _("User/Groups settings")\n     control_panel_view = "usergroups-controlpanel"\n \n@@ -34,7 +33,7 @@ def handleApply(self, action):\n     def updateActions(self):\n         super().updateActions()\n         if self.actions and \'save\' in self.actions:\n-            self.actions[\'save\'].addClass(\'context\')\n+            self.actions[\'save\'].addClass(\'btn-primary\')\n \n \n class ControlPanelFormWrapper(layout.FormWrapper):\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.pt b/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.pt\nindex 135c9fa17f..67e738a52d 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.pt\n@@ -6,9 +6,10 @@\n       metal:use-macro="context/prefs_main_template/macros/master"\n       i18n:domain="plone">\n \n+\n <body>\n \n-<metal:main fill-slot="prefs_configlet_content"\n+<metal:main fill-slot="prefs_configlet_main"\n      tal:define="template_id string:@@usergroup-groupdetails;\n                  portal_roles view/portal_roles;\n                  groupquery python:view.makeQuery(groupname=view.groupname);\n@@ -24,20 +25,17 @@\n           </metal:title>\n \n           <metal:name metal:fill-slot="name">\n-              <div class="field">\n-                  <label for="addname" i18n:translate="label_name">Name</label>\n-\n-                  <span class="fieldRequired" title="Required"\n-                        i18n:attributes="title title_required;"\n-                        i18n:translate="label_required">(Required)</span>\n-\n-                   <div class="formHelp" i18n:translate="help_groupname">\n-                   A unique identifier for the group. Can not be changed after creation.\n-                   </div>\n-\n+              <div class="mb-3">\n+                  <label class="form-label" for="addname">\n+                    <span i18n:translate="label_name">Name</span>\n+                    <span class="required" i18n:attributes="title title_required;" title="Required"></span>\n+                  </label>\n                   <input type="text" name="addname" value="groupname"\n-                         id="addname"\n+                         id="addname" class="form-control"\n                          tal:attributes="value view/groupname | string:"/>\n+                  <small class="form-text text-muted" i18n:translate="help_groupname">\n+                  A unique identifier for the group. Can not be changed after creation.\n+                  </small>\n               </div>\n           </metal:name>\n       </metal:block>\n@@ -47,7 +45,7 @@\n     <metal:block define-macro="props">\n \n       <a href="${portal_url}/@@usergroup-groupprefs"\n-         class="link-parent"\n+         class="link-parent" tal:condition="view/group"\n          i18n:translate="label_up_to_groups_overview">\n          Up to Groups Overview\n       </a>\n@@ -64,17 +62,17 @@\n            tal:define="token context/@@authenticator/token">\n         <div class="autotabs">\n \n-          <nav class="autotoc-nav">\n-            <a href="${portal_url}/@@usergroup-groupmembership?${groupquery}"\n+          <div tal:condition="view/group" class="nav nav-pills">\n+            <a href="${portal_url}/@@usergroup-groupmembership?${groupquery}" class="nav-link"\n                i18n:translate="label_group_members">Group Members</a>\n-            <a class="active"\n+            <a class="nav-link active"\n                href="${portal_url}/@@usergroup-groupdetails?${groupquery}"\n                i18n:translate="label_group_properties">Group Properties</a>\n-            <a href="${portal_url}/@@manage-group-portlets?${groupkeyquery}&_authenticator=${token}"\n+            <a href="${portal_url}/@@manage-group-portlets?${groupkeyquery}&_authenticator=${token}" class="nav-link"\n                i18n:translate="label_group_portlets">Group Portlets</a>\n-            <a href="${portal_url}/@@manage-group-dashboard?${groupkeyquery}&_authenticator=${token}"\n+            <a href="${portal_url}/@@manage-group-dashboard?${groupkeyquery}&_authenticator=${token}" class="nav-link"\n                i18n:translate="label_group_dashboard">Group Dashboard</a>\n-          </nav>\n+          </div>\n \n           <form action=""\n                 id="createGroup"\n@@ -85,30 +83,23 @@\n                 tal:define="targetobject context/portal_groupdata;">\n \n               <fieldset>\n-                  <div class="field" metal:define-slot="name">\n-                     <label for="groupname" i18n:translate="label_name">Name</label>\n-\n-                     <div tal:content="view/groupname | string:" />\n+                  <div class="mb-3" metal:define-slot="name">\n+                     <label class="form-label" for="groupname" i18n:translate="label_name">Name</label>\n+                     <p>\n+                      <strong class="" tal:content="view/groupname | string:"/>\n+                     </p>\n                      <input type="hidden" name="groupname" value="groupname"\n-                            id="groupname"\n+                            id="groupname" class="form-control"\n                             tal:attributes="value view/groupname | string:"/>\n                   </div>\n \n-                   <tal:set tal:condition="targetobject/management_page_charset|nothing"\n-                            tal:define="dummy python:request.set(\'management_page_charset_tag\',\'\')" />\n-\n-                   <tal:set tal:condition="not:targetobject/management_page_charset|nothing">\n-                      <tal:defines define="dummy python:request.set(\'management_page_charset\',\'UTF-8\');\n-                                           dummy python:request.set(\'management_page_charset_tag\',\'UTF-8:\');" />\n-                   </tal:set>\n-\n                   <tal:properties repeat="property targetobject/propertyMap">\n-                      <div class="field"\n+                      <div class="field mb-3"\n                            tal:define="id property/id;\n                                        type property/type;\n                                        propertyvalue python:view.get_group_property(id);">\n \n-                      <label for="value"\n+                      <label class="form-label" for="value"\n                               tal:attributes="for id"\n                               i18n:translate=""\n                               tal:content="python:targetobject.propertyLabel(id).capitalize()">Property Value</label>\n@@ -117,29 +108,33 @@\n                                        disabled python:None if (not view.group or view.group.canWriteProperty(id)) else \'disabled\';"\n                       tal:condition="python:\'w\' in property.get(\'mode\', \'awd\')">\n \n-                      <input type="text" name="id" size="35"\n+                      <input type="text" name="id" size="35" class="form-control"\n                               tal:condition="python:type in (\'int\', \'long\')"\n                               tal:attributes="name string:$id:$type;\n                                               id id;\n                                               value python:propertyvalue if propertyvalue else \'\';\n                                               disabled disabled;" />\n \n-                      <input type="text" name="id" size="35"\n+                      <input type="text" name="id" size="35" class="form-control"\n                               tal:condition="python:type in (\'float\',\'date\')"\n-                              tal:attributes="name string:$id:${request/management_page_charset_tag}$type;\n+                              tal:attributes="name string:$id:$type;\n                                               id id;\n                                               value python:propertyvalue if propertyvalue else \'\';\n                                               disabled disabled;" />\n-\n-                      <input type="text" name="string and ustring" size="35"\n+                      <tal:comment condition="nothing">\n+                        Unicode property types, like ustring, are deprecated and should not be used in Plone 6 (Zope 5).\n+                        Core Plone should not need them, but there could be custom groups that use them,\n+                        so we keep the compatibility checks in here.\n+                      </tal:comment>\n+                      <input type="text" name="string and ustring" size="35" class="form-control"\n                               tal:condition="python:type in (\'string\',\'ustring\')"\n-                              tal:attributes="name string:$id:${request/management_page_charset_tag}$type;\n+                              tal:attributes="name string:$id:$type;\n                                               id id;\n                                               value python:propertyvalue if propertyvalue else \'\';\n                                               disabled disabled;" />\n \n                       <input type="checkbox"\n-                              class="noborder"\n+                              class="noborder form-control"\n                               name="id"\n                               id="cb-checkbox"\n                               tal:condition="python: type in (\'boolean\',)"\n@@ -148,25 +143,25 @@\n                                               checked python:\'checked\' if propertyvalue else \'\';\n                                               disabled disabled;" />\n \n-                      <input name="tokens and utokens" value="" type="text" size="35"\n+                      <input name="tokens and utokens" value="" type="text" size="35" class="form-control"\n                               tal:condition="python:type in (\'tokens\', \'utokens\')"\n-                              tal:attributes="name string:$id:${request/management_page_charset_tag}$type;\n+                              tal:attributes="name string:$id:$type;\n                                               value python:propertyvalue if propertyvalue else \'\';\n                                               disabled disabled;" />\n \n-                      <textarea name="text and utext"\n+                      <textarea name="text and utext" class="form-control"\n                               rows="6"\n                               cols="35"\n                               tal:condition="python: type in (\'text\', \'utext\')"\n-                              tal:attributes="name string:$id:${request/management_page_charset_tag}$type;\n+                              tal:attributes="name string:$id:$type;\n                                               disabled disabled;"\n                               tal:content="propertyvalue">some data</textarea>\n \n-                      <textarea name="lines and ulines"\n+                      <textarea name="lines and ulines" class="form-control"\n                               rows="6"\n                               cols="35"\n                               tal:condition="python: type in (\'lines\', \'ulines\')"\n-                              tal:attributes="name string:$id:${request/management_page_charset_tag}$type;\n+                              tal:attributes="name string:$id:$type;\n                                               disabled disabled;"\n                               tal:content="python: propertyvalue and \'\\n\'.join(propertyvalue) or \'\'">\n                       </textarea>\n@@ -177,7 +172,7 @@\n                                       select_value python:select_variable and path(\'context/%s\' %select_variable) or [];">\n \n                       <select name="selection" tal:condition="python:type in (\'selection\',)"\n-                          tal:attributes="name string:$id:${request/management_page_charset_tag}text;\n+                          tal:attributes="name string:$id:text;\n                                           disabled disabled;">\n                           <tal:values repeat="option select_value">\n                               <option tal:attributes="SELECTED python:\'SELECTED\' if propertyvalue==option else \'\'"\n@@ -186,7 +181,7 @@\n                       </select>\n \n                       <select name="multiple selection" multiple="multiple" tal:condition="python:type in (\'multiple selection\',)"\n-                              tal:attributes="name string:$id:${request/management_page_charset_tag}list:string;\n+                              tal:attributes="name string:$id:list:string;\n                                               size python:min(7, len(select_value));\n                                               disabled disabled;">\n                           <tal:values repeat="option select_value">\n@@ -202,18 +197,16 @@\n                       </div>\n                   </tal:properties>\n \n-                  <input type="hidden" name="form.submitted" value="1" />\n-\n-                  <div class="formControls">\n-                      <input class="context"\n-                             type="submit"\n-                             name="form.button.Save"\n-                             value="Save"\n-                             i18n:attributes="value label_save;" />\n-                  </div>\n+                  <input type="hidden" name="form.submitted" value="1" class="form-control"/>\n+                  <button class="btn btn-primary"\n+                          type="submit"\n+                          name="form.button.Save"\n+                          value="Save"\n+                          i18n:translate=""\n+                          i18n:attributes="value label_save;">Save</button>\n               </fieldset>\n \n-              <input tal:replace="structure context/@@authenticator/authenticator" />\n+              <input class="form-control" tal:replace="structure context/@@authenticator/authenticator" />\n           </form>\n         </div>\n       </div>\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt\nindex b8178b6a32..ffbd86c817 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt\n@@ -8,25 +8,25 @@\n \n <body>\n \n-<metal:main fill-slot="prefs_configlet_content"\n+<metal:main fill-slot="prefs_configlet_main"\n      tal:define="template_id string:@@usergroup-groupmembership;\n                  errors python:request.get(\'errors\', {});\n                  portal_roles view/portal_roles;">\n \n   <article id="content">\n \n-    <a href=""\n-       class="link-parent"\n-       tal:attributes="href string:$portal_url/@@usergroup-groupprefs"\n-       i18n:translate="label_up_to_groups_overview">\n-      Up to Groups Overview\n-    </a>\n-\n     <tal:ifnogroups tal:condition="not:view/group | nothing">\n       <h1 class="documentFirstHeading"\n           i18n:translate="heading_group_members">Group Members</h1>\n \n-      <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n+        <a href=""\n+           class="link-parent"\n+           tal:attributes="href string:$portal_url/@@usergroup-groupprefs"\n+           i18n:translate="label_up_to_groups_overview">\n+          Up to Groups Overview\n+        </a>\n+\n+       <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n         Portal status message\n       </div>\n \n@@ -53,160 +53,174 @@\n           <h1 class="documentFirstHeading"\n               i18n:translate="heading_group_members_of">Group: <span i18n:name="groupname" tal:replace="view/grouptitle">groupname</span></h1>\n \n-          <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n-            Portal status message\n-          </div>\n+            <a href=""\n+               class="link-parent mb-3 d-block"\n+               tal:attributes="href string:$portal_url/@@usergroup-groupprefs"\n+               i18n:translate="label_up_to_groups_overview">\n+              Up to Groups Overview\n+            </a>\n \n-          <div id="content-core"\n+            <div id="content-core"\n                tal:define="token context/@@authenticator/token">\n \n-            <div class="autotabs">\n-\n-              <nav class="autotoc-nav">\n-                <a class="active"\n-                   href="${portal_url}/@@usergroup-groupmembership?${groupquery}"\n-                   i18n:translate="label_group_members">Group Members</a>\n-                <a href="${portal_url}/@@usergroup-groupdetails?${groupquery}"\n-                   i18n:translate="label_group_properties">Group Properties</a>\n-                <a href="${portal_url}/@@manage-group-portlets?${groupkeyquery}&_authenticator=${token}"\n-                   i18n:translate="label_group_portlets">Group Portlets</a>\n-                <a href="${portal_url}/@@manage-group-dashboard?${groupkeyquery}&_authenticator=${token}"\n-                   i18n:translate="label_group_dashboard">Group Dashboard</a>\n-              </nav>\n-\n-              <p i18n:translate="description_group_members_of">\n-                You can add or remove groups and users from this particular group here. Note that this\n-                doesn\'t actually delete the group or user, it is only removed from this group.\n-              </p>\n-\n-              <form action=""\n-                        name="groups"\n-                        method="post"\n-                        tal:attributes="action string:$portal_url/$template_id?groupname=${view/groupname}"\n-                        tal:define="batch python:Batch(view.searchResults, b_size, int(b_start));\n-                                    batchformkeys python:[\'searchstring\',\'_authenticator\',\'groupname\',\'form.submitted\'];\n-                                    many_users view/many_users">\n-                <h2 i18n:translate="heading_groupmembers_current">Current group members</h2>\n-                  <table class="listing" summary="Group Members Listing"\n-                     tal:condition="view/groupMembers">\n-\n-                      <tr>\n-                          <th>\n-                              <input class="noborder"\n-                                     type="checkbox"\n-                                     src="select_all_icon.png"\n-                                     name="selectButton"\n-                                     title="Select all items"\n-                                     onClick="toggleSelect(this, \'delete:list\');"\n-                                     tal:attributes="src string:$portal_url/select_all_icon.png"\n-                                     alt="Select all items"\n-                                     i18n:attributes="title label_select_all_items; alt label_select_all_items;"/>\n-                                     <!--Remove user from this group-->\n-                          </th>\n-                          <th i18n:translate="listingheader_user_name">User name</th>\n-                          <th i18n:translate="listingheader_email_address">E-mail Address</th>\n-                      </tr>\n-\n-                      <tal:block tal:repeat="this_user view/groupMembers">\n-                        <tr tal:condition="python:this_user is not None"\n-                            tal:define="oddrow repeat/this_user/odd"\n-                            tal:attributes="class python:oddrow and \'odd\' or \'even\'">\n-                            <td class="listingCheckbox">\n-                                <input\n-                                       type="checkbox"\n-                                       class="noborder notify"\n-                                       name="delete:list"\n-                                       tal:attributes="value this_user/getId;\n-                                                       disabled python:this_user.canRemoveFromGroup(view.groupname) and default or \'disabled\'" />\n-                            </td>\n-\n-                            <tal:block tal:condition="python: view.isGroup(this_user)">\n-                              <td>\n-                                <img src="group.png" alt="" />\n-                                <a href="" tal:attributes="href python:\'@@usergroup-groupdetails?\' + view.makeQuery(groupname=this_user.getGroupName())" >\n-                                  <span tal:replace="this_user/getGroupTitleOrName | default" />\n-                                  (<span tal:replace="this_user/id" />)\n-                                </a>\n-                              </td>\n-                            </tal:block>\n-\n-                            <tal:block tal:condition="python: not view.isGroup(this_user)">\n-                              <td>\n-                                <img src="user.png" alt="" />\n-                                <a href="" tal:attributes="href python:\'@@user-information?\' + view.makeQuery(userid=this_user.getId());\n-                                                           title this_user/getId">\n-                                    <span tal:replace="python:this_user.getProperty(\'fullname\')">Full Name</span>\n-                                    <tal:userid tal:condition="not:view/email_as_username">\n-                                        (<span tal:replace="this_user/getUserName | default" />)\n-                                    </tal:userid>\n-                                </a>\n-                              </td>\n-                            </tal:block>\n-\n-                            <td tal:define="email python: this_user.getProperty(\'email\')">\n-                                <a  href="#"\n-                                    tal:attributes="href string:mailto:${email}"\n-                                    title="Send a mail to this user"\n-                                    i18n:attributes="title title_send_mail_to_user;"\n-                                    tal:condition="email">\n-                                    <span tal:replace="email" />\n-                                </a>\n-                            </td>\n-                        </tr>\n-                      </tal:block>\n-                  </table>\n-\n-\n-                  <p tal:condition="not:view/groupMembers" i18n:translate="decription_no_members_assigned">There is no group or user attached to this group.</p>\n-\n-                  <input class="destructive"\n-                         type="submit"\n-                         name="form.button.Edit"\n-                         value="Remove selected groups / users"\n-                         i18n:attributes="value label_remove_selected_users;"\n-                         tal:condition="view/groupMembers" />\n-\n-                <tal:addusers tal:condition="view/canAddUsers">\n-\n-                    <h2 i18n:translate="heading_search_newmembers">Search for new group members</h2>\n+            <div tal:condition="view/group" class="nav nav-pills">\n+              <a class="nav-link active"\n+                  href="${portal_url}/@@usergroup-groupmembership?${groupquery}"\n+                  i18n:translate="label_group_members">Group Members</a>\n+              <a class="nav-link"\n+                  href="${portal_url}/@@usergroup-groupdetails?${groupquery}"\n+                  i18n:translate="label_group_properties">Group Properties</a>\n+              <a href="${portal_url}/@@manage-group-portlets?${groupkeyquery}&_authenticator=${token}" class="nav-link"\n+                  i18n:translate="label_group_portlets">Group Portlets</a>\n+              <a href="${portal_url}/@@manage-group-dashboard?${groupkeyquery}&_authenticator=${token}" class="nav-link"\n+                i18n:translate="label_group_dashboard">Group Dashboard</a>\n+            </div>\n+            <div class="text-muted mt-2 mb-4"\n+                 i18n:translate="description_group_members_of">\n+              You can add or remove groups and users from this particular group here. Note that this\n+              doesn\'t actually delete the group or user, it is only removed from this group.\n+            </div>\n+            <form action=""\n+                  name="groups"\n+                  method="post"\n+                  tal:attributes="action string:$portal_url/$template_id?groupname=${view/groupname}"\n+                  tal:define="batch python:Batch(view.searchResults, b_size, int(b_start));\n+                              batchformkeys python:[\'searchstring\',\'_authenticator\',\'groupname\',\'form.submitted\'];\n+                              many_users view/many_users">\n+              <h2 i18n:translate="heading_groupmembers_current">Current group members</h2>\n+              <table class="table table-responsive table-bordered table-striped" summary="Group Members Listing"\n+                  tal:condition="view/groupMembers">\n+                <thead>\n+                  <tr>\n+                      <th>\n+                          <input class="noborder"\n+                                  type="checkbox"\n+                                  src="select_all_icon.png"\n+                                  name="selectButton"\n+                                  title="Select all items"\n+                                  onClick="toggleSelect(this, \'delete:list\');"\n+                                  tal:attributes="src string:$portal_url/select_all_icon.png"\n+                                  alt="Select all items"\n+                                  i18n:attributes="title label_select_all_items; alt label_select_all_items;"/>\n+                                  <!--Remove user from this group-->\n+                      </th>\n+                      <th i18n:translate="listingheader_user_name">User name</th>\n+                      <th i18n:translate="listingheader_email_address">E-mail Address</th>\n+                  </tr>\n+                </thead>\n+                <tbody>\n+                  <tal:block tal:repeat="this_user view/groupMembers">\n+                    <tr tal:condition="python:this_user is not None"\n+                        tal:define="oddrow repeat/this_user/odd"\n+                        tal:attributes="class python:oddrow and \'odd\' or \'even\'">\n+                        <td class="listingCheckbox">\n+                            <input\n+                                    type="checkbox"\n+                                    class="noborder notify"\n+                                    name="delete:list"\n+                                    tal:attributes="value this_user/getId;\n+                                                    disabled python:this_user.canRemoveFromGroup(view.groupname) and default or \'disabled\'" />\n+                        </td>\n+\n+                        <tal:block tal:condition="python: view.isGroup(this_user)">\n+                          <td>\n+                            <img src="group.png" alt="" />\n+                            <a href="" tal:attributes="href python:\'@@usergroup-groupdetails?\' + view.makeQuery(groupname=this_user.getGroupName())" >\n+                              <span tal:replace="this_user/getGroupTitleOrName | default" />\n+                              (<span tal:replace="this_user/id" />)\n+                            </a>\n+                          </td>\n+                        </tal:block>\n \n-                    <input type="hidden" name="form.submitted" value="1" />\n+                        <tal:block tal:condition="python: not view.isGroup(this_user)">\n+                          <td>\n+                            <img src="user.png" alt="" />\n+                            <a href="" tal:attributes="href python:\'@@user-information?\' + view.makeQuery(userid=this_user.getId());\n+                                                        title this_user/getId">\n+                                <span tal:replace="python:this_user.getProperty(\'fullname\')">Full Name</span>\n+                                <tal:userid tal:condition="not:view/email_as_username">\n+                                    (<span tal:replace="this_user/getUserName | default" />)\n+                                </tal:userid>\n+                            </a>\n+                          </td>\n+                        </tal:block>\n \n-                    <table class="listing" summary="Groups">\n+                        <td tal:define="email python: this_user.getProperty(\'email\')">\n+                            <a  href="#"\n+                                tal:attributes="href string:mailto:${email}"\n+                                title="Send a mail to this user"\n+                                i18n:attributes="title title_send_mail_to_user;"\n+                                tal:condition="email">\n+                                <span tal:replace="email" />\n+                            </a>\n+                        </td>\n+                    </tr>\n+                  </tal:block>\n+                </tbody>\n+                <tfoot>\n+                  <tr>\n+                    <td colspan="3">\n+                      <button class="btn btn-danger"\n+                              type="submit"\n+                              name="form.button.Edit"\n+                              value="Remove selected groups / users"\n+                              i18n:translate="label_remove_selected_users"\n+                              tal:condition="view/groupMembers">Remove selected Groups / Users</button>\n+                    </td>\n+                  </tr>\n+                </tfoot>\n+              </table>\n+              <p tal:condition="not:view/groupMembers" i18n:translate="decription_no_members_assigned">There is no group or user attached to this group.</p>\n+\n+\n+\n+              <tal:addusers tal:condition="view/canAddUsers">\n+\n+                  <h2 class="mt-4" i18n:translate="heading_search_newmembers">Search for new group members</h2>\n+\n+                  <input type="hidden" name="form.submitted" value="1" />\n+\n+                  <table class="table table-responsive table-bordered table-striped" summary="Groups">\n+                    <thead>\n                       <tr>\n                         <th colspan="3">\n-                          <span tal:omit-tag="" i18n:translate="label_quick_search">Quick search</span>:\n-                            <input class="quickSearch"\n-                                   type="text"\n-                                   name="searchstring"\n-                                   value=""\n-                                   tal:attributes="value view/searchString;"\n-                                   />\n-\n-                            <input type="submit"\n-                                   class="searchButton"\n-                                   name="form.button.Search"\n-                                   value="Search"\n-                                   i18n:attributes="value label_search;" />\n-                            <input type="submit"\n-                                   class="searchButton"\n-                                   name="form.button.FindAll"\n-                                   value="Show all"\n-                                   i18n:attributes="value label_search_large;"\n-                                   tal:condition="not:many_users" />\n+                          <div class="input-group">\n+                            <span class="input-group-text" i18n:translate="label_quick_search">Quick search</span>\n+                            <input class="quickSearch form-control"\n+                                    type="text"\n+                                    name="searchstring"\n+                                    value=""\n+                                    tal:attributes="value view/searchString;"\n+                                    />\n+\n+                            <button type="submit"\n+                                    class="btn btn-primary"\n+                                    name="form.button.Search"\n+                                    value="Search"\n+                                    i18n:translate=""\n+                                    i18n:attributes="value label_search;">Search</button>\n+                            <button type="submit"\n+                                    class="btn btn-secondary"\n+                                    name="form.button.FindAll"\n+                                    value="Show all"\n+                                    i18n:translate="label_search_large"\n+                                    tal:condition="not:many_users">Show all</button>\n+                          </div>\n                         </th>\n                       </tr>\n+                    </thead>\n+                    <tbody>\n                       <tr tal:condition="batch">\n                         <th>\n                             <input class="noborder"\n-                                   type="checkbox"\n-                                   src="select_all_icon.png"\n-                                   name="selectButton"\n-                                   title="Select all items"\n-                                   onClick="toggleSelect(this, \'add:list\');"\n-                                   tal:attributes="src string:$portal_url/select_all_icon.png"\n-                                   alt="Select all items"\n-                                   i18n:attributes="title label_select_all_items; alt label_select_all_items;"/>\n+                                    type="checkbox"\n+                                    src="select_all_icon.png"\n+                                    name="selectButton"\n+                                    title="Select all items"\n+                                    onClick="toggleSelect(this, \'add:list\');"\n+                                    tal:attributes="src string:$portal_url/select_all_icon.png"\n+                                    alt="Select all items"\n+                                    i18n:attributes="title label_select_all_items; alt label_select_all_items;"/>\n                         </th>\n \n                         <th i18n:translate="listingheader_group_user_name">Group/User name</th>\n@@ -220,18 +234,18 @@\n \n                           <td class="listingCheckbox">\n                             <input type="checkbox"\n-                                   class="noborder"\n-                                   name="add:list"\n-                                   value="value"\n-                                   tal:attributes="value this_user/getId;\n-                                                   disabled python:this_user.canAddToGroup(view.groupname) and default or \'disabled\'" />\n+                                    class="noborder"\n+                                    name="add:list"\n+                                    value="value"\n+                                    tal:attributes="value this_user/getId;\n+                                                    disabled python:this_user.canAddToGroup(view.groupname) and default or \'disabled\'" />\n                           </td>\n \n                           <td>\n                               <tal:block tal:condition="python:not view.isGroup(this_user)">\n                                   <img src="user.png" alt="" />\n                                   <a href="" tal:attributes="href python:\'@@user-information?\' + view.makeQuery(userid=this_user.getId());\n-                                                             title this_user/getId">\n+                                                              title this_user/getId">\n                                     <span tal:replace="python:this_user.getProperty(\'fullname\')">Full Name</span>\n                                     <tal:userid tal:condition="not:view/email_as_username">\n                                         (<span tal:replace="this_user/getUserName | default" />)\n@@ -280,42 +294,49 @@\n                         </tal:block>\n \n                       </tr>\n+                    </tbody>\n+                    <tfoot>\n+                      <tr>\n+                        <th colspan="3">\n+                          <button class="btn btn-success"\n+                                  type="submit"\n+                                  name="form.button.Add"\n+                                  value="Add selected groups and users to this group"\n+                                  tal:condition="batch"\n+                                  i18n:translate="label_add_users_to_group">Add selected groups and users to this group</button>\n+\n+                        </th>\n+                      </tr>\n+                    </tfoot>\n \n-                    </table>\n+                  </table>\n \n-                    <input type="hidden" value="b_start" name="b_start"\n-                           tal:attributes="value b_start"/>\n+                  <input type="hidden" value="b_start" name="b_start"\n+                          tal:attributes="value b_start"/>\n \n-                    <input type="hidden" value="" name="showAll"\n-                           tal:attributes="value showAll"/>\n+                  <input type="hidden" value="" name="showAll"\n+                          tal:attributes="value showAll"/>\n \n-                    <div metal:use-macro="context/batch_macros/macros/navigation" />\n+                  <div metal:use-macro="context/batch_macros/macros/navigation" />\n \n-                    <div class="showAllSearchResults"\n-                         tal:condition="python:batch.next or batch.previous"\n-                         tal:define="mq python:modules[\'ZTUtils\'].make_query;\n-                                     keys batchformkeys|nothing;\n-                                     linkparams python:keys and dict([(key, request.form[key]) for key in keys if key in request]) or request.form;\n-                                     url batch_base_url | string:${context/absolute_url}/${template_id}">\n-                        <a tal:attributes="href python: \'%s?%s\' % (url, mq( linkparams, {\'showAll\':\'y\'} ))"\n-                           i18n:translate="description_pas_show_all_search_results">\n-                            Show all search results\n-                        </a>\n-                    </div>\n+                  <div class="showAllSearchResults"\n+                        tal:condition="python:batch.next or batch.previous"\n+                        tal:define="mq python:modules[\'ZTUtils\'].make_query;\n+                                    keys batchformkeys|nothing;\n+                                    linkparams python:keys and dict([(key, request.form[key]) for key in keys if key in request]) or request.form;\n+                                    url batch_base_url | string:${context/absolute_url}/${template_id}">\n+                      <a tal:attributes="href python: \'%s?%s\' % (url, mq( linkparams, {\'showAll\':\'y\'} ))"\n+                          i18n:translate="description_pas_show_all_search_results">\n+                          Show all search results\n+                      </a>\n+                  </div>\n \n-                    <input class="context"\n-                            type="submit"\n-                            name="form.button.Add"\n-                            value="Add selected groups and users to this group"\n-                            tal:condition="batch"\n-                            i18n:attributes="value label_add_users_to_group;" />\n \n-                </tal:addusers>\n+              </tal:addusers>\n \n-                <input tal:replace="structure context/@@authenticator/authenticator" />\n+              <input tal:replace="structure context/@@authenticator/authenticator" />\n \n-              </form>\n-            </div>\n+            </form>\n           </div>\n       </tal:defs>\n     </tal:ifgroups>\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt b/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt\nindex 291e29ded1..2bab236cfb 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt\n@@ -8,66 +8,47 @@\n \n <body>\n \n-<metal:main fill-slot="prefs_configlet_content"\n-     tal:define="template_id string:@@usergroup-groupprefs;\n-                 errors python:request.get(\'errors\', {});\n-                 showAll python:request.get(\'showAll\', \'\') and not view.newSearch and \'y\';\n-                 Batch python:modules[\'Products.CMFPlone\'].Batch;\n-                 b_start python:0 if showAll or view.newSearch else request.get(\'b_start\',0);\n-                 portal_roles view/portal_roles;\n-                 search_results view/searchResults;\n-                 b_size python:showAll and len(search_results) or 20;\n-                 batch python:search_results and Batch(search_results, b_size, int(b_start), orphan=1) or None;\n-                 batchformkeys python:[\'searchstring\',\'_authenticator\'];\n-                 portal_url context/portal_url;">\n+<metal:main fill-slot="prefs_configlet_main"\n+            tal:define="template_id string:@@usergroup-groupprefs;\n+                        errors python:request.get(\'errors\', {});\n+                        showAll python:request.get(\'showAll\', \'\') and not view.newSearch and \'y\';\n+                        Batch python:modules[\'Products.CMFPlone\'].Batch;\n+                        b_start python:0 if showAll or view.newSearch else request.get(\'b_start\',0);\n+                        portal_roles view/portal_roles;\n+                        search_results view/searchResults;\n+                        b_size python:showAll and len(search_results) or 20;\n+                        batch python:search_results and Batch(search_results, b_size, int(b_start), orphan=1) or None;\n+                        batchformkeys python:[\'searchstring\',\'_authenticator\'];\n+                        portal_url context/portal_url;">\n \n   <article id="content">\n+    <header>\n+        <h1 class="documentFirstHeading"\n+            i18n:translate="">Groups</h1>\n \n-    <a id="setup-link" class="link-parent"\n-       tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-       i18n:translate="">\n-        Site Setup\n-    </a>\n-\n-    <h1 class="documentFirstHeading"\n-        i18n:translate="">Users and Groups</h1>\n-\n-    <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n-        Portal status message\n-    </div>\n-\n-    <div id="content-core">\n+        <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n+            Portal status message\n+        </div>\n \n-      <div class="autotabs">\n-        <div class="autotoc-nav">\n-          <a href="${portal_url}/@@usergroup-userprefs"\n-             i18n:translate="label_users">Users</a>\n-          <a class="active"\n-             href="${portal_url}/@@usergroup-groupprefs"\n-             i18n:translate="label_groups">Groups</a>\n-          <a href="${portal_url}/@@usergroup-controlpanel"\n-             i18n:translate="label_usergroup_settings">Settings</a>\n-          <a href="${portal_url}/@@member-fields"\n-             i18n:translate="label_member_fields">Member fields</a>\n+        <div class="text-muted mt-2">\n+            <span tal:omit-tag=""\n+                    i18n:translate="description_groups_management">\n+                Groups are logical collections of users, such as\n+                departments and business units. Groups are not directly\n+                related to permissions on a global level, you normally\n+                use Roles for that - and let certain Groups have a\n+                particular role.\n+            </span>\n+            <span tal:omit-tag=""\n+                    i18n:translate="description_groups_management2">\n+                The symbol\n+                <span i18n:name="image_link_icon"><tal:icon tal:replace="structure python:icons.tag(\'people\', tag_alt=\'Inherited from Group\')" /></span>\n+                indicates a role inherited from membership in another group.\n+            </span>\n         </div>\n+    </header>\n \n-        <p class="discreet">\n-          <span tal:omit-tag=""\n-                i18n:translate="description_groups_management">\n-            Groups are logical collections of users, such as\n-            departments and business units. Groups are not directly\n-            related to permissions on a global level, you normally\n-            use Roles for that - and let certain Groups have a\n-            particular role.\n-          </span>\n-          <span tal:omit-tag=""\n-                i18n:translate="description_groups_management2">\n-            The symbol\n-            <img i18n:name="image_link_icon"\n-                 tal:replace="structure context/site_icon.png" />\n-            indicates a role inherited from membership in another group.\n-          </span>\n-        </p>\n+    <div id="content-core">\n \n         <p i18n:translate="description_pas_group_listing"\n            tal:condition="view/show_group_listing_warning">\n@@ -77,13 +58,6 @@\n             doing a specific search.\n         </p>\n \n-        <p>\n-          <a class="pat-plone-modal" id="add-group"\n-             tal:attributes="href string:${portal_url}/@@usergroup-groupdetails">\n-             <button i18n:translate="label_add_new_group" class="context">Add New Group</button>\n-          </a>\n-        </p>\n-\n         <form action=""\n               name="groups_search"\n               method="post"\n@@ -97,68 +71,52 @@\n             <input type="hidden" value="" name="showAll"\n                    tal:attributes="value showAll"/>\n \n-            <div class="field">\n-\n-                <span tal:omit-tag=""\n-                      i18n:translate="label_group_search">\n-                    Group Search\n-                </span>\n-\n-                <input class="quickSearch"\n-                       type="text"\n-                       name="searchstring"\n-                       value=""\n-                       tal:attributes="value view/searchString;"\n-                       />\n-\n-                <input type="submit"\n-                       class="searchButton context"\n-                       name="form.button.Search"\n-                       value="Search"\n-                       i18n:attributes="value label_search;"\n-                       />\n-\n-                <input type="submit"\n-                       class="searchButton"\n-                       name="form.button.FindAll"\n-                       value="Show all"\n-                       i18n:attributes="value label_showall;"\n-                       tal:condition="not:view/many_groups"\n-                       />\n-\n+            <div class="mb-3 input-group">\n+                <a class="pat-plone-modal btn btn-success me-3" id="add-group"\n+                    tal:attributes="href string:${portal_url}/@@usergroup-groupdetails"\n+                    i18n:translate="label_add_new_group">Add New Group</a>\n+                <span class="input-group-text" id="quickSearchLabel" i18n:translate="label_group_search">Group Search</span>\n+                <input class="form-control quickSearch"\n+                    type="text"\n+                    name="searchstring"\n+                    aria-labelledby="quickSearchLabel"\n+                    value=""\n+                    tal:attributes="value view/searchString;"\n+                    />\n+                <button type="submit"\n+                    class="btn btn-primary"\n+                    name="form.button.Search"\n+                    value="Search"\n+                    i18n:translate="label_search"\n+                    >Search</button>\n+                <button type="submit"\n+                    class="btn btn-secondary"\n+                    name="form.button.FindAll"\n+                    value="Show all"\n+                    i18n:translate="label_showall"\n+                    tal:condition="not:view/many_groups"\n+                    >Show all</button>\n             </div>\n \n \n-            <table class="listing"\n+            <table class="table table-responsive table-bordered table-striped text-center"\n                    summary="Select roles for each group"\n                    i18n:attributes="summary summary_roles_for_groups;">\n+                <thead tal:condition="search_results">\n+                    <tr>\n+                        <th class="text-start" i18n:translate="listingheader_group_name">Group Name</th>\n+                        <th class="rotate" tal:repeat="portal_role portal_roles"><div tal:content="portal_role" i18n:translate="">Role</div></th>\n+                        <th class="rotate alert-danger"><div i18n:translate="listingheader_remove">Remove</div></th>\n+                    </tr>\n+                </thead>\n                 <tbody>\n-\n                     <tal:block tal:condition="search_results">\n-                    <tr class="odd">\n-                        <th rowspan=""\n-                            i18n:translate="listingheader_group_name">\n-                            Group Name\n-                        </th>\n-\n-                        <tal:header repeat="portal_role portal_roles">\n-                            <th tal:content="portal_role"\n-                                i18n:translate="">\n-                                Role\n-                            </th>\n-                        </tal:header>\n-\n-                        <th rowspan=""\n-                            i18n:translate="listingheader_remove">\n-                            Remove\n-                        </th>\n-                    </tr>\n \n                     <tal:block repeat="group_info batch">\n                     <tr tal:define="oddrow repeat/group_info/odd;"\n                         tal:attributes="class python:oddrow and \'odd\' or \'even\'">\n \n-                        <td>\n+                        <td class="text-start">\n                             <input type="hidden"\n                                    name=""\n                                    tal:attributes="name string:group_${group_info/groupid}:list"\n@@ -168,8 +126,7 @@\n                             <a href="#"\n                                tal:attributes="href python:portal_url+\'/@@usergroup-groupmembership?\'+view.makeQuery(groupname=group_info[\'groupid\']);\n                                                title group_info/description|string:\'\'">\n-                               <tal:block replace="structure context/portal_url/group.png" />&nbsp;\n-                               <tal:group tal:replace="group_info/title" /> <tal:groupid tal:condition="python:group_info[\'groupid\'] != group_info[\'title\']">(<tal:id tal:replace="group_info/groupid" />)</tal:groupid>\n+                               ${group_info/title} <span class="text-muted" tal:condition="python:group_info[\'groupid\'] != group_info[\'title\']">(${group_info/groupid})</span>\n                            </a>\n                         </td>\n \n@@ -194,11 +151,11 @@\n                                    tal:condition="python:explicit and not enabled and not inherited"\n                                    tal:attributes="name string:group_${group_info/groupid}:list;\n                                                    value portal_role" />\n-                            <img tal:condition="inherited" tal:replace="structure context/site_icon.png" />\n+                            <tal:icon tal:condition="inherited" tal:replace="structure python:icons.tag(\'people\', tag_alt=\'Inherited from Group\')" />\n                           </tal:block>\n                         </td>\n \n-                        <td class="listingCheckbox">\n+                        <td class="listingCheckbox alert-danger">\n                             <input type="checkbox"\n                                    class="noborder notify"\n                                    name="delete:list"\n@@ -238,22 +195,17 @@\n                         Show all search results\n                     </a>\n                 </div>\n-\n-                <div class="formControls">\n-                  <input class="context"\n-                         type="submit"\n-                         name="form.button.Modify"\n-                         value="Save"\n-                         i18n:attributes="value label_save;"\n-                         />\n-                </div>\n-\n             </tal:block>\n-\n             <input tal:replace="structure context/@@authenticator/authenticator" />\n-\n+            <div class="formControls">\n+                <button class="btn btn-primary"\n+                        type="submit"\n+                        name="form.button.Modify"\n+                        value="Save"\n+                        i18n:translate="label_apply_changes"\n+                        >Apply changes</button>\n+            </div>\n         </form>\n-      </div>\n     </div>\n   </article>\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt b/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt\nindex 89024e15b8..f0651e77b6 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt\n@@ -8,7 +8,7 @@\n \n <body>\n \n-<metal:main fill-slot="prefs_configlet_content"\n+<metal:main fill-slot="prefs_configlet_main"\n      tal:define="template_id string:@@usergroup-usermembership;\n                  portal context/@@plone_portal_state/portal;\n                  userid view/userid;\n@@ -96,7 +96,7 @@\n             </tal:block>\n           </table>\n           <p tal:condition="not:groups" i18n:translate="text_user_not_in_any_group">This user does not belong to any group.</p>\n-          <input class="destructive"\n+          <button class="btn btn-alert"\n                  type="submit"\n                  name="form.button.Delete"\n                  value="Remove from selected groups"\n@@ -106,7 +106,7 @@\n           <h2 tal:condition="many_groups" i18n:translate="heading_search_groups">Search for groups</h2>\n           <h2 tal:condition="not:many_groups" i18n:translate="heading_assign_to_groups">Assign to groups</h2>\n \n-          <table class="listing" summary="Groups">\n+          <table class="table overflow-auto table-bordered table-striped text-center" summary="Groups">\n             <tr>\n               <th colspan="2" tal:condition="many_groups">\n                 <span tal:omit-tag="" i18n:translate="label_quick_search">Quick search</span>:\n@@ -117,8 +117,8 @@\n                              tal:attributes="value view/searchString;"\n                              />\n \n-                      <input type="submit"\n-                             class="searchButton"\n+                      <button type="submit"\n+                             class="searchButton btn btn-primary"\n                              name="form.button.search"\n                              value="Search"\n                              i18n:attributes="value label_search;" />\n@@ -191,12 +191,13 @@\n \n           <input type="hidden" name="form.submitted" value="1" />\n \n-          <input class="context"\n+          <button class="btn btn-primary"\n                  type="submit"\n                  name="form.button.Add"\n                  value="Add user to selected groups"\n                  tal:condition="batch"\n-                 i18n:attributes="value label_add_user_to_group;" />\n+                 i18n:translate=""\n+                 i18n:attributes="value label_add_user_to_group;">Add user to selected groups</button>\n           <input tal:replace="structure context/@@authenticator/authenticator" />\n \n         </form>\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt b/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt\nindex 33ce2f1e42..6bf0192991 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt\n@@ -2,13 +2,13 @@\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-    lang="en"\n-    metal:use-macro="context/prefs_main_template/macros/master"\n-    i18n:domain="plone">\n+      lang="en"\n+      metal:use-macro="context/prefs_main_template/macros/master"\n+      i18n:domain="plone">\n \n <body>\n \n-<metal:main fill-slot="prefs_configlet_content"\n+<metal:main fill-slot="prefs_configlet_main"\n     tal:define="template_id string:@@usergroup-userprefs;\n                 showAll python:request.get(\'showAll\', \'\') and not view.newSearch and \'y\';\n                 Batch python:modules[\'Products.CMFPlone\'].Batch;\n@@ -17,55 +17,35 @@\n                 portal_roles view/portal_roles;\n                 portal_url context/portal_url;">\n \n-  <article id="content">\n+    <article id="content">\n \n-    <a id="setup-link" class="link-parent"\n-       tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-       i18n:translate="">\n-        Site Setup\n-    </a>\n+    <header>\n \n-    <h1 class="documentFirstHeading"\n-        i18n:translate="">Users and Groups</h1>\n+        <h1 class="documentFirstHeading"\n+            i18n:translate="">Users</h1>\n \n-    <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n-      Portal status message\n-    </div>\n+        <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n+          Portal status message\n+        </div>\n+\n+        <div i18n:translate="user_roles_note" class="text-muted mt-2">\n+              Note that roles set here apply directly to a user.\n+              The symbol <span i18n:name="image_link_icon"><tal:icon tal:replace="structure python:icons.tag(\'people\', tag_alt=\'Inherited from Group\')" /></span>\n+              indicates a role inherited from membership in a group.\n+        </div>\n+      </header>\n \n     <div id="content-core">\n \n       <div class="autotabs">\n-        <div class="autotoc-nav">\n-          <a class="active"\n-             href="${portal_url}/@@usergroup-userprefs"\n-             i18n:translate="label_users">Users</a>\n-          <a href="${portal_url}/@@usergroup-groupprefs"\n-             i18n:translate="label_groups">Groups</a>\n-          <a href="${portal_url}/@@usergroup-controlpanel"\n-             i18n:translate="label_usergroup_settings">Settings</a>\n-          <a href="${portal_url}/@@member-fields"\n-             i18n:translate="label_member_fields">Member fields</a>\n-        </div>\n-\n-        <p i18n:translate="user_roles_note" class="discreet">\n-          Note that roles set here apply directly to a user.\n-          The symbol <img i18n:name="image_link_icon" tal:replace="structure context/site_icon.png" />\n-          indicates a role inherited from membership in a group.\n-        </p>\n-        <p tal:condition="view/show_users_listing_warning" class="portalMessage warning" role="status">\n+        <p tal:condition="view/show_users_listing_warning" class="alert alert-warn" role="status">\n           <strong i18n:translate="">Note</strong>\n           <span i18n:translate="description_pas_users_listing">Some or all of your PAS user source\n           plugins do not allow listing of users, so you may not see\n           the users defined by those plugins unless doing a specific\n           search.</span>\n         </p>\n-        <p>\n-          <a class="pat-plone-modal" id="add-user"\n-             data-pat-plone-modal="{&quot;actionOptions&quot;: {&quot;displayInModal&quot;: false}}"\n-             tal:attributes="href string:${portal_url}/@@new-user">\n-             <button i18n:translate="label_add_new_user" id="add-new-user" class="context">Add New User</button>\n-          </a>\n-        </p>\n+\n         <form action=""\n               class="pat-formautofocus"\n               name="users_search"\n@@ -78,53 +58,64 @@\n                           many_users view/many_users">\n           <input type="hidden" name="form.submitted" value="1" />\n \n-          <div class="field">\n-            <label for="quickSearch" i18n:translate="label_user_search">User Search</label>\n-                          <input class="quickSearch"\n-                                 id="quickSearch"\n-                                 type="text"\n-                                 name="searchstring"\n-                                 value=""\n-                                 tal:attributes="value view/searchString;"\n-                                 />\n-\n-                          <input type="submit"\n-                                 class="searchButton context"\n-                                 name="form.button.Search"\n-                                 value="Search"\n-                                 i18n:attributes="value label_search;"\n-                                 />\n-\n-                          <input type="submit"\n-                                 class="searchButton standalone"\n-                                 name="form.button.FindAll"\n-                                 value="Show all"\n-                                 i18n:attributes="value label_showall;"\n-                                 tal:condition="not:many_users"\n-                                 />\n-          </div>\n-          <table class="listing" summary="User Listing">\n+\n+        <div class="mb-3 input-group">\n+          <a class="pat-plone-modal me-3 btn btn-success " id="add-user"\n+             data-pat-plone-modal=\'{\n+                "actionOptions": {\n+                  "redirectOnResponse": true,\n+                  "redirectToUrl": "${portal_url}/@@usergroup-userprefs"\n+                }\n+              }\'\n+             tal:attributes="href string:${portal_url}/@@new-user"\n+             i18n:translate="label_add_new_user">Add New User</a>\n+          <span class="input-group-text" id="quickSearchLabel" i18n:translate="label_user_search">User Search</span>\n+          <input class="form-control quickSearch"\n+                  id="quickSearch"\n+                  aria-labelledby="quickSearchLabel"\n+                  type="text"\n+                  name="searchstring"\n+                  value=""\n+                  tal:attributes="value view/searchString;"\n+                  />\n+          <button type="submit"\n+                  class="searchButton btn btn-primary"\n+                  name="form.button.Search"\n+                  value="Search"\n+                  i18n:translate=""\n+                  i18n:attributes="value label_search;"\n+                  >Search</button>\n+\n+          <button type="submit"\n+                  class="searchButton btn btn-secondary"\n+                  name="form.button.FindAll"\n+                  value="Show all"\n+                  i18n:translate="label_showall"\n+                  i18n:attributes="value label_showall;"\n+                  tal:condition="not:many_users"\n+                  >Show all</button>\n+        </div>\n+          <table class="table table-responsive table-bordered table-striped text-center" summary="User Listing">\n+              <thead tal:condition="portal_users">\n+                <tr>\n+                  <th  class="text-start" i18n:translate="listingheader_user_name">User name</th>\n+                  <th class="rotate" tal:repeat="portal_role portal_roles"><div tal:content="portal_role" i18n:translate="">Role</div></th>\n+                  <th class="rotate table-warning"><div i18n:translate="listingheader_reset_password">Reset Password</div></th>\n+                  <th class="rotate table-danger"><div i18n:translate="listingheader_remove">Remove</div></th>\n+                </tr>\n+              </thead>\n               <tbody>\n-                  <tal:block tal:condition="portal_users" >\n-                  <tr class="odd">\n-                      <th rowspan="" i18n:translate="listingheader_user_name">User name</th>\n-                      <th tal:repeat="portal_role portal_roles" tal:content="portal_role" i18n:translate="">Role</th>\n-                      <th rowspan="" i18n:translate="listingheader_reset_password">Reset Password</th>\n-                      <th rowspan="" i18n:translate="listingheader_remove">Remove</th>\n-                  </tr>\n-                  </tal:block>\n-                  <tal:block repeat="user batch">\n+                  <tal:loop repeat="user batch">\n                     <tr tal:define="oddrow repeat/user/odd;\n                                     userid user/userid;\n                                     userquery python:view.makeQuery(userid=userid);"\n                         tal:attributes="class python:oddrow and \'odd\' or \'even\'">\n \n-                        <td>\n-                            <a href="@@user-information"\n+                        <td class="text-start">\n+                            <a href="@@user-i0nformation"\n                                tal:attributes="href string:$portal_url/@@user-information?${userquery};\n                                                title userid">\n-                                <span tal:replace="user/fullname">Full Name</span>\n-                                <em> \xe2\x80\x93 <em tal:replace="user/login">login name</em></em>\n+                                ${user/fullname} <span class="text-muted">(${user/login})</span>\n                             </a>\n                             <input type="hidden" name="users.id:records" tal:attributes="value userid" />\n                         </td>\n@@ -135,42 +126,45 @@\n                                                  explicit python:user[\'roles\'][portal_role][\'explicit\'];\n                                                  enabled python:user[\'roles\'][portal_role][\'canAssign\']">\n                             <input type="checkbox"\n-                               class="noborder"\n-                               name="users.roles:list:records"\n-                               value="Manager"\n-                               tal:condition="not:inherited"\n-                               tal:attributes="value portal_role;\n-                                   checked python:\'checked\' if explicit else nothing;\n-                                   disabled python:default if enabled else \'disabled\'" />\n+                                   class="noborder"\n+                                   name="users.roles:list:records"\n+                                   value="Manager"\n+                                   tal:condition="not:inherited"\n+                                   tal:attributes="value portal_role;\n+                                       checked python:\'checked\' if explicit else nothing;\n+                                       disabled python:default if enabled else \'disabled\'" />\n                             <input type="hidden"\n-                                name="users.roles:list:records"\n-                                value="Manager"\n-                                tal:condition="python:inherited"\n-                                tal:attributes="value portal_role" />\n-                            <img tal:condition="inherited" tal:replace="structure context/site_icon.png" />\n+                                   name="users.roles:list:records"\n+                                   value="Manager"\n+                                   tal:condition="python:inherited"\n+                                   tal:attributes="value portal_role" />\n+                            <tal:icon tal:condition="inherited" tal:replace="structure python:icons.tag(\'people\', tag_alt=\'Inherited from Group\')" />\n+\n                           </tal:block>\n \n                         </td>\n \n-                        <td class="listingCheckbox">\n+                        <td class="listingCheckbox table-warning">\n                           <input type="checkbox"\n-                             class="noborder"\n-                             name="users.resetpassword:records"\n-                                         value=""\n-                                         tal:attributes="value userid;\n-                                                         disabled python:user[\'can_set_password\'] and default or \'disabled\'" />\n+                                 class="noborder"\n+                                 name="users.resetpassword:records"\n+                                 value=""\n+                                 tal:attributes="value userid;\n+                                                 title string:Reset password of user ${user/fullname};\n+                                                 disabled python:user[\'can_set_password\'] and default or \'disabled\'" />\n                         </td>\n \n-                        <td class="listingCheckbox">\n+                        <td class="listingCheckbox table-danger">\n                           <input type="checkbox"\n                                          class="noborder notify"\n                                          name="delete:list"\n                                          value=""\n                                          tal:attributes="value userid;\n+                                                         title string:Remove user ${user/fullname};\n                                                          disabled python:user[\'can_delete\'] and default or \'disabled\'" />\n                         </td>\n                     </tr>\n-                  </tal:block>\n+                  </tal:loop>\n                   <tr tal:condition="not:batch">\n                       <td tal:condition="view/searchString"\n                           i18n:translate="text_nomatches"\n@@ -215,13 +209,13 @@\n \n           <div tal:condition="batch">\n \n-            <div class="formControls">\n-              <input class="context"\n+            <div class="btn-group">\n+              <button class="btn btn-primary"\n                  type="submit"\n                  name="form.button.Modify"\n                  value="Save"\n-                 i18n:attributes="value label_save;"\n-                 />\n+                 i18n:translate="label_apply_changes"\n+                 >Apply changes</button>\n             </div>\n           </div>\n \ndiff --git a/Products/CMFPlone/controlpanel/configure.zcml b/Products/CMFPlone/controlpanel/configure.zcml\nindex 86f75133c2..c25bb55caa 100644\n--- a/Products/CMFPlone/controlpanel/configure.zcml\n+++ b/Products/CMFPlone/controlpanel/configure.zcml\n@@ -2,12 +2,10 @@\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:five="http://namespaces.zope.org/five">\n \n+  <include file="permissions.zcml" />\n   <include package="plone.app.registry" />\n-\n   <include package=".bbb" />\n   <include package=".browser" />\n-\n   <include file="events.zcml" />\n-  <include file="permissions.zcml" />\n \n </configure>\ndiff --git a/Products/CMFPlone/controlpanel/events.py b/Products/CMFPlone/controlpanel/events.py\nindex 1273f6297d..fdbced0807 100644\n--- a/Products/CMFPlone/controlpanel/events.py\n+++ b/Products/CMFPlone/controlpanel/events.py\n@@ -3,8 +3,8 @@\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.utils import migrate_to_email_login\n from Products.CMFPlone.controlpanel.utils import migrate_from_email_login\n-from Products.CMFPlone.interfaces import IConfigurationChangedEvent\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import IConfigurationChangedEvent\n+from plone.base.interfaces import ISecuritySchema\n from Products.CMFPlone.utils import safe_hasattr\n from plone.registry.interfaces import IRecordModifiedEvent\n from zope.component import adapter\ndiff --git a/Products/CMFPlone/controlpanel/permissions.zcml b/Products/CMFPlone/controlpanel/permissions.zcml\nindex e3012f8828..7acb137927 100644\n--- a/Products/CMFPlone/controlpanel/permissions.zcml\n+++ b/Products/CMFPlone/controlpanel/permissions.zcml\n@@ -40,4 +40,10 @@\n   <permission id="plone.app.controlpanel.UsersAndGroups"\n               title="Plone Site Setup: Users and Groups"/>\n \n+  <permission id="Products.CMFPlone.InspectRelations"\n+              title="Inspect Relations">\n+    <role name="Manager"/>\n+    <role name="Site Administrator"/>\n+  </permission>\n+\n </configure>\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py\nindex 8e48c1737c..a1ca337498 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import IEditingSchema\n+from plone.base.interfaces import IEditingSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py\nindex 8321155c99..ef03ef4699 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import IFilterSchema\n+from plone.base.interfaces import IFilterSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py\nindex a3227f068e..d936b92091 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import IMailSchema\n+from plone.base.interfaces import IMailSchema\n from Products.CMFPlone.testing import \\\n     PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID, setRoles\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py\nindex ebcb4e1d6c..c002629e18 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import IMaintenanceSchema\n+from plone.base.interfaces import IMaintenanceSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py\nindex 4e9e2cfb36..f5f3c8135a 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import IMarkupSchema\n+from plone.base.interfaces import IMarkupSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py\nindex 2f0d0eacfb..fdec408974 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import INavigationSchema\n+from plone.base.interfaces import INavigationSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID, setRoles\n from plone.registry.interfaces import IRegistry\n@@ -134,21 +134,21 @@ def test_set_workflow_states_to_show(self):\n     def test_get_show_excluded_items(self):\n         self.assertEqual(\n             getAdapter(self.portal, INavigationSchema).show_excluded_items,\n-            True\n+            False\n         )\n-        self.navigation_settings.show_excluded_items = False\n+        self.navigation_settings.show_excluded_items = True\n         self.assertEqual(\n             getAdapter(self.portal, INavigationSchema).show_excluded_items,\n-            False\n+            True\n         )\n \n     def test_set_show_excluded_items(self):\n         self.assertEqual(\n             self.navigation_settings.show_excluded_items,\n-            True\n+            False\n         )\n-        getAdapter(self.portal, INavigationSchema).show_excluded_items = False\n+        getAdapter(self.portal, INavigationSchema).show_excluded_items = True\n         self.assertEqual(\n             self.navigation_settings.show_excluded_items,\n-            False\n+            True\n         )\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py\nindex 4efa771e07..c2bf2ecd91 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import ISearchSchema\n+from plone.base.interfaces import ISearchSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID, setRoles\n from plone.registry.interfaces import IRegistry\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py\nindex 139ca26bca..a98e190663 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py\n@@ -1,6 +1,6 @@\n from Products.CMFPlone.testing import \\\n     PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISecuritySchema\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n from zope.component import getAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py\nindex 9dcc8d3a32..443f5f20c8 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py\nindex 6c3d7801f1..2f7229a9ad 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py\n@@ -1,5 +1,5 @@\n from plone.app.testing import setRoles\n-from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema\n+from plone.base.interfaces import IUserGroupsSettingsSchema\n from zope.component import getAdapter\n from plone.app.testing import TEST_USER_ID\n from plone.registry.interfaces import IRegistry\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py\nindex 81ed3de60f..3b0be82fb7 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import IEditingSchema\n+from plone.base.interfaces import IEditingSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.app.linkintegrity.utils import linkintegrity_enabled\n from plone.app.testing import SITE_OWNER_NAME\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py\nnew file mode 100644\nindex 0000000000..ae797cd070\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py\n@@ -0,0 +1,64 @@\n+import unittest\n+\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.testing.zope import Browser\n+from zope.component import getMultiAdapter\n+\n+\n+class ErrorLogControlPanelFunctionalTest(unittest.TestCase):\n+    """Test for Controlpanel Error Log\n+    """\n+\n+    layer = PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+    error_log_properties = None\n+\n+    def setUp(self):\n+        self.app = self.layer[\'app\']\n+        self.request = self.layer[\'request\']\n+        self.portal = self.layer[\'portal\']\n+        self.portal_url = self.portal.absolute_url()\n+\n+        # keep initial error_log_properties to reset them\n+        self.error_log_properties = self.portal.error_log.getProperties()\n+\n+        self.browser = Browser(self.app)\n+        self.browser.handleErrors = False\n+        self.browser.addHeader(\n+            \'Authorization\',\n+            f\'Basic {SITE_OWNER_NAME}:{SITE_OWNER_PASSWORD}\'\n+        )\n+\n+    def tearDown(self):\n+        # reset error log properties\n+        keep_entries = self.error_log_properties[\'keep_entries\']\n+        copy_to_zlog = self.error_log_properties[\'copy_to_zlog\']\n+        ignored_exceptions = self.error_log_properties[\'ignored_exceptions\']\n+        self.portal.error_log.setProperties(keep_entries, copy_to_zlog, ignored_exceptions)\n+\n+    def test_error_log_control_panel_link(self):\n+        self.browser.open("%s/@@overview-controlpanel" % self.portal_url)\n+        self.browser.getLink(\'Errors\').click()\n+\n+        self.assertEqual(self.browser.url, "%s/@@error-log-form" % self.portal_url)\n+        self.assertIn(\'<h1>Error log</h1>\', self.browser.contents)\n+\n+    def test_error_log_set_properties(self):\n+        self.assertEqual(self.error_log_properties[\'keep_entries\'], 20)\n+        self.assertEqual(self.error_log_properties[\'copy_to_zlog\'], True)\n+        self.assertEqual(self.error_log_properties[\'ignored_exceptions\'], (\'Unauthorized\', \'NotFound\', \'Redirect\'))\n+\n+        self.request.form = {\n+            \'keep_entries\': 40,\n+            \'ignored_exceptions\': [\'NotFound\', \'Redirect\']\n+        }\n+\n+        set_properties_view = getMultiAdapter((self.portal, self.request),\n+                                name=\'error-log-set-properties\')\n+        set_properties_view()\n+\n+        error_log_properties = self.portal.error_log.getProperties()\n+        self.assertEqual(error_log_properties[\'keep_entries\'], 40)\n+        self.assertEqual(error_log_properties[\'copy_to_zlog\'], False)\n+        self.assertEqual(error_log_properties[\'ignored_exceptions\'], (\'NotFound\', \'Redirect\'))\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py\nindex e6b04e0a5c..5ede8606b1 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py\n@@ -2,7 +2,7 @@\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IFilterSchema\n+from plone.base.interfaces import IFilterSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from Products.PortalTransforms.data import datastream\n from zope.component import getMultiAdapter\n@@ -103,5 +103,5 @@ def test_nasty_tags(self):\n         ds = datastream(\'dummy_name\')\n         self.assertEqual(\n             self.safe_html.convert(good_html, ds).getData(),\n-            \'<p/>\'\n+            \'<p></p>\'\n         )\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_installer.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_installer.py\nindex f68c913db1..67192a3a60 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_installer.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_installer.py\n@@ -71,6 +71,23 @@ def test_addons_controlpanel_install_and_uninstall_all(self):\n             \'%s/prefs_install_products_form\' % self.portal_url)\n         self.assertNotIn(\'Installed\', self.browser.contents)\n         self.assertNotIn(\'Uninstalled\', self.browser.contents)\n+\n+        # In a fresh site there should be no uninstall buttons.\n+        # If there is one, it is likely an upgrade profile that should be hidden.\n+        # This could change: we might for example install a theme by default\n+        # but make it uninstallable.  The logic in this test should be updated then.\n+        try:\n+            button = self.browser.getControl(\'Uninstall\', index=0)\n+        except LookupError:\n+            # This is good.\n+            pass\n+        else:\n+            # We cannot easily see what the Uninstall button is for.\n+            # We have to get the form with a private attribute.\n+            raise AssertionError(\n+                f"Uninstall button found. Probably an upgrade profile needs to be hidden. {button._form.text}"\n+            )\n+\n         # It is hard to determine which exact product will be installed\n         # by clicking on a button, because they are all called \'Install\'.\n         # We install all available products.\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py\nindex c3d306202a..c575f7f438 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py\n@@ -5,7 +5,7 @@\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n \n-from Products.CMFPlone.interfaces import IMailSchema\n+from plone.base.interfaces import IMailSchema\n from Products.CMFPlone.testing import \\\n     PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py\nindex a4cb5ae821..cd34913f44 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import IMarkupSchema\n+from plone.base.interfaces import IMarkupSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.registry.interfaces import IRegistry\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py\nindex 7921dec95d..66e79d0d0e 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import INavigationSchema\n+from plone.base.interfaces import INavigationSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.registry.interfaces import IRegistry\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py\nnew file mode 100644\nindex 0000000000..a99d71950a\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py\n@@ -0,0 +1,74 @@\n+import unittest\n+\n+from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n+from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n+\n+class RelationsControlPanelFunctionalTest(unittest.TestCase):\n+    """Test that links and actions in controlpanel starts with to absolute portal url."""\n+\n+    layer = PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n+    def _add_broken_relation(self):\n+        import transaction\n+        from persistent.list import PersistentList\n+        from z3c.relationfield import RelationValue\n+        from zope.component import getUtility\n+        from zope.intid.interfaces import IIntIds\n+        from zope.lifecycleevent import modified\n+\n+        self.portal.invokeFactory("Document", id="doc1", title="doc1")\n+        doc1 = self.portal["doc1"]\n+        self.portal.invokeFactory("Document", id="doc2", title="doc2")\n+        doc2 = self.portal["doc2"]\n+\n+        intids = getUtility(IIntIds)\n+        doc1.relatedItems = PersistentList()\n+        doc1.relatedItems.append(RelationValue(intids.getId(doc2)))\n+        modified(doc1)\n+        self.portal._delObject("doc2")\n+        transaction.commit()\n+\n+    def setUp(self):\n+        self.app = self.layer["app"]\n+        self.portal = self.layer["portal"]\n+        self.portal_url = self.portal.absolute_url()\n+        self.browser = Browser(self.app)\n+        self.browser.handleErrors = False\n+        self.browser.addHeader(\n+            "Authorization", f"Basic {SITE_OWNER_NAME}:{SITE_OWNER_PASSWORD}"\n+        )\n+\n+    def test_inspect_realtions_form_action(self):\n+        from io import StringIO\n+\n+        from lxml import etree\n+\n+        self.browser.open(f"{self.portal_url}/@@inspect-relations")\n+        tree = etree.parse(StringIO(self.browser.contents), etree.HTMLParser())\n+        action_url = tree.xpath("//form[@id=\'relationinfo\']/@action")[0]\n+        self.assertTrue(\n+            action_url.startswith(self.portal_url),\n+            "URL in relationinfo form should start with portal url",\n+        )\n+\n+    def test_rebuild_relations_links(self):\n+        from io import StringIO\n+\n+        from lxml import etree\n+\n+        # first we need a broken relation\n+        # for conditional rendering alert panel in controlpanel\n+        self._add_broken_relation()\n+\n+        self.browser.open(f"{self.portal_url}/@@inspect-relations")\n+        tree = etree.parse(StringIO(self.browser.contents), etree.HTMLParser())\n+        hrefs = tree.xpath(\n+            "//div[@id=\'content-core\']//a[contains(@href, \'@@rebuild-relations\')]/@href"\n+        )\n+        for href in hrefs:\n+            self.assertTrue(\n+                href.startswith(self.portal_url),\n+                "URL in Link should start with portal url",\n+            )\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\nindex 02358a34d0..3b2d7d17c0 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import ISearchSchema\n+from plone.base.interfaces import ISearchSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.registry.interfaces import IRegistry\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py\nindex df4f58c383..89c57b5113 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISecuritySchema\n from Products.CMFPlone.testing import \\\n     PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py\nindex 583e5e4b83..e5cf80998d 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py\n@@ -1,7 +1,7 @@\n from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from io import BytesIO\n from zope.component import getMultiAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\nindex 57313133f2..ae275bde1a 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n@@ -114,7 +114,7 @@ def test_disable_versioning_removes_behavior(self):\n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n         self.assertTrue(\n-            \'plone.app.versioningbehavior.behaviors.IVersionable\'\n+            \'plone.versioning\'\n             not in doc_type.behaviors)  # noqa\n \n     def test_enable_versioning_behavior_on_document(self):\n@@ -127,14 +127,14 @@ def test_enable_versioning_behavior_on_document(self):\n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n         self.assertTrue(\n-            \'plone.app.versioningbehavior.behaviors.IVersionable\'\n+            \'plone.versioning\'\n             not in doc_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n         self.browser.getControl(name="form.button.Save").click()\n \n         self.assertTrue(\n-            \'plone.app.versioningbehavior.behaviors.IVersionable\'\n+            \'plone.versioning\'\n             in doc_type.behaviors)\n \n     def test_enable_versioning_behavior_on_file(self):\n@@ -149,20 +149,20 @@ def test_enable_versioning_behavior_on_file(self):\n \n         # File has no Versioning and no Locking on default, but needs it\n         self.assertTrue(\n-            \'plone.app.versioningbehavior.behaviors.IVersionable\'\n+            \'plone.versioning\'\n             not in file_type.behaviors)  # noqa\n         self.assertTrue(\n-            \'plone.app.lockingbehavior.behaviors.ILocking\'\n+            \'plone.locking\'\n             not in file_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n         self.browser.getControl(\'Save\').click()\n \n         self.assertTrue(\n-            \'plone.app.versioningbehavior.behaviors.IVersionable\'\n+            \'plone.versioning\'\n             in file_type.behaviors)\n         self.assertTrue(\n-            \'plone.app.lockingbehavior.behaviors.ILocking\'\n+            \'plone.locking\'\n             in file_type.behaviors)\n \n     def test_dont_update_settings_when_switch_types(self):\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\nindex 0177044722..4a24a758fe 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\n@@ -141,8 +141,10 @@ def setUp(self):\n         self.app = self.layer[\'app\']\n         self.portal = self.layer[\'portal\']\n         self.portal_url = self.portal.absolute_url()\n-        self.usergroups_url = "%s/@@usergroup-userprefs" % self.portal_url\n+        self.users_url = "%s/@@usergroup-userprefs" % self.portal_url\n         self.groups_url = "%s/@@usergroup-groupprefs" % self.portal_url\n+        self.settings_url = "%s/@@usergroup-controlpanel" % self.portal_url\n+        self.memberfields_url = "%s/@@member-fields" % self.portal_url\n         self._generateGroups()\n         self._generateUsers()\n         transaction.commit()\n@@ -154,41 +156,39 @@ def setUp(self):\n             f\'Basic {SITE_OWNER_NAME}:{SITE_OWNER_PASSWORD}\'\n         )\n \n-    def test_usergroups_control_panel_link(self):\n-        self.browser.open(\n-            "%s/@@overview-controlpanel" % self.portal_url)\n-        self.browser.getLink(\'Users and Groups\').click()\n+    def test_usergroups_control_panel_link_users(self):\n+        self.browser.open("%s/@@overview-controlpanel" % self.portal_url)\n+        self.browser.getLink(\'Users\').click()\n         self.assertEqual(\n             self.browser.url,\n-            self.usergroups_url\n+            self.users_url\n         )\n-\n-    def test_usergroups_groups_link(self):\n-        self.browser.open(self.usergroups_url)\n-        self.browser.getLink(\'Groups\', index=0).click()\n+    def test_usergroups_control_panel_link_users(self):\n+        self.browser.open("%s/@@overview-controlpanel" % self.portal_url)\n+        self.browser.getLink(\'Groups\').click()\n         self.assertEqual(\n             self.browser.url,\n-            "%s/@@usergroup-groupprefs" % self.portal_url\n+            self.groups_url\n         )\n \n-    def test_usergroups_settings_link(self):\n-        self.browser.open(self.usergroups_url)\n-        self.browser.getLink(\'Settings\').click()\n+    def test_usergroups_control_panel_link_settings(self):\n+        self.browser.open("%s/@@overview-controlpanel" % self.portal_url)\n+        self.browser.getLink(\'User and Group Settings\').click()\n         self.assertEqual(\n             self.browser.url,\n-            "%s/@@usergroup-controlpanel" % self.portal_url\n+            self.settings_url\n         )\n \n-    def test_usergroups_memberfields_link(self):\n-        self.browser.open(self.usergroups_url)\n-        self.browser.getLink(\'Member fields\').click()\n+    def test_usergroups_control_panel_link_settings(self):\n+        self.browser.open("%s/@@overview-controlpanel" % self.portal_url)\n+        self.browser.getLink(\'Member Fields\').click()\n         self.assertEqual(\n             self.browser.url,\n-            "%s/@@member-fields" % self.portal_url\n+            self.memberfields_url\n         )\n \n     def test_user_search_by_name(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'Richard\'\n         self.browser.getControl(name=\'form.button.Search\').click()\n         self.assertIn(\'Richard Ramirez\', self.browser.contents)\n@@ -196,25 +196,25 @@ def test_user_search_by_name(self):\n         self.assertIn(\'\xc3\x89milie Richard\', self.browser.contents)\n \n     def test_user_search_by_name_accent(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'\xc3\x89milie\'\n         self.browser.getControl(name=\'form.button.Search\').click()\n         self.assertIn(\'\xc3\x89milie Richard\', self.browser.contents)\n \n     def test_user_search_by_id(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'TWrMCLIo\'\n         self.browser.getControl(name=\'form.button.Search\').click()\n         self.assertIn(\'Autumn Brooks\', self.browser.contents)\n \n     def test_user_search_by_mail(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'DohPmgIa@\'\n         self.browser.getControl(name=\'form.button.Search\').click()\n         self.assertIn(\'Gracie Diaz\', self.browser.contents)\n \n     def test_user_show_all(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'form.button.FindAll\').click()\n \n         # Check that first 10 members (sorted by fullname) are shown.\n@@ -224,7 +224,7 @@ def test_user_show_all(self):\n             self.assertIn(member[\'fullname\'], self.browser.contents)\n \n     def test_user_show_all_with_search_term(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'no-user\'\n         self.browser.getControl(name=\'form.button.FindAll\').click()\n \n@@ -232,7 +232,7 @@ def test_user_show_all_with_search_term(self):\n         self.assertIn(\'Avery Cooper\', self.browser.contents)\n \n     def test_user_add_new_link(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getLink(id=\'add-user\').click()\n         self.assertEqual(\n             self.browser.url,\n@@ -240,7 +240,7 @@ def test_user_add_new_link(self):\n         )\n \n     def test_user_modify_roles(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'TWrMCLIo\'\n         self.browser.getControl(name=\'form.button.Search\').click()\n \n@@ -254,7 +254,7 @@ def test_user_modify_roles(self):\n         self.browser.getControl(name=\'form.button.Modify\').click()\n \n         # Check that contributor role is now enabled for this user\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'TWrMCLIo\'\n         self.browser.getControl(name=\'form.button.Search\').click()\n         self.assertTrue(self.browser.getControl(\n@@ -262,7 +262,7 @@ def test_user_modify_roles(self):\n         ).getControl(value=\'Contributor\').selected)\n \n     def test_user_delete(self):\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'TWrMCLIo\'\n         self.browser.getControl(name=\'form.button.Search\').click()\n         self.assertIn(\'Autumn Brooks\', self.browser.contents)\n@@ -393,11 +393,11 @@ def test_usergroups_settings_many_users(self):\n         self.browser.getControl(\'Save\').click()\n \n         # Check that show all button for users is no longer available\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.assertNotIn(\'Show all\', self.browser.contents)\n \n         # Check that empty search does not trigger show all\n-        self.browser.open(self.usergroups_url)\n+        self.browser.open(self.users_url)\n         self.browser.getControl(name=\'searchstring\').value = \'\'\n \n     def test_usergroups_settings_many_groups(self):\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\nindex 9d42df3649..9b567ea24c 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\n@@ -7,7 +7,6 @@\n from plone.testing.zope import Browser\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from io import StringIO\n from urllib.parse import urlencode\n \n import re\n@@ -73,8 +72,7 @@ def _simplify_white_space(self, text):\n     def testControlPanelOverview(self):\n         # make sure we can view the Site Setup page,\n         # at both old and new URLs\n-        view = self.portal.restrictedTraverse(\'plone_control_panel\')\n-        self.assertTrue(view())\n+        self.assertFalse(self.portal.restrictedTraverse(\'plone_control_panel\', False))\n         view = self.portal.restrictedTraverse(\'overview-controlpanel\')\n         self.assertTrue(view())\n \n@@ -305,7 +303,7 @@ def test_users_overview_blocks_deleting_managers(self):\n         contents = self._simplify_white_space(self.browser.contents)\n         self.assertTrue(\n             \'<input type="checkbox" class="noborder notify" \'\n-            \'name="delete:list" value="root" disabled="disabled" />\'\n+            \'name="delete:list" value="root" title="Remove user " disabled="disabled" />\'\n             in contents)\n \n         form = {\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py\nindex ed75bc1727..9a86dee7be 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import IDateAndTimeSchema\n+from plone.base.interfaces import IDateAndTimeSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py\nindex 3a5f9c27c0..037d4b166e 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py\n@@ -1,5 +1,5 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IEditingSchema\n+from plone.base.interfaces import IEditingSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getMultiAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py\nindex 7bc43c1708..0e053ff69f 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py\n@@ -1,7 +1,7 @@\n from Products.CMFPlone.testing import \\\n     PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISecuritySchema\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n from zope.component import getAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py\nindex c96c5e8c1a..44b5fcd01f 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py\n@@ -1,5 +1,5 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IFilterSchema\n+from plone.base.interfaces import IFilterSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getMultiAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py\nindex 2b78ace63f..0de6c66436 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py\n@@ -3,7 +3,7 @@\n from plone.registry.interfaces import IRegistry\n \n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IMailSchema\n+from plone.base.interfaces import IMailSchema\n from Products.CMFPlone.testing import \\\n     PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py\nindex 9af62e6e6b..248e27602c 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py\n@@ -1,5 +1,5 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IMarkupSchema\n+from plone.base.interfaces import IMarkupSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getMultiAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py\nindex 62ca94ae2f..955ed19c40 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py\n@@ -1,5 +1,5 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import INavigationSchema\n+from plone.base.interfaces import INavigationSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getMultiAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py\nindex 55a368e5d5..974d6c3828 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py\n@@ -4,6 +4,7 @@\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\n from unittest import mock\n+import os\n import unittest\n \n \n@@ -12,15 +13,15 @@ def mock_getUtility1(iface):\n \n \n def mock_getUtility2(iface):\n-    return {\'plone.portal_timezone\': None}\n+    return {"plone.portal_timezone": None}\n \n \n def mock_getUtility3(iface):\n-    return {\'plone.portal_timezone\': \'Europe/Amsterdam\'}\n+    return {"plone.portal_timezone": "Europe/Amsterdam"}\n \n \n def mock_getUtility4(iface):\n-    return {\'plone.app.event.portal_timezone\': \'Europe/Amsterdam\'}\n+    return {"plone.app.event.portal_timezone": "Europe/Amsterdam"}\n \n \n class TestControlPanel(unittest.TestCase):\n@@ -28,34 +29,49 @@ class TestControlPanel(unittest.TestCase):\n     layer = PLONE_INTEGRATION_TESTING\n \n     def setUp(self):\n-        self.portal = self.layer[\'portal\']\n-        self.request = self.layer[\'request\']\n-        setRoles(self.portal, TEST_USER_ID, [\'Manager\'])\n+        self.portal = self.layer["portal"]\n+        self.request = self.layer["request"]\n+        setRoles(self.portal, TEST_USER_ID, ["Manager"])\n \n-    @mock.patch(\'Products.CMFPlone.controlpanel.browser.overview.getUtility\',\n-                new=mock_getUtility1)\n+    @mock.patch(\n+        "Products.CMFPlone.controlpanel.browser.overview.getUtility",\n+        new=mock_getUtility1,\n+    )\n     def test_timezone_warning__noreg(self):\n         # If no registry key is available, return True\n         registry = getUtility(IRegistry)\n         reg_key = "plone.portal_timezone"\n         del registry.records[reg_key]\n         self.assertFalse(reg_key in registry)\n-        view = self.portal.restrictedTraverse(\'@@overview-controlpanel\')\n+        view = self.portal.restrictedTraverse("@@overview-controlpanel")\n         self.assertTrue(view.timezone_warning())\n \n-    @mock.patch(\'Products.CMFPlone.controlpanel.browser.overview.getUtility\',\n-                new=mock_getUtility2)\n+    @mock.patch(\n+        "Products.CMFPlone.controlpanel.browser.overview.getUtility",\n+        new=mock_getUtility2,\n+    )\n     def test_timezone_warning__emptyreg(self):\n         # If registry key value is empty, return True\n         registry = getUtility(IRegistry)\n         reg_key = "plone.portal_timezone"\n         registry[reg_key] = None\n-        view = self.portal.restrictedTraverse(\'@@overview-controlpanel\')\n+        view = self.portal.restrictedTraverse("@@overview-controlpanel")\n         self.assertTrue(view.timezone_warning())\n \n-    @mock.patch(\'Products.CMFPlone.controlpanel.browser.overview.getUtility\',\n-                new=mock_getUtility3)\n+    @mock.patch(\n+        "Products.CMFPlone.controlpanel.browser.overview.getUtility",\n+        new=mock_getUtility3,\n+    )\n     def test_timezone_warning__set(self):\n         # If new plone.portal_timezone is set, return False\n-        view = self.portal.restrictedTraverse(\'@@overview-controlpanel\')\n+        view = self.portal.restrictedTraverse("@@overview-controlpanel")\n         self.assertFalse(view.timezone_warning())\n+\n+    def test_gunicorn_server_name(self):\n+        self.request["SERVER_SOFTWARE"] = "gunicorn/19.6.0"\n+        view = self.portal.restrictedTraverse("@@overview-controlpanel")\n+        self.assertEqual(view.server_info()["server_name"], "gunicorn")\n+        self.request["SERVER_SOFTWARE"] = "bad-gunicorn-name/19.6.0"\n+        view = self.portal.restrictedTraverse("@@overview-controlpanel")\n+        with self.assertWarns(Warning):\n+            view.server_info()["server_name"]\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\nnew file mode 100644\nindex 0000000000..a6bf021866\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\n@@ -0,0 +1,161 @@\n+from persistent.list import PersistentList\n+from plone.app.testing import TEST_USER_ID, setRoles\n+from Products.CMFPlone.controlpanel.browser.relations import get_relations_stats\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from z3c.relationfield import RelationValue\n+from zope.component import getMultiAdapter\n+from zope.component import getUtility\n+from zope.intid.interfaces import IIntIds\n+from zope.lifecycleevent import modified\n+\n+import unittest\n+\n+\n+class TestRelationsControlpanel(unittest.TestCase):\n+\n+    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+\n+    def setUp(self):\n+        self.portal = self.layer[\'portal\']\n+        self.request = self.layer[\'request\']\n+        setRoles(self.portal, TEST_USER_ID, (\'Manager\',))\n+\n+    def test_relations_stats(self):\n+        self.portal.invokeFactory(\'Document\', id=\'doc1\', title=\'doc1\')\n+        doc1 = self.portal[\'doc1\']\n+        self.portal.invokeFactory(\'Document\', id=\'doc2\', title=\'doc2\')\n+        doc2 = self.portal[\'doc2\']\n+        intids = getUtility(IIntIds)\n+        doc1.relatedItems = PersistentList()\n+        doc1.relatedItems.append(RelationValue(intids.getId(doc2)))\n+        modified(doc1)\n+        # TODO: simplify when relation-support is merged into plone.api\n+        # api.relation.create(doc1, doc2, \'relatedItems\')\n+\n+        stats, broken = get_relations_stats()\n+        self.assertEqual(dict(stats), {\'relatedItems\': 1})\n+        self.assertEqual(dict(broken), {})\n+        view = getMultiAdapter((self.portal, self.request), name=\'inspect-relations\')\n+        self.assertTrue(view())\n+        self.assertTrue(view(relation=\'relatedItems\'))\n+\n+    def test_relations_stats_broken(self):\n+        self.portal.invokeFactory(\'Document\', id=\'doc1\', title=\'doc1\')\n+        doc1 = self.portal[\'doc1\']\n+        self.portal.invokeFactory(\'Document\', id=\'doc2\', title=\'doc2\')\n+        doc2 = self.portal[\'doc2\']\n+        self.portal.invokeFactory(\'Document\', id=\'doc3\', title=\'doc3\')\n+        doc3 = self.portal[\'doc3\']\n+\n+        intids = getUtility(IIntIds)\n+        doc1.relatedItems = PersistentList()\n+        doc1.relatedItems.append(RelationValue(intids.getId(doc2)))\n+        doc1.relatedItems.append(RelationValue(intids.getId(doc3)))\n+        modified(doc1)\n+        # api.relation.create(doc1, doc2, \'relatedItems\')\n+        # api.relation.create(doc1, doc3, \'relatedItems\')\n+\n+        self.portal._delObject(\'doc2\')\n+        stats, broken = get_relations_stats()\n+        self.assertEqual(dict(stats), {\'relatedItems\': 1})\n+        self.assertEqual(dict(broken), {\'relatedItems\': 1})\n+        view = getMultiAdapter((self.portal, self.request), name=\'inspect-relations\')\n+        self.assertTrue(view())\n+        self.assertTrue(view(relation=\'relatedItems\'))\n+\n+    def test_rebuild_relations(self):\n+        self.portal.invokeFactory(\'Document\', id=\'doc1\', title=\'doc1\')\n+        doc1 = self.portal[\'doc1\']\n+        self.portal.invokeFactory(\'Document\', id=\'doc2\', title=\'doc2\')\n+        doc2 = self.portal[\'doc2\']\n+        self.portal.invokeFactory(\'Document\', id=\'doc3\', title=\'doc3\')\n+        doc3 = self.portal[\'doc3\']\n+        intids = getUtility(IIntIds)\n+        doc1_intid = intids.getId(doc1)\n+        doc2_intid = intids.getId(doc2)\n+        doc3_intid = intids.getId(doc3)\n+\n+        doc1.relatedItems = PersistentList()\n+        doc1.relatedItems.append(RelationValue(doc2_intid))\n+        doc1.relatedItems.append(RelationValue(doc3_intid))\n+        modified(doc1)\n+        # api.relation.create(doc1, doc2, \'relatedItems\')\n+        # api.relation.create(doc1, doc3, \'relatedItems\')\n+\n+        # Make sure the catalog index queue is flushed.\n+        self.portal.portal_catalog.searchResults({})\n+\n+        stats, broken = get_relations_stats()\n+        self.assertEqual(dict(stats), {\'relatedItems\': 2})\n+        self.assertEqual(dict(broken), {})\n+\n+        view = getMultiAdapter((self.portal, self.request), name=\'rebuild-relations\')\n+        results = view(rebuild=True)\n+\n+        # relations are the same after a rebuild\n+        stats, broken = get_relations_stats()\n+        self.assertEqual(dict(stats), {\'relatedItems\': 2})\n+        self.assertEqual(dict(broken), {})\n+\n+        # intids are not changed\n+        doc1_intid_after = intids.getId(doc1)\n+        doc2_intid_after = intids.getId(doc2)\n+        doc3_intid_after = intids.getId(doc3)\n+        self.assertEqual(doc1_intid, doc1_intid_after)\n+        self.assertEqual(doc2_intid, doc2_intid_after)\n+        self.assertEqual(doc3_intid, doc3_intid_after)\n+\n+        # break a relation\n+        self.portal._delObject(\'doc2\')\n+\n+        stats, broken = get_relations_stats()\n+        self.assertEqual(dict(stats), {\'relatedItems\': 1})\n+        self.assertEqual(dict(broken), {\'relatedItems\': 1})\n+\n+        # broken relations are gone after rebuilding\n+        view = getMultiAdapter((self.portal, self.request), name=\'rebuild-relations\')\n+        results = view(rebuild=True)\n+        stats, broken = get_relations_stats()\n+        self.assertEqual(dict(stats), {\'relatedItems\': 1})\n+        self.assertEqual(dict(broken), {})\n+\n+    def test_rebuild_relations_with_intid(self):\n+        self.portal.invokeFactory(\'Document\', id=\'doc1\', title=\'doc1\')\n+        doc1 = self.portal[\'doc1\']\n+        self.portal.invokeFactory(\'Document\', id=\'doc2\', title=\'doc2\')\n+        doc2 = self.portal[\'doc2\']\n+        self.portal.invokeFactory(\'Document\', id=\'doc3\', title=\'doc3\')\n+        doc3 = self.portal[\'doc3\']\n+        intids = getUtility(IIntIds)\n+        doc1_intid = intids.getId(doc1)\n+        doc2_intid = intids.getId(doc2)\n+        doc3_intid = intids.getId(doc3)\n+        doc1.relatedItems = PersistentList()\n+        doc1.relatedItems.append(RelationValue(doc2_intid))\n+        doc1.relatedItems.append(RelationValue(doc3_intid))\n+        modified(doc1)\n+        # api.relation.create(doc1, doc2, \'relatedItems\')\n+        # api.relation.create(doc1, doc3, \'relatedItems\')\n+\n+        # Make sure the catalog index queue is flushed.\n+        self.portal.portal_catalog.searchResults({})\n+\n+        stats, broken = get_relations_stats()\n+        self.assertEqual(dict(stats), {\'relatedItems\': 2})\n+        self.assertEqual(dict(broken), {})\n+\n+        view = getMultiAdapter((self.portal, self.request), name=\'rebuild-relations\')\n+        results = view(rebuild=True, flush_and_rebuild_intids=True)\n+\n+        # relations are the same after a rebuild\n+        stats, broken = get_relations_stats()\n+        self.assertEqual(dict(stats), {\'relatedItems\': 2})\n+        self.assertEqual(dict(broken), {})\n+\n+        # intids are now changed\n+        doc1_intid_after = intids.getId(doc1)\n+        doc2_intid_after = intids.getId(doc2)\n+        doc3_intid_after = intids.getId(doc3)\n+        self.assertNotEqual(doc1_intid, doc1_intid_after)\n+        self.assertNotEqual(doc2_intid, doc2_intid_after)\n+        self.assertNotEqual(doc3_intid, doc3_intid_after)\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py\nindex ccdbce6c6b..8cab7e457c 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py\n@@ -1,5 +1,5 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import ISearchSchema\n+from plone.base.interfaces import ISearchSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getMultiAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py\nindex f2f39cb42f..12898194be 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py\n@@ -1,5 +1,5 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISecuritySchema\n from Products.CMFPlone.testing import \\\n     PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.app.testing import TEST_USER_ID, setRoles\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py\nindex 38ec5f45e8..d8786bbb95 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py\n@@ -1,5 +1,5 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getMultiAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py\nindex 1294c6812e..311d29b9e3 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py\n@@ -1,5 +1,5 @@\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import ITypesSchema\n+from plone.base.interfaces import ITypesSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getMultiAdapter\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py\nindex 6593bfa4f8..7e92c90e83 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py\n@@ -1,6 +1,6 @@\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema\n+from plone.base.interfaces import IUserGroupsSettingsSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n@@ -31,13 +31,14 @@ def test_usergroups_controlpanel_view(self):\n \n     def test_usergroups_in_controlpanel(self):\n         self.controlpanel = getToolByName(self.portal, "portal_controlpanel")\n-        self.assertTrue(\n-            \'UsersGroups\'\n-            in [\n-                a.getAction(self)[\'id\']\n-                for a in self.controlpanel.listActions()\n-            ]\n-        )\n+        actions = [\n+            a.getAction(self)[\'id\']\n+            for a in self.controlpanel.listActions()\n+        ]\n+        self.assertTrue(\'UsersGroups\' in actions)\n+        self.assertTrue(\'UsersGroups2\' in actions)\n+        self.assertTrue(\'UsersGroupsSettings\' in actions)\n+        self.assertTrue(\'MemberFields\' in actions)\n \n     def test_many_groups_setting(self):\n         self.assertTrue(hasattr(self.settings, \'many_groups\'))\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_upgrades1.zcml b/Products/CMFPlone/controlpanel/tests/test_upgrades1.zcml\nindex a33635e929..957e962283 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_upgrades1.zcml\n+++ b/Products/CMFPlone/controlpanel/tests/test_upgrades1.zcml\n@@ -7,7 +7,7 @@\n       name="testfixture1"\n       title="Plone Test Fixture 1"\n       directory="profiles/testfixture"\n-      for="Products.CMFPlone.interfaces.ITestCasePloneSiteRoot"\n+      for="plone.base.interfaces.ITestCasePloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_upgrades2.zcml b/Products/CMFPlone/controlpanel/tests/test_upgrades2.zcml\nindex 0a6fcb4c43..c02f7be17d 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_upgrades2.zcml\n+++ b/Products/CMFPlone/controlpanel/tests/test_upgrades2.zcml\n@@ -7,7 +7,7 @@\n       name="testfixture2"\n       title="Plone Test Fixture 2"\n       directory="profiles/testfixture"\n-      for="Products.CMFPlone.interfaces.ITestCasePloneSiteRoot"\n+      for="plone.base.interfaces.ITestCasePloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \ndiff --git a/Products/CMFPlone/defaultpage.py b/Products/CMFPlone/defaultpage.py\nindex 626bebb829..bdf7402894 100644\n--- a/Products/CMFPlone/defaultpage.py\n+++ b/Products/CMFPlone/defaultpage.py\n@@ -1,139 +1,3 @@\n-from Acquisition import aq_base\n-from Acquisition import aq_parent\n-from Acquisition import aq_inner\n-from plone.registry.interfaces import IRegistry\n-from Products.BTreeFolder2.BTreeFolder2 import BTreeFolder2Base\n-from Products.CMFCore.interfaces import IFolderish\n-from Products.CMFCore.interfaces import ISiteRoot\n-from Products.CMFDynamicViewFTI.interfaces import IBrowserDefault\n-from Products.CMFDynamicViewFTI.interfaces import IDynamicViewTypeInformation\n-from zope.component import getUtility\n-from zope.component import queryAdapter\n-from zope.component import queryUtility\n-from zope.component import queryMultiAdapter\n+from zope.deprecation import moved\n \n-\n-def get_default_page(context):\n-    """Given a folderish item, find out if it has a default-page using\n-    the following lookup rules:\n-\n-        1. A content object called \'index_html\' wins\n-        2. Else check for IBrowserDefault, either if the container implements\n-           it or if an adapter exists. In both cases fetch its FTI and either\n-           take it if it implements IDynamicViewTypeInformation or adapt it to\n-           IDynamicViewTypeInformation. call getDefaultPage on the implementer\n-           and take value if given.\n-        3. Else, look up the attribute default_page on the object, without\n-           acquisition in place\n-        3.1 look for a content in the container with the id, no acquisition!\n-        3.2 look for a content at portal, with acquisition\n-        4. Else, look up the property default_page in site_properties for\n-           magic ids and test these\n-\n-    The id of the first matching item is then used to lookup a translation\n-    and if found, its id is returned. If no default page is set, None is\n-    returned. If a non-folderish item is passed in, return None always.\n-    """\n-    # met precondition?\n-    if not IFolderish.providedBy(context):\n-        return\n-\n-    # The ids where we look for default - must support __contains__\n-    ids = set()\n-\n-    # For BTreeFolders we just use the __contains__ otherwise build a set\n-    if isinstance(aq_base(context), BTreeFolder2Base):\n-        ids = context\n-    elif hasattr(aq_base(context), \'objectIds\'):\n-        ids = set(context.objectIds())\n-\n-    # 1. test for contentish index_html\n-    if \'index_html\' in ids:\n-        return \'index_html\'\n-\n-    # 2. Test for IBrowserDefault\n-    if IBrowserDefault.providedBy(context):\n-        browserDefault = context\n-    else:\n-        browserDefault = queryAdapter(context, IBrowserDefault)\n-\n-    if browserDefault is not None:\n-        fti = context.getTypeInfo()\n-        if fti is not None:\n-            if IDynamicViewTypeInformation.providedBy(fti):\n-                dynamic_fti = fti\n-            else:\n-                dynamic_fti = queryAdapter(fti, IDynamicViewTypeInformation)\n-            if dynamic_fti is not None:\n-                page = dynamic_fti.getDefaultPage(context, check_exists=True)\n-                if page is not None:\n-                    return page\n-\n-    # 3.1 Test for default_page attribute in folder, no acquisition\n-    pages = getattr(aq_base(context), \'default_page\', [])\n-    if isinstance(pages, str):\n-        pages = [pages]\n-    for page in pages:\n-        if page and page in ids:\n-            return page\n-\n-    portal = queryUtility(ISiteRoot)\n-    # Might happen during portal creation\n-    if portal is None:\n-        return\n-\n-    # 3.2 Test for default page in portal, acquire\n-    for page in pages:\n-        if portal.unrestrictedTraverse(page, None):\n-            return page\n-\n-    # 4. Test for default sitewide default_page setting\n-    registry = getUtility(IRegistry)\n-    for page in registry.get(\'plone.default_page\', []):\n-        if page in ids:\n-            return page\n-\n-\n-def is_default_page(container, obj):\n-    """Finds out if the given obj is the default page in its parent folder.\n-\n-    Only considers explicitly contained objects, either set as index_html,\n-    with the default_page property, or using IBrowserDefault.\n-    """\n-    parent_default_page = get_default_page(container)\n-    precondition = (\n-        parent_default_page is not None\n-        and \'/\' not in parent_default_page\n-        and hasattr(aq_base(obj), \'getId\')\n-    )\n-    return precondition and (parent_default_page == obj.getId())\n-\n-\n-def _getDefaultPageView(obj, request):\n-    """This is a nasty hack because the view lookup fails when it occurs too\n-       early in the publishing process because the request isn\'t marked with\n-       the default skin.  Explicitly marking the request appears to cause\n-       connection errors, so we just instantiate the view manually.\n-    """\n-    view = queryMultiAdapter((obj, request), name=\'default_page\')\n-    if view is None:\n-        # mask circular import\n-        from Products.CMFPlone.browser.defaultpage import DefaultPage\n-        view = DefaultPage(obj, request)\n-    return view\n-\n-\n-def check_default_page_via_view(obj, request):\n-    container = aq_parent(aq_inner(obj))\n-    if container is None:\n-        return False\n-    view = _getDefaultPageView(container, request)\n-    return view.isDefaultPage(obj)\n-\n-\n-def get_default_page_via_view(obj, request):\n-    # Short circuit if we are not looking at a Folder\n-    if not obj.isPrincipiaFolderish:\n-        return None\n-    view = _getDefaultPageView(obj, request)\n-    return view.getDefaultPage()\n+moved(\'plone.base.defaultpage\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/deprecated.zcml b/Products/CMFPlone/deprecated.zcml\ndeleted file mode 100644\nindex e93a741095..0000000000\n--- a/Products/CMFPlone/deprecated.zcml\n+++ /dev/null\n@@ -1,16 +0,0 @@\n-<configure xmlns="http://namespaces.zope.org/zope"\n-           xmlns:browser="http://namespaces.zope.org/browser"\n-           xmlns:five="http://namespaces.zope.org/five"\n-           xmlns:zcml="http://namespaces.zope.org/zcml"\n-           i18n_domain="plone">\n-\n-  <!-- The following declarations are deprecated and will be removed in\n-       Plone 4.0. -->\n-\n-  <five:deprecatedManageAddDelete\n-      class=".Portal.PloneSite" />\n-\n-  <five:deprecatedManageAddDelete\n-      class=".CatalogTool.CatalogTool" />\n-\n-</configure>\ndiff --git a/Products/CMFPlone/events.py b/Products/CMFPlone/events.py\nindex b9c04fd830..e8ffce63ac 100644\n--- a/Products/CMFPlone/events.py\n+++ b/Products/CMFPlone/events.py\n@@ -1,14 +1,12 @@\n+from plone.base.interfaces import IReorderedEvent\n+from plone.base.interfaces import ISiteManagerCreatedEvent\n+from plone.base.utils import get_installer\n from zope.interface import implementer\n from zope.interface.interfaces import ObjectEvent\n-from Products.CMFPlone.utils import get_installer\n-\n-from .interfaces import ISiteManagerCreatedEvent\n-from .interfaces import IReorderedEvent\n \n \n @implementer(ISiteManagerCreatedEvent)\n class SiteManagerCreatedEvent(ObjectEvent):\n-\n     pass\n \n \ndiff --git a/Products/CMFPlone/exportimport/configure.zcml b/Products/CMFPlone/exportimport/configure.zcml\nindex 3607947997..e38d8c41cb 100644\n--- a/Products/CMFPlone/exportimport/configure.zcml\n+++ b/Products/CMFPlone/exportimport/configure.zcml\n@@ -76,14 +76,6 @@\n       description="Import CMFDiffTool settings">\n   </genericsetup:importStep>\n \n-  <genericsetup:importStep\n-      name="combine-bundles"\n-      title="Bundle combination"\n-      description="Combine JS/CSS bundles together"\n-      handler="Products.CMFPlone.resources.exportimport.bundles.combine">\n-    <depends name="plone.app.registry" />\n-  </genericsetup:importStep>\n-\n   <genericsetup:exportStep\n       name="content"\n       title="Content"\n@@ -122,14 +114,14 @@\n   <adapter\n      factory=".propertiestool.PlonePropertiesToolXMLAdapter"\n      provides="Products.GenericSetup.interfaces.IBody"\n-     for="Products.CMFPlone.interfaces.IPropertiesTool\n+     for="plone.base.interfaces.IPropertiesTool\n           Products.GenericSetup.interfaces.ISetupEnviron"\n      />\n \n   <adapter\n      factory=".propertiestool.SimpleItemWithPropertiesXMLAdapter"\n      provides="Products.GenericSetup.interfaces.IBody"\n-     for="Products.CMFPlone.interfaces.ISimpleItemWithProperties\n+     for="plone.base.interfaces.ISimpleItemWithProperties\n           Products.GenericSetup.interfaces.ISetupEnviron"\n      />\n \n@@ -150,7 +142,7 @@\n   <adapter\n      factory=".controlpanel.ControlPanelXMLAdapter"\n      provides="Products.GenericSetup.interfaces.IBody"\n-     for="Products.CMFPlone.interfaces.IControlPanel\n+     for="plone.base.interfaces.IControlPanel\n           Products.GenericSetup.interfaces.ISetupEnviron"\n      />\n \ndiff --git a/Products/CMFPlone/exportimport/controlpanel.py b/Products/CMFPlone/exportimport/controlpanel.py\nindex ecf8107973..48ca8c891d 100644\n--- a/Products/CMFPlone/exportimport/controlpanel.py\n+++ b/Products/CMFPlone/exportimport/controlpanel.py\n@@ -23,7 +23,7 @@\n from Products.CMFCore.interfaces import IActionProvider\n from Products.CMFCore.utils import getToolByName\n \n-from Products.CMFPlone.interfaces import IControlPanel\n+from plone.base.interfaces import IControlPanel\n \n \n class ControlPanelXMLAdapter(XMLAdapterBase):\ndiff --git a/Products/CMFPlone/exportimport/propertiestool.py b/Products/CMFPlone/exportimport/propertiestool.py\nindex 7d819ed58d..3bc7ea923b 100644\n--- a/Products/CMFPlone/exportimport/propertiestool.py\n+++ b/Products/CMFPlone/exportimport/propertiestool.py\n@@ -11,9 +11,9 @@\n from Products.GenericSetup.utils import ObjectManagerHelpers\n from Products.GenericSetup.utils import PropertyManagerHelpers\n from Products.CMFPlone.PropertiesTool import SimpleItemWithProperties\n-from Products.CMFPlone.interfaces \\\n+from plone.base.interfaces \\\n     import IPropertiesTool as IPlonePropertiesTool\n-from Products.CMFPlone.interfaces import ISimpleItemWithProperties\n+from plone.base.interfaces import ISimpleItemWithProperties\n \n _FILENAME = \'propertiestool.xml\'\n \ndiff --git a/Products/CMFPlone/exportimport/tests/testControlPanel.py b/Products/CMFPlone/exportimport/tests/testControlPanel.py\nindex e2c7d5ba76..cb016c97c0 100644\n--- a/Products/CMFPlone/exportimport/tests/testControlPanel.py\n+++ b/Products/CMFPlone/exportimport/tests/testControlPanel.py\n@@ -1,6 +1,6 @@\n from OFS.Folder import Folder\n from Products.CMFPlone.exportimport.tests.base import BodyAdapterTestCase\n-from Products.CMFPlone.interfaces import IControlPanel\n+from plone.base.interfaces import IControlPanel\n from Products.CMFPlone.PloneControlPanel import PloneControlPanel\n from zope.component import provideUtility\n from zope.component import provideAdapter\ndiff --git a/Products/CMFPlone/exportimport/tests/testPropertiesTool.py b/Products/CMFPlone/exportimport/tests/testPropertiesTool.py\nindex 511ebc786d..317b19100d 100644\n--- a/Products/CMFPlone/exportimport/tests/testPropertiesTool.py\n+++ b/Products/CMFPlone/exportimport/tests/testPropertiesTool.py\n@@ -37,7 +37,7 @@ def _populate(self, obj):\n             \'displayPublicationDateInByline\', True, \'boolean\')\n \n     def setUp(self):\n-        from Products.CMFPlone.interfaces import ISimpleItemWithProperties\n+        from plone.base.interfaces import ISimpleItemWithProperties\n         from Products.GenericSetup.interfaces import ISetupEnviron\n         from Products.GenericSetup.interfaces import IBody\n         provideAdapter(\n@@ -66,8 +66,8 @@ def _populate(self, obj):\n     def setUp(self):\n         from Products.CMFPlone.exportimport.propertiestool \\\n             import SimpleItemWithPropertiesXMLAdapter\n-        from Products.CMFPlone.interfaces import IPropertiesTool\n-        from Products.CMFPlone.interfaces import ISimpleItemWithProperties\n+        from plone.base.interfaces import IPropertiesTool\n+        from plone.base.interfaces import ISimpleItemWithProperties\n         from Products.GenericSetup.interfaces import ISetupEnviron\n         from Products.GenericSetup.interfaces import IBody\n         provideAdapter(\ndiff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py\nindex adf99b7fa1..550784c1a0 100644\n--- a/Products/CMFPlone/factory.py\n+++ b/Products/CMFPlone/factory.py\n@@ -2,23 +2,29 @@\n from plone.registry.interfaces import IRegistry\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.events import SiteManagerCreatedEvent\n-from Products.CMFPlone.interfaces import INonInstallable\n+from plone.base.interfaces import INonInstallable\n from Products.CMFPlone.Portal import PloneSite\n from Products.GenericSetup.tool import SetupTool\n-from Products.statusmessages.interfaces import IStatusMessage\n from zope.component import queryUtility\n from zope.component.hooks import setSite\n from zope.event import notify\n from zope.interface import implementer\n+from zope.lifecycleevent import ObjectCreatedEvent\n \n _TOOL_ID = \'portal_setup\'\n _DEFAULT_PROFILE = \'Products.CMFPlone:plone\'\n _TYPES_PROFILE = \'plone.app.contenttypes:default\'\n _CONTENT_PROFILE = \'plone.app.contenttypes:plone-content\'\n \n-# A little hint for PloneTestCase\n+# A little hint for PloneTestCase (pre-Plone 6.0)\n _IMREALLYPLONE5 = True\n \n+# Marker hints for code that needs to know the major Plone version\n+# Works the same way than zcml condition hints so it contains the current and the\n+# last ones\n+PLONE52MARKER = True\n+PLONE60MARKER = True\n+\n logger = getLogger(\'Plone\')\n \n \n@@ -35,7 +41,6 @@ def getNonInstallableProducts(self):\n             \'PasswordResetTool\', \'Products.PasswordResetTool\',\n             \'PlonePAS\', \'Products.PlonePAS\',\n             \'PloneLanguageTool\', \'Products.PloneLanguageTool\',\n-            \'CMFFormController\', \'Products.CMFFormController\',\n             \'MimetypesRegistry\', \'Products.MimetypesRegistry\',\n             \'PortalTransforms\', \'Products.PortalTransforms\',\n             \'CMFDiffTool\', \'Products.CMFDiffTool\',\n@@ -71,7 +76,6 @@ def getNonInstallableProfiles(self):\n                 _CONTENT_PROFILE,\n                 \'Products.CMFDiffTool:CMFDiffTool\',\n                 \'Products.CMFEditions:CMFEditions\',\n-                \'Products.CMFFormController:CMFFormController\',\n                 \'Products.CMFPlone:dependencies\',\n                 \'Products.CMFPlone:testfixture\',\n                 \'Products.NuPlone:uninstall\',\n@@ -116,8 +120,12 @@ def addPloneSite(context, site_id, title=\'Plone site\', description=\'\',\n                  extension_ids=(), setup_content=True,\n                  default_language=\'en\', portal_timezone=\'UTC\'):\n     """Add a PloneSite to the context."""\n-    context._setObject(site_id, PloneSite(site_id))\n-    site = context._getOb(site_id)\n+\n+    site = PloneSite(site_id)\n+    notify(ObjectCreatedEvent(site))\n+    context[site_id] = site\n+\n+    site = context[site_id]\n     site.setLanguage(default_language)\n     # Set the accepted language for the rest of the request.  This makes sure\n     # the front-page text gets the correct translation also when your browser\n@@ -132,49 +140,42 @@ def addPloneSite(context, site_id, title=\'Plone site\', description=\'\',\n     notify(SiteManagerCreatedEvent(site))\n     setSite(site)\n \n-    setup_tool.setBaselineContext(\'profile-%s\' % profile_id)\n-    setup_tool.runAllImportStepsFromProfile(\'profile-%s\' % profile_id)\n-\n-    reg = queryUtility(IRegistry, context=site)\n-    reg[\'plone.portal_timezone\'] = portal_timezone\n-    reg[\'plone.available_timezones\'] = [portal_timezone]\n-    reg[\'plone.default_language\'] = default_language\n-    reg[\'plone.available_languages\'] = [default_language]\n-\n-    # Install default content types profile if user do not select "example content"\n-    # during site creation.\n-    content_types_profile = content_profile_id if setup_content else _TYPES_PROFILE\n-\n-    setup_tool.runAllImportStepsFromProfile(f\'profile-{content_types_profile}\')\n-\n-    props = dict(\n-        title=title,\n-        description=description,\n-    )\n-    # Do this before applying extension profiles, so the settings from a\n-    # properties.xml file are applied and not overwritten by this\n-    site.manage_changeProperties(**props)\n-\n-    for extension_id in extension_ids:\n-        try:\n-            setup_tool.runAllImportStepsFromProfile(\n-                \'profile-%s\' % extension_id)\n-        except Exception as msg:\n-            IStatusMessage(request).add(_(\n-                \'Could not install ${profile_id}: ${error_msg}! \'\n-                \'Please try to install it manually using the "Addons" \'\n-                \'controlpanel and report any issues to the \'\n-                \'addon maintainers.\',\n-                mapping={\n-                    \'profile_id\': extension_id,\n-                    \'error_msg\': msg.args,\n-                }),\n-                type=\'error\')\n-            logger.exception(\n-                \'Error while installing addon {}. \'\n-                \'See traceback below for details.\'.format(extension_id))\n-\n-    if snapshot is True:\n-        setup_tool.createSnapshot(\'initial_configuration\')\n-\n-    return site\n+    try:\n+        setup_tool.setBaselineContext(\'profile-%s\' % profile_id)\n+        setup_tool.runAllImportStepsFromProfile(\'profile-%s\' % profile_id)\n+\n+        reg = queryUtility(IRegistry, context=site)\n+        reg[\'plone.portal_timezone\'] = portal_timezone\n+        reg[\'plone.available_timezones\'] = [portal_timezone]\n+        reg[\'plone.default_language\'] = default_language\n+        reg[\'plone.available_languages\'] = [default_language]\n+        reg[\'plone.site_title\'] = title\n+\n+        # Install default content types profile if user do not select "example content"\n+        # during site creation.\n+        content_types_profile = content_profile_id if setup_content else _TYPES_PROFILE\n+\n+        setup_tool.runAllImportStepsFromProfile(f\'profile-{content_types_profile}\')\n+\n+        props = dict(\n+            title=title,\n+            description=description,\n+        )\n+        # Do this before applying extension profiles, so the settings from a\n+        # properties.xml file are applied and not overwritten by this\n+        site.manage_changeProperties(**props)\n+\n+        for extension_id in extension_ids:\n+            try:\n+                setup_tool.runAllImportStepsFromProfile(f"profile-{extension_id}")\n+            except Exception:\n+                logger.error(f"Error while installing profile {extension_id}:")\n+                raise\n+\n+        if snapshot is True:\n+            setup_tool.createSnapshot(\'initial_configuration\')\n+\n+        return site\n+    except Exception:\n+        setSite(None)\n+        raise\ndiff --git a/Products/CMFPlone/i18nl10n.py b/Products/CMFPlone/i18nl10n.py\nindex b5fdaa64f5..d9980a07e9 100644\n--- a/Products/CMFPlone/i18nl10n.py\n+++ b/Products/CMFPlone/i18nl10n.py\n@@ -1,290 +1,3 @@\n-"""\n-Collection of i18n and l10n utility methods.\n-"""\n-from Acquisition import aq_acquire\n-from DateTime import DateTime\n-from DateTime.interfaces import IDateTime\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.utils import log\n-from zope.component import getUtility\n-from zope.i18n import translate\n-from zope.i18n.locales import locales\n-from zope.publisher.interfaces.browser import IBrowserRequest\n+from zope.deprecation import moved\n \n-import logging\n-import re\n-\n-datetime_formatvariables = {\'H\', \'I\', \'m\', \'d\', \'M\', \'p\', \'S\', \'Y\', \'y\', \'Z\'}\n-name_formatvariables = {\'a\', \'A\', \'b\', \'B\'}\n-all_formatvariables = datetime_formatvariables | name_formatvariables\n-_all_regexp_set = \',\'.join(all_formatvariables)\n-# regexp to split up ${X} format strings\n-_interp_regex = re.compile(\n-    r\'(?<!\\$)(\\$(?:[%(n)s]|{[%(n)s]}))\' % ({\'n\': _all_regexp_set})\n-)\n-# regexp to detect if this is a strftime format string\n-_dt_format_string_regexp = re.compile(fr\'\\%([{_all_regexp_set}])\')\n-\n-# those are from DateTime.DateTime, but we must not rely on its internal\n-# structures, so here a copy:\n-ENGLISH_NAMES = {\n-    \'_days\': (\n-        \'Sunday\', \'Monday\', \'Tuesday\', \'Wednesday\',  \'Thursday\', \'Friday\',\n-        \'Saturday\',\n-    ),\n-    \'_days_a\': (\'Sun\', \'Mon\', \'Tue\', \'Wed\', \'Thu\', \'Fri\', \'Sat\'),\n-    \'_days_p\': (\'Sun.\', \'Mon.\', \'Tue.\', \'Wed.\', \'Thu.\', \'Fri.\', \'Sat.\'),\n-    \'_months\': (\n-        \'\', \'January\', \'February\', \'March\', \'April\', \'May\', \'June\',\n-        \'July\', \'August\', \'September\', \'October\', \'November\', \'December\',\n-    ),\n-    \'_months_a\': (\n-        \'\', \'Jan\', \'Feb\', \'Mar\', \'Apr\', \'May\', \'Jun\',\n-        \'Jul\', \'Aug\', \'Sep\', \'Oct\', \'Nov\', \'Dec\',\n-    ),\n-    \'_months_p\': (\n-        \'\', \'Jan.\', \'Feb.\', \'Mar.\', \'Apr.\', \'May\', \'June\',\n-        \'July\', \'Aug.\', \'Sep.\', \'Oct.\', \'Nov.\', \'Dec.\'\n-    ),\n-}\n-\n-# The following are helper methods to change the default date and time formats\n-# for a specific locale. These locale dependent formats are used in the\n-# date/time widgets to determine the format and decide if a 24 hour or 12 hour\n-# AM/PM widget should be used. If \'a\' is part of the pattern the AM/PM widget\n-# will be used, otherwise a 24 hour clock.\n-#\n-# localeid is a tuple of the form: (language, country, variant)\n-# for example: (None, ) or (\'en\', ) or (\'en\', \'US\', None)\n-#\n-# value is in the format described by zope.i18n.interfaces.IDateTimeFormat\n-# for example u\'yyyy-MM-dd\' or u\'HH:mm:ss\'\n-#\n-# Note that this is a different format than used for the other methods in\n-# this module.\n-#\n-# locales uses a module level cache, so any changes you make with these\n-# methods will apply to the entire process and only need to be made once.\n-# You can use them in any code imported at startup, for example in a packages\n-# __init__ method.\n-#\n-# In order to use a 24 hour clock for English speakers, you would do:\n-#\n-# from Products.CMFPlone import i18nl10n\n-# i18nl10n.setDefaultTimeFormat((\'en\',), u\'HH:mm:ss\')\n-\n-\n-def setDefaultDateFormat(localeid, value):\n-    gregorian = locales.getLocale(*localeid).dates.calendars[\'gregorian\']\n-    date_format = gregorian.dateFormats[\'medium\'].formats[None]\n-    date_format.pattern = value\n-\n-\n-def setDefaultTimeFormat(localeid, value):\n-    gregorian = locales.getLocale(*localeid).dates.calendars[\'gregorian\']\n-    time_format = gregorian.timeFormats[\'medium\'].formats[None]\n-    time_format.pattern = value\n-\n-\n-def utranslate(domain, msgid, mapping=None, context=None,\n-               target_language=None, default=None):\n-    # We used to pass an object as context.\n-    if not IBrowserRequest.providedBy(context):\n-        context = aq_acquire(context, \'REQUEST\')\n-    # The signature of zope.i18n\'s translate has the msgid and domain switched\n-    return translate(msgid, domain=domain, mapping=mapping, context=context,\n-                     target_language=target_language, default=default)\n-\n-\n-def get_formatstring_from_registry(msgid):\n-    """If the Enabled record is True, return a format string."""\n-    registry = getUtility(IRegistry)\n-    name_root = \'Products.CMFPlone.i18nl10n.override_dateformat.\'\n-    if registry.get(name_root + \'Enabled\', False) is False:\n-        return None\n-    # msgid: "date_format_long", "date_format_short", or "time_format"\n-    record_name = name_root + msgid\n-    return registry.get(record_name, None)\n-\n-\n-def ulocalized_time(time, long_format=None, time_only=False, context=None,\n-                    domain=\'plonelocales\', request=None, target_language=None):\n-    """unicode aware localized time method (l10n)"""\n-\n-    if time_only:\n-        msgid = \'time_format\'\n-    elif long_format:\n-        msgid = \'date_format_long\'\n-    else:\n-        msgid = \'date_format_short\'\n-\n-    # NOTE: this requires the presence of three msgids inside the translation\n-    #       catalog date_format_long, date_format_short, and time_format\n-    #       These msgids are translated using interpolation.\n-    #       The variables used here are the same as used in the strftime\n-    #       formating.\n-    #       Supported are:\n-    #           %A, %a, %B, %b, %H, %I, %m, %d, %M, %p, %S, %Y, %y, %Z\n-    #       Each used as variable in the msgstr without the %.\n-    #       For example: "${A} ${d}. ${B} ${Y}, ${H}:${M} ${Z}"\n-    #       Each language dependend part is translated itself as well.\n-\n-    # From http://docs.python.org/lib/module-time.html\n-    #\n-    # %a    Locale\'s abbreviated weekday name.\n-    # %A        Locale\'s full weekday name.\n-    # %b        Locale\'s abbreviated month name.\n-    # %B        Locale\'s full month name.\n-    # %d        Day of the month as a decimal number [01,31].\n-    # %H        Hour (24-hour clock) as a decimal number [00,23].\n-    # %I        Hour (12-hour clock) as a decimal number [01,12].\n-    # %m        Month as a decimal number [01,12].\n-    # %M        Minute as a decimal number [00,59].\n-    # %p        Locale\'s equivalent of either AM or PM.\n-    # %S        Second as a decimal number [00,61].\n-    # %y        Year without century as a decimal number [00,99].\n-    # %Y        Year with century as a decimal number.\n-    # %Z        Time zone name (no characters if no time zone exists).\n-\n-    mapping = {}\n-    # convert to DateTime instances. Either a date string or\n-    # a DateTime instance needs to be passed.\n-    if not IDateTime.providedBy(time):\n-        try:\n-            time = DateTime(time)\n-        except:\n-            log(\'Failed to convert %s to a DateTime object\' % time,\n-                severity=logging.DEBUG)\n-            return None\n-\n-    if context is None:\n-        # when without context, we cannot do very much.\n-        return time.ISO8601()\n-\n-    if request is None:\n-        request = aq_acquire(context, \'REQUEST\')\n-\n-    # 1. if our Enabled flag in the configuration registry is set,\n-    # the format string there should override the translation machinery\n-    formatstring = get_formatstring_from_registry(msgid)\n-\n-    if formatstring is not None:\n-        if _dt_format_string_regexp.findall(formatstring):\n-            # classic strftime formatting, no i18n/l10n\n-            return time.strftime(formatstring)\n-    else:\n-        # 2. the normal case: translation machinery,\n-        # that is the ".../LC_MESSAGES/plonelocales.po" files\n-        formatstring = translate(\n-            msgid, domain, mapping, request, target_language=target_language\n-        )\n-\n-    # 3. if both failed, fall back to hardcoded ISO style\n-    if formatstring == msgid:\n-        if msgid == \'date_format_long\':\n-            formatstring = \'%Y-%m-%d %H:%M\'  # 2038-01-19 03:14\n-        elif msgid == \'date_format_short\':\n-            formatstring = \'%Y-%m-%d\'  # 2038-01-19\n-        elif msgid == \'time_format\':\n-            formatstring = \'%H:%M\'  # 03:14\n-        else:\n-            formatstring = \'[INTERNAL ERROR]\'\n-        return time.strftime(formatstring)\n-\n-    # get the format elements used in the formatstring\n-    formatelements = {el[2:-1] for el in _interp_regex.findall(formatstring)}\n-\n-    # add used elements to mapping\n-    elements = formatelements & datetime_formatvariables\n-    for key in elements:\n-        mapping[key] = time.strftime(\'%\' + key)\n-\n-    # add weekday name, abbr. weekday name, month name, abbr month name\n-    name_elements = formatelements & name_formatvariables\n-    if {\'a\', \'A\'} & name_elements:\n-        weekday = int(time.strftime(\'%w\'))  # weekday, sunday = 0\n-        if \'a\' in name_elements:\n-            mapping[\'a\'] = weekdayname_msgid_abbr(weekday)\n-        if \'A\' in name_elements:\n-            mapping[\'A\'] = weekdayname_msgid(weekday)\n-    if {\'b\', \'B\'} & name_elements:\n-        monthday = int(time.strftime(\'%m\'))  # month, january = 1\n-        if \'b\' in name_elements:\n-            mapping[\'b\'] = monthname_msgid_abbr(monthday)\n-        if \'B\' in name_elements:\n-            mapping[\'B\'] = monthname_msgid(monthday)\n-\n-    # translate translateable elements\n-    for key in name_elements:\n-        mapping[key] = translate(\n-            mapping[key],\n-            domain,\n-            context=request,\n-            default=mapping[key],\n-            target_language=target_language,\n-        )\n-\n-    # translate the time string\n-    return translate(\n-        msgid, domain, mapping, request, target_language=target_language\n-    )\n-\n-\n-def _numbertoenglishname(number, format=None, attr=\'_days\'):\n-    # returns the english name of day or month number\n-    # starting with Sunday == 0\n-    # and January = 1\n-    # format is either None, \'a\' or \'p\')\n-    #   None  means full name (January, February, ...)\n-    #   \'a\' means abbreviated (Jan, Feb, ..)\n-    #   \'p\' means abbreviated with . (dot) at end (Jan., Feb., ...)\n-\n-    number = int(number)\n-    if format is not None:\n-        attr = f\'{attr}_{format}\'\n-    return ENGLISH_NAMES[attr][number]\n-\n-\n-def monthname_english(number, format=None):\n-    # returns the english name of month with number\n-    return _numbertoenglishname(number, format=format, attr=\'_months\')\n-\n-\n-def weekdayname_english(number, format=None):\n-    # returns the english name of week with number\n-    return _numbertoenglishname(number, format=format, attr=\'_days\')\n-\n-\n-def monthname_msgid(number):\n-    # returns the msgid for monthname\n-    # use to translate to full monthname (January, February, ...)\n-    # e.g. month_jan, month_feb, ...\n-    return "month_%s" % monthname_english(number, format=\'a\').lower()\n-\n-\n-def monthname_msgid_abbr(number):\n-    # returns the msgid for the abbreviated monthname\n-    # use to translate to abbreviated format (Jan, Feb, ...)\n-    # e.g. month_jan_abbr, month_feb_abbr, ...\n-    return "month_%s_abbr" % monthname_english(number, format=\'a\').lower()\n-\n-\n-def weekdayname_msgid(number):\n-    # returns the msgid for the weekdayname\n-    # use to translate to full weekdayname (Monday, Tuesday, ...)\n-    # e.g. weekday_mon, weekday_tue, ...\n-    return "weekday_%s" % weekdayname_english(number, format=\'a\').lower()\n-\n-\n-def weekdayname_msgid_abbr(number):\n-    # returns the msgid for abbreviated weekdayname\n-    # use to translate to abbreviated format (Mon, Tue, ...)\n-    # e.g. weekday_mon_abbr, weekday_tue_abbr, ...\n-    return "weekday_%s_abbr" % weekdayname_english(number, format=\'a\').lower()\n-\n-\n-def weekdayname_msgid_short(number):\n-    # return the msgid for short weekdayname\n-    # use to translate to 2 char format (Mo, Tu, ...)\n-    # e.g. weekday_mon_short, weekday_tue_short, ...\n-    return "weekday_%s_short" % weekdayname_english(number, format=\'a\').lower()\n+moved(\'plone.base.i18nl10n\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/resources/exportimport/__init__.py b/Products/CMFPlone/image_scales/__init__.py\nsimilarity index 100%\nrename from Products/CMFPlone/resources/exportimport/__init__.py\nrename to Products/CMFPlone/image_scales/__init__.py\ndiff --git a/Products/CMFPlone/image_scales/adapters.py b/Products/CMFPlone/image_scales/adapters.py\nnew file mode 100644\nindex 0000000000..6fc7230b48\n--- /dev/null\n+++ b/Products/CMFPlone/image_scales/adapters.py\n@@ -0,0 +1,33 @@\n+from Acquisition import aq_inner\n+from plone.dexterity.interfaces import IDexterityContent\n+from plone.dexterity.utils import iterSchemata\n+from plone.base.interfaces import IImageScalesAdapter\n+from plone.base.interfaces import IImageScalesFieldAdapter\n+from zope.component import adapter\n+from zope.component import queryMultiAdapter\n+from zope.interface import implementer\n+from zope.interface import Interface\n+from zope.schema import getFields\n+\n+\n+@implementer(IImageScalesAdapter)\n+@adapter(IDexterityContent, Interface)\n+class ImageScales:\n+    def __init__(self, context, request):\n+        self.context = context\n+        self.request = request\n+\n+    def __call__(self):\n+        obj = aq_inner(self.context)\n+        res = {}\n+        for schema in iterSchemata(self.context):\n+            for name, field in getFields(schema).items():\n+                # serialize the field\n+                serializer = queryMultiAdapter(\n+                    (field, obj, self.request), IImageScalesFieldAdapter\n+                )\n+                if serializer:\n+                    scales = serializer()\n+                    if scales:\n+                        res[name] = scales\n+        return res\ndiff --git a/Products/CMFPlone/image_scales/configure.zcml b/Products/CMFPlone/image_scales/configure.zcml\nnew file mode 100644\nindex 0000000000..623a9fb12d\n--- /dev/null\n+++ b/Products/CMFPlone/image_scales/configure.zcml\n@@ -0,0 +1,14 @@\n+<configure\n+    xmlns="http://namespaces.zope.org/zope"\n+    xmlns:zcml="http://namespaces.zope.org/zcml">\n+\n+  <!-- indexer -->\n+  <adapter\n+      factory=".indexer.image_scales"\n+      name="image_scales"\n+      />\n+\n+  <!-- adapters -->\n+  <adapter factory=".adapters.ImageScales" />\n+\n+</configure>\ndiff --git a/Products/CMFPlone/image_scales/indexer.py b/Products/CMFPlone/image_scales/indexer.py\nnew file mode 100644\nindex 0000000000..2c4c9c20be\n--- /dev/null\n+++ b/Products/CMFPlone/image_scales/indexer.py\n@@ -0,0 +1,22 @@\n+from persistent.dict import PersistentDict\n+from plone.base.interfaces import IImageScalesAdapter\n+from plone.dexterity.interfaces import IDexterityContent\n+from plone.indexer.decorator import indexer\n+from zope.component import queryMultiAdapter\n+from zope.globalrequest import getRequest\n+\n+\n+@indexer(IDexterityContent)\n+def image_scales(obj):\n+    """\n+    Indexer used to store in metadata the image scales of the object.\n+    """\n+    adapter = queryMultiAdapter((obj, getRequest()), IImageScalesAdapter)\n+    if not adapter:\n+        # Raising an AttributeError does the right thing,\n+        # making sure nothing is saved in the catalog.\n+        raise AttributeError\n+    scales = adapter()\n+    if not scales:\n+        raise AttributeError\n+    return PersistentDict(scales)\ndiff --git a/Products/CMFPlone/image_scales/tests/__init__.py b/Products/CMFPlone/image_scales/tests/__init__.py\nnew file mode 100644\nindex 0000000000..e69de29bb2\ndiff --git a/Products/CMFPlone/image_scales/tests/images.xml b/Products/CMFPlone/image_scales/tests/images.xml\nnew file mode 100644\nindex 0000000000..c12dcb4a1e\n--- /dev/null\n+++ b/Products/CMFPlone/image_scales/tests/images.xml\n@@ -0,0 +1,12 @@\n+<model xmlns="http://namespaces.plone.org/supermodel/schema"\n+       xmlns:marshal="http://namespaces.plone.org/supermodel/marshal">\n+  <schema>\n+    <field name="image1" type="plone.namedfile.field.NamedBlobImage"\n+        marshal:primary="true">\n+      <title>Image 1</title>\n+    </field>\n+    <field name="image2" type="plone.namedfile.field.NamedBlobImage">\n+      <title>Image 2</title>\n+    </field>\n+  </schema>\n+</model>\ndiff --git a/Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py b/Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py\nnew file mode 100644\nindex 0000000000..0cc5c2c1e0\n--- /dev/null\n+++ b/Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py\n@@ -0,0 +1,154 @@\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n+from plone.dexterity.fti import DexterityFTI\n+from plone.dexterity.utils import iterSchemata\n+from plone.namedfile.file import NamedImage\n+from plone.base.interfaces import IImageScalesAdapter\n+from plone.base.interfaces import IImageScalesFieldAdapter\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from Products.CMFPlone.tests import dummy\n+from zope.component import queryMultiAdapter\n+\n+import Missing\n+import unittest\n+\n+\n+class ImageScalesAdaptersRegisteredTest(unittest.TestCase):\n+    """Test portal actions control panel."""\n+\n+    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+\n+    def setUp(self):\n+        self.portal = self.layer["portal"]\n+        self.request = self.layer["request"]\n+        setRoles(self.portal, TEST_USER_ID, ["Manager"])\n+\n+        news_id = self.portal.invokeFactory(\n+            "News Item",\n+            id="news",\n+            title="News",\n+        )\n+\n+        image_id = self.portal.invokeFactory(\n+            "Image",\n+            id="image",\n+            title="image",\n+            image=NamedImage(dummy.Image(), filename="dummy.gif"),\n+        )\n+\n+        self.image = self.portal[image_id]\n+        self.news = self.portal[news_id]\n+\n+    def serialize(self, context, fieldname):\n+        for schema in iterSchemata(context):\n+            if fieldname in schema:\n+                field = schema.get(fieldname)\n+                break\n+        serializer = queryMultiAdapter(\n+            (field, context, self.request), IImageScalesFieldAdapter\n+        )\n+        if serializer:\n+            return serializer()\n+        return None\n+\n+    def test_field_adapter_do_not_return_scales_for_fields_without_adapter(self):\n+        res = self.serialize(self.image, "title")\n+        self.assertEqual(res, None)\n+\n+    def test_field_adapter_return_scales_for_fields_with_adapter(self):\n+        res = self.serialize(self.image, "image")\n+        self.assertNotEqual(res, None)\n+        self.assertEqual(len(res), 1)\n+        scales = res[0]\n+        self.assertEqual(scales["content-type"], "image/gif")\n+        self.assertEqual(scales["filename"], "dummy.gif")\n+        self.assertIn("scales", scales)\n+        scales = scales["scales"]\n+        self.assertIn("listing", scales)\n+        listing_scale = scales["listing"]\n+        self.assertIn("download", listing_scale)\n+\n+    def test_field_adapter_do_not_return_scales_for_empty_fields_with_adapter(self):\n+        res = self.serialize(self.news, "image")\n+        self.assertEqual(res, None)\n+\n+    def test_field_adapter_does_not_return_larger_scales(self):\n+        # Add an image of 900 by 900 pixels.\n+        image_id = self.portal.invokeFactory(\n+            "Image",\n+            id="jpeg",\n+            title="jpeg image",\n+            image=NamedImage(dummy.JpegImage(), filename="900.jpeg"),\n+        )\n+        image = self.portal[image_id]\n+        res = self.serialize(image, "image")\n+        self.assertNotEqual(res, None)\n+        self.assertEqual(len(res), 1)\n+        scales = res[0]\n+        self.assertEqual(scales["content-type"], "image/jpeg")\n+        self.assertIn("scales", scales)\n+        self.assertEqual(scales["filename"], "900.jpeg")\n+        self.assertEqual(scales["width"], 900)\n+        self.assertEqual(scales["height"], 900)\n+        download = scales["download"]\n+        self.assertTrue(download.startswith("@@images/image-900-"))\n+        self.assertTrue(download.endswith(".jpeg"))\n+        scales = scales["scales"]\n+        # larger and huge should not be in here: these scales would return the same\n+        # content as the original.\n+        self.assertEqual(\n+            ["icon", "large", "listing", "mini", "preview", "teaser", "thumb", "tile"],\n+            sorted(scales.keys()),\n+        )\n+        preview = scales["preview"]\n+        self.assertEqual(preview["width"], 400)\n+        self.assertEqual(preview["height"], 400)\n+        self.assertTrue(preview["download"].startswith("@@images/image-400-"))\n+\n+    def test_content_adapter_return_proper_scales(self):\n+        res = queryMultiAdapter((self.image, self.request), IImageScalesAdapter)()\n+        self.assertNotEqual(res, None)\n+        self.assertEqual(list(res.keys()), ["image"])\n+        self.assertEqual(len(res["image"]), 1)\n+        scales = res["image"][0]\n+        self.assertEqual(scales["content-type"], "image/gif")\n+        self.assertIn("scales", scales)\n+\n+    def test_content_adapter_do_not_return_scales_if_empty_fields(self):\n+        res = queryMultiAdapter((self.news, self.request), IImageScalesAdapter)()\n+        self.assertEqual(res, {})\n+\n+    def test_metadata_populated_with_scales(self):\n+        catalog = self.portal.portal_catalog\n+        news_brain = catalog(UID=self.news.UID())[0]\n+        image_brain = catalog(UID=self.image.UID())[0]\n+\n+        self.assertEqual(news_brain.image_scales, Missing.Value)\n+        self.assertEqual(list(image_brain.image_scales.keys()), ["image"])\n+        self.assertEqual(len(image_brain.image_scales["image"]), 1)\n+        self.assertEqual(\n+            image_brain.image_scales["image"][0]["content-type"], "image/gif"\n+        )\n+        self.assertIn("scales", image_brain.image_scales["image"][0])\n+\n+    def test_multiple_image_fields(self):\n+        # Note: since there are basically three ways to set fields on an FTI, we use\n+        # one, and make the others explicitly None, otherwise no fields may be found.\n+        fti = DexterityFTI(\n+            "multi",\n+            model_file="Products.CMFPlone.image_scales.tests:images.xml",\n+            model_source=None,\n+            schema=None,\n+        )\n+        self.portal.portal_types._setObject("multi", fti)\n+        content_id = self.portal.invokeFactory(\n+            "multi",\n+            id="multi",\n+            title="Multi",\n+            image1=NamedImage(dummy.Image()),\n+            image2=NamedImage(dummy.Image()),\n+        )\n+        multi = self.portal[content_id]\n+        catalog = self.portal.portal_catalog\n+        brain = catalog(UID=multi.UID())[0]\n+        self.assertEqual(sorted(list(brain.image_scales.keys())), ["image1", "image2"])\ndiff --git a/Products/CMFPlone/interfaces/__init__.py b/Products/CMFPlone/interfaces/__init__.py\nindex 318f89ae1e..f5e6813e6b 100644\n--- a/Products/CMFPlone/interfaces/__init__.py\n+++ b/Products/CMFPlone/interfaces/__init__.py\n@@ -1,69 +1,65 @@\n-# flake8: noqa\n-from Products.CMFPlone.interfaces.basetool import IPloneBaseTool\n-from Products.CMFPlone.interfaces.basetool import IPloneCatalogTool\n-from Products.CMFPlone.interfaces.basetool import IPloneTool\n-from Products.CMFPlone.interfaces.breadcrumbs import IHideFromBreadcrumbs\n-from Products.CMFPlone.interfaces.constrains import IConstrainTypes\n-from Products.CMFPlone.interfaces.constrains import ISelectableConstrainTypes\n-from Products.CMFPlone.interfaces.controlpanel import IActionSchema\n-from Products.CMFPlone.interfaces.controlpanel import IControlPanel\n-from Products.CMFPlone.interfaces.controlpanel import IDateAndTimeSchema\n-from Products.CMFPlone.interfaces.controlpanel import IEditingSchema\n-from Products.CMFPlone.interfaces.controlpanel import IFilterSchema\n-from Products.CMFPlone.interfaces.controlpanel import IImagingSchema\n-from Products.CMFPlone.interfaces.controlpanel import ILinkSchema\n-from Products.CMFPlone.interfaces.controlpanel import ILoginSchema\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n-from Products.CMFPlone.interfaces.controlpanel import IMaintenanceSchema\n-from Products.CMFPlone.interfaces.controlpanel import IMarkupSchema\n-from Products.CMFPlone.interfaces.controlpanel import INavigationSchema\n-from Products.CMFPlone.interfaces.controlpanel import INewActionSchema\n-from Products.CMFPlone.interfaces.controlpanel import ISearchSchema\n-from Products.CMFPlone.interfaces.controlpanel import ISecuritySchema\n-from Products.CMFPlone.interfaces.controlpanel import ISiteSchema\n-from Products.CMFPlone.interfaces.controlpanel import ISocialMediaSchema\n-from Products.CMFPlone.interfaces.controlpanel import ITinyMCEAdvancedSchema\n-from Products.CMFPlone.interfaces.controlpanel import ITinyMCELayoutSchema\n-from Products.CMFPlone.interfaces.controlpanel import ITinyMCEPluginSchema\n-from Products.CMFPlone.interfaces.controlpanel import ITinyMCEResourceTypesSchema\n-from Products.CMFPlone.interfaces.controlpanel import ITinyMCESchema\n-from Products.CMFPlone.interfaces.controlpanel import ITinyMCESpellCheckerSchema\n-from Products.CMFPlone.interfaces.controlpanel import ITypesSchema\n-from Products.CMFPlone.interfaces.controlpanel import IUserGroupsSettingsSchema\n-from Products.CMFPlone.interfaces.events import IConfigurationChangedEvent\n-from Products.CMFPlone.interfaces.events import IReorderedEvent\n-from Products.CMFPlone.interfaces.events import ISiteManagerCreatedEvent\n-from Products.CMFPlone.interfaces.installable import INonInstallable\n-from Products.CMFPlone.interfaces.interface import IInterfaceTool\n-from Products.CMFPlone.interfaces.language import ILanguage\n-from Products.CMFPlone.interfaces.login import IForcePasswordChange\n-from Products.CMFPlone.interfaces.login import IInitialLogin\n-from Products.CMFPlone.interfaces.login import ILogin\n-from Products.CMFPlone.interfaces.login import ILoginForm\n-from Products.CMFPlone.interfaces.login import ILoginFormSchema\n-from Products.CMFPlone.interfaces.login import ILoginHelpForm\n-from Products.CMFPlone.interfaces.login import ILoginHelpFormSchema\n-from Products.CMFPlone.interfaces.login import IRedirectAfterLogin\n-from Products.CMFPlone.interfaces.migration import IMigrationTool\n-from Products.CMFPlone.interfaces.password_reset import IPasswordResetToolView\n-from Products.CMFPlone.interfaces.password_reset import IPWResetTool\n-from Products.CMFPlone.interfaces.patterns import IPatternsSettings\n-from Products.CMFPlone.interfaces.properties import IPropertiesTool\n-from Products.CMFPlone.interfaces.properties import ISimpleItemWithProperties\n-from Products.CMFPlone.interfaces.resources import IBundleRegistry\n-from Products.CMFPlone.interfaces.resources import IResourceRegistry\n-from Products.CMFPlone.interfaces.siteroot import IMigratingPloneSiteRoot\n-from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot\n-from Products.CMFPlone.interfaces.siteroot import ITestCasePloneSiteRoot\n-from Products.CMFPlone.interfaces.structure import INonStructuralFolder\n-from Products.CMFPlone.interfaces.syndication import ISiteSyndicationSettings\n-from Products.CMFPlone.interfaces.translationservice import ITranslationServiceTool\n-from Products.CMFPlone.interfaces.workflow import IWorkflowChain\n-\n from zope.deferredimport import deprecated\n \n-\n deprecated(\n-    "It has been moved to plone.i18n.interfaces, import from there instead.",\n-    ILanguageSchema=\'plone.i18n.interfaces:ILanguageSchema\',\n+    "Moved to plone.base.interfaces, import from there instead (will be removed in Plone 7).",\n+    IPloneBaseTool="plone.base.interfaces.basetool:IPloneBaseTool",\n+    IPloneCatalogTool="plone.base.interfaces.basetool:IPloneCatalogTool",\n+    IPloneTool="plone.base.interfaces.basetool:IPloneTool",\n+    IHideFromBreadcrumbs="plone.base.interfaces.breadcrumbs:IHideFromBreadcrumbs",\n+    IConstrainTypes="plone.base.interfaces.constrains:IConstrainTypes",\n+    ISelectableConstrainTypes="plone.base.interfaces.constrains:ISelectableConstrainTypes",\n+    IActionSchema="plone.base.interfaces.controlpanel:IActionSchema",\n+    IControlPanel="plone.base.interfaces.controlpanel:IControlPanel",\n+    IDateAndTimeSchema="plone.base.interfaces.controlpanel:IDateAndTimeSchema",\n+    IEditingSchema="plone.base.interfaces.controlpanel:IEditingSchema",\n+    IFilterSchema="plone.base.interfaces.controlpanel:IFilterSchema",\n+    IImagingSchema="plone.base.interfaces.controlpanel:IImagingSchema",\n+    ILinkSchema="plone.base.interfaces.controlpanel:ILinkSchema",\n+    ILoginSchema="plone.base.interfaces.controlpanel:ILoginSchema",\n+    IMailSchema="plone.base.interfaces.controlpanel:IMailSchema",\n+    IMaintenanceSchema="plone.base.interfaces.controlpanel:IMaintenanceSchema",\n+    IMarkupSchema="plone.base.interfaces.controlpanel:IMarkupSchema",\n+    INavigationSchema="plone.base.interfaces.controlpanel:INavigationSchema",\n+    INewActionSchema="plone.base.interfaces.controlpanel:INewActionSchema",\n+    ISearchSchema="plone.base.interfaces.controlpanel:ISearchSchema",\n+    ISecuritySchema="plone.base.interfaces.controlpanel:ISecuritySchema",\n+    ISiteSchema="plone.base.interfaces.controlpanel:ISiteSchema",\n+    ISocialMediaSchema="plone.base.interfaces.controlpanel:ISocialMediaSchema",\n+    ITinyMCEAdvancedSchema="plone.base.interfaces.controlpanel:ITinyMCEAdvancedSchema",\n+    ITinyMCELayoutSchema="plone.base.interfaces.controlpanel:ITinyMCELayoutSchema",\n+    ITinyMCEPluginSchema="plone.base.interfaces.controlpanel:ITinyMCEPluginSchema",\n+    ITinyMCEResourceTypesSchema="plone.base.interfaces.controlpanel:ITinyMCEResourceTypesSchema",\n+    ITinyMCESchema="plone.base.interfaces.controlpanel:ITinyMCESchema",\n+    ITinyMCESpellCheckerSchema="plone.base.interfaces.controlpanel:ITinyMCESpellCheckerSchema",\n+    ITypesSchema="plone.base.interfaces.controlpanel:ITypesSchema",\n+    IUserGroupsSettingsSchema="plone.base.interfaces.controlpanel:IUserGroupsSettingsSchema",\n+    IConfigurationChangedEvent="plone.base.interfaces.events:IConfigurationChangedEvent",\n+    IReorderedEvent="plone.base.interfaces.events:IReorderedEvent",\n+    ISiteManagerCreatedEvent="plone.base.interfaces.events:ISiteManagerCreatedEvent",\n+    INonInstallable="plone.base.interfaces.installable:INonInstallable",\n+    IInterfaceTool="plone.base.interfaces.interface:IInterfaceTool",\n+    ILanguage="plone.base.interfaces.language:ILanguage",\n+    IForcePasswordChange="plone.base.interfaces.login:IForcePasswordChange",\n+    IInitialLogin="plone.base.interfaces.login:IInitialLogin",\n+    ILogin="plone.base.interfaces.login:ILogin",\n+    ILoginForm="plone.base.interfaces.login:ILoginForm",\n+    ILoginFormSchema="plone.base.interfaces.login:ILoginFormSchema",\n+    ILoginHelpForm="plone.base.interfaces.login:ILoginHelpForm",\n+    ILoginHelpFormSchema="plone.base.interfaces.login:ILoginHelpFormSchema",\n+    IRedirectAfterLogin="plone.base.interfaces.login:IRedirectAfterLogin",\n+    IMigrationTool="plone.base.interfaces.migration:IMigrationTool",\n+    IPasswordResetToolView="plone.base.interfaces.password_reset:IPasswordResetToolView",\n+    IPWResetTool="plone.base.interfaces.password_reset:IPWResetTool",\n+    IPatternsSettings="plone.base.interfaces.patterns:IPatternsSettings",\n+    IPropertiesTool="plone.base.interfaces.properties:IPropertiesTool",\n+    ISimpleItemWithProperties="plone.base.interfaces.properties:ISimpleItemWithProperties",\n+    IBundleRegistry="plone.base.interfaces.resources:IBundleRegistry",\n+    IResourceRegistry="plone.base.interfaces.resources:IResourceRegistry",\n+    IMigratingPloneSiteRoot="plone.base.interfaces.siteroot:IMigratingPloneSiteRoot",\n+    IPloneSiteRoot="plone.base.interfaces.siteroot:IPloneSiteRoot",\n+    ITestCasePloneSiteRoot="plone.base.interfaces.siteroot:ITestCasePloneSiteRoot",\n+    INonStructuralFolder="plone.base.interfaces.structure:INonStructuralFolder",\n+    ISiteSyndicationSettings="plone.base.interfaces.syndication:ISiteSyndicationSettings",\n+    ITranslationServiceTool="plone.base.interfaces.translationservice:ITranslationServiceTool",\n+    IWorkflowChain="plone.base.interfaces.workflow:IWorkflowChain",\n )\ndiff --git a/Products/CMFPlone/interfaces/atd.py b/Products/CMFPlone/interfaces/atd.py\nindex 50ea205ee3..f43019c7d8 100644\n--- a/Products/CMFPlone/interfaces/atd.py\n+++ b/Products/CMFPlone/interfaces/atd.py\n@@ -1,11 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class IATDProxyView(Interface):\n-    """ Proxy view for the \'After the Deadline" spellchecker\n-    """\n-\n-    def checkDocument(self):\n-        """ Proxy for the AtD service\'s checkDocument function\n-            See http://www.afterthedeadline.com/api.slp for more info.\n-        """\n+moved(\'plone.base.interfaces.atd\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/basetool.py b/Products/CMFPlone/interfaces/basetool.py\nindex cff9d2cdac..2ddb20e69b 100644\n--- a/Products/CMFPlone/interfaces/basetool.py\n+++ b/Products/CMFPlone/interfaces/basetool.py\n@@ -1,16 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class IPloneBaseTool(Interface):\n-    """Marker interface for plone tools\n-    """\n-\n-\n-class IPloneTool(Interface):\n-    """Marker interface for the plone utils tool.\n-    """\n-\n-\n-class IPloneCatalogTool(Interface):\n-    """Marker interface for Plone\'s catalog tool\n-    """\n+moved(\'plone.base.interfaces.basetool\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/breadcrumbs.py b/Products/CMFPlone/interfaces/breadcrumbs.py\nindex 005bca13ac..5be8cc296c 100644\n--- a/Products/CMFPlone/interfaces/breadcrumbs.py\n+++ b/Products/CMFPlone/interfaces/breadcrumbs.py\n@@ -1,6 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class IHideFromBreadcrumbs(Interface):\n-    """Marker for content which should not appear in the breadcrumbs.\n-    """\n+moved(\'plone.base.interfaces.breadcrumbs\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/constrains.py b/Products/CMFPlone/interfaces/constrains.py\nindex 3686052ae3..720eed0ec3 100644\n--- a/Products/CMFPlone/interfaces/constrains.py\n+++ b/Products/CMFPlone/interfaces/constrains.py\n@@ -1,87 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-ACQUIRE = -1  # acquire locallyAllowedTypes from parent (default)\n-DISABLED = 0  # use default behavior of PortalFolder,\n-# which uses the FTI information\n-ENABLED = 1  # allow types from locallyAllowedTypes only\n-\n-\n-class IConstrainTypes(Interface):\n-    """\n-    Interface for folderish content types supporting restricting addable types\n-    on a per-instance basis.\n-    """\n-\n-    def getConstrainTypesMode():\n-        """\n-        Find out if add-restrictions are enabled. Returns 0 if they are\n-        disabled (the type\'s default FTI-set allowable types is in effect),\n-        1 if they are enabled (only a selected subset if allowed types will be\n-        available), and -1 if the allowed types should be acquired from the\n-        parent. Note that in this case, if the parent portal type is not the\n-        same as the portal type of this object, fall back on the default (same\n-        as 0)\n-        """\n-\n-    def getLocallyAllowedTypes():\n-        """\n-        Get the list of FTI ids for the types which should be allowed to be\n-        added in this container.\n-        """\n-\n-    def getImmediatelyAddableTypes():\n-        """\n-        Return a subset of the FTI ids from getLocallyAllowedTypes() which\n-        should be made most easily available.\n-        """\n-\n-    def getDefaultAddableTypes():\n-        """\n-        Return a list of FTIs which correspond to the list of FTIs available\n-        when the constraint mode = 0 (that is, the types addable without any\n-        setLocallyAllowedTypes trickery involved)\n-        """\n-\n-    def allowedContentTypes():\n-        """\n-        Return the list of currently permitted FTIs.\n-        """\n-\n-\n-class ISelectableConstrainTypes(IConstrainTypes):\n-    """\n-    Extension to the IConstrainTypes interface for content types which allow\n-    the user to set the allowable content types and immediately available\n-    types.\n-    """\n-\n-    def setConstrainTypesMode(mode):\n-        """\n-        Set how addable types is controlled in this class. If mode is 0, use\n-        the type\'s default FTI-set allowable types). If mode is 1, use only\n-        those types explicitly enabled using setLocallyAllowedTypes(). If\n-        mode is -1, acquire the allowable types from the parent. If the parent\n-        portal type is not the same as this object\'s type, fall back on the\n-        behaviour obtained if mode == 0.\n-        """\n-\n-    def setLocallyAllowedTypes(types):\n-        """\n-        Set a list of type ids which should be allowed. This must be a\n-        subset of the type\'s FTI-set allowable types. This list only comes\n-        into effect when the restrictions mode is 1 (enabled).\n-        """\n-\n-    def setImmediatelyAddableTypes(types):\n-        """\n-        Set the list of type ids which should be immediately/most easily\n-        addable. This list must be a subset of any types set in\n-        setLocallyAllowedTypes.\n-        """\n-\n-    def canSetConstrainTypes():\n-        """\n-        Return True if the current user is permitted to constrain addable\n-        types in this folderish object.\n-        """\n+moved(\'plone.base.interfaces.constrains\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py\nindex 7e80bbfa8a..9731ce70f2 100644\n--- a/Products/CMFPlone/interfaces/controlpanel.py\n+++ b/Products/CMFPlone/interfaces/controlpanel.py\n@@ -1,1734 +1,3 @@\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone._compat import dump_json_to_text\n-from Products.CMFPlone.interfaces.basetool import IPloneBaseTool\n-from zope import schema\n-from zope.deferredimport import deprecated\n-from zope.component.hooks import getSite\n-from zope.interface import Attribute\n-from zope.interface import implementer\n-from zope.interface import Interface\n-from zope.interface import Invalid\n-from zope.interface import invariant\n-from zope.schema.vocabulary import SimpleTerm\n-from zope.schema.vocabulary import SimpleVocabulary\n+from zope.deprecation import moved\n \n-import json\n-\n-\n-deprecated(\n-    "It has been moved to plone.i18n.interfaces, import from there instead.",\n-    ILanguageSchema=\'plone.i18n.interfaces:ILanguageSchema\',\n-)\n-\n-\n-ROBOTS_TXT = """Sitemap: {portal_url}/sitemap.xml.gz\n-\n-# Define access-restrictions for robots/spiders\n-# http://www.robotstxt.org/wc/norobots.html\n-\n-\n-\n-# By default we allow robots to access all areas of our site\n-# already accessible to anonymous users\n-\n-User-agent: *\n-Disallow:\n-\n-\n-\n-# Add Googlebot-specific syntax extension to exclude forms\n-# that are repeated for each piece of content in the site\n-# the wildcard is only supported by Googlebot\n-# http://www.google.com/support/webmasters/bin/answer.py?answer=40367&ctx=sibling\n-\n-User-Agent: Googlebot\n-Disallow: /*?\n-Disallow: /*atct_album_view$\n-Disallow: /*folder_factories$\n-Disallow: /*folder_summary_view$\n-Disallow: /*login_form$\n-Disallow: /*mail_password_form$\n-Disallow: /@@search\n-Disallow: /*search_rss$\n-Disallow: /*sendto_form$\n-Disallow: /*summary_view$\n-Disallow: /*thumbnail_view$\n-Disallow: /*view$\n-"""\n-\n-\n-def validate_json(value):\n-    try:\n-        json.loads(value)\n-    except ValueError as exc:\n-        class JSONError(schema.ValidationError):\n-            __doc__ = _("Must be empty or a valid JSON-formatted "\n-                        "configuration \xe2\x80\x93 ${message}.", mapping={\n-                            \'message\': str(exc)})\n-\n-        raise JSONError(value)\n-\n-    return True\n-\n-\n-class IControlPanel(IPloneBaseTool):\n-    """ Interface for the ControlPanel """\n-\n-    def registerConfiglet(id, name, action, condition=\'\', permission=\'\',  # NOQA\n-                          category=\'Plone\', visible=1, appId=None,\n-                          imageUrl=None, description=\'\', REQUEST=None):\n-        """ Registration of a Configlet """\n-\n-    def unregisterConfiglet(id):  # NOQA\n-        """ unregister Configlet """\n-\n-    def unregisterApplication(appId):  # NOQA\n-        """ unregister Application with all configlets """\n-\n-    def getGroupIds():  # NOQA\n-        """ list of the group ids """\n-\n-    def getGroups():  # NOQA\n-        """ list of groups as dicts with id and title """\n-\n-    def enumConfiglets(group=None):  # NOQA\n-        """ lists the Configlets of a group, returns them as dicts by\n-            calling .getAction() on each of them """\n-\n-\n-class IEditingSchema(Interface):\n-\n-    available_editors = schema.List(\n-        title=_(\'Available editors\'),\n-        description=_(\'Available editors in the portal.\'),\n-        default=[\'TinyMCE\', \'None\'],\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        required=True\n-    )\n-\n-    default_editor = schema.Choice(\n-        title=_(\'Default editor\'),\n-        description=_(\n-            \'Select the default wysiwyg \'\n-            \'editor. Users will be able to choose their \'\n-            \'own or select to use the site default.\'),\n-        default=\'TinyMCE\',\n-        missing_value=set(),\n-        vocabulary=\'plone.app.vocabularies.AvailableEditors\',\n-        required=True)\n-\n-    ext_editor = schema.Bool(\n-        title=_(\'Enable External Editor feature\'),\n-        description=_(\n-            \'Determines if the external editor \'\n-            \'feature is enabled. This feature requires a \'\n-            \'special client-side application installed. The \'\n-            \'users also have to enable this in their \'\n-            \'preferences.\'),\n-        default=False,\n-        required=False)\n-\n-    enable_link_integrity_checks = schema.Bool(\n-        title=_(\'Enable link integrity checks\'),\n-        description=_(\n-            \'Determines if the users should get \'\n-            \'warnings when they delete or move content that \'\n-            \'is linked from inside the site.\'),\n-        default=True,\n-        required=False)\n-\n-    lock_on_ttw_edit = schema.Bool(\n-        title=_(\'Enable locking for through-the-web edits\'),\n-        description=_(\n-            \'Disabling locking here will only \'\n-            \'affect users editing content through the \'\n-            \'Plone web UI.  Content edited via WebDAV \'\n-            \'clients will still be subject to locking.\'),\n-        default=True,\n-        required=False)\n-\n-    subjects_of_navigation_root = schema.Bool(\n-        title=_(\'Limit tags/keywords to the current navigation root\'),\n-        description=_(\n-            \'Limit tags aka keywords vocabulary used for Tags field and \'\n-            \'in searches to the terms used inside the subtree of the current \'\n-            "navigation root. This can be used together with Plone\'s "\n-            \'multilingual extension plone.app.multilingual to only offer \'\n-            \'keywords of the current selected language. Other addons may \'\n-            \'utilize this feature for its specific purposes.\'),\n-        default=False,\n-        required=False)\n-\n-\n-class ITagAttrPair(Interface):\n-    tags = schema.TextLine(title=\'tags\')\n-    attributes = schema.TextLine(title=\'attributes\')\n-\n-\n-@implementer(ITagAttrPair)\n-class TagAttrPair:\n-\n-    def __init__(self, tags=\'\', attributes=\'\'):\n-        self.tags = tags\n-        self.attributes = attributes\n-\n-\n-class IFilterSchema(Interface):\n-    """Combined schema for the adapter lookup.\n-    """\n-\n-    # class IFilterTagsSchema(Interface):\n-\n-    disable_filtering = schema.Bool(\n-        title=_(\'Disable HTML filtering\'),\n-        description=_(\'Warning: disabling this can be dangerous. \'\n-                      \'Only disable if you know what you are doing.\'),\n-        default=False,\n-        required=False)\n-\n-    nasty_tags = schema.List(\n-        title=_(\'Nasty tags\'),\n-        description=_(\'These tags and their content are completely blocked \'\n-                      \'when a page is saved or rendered. They are only deleted\'\n-                      \' if they are not marked as valid_tags\'),\n-        default=[\'style\', \'object\', \'embed\', \'applet\', \'script\', \'meta\'],\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        required=False)\n-\n-    valid_tags = schema.List(\n-        title=_(\'Valid tags\'),\n-        description=_(\'A list of valid tags which will be not filtered out.\'),\n-        default=[\n-            \'a\',\n-            \'abbr\',\n-            \'acronym\',\n-            \'address\',\n-            \'article\',\n-            \'aside\',\n-            \'audio\',\n-            \'b\',\n-            \'bdo\',\n-            \'big\',\n-            \'blockquote\',\n-            \'body\',\n-            \'br\',\n-            \'canvas\',\n-            \'caption\',\n-            \'cite\',\n-            \'code\',\n-            \'col\',\n-            \'colgroup\',\n-            \'command\',\n-            \'datalist\',\n-            \'dd\',\n-            \'del\',\n-            \'details\',\n-            \'dfn\',\n-            \'dialog\',\n-            \'div\',\n-            \'dl\',\n-            \'dt\',\n-            \'em\',\n-            \'figure\',\n-            \'figcaption\',\n-            \'footer\',\n-            \'h1\',\n-            \'h2\',\n-            \'h3\',\n-            \'h4\',\n-            \'h5\',\n-            \'h6\',\n-            \'head\',\n-            \'header\',\n-            \'hgroup\',\n-            \'hr\',\n-            \'html\',\n-            \'i\',\n-            \'iframe\',\n-            \'img\',\n-            \'ins\',\n-            \'kbd\',\n-            \'keygen\',\n-            \'li\',\n-            \'map\',\n-            \'mark\',\n-            \'meter\',\n-            \'nav\',\n-            \'ol\',\n-            \'output\',\n-            \'p\',\n-            \'pre\',\n-            \'progress\',\n-            \'q\',\n-            \'rp\',\n-            \'rt\',\n-            \'ruby\',\n-            \'samp\',\n-            \'section\',\n-            \'small\',\n-            \'source\',\n-            \'span\',\n-            \'strong\',\n-            \'sub\',\n-            \'sup\',\n-            \'table\',\n-            \'tbody\',\n-            \'td\',\n-            \'tfoot\',\n-            \'th\',\n-            \'thead\',\n-            \'time\',\n-            \'title\',\n-            \'tr\',\n-            \'tt\',\n-            \'u\',\n-            \'ul\',\n-            \'var\',\n-            \'video\',\n-        ],\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        required=False)\n-\n-    custom_attributes = schema.List(\n-        title=_(\'Custom attributes\'),\n-        description=_(\'These attributes are additionally allowed.\'),\n-        default=[\'style\'],\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        required=False)\n-\n-\n-class ITinyMCELayoutSchema(Interface):\n-    """This interface defines the layout properties."""\n-\n-    resizing = schema.Bool(\n-        title=_(\'Enable resizing the editor window.\'),\n-        description=_(\'This option gives you the ability to enable/disable \'\n-                      \'resizing the editor window. \'),\n-        default=True,\n-        required=False)\n-\n-    autoresize = schema.Bool(\n-        title=_(\'Enable auto resizing of the editor window.\'),\n-        description=_(\'This option gives you the ability to enable/disable \'\n-                      \'auto resizing the editor window depending \'\n-                      \'on the content.\'),\n-        default=False,\n-        required=False)\n-\n-    # TODO: add validation to assert % and px in the value\n-    editor_width = schema.TextLine(\n-        title=_(\'Editor width\'),\n-        description=_(\'This option gives you the ability to specify the \'\n-                      \'width of the editor (like 100% or 400px).\'),\n-        default=None,\n-        required=False)\n-\n-    # TODO: add validation to assert % and px in the value\n-    editor_height = schema.TextLine(\n-        title=_(\'Editor height\'),\n-        description=_(\'This option gives you the ability to specify the \'\n-                      \'height of the editor in pixels. \'\n-                      \'If auto resize is enabled this value is used \'\n-                      \'as minimum height.\'),\n-        default=None,\n-        required=False)\n-\n-    content_css = schema.List(\n-        title=_(\'Choose the CSS used in WYSIWYG Editor Area\'),\n-        description=_(\'This option enables you to specify a custom CSS file \'\n-                      \'that provides content CSS. \'\n-                      \'This CSS file is the one used within the editor \'\n-                      \'(the editable area). In addition to what is listed, \'\n-                      \'here the plone bundle CSS and diazo themes using the \'\n-                      \'tinymce-content-css setting are also added.\'),\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[\n-            \'++plone++static/components/tinymce/\'\n-            \'skins/lightgray/content.min.css\'\n-        ],\n-        required=False)\n-\n-    header_styles = schema.List(\n-        title=_(\'Header styles\'),\n-        description=_(\'Name|tag\'),\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[\n-            \'Header 1|h1\',\n-            \'Header 2|h2\',\n-            \'Header 3|h3\',\n-            \'Header 4|h4\',\n-            \'Header 5|h5\',\n-            \'Header 6|h6\'\n-        ])\n-\n-    inline_styles = schema.List(\n-        title=_(\'Inline styles\'),\n-        description=_(\'Name|format|icon\'),\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[\n-            \'Bold|bold|bold\',\n-            \'Italic|italic|italic\',\n-            \'Underline|underline|underline\',\n-            \'Strikethrough|strikethrough|strikethrough\',\n-            \'Superscript|superscript|superscript\',\n-            \'Subscript|subscript|subscript\',\n-            \'Code|code|code\'])\n-\n-    block_styles = schema.List(\n-        title=_(\'Block styles\'),\n-        description=_(\'Name|format\'),\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[\n-            \'Paragraph|p\',\n-            \'Blockquote|blockquote\',\n-            \'Div|div\',\n-            \'Pre|pre\'])\n-\n-    alignment_styles = schema.List(\n-        title=_(\'Alignment styles\'),\n-        description=_(\'Name|format|icon\'),\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[\n-            \'Left|alignleft|alignleft\',\n-            \'Center|aligncenter|aligncenter\',\n-            \'Right|alignright|alignright\',\n-            \'Justify|alignjustify|alignjustify\'])\n-\n-    table_styles = schema.List(\n-        title=_(\'Table styles\'),\n-        description=_(\'Name|class\'),\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[\n-            \'Listing|listing\',\n-            \'Invisible Grid|invisible-grid\'\n-        ])\n-\n-    formats = schema.Text(\n-        title=_(\'Formats\'),\n-        description=_(\n-            \'Enter a JSON-formatted style format configuration. \'\n-            \'A format is for example the style that get applied when \'\n-            \'you press the bold button inside the editor. \'\n-            \'See https://www.tinymce.com/docs/configure/content-formatting/#formats\'),  # NOQA: E501\n-        constraint=validate_json,\n-        default=dump_json_to_text({\n-            \'discreet\': {\'inline\': \'span\', \'classes\': \'discreet\'},\n-            \'clearfix\': {\'block\': \'div\', \'classes\': \'clearfix\'}\n-        }),\n-        required=True,\n-    )\n-\n-\n-class ITinyMCEPluginSchema(Interface):\n-    """This interface defines the toolbar properties."""\n-\n-    plugins = schema.List(\n-        title=_(\'label_tinymce_plugins\', default=\'Editor plugins\'),\n-        description=_(\'help_tinymce_plugins\', default=(\n-            \'Select plugins to include with tinymce\')),\n-        value_type=schema.Choice(vocabulary=SimpleVocabulary([\n-            SimpleTerm(\'advlist\', \'advlist\', \'advlist\'),\n-            SimpleTerm(\'anchor\', \'anchor\', \'anchor\'),\n-            SimpleTerm(\'autosave\', \'autosave\', \'autosave\'),\n-            SimpleTerm(\'charmap\', \'charmap\', \'charmap\'),\n-            SimpleTerm(\'code\', \'code\', \'code\'),\n-            SimpleTerm(\'colorpicker\', \'colorpicker\', \'colorpicker\'),\n-            SimpleTerm(\'contextmenu\', \'contextmenu\', \'contextmenu\'),\n-            SimpleTerm(\'directionality\', \'directionality\', \'directionality\'),\n-            SimpleTerm(\'emoticons\', \'emoticons\', \'emoticons\'),\n-            SimpleTerm(\'fullpage\', \'fullpage\', \'fullpage\'),\n-            SimpleTerm(\'fullscreen\', \'fullscreen\', \'fullscreen\'),\n-            SimpleTerm(\'hr\', \'hr\', \'hr\'),\n-            SimpleTerm(\'insertdatetime\', \'insertdatetime\', \'insertdatetime\'),\n-            SimpleTerm(\'layer\', \'layer\', \'layer\'),\n-            SimpleTerm(\'lists\', \'lists\', \'lists\'),\n-            SimpleTerm(\'media\', \'media\', \'media\'),\n-            SimpleTerm(\'nonbreaking\', \'nonbreaking\', \'nonbreaking\'),\n-            SimpleTerm(\'noneditable\', \'noneditable\', \'noneditable\'),\n-            SimpleTerm(\'pagebreak\', \'pagebreak\', \'pagebreak\'),\n-            SimpleTerm(\'paste\', \'paste\', \'paste\'),\n-            SimpleTerm(\'preview\', \'preview\', \'preview\'),\n-            SimpleTerm(\'print\', \'print\', \'print\'),\n-            # XXX disable save button since it is not implemeneted\n-            # SimpleTerm(\'save\', \'save\', u\'save\'),\n-            SimpleTerm(\'searchreplace\', \'searchreplace\', \'searchreplace\'),\n-            SimpleTerm(\'tabfocus\', \'tabfocus\', \'tabfocus\'),\n-            SimpleTerm(\'table\', \'table\', \'table\'),\n-            SimpleTerm(\'textcolor\', \'textcolor\', \'textcolor\'),\n-            SimpleTerm(\'textpattern\', \'textpattern\', \'textpattern\'),\n-            SimpleTerm(\'visualblocks\', \'visualblocks\', \'visualblocks\'),\n-            SimpleTerm(\'visualchars\', \'visualchars\', \'visualchars\'),\n-            SimpleTerm(\'wordcount\', \'wordcount\', \'wordcount\')\n-        ])),\n-        default=[\'advlist\', \'fullscreen\', \'hr\', \'lists\', \'media\',\n-                 \'nonbreaking\', \'noneditable\', \'pagebreak\', \'paste\', \'preview\',\n-                 \'print\', \'searchreplace\', \'tabfocus\', \'table\',\n-                 \'visualchars\', \'wordcount\', \'code\'],\n-        missing_value=[],\n-        required=False)\n-\n-    menubar = schema.List(\n-        title=_(\'label_tinymce_menubar\', default=\'Menubar\'),\n-        description=_(\'help_tinymce_menubar\', default=(\n-            \'Enter what items you would like in the menu bar.\')),\n-        required=True,\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[\n-            \'edit\', \'table\', \'format\',\n-            \'tools\' \'view\', \'insert\'])\n-\n-    menu = schema.Text(\n-        title=_(\'label_tinymce_menu\', \'Menu\'),\n-        description=_(\'hint_tinymce_menu\',\n-                      default=\'JSON formatted Menu configuration.\'),\n-        constraint=validate_json,\n-        default=dump_json_to_text({\n-            \'edit\': {\n-                \'title\': \'Edit\',\n-                \'items\': \'undo redo | cut copy paste pastetext | \'\n-                         \'searchreplace textpattern selectall | textcolor\'},\n-            \'insert\': {\'title\': \'Insert\', \'items\': \'link media | template hr\'},\n-            \'view\': {\n-                \'title\': \'View\',\n-                \'items\': \'visualaid visualchars visualblocks preview \'\n-                         \'fullpage fullscreen\',\n-            },\n-            \'format\': {\n-                \'title\': \'Format\',\n-                \'items\': \'bold italic underline strikethrough \'\n-                         \'superscript subscript | formats | removeformat\'\n-            },\n-            \'table\': {\n-                \'title\': \'Table\',\n-                \'items\': \'inserttable tableprops deletetable | cell row column\'\n-            },\n-            \'tools\': {\n-                \'title\': \'Tools\',\n-                \'items\': \'spellchecker charmap emoticons insertdatetime \'\n-                         \'layer code\'\n-            }\n-        })\n-    )\n-\n-    templates = schema.Text(\n-        title=_(\'label_tinymce_templates\', default=\'Templates\'),\n-        description=_(\n-            \'help_tinymce_templates\',\n-            default=(\n-                \'Enter the list of templates in json format \'\n-                \'https://www.tinymce.com/docs/plugins/template/\'\n-            )\n-        ),\n-        required=False,\n-        constraint=validate_json,\n-        default=dump_json_to_text({}))\n-\n-    toolbar = schema.Text(\n-        title=_(\'label_tinymce_toolbar\', default=\'Toolbar\'),\n-        description=_(\'help_tinymce_toolbar\', default=(\n-            \'Enter how you would like the toolbar items to list.\')),\n-        required=True,\n-        default=\'ltr rtl | undo redo | styleselect | bold italic | \'\n-                \'alignleft aligncenter alignright alignjustify | \'\n-                \'bullist numlist outdent indent | \'\n-                \'unlink plonelink ploneimage\')\n-\n-    custom_plugins = schema.List(\n-        title=_(\'Custom plugins\'),\n-        description=_(\'Enter a list of custom plugins which will be loaded \'\n-                      \'in the editor. Format is \'\n-                      \'pluginname|location, one per line.\'),\n-        required=False,\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[])\n-\n-    custom_buttons = schema.List(\n-        title=_(\'Custom buttons\'),\n-        description=_(\n-            \'Enter a list of custom buttons which will be added to toolbar\'),\n-        required=False,\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        default=[])\n-\n-\n-ITinyMCELibrariesSchema = ITinyMCEPluginSchema  # bw compat\n-\n-\n-class ITinyMCESpellCheckerSchema(Interface):\n-    """This interface defines the libraries properties."""\n-\n-    libraries_spellchecker_choice = schema.Choice(\n-        title=_(\'Spellchecker plugin to use\'),\n-        description=_(\'This option allows you to choose the spellchecker for \'\n-                      \'TinyMCE.\'),\n-        missing_value=set(),\n-        vocabulary=SimpleVocabulary([\n-            SimpleTerm(\'browser\', \'browser\',\n-                       _(\'Default browser spellchecker\')),\n-            SimpleTerm(\'AtD\', \'AtD\',\n-                       _(\'After the deadline (FLOSS)\')),\n-        ]),\n-        default=\'browser\',\n-        required=False)\n-\n-    libraries_atd_ignore_strings = schema.List(\n-        title=_(\'AtD ignore strings\'),\n-        description=_(\n-            \'label_atd_ignore_strings\',\n-            default=\'A list of strings which the "After the Deadline" \'\n-                    \'spellchecker should ignore. \'\n-                    \'Note: This option is only applicable when the \'\n-                    \'appropriate spellchecker has been chosen above.\'),\n-        default=[\n-            \'Zope\',\n-            \'Plone\',\n-            \'TinyMCE\'],\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        required=False)\n-\n-    libraries_atd_show_types = schema.List(\n-        title=_(\'AtD error types to show\'),\n-        description=_(\n-            \'help_atderrortypes_to_show\',\n-            default=\'A list of error types which the \'\n-                    \'"After the Deadline" spellchecker should check for. \'\n-                    \'By default, all the available error type will be \'\n-                    \'listed here.\'),\n-        value_type=schema.TextLine(),\n-        default=[\n-            \'Bias Language\',\n-            \'Cliches\',\n-            \'Complex Expression\',\n-            \'Diacritical Marks\',\n-            \'Double Negatives\',\n-            \'Hidden Verbs\',\n-            \'Jargon Language\',\n-            \'Passive voice\',\n-            \'Phrases to Avoid\',\n-            \'Redundant Expression\'],\n-        missing_value=[],\n-        required=False)\n-\n-    libraries_atd_service_url = schema.TextLine(\n-        title=_(\'AtD service URL\'),\n-        description=_(\n-            \'help_atd_service_url\',\n-            default=\'The URL of the "After the Deadline" grammar and spell \'\n-                    \'checking server. \'\n-                    \'The default value is the public server, \'\n-                    \'but ideally you should download and install your own \'\n-                    \'and specify its address here.\'),\n-        required=True,\n-        default=\'service.afterthedeadline.com\',)\n-\n-\n-class ITinyMCEResourceTypesSchema(Interface):\n-    """This interface defines the resource types properties."""\n-\n-    # XXX Not implemented in new tinymce version. Need to decide about this\n-    # rooted = schema.Bool(\n-    #    title=_(u"Rooted to current object"),\n-    #    description=_(u"When enabled the user will be rooted to the current "\n-    #                  "object and can\'t add links and images from other "\n-    #                  "parts of the site."),\n-    #    default=False,\n-    #    required=False)\n-\n-    contains_objects = schema.List(\n-        title=_(\'Contains objects\'),\n-        description=_(\'Enter a list of content types which can contain other \'\n-                      \'objects. Format is one contenttype per line.\'),\n-        value_type=schema.TextLine(),\n-        default=[\n-            \'Folder\',\n-            \'Large Plone Folder\',\n-            \'Plone Site\'],\n-        missing_value=[],\n-        required=False)\n-\n-    image_objects = schema.List(\n-        title=_(\'Image objects\'),\n-        description=_(\'Enter a list of content types which can be used as \'\n-                      \'images. Format is one contenttype per line.\'),\n-        default=[\'Image\'],\n-        value_type=schema.TextLine(),\n-        missing_value=[],\n-        required=False)\n-\n-    entity_encoding = schema.Choice(\n-        title=_(\'Entity encoding\'),\n-        description=_(\n-            \'This option controls how entities/characters get processed. \'\n-            \'Named: Characters will be converted into named entities \'\n-            \'based on the entities option. \'\n-            \'Numeric: Characters will be converted into numeric entities. \'\n-            \'Raw: All characters will be stored in non-entity form \'\n-            \'except these XML default entities: amp lt gt quot\'),\n-        missing_value=set(),\n-        vocabulary=SimpleVocabulary(\n-            [SimpleTerm(\'named\', \'named\', _(\'Named\')),\n-             SimpleTerm(\'numeric\', \'numeric\', _(\'Numeric\')),\n-             SimpleTerm(\'raw\', \'raw\', _(\'Raw\'))]),\n-        default="raw",\n-        required=False)\n-\n-\n-class ITinyMCEAdvancedSchema(Interface):\n-    """This interface defines the resource types properties."""\n-\n-    other_settings = schema.Text(\n-        title=_(\'label_tinymce_other_settings\', \'Other settings\'),\n-        description=_(\n-            \'hint_tinymce_other_settings\',\n-            default=\'Other TinyMCE configuration formatted as JSON.\'\n-        ),\n-        required=False,\n-        constraint=validate_json,\n-        default=dump_json_to_text({}),\n-    )\n-\n-\n-class ITinyMCESchema(\n-    ITinyMCELayoutSchema,\n-    ITinyMCEPluginSchema,\n-    ITinyMCESpellCheckerSchema,\n-    ITinyMCEResourceTypesSchema,\n-    ITinyMCEAdvancedSchema\n-):\n-    """TinyMCE Schema"""\n-\n-\n-class IMaintenanceSchema(Interface):\n-\n-    days = schema.Int(\n-        title=_(\'Days of object history to keep after packing\'),\n-        description=_(\n-            \'You should pack your database regularly. This number \'\n-            \'indicates how many days of undo history you want to \'\n-            \'keep. It is unrelated to versioning, so even if you \'\n-            \'pack the database, the history of the content changes \'\n-            \'will be kept. Recommended value is 7 days.\'\n-        ),\n-        default=7,\n-        min=0,\n-        required=True\n-    )\n-\n-\n-class INavigationSchema(Interface):\n-\n-    navigation_depth = schema.Int(\n-        title=_(\'Navigation depth\'),\n-        description=_(\'Number of folder levels to show in the navigation.\'),\n-        default=3,\n-        required=True\n-    )\n-\n-    generate_tabs = schema.Bool(\n-        title=_(\'Automatically generate tabs\'),\n-        description=_(\n-            \'By default, all items created at the root level will \'\n-            \'appear as tabs. You can turn this off if you prefer manually \'\n-            \'constructing this part of the navigation.\'),\n-        default=True,\n-        required=False)\n-\n-    nonfolderish_tabs = schema.Bool(\n-        title=_(\'Generate tabs for items other than folders.\'),\n-        description=_(\n-            \'By default, any content item in the root of the portal will \'\n-            \'appear as a tab. If you turn this option off, only folders \'\n-            \'will be shown. This only has an effect if \\\'automatically \'\n-            \'generate tabs\\\' is enabled.\'),\n-        default=True,\n-        required=False)\n-\n-    sort_tabs_on = schema.Choice(\n-        title=_(\'Sort tabs on\'),\n-        description=_(\n-            \'Index used to sort the tabs\'\n-        ),\n-        required=True,\n-        default=\'getObjPositionInParent\',\n-        vocabulary=SimpleVocabulary([\n-            # there is no vocabulary of sortable indexes by now, so hard code\n-            # some options here\n-            SimpleTerm(\n-                \'getObjPositionInParent\',\n-                \'getObjPositionInParent\',\n-                _(\'Position in Parent\')\n-            ),\n-            SimpleTerm(\n-                \'sortable_title\',\n-                \'sortable_title\',\n-                _(\'Title\')\n-            ),\n-            SimpleTerm(\n-                \'getId\',\n-                \'getId\',\n-                _(\'Short Name (ID)\')\n-            ),\n-        ]),\n-    )\n-    sort_tabs_reversed = schema.Bool(\n-        title=_(\'Reversed sort order for tabs.\'),\n-        description=_(\n-            \'Sort tabs in descending.\'),\n-        default=False,\n-        required=False)\n-\n-    displayed_types = schema.Tuple(\n-        title=_(\'Displayed content types\'),\n-        description=_(\n-            \'The content types that should be shown in the navigation and \'\n-            \'site map.\'),\n-        required=False,\n-        default=(\n-            \'Image\',\n-            \'File\',\n-            \'Link\',\n-            \'News Item\',\n-            \'Folder\',\n-            \'Document\',\n-            \'Event\'\n-        ),\n-        missing_value=(),\n-        value_type=schema.Choice(\n-            source=\'plone.app.vocabularies.ReallyUserFriendlyTypes\'\n-        ))\n-\n-    filter_on_workflow = schema.Bool(\n-        title=_(\'Filter on workflow state\'),\n-        description=_(\n-            \'The workflow states that should be shown in the navigation \'\n-            \'and the site map.\'),\n-        default=False,\n-        required=False)\n-\n-    workflow_states_to_show = schema.Tuple(\n-        required=False,\n-        default=(),\n-        missing_value=(),\n-        value_type=schema.Choice(\n-            source=\'plone.app.vocabularies.WorkflowStates\'))\n-\n-    show_excluded_items = schema.Bool(\n-        title=_(\n-            \'Show items normally excluded from navigation if viewing their \'\n-            \'children.\'),\n-        description=_(\n-            \'If an item has been excluded from navigation should it be \'\n-            \'shown in navigation when viewing content contained within it \'\n-            \'or within a subfolder.\'),\n-        default=True,\n-        required=False)\n-\n-    root = schema.TextLine(\n-        title=_(\n-            \'Root\'),\n-        description=_(\n-            \'Path to be used as navigation root, relative to Plone site root.\'\n-            \'Starts with \\\'/\\\'\'\n-        ),\n-        default=\'/\',\n-        required=True\n-    )\n-\n-    sitemap_depth = schema.Int(\n-        title=_(\'Sitemap depth\'),\n-        description=_(\'Number of folder levels to show in the site map.\'),\n-        default=3,\n-        required=True\n-    )\n-\n-    parent_types_not_to_query = schema.List(\n-        title=_(\'Hide children of these types\'),\n-        description=_(\n-            \'Hide content inside the following types in Navigation.\'),\n-        default=[\'TempFolder\'],\n-        value_type=schema.TextLine(),\n-        missing_value=(),\n-        required=False,\n-    )\n-\n-\n-class ISearchSchema(Interface):\n-\n-    enable_livesearch = schema.Bool(\n-        title=_(\'Enable LiveSearch\'),\n-        description=_(\n-            \'Enables the LiveSearch feature, which shows live \'\n-            \'results if the browser supports JavaScript.\'),\n-        default=True,\n-        required=False\n-    )\n-\n-    types_not_searched = schema.Tuple(\n-        title=_(\'Define the types to be shown in the site and searched\'),\n-        description=_(\n-            \'Define the types that should be searched and be \'\n-            \'available in the user facing part of the site. \'\n-            \'Note that if new content types are installed, they \'\n-            \'will be enabled by default unless explicitly turned \'\n-            \'off here or by the relevant installer.\'\n-        ),\n-        required=False,\n-        default=(\n-            \'Discussion Item\',\n-            \'Plone Site\',\n-            \'TempFolder\',\n-        ),\n-        missing_value=(),\n-        value_type=schema.Choice(\n-            source=\'plone.app.vocabularies.PortalTypes\'\n-        ),\n-    )\n-\n-    search_results_description_length = schema.Int(\n-        title=_(\'Crop the item description in search result listings \'\n-                \'after a number of characters.\'),\n-        required=False,\n-        default=160,\n-    )\n-\n-    sort_on = schema.Choice(\n-        title=_(\'label_sort_on\', default=\'Sort on\'),\n-        description=_(\'Sort the default search on this index\'),\n-        vocabulary=SimpleVocabulary([\n-            SimpleTerm(\'relevance\', \'relevance\', _(\'relevance\')),\n-            SimpleTerm(\'Date\', \'Date\', _(\'date (newest first)\')),\n-            SimpleTerm(\'sortable_title\', \'sortable_title\',\n-                       _(\'alphabetically\'))]),\n-        default=\'relevance\',\n-        required=True\n-    )\n-\n-\n-class ISecuritySchema(Interface):\n-\n-    enable_self_reg = schema.Bool(\n-        title=_(\'Enable self-registration\'),\n-        description=_(\n-            \'Allows users to register themselves on the site. If \'\n-            \'not selected, only site managers can add new users.\'),\n-        default=False,\n-        required=False)\n-\n-    enable_user_pwd_choice = schema.Bool(\n-        title=_(\'Let users select their own passwords\'),\n-        description=_(\n-            \'If not selected, a URL will be generated and \'\n-            \'e-mailed. Users are instructed to follow the link to \'\n-            \'reach a page where they can change their password and \'\n-            \'complete the registration process; this also verifies \'\n-            \'that they have entered a valid email address.\'),\n-        default=False,\n-        required=False)\n-\n-    enable_user_folders = schema.Bool(\n-        title=_(\'Enable User Folders\'),\n-        description=_(\n-            \'If selected, home folders where users can create \'\n-            \'content will be created when they log in.\'),\n-        default=False,\n-        required=False)\n-\n-    allow_anon_views_about = schema.Bool(\n-        title=_(\'Allow anyone to view \\\'about\\\' information\'),\n-        description=_(\n-            \'If not selected only logged-in users will be able to \'\n-            \'view information about who created an item and when it \'\n-            \'was modified.\'),\n-        default=False,\n-        required=False)\n-\n-    use_email_as_login = schema.Bool(\n-        title=_(\'Use email address as login name\'),\n-        description=_(\n-            \'Allows users to login with their email address instead \'\n-            \'of specifying a separate login name. This also updates \'\n-            \'the login name of existing users, which may take a \'\n-            \'while on large sites. The login name is saved as \'\n-            \'lower case, but to be userfriendly it does not matter \'\n-            \'which case you use to login. When duplicates are found, \'\n-            \'saving this form will fail. You can use the \'\n-            \'@@migrate-to-emaillogin page to show the duplicates.\'),\n-        default=False,\n-        required=False)\n-\n-    use_uuid_as_userid = schema.Bool(\n-        title=_(\'Use UUID user ids\'),\n-        description=_(\n-            \'Use automatically generated UUIDs as user id for new users. \'\n-            \'When not turned on, the default is to use the same as the \'\n-            \'login name, or when using the email address as login name we \'\n-            \'generate a user id based on the fullname.\'),\n-        default=False,\n-        required=False)\n-\n-    autologin_after_password_reset = schema.Bool(\n-        title=_(\'Login user after password reset\'),\n-        description=_(\n-            \'After successful password reset the user will be logged \'\n-            \'in automatically.\'),\n-        default=True,\n-        required=False)\n-\n-\n-class ISiteSchema(Interface):\n-\n-    site_title = schema.TextLine(\n-        title=_(\'Site title\'),\n-        description=_(\n-            \'This shows up in the title bar of \'\n-            \'browsers and in syndication feeds.\'),\n-        default=\'Plone site\')\n-\n-    site_logo = schema.Bytes(\n-        title=_(\'Site Logo\'),\n-        description=_(\'This shows a custom logo on your site.\'),\n-        required=False,\n-    )\n-\n-    exposeDCMetaTags = schema.Bool(\n-        title=_(\'Expose Dublin Core metadata\'),\n-        description=_(\'Exposes the Dublin Core properties as metatags.\'),\n-        default=False,\n-        required=False)\n-\n-    enable_sitemap = schema.Bool(\n-        title=_(\'Expose sitemap.xml.gz\'),\n-        description=_(\n-            \'Exposes your content as a file \'\n-            \'according to the \'\n-            \'<a href=\\\'http://sitemaps.org\\\'>sitemaps.org</a> \'\n-            \'standard. You \'\n-            \'can submit this to compliant search engines \'\n-            \'like Google, Yahoo and Microsoft. It allows \'\n-            \'these search engines to more intelligently \'\n-            \'crawl your site.\'),\n-        default=False,\n-        required=False)\n-\n-    webstats_js = schema.SourceText(\n-        title=_(\'JavaScript for web statistics support\'),\n-        description=_(\n-            \'For enabling web statistics support \'\n-            \'from external providers (e.g. Google \'\n-            \'Analytics). Paste the provided code snippet here. \'\n-            \'It will be rendered as \'\n-            \'entered near the end of the page.\'),\n-        default=\'\',\n-        required=False)\n-\n-    display_publication_date_in_byline = schema.Bool(\n-        title=_(\'Display publication date\'),\n-        description=_(\n-            \'Show in the byline the date a content item was published.\'),\n-        default=False,\n-        required=False)\n-\n-    icon_visibility = schema.Choice(\n-        title=_(\'Icon visibility\'),\n-        description=_(\'Show icons in listings\'),\n-        default=\'enabled\',\n-        vocabulary=SimpleVocabulary([\n-            SimpleTerm(\'false\', \'false\', _(\'Never\')),\n-            SimpleTerm(\'enabled\', \'enabled\', _(\'Always\')),\n-            SimpleTerm(\'authenticated\', \'authenticated\',\n-                       _(\'For authenticated users only\'))]),\n-        required=True)\n-\n-    thumb_visibility = schema.Choice(\n-        title=_(\'Thumb visibility\'),\n-        description=_(\'Show thumbnail images in listings\'),\n-        default=\'enabled\',\n-        vocabulary=SimpleVocabulary([\n-            SimpleTerm(\'false\', \'false\', _(\'Never\')),\n-            SimpleTerm(\'enabled\', \'enabled\', _(\'Always\')),\n-            SimpleTerm(\'authenticated\', \'authenticated\',\n-                       _(\'For authenticated users only\'))]),\n-        required=True)\n-\n-    no_thumbs_portlet = schema.Bool(\n-        title=_(\'No Thumbs in portlets\'),\n-        description=_(\n-            \'Suppress thumbs in all portlets;\'\n-            \' this default can be overridden individually \'\n-            \'in selected portlets\'),\n-        default=False,\n-        required=False)\n-\n-    no_thumbs_lists = schema.Bool(\n-        title=_(\'No thumbs in list views\'),\n-        description=_(\'Suppress thumbs in all list views; \'\n-                      \'this default can be overriden individually\'),\n-        default=False,\n-        required=False)\n-\n-    no_thumbs_summary = schema.Bool(\n-        title=_(\'No thumbs in summary views\'),\n-        description=_(\'Suppress thumbs in all summary views; \'\n-                      \'this default can be overriden individually\'),\n-        default=False,\n-        required=False)\n-\n-    no_thumbs_tables = schema.Bool(\n-        title=_(\'No thumbs in table views\'), description=_(\n-            \'Suppress thumbs in all tableviews and in folder contents view; \'\n-            \'this default can be overriden individually\'),\n-        default=False,\n-        required=False)\n-\n-    thumb_scale_portlet = schema.Choice(\n-        title=_(\'Thumb scale for portlets\'),\n-        description=_(\'This default can be overriden individually.\'),\n-        default=\'icon\',\n-        vocabulary=\'plone.app.vocabularies.ImagesScales\',\n-        required=True)\n-\n-    thumb_scale_listing = schema.Choice(\n-        title=_(\'Thumb scale for listings\'),\n-        description=_(\'E.g. standard view;\'\n-                      \' This default can be overriden individually.\'),\n-        default=\'thumb\',\n-        vocabulary=\'plone.app.vocabularies.ImagesScales\',\n-        required=True)\n-\n-    thumb_scale_table = schema.Choice(\n-        title=_(\'Thumb scale for tables\'),\n-        description=_(\'E.g., tabular view, folder content listing;\'\n-                      \' This default can be overriden individually.\'),\n-        default=\'tile\',\n-        vocabulary=\'plone.app.vocabularies.ImagesScales\',\n-        required=True)\n-\n-    thumb_scale_summary = schema.Choice(\n-        title=_(\'Thumb scale for summary view\'),\n-        description=_(\'This default can be overriden individually.\'),\n-        default=\'mini\',\n-        vocabulary=\'plone.app.vocabularies.ImagesScales\',\n-        required=True)\n-\n-    toolbar_position = schema.Choice(\n-        title=_(\'Toolbar position\'),\n-        description=_(\n-            \'It can be on the side (vertical mode) \'\n-            \'or on the top (horizontal mode)\'),\n-        default=\'side\',\n-        vocabulary=SimpleVocabulary([\n-            SimpleTerm(\'side\', \'side\', _(\'Side\')),\n-            SimpleTerm(\'top\', \'top\', _(\'Top\'))]),\n-        required=True)\n-\n-    toolbar_logo = schema.TextLine(\n-        title=_(\'Relative URL for the toolbar logo\'),\n-        description=_(\n-            \'This must be a URL relative to the site root. \'\n-            \'By default it is /++plone++static/plone-toolbarlogo.svg\'),\n-        default=\'/++plone++static/plone-toolbarlogo.svg\',\n-        required=False,\n-    )\n-\n-    robots_txt = schema.SourceText(\n-        title=_(\'robots.txt\'),\n-        description=_(\n-            \'help_robots_txt\',\n-            default=\'robots.txt is read by search engines to \'\n-                    \'determine how to index your site. \'\n-                    \'For details see <a href=\\\'http://www.robotstxt.org\\\'>\'\n-                    \'http://www.robotstxt.org</a>. \'\n-                    \'Use \\\'{portal_url}\\\' for the site URL.\'),\n-        default=ROBOTS_TXT,\n-        required=False,\n-    )\n-\n-    default_page = schema.List(\n-        title=_(\'Default page IDs\'),\n-        description=_(\n-            \'Select which IDs (short names) can act as fallback \'\n-            \'default pages for a container.\'),\n-        required=False,\n-        default=[\n-            \'index_html\',\n-            \'index.html\',\n-            \'index.htm\',\n-            \'FrontPage\'],\n-        missing_value=[],\n-        value_type=schema.TextLine())\n-\n-    roles_allowed_to_add_keywords = schema.List(\n-        title=_(\'Roles that can add keywords\'),\n-        description=_(\n-            \'help_allow_roles_to_add_keywords\',\n-            default=\'Only the following roles can add new keywords \'),\n-        required=False,\n-        default=[\n-            \'Manager\',\n-            \'Site Administrator\',\n-            \'Reviewer\',\n-        ],\n-        missing_value=[],\n-        value_type=schema.Choice(vocabulary=\'plone.app.vocabularies.Roles\'),\n-    )\n-\n-\n-class IDateAndTimeSchema(Interface):\n-    """Controlpanel settings for date and time related settings.\n-    """\n-\n-    portal_timezone = schema.Choice(\n-        title=_(\'Portal default timezone\'),\n-        description=_(\n-            \'help_portal_timezone\',\n-            default=\'The timezone setting of the portal. Users can set \'\n-                    \'their own timezone, if available timezones are \'\n-                    \'defined.\'),\n-        required=True,\n-        default=None,\n-        vocabulary=\'plone.app.vocabularies.CommonTimezones\')\n-\n-    available_timezones = schema.List(\n-        title=_(\'Available timezones\'),\n-        description=_(\n-            \'help_available_timezones\',\n-            default=\'The timezones, which should be available for the \'\n-                    \'portal. Can be set for users and events\'),\n-        required=False,\n-        default=[],\n-        missing_value=[],\n-        value_type=schema.Choice(\n-            vocabulary=\'plone.app.vocabularies.Timezones\'))\n-\n-    first_weekday = schema.Choice(\n-        title=_(\'label_first_weekday\', default=\'First weekday\'),\n-        description=_(\n-            \'help_first_weekday\',\n-            default=\'First day in the week.\'),\n-        required=True,\n-        default=None,\n-        vocabulary=\'plone.app.vocabularies.Weekdays\')\n-\n-\n-class ITypesSchema(Interface):\n-    """Controlpanel settings for the types settings.\n-    """\n-\n-    types_use_view_action_in_listings = schema.List(\n-        title=_(\'Types which use the view action in listing views.\'),\n-        description=_(\n-            \'help_types_use_view_action_in_listings\',\n-            default=\'When clicking items in listing views, these \'\n-                    \'types will use the \\\'view\\\' action instead of using \'\n-                    \'their default view.\'),\n-        required=False,\n-        default=[\'Image\',\n-                 \'File\'],\n-        missing_value=[],\n-        value_type=schema.TextLine(),\n-    )\n-\n-    redirect_links = schema.Bool(\n-        title=_(\'Redirect links\'),\n-        description=_(\n-            \'help_redirect_links\',\n-            default=\'When clicking on a Link type, should the user be \'\n-                    \'taken to the default view or be redirected to the \'\n-                    \'Link\\\'s URL?\'),\n-        required=False,\n-        default=True\n-    )\n-\n-    default_page_types = schema.List(\n-        title=_(\'Types that can be set as a default page\'),\n-        description=_(\n-            \'The content types that should be available for selection \'\n-            \'when setting a default page.\'),\n-        required=False,\n-        missing_value=[],\n-        default=[\n-            \'Document\',\n-            \'Event\',\n-            \'News Item\',\n-            \'Collection\',\n-        ],\n-        value_type=schema.TextLine()\n-    )\n-\n-\n-class IMailSchema(Interface):\n-\n-    smtp_host = schema.TextLine(\n-        title=_(\n-            \'label_smtp_server\',\n-            default=\'SMTP server\'),\n-        description=_(\n-            \'help_smtp_server\',\n-            default=\'The address of your local \'\n-                    \'SMTP (outgoing e-mail) server. Usually \'\n-                    \'\\\'localhost\\\', unless you use an \'\n-                    \'external server to send e-mail.\'),\n-        default=\'localhost\',\n-        required=True)\n-\n-    smtp_port = schema.Int(\n-        title=_(\'label_smtp_port\',\n-                default=\'SMTP port\'),\n-        description=_(\n-            \'help_smtp_port\',\n-            default=\'The port of your local SMTP \'\n-                    \'(outgoing e-mail) server. Usually \\\'25\\\'.\'\n-        ),\n-        default=25,\n-        required=True)\n-\n-    smtp_userid = schema.TextLine(\n-        title=_(\n-            \'label_smtp_userid\',\n-            default=\'ESMTP username\'),\n-        description=_(\n-            \'help_smtp_userid\',\n-            default=\'Username for authentication \'\n-                    \'to your e-mail server. Not required \'\n-                    \'unless you are using ESMTP.\'),\n-        default=None,\n-        required=False)\n-\n-    smtp_pass = schema.Password(\n-        title=_(\n-            \'label_smtp_pass\',\n-            default=\'ESMTP password\'),\n-        description=_(\n-            \'help_smtp_pass\',\n-            default=\'The password for the ESMTP \'\n-                    \'user account.\'),\n-        default=None,\n-        required=False)\n-\n-    email_from_name = schema.TextLine(\n-        title=_(\'Site \\\'From\\\' name\'),\n-        description=_(\n-            \'Plone generates e-mail using \'\n-            \'this name as the e-mail \'\n-            \'sender.\'),\n-        default=None,\n-        required=True)\n-\n-    email_from_address = schema.ASCIILine(\n-        title=_(\'Site \\\'From\\\' address\'),\n-        description=_(\n-            \'Plone generates e-mail using \'\n-            \'this address as the e-mail \'\n-            \'return address. It is also \'\n-            \'used as the destination \'\n-            \'address for the site-wide \'\n-            \'contact form and the \\\'Send test \'\n-            \'e-mail\\\' feature.\'),\n-        default=None,\n-        required=True)\n-\n-    email_charset = schema.ASCIILine(\n-        title=_(\'E-mail characterset\'),\n-        description=_(\'Characterset to use when sending e-mails.\'),\n-        default=\'utf-8\',\n-        required=True,\n-    )\n-\n-\n-class IMarkupSchema(Interface):\n-\n-    default_type = schema.Choice(\n-        title=_(\'Default format\'),\n-        description=_(\n-            \'Select the default format of textfields for newly \'\n-            \'created content objects.\'\n-        ),\n-        default=\'text/html\',\n-        vocabulary=\'plone.app.vocabularies.AllowableContentTypes\',\n-        required=True\n-    )\n-\n-    allowed_types = schema.Tuple(\n-        title=_(\'Alternative formats\'),\n-        description=_(\n-            \'Select which formats are available for users as \'\n-            \'alternative to the default format. Note that if new \'\n-            \'formats are installed, they will be enabled for text \'\n-            \'fields by default unless explicitly turned off here \'\n-            \'or by the relevant installer.\'\n-        ),\n-        required=True,\n-        default=(\'text/html\', \'text/x-web-textile\'),\n-        missing_value=(),\n-        value_type=schema.Choice(\n-            vocabulary=\'plone.app.vocabularies.AllowableContentTypes\'\n-        )\n-    )\n-\n-    markdown_extensions = schema.List(\n-        default=[\n-            \'markdown.extensions.fenced_code\',\n-            \'markdown.extensions.nl2br\',\n-        ],\n-        description=_(\n-            \'Look for available extensions at \'\n-            \'https://python-markdown.github.io/extensions/ or write your own.\'\n-        ),\n-        missing_value=(),\n-        required=False,\n-        title=_(\'Enabled markdown extensions\'),\n-        value_type=schema.TextLine()\n-    )\n-\n-\n-class IUserGroupsSettingsSchema(Interface):\n-\n-    many_groups = schema.Bool(\n-        title=_(\'Many groups?\'),\n-        description=_(\n-            \'Determines if your Plone is optimized \'\n-            \'for small or large sites. In environments with a \'\n-            \'lot of groups it can be very slow or impossible \'\n-            \'to build a list all groups. This option tunes the \'\n-            \'user interface and behaviour of Plone for this \'\n-            \'case by allowing you to search for groups instead \'\n-            \'of listing all of them.\'),\n-        default=False\n-    )\n-\n-    many_users = schema.Bool(\n-        title=_(\'Many users?\'),\n-        description=_(\n-            \'Determines if your Plone is optimized \'\n-            \'for small or large sites. In environments with a \'\n-            \'lot of users it can be very slow or impossible to \'\n-            \'build a list all users. This option tunes the user \'\n-            \'interface and behaviour of Plone for this case by \'\n-            \'allowing you to search for users instead of \'\n-            \'listing all of them.\'),\n-        default=False\n-    )\n-\n-\n-def validate_twitter_username(value):\n-    if value and value.startswith(\'@\'):\n-        raise Invalid(\n-            \'Twitter username should not include the "@" prefix character.\')\n-    return True\n-\n-\n-class ISocialMediaSchema(Interface):\n-\n-    share_social_data = schema.Bool(\n-        title=_(\'Share social data\'),\n-        description=_(\'Include meta tags on pages to give hints to \'\n-                      \'social media on how to better render your pages \'\n-                      \'when shared\'),\n-        default=True)\n-\n-    twitter_username = schema.ASCIILine(\n-        title=_(\'Twitter username\'),\n-        description=_(\n-            \'To identify things like Twitter Cards. \'\n-            \'Do not include the "@" prefix character.\'\n-        ),\n-        required=False,\n-        default=\'\',\n-        constraint=validate_twitter_username,\n-    )\n-\n-    facebook_app_id = schema.ASCIILine(\n-        title=_(\'Facebook App ID\'),\n-        description=_(\n-            \'To be used with some integrations like Open Graph data\'),\n-        required=False,\n-        default=\'\')\n-\n-    facebook_username = schema.ASCIILine(\n-        title=_(\'Facebook username\'),\n-        description=_(\'For linking Open Graph data to a Facebook account\'),\n-        required=False,\n-        default=\'\')\n-\n-\n-class IImagingSchema(Interface):\n-    allowed_sizes = schema.List(\n-        title=_(\'Allowed image sizes\'),\n-        description=_(\n-            \'Specify all allowed maximum image dimensions, one per line. The \'\n-            \'required format is &lt;name&gt; &lt;width&gt;:&lt;height&gt;.\'\n-        ),\n-        value_type=schema.TextLine(),\n-        default=[\n-            \'large 768:768\',\n-            \'preview 400:400\',\n-            \'mini 200:200\',\n-            \'thumb 128:128\',\n-            \'tile 64:64\',\n-            \'icon 32:32\',\n-            \'listing 16:16\'],\n-        missing_value=[],\n-        required=False,\n-    )\n-\n-    quality = schema.Int(\n-        title=_(\'Scaled image quality\'),\n-        description=_(\'A value for the quality of scaled images, from 1 \'\n-                      \'(lowest) to 95 (highest). A value of 0 will mean \'\n-                      \'plone.scaling\\\'s default will be used, which is \'\n-                      \'currently 88.\'),\n-        min=0,\n-        max=95,\n-        default=88\n-    )\n-\n-    highpixeldensity_scales = schema.Choice(\n-        title=_(\'High pixel density mode\'),\n-        description=_(\'\'),\n-        default=\'disabled\',\n-        vocabulary=SimpleVocabulary([\n-            SimpleTerm(\'disabled\', \'disabled\', \'Disabled\'),\n-            SimpleTerm(\'2x\', \'2x\', \'Enabled (2x)\'),\n-            SimpleTerm(\'3x\', \'3x\', \'Enabled (2x, 3x)\')\n-        ]),\n-    )\n-\n-    quality_2x = schema.Int(\n-        title=_(\'Image quality at 2x\'),\n-        description=_(\'A value for the quality of 2x high pixel density images, from 1 \'\n-                      \'(lowest) to 95 (highest). A value of 0 will mean \'\n-                      \'plone.scaling\\\'s default will be used, which is \'\n-                      \'currently 62.\'),\n-        min=0,\n-        max=95,\n-        default=62,\n-    )\n-\n-    quality_3x = schema.Int(\n-        title=_(\'Image quality at 3x\'),\n-        description=_(\'A value for the quality of 3x high pixel density images, from 1 \'\n-                      \'(lowest) to 95 (highest). A value of 0 will mean \'\n-                      \'plone.scaling\\\'s default will be used, which is \'\n-                      \'currently 51.\'),\n-        min=0,\n-        max=95,\n-        default=51,\n-    )\n-\n-    image_captioning = schema.Bool(\n-        title=_(\'image_captioning_title\', \'Enable image captioning\'),\n-        description=_(\n-            \'image_captioning_description\',\n-            \'Enable automatic image captioning for images set in the richtext editor based on the description of images.\'\n-        ),\n-        default=True,\n-        required=False\n-    )\n-\n-\n-class ILoginSchema(Interface):\n-\n-    auth_cookie_length = schema.Int(\n-        title=_(\'Auth cookie length\'),\n-        default=0,\n-        required=False\n-    )\n-\n-    verify_login_name = schema.Bool(\n-        title=_(\'Verify login name\'),\n-        default=True,\n-        required=False\n-    )\n-\n-    allow_external_login_sites = schema.Tuple(\n-        title=_(\'Allow external login sites\'),\n-        default=(),\n-        value_type=schema.ASCIILine(),\n-        required=False\n-    )\n-\n-    external_login_url = schema.ASCIILine(\n-        title=_(\'External login url\'),\n-        default=None,\n-        required=False\n-    )\n-\n-    external_logout_url = schema.ASCIILine(\n-        title=_(\'External logout url\'),\n-        default=None,\n-        required=False\n-    )\n-\n-    external_login_iframe = schema.Bool(\n-        title=_(\'External login iframe\'),\n-        default=False,\n-        required=False\n-    )\n-\n-\n-class ILinkSchema(Interface):\n-\n-    external_links_open_new_window = schema.Bool(\n-        title=_(\'Open external links in new a window\'),\n-        description=_(\'\'),\n-        default=False,\n-        required=False)\n-\n-    mark_special_links = schema.Bool(\n-        title=_(\'Mark special links\'),\n-        description=_(\'Marks external or special protocol links with class.\'),\n-        default=False,\n-        required=False)\n-\n-\n-def _check_tales_expression(value):\n-    from Products.PageTemplates.Expressions import getEngine\n-    try:\n-        getEngine().compile(value)\n-    except Exception:\n-        raise Invalid(\n-            _(\n-                \'The expression "${value}" is invalid\',\n-                mapping={\'value\': value},\n-            )\n-        )\n-    return True\n-\n-\n-class IActionSchema(Interface):\n-\n-    category = schema.Choice(\n-        title=_(\'Category\'),\n-        vocabulary=\'plone.app.vocabularies.PortalActionCategories\',\n-        required=True)\n-\n-    title = schema.TextLine(\n-        title=_(\'Title\'),\n-        required=True)\n-\n-    description = schema.Text(\n-        title=_(\'Description\'),\n-        required=False)\n-\n-    i18n_domain = schema.TextLine(\n-        title=_(\'i18n_domain_heading\', default=\'I18n domain\'),\n-        default=\'plone\',\n-        required=False)\n-\n-    url_expr = schema.ASCIILine(\n-        title=_(\'action_url_heading\', default=\'Action URL\'),\n-        description=_(\n-            \'action_url_description\',\n-            default=\'An expression producing the called URL. \'\n-            \'Example: string:${globals_view/navigationRootUrl}/page\'\n-        ),\n-        required=True,\n-        constraint=_check_tales_expression,\n-    )\n-\n-    available_expr = schema.ASCIILine(\n-        title=_(\'action_condition_heading\', default=\'Condition\'),\n-        description=_(\n-            \'action_condition_description\',\n-            default=\'A boolean expression\'\n-        ),\n-        required=False)\n-\n-    permissions = schema.List(\n-        title=_(\'action_permissions_heading\', default=\'Permissions\'),\n-        required=True,\n-        default=[\'View\'],\n-        missing_value=[],\n-        value_type=schema.Choice(\n-            vocabulary=\'plone.app.vocabularies.Permissions\'\n-        )\n-    )\n-\n-    visible = schema.Bool(\n-        title=_(\'action_visibility_heading\', default=\'Visible?\'),\n-        default=True,\n-        required=False)\n-\n-    position = schema.Int(\n-        title=_(\'action_position_heading\', default=\'Position\'),\n-        default=1,\n-        min=1,\n-        required=True)\n-\n-\n-class INewActionSchema(Interface):\n-\n-    category = schema.Choice(\n-        title=_(\'Category\'),\n-        vocabulary=\'plone.app.vocabularies.PortalActionCategories\',\n-        required=True)\n-\n-    id = schema.ASCIILine(\n-        title=_(\'Id\'),\n-        required=True)\n-\n-    @invariant\n-    def validate_category_id(data):\n-        categoryid = data.category\n-        pa = getToolByName(getSite(), \'portal_actions\')\n-        category = pa.get(categoryid, {})\n-        actionid = data.id\n-        if actionid in category:\n-            raise Invalid(\n-                _(\n-                    \'An action with the id "${actionid}" already exists\',\n-                    mapping={\'actionid\': actionid},\n-                )\n-            )\n-        try:\n-            category._checkId(actionid)\n-        except Exception:\n-            raise Invalid(\n-                _(\n-                    \'The id "${actionid}" is invalid\',\n-                    mapping={\'actionid\': actionid},\n-                )\n-            )\n-\n-\n-class IPloneControlPanelView(Interface):\n-    """A marker interface for views showing a controlpanel.\n-    """\n-\n-\n-class IPloneControlPanelForm(IPloneControlPanelView):\n-    """Forms using plone.app.controlpanel\n-    """\n-\n-    def _on_save():\n-        """Callback mehod which can be implemented by control panels to\n-        react when the form is successfully saved. This avoids the need\n-        to re-define actions only to do some additional notification or\n-        configuration which cannot be handled by the normal schema adapter.\n-\n-        By default, does nothing.\n-        """\n-\n-\n-class IConfigurationChangedEvent(Interface):\n-    """An event which is fired after a configuration setting has been changed.\n-    """\n-\n-    context = Attribute("The configuration context which was changed.")\n-\n-    data = Attribute("The configuration data which was changed.")\n+moved(\'plone.base.interfaces.controlpanel\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/defaultpage.py b/Products/CMFPlone/interfaces/defaultpage.py\nindex 8b869b1cdd..4b9a4c610b 100644\n--- a/Products/CMFPlone/interfaces/defaultpage.py\n+++ b/Products/CMFPlone/interfaces/defaultpage.py\n@@ -1,16 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class IDefaultPage(Interface):\n-    """Interface for a view that can determine if its context is the\n-    default page or not.\n-    """\n-\n-    def isDefaultPage(obj):\n-        """Finds out if the given obj is the default page for the\n-        adapted object.\n-        """\n-\n-    def getDefaultPage():\n-        """Returns the id of the default page for the adapted object.\n-        """\n+moved(\'plone.base.interfaces.defaultpage\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/events.py b/Products/CMFPlone/interfaces/events.py\nindex f83cc0430d..57f9fb71b6 100644\n--- a/Products/CMFPlone/interfaces/events.py\n+++ b/Products/CMFPlone/interfaces/events.py\n@@ -1,23 +1,3 @@\n-from zope.interface import Attribute\n-from zope.interface import Interface\n-from zope.interface.interfaces import IObjectEvent\n+from zope.deprecation import moved\n \n-\n-class ISiteManagerCreatedEvent(IObjectEvent):\n-    """An event that\'s fired once the Plone portal is enabled as a site.\n-    """\n-\n-\n-class IReorderedEvent(IObjectEvent):\n-    """An event that\'s fired once the Plone Tool has been notified of\n-       a reordering\n-    """\n-\n-\n-class IConfigurationChangedEvent(Interface):\n-    """An event which is fired after a configuration setting has been changed.\n-    """\n-\n-    context = Attribute("The configuration context which was changed.")\n-\n-    data = Attribute("The configuration data which was changed.")\n+moved(\'plone.base.interfaces.events\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/installable.py b/Products/CMFPlone/interfaces/installable.py\nindex f82e9ef240..79006705e0 100644\n--- a/Products/CMFPlone/interfaces/installable.py\n+++ b/Products/CMFPlone/interfaces/installable.py\n@@ -1,17 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class INonInstallable(Interface):\n-\n-    def getNonInstallableProfiles():\n-        """Returns a list of profiles that should not be available for\n-           installation at portal creation time.\n-\n-           The usual use-case is to prevent extension profiles from showing up,\n-           that will be installed as part of the site creation anyways.\n-        """\n-\n-    def getNonInstallableProducts():\n-        """Returns a list of products that should not be available for\n-           installation.\n-        """\n+moved(\'plone.base.interfaces.installable\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/interface.py b/Products/CMFPlone/interfaces/interface.py\nindex 589430c96b..1d12e69c6c 100644\n--- a/Products/CMFPlone/interfaces/interface.py\n+++ b/Products/CMFPlone/interfaces/interface.py\n@@ -1,20 +1,3 @@\n-from Products.CMFPlone.interfaces.basetool import IPloneBaseTool\n-from zope.interface import Attribute\n+from zope.deprecation import moved\n \n-\n-class IInterfaceTool(IPloneBaseTool):\n-    """ This tool exposes the interface package for TTW applications,\n-    by accepting a dotted name of an interface and exporting the\n-    IInterface API """\n-\n-    id = Attribute(\'id\', \'Must be set to "portal_interface"\')\n-\n-    def objectImplements(obj, dotted_name):\n-        """ Asserts if an object implements a given interface """\n-\n-    def classImplements(obj, dotted_name):\n-        """ Asserts if an object\'s class implements a given interface """\n-\n-    def namesAndDescriptions(dotted_name, all=0):\n-        """ Returns a list of pairs (name, description) for a given\n-        interface"""\n+moved(\'plone.base.interfaces.interface\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/language.py b/Products/CMFPlone/interfaces/language.py\nindex e3838c37a9..e8f180cf11 100644\n--- a/Products/CMFPlone/interfaces/language.py\n+++ b/Products/CMFPlone/interfaces/language.py\n@@ -1,11 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-# Language-support\n-class ILanguage(Interface):\n-\n-    def get_language(self):\n-        """ return the contents language """\n-\n-    def set_language(self):\n-        """ return the contents language """\n+moved(\'plone.base.interfaces.language\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/login.py b/Products/CMFPlone/interfaces/login.py\nindex d86b1521c4..19e30f8a8f 100644\n--- a/Products/CMFPlone/interfaces/login.py\n+++ b/Products/CMFPlone/interfaces/login.py\n@@ -1,81 +1,3 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.schema.email import Email\n-from plone.z3cform.interfaces import IWrappedForm\n-from zope import schema\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class IRedirectAfterLogin(Interface):\n-    """ Redirect after login adapters should provide this interface """\n-\n-\n-class IForcePasswordChange(Interface):\n-    """ Hook point to customize forcing a password change """\n-\n-\n-class IInitialLogin(Interface):\n-    """ Hook point to customize what happens the first time a user logs into\n-        the site """\n-\n-\n-class ILogin(Interface):\n-    """ Login form schema """\n-\n-    login = schema.TextLine(\n-        title=_(\'label_log_in\', default=\'Log in\'),\n-    )\n-\n-    password = schema.Password(\n-        title=_(\'label_password\', default=\'Password\'),\n-    )\n-\n-\n-class ILoginForm(IWrappedForm):\n-    """ Login form marker interface """\n-\n-\n-class ILoginFormSchema(Interface):\n-    """ Login form schema """\n-\n-    ac_name = schema.TextLine(\n-        title=_(\'label_login_name\', default=\'Login Name\'),\n-        required=True,\n-    )\n-\n-    ac_password = schema.Password(\n-        title=_(\'label_password\', default=\'Password\'),\n-        required=True,\n-    )\n-\n-    came_from = schema.TextLine(\n-        title=\'Came From\',  # not translated, hidden field\n-        required=False,\n-    )\n-\n-\n-class ILoginHelpForm(IWrappedForm):\n-    """ Login Help form marker interface """\n-\n-\n-class ILoginHelpFormSchema(Interface):\n-    """ Login Help form schema """\n-\n-    reset_password = schema.TextLine(\n-        title=_(\'label_pwreset_username\', default=\'Username\'),\n-        description=_(\n-            \'help_pwreset_username\',\n-            default=\'Enter your username \'\n-                    \'or email and we\xe2\x80\x99ll send you a password reset link.\',\n-        ),\n-        required=True,\n-    )\n-\n-    recover_username = Email(\n-        title=_(\'label_pwreset_email\', default=\'Email\'),\n-        description=_(\n-            \'help_pwreset_email\',\n-            default=\'Enter your email and \'\n-                    \'we\xe2\x80\x99ll send you your username.\',\n-        ),\n-        required=True,\n-    )\n+moved(\'plone.base.interfaces.login\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/migration.py b/Products/CMFPlone/interfaces/migration.py\nindex 2ae6a851f6..5672aac457 100644\n--- a/Products/CMFPlone/interfaces/migration.py\n+++ b/Products/CMFPlone/interfaces/migration.py\n@@ -1,32 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class IMigrationTool(Interface):\n-    """Handles migrations between Plone releases."""\n-\n-    def getInstanceVersion():\n-        """The version this instance of Plone is on."""\n-\n-    def setInstanceVersion(version):\n-        """The version this instance of Plone is on."""\n-\n-    def getFileSystemVersion():\n-        """The version the filesystem code of Plone is on."""\n-\n-    def needUpgrading():\n-        """Need upgrading?"""\n-\n-    def coreVersions():\n-        """Useful core version information."""\n-\n-    def coreVersionsList():\n-        """Useful core version information."""\n-\n-    def needUpdateRole():\n-        """Do roles need to be updated?"""\n-\n-    def needRecatalog():\n-        """Does this thing now need recataloging?"""\n-\n-    def upgrade(REQUEST=None, dry_run=None, swallow_errors=1):\n-        """Perform the upgrade."""\n+moved(\'plone.base.interfaces.migration\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/password_reset.py b/Products/CMFPlone/interfaces/password_reset.py\nindex fde6f96bb4..97fd367189 100644\n--- a/Products/CMFPlone/interfaces/password_reset.py\n+++ b/Products/CMFPlone/interfaces/password_reset.py\n@@ -1,41 +1,3 @@\n-from zope.interface import Interface, Attribute\n+from zope.deprecation import moved\n \n-\n-class IPasswordResetToolView(Interface):\n-    """ BrowserView with utility methods """\n-\n-    def encode_mail_header(text):\n-        """ Encodes text into correctly encoded email header """\n-\n-    def encoded_mail_sender():\n-        """ returns encoded version of Portal name <portal_email> """\n-\n-    def registered_notify_subject():\n-        """ returns encoded version of registered notify template subject line """\n-\n-    def mail_password_subject():\n-        """ returns encoded version of mail password template subject line """\n-\n-\n-class IPWResetTool(Interface):\n-    """Defines an interface for a tool that provides a facility to\n-    reset forgotten passwords.\n-\n-    This interface is rather sparse, but sufficient to describe the\n-    task. (In this manner we void being dependant on a specific\n-    process) The details of the process are in the implementation,\n-    where they belong."""\n-\n-    id = Attribute(\'id\', \'Must be set to "portal_password_reset"\')\n-\n-    def requestReset(userid):\n-        """Ask the system to start the password reset procedure for\n-        user \'userid\'.\n-\n-        Returns the random string that must be used to reset the\n-        password."""\n-\n-    def resetPassword(userid, randomstring, password):\n-        """Set the password (in \'password\') for the user who maps to\n-        the string in \'randomstring\'. The \'userid\' parameter is provided\n-        in case extra authentication is needed."""\n+moved(\'plone.base.interfaces.password_reset\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/patterns.py b/Products/CMFPlone/interfaces/patterns.py\nindex 9a7a0add78..91983316aa 100644\n--- a/Products/CMFPlone/interfaces/patterns.py\n+++ b/Products/CMFPlone/interfaces/patterns.py\n@@ -1,12 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class IPatternsSettings(Interface):\n-    """ Interface to register global pattern settings adapters\n-    """\n-\n-    def __call__(self):\n-        """\n-            Return a dict of pattern options\n-        """\n-        pass\n+moved(\'plone.base.interfaces.patterns\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/properties.py b/Products/CMFPlone/interfaces/properties.py\nindex 560c80b399..4c4b228fff 100644\n--- a/Products/CMFPlone/interfaces/properties.py\n+++ b/Products/CMFPlone/interfaces/properties.py\n@@ -1,26 +1,3 @@\n-from zope.interface import Interface\n-from zope.interface import Attribute\n+from zope.deprecation import moved\n \n-\n-class IPropertiesTool(Interface):\n-\n-    """ Manage properties of the site as a whole.\n-    """\n-\n-    id = Attribute(\'id\', \'Must be set to "portal_properties"\')\n-\n-    def editProperties(props):\n-        """ Change portal settings.\n-\n-        Permission --  Manage portal\n-        """\n-\n-    def smtp_server():\n-        """ Get local SMTP server.\n-\n-        Returns -- String\n-        """\n-\n-\n-class ISimpleItemWithProperties(Interface):\n-    pass\n+moved(\'plone.base.interfaces.properties\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/resources.py b/Products/CMFPlone/interfaces/resources.py\nindex 91a16a0d8e..5e1cab52d3 100644\n--- a/Products/CMFPlone/interfaces/resources.py\n+++ b/Products/CMFPlone/interfaces/resources.py\n@@ -1,143 +1,3 @@\n-import zope.interface\n-import zope.component\n-from zope import schema\n-from zope.schema.vocabulary import SimpleTerm\n-from zope.schema.vocabulary import SimpleVocabulary\n+from zope.deprecation import moved\n \n-from Products.CMFPlone import PloneMessageFactory as _\n-\n-OVERRIDE_RESOURCE_DIRECTORY_NAME = \'resource_overrides\'\n-\n-\n-class IResourceRegistry(zope.interface.Interface):\n-\n-    url = schema.ASCIILine(\n-        title=_("Resources base URL"),\n-        required=False)\n-\n-    js = schema.ASCIILine(\n-        title=_("Main js file"),\n-        required=False)\n-\n-    css = schema.List(\n-        title=_("CSS/LESS files"),\n-        value_type=schema.ASCIILine(title=_("URL")),\n-        default=[],\n-        required=False)\n-\n-    init = schema.ASCIILine(\n-        title=_("Init instruction for shim"),\n-        required=False)\n-\n-    deps = schema.ASCIILine(\n-        title=_("Dependencies for shim"),\n-        description=_("Comma separated values of resource for shim"),\n-        required=False)\n-\n-    export = schema.ASCIILine(\n-        title=_("Export vars for shim"),\n-        required=False)\n-\n-    conf = schema.Text(\n-        title=_("Configuration in JSON for the widget"),\n-        description=_("Should be accessible on @@getWCconfig?id=name"),\n-        required=False)\n-\n-\n-class IBundleRegistry(zope.interface.Interface):\n-\n-    jscompilation = schema.ASCIILine(\n-        title=_("URL of the last js compilation"),\n-        required=False)\n-\n-    csscompilation = schema.ASCIILine(\n-        title=_("URL of the last css compilation"),\n-        required=False)\n-\n-    last_compilation = schema.Datetime(\n-        title=_("Last compiled date"),\n-        description=_("Date time of the last compilation of this bundle"),\n-        required=False)\n-\n-    expression = schema.ASCIILine(\n-        title=_("Expression to render"),\n-        description=_(\n-            "In case its a bundle we can have a condition to render it (it "\n-            "does not apply if the bundle is merged)."),\n-        required=False)\n-\n-    conditionalcomment = schema.ASCIILine(\n-        title=_("Conditional comment"),\n-        description=_(\n-            "In case you want to render this resource on conditional comment "\n-            "(it does not apply if the bundle is merged)."),\n-        required=False)\n-\n-    resources = schema.List(\n-        title=_("Loaded resources"),\n-        description=_(\n-            "The resources that are going to be loaded on this bundle in order"),\n-        value_type=schema.ASCIILine(title=_("Resource name")),\n-        required=False)\n-\n-    enabled = schema.Bool(\n-        title=_("It\'s enabled?"),\n-        default=True,\n-        required=False)\n-\n-    compile = schema.Bool(\n-        title=_("Does your bundle contains any RequireJS or LESS file?"),\n-        description=_(\n-            "If its true and you modify this bundle you need to build it before production"),\n-        default=True,\n-        required=False)\n-\n-    depends = schema.ASCIILine(\n-        title=_("Depends on another bundle"),\n-        description=_(\n-            "In case you want to be the last: *, in case its the first should be empty"),\n-        required=False)\n-\n-    develop_javascript = schema.Bool(\n-        title=_(\'Develop JavaScript\'),\n-        default=False)\n-\n-    develop_css = schema.Bool(\n-        title=_(\'Develop CSS\'),\n-        default=False)\n-\n-    stub_js_modules = schema.List(\n-        title=_(\'Stub JavaScript modules\'),\n-        description=_(\'Define list of modules that will be defined empty \'\n-                      \'on RequireJS build steps to prevent loading modules multiple times.\'),\n-        value_type=schema.ASCIILine(title=_("Resource name")),\n-        required=False,\n-        missing_value=[],\n-        default=[])\n-\n-    merge_with = schema.Choice(\n-        title=_("Merge with"),\n-        description=_(\n-            "In production mode, bundles are merged together to reduce the "\n-            "quantity of JS and CSS resources loaded by the browser. Choose "\n-            "\'default\' if this bundle must be available for all the visitors, "\n-            "choose \'logged-in\' if it must be available for logged-in users "\n-            "only, or leave it empty if it must not be merged."),\n-        vocabulary=SimpleVocabulary(\n-            [SimpleTerm(\'\', \'\', _("")),\n-             SimpleTerm(\'default\', \'default\', \'default\'),\n-             SimpleTerm(\'logged-in\', \'logged-in\', \'logged-in\')]),\n-        default="",\n-        required=False)\n-\n-    load_async = schema.Bool(\n-        title=_("Load asynchronously"),\n-        description=_("Load the JavaScript files asynchronously by adding an ``async`` attribute to the script tag."),\n-        default=False,\n-        required=False)\n-\n-    load_defer = schema.Bool(\n-        title=_("Load deferred"),\n-        description=_("Load the JavaScript files deferred after the document has been parsed but before ``DOMContentLoaded`` by adding a ``defer`` attribute to the script tag."),\n-        default=False,\n-        required=False)\n+moved(\'plone.base.interfaces.resources\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/siteroot.py b/Products/CMFPlone/interfaces/siteroot.py\nindex 83c119871d..e05bac1d96 100644\n--- a/Products/CMFPlone/interfaces/siteroot.py\n+++ b/Products/CMFPlone/interfaces/siteroot.py\n@@ -1,22 +1,3 @@\n-from zope.interface import Interface\n-from Products.CMFCore.interfaces import ISiteRoot\n-from plone.app.layout.navigation.interfaces import INavigationRoot\n+from zope.deprecation import moved\n \n-\n-class IPloneSiteRoot(ISiteRoot, INavigationRoot):\n-    """\n-    Marker interface for the object which serves as the root of a\n-    Plone site.\n-    """\n-\n-\n-class IMigratingPloneSiteRoot(Interface):\n-    """\n-    Marker interface used for migration GenericSetup profiles.\n-    """\n-\n-\n-class ITestCasePloneSiteRoot(Interface):\n-    """\n-    Marker interface used for test fixture GenericSetup profiles.\n-    """\n+moved(\'plone.base.interfaces.siteroot\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/structure.py b/Products/CMFPlone/interfaces/structure.py\nindex ea43a111c2..1de8c04966 100644\n--- a/Products/CMFPlone/interfaces/structure.py\n+++ b/Products/CMFPlone/interfaces/structure.py\n@@ -1,12 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class INonStructuralFolder(Interface):\n-    """Marker for folderish content types that are folderish as an\n-    implementation detail only.\n-\n-    By declaring support for this interface, a content type will not be\n-    considered folderish by the catalog\'s is_folderish index/metadata, meaning\n-    that it will not be treated as folderish by the navigation tree, portal tab\n-    generation and folder_contents.\n-    """\n+moved(\'plone.base.interfaces.structure\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/syndication.py b/Products/CMFPlone/interfaces/syndication.py\nindex b65465a0be..e2bdf7315c 100644\n--- a/Products/CMFPlone/interfaces/syndication.py\n+++ b/Products/CMFPlone/interfaces/syndication.py\n@@ -1,296 +1,3 @@\n-from zope.interface import Interface\n-from zope import schema\n-from Products.CMFPlone import PloneMessageFactory as _\n+from zope.deprecation import moved\n \n-\n-class ISyndicatable(Interface):\n-    pass\n-\n-\n-class IFeedData(Interface):\n-\n-    def link():\n-        """\n-        Link to item\n-        """\n-\n-    def base_url():\n-        """\n-        base url to item\n-        """\n-\n-    def title():\n-        """\n-        title of item\n-        """\n-\n-    def description():\n-        """\n-        """\n-\n-    def categories():\n-        """\n-        List of tags\n-        """\n-\n-    def published():\n-        """\n-        publishing date\n-        """\n-\n-    def modified():\n-        """\n-        modification date\n-        """\n-\n-    def uid():\n-        """\n-        """\n-\n-    def rights():\n-        """\n-        """\n-\n-    def publisher():\n-        """\n-        """\n-\n-    def author():\n-        """\n-        """\n-\n-    def author_name():\n-        """\n-        """\n-\n-    def author_email():\n-        """\n-        """\n-\n-\n-class IFeed(IFeedData):\n-    """\n-    An adapter on the context and request\n-    to get feed information\n-    """\n-    def show_about():\n-        """\n-        """\n-\n-    def logo():\n-        """\n-        """\n-\n-    def icon():\n-        """\n-        """\n-\n-    def _brains():\n-        """\n-        return list of brains\n-        """\n-\n-    def _items():\n-        """\n-        return full objects\n-        """\n-\n-    def items():\n-        """\n-        adapted items\n-        """\n-\n-    def limit():\n-        """\n-        """\n-\n-    def language():\n-        """\n-        """\n-\n-\n-class ISearchFeed(IFeed):\n-    pass\n-\n-\n-class IFeedItem(IFeedData):\n-    """\n-    An adapter on the feed item and IFeed instance\n-    """\n-\n-    def body():\n-        """\n-        """\n-\n-    def guid():\n-        """\n-        """\n-\n-    def has_enclosure():\n-        """\n-        """\n-\n-    def file():\n-        """\n-        """\n-\n-    def file_url():\n-        """\n-        """\n-\n-    def file_length():\n-        """\n-        """\n-\n-    def file_type():\n-        """\n-        """\n-\n-\n-class ISiteSyndicationSettings(Interface):\n-\n-    allowed = schema.Bool(\n-        title=_(\'Allowed\'),\n-        description=_(\'Allow syndication for collections and folders \'\n-                      \'on site.\'),\n-        default=True)\n-\n-    default_enabled = schema.Bool(\n-        title=_(\'Enabled by default\'),\n-        description=_(\'If syndication should be enabled by default for all \'\n-                      \'folders and collections.\'),\n-        default=False)\n-\n-    search_rss_enabled = schema.Bool(\n-        title=_(\'Search RSS enabled\'),\n-        description=_(\'Allows users to subscribe to feeds of search results\'),\n-        default=True)\n-\n-    show_author_info = schema.Bool(\n-        title=_(\'Show author info\'),\n-        description=_(\'Should feeds include author information\'),\n-        default=True)\n-\n-    render_body = schema.Bool(\n-        title=_(\'Render Body\'),\n-        description=_(\'help_render_body\',\n-                      default=\'If body text available for item, \'\n-                      \'render it, otherwise use description.\'),\n-        default=False)\n-\n-    max_items = schema.Int(\n-        title=_(\'label_syndication_max_items\',\n-                default=\'Maximum items\'),\n-        description=_(\'help_syndication_max_items\',\n-                      default=\'Maximum number of items that will be syndicated.\'),\n-        min=1,\n-        default=15)\n-\n-    allowed_feed_types = schema.Tuple(\n-        title=_(\'Allowed Feed Types\'),\n-        description=_("Separate view name and title by \'|\'"),\n-        required=True,\n-        missing_value=None,\n-        default=(\n-            "RSS|RSS 1.0",\n-            "rss.xml|RSS 2.0",\n-            "atom.xml|Atom",\n-            "itunes.xml|iTunes"),\n-        value_type=schema.TextLine()\n-    )\n-\n-    site_rss_items = schema.Tuple(\n-        title=_(\'Site RSS\'),\n-        description=_(\'Paths to folders and collections to link to \'\n-                      \'at the portal root.\'),\n-        required=False,\n-        default=(\'/news/aggregator\',),\n-        value_type=schema.Choice(\n-            vocabulary="plone.app.vocabularies.SyndicatableFeedItems")\n-    )\n-\n-    show_syndication_button = schema.Bool(\n-        title=_("Show settings button"),\n-        description=_("Makes it possible to customize syndication settings "\n-                      "for particular folders and collections "))\n-\n-    show_syndication_link = schema.Bool(\n-        title=_("Show feed link"),\n-        description=_("Enable RSS link document action on the syndication "\n-                      "content item."))\n-\n-\n-class IFeedSettings(Interface):\n-\n-    enabled = schema.Bool(\n-        title=_(\'Enabled\'),\n-        default=False)\n-\n-    feed_types = schema.Tuple(\n-        title=_(\'Feed Types\'),\n-        required=True,\n-        missing_value=None,\n-        default=("RSS", "rss.xml", "atom.xml"),\n-        value_type=schema.Choice(\n-            vocabulary="plone.app.vocabularies.SyndicationFeedTypes"\n-        ))\n-\n-    render_body = schema.Bool(\n-        title=_(\'Render Body\'),\n-        description=_(\n-            \'help_render_body\',\n-            default=\'If body text available for item, \'\n-                    \'render it, otherwise use description.\'),\n-        default=False)\n-\n-    max_items = schema.Int(\n-        title=_(\'label_syndication_max_items\',\n-                default=\'Maximum items\'),\n-        description=_(\n-            \'help_syndication_max_items\',\n-            default=\'Maximum number of items that will be syndicated.\'),\n-        default=15)\n-\n-\n-class ISyndicationUtil(Interface):\n-\n-    def allowed_feed_types():\n-        """\n-        get a list of allow feed types\n-        """\n-\n-    def context_allowed():\n-        """\n-        If syndication is allowed on the context\n-        """\n-\n-    def context_enabled(raise404=False):\n-        """\n-        If syndication is enabled on the context\n-        """\n-\n-    def site_enabled():\n-        """\n-        If syndication is enabled on the site\n-        """\n-\n-    def search_rss_enabled(raise404=False):\n-        """\n-        If search_rss is enabled\n-        """\n-\n-    def show_author_info():\n-        """\n-        If author information should show on feeds\n-        """\n-\n-    def max_items():\n-        """\n-        Default max items to show on the site\n-        """\n-\n-    def rss_url():\n-        """\n-        Default rss url. Mainly to be used for the\n-        rss portal_action link\n-        """\n+moved(\'plone.base.interfaces.syndication\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/interfaces/translationservice.py b/Products/CMFPlone/interfaces/translationservice.py\nindex b908e28ee8..f840d67732 100644\n--- a/Products/CMFPlone/interfaces/translationservice.py\n+++ b/Products/CMFPlone/interfaces/translationservice.py\n@@ -1,44 +1,3 @@\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class ITranslationServiceTool(Interface):\n-    """ Utility methods to access the translation machinery\n-    """\n-\n-    def translate(*args, **kw):\n-        """Translate method to access the translation service\n-           from resticted code like skins.\n-        """\n-\n-    def encode(m, input_encoding=None, output_encoding=None, errors=\'strict\'):\n-        """Encode a give unicode type or string type to string type in encoding\n-           output_encoding\n-        """\n-\n-    def asunicodetype(m, input_encoding=None, errors=\'strict\'):\n-        """Create type unicode from type string"""\n-\n-    def ulocalized_time(time, long_format=None, time_only=None, context=None,\n-                        domain=\'plonelocales\'):\n-        """Returns localized time."""\n-\n-    def day_msgid(number, format=\'\'):\n-        """Returns the msgid which can be passed to the translation service for\n-           l10n of weekday names. Format is either \'\', \'a\' or \'s\'.\n-        """\n-\n-    def month_msgid(number, format=\'\'):\n-        """Returns the msgid which can be passed to the translation service for\n-           l10n of month names. Format is either \'\' or \'a\' (long or\n-           abbreviation).\n-        """\n-\n-    def month_english(number, format=\'\'):\n-        """Returns the english name of month by number. Format is either \'\' or\n-           \'a\' (long or abbreviation).\n-        """\n-\n-    def weekday_english(number, format=\'\'):\n-        """Returns the english name of a week by number. Format is either \'\',\n-           \'a\' or \'p\'.\n-        """\n+moved(\'plone.base.interfaces.translationservice\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/log.py b/Products/CMFPlone/log.py\nindex ba2e6359dd..7cf1dfa8ca 100644\n--- a/Products/CMFPlone/log.py\n+++ b/Products/CMFPlone/log.py\n@@ -2,6 +2,7 @@\n This module resolves an import order dependency.\n Don\'t import from here, import from utils.\n """\n+from zope.deprecation import deprecate\n \n import logging\n \n@@ -19,6 +20,9 @@ def log_exc(message=\'\', summary=\'\', severity=logging.ERROR):\n \n \n # deprecration warning\n+@deprecate("Use a recommended deprecation method, see Plone Deprecation Guide: "\n+           "https://docs.plone.org/develop/styleguide/deprecation.html "\n+           "(will be removed in Plone 7.0)")\n def log_deprecated(message, summary=\'Deprecation Warning\',\n                    severity=logging.WARNING):\n     logger.log(severity, \'%s \\n%s\', summary, message)\ndiff --git a/Products/CMFPlone/meta-bbb.zcml b/Products/CMFPlone/meta-bbb.zcml\ndeleted file mode 100644\nindex 67d7ca3cf5..0000000000\n--- a/Products/CMFPlone/meta-bbb.zcml\n+++ /dev/null\n@@ -1,13 +0,0 @@\n-<configure\n-    xmlns="http://namespaces.zope.org/zope"\n-    xmlns:zcml="http://namespaces.zope.org/zcml"\n-    xmlns:meta="http://namespaces.zope.org/meta">\n-\n-    <configure zcml:condition="installed Products.CMFDefault.browser">\n-        <exclude package="Products.CMFDefault.browser" file="configure.zcml" />\n-        <exclude package="Products.CMFDefault.formlib" file="configure.zcml" />\n-        <exclude package="Products.CMFDefault.upgrade" file="configure.zcml" />\n-    </configure>\n-\n-</configure>\n-\ndiff --git a/Products/CMFPlone/meta.zcml b/Products/CMFPlone/meta.zcml\nindex dbc42f3571..4f7b7c53a9 100644\n--- a/Products/CMFPlone/meta.zcml\n+++ b/Products/CMFPlone/meta.zcml\n@@ -23,17 +23,21 @@\n     <include package="Products.CMFCore" file="meta.zcml" />\n     <include package="Products.GenericSetup" file="meta.zcml" />\n \n+    <include package="plone.dexterity" file="meta.zcml" />\n+    <include package="plone.resource" file="meta.zcml" />\n+    <include package="plone.app.dexterity" file="meta.zcml" />\n     <include package="plone.app.portlets" file="meta.zcml" />\n+    <include package="plone.contentrules" file="meta.zcml" />\n+    <include package="plone.session" file="meta.zcml" />\n \n-    <!-- z3c.autoinclude\'s `includePlugins` directive finds\n+    <!-- plone.autoinclude\'s `autoIncludePlugins` directive finds\n          and executes ZCML files from any installed packages\n          that provide an entry point to declare themselves a\n          plone plugin -->\n-    <include package="z3c.autoinclude" file="meta.zcml" />\n-\n-    <includePlugins\n+    <include package="plone.autoinclude" file="meta.zcml" />\n+    <autoIncludePlugins\n         zcml:condition="not-have disable-autoinclude"\n-        package="plone"\n+        target="plone"\n         file="meta.zcml"\n         />\n \ndiff --git a/Products/CMFPlone/overrides.zcml b/Products/CMFPlone/overrides.zcml\nindex b607ef576a..f756997d4f 100644\n--- a/Products/CMFPlone/overrides.zcml\n+++ b/Products/CMFPlone/overrides.zcml\n@@ -4,18 +4,21 @@\n            i18n_domain="plone">\n \n     <include package="Products.CMFCore" file="overrides.zcml" />\n+    <include package="five.localsitemanager" file="overrides.zcml" />\n     <include package="plone.i18n" file="overrides.zcml" />\n     <include package="plone.app.portlets" file="overrides.zcml" />\n+    <include package="plone.app.multilingual" file="overrides.zcml" />\n+    <include package="plone.app.dexterity" file="overrides.zcml" />\n \n     <utility\n         provides="Products.PageTemplates.interfaces.IUnicodeEncodingConflictResolver"\n         component="Products.CMFPlone.unicodeconflictresolver.UTF8EncodingConflictResolver"\n         />\n \n-    <!-- include plone plugins with z3c.autoinclude -->\n-    <includePluginsOverrides\n+    <!-- include plone plugins with plone.autoinclude -->\n+    <autoIncludePluginsOverrides\n         zcml:condition="not-have disable-autoinclude"\n-        package="plone"\n+        target="plone"\n         file="overrides.zcml"\n         />\n \ndiff --git a/Products/CMFPlone/patches/publishing.py b/Products/CMFPlone/patches/publishing.py\nindex 7920d4e5fb..340f372c33 100644\n--- a/Products/CMFPlone/patches/publishing.py\n+++ b/Products/CMFPlone/patches/publishing.py\n@@ -1,11 +1,23 @@\n # From Products.PloneHotfix20160419\n # Plus extras for properties.\n+# Plus Products.PloneHotfix20210518.\n from OFS.PropertyManager import PropertyManager\n from Products.CMFPlone.Portal import PloneSite\n from plone.dexterity.content import Item\n from plone.dexterity.content import Container\n \n \n+def delete_method_docstring(klass, method_name):\n+    # Delete the docstring from the class method.\n+    # Objects must have a docstring to be published.\n+    # So this avoids them getting published.\n+    method = getattr(klass, method_name, None)\n+    if method is None:\n+        return\n+    if hasattr(method, "__doc__"):\n+        del method.__doc__\n+\n+\n klasses = (\n #    Node,\n #    Document,\n@@ -36,10 +48,7 @@\n \n for klass in klasses:\n     for method_name in methods:\n-        method = getattr(klass, method_name, None)\n-        if (method is not None and hasattr(method, \'im_func\') and\n-                hasattr(method.im_func, \'__doc__\')):\n-            del method.im_func.__doc__\n+        delete_method_docstring(klass, method_name)\n \n property_methods = (\n     \'getProperty\',\n@@ -54,7 +63,4 @@\n )\n \n for method_name in property_methods:\n-    method = getattr(PropertyManager, method_name, None)\n-    if (method is not None and hasattr(method, \'im_func\') and\n-            hasattr(method.im_func, \'__doc__\')):\n-        del method.im_func.__doc__\n+    delete_method_docstring(PropertyManager, method_name)\ndiff --git a/Products/CMFPlone/patches/sendmail.py b/Products/CMFPlone/patches/sendmail.py\nindex bfee534d59..d699ceee01 100644\n--- a/Products/CMFPlone/patches/sendmail.py\n+++ b/Products/CMFPlone/patches/sendmail.py\n@@ -1,5 +1,5 @@\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import IMailSchema\n+from plone.base.interfaces import IMailSchema\n from transaction._transaction import Status\n from zope.component import getUtility\n from zope.sendmail.mailer import _SMTPState\ndiff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py\nindex da2630c137..d55d4a7d11 100644\n--- a/Products/CMFPlone/patterns/__init__.py\n+++ b/Products/CMFPlone/patterns/__init__.py\n@@ -2,11 +2,9 @@\n \n deprecated(\n     "Import from Products.CMFPlone.patterns.tinymce instead",\n-    TinyMCESettingsGenerator=\'Products.CMFPlone.patterns.tinymce.\'\n-                             \'TinyMCESettingsGenerator\'\n+    TinyMCESettingsGenerator="Products.CMFPlone.patterns.tinymce.TinyMCESettingsGenerator",  # noqa: E501\n )\n deprecated(\n     "Import from Products.CMFPlone.patterns.settings instead",\n-    PloneSettingsAdapter=\'Products.CMFPlone.patterns.settings.\'\n-                         \'PatternSettingsAdapter\'\n+    PloneSettingsAdapter="Products.CMFPlone.patterns.settings.PatternSettingsAdapter",  # noqa: E501\n )\ndiff --git a/Products/CMFPlone/patterns/configure.zcml b/Products/CMFPlone/patterns/configure.zcml\nindex c4c0de969e..63908ad2ee 100644\n--- a/Products/CMFPlone/patterns/configure.zcml\n+++ b/Products/CMFPlone/patterns/configure.zcml\n@@ -14,13 +14,13 @@\n       factory=".settings.PatternSettingsAdapter"\n       for="* * *"\n       name="pattern_settings"\n-      provides="Products.CMFPlone.interfaces.IPatternsSettings"\n+      provides="plone.base.interfaces.IPatternsSettings"\n   />\n   <!-- deprecated name -->\n   <adapter\n       factory=".settings.PatternSettingsAdapter"\n       for="* * *"\n       name="plone_settings"\n-      provides="Products.CMFPlone.interfaces.IPatternsSettings"\n+      provides="plone.base.interfaces.IPatternsSettings"\n   />\n </configure>\ndiff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex a4683384cd..a8fe05d5a2 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -7,9 +7,10 @@\n from plone.registry.interfaces import IRegistry\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.interfaces._content import IFolderish\n-from Products.CMFPlone.interfaces import ILinkSchema\n-from Products.CMFPlone.interfaces import IPatternsSettings\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import IImagingSchema\n+from plone.base.interfaces import ILinkSchema\n+from plone.base.interfaces import IPatternsSettings\n+from plone.base.interfaces import IPloneSiteRoot\n from Products.CMFPlone.patterns.tinymce import TinyMCESettingsGenerator\n from Products.CMFPlone.utils import get_portal\n from zope.component import getUtility\n@@ -42,13 +43,15 @@ def structure_updater(self):\n         If we\'re not in folder contents view, do not expose these options.\n         """\n         data = {}\n-        view = self.request.get(\'PUBLISHED\', None)\n+        view = self.request.get("PUBLISHED", None)\n         if IFolderContentsView.providedBy(view):\n             data = {\n-                \'data-pat-structureupdater\': json.dumps({\n-                    \'titleSelector\': \'.documentFirstHeading\',\n-                    \'descriptionSelector\': \'.documentDescription\'\n-                })\n+                "data-pat-structureupdater": json.dumps(\n+                    {\n+                        "titleSelector": ".documentFirstHeading",\n+                        "descriptionSelector": ".documentDescription",\n+                    }\n+                )\n             }\n         return data\n \n@@ -56,35 +59,46 @@ def mark_special_links(self):\n         result = {}\n \n         registry = getUtility(IRegistry)\n-        settings = registry.forInterface(\n-            ILinkSchema, prefix="plone", check=False)\n+        settings = registry.forInterface(ILinkSchema, prefix="plone", check=False)\n \n         msl = settings.mark_special_links\n         elonw = settings.external_links_open_new_window\n         if msl or elonw:\n             result = {\n-                \'data-pat-markspeciallinks\': json.dumps(\n-                    {\n-                        \'external_links_open_new_window\': elonw,\n-                        \'mark_special_links\': msl\n-                    }\n+                "data-pat-markspeciallinks": json.dumps(\n+                    {"external_links_open_new_window": elonw, "mark_special_links": msl}\n                 )\n             }\n         return result\n \n     @property\n     def image_scales(self):\n-        factory = getUtility(\n-            IVocabularyFactory,\n-            \'plone.app.vocabularies.ImagesScales\'\n-        )\n+        # Keep image_scales at least until https://github.com/plone/mockup/pull/1156\n+        # is merged and plone.staticresources is updated.\n+        factory = getUtility(IVocabularyFactory, "plone.app.vocabularies.ImagesScales")\n         vocabulary = factory(self.context)\n-        ret = [{\n-            \'title\': translate(it.title), \'value\': it.value}\n-            for it in vocabulary]\n-        ret = sorted(ret, key=lambda it: it[\'title\'])\n+        ret = [{"title": translate(it.title), "value": it.value} for it in vocabulary]\n+        ret = sorted(ret, key=lambda it: it["title"])\n         return json.dumps(ret)\n \n+    @property\n+    def picture_variants(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n+        editor_picture_variants = {}\n+        for k, picture_variant in settings.picture_variants.items():\n+            hide_in_editor = picture_variant.get("hideInEditor")\n+            if hide_in_editor:\n+                continue\n+            editor_picture_variants[k] = picture_variant\n+        return editor_picture_variants\n+\n+    @property\n+    def image_captioning(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n+        return settings.image_captioning\n+\n     def tinymce(self):\n         """\n         data-pat-tinymce : JSON.stringify({\n@@ -116,46 +130,48 @@ def tinymce(self):\n \n         portal = get_portal()\n         portal_url = portal.absolute_url()\n-        current_path = folder.absolute_url()[len(portal_url):]\n+        current_path = folder.absolute_url()[len(portal_url) :]\n \n         image_types = settings.image_objects or []\n \n-        server_url = self.request.get(\'SERVER_URL\', \'\')\n-        site_path = portal_url[len(server_url):]\n+        server_url = self.request.get("SERVER_URL", "")\n+        site_path = portal_url[len(server_url) :]\n \n         related_items_config = get_relateditems_options(\n             context=self.context,\n             value=None,\n-            separator=\';\',\n-            vocabulary_name=\'plone.app.vocabularies.Catalog\',\n-            vocabulary_view=\'@@getVocabulary\',\n-            field_name=None\n-        )\n-        related_items_config = call_callables(\n-            related_items_config,\n-            self.context\n+            separator=";",\n+            vocabulary_name="plone.app.vocabularies.Catalog",\n+            vocabulary_view="@@getVocabulary",\n+            field_name=None,\n         )\n+        related_items_config = call_callables(related_items_config, self.context)\n \n         configuration = {\n-            \'base_url\': self.context.absolute_url(),\n-            \'imageTypes\': image_types,\n-            \'imageScales\': self.image_scales,\n-            \'linkAttribute\': \'UID\',\n+            "base_url": self.context.absolute_url(),\n+            "imageTypes": image_types,\n+            # Keep imageScales at least until https://github.com/plone/mockup/pull/1156\n+            # is merged and plone.staticresources is updated.\n+            "imageScales": self.image_scales,\n+            "pictureVariants": self.picture_variants,\n+            "imageCaptioningEnabled": self.image_captioning,\n+            "linkAttribute": "UID",\n             # This is for loading the languages on tinymce\n-            \'loadingBaseUrl\': \'{}/++plone++static/components/tinymce-builded/\'\n-                              \'js/tinymce\'.format(portal_url),\n-            \'relatedItems\': related_items_config,\n-            \'prependToScalePart\': \'/@@images/image/\',\n-            \'prependToUrl\': \'{}/resolveuid/\'.format(site_path.rstrip(\'/\')),\n-            \'tiny\': generator.get_tiny_config(),\n-            \'upload\': {\n-                \'baseUrl\': portal_url,\n-                \'currentPath\': current_path,\n-                \'initialFolder\': initial,\n-                \'maxFiles\': 1,\n-                \'relativePath\': \'@@fileUpload\',\n-                \'showTitle\': False,\n-                \'uploadMultiple\': False,\n+            "loadingBaseUrl": "{}/++plone++static/components/tinymce-builded/"\n+            "js/tinymce".format(portal_url),\n+            "relatedItems": related_items_config,\n+            "prependToScalePart": "/@@images/image/",\n+            "prependToUrl": "{}/resolveuid/".format(site_path.rstrip("/")),\n+            "inline": settings.inline,\n+            "tiny": generator.get_tiny_config(),\n+            "upload": {\n+                "baseUrl": portal_url,\n+                "currentPath": current_path,\n+                "initialFolder": initial,\n+                "maxFiles": 1,\n+                "relativePath": "@@fileUpload",\n+                "showTitle": False,\n+                "uploadMultiple": False,\n             },\n         }\n-        return {\'data-pat-tinymce\': json.dumps(configuration)}\n+        return {"data-pat-tinymce": json.dumps(configuration)}\ndiff --git a/Products/CMFPlone/patterns/tinymce.py b/Products/CMFPlone/patterns/tinymce.py\nindex 9cb77d0329..0ae8528f46 100644\n--- a/Products/CMFPlone/patterns/tinymce.py\n+++ b/Products/CMFPlone/patterns/tinymce.py\n@@ -3,29 +3,24 @@\n from plone.app.theming.utils import theming_policy\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IFilterSchema\n-from Products.CMFPlone.interfaces import ITinyMCESchema\n+from plone.base.interfaces import IFilterSchema\n+from plone.base.interfaces import ITinyMCESchema\n from Products.CMFPlone.utils import get_portal\n-from Products.CMFPlone.utils import safe_unicode\n+from plone.base.utils import safe_text\n from zope.component import getUtility\n \n import json\n \n \n class TinyMCESettingsGenerator:\n-\n     def __init__(self, context, request):\n         self.context = context\n         self.request = request\n         self.settings = getUtility(IRegistry).forInterface(\n-            ITinyMCESchema,\n-            prefix="plone",\n-            check=False\n+            ITinyMCESchema, prefix="plone", check=False\n         )\n         self.filter_settings = getUtility(IRegistry).forInterface(\n-            IFilterSchema,\n-            prefix="plone",\n-            check=False\n+            IFilterSchema, prefix="plone", check=False\n         )\n         self.nav_root = getNavigationRootObject(\n             self.context,\n@@ -36,44 +31,39 @@ def __init__(self, context, request):\n     def get_theme(self):\n         return theming_policy().get_theme()\n \n-    def get_content_css(self, style_css=\'\'):\n-        files = [\n-            f\'{self.nav_root_url}/++plone++static/plone-compiled.css\'\n-        ]\n+    def get_content_css(self, style_css=""):\n+        files = []\n         if style_css:\n-            files.extend(style_css.split(\',\'))\n+            files.extend(style_css.split(","))\n         content_css = self.settings.content_css or []\n         for url in content_css:\n             if url and url.strip():\n-                files.append(\'/\'.join([self.nav_root_url, url.strip()]))\n+                files.append("/".join([self.nav_root_url, url.strip()]))\n         theme = self.get_theme()\n-        tinymce_content_css = getattr(theme, \'tinymce_content_css\', None)\n-        if tinymce_content_css is not None and tinymce_content_css != \'\':\n-            for path in theme.tinymce_content_css.split(\',\'):\n-                if path.startswith(\'http://\') or path.startswith(\'https://\'):\n+        tinymce_content_css = getattr(theme, "tinymce_content_css", None)\n+        if tinymce_content_css is not None and tinymce_content_css != "":\n+            for path in theme.tinymce_content_css.split(","):\n+                if path.startswith("http://") or path.startswith("https://"):\n                     files.append(path)\n                 else:\n                     files.append(self.nav_root_url + path)\n \n-        return \',\'.join(files)\n+        return ",".join(files)\n \n-    def get_style_format(self, txt, _type=\'format\', base=None):\n-        parts = txt.strip().split(\'|\')\n+    def get_style_format(self, txt, _type="format", base=None):\n+        parts = txt.strip().split("|")\n         if len(parts) < 2:\n             return\n         if base is None:\n             val = {}\n         else:\n             val = base.copy()\n-        val.update({\n-            \'title\': parts[0],\n-            _type: parts[1]\n-        })\n+        val.update({"title": parts[0], _type: parts[1]})\n         if len(parts) > 2:\n-            val[\'icon\'] = parts[2]\n+            val["icon"] = parts[2]\n         return val\n \n-    def get_styles(self, styles, _type=\'format\', base=None):\n+    def get_styles(self, styles, _type="format", base=None):\n         result = []\n         for style in styles:\n             style = self.get_style_format(style, _type, base)\n@@ -88,120 +78,109 @@ def get_all_style_formats(self):\n         inline_styles = self.settings.inline_styles or []\n         alignment_styles = self.settings.alignment_styles or []\n         table_styles = self.settings.table_styles or []\n-        style_formats = [{\n-            \'title\': \'Headers\',\n-            \'items\': self.get_styles(header_styles)\n-        }, {\n-            \'title\': \'Block\',\n-            \'items\': self.get_styles(block_styles)\n-        }, {\n-            \'title\': \'Inline\',\n-            \'items\': self.get_styles(inline_styles)\n-        }, {\n-            \'title\': \'Alignment\',\n-            \'items\': self.get_styles(alignment_styles)\n-        }, {\n-            \'title\': \'Tables\',\n-            \'items\': self.get_styles(\n-                table_styles, \'classes\', {\'selector\': \'table\'})\n-        }]\n-        return [sf for sf in style_formats if sf[\'items\']]\n+        style_formats = [\n+            {"title": "Headers", "items": self.get_styles(header_styles)},\n+            {"title": "Block", "items": self.get_styles(block_styles)},\n+            {"title": "Inline", "items": self.get_styles(inline_styles)},\n+            {"title": "Alignment", "items": self.get_styles(alignment_styles)},\n+            {\n+                "title": "Tables",\n+                "items": self.get_styles(\n+                    table_styles, "classes", {"selector": "table"}\n+                ),\n+            },\n+        ]\n+        return [sf for sf in style_formats if sf["items"]]\n \n     def get_tiny_config(self):\n         settings = self.settings\n-        importcss_file_filter = \'%s/++plone++static/tinymce-styles.css\' % (\n-            self.nav_root_url\n-        )\n+        importcss_file_filter = "tinymce-formats.css"\n \n         theme = self.get_theme()\n-        if theme and getattr(theme, \'tinymce_styles_css\', None):\n-            importcss_file_filter += \',{}/{}\'.format(\n-                self.nav_root_url,\n-                theme.tinymce_styles_css.lstrip(\'/\'))\n+        if theme and getattr(theme, "tinymce_styles_css", None):\n+            importcss_file_filter += ",{}/{}".format(\n+                self.nav_root_url, theme.tinymce_styles_css.lstrip("/")\n+            )\n \n         tiny_config = {\n-            \'resize\': \'both\' if settings.resizing else False,\n-            \'content_css\': self.get_content_css(importcss_file_filter),\n-            \'plugins\': [\n-                \'plonelink\',\n-                \'ploneimage\',\n-                \'importcss\'\n-            ] + settings.plugins,\n-            \'external_plugins\': {},\n-            \'toolbar\': settings.toolbar,\n-            \'entity_encoding\': settings.entity_encoding,\n-            \'importcss_append\': True,\n-            \'importcss_file_filter\': importcss_file_filter,\n-            \'browser_spellcheck\': True\n+            "resize": "both" if settings.resizing else False,\n+            "content_css": self.get_content_css(),\n+            "plugins": ["plonelink", "ploneimage", "importcss"] + settings.plugins,\n+            "external_plugins": {},\n+            "toolbar": settings.toolbar,\n+            "entity_encoding": settings.entity_encoding,\n+            "importcss_append": True,\n+            "importcss_file_filter": importcss_file_filter,\n+            "browser_spellcheck": True,\n         }\n         toolbar_additions = settings.custom_buttons or []\n \n         if settings.editor_height:\n-            tiny_config[\'height\'] = settings.editor_height\n+            tiny_config["height"] = settings.editor_height\n         if settings.autoresize:\n-            tiny_config[\'plugins\'].append(\'autoresize\')\n-            tiny_config[\'autoresize_max_height\'] = 1000  # hard coded?\n+            tiny_config["plugins"].append("autoresize")\n+            tiny_config["autoresize_max_height"] = 1000  # hard coded?\n         if settings.editor_width:\n-            tiny_config[\'width\'] = settings.editor_width\n+            tiny_config["width"] = settings.editor_width\n \n         # specific plugin options\n-        if \'contextmenu\' in settings.plugins:\n-            tiny_config[\'contextmenu\'] = "plonelink ploneimage inserttable |"\\\n-                " cell row column deletetable"\n+        if "contextmenu" in settings.plugins:\n+            tiny_config["contextmenu"] = (\n+                "plonelink ploneimage inserttable |" " cell row column deletetable"\n+            )\n \n-        if settings.libraries_spellchecker_choice == \'AtD\':\n-            mtool = getToolByName(self.context, \'portal_membership\')\n+        if settings.libraries_spellchecker_choice == "AtD":\n+            mtool = getToolByName(self.context, "portal_membership")\n             member = mtool.getAuthenticatedMember()\n             member_id = member.getId()\n             if member_id:\n-                if \'compat3x\' not in tiny_config[\'plugins\']:\n-                    tiny_config[\'plugins\'].append(\'compat3x\')\n-                tiny_config[\'external_plugins\'][\'AtD\'] = (\n-                    \'{}/++plone++static/tinymce-AtD-plugin/\'\n-                    \'editor_plugin.js\'.format(self.nav_root_url)\n+                if "compat3x" not in tiny_config["plugins"]:\n+                    tiny_config["plugins"].append("compat3x")\n+                tiny_config["external_plugins"][\n+                    "AtD"\n+                ] = "{}/++plone++static/tinymce-AtD-plugin/" "editor_plugin.js".format(\n+                    self.nav_root_url\n                 )\n                 # None when Anonymous User\n-                tiny_config[\'atd_rpc_id\'] = \'plone-\' + member_id\n-                tiny_config[\'atd_rpc_url\'] = self.nav_root_url\n-                tiny_config[\'atd_show_types\'] = \',\'.join(\n+                tiny_config["atd_rpc_id"] = "plone-" + member_id\n+                tiny_config["atd_rpc_url"] = self.nav_root_url\n+                tiny_config["atd_show_types"] = ",".join(\n                     settings.libraries_atd_show_types\n                 )\n-                tiny_config[\'atd_ignore_strings\'] = \',\'.join(\n+                tiny_config["atd_ignore_strings"] = ",".join(\n                     settings.libraries_atd_ignore_strings\n                 )\n-                toolbar_additions.append(\'AtD\')\n-        elif settings.libraries_spellchecker_choice == \'AtD\':\n-            tiny_config[\'browser_spellcheck\'] = True\n+                toolbar_additions.append("AtD")\n+        elif settings.libraries_spellchecker_choice == "AtD":\n+            tiny_config["browser_spellcheck"] = True\n \n         if toolbar_additions:\n-            tiny_config[\'toolbar\'] += \' | {}\'.format(\n-                \' \'.join(toolbar_additions)\n-            )\n+            tiny_config["toolbar"] += " | {}".format(" ".join(toolbar_additions))\n \n         for plugin in settings.custom_plugins or []:\n-            parts = plugin.split(\'|\')\n+            parts = plugin.split("|")\n             if len(parts) != 2:\n                 continue\n-            tiny_config[\'external_plugins\'][parts[0]] = parts[1]\n+            tiny_config["external_plugins"][parts[0]] = parts[1]\n \n-        tiny_config[\'style_formats\'] = self.get_all_style_formats()\n+        tiny_config["style_formats"] = self.get_all_style_formats()\n         if settings.formats:\n             try:\n-                tiny_config[\'formats\'] = json.loads(settings.formats)\n+                tiny_config["formats"] = json.loads(settings.formats)\n             except ValueError:\n                 pass\n \n         if settings.menubar:\n-            tiny_config[\'menubar\'] = settings.menubar\n+            tiny_config["menubar"] = settings.menubar\n         if settings.menu:\n             try:\n-                tiny_config[\'menu\'] = json.loads(settings.menu)\n+                tiny_config["menu"] = json.loads(settings.menu)\n             except ValueError:\n                 pass\n \n-        if hasattr(settings, \'templates\') and settings.templates:\n+        if hasattr(settings, "templates") and settings.templates:\n             try:\n-                tiny_config[\'templates\'] = json.loads(settings.templates)\n+                tiny_config["templates"] = json.loads(settings.templates)\n             except ValueError:\n                 pass\n \n@@ -210,8 +189,7 @@ def get_tiny_config(self):\n             valid_tags = self.filter_settings.valid_tags\n             nasty_tags = self.filter_settings.nasty_tags\n             custom_attributes = self.filter_settings.custom_attributes\n-            safe_attributes = [\n-                safe_unicode(attr) for attr in html.defs.safe_attrs]\n+            safe_attributes = [safe_text(attr) for attr in html.defs.safe_attrs]\n             valid_attributes = safe_attributes + custom_attributes\n             # valid_elements : \'a[href|target=_blank],strong/b,div[align],br\'\n             tiny_valid_elements = []\n@@ -223,7 +201,7 @@ def get_tiny_config(self):\n             for tag in nasty_tags:\n                 tag_str = "{}[{}]".format(tag, "|".join(valid_attributes))\n                 tiny_valid_elements.append(tag_str)\n-            tiny_config[\'valid_elements\'] = ",".join(tiny_valid_elements)\n+            tiny_config["valid_elements"] = ",".join(tiny_valid_elements)\n \n         if settings.other_settings:\n             try:\ndiff --git a/Products/CMFPlone/patterns/utils.py b/Products/CMFPlone/patterns/utils.py\nindex 675eb7c2d4..bc186d7d30 100644\n--- a/Products/CMFPlone/patterns/utils.py\n+++ b/Products/CMFPlone/patterns/utils.py\n@@ -5,31 +5,29 @@\n \n \n def format_pattern_settings(option, config):\n-    if option.startswith(\'json:\'):\n+    if option.startswith("json:"):\n         try:\n-            return json.loads(option.lstrip(\'json:\') % config)\n+            return json.loads(option.lstrip("json:") % config)\n         except:\n             return {}\n     return option % config\n \n \n def get_portal():\n-    """DEPRECATED\n-    """\n+    """DEPRECATED"""\n     warnings.warn(\n-        \'Instead of Products.CMFPlone.patterns.get_portal: \'\n-        \'use Products.CMFPlone.utils.get_portal\',\n-        DeprecationWarning\n+        "Instead of Products.CMFPlone.patterns.get_portal: "\n+        "use Products.CMFPlone.utils.get_portal",\n+        DeprecationWarning,\n     )\n     return utils.get_portal()\n \n \n def get_portal_url(context):\n-    """DEPRECATED\n-    """\n+    """DEPRECATED"""\n     warnings.warn(\n-        \'Instead of Products.CMFPlone.patterns.get_portal_url: \'\n-        \'Use Products.CMFPlone.utils.portal.absolute_url()\',\n-        DeprecationWarning\n+        "Instead of Products.CMFPlone.patterns.get_portal_url: "\n+        "Use Products.CMFPlone.utils.portal.absolute_url()",\n+        DeprecationWarning,\n     )\n     return utils.get_portal().absolute_url()\ndiff --git a/Products/CMFPlone/patterns/view.py b/Products/CMFPlone/patterns/view.py\nindex 6a1c63660f..5f7b8e311b 100644\n--- a/Products/CMFPlone/patterns/view.py\n+++ b/Products/CMFPlone/patterns/view.py\n@@ -1,6 +1,6 @@\n # This module delivers the global patterns settings\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import IPatternsSettings\n+from plone.base.interfaces import IPatternsSettings\n from zope.component import getAdapters\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n@@ -14,34 +14,29 @@ class PatternsSettingsView(BrowserView):\n \n     def __call__(self):\n         portal_state = getMultiAdapter(\n-            (self.context, self.request),\n-            name=\'plone_portal_state\'\n+            (self.context, self.request), name="plone_portal_state"\n         )\n         context_state = getMultiAdapter(\n-            (self.context, self.request),\n-            name=\'plone_context_state\'\n+            (self.context, self.request), name="plone_context_state"\n         )\n         # do not use getSite because it\'s possible it could be different\n         # than the actual portal url\n         portal_url = portal_state.portal_url()\n         result = {\n-            \'data-base-url\': self.context.absolute_url(),\n-            \'data-view-url\': context_state.view_url(),\n-            \'data-portal-url\': portal_url,\n-            \'data-i18ncatalogurl\': portal_url + \'/plonejsi18n\'\n+            "data-base-url": self.context.absolute_url(),\n+            "data-view-url": context_state.view_url(),\n+            "data-portal-url": portal_url,\n+            "data-i18ncatalogurl": portal_url + "/plonejsi18n",\n         }\n \n         # first, check for any adapters that need pattern data defined\n-        adapters = getAdapters(\n-            (self.context, self.request, None),\n-            IPatternsSettings\n-        )\n+        adapters = getAdapters((self.context, self.request, None), IPatternsSettings)\n         [result.update(x[1]()) for x in adapters]\n \n         # Resources Registered UI patterns can override adapters\n         registry = getUtility(IRegistry)\n-        pattern_options = registry.get(\'plone.patternoptions\', {})\n+        pattern_options = registry.get("plone.patternoptions", {})\n         for key, value in pattern_options.items():\n-            result[\'data-pat-\' + key] = value\n+            result["data-pat-" + key] = value\n \n         return result\ndiff --git a/Products/CMFPlone/permissions.py b/Products/CMFPlone/permissions.py\nindex 07370e2931..4230ff54eb 100644\n--- a/Products/CMFPlone/permissions.py\n+++ b/Products/CMFPlone/permissions.py\n@@ -1,67 +1,3 @@\n-""" CMFPlone product permissions """\n-from AccessControl import ModuleSecurityInfo\n+from zope.deprecation import moved\n \n-security = ModuleSecurityInfo(\'Products.CMFPlone.permissions\')\n-\n-security.declarePublic(\'AccessContentsInformation\')\n-from Products.CMFCore.permissions import AccessContentsInformation\n-\n-security.declarePublic(\'AddPortalContent\')\n-from Products.CMFCore.permissions import AddPortalContent\n-\n-security.declarePublic(\'AddPortalFolders\')\n-from Products.CMFCore.permissions import AddPortalFolders\n-\n-security.declarePublic(\'AddPortalMember\')\n-from Products.CMFCore.permissions import AddPortalMember\n-\n-security.declarePublic(\'DeleteObjects\')\n-from Products.CMFCore.permissions import DeleteObjects\n-\n-security.declarePublic(\'FTPAccess\')\n-from Products.CMFCore.permissions import FTPAccess\n-\n-security.declarePublic(\'ListFolderContents\')\n-from Products.CMFCore.permissions import ListFolderContents\n-\n-security.declarePublic(\'ListPortalMembers\')\n-from Products.CMFCore.permissions import ListPortalMembers\n-\n-security.declarePublic(\'ListUndoableChanges\')\n-from Products.CMFCore.permissions import ListUndoableChanges\n-\n-security.declarePublic(\'ManagePortal\')\n-from Products.CMFCore.permissions import ManagePortal\n-\n-security.declarePublic(\'ManageProperties\')\n-from Products.CMFCore.permissions import ManageProperties\n-\n-security.declarePublic(\'ManageUsers\')\n-from Products.CMFCore.permissions import ManageUsers\n-\n-security.declarePublic(\'ModifyPortalContent\')\n-from Products.CMFCore.permissions import ModifyPortalContent\n-\n-security.declarePublic(\'ReplyToItem\')\n-from Products.CMFCore.permissions import ReplyToItem\n-\n-security.declarePublic(\'RequestReview\')\n-from Products.CMFCore.permissions import RequestReview\n-\n-security.declarePublic(\'ReviewPortalContent\')\n-from Products.CMFCore.permissions import ReviewPortalContent\n-\n-security.declarePublic(\'SetOwnPassword\')\n-from Products.CMFCore.permissions import SetOwnPassword\n-\n-security.declarePublic(\'SetOwnProperties\')\n-from Products.CMFCore.permissions import SetOwnProperties\n-\n-security.declarePublic(\'UndoChanges\')\n-from Products.CMFCore.permissions import UndoChanges\n-\n-security.declarePublic(\'View\')\n-from Products.CMFCore.permissions import View\n-\n-security.declarePublic(\'ViewManagementScreens\')\n-from Products.CMFCore.permissions import ViewManagementScreens\n+moved(\'plone.base.permissions\', \'Version 7.0\')\n\\ No newline at end of file\ndiff --git a/Products/CMFPlone/profiles.zcml b/Products/CMFPlone/profiles.zcml\nindex 78ee432b74..b82c00411d 100644\n--- a/Products/CMFPlone/profiles.zcml\n+++ b/Products/CMFPlone/profiles.zcml\n@@ -8,7 +8,7 @@\n       title="Plone Site"\n       directory="profiles/default"\n       description="Profile for a default Plone."\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       post_handler="Products.CMFPlone.setuphandlers.importFinalSteps"\n       />\n \n@@ -17,7 +17,7 @@\n       title="Mandatory dependencies for a Plone site"\n       directory="profiles/dependencies"\n       description="Load all profiles from other packages/products that are needed for a full Plone site."\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for="plone.base.interfaces.IPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -26,7 +26,7 @@\n       title="Plone Test Fixture"\n       directory="profiles/testfixture"\n       description="Extension profile to configure a test fixture"\n-      for="Products.CMFPlone.interfaces.ITestCasePloneSiteRoot"\n+      for="plone.base.interfaces.ITestCasePloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \ndiff --git a/Products/CMFPlone/profiles/default/actions.xml b/Products/CMFPlone/profiles/default/actions.xml\nindex 1035539623..0f79034d3f 100644\n--- a/Products/CMFPlone/profiles/default/actions.xml\n+++ b/Products/CMFPlone/profiles/default/actions.xml\n@@ -10,7 +10,7 @@\n    <property name="title" i18n:translate="">RSS feed</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">object/@@syndication-util/rss_url</property>\n-   <property name="icon_expr">string:$portal_url/rss.png</property>\n+   <property name="icon_expr">string:plone-rss</property>\n    <property\n       name="available_expr">object/@@syndication-util/context_enabled</property>\n    <property name="permissions">\n@@ -22,7 +22,7 @@\n    <property name="title" i18n:translate="">Print this</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:javascript:this.print();</property>\n-   <property name="icon_expr">string:$portal_url/print_icon.png</property>\n+   <property name="icon_expr">string:plone-print</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n     <element value="View"/>\n@@ -48,7 +48,7 @@\n    <property name="title" i18n:translate="">Site Map</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${globals_view/navigationRootUrl}/sitemap</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-sitemap</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n     <element value="View"/>\n@@ -60,7 +60,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:${globals_view/navigationRootUrl}/accessibility-info</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-accessibility</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n     <element value="View"/>\n@@ -71,7 +71,7 @@\n    <property name="title" i18n:translate="">Contact</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${globals_view/navigationRootUrl}/contact-info</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-contact-info</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n     <element value="View"/>\n@@ -87,7 +87,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:${globals_view/getCurrentFolderUrl}/folder_contents</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:toolbar-action/folderContents</property>\n    <property name="permissions">\n     <element value="List folder contents"/>\n    </property>\n@@ -98,10 +98,10 @@\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${object_url}/@@historyview</property>\n    <property name="link_target"></property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:toolbar-action/history</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n-    <element value="View"/>\n+    <element value="Modify portal content"/>\n    </property>\n    <property name="visible">True</property>\n   </object>\n@@ -109,7 +109,7 @@\n    <property name="title" i18n:translate="">Sharing</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${object_url}/@@sharing</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:toolbar-action/sharing</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n     <element value="Sharing page: Delegate roles"/>\n@@ -121,7 +121,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:${plone_context_state/canonical_object_url}/@@manage-content-rules</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-rules</property>\n    <property\n       name="available_expr">python:plone_context_state.canonical_object().restrictedTraverse(\'@@plone_contentrules_info\').show_rules_tab()</property>\n    <property name="permissions">\n@@ -133,7 +133,7 @@\n    <property name="title" i18n:translate="">Syndication</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${object_url}/synPropertiesForm</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-rss</property>\n    <property\n       name="available_expr">object/@@syndication-util/context_allowed</property>\n    <property name="permissions">\n@@ -149,6 +149,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:$object_url/object_cut</property>\n+   <property name="icon_expr">string:plone-cut</property>\n    <property\n       name="available_expr">python:checkPermission("Delete objects", globals_view.getParentObject()) and checkPermission("Copy or Move", object) and not globals_view.isPortalOrPortalDefaultPage()</property>\n    <property name="permissions">\n@@ -161,6 +162,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:$object_url/object_copy</property>\n+   <property name="icon_expr">string:plone-copy</property>\n    <property\n       name="available_expr">python:checkPermission("Copy or Move", object) and not globals_view.isPortalOrPortalDefaultPage()</property>\n    <property name="permissions">\n@@ -172,6 +174,7 @@\n    <property name="title" i18n:translate="">Paste</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${globals_view/getCurrentFolderUrl}/object_paste</property>\n+   <property name="icon_expr">string:plone-paste</property>\n    <property name="available_expr">folder/cb_dataValid|nothing</property>\n    <property name="permissions">\n     <element value="View"/>\n@@ -183,6 +186,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:$object_url/delete_confirmation</property>\n+   <property name="icon_expr">string:plone-delete</property>\n    <property\n       name="available_expr">python:checkPermission("Delete objects", globals_view.getParentObject()) and not globals_view.isPortalOrPortalDefaultPage()</property>\n    <property name="permissions">\n@@ -196,7 +200,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:$object_url/object_rename</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-rename</property>\n    <property\n       name="available_expr">python:checkPermission("Delete objects", globals_view.getParentObject()) and checkPermission("Copy or Move", object) and checkPermission("Add portal content", object) and not globals_view.isPortalOrPortalDefaultPage()</property>\n    <property name="permissions">\n@@ -210,7 +214,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string: ${object_url}/@@manage-aliases</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-redirection</property>\n    <property name="available_expr">python:not globals_view.isPortalOrPortalDefaultPage()</property>\n    <property name="permissions">\n     <element value="Manage Context Aliases"/>\n@@ -225,7 +229,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:${globals_view/navigationRootUrl}</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-home</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n     <element value="View"/>\n@@ -240,7 +244,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:${globals_view/navigationRootUrl}/@@personal-preferences</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-user</property>\n    <property name="available_expr">python:member is not None</property>\n    <property name="permissions">\n     <element value="View"/>\n@@ -252,7 +256,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:${portal_url}/dashboard</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-dashboard</property>\n    <property name="available_expr">python:member is not None</property>\n    <property name="permissions">\n     <element value="Portlets: Manage own portlets"/>\n@@ -263,31 +267,31 @@\n    <property name="title" i18n:translate="">Log in</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${globals_view/navigationRootUrl}/login</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-login</property>\n    <property name="available_expr">python:member is None</property>\n    <property name="permissions">\n     <element value="View"/>\n    </property>\n    <property name="visible">True</property>\n-   <property name="modal" type="text">{"prependContent": ".portalMessage", "title": "Log in", "width": "26em", "actionOptions": {"redirectOnResponse": true}}</property>\n+   <property name="modal" type="text">{}</property>\n   </object>\n   <object name="join" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Register</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${globals_view/navigationRootUrl}/@@register</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-register</property>\n    <property name="available_expr">python:member is None</property>\n    <property name="permissions">\n     <element value="Add portal member"/>\n    </property>\n    <property name="visible">True</property>\n-   <property name="modal" type="text">{"prependContent": ".portalMessage"}</property>\n+   <property name="modal" type="text">{}</property>\n   </object>\n   <object name="undo" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Undo</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${globals_view/navigationRootUrl}/undo_form</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-undo</property>\n    <property name="available_expr">python:member is not None</property>\n    <property name="permissions">\n     <element value="List undoable changes"/>\n@@ -299,7 +303,7 @@\n    <property name="description" i18n:translate=""></property>\n    <property\n       name="url_expr">string:${portal_url}/@@overview-controlpanel</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-controlpanel</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n     <element value="Plone Site Setup: Overview"/>\n@@ -310,7 +314,7 @@\n    <property name="title" i18n:translate="">Log out</property>\n    <property name="description" i18n:translate=""></property>\n    <property name="url_expr">string:${globals_view/navigationRootUrl}/logout</property>\n-   <property name="icon_expr"></property>\n+   <property name="icon_expr">string:plone-logout</property>\n    <property name="available_expr">python:member is not None</property>\n    <property name="permissions">\n     <element value="View"/>\ndiff --git a/Products/CMFPlone/profiles/default/catalog.xml b/Products/CMFPlone/profiles/default/catalog.xml\nindex ebab330d9f..51ab0fbaa6 100644\n--- a/Products/CMFPlone/profiles/default/catalog.xml\n+++ b/Products/CMFPlone/profiles/default/catalog.xml\n@@ -127,6 +127,7 @@\n  <column value="getObjSize"/>\n  <column value="getRemoteUrl"/>\n  <column value="id"/>\n+ <column value="image_scales"/>\n  <column value="is_folderish"/>\n  <column value="listCreators"/>\n  <column value="location"/>\ndiff --git a/Products/CMFPlone/profiles/default/controlpanel.xml b/Products/CMFPlone/profiles/default/controlpanel.xml\nindex ab20ff6ba3..2ab92c9020 100644\n--- a/Products/CMFPlone/profiles/default/controlpanel.xml\n+++ b/Products/CMFPlone/profiles/default/controlpanel.xml\n@@ -3,192 +3,195 @@\n   i18n:domain="plone" xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n  <configlet title="Add-ons" action_id="QuickInstaller" appId="QuickInstaller"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/product_icon.png"\n+    icon_expr="string:puzzle"\n     url_expr="string:${portal_url}/prefs_install_products_form"\n     visible="True" i18n:attributes="title">\n   <permission>Manage portal</permission>\n  </configlet>\n  <configlet title="Site" action_id="PloneReconfig" appId="Plone"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/logoIcon.png"\n+    icon_expr="string:house-door"\n     url_expr="string:${portal_url}/@@site-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Site</permission>\n  </configlet>\n  <configlet title="Date and Time" action_id="DateAndTime" appId="DateAndTime"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/event_icon.png"\n+    icon_expr="string:clock"\n     url_expr="string:${portal_url}/@@dateandtime-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Site</permission>\n  </configlet>\n- <configlet title="Users and Groups" action_id="UsersGroups"\n+ <configlet title="Users" action_id="UsersGroups"\n     appId="UsersGroups" category="plone-users" condition_expr=""\n-    icon_expr="string:$portal_url/group.png"\n+    icon_expr="string:person"\n     url_expr="string:${portal_url}/@@usergroup-userprefs" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Users and Groups</permission>\n  </configlet>\n- <configlet title="Users and Groups" action_id="UsersGroups2"\n-    appId="UsersGroups" category="plone-users" condition_expr=""\n-    icon_expr="string:$portal_url/group.png"\n-    url_expr="string:${portal_url}/@@usergroup-groupprefs" visible="False"\n+ <configlet title="Groups" action_id="UsersGroups2"\n+    appId="UsersGroups2" category="plone-users" condition_expr=""\n+    icon_expr="string:people"\n+    url_expr="string:${portal_url}/@@usergroup-groupprefs" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Users and Groups</permission>\n  </configlet>\n- <configlet title="Personal Preferences" action_id="MemberPrefs" appId="Plone"\n-    category="Member" condition_expr=""\n-    icon_expr="string:$portal_url/user.png"\n-    url_expr="string:${portal_url}/@@personal-preferences" visible="True"\n+ <configlet title="User and Group Settings" action_id="UsersGroupsSettings"\n+    appId="UsersGroupsSettings" category="plone-users" condition_expr=""\n+    icon_expr="string:toggles"\n+    url_expr="string:${portal_url}/@@usergroup-controlpanel" visible="True"\n     i18n:attributes="title">\n-  <permission>Set own properties</permission>\n+  <permission>Plone Site Setup: Users and Groups</permission>\n  </configlet>\n- <configlet title="Change Password" action_id="MemberPassword" appId="Plone"\n-    category="Member" condition_expr="python:member.canPasswordSet()"\n-    icon_expr="string:$portal_url/lock_icon.png"\n-    url_expr="string:${portal_url}/password_form" visible="True"\n+ <configlet title="Member Fields" action_id="MemberFields"\n+    appId="MemberFields" category="plone-users" condition_expr=""\n+    icon_expr="string:card-list"\n+    url_expr="string:${portal_url}/@@member-fields" visible="True"\n     i18n:attributes="title">\n-  <permission>Set own password</permission>\n+  <permission>Plone Site Setup: Users and Groups</permission>\n  </configlet>\n  <configlet title="Mail" action_id="MailHost" appId="MailHost"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/mail_icon.png"\n+    icon_expr="string:envelope-open"\n     url_expr="string:${portal_url}/@@mail-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Mail</permission>\n  </configlet>\n  <configlet title="Themes" action_id="PortalSkin" appId="PortalSkin"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/skins_icon.png"\n+    icon_expr="string:display"\n     url_expr="string:${portal_url}/@@skins-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Themes</permission>\n  </configlet>\n  <configlet title="Editing" action_id="EditingSettings" appId="Plone"\n     category="plone-content" condition_expr=""\n-    icon_expr="string:$portal_url/cut_icon.png"\n+    icon_expr="string:pencil"\n     url_expr="string:${portal_url}/@@editing-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Editing</permission>\n  </configlet>\n  <configlet title="Errors" action_id="errorLog" appId="ErrorLog"\n     category="plone-security" condition_expr=""\n-    icon_expr="string:$portal_url/error_log_icon.png"\n-    url_expr="string:${portal_url}/prefs_error_log_form" visible="True"\n+    icon_expr="string:exclamation-square"\n+    url_expr="string:${portal_url}/@@error-log-form" visible="True"\n     i18n:attributes="title">\n   <permission>Manage portal</permission>\n  </configlet>\n  <configlet title="Content Settings" action_id="TypesSettings" appId="TypesSettings"\n     category="plone-content" condition_expr=""\n-    icon_expr="string:$portal_url/document_icon.png"\n+    icon_expr="string:file-text"\n     url_expr="string:${portal_url}/@@content-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Types</permission>\n  </configlet>\n  <configlet title="Markup" action_id="MarkupSettings" appId="MarkupSettings"\n-    category="plone-content" condition_expr="" icon_expr="string:$portal_url/edit.png"\n+    category="plone-content" condition_expr=""\n+    icon_expr="string:code-slash"\n     url_expr="string:${portal_url}/@@markup-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Markup</permission>\n  </configlet>\n  <configlet title="Security" action_id="SecuritySettings"\n     appId="SecuritySettings" category="plone-security" condition_expr=""\n-    icon_expr="string:$portal_url/lock_icon.png"\n+    icon_expr="string:shield-check"\n     url_expr="string:${portal_url}/@@security-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Security</permission>\n  </configlet>\n  <configlet title="Management Interface" action_id="ZMI" appId="ZMI"\n     category="plone-advanced" condition_expr=""\n-    icon_expr="string:$portal_url/zope_icon.png"\n+    icon_expr="string:command"\n     url_expr="string:${portal_url}/manage_main" visible="True"\n     i18n:attributes="title">\n   <permission>Manage portal</permission>\n  </configlet>\n  <configlet title="Search" action_id="SearchSettings" appId="Plone"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/search_icon.png"\n+    icon_expr="string:search"\n     url_expr="string:${portal_url}/@@search-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Search</permission>\n  </configlet>\n  <configlet title="Navigation" action_id="NavigationSettings" appId="Plone"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/navigation_icon.png"\n+    icon_expr="string:list-nested"\n     url_expr="string:${portal_url}/@@navigation-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Navigation</permission>\n  </configlet>\n  <configlet title="Language" action_id="LanguageSettings"\n     appId="Plone" category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/flag-plone.png"\n+    icon_expr="string:flag"\n     url_expr="string:${portal_url}/@@language-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Language</permission>\n  </configlet>\n  <configlet title="HTML Filtering" action_id="FilterSettings" appId="FilterSettings"\n     category="plone-security" condition_expr=""\n-    icon_expr="string:$portal_url/htmlfilter_icon.png"\n+    icon_expr="string:funnel"\n     url_expr="string:${portal_url}/@@filter-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Filtering</permission>\n  </configlet>\n  <configlet title="Maintenance" action_id="Maintenance" appId="Plone"\n     category="plone-advanced" condition_expr=""\n-    icon_expr="string:$portal_url/maintenance_icon.png"\n+    icon_expr="string:wrench"\n     url_expr="string:${portal_url}/@@maintenance-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Manage portal</permission>\n  </configlet>\n  <configlet title="Content Rules" action_id="ContentRules" appId="Plone"\n     category="plone-content" condition_expr=""\n-    icon_expr="string:$portal_url/contentrules_icon.png"\n+    icon_expr="string:card-checklist"\n     url_expr="string:${portal_url}/@@rules-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Content rules: Manage rules</permission>\n  </configlet>\n  <configlet title="Syndication" action_id="syndication" appId="Plone"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/rss.png"\n+    icon_expr="string:wifi"\n     url_expr="string:${portal_url}/@@syndication-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Site</permission>\n  </configlet>\n  <configlet title="Resource Registries" action_id="resourceregistries" appId="Plone"\n     category="plone-advanced" condition_expr=""\n-    icon_expr=""\n+    icon_expr="string:bootstrap-reboot"\n     url_expr="string:${portal_url}/@@resourceregistry-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Site</permission>\n  </configlet>\n  <configlet title="TinyMCE" action_id="tinymce" appId="Plone"\n     category="plone-general" condition_expr=""\n-    icon_expr="string:$portal_url/tinymce.png"\n+    icon_expr="string:textarea-t"\n     url_expr="string:${portal_url}/@@tinymce-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: TinyMCE</permission>\n  </configlet>\n  <configlet title="Social Media" action_id="socialmedia" appId="Plone"\n     category="plone-general" condition_expr=""\n+    icon_expr="string:volume-up"\n     url_expr="string:${portal_url}/@@social-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Site</permission>\n  </configlet>\n   <configlet title="Image Handling" action_id="ImagingSettings" appId="ImagingSettings"\n     category="plone-content" condition_expr=""\n-    icon_expr="string:$portal_url/image_icon.png"\n+    icon_expr="string:image"\n     url_expr="string:${portal_url}/@@imaging-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Plone Site Setup: Imaging</permission>\n  </configlet>\n  <configlet title="Actions" action_id="ActionSettings" appId="Plone"\n     category="plone-general" condition_expr=""\n+    icon_expr="string:lightning"\n     url_expr="string:${portal_url}/@@actions-controlpanel" visible="True"\n     i18n:attributes="title">\n   <permission>Manage portal</permission>\n  </configlet>\n  <configlet title="URL Management" action_id="RedirectionTool"\n-    icon_expr="string:$portal_url/action_icon.png"\n+    icon_expr="string:alt"\n     appId="Plone" category="plone-general"\n     condition_expr=""\n     url_expr="string:${portal_url}/@@redirection-controlpanel"\n@@ -196,4 +199,13 @@\n     i18n:attributes="title">\n   <permission>Manage Portal Aliases</permission>\n  </configlet>\n+ <configlet title="Relations" action_id="inspectrelations"\n+    icon_expr="string:share-fill"\n+    appId="Relations" category="plone-content"\n+    condition_expr=""\n+    url_expr="string:${portal_url}/@@inspect-relations"\n+    visible="True"\n+    i18n:attributes="title">\n+  <permission>Inspect Relations</permission>\n+ </configlet>\n </object>\ndiff --git a/Products/CMFPlone/profiles/default/metadata.xml b/Products/CMFPlone/profiles/default/metadata.xml\nindex bf392ac8e1..a51ef8dc57 100644\n--- a/Products/CMFPlone/profiles/default/metadata.xml\n+++ b/Products/CMFPlone/profiles/default/metadata.xml\n@@ -1,4 +1,4 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>6000</version>\n+  <version>6007</version>\n </metadata>\ndiff --git a/Products/CMFPlone/profiles/default/skins.xml b/Products/CMFPlone/profiles/default/skins.xml\nindex b8be444eff..4dd376ef0a 100644\n--- a/Products/CMFPlone/profiles/default/skins.xml\n+++ b/Products/CMFPlone/profiles/default/skins.xml\n@@ -3,24 +3,15 @@\n    cookie_persistence="False" default_skin="Plone Default"\n    request_varname="plone_skin">\n  <object name="custom" meta_type="Folder"/>\n- <object name="plone_form_scripts" meta_type="Filesystem Directory View"\n-    directory="Products.CMFPlone:skins/plone_form_scripts"/>\n  <object name="plone_images" meta_type="Filesystem Directory View"\n     directory="Products.CMFPlone:skins/plone_images"/>\n- <object name="plone_prefs" meta_type="Filesystem Directory View"\n-    directory="Products.CMFPlone:skins/plone_prefs"/>\n  <object name="plone_scripts" meta_type="Filesystem Directory View"\n     directory="Products.CMFPlone:skins/plone_scripts"/>\n- <object name="plone_templates" meta_type="Filesystem Directory View"\n-    directory="Products.CMFPlone:skins/plone_templates"/>\n  <object name="plone_wysiwyg" meta_type="Filesystem Directory View"\n     directory="Products.CMFPlone:skins/plone_wysiwyg"/>\n  <skin-path name="Plone Default">\n   <layer name="custom"/>\n   <layer name="plone_wysiwyg"/>\n-  <layer name="plone_prefs"/>\n-  <layer name="plone_templates"/>\n-  <layer name="plone_form_scripts"/>\n   <layer name="plone_scripts"/>\n   <layer name="plone_images"/>\n  </skin-path>\ndiff --git a/Products/CMFPlone/profiles/default/types.xml b/Products/CMFPlone/profiles/default/types.xml\nindex 93d91d8054..324c5fa186 100644\n--- a/Products/CMFPlone/profiles/default/types.xml\n+++ b/Products/CMFPlone/profiles/default/types.xml\n@@ -3,7 +3,6 @@\n  <property\n     name="title">Controls the available content types in your portal</property>\n  <object name="Discussion Item" meta_type="Factory-based Type Information"/>\n- <object name="Plone Site"\n-    meta_type="Factory-based Type Information with dynamic views"/>\n  <object name="TempFolder" meta_type="Factory-based Type Information"/>\n+ <object name="Plone Site" meta_type="Dexterity FTI" />\n </object>\ndiff --git a/Products/CMFPlone/profiles/default/types/Plone_Site.xml b/Products/CMFPlone/profiles/default/types/Plone_Site.xml\nindex 8cdc3035c2..b89fca2444 100644\n--- a/Products/CMFPlone/profiles/default/types/Plone_Site.xml\n+++ b/Products/CMFPlone/profiles/default/types/Plone_Site.xml\n@@ -1,34 +1,86 @@\n <?xml version="1.0"?>\n-<object name="Plone Site"\n-   meta_type="Factory-based Type Information with dynamic views"\n-   i18n:domain="plone" xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n- <property name="title" i18n:translate=""></property>\n- <property name="description"\n-      i18n:translate="">The root object in a Plone site.</property>\n- <property name="icon_expr"></property>\n- <property name="content_meta_type">Plone Site</property>\n- <property name="product">CMFPlone</property>\n- <property name="factory">manage_addSite</property>\n- <property name="immediate_view">folder_listing</property>\n- <property name="global_allow">False</property>\n- <property name="filter_content_types">False</property>\n- <property name="allowed_content_types"/>\n- <property name="allow_discussion">False</property>\n- <property name="default_view">folder_listing</property>\n- <property name="view_methods">\n-  <element value="folder_listing"/>\n-  <element value="folder_summary_view"/>\n-  <element value="folder_full_view"/>\n-  <element value="folder_tabular_view"/>\n-  <element value="atct_album_view"/>\n- </property>\n+<object\n+    i18n:domain="plone"\n+    meta_type="Dexterity FTI"\n+    name="Plone Site"\n+    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n+\n+  <!-- Basic properties -->\n+  <property\n+      i18n:translate=""\n+      name="title">Plone Site</property>\n+  <property\n+      i18n:translate=""\n+      name="description"></property>\n+\n+  <property name="allow_discussion">False</property>\n+  <property name="factory">manage_addSite</property>\n+  <property name="icon_expr"></property>\n+  <property name="link_target"></property>\n+\n+  <!-- Hierarchy control -->\n+  <property name="allowed_content_types"/>\n+  <property name="filter_content_types">False</property>\n+  <property name="global_allow">False</property>\n+\n+  <!-- Schema, class and security -->\n+  <property name="add_permission">cmf.AddPortalContent</property>\n+  <property name="klass">Products.CMFPlone.Portal.PloneSite</property>\n+  <property name="model_file">plone.app.contenttypes.schema:folder.xml</property>\n+  <property name="model_source"></property>\n+  <property name="schema"></property>\n+\n+  <!-- Enabled behaviors -->\n+  <property name="behaviors" purge="false">\n+    <element value="plone.dublincore" />\n+    <element value="plone.richtext" />\n+    <element value="plone.relateditems" />\n+    <element value="plone.locking" />\n+    <element value="plone.allowdiscussion" />\n+    <element value="plone.excludefromnavigation" />\n+    <element value="plone.tableofcontents" />\n+  </property>\n+\n+  <!-- View information -->\n+  <property name="add_view_expr">string:${folder_url}/addPlone Site</property>\n+  <property name="default_view">listing_view</property>\n+  <property name="default_view_fallback">False</property>\n+  <property name="immediate_view">view</property>\n+  <property name="view_methods">\n+    <element value="album_view"/>\n+    <element value="event_listing"/>\n+    <element value="full_view"/>\n+    <element value="listing_view"/>\n+    <element value="summary_view"/>\n+    <element value="tabular_view"/>\n+  </property>\n+\n+  <!-- Method aliases -->\n  <alias from="(Default)" to="(dynamic view)"/>\n- <alias from="edit" to="@@site-controlpanel"/>\n+ <alias from="edit" to="@@edit"/>\n  <alias from="sharing" to="@@sharing"/>\n  <alias from="view" to="(selected layout)"/>\n- <action title="View" action_id="view" category="object" condition_expr=""\n-    url_expr="string:${object_url}" visible="True"\n+ <action\n+    title="View"\n+    action_id="view"\n+    category="object"\n+    condition_expr=""\n+    url_expr="string:${object_url}"\n+    icon_expr="string:toolbar-action/view"\n+    visible="True"\n     i18n:attributes="title">\n   <permission value="View"/>\n  </action>\n+ <action\n+    action_id="edit"\n+    category="object"\n+    condition_expr="not:object/@@plone_lock_info/is_locked_for_current_user|python:True"\n+    i18n:attributes="title"\n+    title="Edit"\n+    url_expr="string:${object_url}/edit"\n+    icon_expr="string:toolbar-action/edit"\n+    visible="True">\n+  <permission value="Modify portal content"/>\n+ </action>\n+\n </object>\ndiff --git a/Products/CMFPlone/profiles/default/viewlets.xml b/Products/CMFPlone/profiles/default/viewlets.xml\nindex 77d0fb445c..5622b3eb67 100644\n--- a/Products/CMFPlone/profiles/default/viewlets.xml\n+++ b/Products/CMFPlone/profiles/default/viewlets.xml\n@@ -1,13 +1,16 @@\n <?xml version="1.0"?>\n <object>\n   <order manager="plone.portaltop" skinname="Plone Default">\n-    <viewlet name="plone.header" />\n+\n   </order>\n   <order manager="plone.portalheader" skinname="Plone Default">\n+    <viewlet name="plone.anontools" />\n+    <viewlet name="plone.membertools" />\n     <viewlet name="plone.logo" />\n+    <viewlet name="plone.favicon" />\n     <viewlet name="plone.searchbox" />\n-    <viewlet name="plone.anontools" />\n     <viewlet name="plone.app.i18n.locales.languageselector" />\n+    <viewlet name="plone.app.multilingual.languageselector" />\n   </order>\n   <order manager="plone.mainnavigation" skinname="Plone Default">\n     <viewlet name="plone.global_sections" />\n@@ -19,11 +22,13 @@\n     <viewlet name="plone.contentviews" />\n   </order>\n   <order manager="plone.belowcontentbody" skinname="Plone Default">\n+    <viewlet name="plone.contributors" />\n+    <viewlet name="plone.rights" />\n+    <viewlet name="plone.keywords" />\n     <viewlet name="plone.belowcontentbody.relateditems" />\n-    <viewlet name="plone.abovecontenttitle.documentactions" />\n   </order>\n   <order manager="plone.belowcontent" skinname="Plone Default">\n-    <viewlet name="plone.belowcontenttitle.keywords" />\n+    <viewlet name="plone.documentactions" />\n     <viewlet name="plone.nextprevious" />\n   </order>\n   <order manager="plone.portalfooter" skinname="Plone Default">\ndiff --git a/Products/CMFPlone/profiles/dependencies/controlpanel.xml b/Products/CMFPlone/profiles/dependencies/controlpanel.xml\ndeleted file mode 100644\nindex 6b849c2806..0000000000\n--- a/Products/CMFPlone/profiles/dependencies/controlpanel.xml\n+++ /dev/null\n@@ -1,17 +0,0 @@\n-<?xml version="1.0"?>\n-<object name="portal_controlpanel"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n" i18n:domain="plone">\n- <configlet title="Image Handling" action_id="ImagingSettings" appId="ImagingSettings"\n-    category="plone-content" condition_expr=""\n-    url_expr="string:${portal_url}/@@imaging-controlpanel" visible="False"\n-    i18n:attributes="title">\n-  <permission>Plone Site Setup: Imaging</permission>\n- </configlet>\n- <configlet title="Image Handling" action_id="ImagingSettings" appId="ImagingSettings"\n-    category="plone-content" condition_expr=""\n-    icon_expr="string:$portal_url/image_icon.png"\n-    url_expr="string:${portal_url}/@@imaging-controlpanel" visible="True"\n-    i18n:attributes="title">\n-  <permission>Plone Site Setup: Imaging</permission>\n- </configlet>\n-</object>\ndiff --git a/Products/CMFPlone/profiles/dependencies/metadata.xml b/Products/CMFPlone/profiles/dependencies/metadata.xml\nindex b9f1997dcd..af29290c27 100644\n--- a/Products/CMFPlone/profiles/dependencies/metadata.xml\n+++ b/Products/CMFPlone/profiles/dependencies/metadata.xml\n@@ -2,7 +2,6 @@\n <metadata>\n   <version>4</version>\n   <dependencies>\n-    <dependency>profile-Products.CMFFormController:CMFFormController</dependency>\n     <dependency>profile-Products.MimetypesRegistry:MimetypesRegistry</dependency>\n     <dependency>profile-Products.PortalTransforms:PortalTransforms</dependency>\n     <dependency>profile-Products.CMFEditions:CMFEditions</dependency>\ndiff --git a/Products/CMFPlone/profiles/dependencies/registry.xml b/Products/CMFPlone/profiles/dependencies/registry.xml\nindex b03d081331..a2868d12c5 100644\n--- a/Products/CMFPlone/profiles/dependencies/registry.xml\n+++ b/Products/CMFPlone/profiles/dependencies/registry.xml\n@@ -18,6 +18,8 @@\n            prefix="plone" />\n   <records interface="Products.CMFPlone.interfaces.ISiteSchema"\n            prefix="plone" />\n+  <records interface="Products.CMFPlone.interfaces.ITinyMCESchema"\n+           prefix="plone" />\n   <records interface="Products.CMFPlone.interfaces.IDateAndTimeSchema"\n            prefix="plone" />\n   <records interface="Products.CMFPlone.interfaces.IMarkupSchema"\n@@ -89,85 +91,11 @@\n   <record name="plone.resources.development">\n     <field type="plone.registry.field.Bool">\n       <title>Frontend development mode</title>\n+      <required>False</required>\n     </field>\n     <value>False</value>\n   </record>\n \n-  <!-- Plone generated resources -->\n-  <record name="plone.resources.configjs">\n-    <field type="plone.registry.field.ASCII">\n-      <title>config.js</title>\n-    </field>\n-    <value>config.js</value>\n-  </record>\n-  <record name="plone.resources.less-modify">\n-    <field type="plone.registry.field.ASCII">\n-      <title>less-modify js</title>\n-    </field>\n-    <value>less-modify.js</value>\n-  </record>\n-  <record name="plone.resources.less-variables">\n-      <field type="plone.registry.field.ASCII">\n-        <title>LESS variables js definer</title>\n-      </field>\n-      <value key="js">less-variables.js</value>\n-  </record>\n-\n-  <!-- Mixins vars for less with the paths -->\n-  <record name="plone.lessvariables">\n-    <field type="plone.registry.field.Dict">\n-      <title>Less variables</title>\n-      <description>Variables that are going to be compiled on less</description>\n-      <key_type type="plone.registry.field.ASCIILine" />\n-      <value_type type="plone.registry.field.TextLine" />\n-    </field>\n-    <value>\n-      <element key="icon-font-path">\\"../fonts/\\"</element>\n-      <element key="bowerPath">\\"{site_url}/++plone++static/components/\\"</element>\n-      <element key="mockupPath">\\"{site_url}/++resource++mockup/\\"</element>\n-      <element key="mockuplessPath">\\"{site_url}/++resource++mockupless/\\"</element>\n-\n-      <element key="plone-link-color">rgba(0,123,179,1)</element>\n-      <element key="plone-gray-lighter">lighten(#000, 80%)</element>\n-      <element key="plone-gray-light">lighten(#000, 46.5%)</element>\n-\n-      <element key="plone-toolbar-bg">rgba(0,0,0,.9)</element>\n-      <element key="plone-toolbar-submenu-bg">rgba(45,45,45,.96)</element>\n-      <element key="plone-toolbar-submenu-width">180px</element>\n-      <element key="plone-toolbar-font-primary">Roboto, \\"Helvetica Neue\\", Helvetica, Arial, sans-serif</element>\n-      <element key="plone-toolbar-font-secondary">Roboto, \\"Helvetica Neue\\", Helvetica, Arial, sans-serif</element>\n-      <element key="plone-toolbar-separator-color">rgba(255,255,255,.17)</element>\n-      <element key="plone-toolbar-link">{plone-link-color}</element>\n-      <element key="plone-toolbar-text-color">rgba(255,255,255,1)</element>\n-      <element key="plone-toolbar-submenu-text-color">lighten(#000, 90%)</element>\n-      <element key="plone-toolbar-submenu-header-color">lighten(#000, 80%)</element>\n-      <element key="plone-toolbar-published-color">{plone-link-color}</element>\n-      <element key="plone-toolbar-draft-color">rgb(250,184,42)</element>\n-      <element key="plone-toolbar-pending-color">rgb(226,231,33)</element>\n-      <element key="plone-toolbar-private-color">rgb(196,24,60)</element>\n-      <element key="plone-toolbar-internal-color">rgb(250,184,42)</element>\n-      <element key="plone-toolbar-internally-published-color">rgb(136,61,250)</element>\n-\n-      <element key="plone-screen-xs-min">480px</element>\n-      <element key="plone-screen-sm-min">768px</element>\n-      <element key="plone-screen-md-min">992px</element>\n-      <element key="plone-screen-lg-min">1200px</element>\n-\n-      <element key="plone-left-toolbar-expanded">120px</element>\n-      <element key="plone-left-toolbar">60px</element>\n-\n-      <element key="plone-container-sm">750px</element>\n-      <element key="plone-container-md">970px</element>\n-      <element key="plone-container-lg">1170px</element>\n-\n-      <element key="plone-screen-xs-max">(@plone-screen-sm-min - 1)</element>\n-      <element key="plone-screen-sm-max">(@plone-screen-md-min - 1)</element>\n-      <element key="plone-screen-md-max">(@plone-screen-lg-min - 1)</element>\n-\n-    </value>\n-  </record>\n-\n-\n   <record name="plone.patternoptions">\n     <field type="plone.registry.field.Dict">\n       <title>Patterns configuration</title>\ndiff --git a/Products/CMFPlone/relationhelper.py b/Products/CMFPlone/relationhelper.py\nnew file mode 100644\nindex 0000000000..da92cccb97\n--- /dev/null\n+++ b/Products/CMFPlone/relationhelper.py\n@@ -0,0 +1,325 @@\n+from collections import Counter\n+from collections import defaultdict\n+from five.intid.intid import addIntIdSubscriber\n+from plone.app.linkintegrity.handlers import modifiedContent\n+from plone.app.linkintegrity.utils import referencedRelationship\n+from plone.app.relationfield.event import update_behavior_relations\n+from plone.app.uuid.utils import uuidToObject\n+from plone.dexterity.interfaces import IDexterityContent\n+from plone.dexterity.utils import iterSchemataForType\n+from Products.CMFCore.interfaces import IContentish\n+from Products.CMFPlone import PloneMessageFactory as _\n+from z3c.relationfield import event\n+from z3c.relationfield import RelationValue\n+from z3c.relationfield.event import updateRelations\n+from z3c.relationfield.schema import Relation\n+from z3c.relationfield.schema import RelationChoice\n+from z3c.relationfield.schema import RelationList\n+from zc.relation.interfaces import ICatalog\n+from zope.annotation.interfaces import IAnnotations\n+from zope.component import getUtility\n+from zope.component import queryUtility\n+from zope.component.hooks import getSite\n+from zope.intid.interfaces import IIntIds\n+from zope.intid.interfaces import ObjectMissingError\n+\n+import logging\n+import pkg_resources\n+\n+try:\n+    # "iterate" is not a dependency of CMFPlone, but a consumer of it\n+    pkg_resources.get_distribution("plone.app.iterate")\n+except pkg_resources.DistributionNotFound:\n+    HAS_ITERATE = False\n+else:\n+    HAS_ITERATE = True\n+    from plone.app.iterate.dexterity import ITERATE_RELATION_NAME\n+    from plone.app.iterate.dexterity.relation import StagingRelationValue\n+\n+\n+logger = logging.getLogger(__name__)\n+\n+RELATIONS_KEY = \'ALL_REFERENCES\'\n+\n+\n+def rebuild_relations(context=None, flush_and_rebuild_intids=False):\n+    store_relations()\n+    purge_relations()\n+    if flush_and_rebuild_intids:\n+        flush_intids()\n+        rebuild_intids()\n+    else:\n+        cleanup_intids()\n+    restore_relations()\n+\n+\n+def get_relations_stats():\n+    info = defaultdict(int)\n+    broken = defaultdict(int)\n+    relation_catalog = getUtility(ICatalog)\n+    for token in relation_catalog.findRelationTokens():\n+        try:\n+            rel = relation_catalog.resolveRelationToken(token)\n+        except ObjectMissingError:\n+            broken[\'Object is missing\'] += 1\n+            logger.info(\'Token {} has no object.\'.format(token))\n+            continue\n+\n+        if rel.isBroken():\n+            broken[rel.from_attribute] += 1\n+        else:\n+            info[rel.from_attribute] += 1\n+    return info, broken\n+\n+\n+def get_all_relations():\n+    """Get all data from zc.relation catalog.\n+    Logs some useful statistics.\n+    """\n+    results = []\n+    info = defaultdict(int)\n+\n+    relation_catalog = getUtility(ICatalog)\n+    for token in relation_catalog.findRelationTokens():\n+        try:\n+            rel = relation_catalog.resolveRelationToken(token)\n+        except ObjectMissingError:\n+            logger.info(\'Token {} has no object.\'.format(token))\n+            continue\n+\n+        if rel.from_object and rel.to_object:\n+            try:\n+                results.append({\n+                    \'from_uuid\': rel.from_object.UID(),\n+                    \'to_uuid\': rel.to_object.UID(),\n+                    \'from_attribute\': rel.from_attribute,\n+                })\n+                info[rel.from_attribute] += 1\n+            except AttributeError as ex:\n+                logger.info(f\'Something went wrong while storing {rel}: \\n {ex}\')\n+        else:\n+            logger.info(f\'Dropping relation {rel.from_attribute} from {rel.from_object} to {rel.to_object}\')\n+    msg = \'\'\n+    for key, value in info.items():\n+        msg += f\'{key}: {value}\\n\'\n+    logger.info(f\'\\nFound the following relations:\\n{msg}\')\n+    return results\n+\n+\n+def store_relations(context=None):\n+    """Store all relations in a annotation on the portal.\n+    """\n+    all_relations = get_all_relations()\n+    portal = getSite()\n+    IAnnotations(portal)[RELATIONS_KEY] = all_relations\n+    logger.info(f\'Stored {len(all_relations)} relations on the portal\')\n+\n+\n+def purge_relations(context=None):\n+    """Removes all entries form zc.relation catalog.\n+    RelationValues that were set as attribute on content are still there!\n+    These are removed/overwritten when restoring the relations.\n+    """\n+    rel_catalog = getUtility(ICatalog)\n+    rel_catalog.clear()\n+    logger.info(\'Purged zc.relation catalog\')\n+\n+\n+def restore_relations(context=None, all_relations=None):\n+    """Restore relations from a annotation on the portal.\n+    """\n+\n+    portal = getSite()\n+    if all_relations is None:\n+        all_relations = IAnnotations(portal)[RELATIONS_KEY]\n+    logger.info(f\'Loaded {len(all_relations)} relations to restore\')\n+    update_linkintegrity = set()\n+    modified_items = set()\n+    modified_relation_lists = defaultdict(list)\n+\n+    # remove duplicates but keep original order\n+    unique_relations = []\n+    seen = set()\n+    seen_add = seen.add\n+    for rel in all_relations:\n+        hashable = tuple(rel.items())\n+        if hashable not in seen:\n+            unique_relations.append(rel)\n+            seen_add(hashable)\n+        else:\n+            logger.info(f\'Dropping duplicate: {hashable}\')\n+\n+    if len(unique_relations) < len(all_relations):\n+        logger.info(f\'Dropping {len(all_relations) - len(unique_relations)} duplicates\')\n+        all_relations = unique_relations\n+\n+    intids = getUtility(IIntIds)\n+    for index, item in enumerate(all_relations, start=1):\n+        if not index % 500:\n+            logger.info(f\'Restored {index} of {len(all_relations)} relations...\')\n+\n+        try:\n+            source_obj = uuidToObject(item[\'from_uuid\'])\n+        except KeyError:\n+            # brain exists but no object\n+            source_obj = None\n+        try:\n+            target_obj = uuidToObject(item[\'to_uuid\'])\n+        except KeyError:\n+            # brain exists but no object\n+            target_obj = None\n+\n+        if not source_obj:\n+            logger.info(f\'{item["from_uuid"]} is missing\')\n+            continue\n+\n+        if not target_obj:\n+            logger.info(f\'{item["to_uuid"]} is missing\')\n+            continue\n+\n+        if not IDexterityContent.providedBy(source_obj):\n+            logger.info(f\'{source_obj} is no dexterity content\')\n+            continue\n+\n+        if not IDexterityContent.providedBy(target_obj):\n+            logger.info(f\'{target_obj} is no dexterity content\')\n+            continue\n+\n+        from_attribute = item[\'from_attribute\']\n+        try:\n+            to_id = intids.getId(target_obj)\n+        except KeyError as e:\n+            logger.warning(f\'No intid for {target_obj}\')\n+            continue\n+\n+        if from_attribute == referencedRelationship:\n+            # Ignore linkintegrity for now. We\'ll rebuilt it at the end!\n+            update_linkintegrity.add(item[\'from_uuid\'])\n+            continue\n+\n+        if HAS_ITERATE and from_attribute == ITERATE_RELATION_NAME:\n+            # Iterate relations are not set as values of fields\n+            relation = StagingRelationValue(to_id)\n+            event._setRelation(source_obj, ITERATE_RELATION_NAME, relation)\n+            continue\n+\n+        field_and_schema = get_field_and_schema_for_fieldname(from_attribute, source_obj.portal_type)\n+        if field_and_schema is None:\n+            # the from_attribute is no field\n+            logger.info(f\'No field. Setting relation: {item}\')\n+            event._setRelation(source_obj, from_attribute, RelationValue(to_id))\n+            continue\n+\n+        field, schema = field_and_schema\n+        relation = RelationValue(to_id)\n+\n+        if isinstance(field, RelationList):\n+            logger.info(f\'Add relation to relationslist {from_attribute} from {source_obj.absolute_url()} to {target_obj.absolute_url()}\')\n+            if item[\'from_uuid\'] in modified_relation_lists.get(from_attribute, []):\n+                # Do not purge relations\n+                existing_relations = getattr(source_obj, from_attribute, [])\n+            else:\n+                # First touch. Make sure we purge!\n+                existing_relations = []\n+            existing_relations.append(relation)\n+            setattr(source_obj, from_attribute, existing_relations)\n+            modified_items.add(item[\'from_uuid\'])\n+            modified_relation_lists[from_attribute].append(item[\'from_uuid\'])\n+            continue\n+\n+        elif isinstance(field, (Relation, RelationChoice)):\n+            logger.info(f\'Add relation {from_attribute} from {source_obj.absolute_url()} to {target_obj.absolute_url()}\')\n+            setattr(source_obj, from_attribute, relation)\n+            modified_items.add(item[\'from_uuid\'])\n+            continue\n+\n+        else:\n+            # we should never end up here!\n+            logger.warn(f\'Unexpected relation {from_attribute} from {source_obj.absolute_url()} to {target_obj.absolute_url()}\')\n+\n+    update_linkintegrity = set(update_linkintegrity)\n+    logger.info(f\'Updating linkintegrity for {len(update_linkintegrity)} items\')\n+    for uuid in sorted(update_linkintegrity):\n+        modifiedContent(uuidToObject(uuid), None)\n+    logger.info(f\'Updating relations for {len(modified_items)} items\')\n+    for uuid in sorted(modified_items):\n+        obj = uuidToObject(uuid)\n+        # updateRelations from z3c.relationfield does not properly update relations in behaviors\n+        # that are registered with a marker-interface.\n+        # update_behavior_relations (from plone.app.relationfield) does that but does not update\n+        # those in the main schema. Duh!\n+        updateRelations(obj, None)\n+        update_behavior_relations(obj, None)\n+\n+    # purge annotation from portal if they exist\n+    if RELATIONS_KEY in IAnnotations(portal):\n+        del IAnnotations(portal)[RELATIONS_KEY]\n+    logger.info(\'Done!\')\n+\n+\n+def get_intid(obj):\n+    """Intid from intid-catalog"""\n+    intids = queryUtility(IIntIds)\n+    if intids is None:\n+        return\n+    # check that the object has an intid, otherwise there\'s nothing to be done\n+    try:\n+        return intids.getId(obj)\n+    except KeyError:  # noqa\n+        # The object has not been added to the ZODB yet\n+        return\n+\n+\n+def get_field_and_schema_for_fieldname(field_id, portal_type):\n+    """Get field and its schema from a portal_type.\n+    """\n+    # Turn form.widgets.IDublinCore.title into title\n+    field_id = field_id.split(\'.\')[-1]\n+    for schema in iterSchemataForType(portal_type):\n+        field = schema.get(field_id, None)\n+        if field is not None:\n+            return (field, schema)\n+\n+\n+def cleanup_intids(context=None):\n+    intids = getUtility(IIntIds)\n+    all_refs = [f\'{i.object.__class__.__module__}.{i.object.__class__.__name__}\'\n+                for i in intids.refs.values()]\n+    logger.info(Counter(all_refs))\n+\n+    count = 0\n+    refs = [i for i in intids.refs.values() if isinstance(i.object, RelationValue)]\n+    for ref in refs:\n+        intids.unregister(ref)\n+        count += 1\n+    logger.info(f\'Removed all {count} RelationValues from IntId-tool\')\n+\n+    count = 0\n+    for ref in intids.refs.values():\n+        if \'broken\' in repr(ref.object):\n+            intids.unregister(ref)\n+    logger.info(f\'Removed {count} broken refs from IntId-tool\')\n+    all_refs = [\'{i.object.__class__.__module__}.{i.object.__class__.__name__}\'\n+                for i in intids.refs.values()]\n+    logger.info(Counter(all_refs))\n+\n+\n+def flush_intids():\n+    """ Flush all intids\n+    """\n+    intids = getUtility(IIntIds)\n+    intids.ids = intids.family.OI.BTree()\n+    intids.refs = intids.family.IO.BTree()\n+\n+\n+def rebuild_intids():\n+    """ Create new intids\n+    """\n+    def add_to_intids(obj, path):\n+        if IContentish.providedBy(obj):\n+            logger.info(f\'Added {obj} at {path} to intid\')\n+            addIntIdSubscriber(obj, None)\n+    portal = getSite()\n+    portal.ZopeFindAndApply(portal,\n+                            search_sub=True,\n+                            apply_func=add_to_intids)\ndiff --git a/Products/CMFPlone/resources/__init__.py b/Products/CMFPlone/resources/__init__.py\nindex 7d97e51ad5..092fcafe89 100644\n--- a/Products/CMFPlone/resources/__init__.py\n+++ b/Products/CMFPlone/resources/__init__.py\n@@ -1,40 +1,32 @@\n+from zope.deprecation import deprecate\n+\n import os\n \n \n-RESOURCE_DEVELOPMENT_MODE = os.getenv(\'FEDEV\', \'\').lower() == \'true\'\n+RESOURCE_DEVELOPMENT_MODE = os.getenv("FEDEV", "").lower() == "true"\n \n \n+@deprecate(\n+    "Adding single resources is no longer supported in Plone 6, use \'add_bundle_on_request\' instead"\n+)\n def add_resource_on_request(request, resource):\n-    """ Adds the resource to the request\n-    """\n-    if not isinstance(resource, str):\n-        raise ValueError(\n-            \'add_resource_on_request expects a string value for resource\'\n-        )\n-    request.enabled_resources = getattr(request, \'enabled_resources\', [])\n-    if resource not in request.enabled_resources:\n-        request.enabled_resources.append(resource)\n+    """(DEPRECATED) Adds the resource to the request."""\n+    return\n \n \n def add_bundle_on_request(request, bundle):\n-    """ Adds the bundle to the request\n-    """\n+    """Adds the bundle to the request."""\n     if not isinstance(bundle, str):\n-        raise ValueError(\n-            \'add_bundle_on_request expects a string value for bundle\'\n-        )\n-    request.enabled_bundles = getattr(request, \'enabled_bundles\', [])\n+        raise ValueError("add_bundle_on_request expects a string value for bundle")\n+    request.enabled_bundles = getattr(request, "enabled_bundles", [])\n     if bundle not in request.enabled_bundles:\n         request.enabled_bundles.append(bundle)\n \n \n def remove_bundle_on_request(request, bundle):\n-    """ Removes the bundle to the request\n-    """\n+    """Removes the bundle to the request."""\n     if not isinstance(bundle, str):\n-        raise ValueError(\n-            \'remove_bundle_on_request expects a string value for bundle\'\n-        )\n-    request.disabled_bundles = getattr(request, \'disabled_bundles\', [])\n+        raise ValueError("remove_bundle_on_request expects a string value for bundle")\n+    request.disabled_bundles = getattr(request, "disabled_bundles", [])\n     if bundle not in request.disabled_bundles:\n         request.disabled_bundles.append(bundle)\ndiff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py\nindex 1e842a10b9..58585b14f7 100644\n--- a/Products/CMFPlone/resources/browser/combine.py\n+++ b/Products/CMFPlone/resources/browser/combine.py\n@@ -1,182 +1,10 @@\n-from Acquisition import aq_base\n-from datetime import datetime\n-from io import BytesIO\n-from plone.registry.interfaces import IRegistry\n-from plone.resource.file import FilesystemFile\n-from plone.resource.interfaces import IResourceDirectory\n-from Products.CMFPlone.interfaces import IBundleRegistry\n-from Products.CMFPlone.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME  # noqa\n-from zExceptions import NotFound\n-from zope.component import getUtility\n-from zope.component import queryUtility\n+import zope.deferredimport\n \n-import logging\n-import re\n \n+zope.deferredimport.initialize()\n \n-PRODUCTION_RESOURCE_DIRECTORY = \'production\'\n-logger = logging.getLogger(__name__)\n-\n-\n-def get_production_resource_directory():\n-    persistent_directory = queryUtility(IResourceDirectory, name=\'persistent\')\n-    if persistent_directory is None:\n-        return \'\'\n-    container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-    try:\n-        production_folder = container[PRODUCTION_RESOURCE_DIRECTORY]\n-    except NotFound:\n-        return \'%s/++unique++1\' % PRODUCTION_RESOURCE_DIRECTORY\n-    if \'timestamp.txt\' not in production_folder:\n-        return \'%s/++unique++1\' % PRODUCTION_RESOURCE_DIRECTORY\n-    timestamp = production_folder.readFile(\'timestamp.txt\')\n-    if isinstance(timestamp, bytes):\n-        timestamp = timestamp.decode()\n-    return \'{}/++unique++{}\'.format(\n-        PRODUCTION_RESOURCE_DIRECTORY, timestamp)\n-\n-\n-def get_resource(context, path):\n-    if path.startswith(\'++plone++\'):\n-        # ++plone++ resources can be customized, we return their override\n-        # value if any\n-        overrides = get_override_directory(context)\n-        filepath = path[9:]\n-        if overrides.isFile(filepath):\n-            return overrides.readFile(filepath)\n-\n-    try:\n-        resource = context.unrestrictedTraverse(path)\n-    except (NotFound, AttributeError):\n-        logger.warning(f\'Could not find resource {path}. You may have to create it first.\')  # noqa\n-        return\n-\n-    if isinstance(resource, FilesystemFile):\n-        (directory, sep, filename) = path.rpartition(\'/\')\n-        return context.unrestrictedTraverse(directory).readFile(filename)\n-\n-    # calling the resource may modify the header, i.e. the content-type.\n-    # we do not want this, so keep the original header intact.\n-    response_before = context.REQUEST.response\n-    context.REQUEST.response = response_before.__class__()\n-    if hasattr(aq_base(resource), \'GET\'):\n-        # for FileResource\n-        result = resource.GET()\n-    else:\n-        # any BrowserView\n-        result = resource()\n-    context.REQUEST.response = response_before\n-    return result\n-\n-\n-def write_js(context, folder, meta_bundle):\n-    registry = getUtility(IRegistry)\n-    resources = []\n-\n-    # default resources\n-    if (\n-        meta_bundle == \'default\' and\n-        registry.records.get(\'plone.resources/jquery.js\')\n-    ):\n-        resources.append(\n-            get_resource(\n-                context,\n-                registry.records[\'plone.resources/jquery.js\'].value\n-            )\n-        )\n-        resources.append(\n-            get_resource(\n-                context,\n-                registry.records[\'plone.resources.requirejs\'].value\n-            )\n-        )\n-        resources.append(\n-            get_resource(\n-                context,\n-                registry.records[\'plone.resources.configjs\'].value\n-            )\n-        )\n-\n-    # bundles\n-    bundles = registry.collectionOfInterface(\n-        IBundleRegistry,\n-        prefix=\'plone.bundles\',\n-        check=False\n-    )\n-    for bundle in bundles.values():\n-        if bundle.merge_with == meta_bundle and bundle.jscompilation:\n-            resource = get_resource(context, bundle.jscompilation)\n-            if not resource:\n-                continue\n-            resources.append(resource)\n-\n-    fi = BytesIO()\n-    for script in resources:\n-        if not isinstance(script, bytes):\n-            script = script.encode()\n-        fi.write(script + b\'\\n\')\n-    folder.writeFile(meta_bundle + \'.js\', fi)\n-    logger.info(\'Wrote combined JS bundle "%s".\' % meta_bundle)\n-\n-\n-def write_css(context, folder, meta_bundle):\n-    registry = getUtility(IRegistry)\n-    resources = []\n-\n-    bundles = registry.collectionOfInterface(\n-        IBundleRegistry,\n-        prefix=\'plone.bundles\',\n-        check=False\n-    )\n-    for bundle in bundles.values():\n-        if bundle.merge_with == meta_bundle and bundle.csscompilation:\n-            css = get_resource(context, bundle.csscompilation)\n-            if not css:\n-                continue\n-            (path, sep, filename) = bundle.csscompilation.rpartition(\'/\')\n-            # Process relative urls:\n-            # we prefix with current resource path any url not starting with\n-            # \'/\' or http: or data:\n-            if not isinstance(path, bytes):\n-                path = path.encode()\n-            css = re.sub(\n-                br"""(url\\([\'"]?(?![\'"]?([a-z]+:|\\/)))""",\n-                br\'\\1%s/\' % path,\n-                css)\n-            resources.append(css)\n-\n-    fi = BytesIO()\n-    for script in resources:\n-        if not isinstance(script, bytes):\n-            script = script.encode()\n-        fi.write(script + b\'\\n\')\n-    folder.writeFile(meta_bundle + \'.css\', fi)\n-    logger.info(\'Wrote combined CSS bundle "%s".\' % meta_bundle)\n-\n-\n-def get_override_directory(context):\n-    persistent_directory = queryUtility(IResourceDirectory, name=\'persistent\')\n-    if persistent_directory is None:\n-        return\n-    if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:\n-        persistent_directory.makeDirectory(OVERRIDE_RESOURCE_DIRECTORY_NAME)\n-    return persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-\n-\n-def combine_bundles(context):\n-    container = get_override_directory(context)\n-    if PRODUCTION_RESOURCE_DIRECTORY not in container:\n-        container.makeDirectory(PRODUCTION_RESOURCE_DIRECTORY)\n-    production_folder = container[PRODUCTION_RESOURCE_DIRECTORY]\n-\n-    # store timestamp\n-    fi = BytesIO()\n-    fi.write(datetime.now().isoformat().encode())\n-    production_folder.writeFile(\'timestamp.txt\', fi)\n-\n-    # generate new combined bundles\n-    write_js(context, production_folder, \'default\')\n-    write_js(context, production_folder, \'logged-in\')\n-    write_css(context, production_folder, \'default\')\n-    write_css(context, production_folder, \'logged-in\')\n-    logger.info(\'Finished bundle compilation.\')\n+zope.deferredimport.deprecated(\n+    "Import from Products.CMFPlone.resources.utils instead",\n+    PRODUCTION_RESOURCE_DIRECTORY="Products.CMFPlone:resources.utils.PRODUCTION_RESOURCE_DIRECTORY",\n+    get_override_directory="Products.CMFPlone:resources.utils.get_override_directory",\n+)\ndiff --git a/Products/CMFPlone/resources/browser/configjs.py b/Products/CMFPlone/resources/browser/configjs.py\ndeleted file mode 100644\nindex 25c5fb134a..0000000000\n--- a/Products/CMFPlone/resources/browser/configjs.py\n+++ /dev/null\n@@ -1,96 +0,0 @@\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import IResourceRegistry\n-from Products.Five.browser import BrowserView\n-from zope.component import getUtility\n-\n-import json\n-import re\n-\n-\n-configjs = """requirejs.config({\n-    baseUrl: PORTAL_URL,\n-    paths: %s,\n-    shim: %s,\n-    optimize: \'uglify\',\n-    wrapShim: true\n-});"""\n-\n-\n-def _format_shims(shims):\n-    result = []\n-    for name, val in shims.items():\n-        options = []\n-        if val.get(\'exports\'):\n-            options.append(\'exports: "%s"\' % val[\'exports\'])\n-        if val.get(\'deps\'):\n-            options.append(\'deps: \' + json.dumps(val[\'deps\']))\n-        if val.get(\'init\'):\n-            # function, no escaping here\n-            options.append(\'init: %s\' % val[\'init\'])\n-        result.append("""\n-        "{}": {{\n-            {}\n-        }}""".format(name, \',\\n            \'.join(options)))\n-    return \'{\' + \',\'.join(result) + \'\\n    }\'\n-\n-\n-class RequireJsView(BrowserView):\n-    """\n-    This view creates the config.js for requirejs with all the registered\n-    resources\n-\n-    It\'s used on development for the config.js and on compilation for the\n-    optimize.js\n-    """\n-\n-    @property\n-    def registry(self):\n-        return getUtility(IRegistry)\n-\n-    def registryResources(self):\n-        return self.registry.collectionOfInterface(\n-            IResourceRegistry, prefix="plone.resources", check=False)\n-\n-    def get_requirejs_config(self):\n-        """\n-        Returns the information for requirejs configuration\n-        """\n-        registry = self.registryResources()\n-        paths = {}\n-        shims = {}\n-        for name, script in registry.items():\n-            if script.js:\n-                # Main resource js file\n-                src = re.sub(r"\\.js$", "", script.js)\n-                paths[name] = src\n-                exports = script.export\n-                deps = script.deps\n-                inits = script.init\n-                if exports or deps or inits:\n-                    shims[name] = {}\n-                    if exports not in (\'\', None):\n-                        shims[name][\'exports\'] = exports\n-                    if deps not in (\'\', None):\n-                        shims[name][\'deps\'] = deps.split(\',\')\n-                    if inits not in (\'\', None):\n-                        shims[name][\'init\'] = inits\n-            if script.url:\n-                # Resources available under name-url name\n-                src = script.url\n-                paths[name + \'-url\'] = src\n-        return (paths, shims)\n-\n-\n-class ConfigJsView(RequireJsView):\n-    """ config.js for requirejs for script rendering. """\n-\n-    def __call__(self):\n-        (paths, shims) = self.get_requirejs_config()\n-        self.request.response.setHeader(\n-            \'Content-Type\',\n-            \'application/javascript\'\n-        )\n-        return configjs % (\n-            json.dumps(paths, indent=4),\n-            _format_shims(shims)\n-        )\ndiff --git a/Products/CMFPlone/resources/browser/configure.zcml b/Products/CMFPlone/resources/browser/configure.zcml\nindex 18875cfdb1..32ca958596 100644\n--- a/Products/CMFPlone/resources/browser/configure.zcml\n+++ b/Products/CMFPlone/resources/browser/configure.zcml\n@@ -6,47 +6,22 @@\n   <browser:viewlet\n       name="plone.resourceregistries.scripts"\n       manager="plone.app.layout.viewlets.interfaces.IScripts"\n-      class="Products.CMFPlone.resources.browser.scripts.ScriptsView"\n-      template="scripts.pt"\n+      class="Products.CMFPlone.resources.browser.resource.ScriptsView"\n       permission="zope2.View"\n       />\n \n   <browser:viewlet\n       name="plone.resourceregistries.styles"\n       manager="plone.app.layout.viewlets.interfaces.IHtmlHeadLinks"\n-      class="Products.CMFPlone.resources.browser.styles.StylesView"\n-      template="styles.pt"\n+      class="Products.CMFPlone.resources.browser.resource.StylesView"\n       permission="zope2.View"\n       />\n \n-\n-  <browser:page\n-      for="*"\n-      name="config.js"\n-      class=".configjs.ConfigJsView"\n-      permission="zope.Public"\n-      />\n-\n-  <browser:page\n-      for="*"\n-      name="less-variables.js"\n-      class=".mixins.LessConfiguration"\n-      permission="zope.Public"\n-      />\n-\n-  <browser:page\n-      for="*"\n-      name="less-modify.js"\n-      class=".mixins.LessModifyConfiguration"\n-      permission="zope.Public"\n-      />\n-\n-\n-  <browser:page\n-      for="*"\n-      name="plone_less_dependency.less"\n-      class=".mixins.LessDependency"\n-      permission="zope.Public"\n+  <adapter\n+      name="webresource"\n+      for="* zope.publisher.interfaces.IRequest"\n+      provides="zope.traversing.interfaces.ITraversable"\n+      factory="plone.resource.traversal.UniqueResourceTraverser"\n       />\n \n </configure>\ndiff --git a/Products/CMFPlone/resources/browser/cook.py b/Products/CMFPlone/resources/browser/cook.py\ndeleted file mode 100644\nindex 2d6ed3b471..0000000000\n--- a/Products/CMFPlone/resources/browser/cook.py\n+++ /dev/null\n@@ -1,174 +0,0 @@\n-from calmjs.parse import es5\n-from datetime import datetime\n-from io import BytesIO\n-from plone.protect.interfaces import IDisableCSRFProtection\n-from plone.registry.interfaces import IRegistry\n-from plone.resource.interfaces import IResourceDirectory\n-from plone.subrequest import subrequest\n-from Products.CMFPlone.interfaces.resources import IBundleRegistry\n-from Products.CMFPlone.interfaces.resources import IResourceRegistry\n-from Products.CMFPlone.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME  # noqa\n-from Products.CMFPlone.resources.browser.combine import combine_bundles\n-from scss import Compiler\n-from zExceptions import NotFound\n-from zope.component import getUtility\n-from zope.component.hooks import getSite\n-from zope.globalrequest import getRequest\n-from zope.interface import alsoProvides\n-\n-import logging\n-\n-\n-logger = logging.getLogger(\'Products.CMFPlone\')\n-\n-REQUIREJS_RESET_PREFIX = """\n-/* reset requirejs definitions so that people who\n-   put requirejs in legacy compilation do not get errors */\n-var _old_define = define;\n-var _old_require = require;\n-define = undefined;\n-require = undefined;\n-try{\n-"""\n-REQUIREJS_RESET_POSTFIX = """\n-}catch(e){\n-    // log it\n-    if (typeof console !== "undefined"){\n-        console.log(\'Error loading javascripts!\' + e);\n-    }\n-}finally{\n-    define = _old_define;\n-    require = _old_require;\n-}\n-"""\n-\n-\n-def cookWhenChangingSettings(context, bundle=None):\n-    """When our settings are changed, re-cook the not compilable bundles\n-    """\n-    registry = getUtility(IRegistry)\n-    resources = registry.collectionOfInterface(\n-        IResourceRegistry, prefix="plone.resources", check=False)\n-    if bundle is None:\n-        # default to cooking legacy bundle\n-        bundles = registry.collectionOfInterface(\n-            IBundleRegistry, prefix="plone.bundles", check=False)\n-        if \'plone-legacy\' in bundles:\n-            bundle = bundles[\'plone-legacy\']\n-        else:\n-            bundle = bundles.setdefault(\'plone-legacy\')\n-            bundle.resources = []\n-\n-    if not bundle.resources:\n-        # you can have a bundle without any resources defined and it\'s just\n-        # shipped as a legacy compiled js file\n-        return\n-\n-    js_path = bundle.jscompilation\n-    css_path = bundle.csscompilation\n-\n-    if not js_path and not css_path:\n-        logger.warning(\n-            \'No js_path or css_path found. We need a plone.resource \'\n-            \'based resource path in order to store the compiled JS and CSS.\'\n-        )\n-        return\n-\n-    # Let\'s join all css and js\n-    css_compiler = Compiler(output_style=\'compressed\')\n-    cooked_css = \'\'\n-    cooked_js = REQUIREJS_RESET_PREFIX\n-    siteUrl = getSite().absolute_url()\n-    request = getRequest()\n-    for package in bundle.resources or []:\n-        if package not in resources:\n-            continue\n-        resource = resources[package]\n-\n-        if css_path:\n-            for css_resource in resource.css:\n-                css_url = siteUrl + \'/\' + css_resource\n-                response = subrequest(css_url)\n-                if response.status == 200:\n-                    logger.info(\'Cooking css %s\', css_resource)\n-                    css = response.getBody()\n-                    if css_resource[-8:] != \'.min.css\':\n-                        css = css_compiler.compile_string(css)\n-                    if not isinstance(css, str):\n-                        css = css.decode(\'utf8\')\n-                    cooked_css += \'\\n/* Resource: {} */\\n{}\\n\'.format(\n-                        css_resource,\n-                        css\n-                    )\n-                else:\n-                    cooked_css +=\\\n-                        \'\\n/* Could not find resource: {} */\\n\\n\'.format(\n-                            css_resource\n-                        )\n-                    logger.warning(\'Could not find resource: %s\', css_resource)\n-        if not resource.js or not js_path:\n-            continue\n-        js_url = siteUrl + \'/\' + resource.js\n-        response = subrequest(js_url)\n-        if response.status == 200:\n-            logger.info(\'Cooking js %s\', resource.js)\n-            js = response.getBody()\n-            if not isinstance(js, str):\n-                js = js.decode(\'utf8\')\n-            try:\n-                cooked_js += \'\\n/* resource: {} */\\n{}\'.format(\n-                    resource.js,\n-                    js if resource.js.endswith(\'.min.js\') else\n-                    es5.minify_print(js)\n-                )\n-            except SyntaxError:\n-                cooked_js +=\\\n-                    \'\\n/* Resource (error cooking): {} */\\n{}\'.format(\n-                        resource.js,\n-                        js\n-                    )\n-                logger.warning(\'Error cooking resource: %s\', resource.js)\n-        else:\n-            logger.warning(\'Could not find resource: %s\', resource.js)\n-            cooked_js += \'\\n/* Could not find resource: {} */\\n\\n\'.format(\n-                js_url\n-            )\n-\n-    cooked_js += REQUIREJS_RESET_POSTFIX\n-\n-    persistent_directory = getUtility(IResourceDirectory, name="persistent")\n-    if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:\n-        persistent_directory.makeDirectory(OVERRIDE_RESOURCE_DIRECTORY_NAME)\n-    container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-\n-    def _write_resource(resource_path, cooked_string):\n-        if not resource_path:\n-            return\n-        if \'++plone++\' in resource_path:\n-            resource_path = resource_path.split(\'++plone++\')[-1]\n-        if \'/\' in resource_path:\n-            resource_name, resource_filepath = resource_path.split(\'/\', 1)\n-        else:\n-            resource_name = \'legacy\'\n-            resource_filepath = resource_path\n-        if resource_name not in container:\n-            container.makeDirectory(resource_name)\n-        if not isinstance(cooked_string, bytes):  # handle Error of OFS.Image  # noqa: E501\n-            cooked_string = cooked_string.encode(\'ascii\', errors=\'ignore\')\n-        try:\n-            folder = container[resource_name]\n-            fi = BytesIO(cooked_string)\n-            folder.writeFile(resource_filepath, fi)\n-            logger.info(\'Writing cooked resource: %s\', resource_path)\n-        except NotFound:\n-            logger.warning(\'Error writing cooked resource: %s\', resource_path)\n-\n-    _write_resource(js_path, cooked_js)\n-    _write_resource(css_path, cooked_css)\n-\n-    bundle.last_compilation = datetime.now()\n-    # refresh production meta bundles\n-    combine_bundles(context)\n-\n-    # Disable CSRF protection on this request\n-    alsoProvides(request, IDisableCSRFProtection)\ndiff --git a/Products/CMFPlone/resources/browser/interfaces.py b/Products/CMFPlone/resources/browser/interfaces.py\ndeleted file mode 100644\nindex b10009c3b8..0000000000\n--- a/Products/CMFPlone/resources/browser/interfaces.py\n+++ /dev/null\n@@ -1,13 +0,0 @@\n-from zope.interface import Interface\n-\n-\n-class IScriptsView(Interface):\n-\n-    def scripts():\n-        """ Returns a list of dicts with information for scripts rendering. """\n-\n-\n-class IStylesView(Interface):\n-\n-    def styles():\n-        """ Returns a list of dicts with information for style rendering. """\ndiff --git a/Products/CMFPlone/resources/browser/mixins.py b/Products/CMFPlone/resources/browser/mixins.py\ndeleted file mode 100644\nindex fe235f922a..0000000000\n--- a/Products/CMFPlone/resources/browser/mixins.py\n+++ /dev/null\n@@ -1,161 +0,0 @@\n-from AccessControl.safe_formatter import SafeFormatter\n-from plone.registry.interfaces import IRegistry\n-from urllib.parse import urlparse\n-from Products.CMFPlone.interfaces import IResourceRegistry\n-from Products.Five.browser import BrowserView\n-from zope.component import getMultiAdapter\n-from zope.component import getUtility\n-\n-\n-lessconfig = """\n- window.less = {\n-    env: "development",\n-    logLevel: %i,\n-    async: false,\n-    fileAsync: false,\n-    errorReporting: window.lessErrorReporting || \'console\',\n-    poll: 1000,\n-    functions: {},\n-    relativeUrls: true,\n-    dumpLineNumbers: "comments",\n-    globalVars: {\n-      %s\n-    },\n-    modifyVars: {\n-      %s\n-    }\n-  };\n-"""\n-\n-lessmodify = """\n-less.modifyVars({\n-    %s\n-})\n-"""\n-\n-\n-class LessConfiguration(BrowserView):\n-    """Browser view that gets the definition of less variables on plone.\n-    """\n-\n-    def registry(self):\n-        registryUtility = getUtility(IRegistry)\n-        return registryUtility.records[\'plone.lessvariables\'].value\n-\n-    def resource_registry(self):\n-        registryUtility = getUtility(IRegistry)\n-        return registryUtility.collectionOfInterface(\n-            IResourceRegistry, prefix="plone.resources", check=False)\n-\n-    def __call__(self):\n-        registry = self.registry()\n-        portal_state = getMultiAdapter((self.context, self.request),\n-                                       name=\'plone_portal_state\')\n-        site_url = portal_state.portal_url()\n-        result = ""\n-        result += "sitePath: \'\\"%s\\"\',\\n" % site_url\n-        result += "isPlone: true,\\n"\n-        result += "isMockup: false,\\n"\n-        result += "staticPath: \'\\"%s/++plone++static\\"\',\\n" % site_url\n-        result += "barcelonetaPath: \'\\"%s/++theme++barceloneta\\"\',\\n" % site_url\n-\n-        less_vars_params = {\n-            \'site_url\': site_url,\n-        }\n-\n-        # Storing variables to use them on further vars\n-        for name, value in registry.items():\n-            less_vars_params[name] = value\n-\n-        for name, value in registry.items():\n-            t = SafeFormatter(value).safe_format(**less_vars_params)\n-            result += f"\'{name}\': \\"{t}\\",\\n"\n-\n-        # Adding all plone.resource entries css values as less vars\n-        for name, value in self.resource_registry().items():\n-            for css in value.css:\n-\n-                url = urlparse(css)\n-                if url.netloc == \'\':\n-                    # Local\n-                    src = f"{site_url}/{css}"\n-                else:\n-                    src = "%s" % (css)\n-                # less vars can\'t have dots on it\n-                result += "\'{}\': \'\\"{}\\"\',\\n".format(name.replace(\'.\', \'_\'), src)\n-\n-        self.request.response.setHeader("Content-Type",\n-                                        "application/javascript")\n-\n-        try:\n-            debug_level = int(self.request.get(\'debug\', 2))\n-        except:\n-            debug_level = 2\n-        return lessconfig % (debug_level, result, result)\n-\n-\n-class LessModifyConfiguration(LessConfiguration):\n-\n-    def __call__(self):\n-        registry = self.registry()\n-        portal_state = getMultiAdapter((self.context, self.request),\n-                                       name=\'plone_portal_state\')\n-        site_url = portal_state.portal_url()\n-        result2 = ""\n-        result2 += "\'@sitePath\': \'\\"%s\\"\',\\n" % site_url\n-        result2 += "\'@isPlone\': true,\\n"\n-        result2 += "\'@isMockup\': false,\\n"\n-        result2 += "\'@staticPath: \'\\"%s/++plone++static\\"\',\\n" % site_url\n-        result2 += "\'@barcelonetaPath: \'\\"%s/++theme++barceloneta\\"\',\\n" % site_url\n-\n-        less_vars_params = {\n-            \'site_url\': site_url,\n-        }\n-\n-        # Storing variables to use them on further vars\n-        for name, value in registry.items():\n-            less_vars_params[name] = value\n-\n-        for name, value in registry.items():\n-            t = SafeFormatter(value).safe_format(**less_vars_params)\n-            result2 += f"\'@{name}\': \\"{t}\\",\\n"\n-\n-        self.request.response.setHeader("Content-Type",\n-                                        "application/javascript")\n-\n-        return lessmodify % (result2)\n-\n-\n-class LessDependency(BrowserView):\n-    """Browser view that returns the less/css on less format for specific\n-    resource.\n-    """\n-\n-    def registry(self):\n-        registryUtility = getUtility(IRegistry)\n-        return registryUtility.collectionOfInterface(\n-            IResourceRegistry, prefix="plone.resources", check=False)\n-\n-    def __call__(self):\n-        portal_state = getMultiAdapter((self.context, self.request),\n-                                       name=\'plone_portal_state\')\n-        site_url = portal_state.portal_url()\n-\n-        registry = self.registry()\n-        resource = self.request.get(\'resource\', None)\n-        result = ""\n-        if resource:\n-            if resource in registry:\n-                for css in registry[resource].css:\n-                    url = urlparse(css)\n-                    if url.netloc == \'\':\n-                        # Local\n-                        src = f"{site_url}/{css}"\n-                    else:\n-                        src = "%s" % (css)\n-\n-                    result += "@import url(\'%s\');\\n" % src\n-\n-        self.request.response.setHeader("Content-Type", "stylesheet/less")\n-\n-        return result\ndiff --git a/Products/CMFPlone/resources/browser/resource.py b/Products/CMFPlone/resources/browser/resource.py\nindex bb64409814..14d0412a26 100644\n--- a/Products/CMFPlone/resources/browser/resource.py\n+++ b/Products/CMFPlone/resources/browser/resource.py\n@@ -1,111 +1,86 @@\n-from Acquisition import aq_base\n-from Acquisition import aq_inner\n-from Acquisition import aq_parent\n+from ..webresource import PloneScriptResource\n+from ..webresource import PloneStyleResource\n from App.config import getConfiguration\n from plone.app.layout.viewlets.common import ViewletBase\n+from plone.app.theming.interfaces import IThemeSettings\n from plone.app.theming.utils import theming_policy\n-from plone.memoize.view import memoize\n+from plone.base.interfaces import IBundleRegistry\n from plone.registry.interfaces import IRegistry\n-from Products.CMFCore.Expression import createExprContext\n-from Products.CMFCore.Expression import Expression\n-from Products.CMFCore.utils import _getAuthenticatedUser\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IBundleRegistry\n-from Products.CMFPlone.interfaces import IResourceRegistry\n-from Products.CMFPlone.resources import RESOURCE_DEVELOPMENT_MODE\n-from Products.CMFPlone.resources.browser.combine import get_production_resource_directory  # noqa\n-from Products.CMFPlone.resources.bundle import Bundle\n-from Products.CMFPlone.utils import get_top_request\n-from zope import component\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n-from zope.ramcache.interfaces import ram\n+from zope.component.hooks import getSite\n+\n+import hashlib\n+import logging\n+import webresource\n+\n+\n+logger = logging.getLogger(__name__)\n+\n+REQUEST_CACHE_KEY = "_WEBRESOURCE_CACHE_"\n+\n+GRACEFUL_DEPENDENCY_REWRITE = {\n+    "plone-base": "plone",\n+    "plone-legacy": "plone",\n+    "plone-logged-in": "plone",\n+}\n \n \n class ResourceBase:\n     """Information for script rendering.\n \n     This is a mixin base class for a browser view, a viewlet or a tile\n-    or anything similar with a context and a request set on initialization.\n+    or anything similar with a context and a request set on\n+    initialization.\n     """\n \n-    @property\n-    @memoize\n-    def anonymous(self):\n-        return _getAuthenticatedUser(\n-            self.context\n-        ).getUserName() == \'Anonymous User\'\n+    def _request_bundles(self):\n+        request = self.request\n+        request_enabled_bundles = set(getattr(request, "enabled_bundles", []))\n+        request_disabled_bundles = set(getattr(request, "disabled_bundles", []))\n+        # include sub/parent request\n+        while request.get("PARENT_REQUEST", None):\n+            request = request["PARENT_REQUEST"]\n+            request_enabled_bundles.update(getattr(request, "enabled_bundles", []))\n+            request_disabled_bundles.update(getattr(request, "disabled_bundles", []))\n+        return request_enabled_bundles, request_disabled_bundles\n \n-    @property\n-    @memoize\n-    def development(self):\n-        """\n-        To set development mode:\n-\n-        - we can define a envvar: FEDEV\n-        - otherwise if its anonymous is using production mode\n-        - finally is checked on the registry entry\n-        """\n-        if RESOURCE_DEVELOPMENT_MODE:\n-            return True\n-        if self.anonymous and not self.debug_mode:\n-            return False\n-        return self.registry.records[\'plone.resources.development\'].value\n+    def _cache_attr_name(self, site):\n+        hashtool = hashlib.sha256()\n+        hashtool.update(self.__class__.__name__.encode(\'utf8\'))\n+        hashtool.update(site.absolute_url().encode(\'utf8\'))\n+        e_bundles, d_bundles = self._request_bundles()\n+        for bundle in e_bundles | d_bundles:\n+            hashtool.update(bundle.encode(\'utf8\'))\n+        return f"_v_renderend_cache_{hashtool.hexdigest()}"\n \n     @property\n-    def debug_mode(self):\n-        return getConfiguration().debug_mode\n-\n-    def develop_bundle(self, bundle, attr):\n-        return (\n-            RESOURCE_DEVELOPMENT_MODE or\n-            (self.development and getattr(bundle, attr, False))\n-        )\n+    def _rendered_cache(self):\n+        if getConfiguration().debug_mode:\n+            return\n+        self.registry = getUtility(IRegistry)\n+        if not self.registry["plone.resources.development"]:\n+            site = getSite()\n+            return getattr(site, self._cache_attr_name(site), None)\n \n-    @property\n-    def last_legacy_import(self):\n-        return self.registry.records[\'plone.resources.last_legacy_import\'].value  # noqa\n-\n-    def evaluateExpression(self, expression, context):\n-        """Evaluate an object\'s TALES condition to see if it should be\n-        displayed.\n-        """\n-        try:\n-            if expression.text and context is not None:\n-                portal = getToolByName(context, \'portal_url\').getPortalObject()\n-\n-                # Find folder (code courtesy of CMFCore.ActionsTool)\n-                if context is None or not hasattr(context, \'aq_base\'):\n-                    folder = portal\n-                else:\n-                    folder = context\n-                    # Search up the containment hierarchy until we find an\n-                    # object that claims it\'s PrincipiaFolderish.\n-                    while folder is not None:\n-                        if getattr(aq_base(folder), \'isPrincipiaFolderish\', 0):\n-                            # found it.\n-                            break\n-                        else:\n-                            folder = aq_parent(aq_inner(folder))\n-\n-                __traceback_info__ = (folder, portal, context, expression)\n-                ec = createExprContext(folder, portal, context)\n-                # add \'context\' as an alias for \'object\'\n-                ec.setGlobal(\'context\', context)\n-                return expression(ec)\n-            else:\n-                return True\n-        except AttributeError:\n-            return True\n+    @_rendered_cache.setter\n+    def _rendered_cache(self, value):\n+        site = getSite()\n+        setattr(site, self._cache_attr_name(site), value)\n \n     def update(self):\n+        # cache on request\n+        cached = getattr(self.request, REQUEST_CACHE_KEY, None)\n+        if cached is not None:\n+            self.renderer = cached\n+            return\n+\n+        # prepare\n         self.portal_state = getMultiAdapter(\n-            (self.context, self.request),\n-            name=\'plone_portal_state\'\n+            (self.context, self.request), name="plone_portal_state"\n         )\n-        self.site_url = self.portal_state.portal_url()\n-        self.registry = getUtility(IRegistry)\n-        self.production_path = get_production_resource_directory()\n+        if not getattr(self, "registry", None):\n+            self.registry = getUtility(IRegistry)\n \n         theme = None\n         policy = theming_policy(self.request)\n@@ -113,125 +88,219 @@ def update(self):\n             # Check if Diazo is enabled\n             theme = policy.get_theme() or None\n \n-        self.diazo_production_css = getattr(theme, \'production_css\', None)\n-        self.diazo_development_css = getattr(theme, \'development_css\', None)\n-        self.diazo_production_js = getattr(theme, \'production_js\', None)\n-        self.diazo_development_js = getattr(theme, \'development_js\', None)\n-        self.theme_enabled_bundles = getattr(theme, \'enabled_bundles\', [])\n-        self.theme_disabled_bundles = getattr(theme, \'disabled_bundles\', [])\n+        # we have two groups for two viewlets (historical reasons)\n+        root_group_js = webresource.ResourceGroup(name="root_js")\n+        root_group_css = webresource.ResourceGroup(name="root_css")\n \n-    def get_bundles(self):\n-        result = {}\n+        # register all bundles from registry\n+        registry_group_js = webresource.ResourceGroup(\n+            name="registry_js", group=root_group_js\n+        )\n+        registry_group_css = webresource.ResourceGroup(\n+            name="registry_css", group=root_group_css\n+        )\n         records = self.registry.collectionOfInterface(\n-            IBundleRegistry,\n-            prefix="plone.bundles",\n-            check=False\n+            IBundleRegistry, prefix="plone.bundles", check=False\n         )\n+        unique = True\n+\n+        theme_enabled_bundles = getattr(theme, "enabled_bundles", [])\n+        theme_disabled_bundles = getattr(theme, "disabled_bundles", [])\n+        request_enabled_bundles, request_disabled_bundles = self._request_bundles()\n+\n+        # collect names\n+        js_names = [name for name, rec in records.items() if rec.jscompilation]\n+        css_names = [name for name, rec in records.items() if rec.csscompilation]\n+        all_names = [\n+            name\n+            for name, rec in records.items()\n+            if rec.jscompilation or rec.csscompilation\n+        ]\n+\n+        def check_dependencies(bundle_name, depends, bundles):\n+            # "depends" can be a comma separated string of dependent\n+            # bundle names\n+            depend_names = depends.split(",") if depends else []\n+            valid_dependencies = []\n+\n+            for name in depend_names:\n+                if name in bundles:\n+                    valid_dependencies.append(name)\n+                    continue\n+                if name in all_names:\n+                    # ignore dependency on bundle outside "bundles"\n+                    continue\n+\n+                msg = f"Bundle \'{bundle_name}\' has a non existing dependeny on \'{name}\'. "\n+\n+                if name in GRACEFUL_DEPENDENCY_REWRITE:\n+                    # gracefully rewrite old bundle names\n+                    graceful_depends = GRACEFUL_DEPENDENCY_REWRITE[name]\n+                    logger.error(\n+                            msg\n+                            + f"Bundle dependency graceful rewritten to \'{graceful_depends}\' "\n+                            + "Fallback will be removed in Plone 7."\n+                        )\n+                    valid_dependencies.append(graceful_depends)\n+                    continue\n+\n+                # if the dependency does not exist, skip the bundle\n+                logger.error(\n+                    msg + "Bundle ignored - This may break your site!"\n+                )\n+                return "__broken__"\n+\n+            return valid_dependencies\n+\n+        # register\n         for name, record in records.items():\n-            result[name] = Bundle(record)\n-        return result\n-\n-    def get_resources(self):\n-        return self.registry.collectionOfInterface(\n-            IResourceRegistry,\n-            prefix="plone.resources",\n-            check=False\n-        )\n+            include = record.enabled\n+            include = include or name in theme_enabled_bundles\n+            include = include and name not in theme_disabled_bundles\n+            include = include or name in request_enabled_bundles\n+            include = include and name not in request_disabled_bundles\n \n-    def eval_expression(self, expression, bundle_name):\n-        if not expression:\n-            return True\n-        cache = component.queryUtility(ram.IRAMCache)\n-        cooked_expression = None\n-        if cache is not None:\n-            cooked_expression = cache.query(\n-                \'plone.bundles.cooked_expressions\',\n-                key=dict(prefix=bundle_name),\n-                default=None\n-            )\n-        if (\n-            cooked_expression is None or\n-            cooked_expression.text != expression\n-        ):\n-            cooked_expression = Expression(expression)\n-            if cache is not None:\n-                cache.set(\n-                    cooked_expression,\n-                    \'plone.bundles.cooked_expressions\',\n-                    key=dict(prefix=bundle_name)\n+            if record.jscompilation:\n+                depends = check_dependencies(name, record.depends, js_names)\n+                if depends == "__broken__":\n+                    continue\n+                external = record.jscompilation.startswith("http")\n+                PloneScriptResource(\n+                    context=self.context,\n+                    name=name,\n+                    depends=depends,\n+                    resource=record.jscompilation if not external else None,\n+                    compressed=record.jscompilation if not external else None,\n+                    include=include,\n+                    expression=record.expression,\n+                    unique=unique,\n+                    group=registry_group_js,\n+                    url=record.jscompilation if external else None,\n+                    crossorigin="anonymous" if external else None,\n+                    async_=record.load_async or None,\n+                    defer=record.load_defer or None,\n+                    integrity=not external,\n                 )\n-        return self.evaluateExpression(cooked_expression, self.context)\n-\n-    def get_cooked_bundles(self):\n-        """\n-        Get the cooked bundles\n-        """\n-        request = get_top_request(self.request)  # might be a subrequest\n-\n-        # theme specific set bundles\n-        enabled_bundles = set(self.theme_enabled_bundles)\n-        disabled_bundles = set(self.theme_disabled_bundles)\n-\n-        # Request set bundles\n-        enabled_bundles.update(getattr(request, \'enabled_bundles\', []))\n-        disabled_bundles.update(getattr(request, \'disabled_bundles\', []))\n-\n-        for key, bundle in self.get_bundles().items():\n-            # The diazo manifest and request bundles are more important than\n-            # the disabled bundle on registry.\n-            # We can access the site with diazo.off=1 without diazo bundles\n-            if (\n-                key in disabled_bundles or\n-                (key not in enabled_bundles and not bundle.enabled) or\n-                not self.eval_expression(bundle.expression, bundle.name)\n-            ):\n-                continue\n-\n-            yield key, bundle\n-\n-    def ordered_bundles_result(self, production=False):\n-        """\n-        It gets the ordered result of bundles\n-        """\n-        result = []\n-        inserted = []\n-        depends_on = {}\n-        for key, bundle in self.get_cooked_bundles():\n-            if bundle.depends is None or bundle.depends == \'\':\n-                # its the first one\n-                if not(production and bundle.merge_with):\n-                    self.get_data(bundle, result)\n-                inserted.append(key)\n-            else:\n-                name = bundle.depends.strip()\n-                if name in depends_on:\n-                    depends_on[name].append(bundle)\n-                else:\n-                    depends_on[name] = [bundle]\n-\n-        # We need to check all dependencies\n-        while len(depends_on) > 0:\n-            found = False\n-            for key, bundles_to_add in list(depends_on.items()):\n-                if key not in inserted:\n+            if record.csscompilation:\n+                depends = check_dependencies(name, record.depends, css_names)\n+                if depends == "__broken__":\n                     continue\n-                found = True\n-                for bundle in bundles_to_add:\n-                    if not(production and bundle.merge_with):\n-                        self.get_data(bundle, result)\n-                    inserted.append(bundle.name)\n-                del depends_on[key]\n-            if not found:\n-                break\n-\n-        # The ones that does not get the dependencies\n-        for bundles_to_add in depends_on.values():\n-            for bundle in bundles_to_add:\n-                if not(production and bundle.merge_with):\n-                    self.get_data(bundle, result)\n-        return result\n+                external = record.csscompilation.startswith("http")\n+                PloneStyleResource(\n+                    context=self.context,\n+                    name=name,\n+                    depends=depends,\n+                    resource=record.csscompilation if not external else None,\n+                    compressed=record.csscompilation if not external else None,\n+                    include=include,\n+                    expression=record.expression,\n+                    unique=unique,\n+                    group=registry_group_css,\n+                    url=record.csscompilation if external else None,\n+                    media="all",\n+                    rel="stylesheet",\n+                )\n+\n+        # Collect theme data\n+        themedata = {}\n+        themedata["production_css"] = getattr(theme, "production_css", None)\n+        themedata["development_css"] = getattr(theme, "development_css", None)\n+        themedata["production_js"] = getattr(theme, "production_js", None)\n+        themedata["development_js"] = getattr(theme, "development_js", None)\n+\n+        # add Theme JS\n+        if themedata["production_js"]:\n+            # we ignore development_js for external detection\n+            external = themedata["production_js"].startswith("http")\n+            PloneScriptResource(\n+                context=self.context,\n+                name="theme",\n+                depends="",\n+                resource=(\n+                    themedata["development_js"] or themedata["production_js"]\n+                    if not external\n+                    else None\n+                ),\n+                compressed=themedata["production_js"] if not external else None,\n+                include=True,\n+                unique=unique,\n+                group=root_group_js,\n+                url=themedata["production_js"] if external else None,\n+                crossorigin="anonymous" if external else None,\n+                integrity=not external,\n+            )\n+\n+        # add Theme CSS\n+        if themedata["production_css"]:\n+            # we ignore development_css for external detection\n+            external = themedata["production_css"].startswith("http")\n+            PloneStyleResource(\n+                context=self.context,\n+                name="theme",\n+                depends="",\n+                resource=(\n+                    themedata["development_css"] or themedata["production_css"]\n+                    if not external\n+                    else None\n+                ),\n+                compressed=themedata["production_css"] if not external else None,\n+                include=True,\n+                unique=unique,\n+                group=root_group_css,\n+                url=themedata["production_css"] if external else None,\n+                media="all",\n+                rel="stylesheet",\n+            )\n+\n+        # add Custom CSS\n+        registry = getUtility(IRegistry)\n+        theme_settings = registry.forInterface(IThemeSettings, False)\n+        if theme_settings.custom_css:\n+            PloneStyleResource(\n+                context=self.context,\n+                name="custom",\n+                depends="",\n+                resource="@@custom.css",\n+                include=True,\n+                unique=unique,\n+                group=root_group_css,\n+                media="all",\n+                rel="stylesheet",\n+            )\n+\n+        self.renderer = {}\n+        setattr(self.request, REQUEST_CACHE_KEY, self.renderer)\n+        resolver_js = webresource.ResourceResolver(root_group_js)\n+        self.renderer["js"] = webresource.ResourceRenderer(\n+            resolver_js, base_url=self.portal_state.portal_url()\n+        )\n+        resolver_css = webresource.ResourceResolver(root_group_css)\n+        self.renderer["css"] = webresource.ResourceRenderer(\n+            resolver_css, base_url=self.portal_state.portal_url()\n+        )\n \n \n class ResourceView(ResourceBase, ViewletBase):\n-    """Viewlet Information for script rendering.\n-    """\n+    """Viewlet Information for script rendering."""\n+\n+\n+class ScriptsView(ResourceView):\n+    """Script Viewlet."""\n+\n+    def index(self):\n+        rendered = self._rendered_cache\n+        if not rendered:\n+            rendered = self.renderer["js"].render()\n+            self._rendered_cache = rendered\n+        return rendered\n+\n+\n+class StylesView(ResourceView):\n+    """Styles Viewlet."""\n+\n+    def index(self):\n+        rendered = self._rendered_cache\n+        if not rendered:\n+            rendered = self.renderer["css"].render()\n+            self._rendered_cache = rendered\n+        return rendered\ndiff --git a/Products/CMFPlone/resources/browser/scripts.pt b/Products/CMFPlone/resources/browser/scripts.pt\ndeleted file mode 100644\nindex d3d762fd7f..0000000000\n--- a/Products/CMFPlone/resources/browser/scripts.pt\n+++ /dev/null\n@@ -1,38 +0,0 @@\n-<script tal:content="string:PORTAL_URL = \'${view/site_url}\';"></script>\n-\n-<tal:scripts repeat="script view/scripts">\n-  <tal:block define="condcomment script/conditionalcomment; resetrjs script/resetrjs|nothing">\n-\n-    <tal:if condition="resetrjs">\n-      <tal:openreset content=\'structure string:&lt;script&gt;\'></tal:openreset>\n-\n-      <tal:comment tal:replace="nothing">\n-        Reset RequireJS definitions so that people who put RequireJS in a legacy compilation do not get errors\n-      </tal:comment>\n-\n-      var _old_define = define;\n-      var _old_require = require;\n-      define = undefined;\n-      require = undefined;\n-      <tal:endreset content=\'structure string:&lt;/script&gt;\'></tal:endreset>\n-    </tal:if>\n-\n-    <tal:if condition="condcomment">\n-      <tal:opencc tal:replace="structure string:&lt;!--[if ${condcomment}]&gt;"></tal:opencc>\n-    </tal:if>\n-\n-    <script type="text/javascript" tal:attributes="src script/src; data-bundle script/bundle; async script/async|nothing; defer script/defer|nothing"></script>\n-\n-    <tal:if condition="condcomment">\n-      <tal:closecc tal:condition="condcomment" tal:replace="structure string:&lt;![endif]--&gt;"></tal:closecc>\n-    </tal:if>\n-\n-    <tal:if condition="resetrjs">\n-      <tal:openredefine content=\'structure string:&lt;script&gt;\'></tal:openredefine>\n-      define = _old_define;\n-      require = _old_require;\n-      <tal:endredefine content=\'structure string:&lt;/script&gt;\'></tal:endredefine>\n-    </tal:if>\n-\n-  </tal:block>\n-</tal:scripts>\ndiff --git a/Products/CMFPlone/resources/browser/scripts.py b/Products/CMFPlone/resources/browser/scripts.py\ndeleted file mode 100644\nindex b7051ff22f..0000000000\n--- a/Products/CMFPlone/resources/browser/scripts.py\n+++ /dev/null\n@@ -1,198 +0,0 @@\n-from Products.CMFPlone.resources.browser.cook import cookWhenChangingSettings\n-from Products.CMFPlone.resources.browser.resource import ResourceView\n-from Products.CMFPlone.utils import get_top_request\n-from urllib import parse\n-from zope.component import getMultiAdapter\n-\n-\n-class ScriptsView(ResourceView):\n-    """Information for script rendering.\n-    """\n-\n-    def _add_resources(\n-        self,\n-        resources_to_add,\n-        result,\n-        bundle_name=\'none\',\n-        resetrjs=False,\n-        conditionalcomment=\'\'\n-    ):\n-        resources = self.get_resources()\n-        for resource in resources_to_add:\n-            data = resources.get(resource, None)\n-            if data is None or not data.js:\n-                continue\n-            url = parse.urlparse(data.js)\n-            if url.netloc == \'\':\n-                # Local\n-                src = f\'{self.site_url}/{data.js}\'\n-            else:\n-                src = data.js\n-            data = {\n-                \'bundle\': bundle_name,\n-                \'conditionalcomment\': conditionalcomment,\n-                \'src\': src,\n-                # Reset RequireJS if bundle is in non-compile to\n-                # avoid "Mismatched anonymous define()" in legacy\n-                # scripts.\n-                \'resetrjs\': resetrjs,\n-            }\n-            result.append(data)\n-\n-    def get_data(self, bundle, result):\n-        if self.develop_bundle(bundle, \'develop_javascript\'):\n-            # Bundle development mode\n-            self._add_resources(\n-                bundle.resources,\n-                result,\n-                bundle_name=bundle.name,\n-                resetrjs=bundle.compile is False,\n-                conditionalcomment=bundle.conditionalcomment,\n-            )\n-            return\n-        if (\n-            not bundle.compile and\n-            (\n-                not bundle.last_compilation or\n-                self.last_legacy_import > bundle.last_compilation\n-            ) and\n-            bundle.resources\n-        ):\n-            # Its a legacy bundle OR compiling is happening outside of plone\n-\n-            # We need to combine files. It\'s possible no resources are\n-            # defined because the compiling is done outside of plone\n-            cookWhenChangingSettings(self.context, bundle)\n-        if bundle.jscompilation:\n-            js_path = bundle.jscompilation\n-            if \'++plone++\' in js_path:\n-                resource_path = js_path.split(\'++plone++\')[-1]\n-                resource_name, resource_filepath = resource_path.split(\n-                    \'/\', 1)\n-                js_location = \'{}/++plone++{}/++unique++{}/{}\'.format(\n-                    self.site_url,\n-                    resource_name,\n-                    parse.quote(str(bundle.last_compilation)),\n-                    resource_filepath\n-                )\n-            else:\n-                js_location = \'{}/{}?version={}\'.format(\n-                    self.site_url,\n-                    bundle.jscompilation,\n-                    parse.quote(str(bundle.last_compilation))\n-                )\n-\n-            load_async = \'async\' if getattr(bundle, \'load_async\', None) else None  # noqa\n-            load_defer = \'defer\' if getattr(bundle, \'load_defer\', None) else None  # noqa\n-\n-            result.append({\n-                \'bundle\': bundle.name,\n-                \'conditionalcomment\': bundle.conditionalcomment,\n-                \'src\': js_location,\n-                \'async\': load_async,\n-                \'defer\': load_defer,\n-            })\n-\n-    def default_resources(self):\n-        """ Default resources used by Plone itself\n-        """\n-        result = []\n-        # We always add jquery resource\n-        result.append({\n-            \'src\': \'{}/{}\'.format(\n-                self.site_url,\n-                self.registry.records[\'plone.resources/jquery.js\'].value),\n-            \'conditionalcomment\': None,\n-            \'bundle\': \'basic\'\n-        })\n-        if self.development:\n-            # We need to add require.js and config.js\n-            result.append({\n-                \'src\': \'{}/{}\'.format(\n-                    self.site_url,\n-                    self.registry.records[\'plone.resources.less-variables\'].value),  # noqa\n-                \'conditionalcomment\': None,\n-                \'bundle\': \'basic\'\n-            })\n-            result.append({\n-                \'src\': \'{}/{}\'.format(\n-                    self.site_url,\n-                    self.registry.records[\'plone.resources.lessc\'].value),\n-                \'conditionalcomment\': None,\n-                \'bundle\': \'basic\'\n-            })\n-        result.append({\n-            \'src\': \'{}/{}\'.format(\n-                self.site_url,\n-                self.registry.records[\'plone.resources.requirejs\'].value),\n-            \'conditionalcomment\': None,\n-            \'bundle\': \'basic\'\n-        })\n-        result.append({\n-            \'src\': \'{}/{}\'.format(\n-                self.site_url,\n-                self.registry.records[\'plone.resources.configjs\'].value),\n-            \'conditionalcomment\': None,\n-            \'bundle\': \'basic\'\n-        })\n-        return result\n-\n-    def base_url(self):\n-        portal_state = getMultiAdapter(\n-            (self.context, self.request),\n-            name=\'plone_portal_state\'\n-        )\n-        site_url = portal_state.portal_url()\n-        return site_url\n-\n-    def scripts(self):\n-        """The requirejs scripts, the ones that are not resources are loaded on\n-        configjs.py\n-        """\n-        if self.debug_mode or self.development or not self.production_path:\n-            result = self.default_resources()\n-            result.extend(self.ordered_bundles_result())\n-        else:\n-            result = [{\n-                \'src\': \'{}/++plone++{}\'.format(\n-                    self.site_url,\n-                    self.production_path + \'/default.js\'\n-                ),\n-                \'conditionalcomment\': None,\n-                \'bundle\': \'production\',\n-                \'async\': None,  # Do not load ``async`` or\n-                \'defer\': None   # ``defer`` for production bundles.\n-            }]\n-            if not self.anonymous:\n-                result.append({\n-                    \'src\': \'{}/++plone++{}\'.format(\n-                        self.site_url,\n-                        self.production_path + \'/logged-in.js\'\n-                    ),\n-                    \'conditionalcomment\': None,\n-                    \'bundle\': \'production\',\n-                    \'async\': None,  # Do not load ``async`` or\n-                    \'defer\': None   # ``defer`` for production bundles.\n-                })\n-            result.extend(self.ordered_bundles_result(production=True))\n-\n-        # Add manual added resources\n-        request = get_top_request(self.request)  # might be a subrequest\n-        enabled_resources = getattr(request, \'enabled_resources\', [])\n-        if enabled_resources:\n-            self._add_resources(enabled_resources, result)\n-\n-        # Add diazo url\n-        origin = None\n-        if self.diazo_production_js and not self.development:\n-            origin = self.diazo_production_js\n-        if self.diazo_development_js and self.development:\n-            origin = self.diazo_development_js\n-        if origin:\n-            result.append({\n-                \'bundle\': \'diazo\',\n-                \'conditionalcomment\': \'\',\n-                \'src\': f\'{self.site_url}/{origin}\',\n-            })\n-\n-        return result\ndiff --git a/Products/CMFPlone/resources/browser/styles.pt b/Products/CMFPlone/resources/browser/styles.pt\ndeleted file mode 100644\nindex 8efe677417..0000000000\n--- a/Products/CMFPlone/resources/browser/styles.pt\n+++ /dev/null\n@@ -1,13 +0,0 @@\n-<tal:styles repeat="style view/styles"\n-  ><tal:block define="condcomment style/conditionalcomment"\n-    ><tal:wcondcomment tal:condition="condcomment">\n-        <tal:opencc tal:replace="structure string:&lt;!--[if ${condcomment}]&gt;" />\n-    </tal:wcondcomment\n-    ><link rel="style"\n-          tal:attributes="href style/src;\n-                          rel style/rel;\n-                          data-bundle style/bundle;" /><tal:wcondcomment tal:condition="condcomment">\n-        <tal:closecc tal:replace="structure string:&lt;![endif]--&gt;" />\n-    </tal:wcondcomment\n-  ></tal:block\n-></tal:styles>\ndiff --git a/Products/CMFPlone/resources/browser/styles.py b/Products/CMFPlone/resources/browser/styles.py\ndeleted file mode 100644\nindex 6b7458d838..0000000000\n--- a/Products/CMFPlone/resources/browser/styles.py\n+++ /dev/null\n@@ -1,179 +0,0 @@\n-from plone.app.layout.viewlets.common import ViewletBase\n-from plone.app.theming.interfaces import IThemeSettings\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.resources.browser.cook import cookWhenChangingSettings\n-from Products.CMFPlone.resources.browser.resource import ResourceBase\n-from Products.CMFPlone.utils import get_top_request\n-from urllib import parse\n-from zope.component import getUtility\n-\n-\n-class StylesBase(ResourceBase):\n-\n-    """ Information for style rendering. """\n-\n-    def get_urls(self, style, bundle):\n-        """\n-        Extracts the urls for the specific resource\n-        """\n-        for css in style.css:\n-            url = parse.urlparse(css)\n-            if url.netloc == \'\':\n-                # Local\n-                src = f"{self.site_url}/{css}"\n-            else:\n-                src = "%s" % (css)\n-\n-            extension = url.path.split(\'.\')[-1]\n-            rel = \'stylesheet\'\n-            if extension != \'\' and extension != \'css\':\n-                rel = "stylesheet/%s" % extension\n-\n-            data = {\n-                \'rel\': rel,\n-                \'bundle\': bundle.name if bundle else \'none\',\n-                \'conditionalcomment\':\n-                    bundle.conditionalcomment if bundle else \'\',\n-                \'src\': src}\n-            yield data\n-\n-    def get_data(self, bundle, result):\n-        """\n-        Gets the needed information for the bundle\n-        and stores it on the result list\n-        """\n-        if self.develop_bundle(bundle, \'develop_css\'):\n-            self.resources = self.get_resources()\n-            # The bundle resources\n-            for resource in bundle.resources:\n-                if resource in self.resources:\n-                    style = self.resources[resource]\n-                    for data in self.get_urls(style, bundle):\n-                        result.append(data)\n-        else:\n-            if bundle.compile is False:\n-                # Its a legacy css bundle\n-                if not bundle.last_compilation\\\n-                        or self.last_legacy_import > bundle.last_compilation:\n-                    # We need to compile\n-                    cookWhenChangingSettings(self.context, bundle)\n-\n-            if bundle.csscompilation:\n-                css_path = bundle.csscompilation\n-                if \'++plone++\' in css_path:\n-                    resource_path = css_path.split(\'++plone++\')[-1]\n-                    resource_name, resource_filepath = resource_path.split(\n-                        \'/\', 1)\n-                    css_location = \'{}/++plone++{}/++unique++{}/{}\'.format(\n-                        self.site_url,\n-                        resource_name,\n-                        parse.quote(str(bundle.last_compilation)),\n-                        resource_filepath\n-                    )\n-                else:\n-                    css_location = \'{}/{}?version={}\'.format(\n-                        self.site_url,\n-                        bundle.csscompilation,\n-                        parse.quote(str(bundle.last_compilation))\n-                    )\n-                result.append({\n-                    \'bundle\': bundle.name,\n-                    \'rel\': \'stylesheet\',\n-                    \'conditionalcomment\': bundle.conditionalcomment,\n-                    \'src\': css_location\n-                })\n-\n-    @property\n-    def _theme_settings(self):\n-        registry = getUtility(IRegistry)\n-        return registry.forInterface(IThemeSettings, False)\n-\n-    @property\n-    def custom_css(self):\n-        return self._theme_settings.custom_css\n-\n-    @property\n-    def custom_css_timestamp(self):\n-        return self._theme_settings.custom_css_timestamp\n-\n-    def styles(self):\n-        """\n-        Get all the styles\n-        """\n-        if self.development or self.debug_mode or not self.production_path:\n-            result = self.ordered_bundles_result()\n-        else:\n-            result = [{\n-                \'src\': \'{}/++plone++{}\'.format(\n-                    self.site_url,\n-                    self.production_path + \'/default.css\'\n-                ),\n-                \'conditionalcomment\': None,\n-                \'rel\': \'stylesheet\',\n-                \'bundle\': \'production\'\n-            }, ]\n-            if not self.anonymous:\n-                result.append({\n-                    \'src\': \'{}/++plone++{}\'.format(\n-                        self.site_url,\n-                        self.production_path + \'/logged-in.css\'\n-                    ),\n-                    \'conditionalcomment\': None,\n-                    \'rel\': \'stylesheet\',\n-                    \'bundle\': \'production\'\n-                })\n-            result.extend(self.ordered_bundles_result(production=True))\n-\n-        # Add manual added resources\n-        resources = self.get_resources()\n-        request = get_top_request(self.request)  # might be a subrequest\n-        if hasattr(request, \'enabled_resources\'):\n-            for resource in request.enabled_resources:\n-                if resource in resources:\n-                    for data in self.get_urls(resources[resource], None):\n-                        result.append(data)\n-\n-        # Add diazo css\n-        origin = None\n-        if self.diazo_production_css and self.development is False:\n-            origin = self.diazo_production_css\n-        if self.diazo_development_css and self.development is True:\n-            origin = self.diazo_development_css\n-        if origin:\n-            url = parse.urlparse(origin)\n-            if url.netloc == \'\':\n-                # Local\n-                src = f"{self.site_url}/{origin}"\n-            else:\n-                src = "%s" % (origin)\n-\n-            extension = url.path.split(\'.\')[-1]\n-            rel = \'stylesheet\'\n-            if extension != \'\' and extension != \'css\':\n-                rel = "stylesheet/%s" % extension\n-\n-            data = {\'rel\': rel,\n-                    \'conditionalcomment\': \'\',\n-                    \'src\': src,\n-                    \'bundle\': \'diazo\'}\n-\n-            result.append(data)\n-\n-        # custom.css\n-        if self.custom_css:\n-            custom_css = {\n-                \'rel\': \'stylesheet\',\n-                \'conditionalcomment\': \'\',\n-                \'src\': "{}/custom.css?timestamp={}".format(\n-                    self.site_url,\n-                    self.custom_css_timestamp,\n-                ),\n-                \'bundle\': \'custom-css\'\n-            }\n-            result.append(custom_css)\n-        return result\n-\n-\n-class StylesView(StylesBase, ViewletBase):\n-    """Styles Viewlet\n-    """\ndiff --git a/Products/CMFPlone/resources/bundle.py b/Products/CMFPlone/resources/bundle.py\ndeleted file mode 100644\nindex 16a2007bc1..0000000000\n--- a/Products/CMFPlone/resources/bundle.py\n+++ /dev/null\n@@ -1,104 +0,0 @@\n-from datetime import datetime\n-from plone.resource.directory import FilesystemResourceDirectory\n-from plone.resource.file import FilesystemFile\n-from Products.CMFCore.FSFile import FSFile\n-from Products.Five.browser.resource import DirectoryResource\n-from Products.Five.browser.resource import FileResource\n-from zExceptions import NotFound\n-from zope.component.hooks import getSite\n-\n-import os\n-\n-\n-class Bundle:\n-    """Wraps pure bundles RecordsProxy and enrich with logic\n-    .\n-    Proxy attributes and provide some utility functions\n-    """\n-\n-    def __init__(self, data):\n-        """initialize Bunde.initialize\n-\n-        data is a\n-        - registry record\n-        - with interfaces\'IResourceRegistry\'\n-        - with prefix \'plone.bundles\'\n-        """\n-        self.data = data\n-\n-    def _real_path(self, ctx):\n-        if ctx == \'js\':\n-            resource_path = self.data.jscompilation\n-        else:\n-            resource_path = self.data.csscompilation\n-        try:\n-            resource = getSite().restrictedTraverse(resource_path)\n-        except (NotFound, KeyError):\n-            return None, None\n-        if resource.__module__ == \'Products.Five.metaclass\':\n-            try:\n-                return \'fs\', resource.chooseContext().path\n-            except:\n-                try:\n-                    return \'fs\', resource.context.path\n-                except:\n-                    try:\n-                        if callable(resource):\n-                            return None, None\n-                        else:\n-                            return None, None\n-                    except:\n-                        return None, None\n-        elif isinstance(resource, FilesystemFile):\n-            return \'fs\', resource.path\n-        elif isinstance(resource, FileResource):\n-            return \'fs\', resource.chooseContext().path\n-        elif isinstance(resource, DirectoryResource):\n-            return \'fs\', resource.context.path\n-        elif isinstance(resource, FilesystemResourceDirectory):\n-            return \'fs\', resource.directory\n-        elif isinstance(resource, FSFile):\n-            return \'zodb\', resource._filepath\n-        else:\n-            return \'zodb\', None\n-\n-    @property\n-    def name(self):\n-        return self.data.__prefix__.split(\'/\', 1)[1].rstrip(\'.\')\n-\n-    @property\n-    def last_compilation(self):\n-        """check bundles last compilation using filesystem date or date of OFS.\n-\n-        if bundle has a last_compilation date newer than filesystem/OFS it wins\n-        always.\n-        """\n-        mods = []\n-        for ctx in [\'js\', \'css\']:\n-            loc, path = self._real_path(ctx)\n-            if loc == \'fs\' and os.path.exists(path):\n-                mods.append(datetime.fromtimestamp(os.path.getmtime(path)))\n-            elif loc == \'zodb\':\n-                self.data.last_compilation\n-        if self.data.last_compilation and mods:\n-            if self.data.last_compilation > max(mods):\n-                return self.data.last_compilation\n-            else:\n-                return max(mods)\n-        return self.data.last_compilation\n-\n-    @last_compilation.setter\n-    def last_compilation(self, value):\n-        self.data.last_compilation = value\n-\n-    def __getattr__(self, name):\n-        """act as r/o wrapper"""\n-        return getattr(self.data, name)\n-\n-    def __repr__(self):\n-        return \'<{}.{} object "{}" at {}>\'.format(\n-            self.__class__.__module__,\n-            self.__class__.__name__,\n-            self.name,\n-            id(self)\n-        )\ndiff --git a/Products/CMFPlone/resources/exportimport/bundles.py b/Products/CMFPlone/resources/exportimport/bundles.py\ndeleted file mode 100644\nindex c4d7379307..0000000000\n--- a/Products/CMFPlone/resources/exportimport/bundles.py\n+++ /dev/null\n@@ -1,33 +0,0 @@\n-from ..browser.combine import combine_bundles\n-from plone.registry.interfaces import IRegistry\n-from zope.component import queryUtility\n-\n-\n-def combine(context):\n-    logger = context.getLogger(\'bundles\')\n-    registry = queryUtility(IRegistry)\n-\n-    if registry is None:\n-        logger.info("Cannot find registry")\n-        return\n-\n-    # Look for a keyword in registry.xml or the registry directory.\n-    filepaths = [\'registry.xml\']\n-    if context.isDirectory(\'registry\'):\n-        for filename in context.listDirectory(\'registry\'):\n-            filepaths.append(\'registry/\' + filename)\n-    found = False\n-    for filepath in filepaths:\n-        body = context.readDataFile(filepath)\n-        if body is not None and b\'IBundleRegistry\' in body:\n-            found = True\n-            break\n-    if not found:\n-        return\n-\n-    # Calling combine_bundles used to have as side effect that the\n-    # Content-Type header of the response was set to application/javascript,\n-    # which we do not want.  But that was fixed already in Plone 5.1b2.\n-    # See https://github.com/plone/Products.CMFPlone/pull/1924\n-    site = context.getSite()\n-    combine_bundles(site)\ndiff --git a/Products/CMFPlone/resources/exportimport/resourceregistry.py b/Products/CMFPlone/resources/exportimport/resourceregistry.py\ndeleted file mode 100644\nindex 9e97729bc7..0000000000\n--- a/Products/CMFPlone/resources/exportimport/resourceregistry.py\n+++ /dev/null\n@@ -1,166 +0,0 @@\n-from datetime import datetime\n-from plone.i18n.normalizer.interfaces import IIDNormalizer\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IBundleRegistry\n-from Products.CMFPlone.interfaces import IResourceRegistry\n-from Products.CMFPlone.resources.browser.cook import cookWhenChangingSettings\n-from Products.GenericSetup.interfaces import IBody\n-from Products.GenericSetup.utils import XMLAdapterBase\n-from zope.component import queryMultiAdapter\n-from zope.component import queryUtility\n-from zope.interface.interfaces import ComponentLookupError\n-\n-\n-def importResRegistry(context, reg_id, reg_title, filename):\n-    """Import resource registry.\n-    """\n-    site = context.getSite()\n-    logger = context.getLogger(\'resourceregistry\')\n-\n-    body = context.readDataFile(filename)\n-    if body is None:\n-        return\n-\n-    res_reg = getToolByName(site, reg_id)\n-\n-    importer = queryMultiAdapter((res_reg, context), IBody)\n-    if importer is None:\n-        logger.warning("%s: Import adapter missing." % reg_title)\n-        return\n-    try:\n-        importer.registry = getToolByName(site, \'portal_registry\')\n-    except AttributeError:\n-        # Upgrade 3.x no registry there\n-        importer.registry = None\n-    importer.body = body\n-    logger.info("%s imported." % reg_title)\n-\n-\n-class ResourceRegistryNodeAdapter(XMLAdapterBase):\n-\n-    resource_blacklist = set()\n-    registry = None\n-\n-    def _importNode(self, node):\n-        """Import the object from the DOM node.\n-        """\n-        if self.registry is None:\n-            # Upgrade 3.x no registry there\n-            return\n-        resources = self.registry.collectionOfInterface(\n-            IResourceRegistry, prefix="plone.resources", check=False)\n-\n-        bundles = self.registry.collectionOfInterface(\n-            IBundleRegistry, prefix="plone.bundles", check=False)\n-        if \'plone-legacy\' in bundles:\n-            legacy = bundles[\'plone-legacy\']\n-        else:\n-            legacy = bundles.setdefault(\'plone-legacy\')\n-            legacy.resources = []\n-            legacy.enabled = True\n-\n-        for child in node.childNodes:\n-            if child.nodeName != self.resource_type:\n-                continue\n-\n-            data = {}\n-            add = True\n-            remove = False\n-            position = res_id = None\n-            for key, value in child.attributes.items():\n-                key = str(key)\n-                if key == \'update\':\n-                    continue\n-                if key == \'remove\' and value in (True, \'true\', \'True\'):\n-                    add = False\n-                    remove = True\n-                    continue\n-                if key in (\'position-before\', \'insert-before\'):\n-                    position = (\'before\', queryUtility(\n-                        IIDNormalizer).normalize(str(value)))\n-                    continue\n-                if key in (\'position-after\', \'insert-after\'):\n-                    position = (\'after\', queryUtility(\n-                        IIDNormalizer).normalize(str(value)))\n-                    continue\n-                if key in (\'position-top\', \'insert-top\'):\n-                    position = (\'*\',)\n-                    continue\n-                if key in (\'position-bottom\', \'insert-bottom\'):\n-                    position = (\'\',)\n-                    continue\n-                if key == \'id\':\n-                    if value in self.resource_blacklist:\n-                        add = False\n-                        data.clear()\n-                        break\n-                    res_id = queryUtility(IIDNormalizer).normalize(str(value))\n-                    data[\'url\'] = str(value)\n-                elif value.lower() == \'false\':\n-                    data[key] = False\n-                elif value.lower() == \'true\':\n-                    data[key] = True\n-                else:\n-                    try:\n-                        data[key] = int(value)\n-                    except ValueError:\n-                        data[key] = str(value)\n-\n-            if add:\n-                proxy = resources.setdefault(res_id)\n-                if self.resource_type == \'javascript\':\n-                    proxy.js = data[\'url\']\n-                elif self.resource_type == \'stylesheet\':\n-                    proxy.css = [data[\'url\']]\n-                if \'enabled\' in data and not data[\'enabled\']:\n-                    # if we are disabling it, we need to remove from legacy\n-                    # resources\n-                    if res_id in legacy.resources:\n-                        legacy.resources.remove(res_id)\n-                    continue\n-                if res_id in legacy.resources:\n-                    # remove here so we can possible re-insert into whatever\n-                    # position is preferred below and then we do not\n-                    # re-add same resource multiple times\n-                    legacy.resources.remove(res_id)\n-                if position is None:\n-                    position = (\'\',)\n-                if position[0] == \'*\':\n-                    legacy.resources.insert(0, res_id)\n-                elif position[0] == \'\':\n-                    legacy.resources.append(res_id)\n-                elif position[0] == \'after\':\n-                    if position[1] in legacy.resources:\n-                        legacy.resources.insert(\n-                            legacy.resources.index(position[1]) + 1,\n-                            res_id)\n-                    else:\n-                        legacy.resources.append(res_id)\n-                elif position[0] == \'before\':\n-                    if position[1] in legacy.resources:\n-                        legacy.resources.insert(\n-                            legacy.resources.index(position[1]),\n-                            res_id)\n-                    else:\n-                        legacy.resources.append(res_id)\n-\n-            elif remove:\n-                if res_id in legacy.resources:\n-                    legacy.resources.remove(res_id)\n-                if res_id in resources:\n-                    del resources[res_id]\n-\n-            # make sure to trigger committing to db\n-            # not sure this is necessary...\n-            legacy.resources = legacy.resources\n-\n-        if \'plone.resources.last_legacy_import\' in self.registry.records:  # noqa\n-            self.registry.records[\n-                \'plone.resources.last_legacy_import\'\n-            ].value = datetime.now()\n-            try:\n-                cookWhenChangingSettings(self.context, legacy)\n-            except (AssertionError, ComponentLookupError):\n-                # zope.globalrequest and the site might not be setup, don\'t\n-                # error out\n-                pass\ndiff --git a/Products/CMFPlone/resources/utils.py b/Products/CMFPlone/resources/utils.py\nnew file mode 100644\nindex 0000000000..3409e53549\n--- /dev/null\n+++ b/Products/CMFPlone/resources/utils.py\n@@ -0,0 +1,116 @@\n+from Acquisition import aq_base\n+from Acquisition import aq_inner\n+from Acquisition import aq_parent\n+from plone.base.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME\n+from plone.resource.file import FilesystemFile\n+from plone.resource.interfaces import IResourceDirectory\n+from Products.CMFCore.Expression import createExprContext\n+from Products.CMFCore.utils import getToolByName\n+from zExceptions import NotFound\n+from zope.component import queryUtility\n+\n+import logging\n+\n+\n+PRODUCTION_RESOURCE_DIRECTORY = "production"\n+logger = logging.getLogger(__name__)\n+\n+\n+def get_production_resource_directory():\n+    persistent_directory = queryUtility(IResourceDirectory, name="persistent")\n+    if persistent_directory is None:\n+        return ""\n+    container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n+    try:\n+        production_folder = container[PRODUCTION_RESOURCE_DIRECTORY]\n+    except NotFound:\n+        return "%s/++unique++1" % PRODUCTION_RESOURCE_DIRECTORY\n+    if "timestamp.txt" not in production_folder:\n+        return "%s/++unique++1" % PRODUCTION_RESOURCE_DIRECTORY\n+    timestamp = production_folder.readFile("timestamp.txt")\n+    if isinstance(timestamp, bytes):\n+        timestamp = timestamp.decode()\n+    return "{}/++unique++{}".format(PRODUCTION_RESOURCE_DIRECTORY, timestamp)\n+\n+\n+def get_resource(context, path):\n+    if path.startswith("++plone++"):\n+        # ++plone++ resources can be customized, we return their override\n+        # value if any\n+        overrides = get_override_directory(context)\n+        filepath = path[9:]\n+        if overrides.isFile(filepath):\n+            return overrides.readFile(filepath)\n+\n+    if "?" in path:\n+        # Example from plone.session:\n+        # "acl_users/session/refresh?session_refresh=true&type=css&minutes=5"\n+        # Traversing will not work then.  In this example we could split on "?"\n+        # and traverse to the first part, acl_users/session/refresh, but this\n+        # gives a function, and this fails when we call it below, missing a\n+        # REQUEST argument\n+        return\n+    try:\n+        resource = context.unrestrictedTraverse(path)\n+    except (NotFound, AttributeError, KeyError):\n+        logger.warning(\n+            f"Could not find resource {path}. You may have to create it first."\n+        )  # noqa\n+        return\n+\n+    if isinstance(resource, FilesystemFile):\n+        (directory, sep, filename) = path.rpartition("/")\n+        return context.unrestrictedTraverse(directory).readFile(filename)\n+\n+    # calling the resource may modify the header, i.e. the content-type.\n+    # we do not want this, so keep the original header intact.\n+    response_before = context.REQUEST.response\n+    context.REQUEST.response = response_before.__class__()\n+    if hasattr(aq_base(resource), "GET"):\n+        # for FileResource\n+        result = resource.GET()\n+    else:\n+        # any BrowserView\n+        result = resource()\n+    context.REQUEST.response = response_before\n+    return result\n+\n+\n+def get_override_directory(context):\n+    persistent_directory = queryUtility(IResourceDirectory, name="persistent")\n+    if persistent_directory is None:\n+        return\n+    if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:\n+        persistent_directory.makeDirectory(OVERRIDE_RESOURCE_DIRECTORY_NAME)\n+    return persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n+\n+\n+def evaluateExpression(expression, context):\n+    """Evaluate an object\'s TALES condition to see if it should be\n+    displayed."""\n+    try:\n+        if expression.text and context is not None:\n+            portal = getToolByName(context, "portal_url").getPortalObject()\n+\n+            # Find folder (code courtesy of CMFCore.ActionsTool)\n+            if context is None or not hasattr(context, "aq_base"):\n+                folder = portal\n+            else:\n+                folder = context\n+                # Search up the containment hierarchy until we find an\n+                # object that claims it\'s PrincipiaFolderish.\n+                while folder is not None:\n+                    if getattr(aq_base(folder), "isPrincipiaFolderish", 0):\n+                        # found it.\n+                        break\n+                    else:\n+                        folder = aq_parent(aq_inner(folder))\n+\n+            __traceback_info__ = (folder, portal, context, expression)\n+            ec = createExprContext(folder, portal, context)\n+            # add \'context\' as an alias for \'object\'\n+            ec.setGlobal("context", context)\n+            return expression(ec)\n+        return True\n+    except AttributeError:\n+        return True\ndiff --git a/Products/CMFPlone/resources/webresource.py b/Products/CMFPlone/resources/webresource.py\nnew file mode 100644\nindex 0000000000..b3d6233660\n--- /dev/null\n+++ b/Products/CMFPlone/resources/webresource.py\n@@ -0,0 +1,75 @@\n+from .utils import evaluateExpression\n+from .utils import get_resource\n+from Products.CMFCore.Expression import Expression\n+from webresource import ScriptResource\n+from webresource import StyleResource\n+from zope.component import queryUtility\n+from zope.ramcache.interfaces import ram\n+\n+\n+class PloneBaseResource:\n+    """Mixin to override certain aspects of a webresource for Plone needs."""\n+\n+    def __init__(self, context, **kw):\n+        """Initialize with Plone context"""\n+        self.context = context\n+        self.expression = kw.pop("expression", "")\n+        super().__init__(**kw)\n+\n+    @property\n+    def file_data(self):\n+        """Fetch data from using a resource via traversal"""\n+        data = get_resource(self.context, self.resource)\n+        if data is None:\n+            # This happens with plone.session when trying to get a resource\n+            # with this path:\n+            # "acl_users/session/refresh?session_refresh=true&type=css&minutes=5"\n+            # We could \'return b""\', but let\'s take the resource path instead.\n+            data = self.resource\n+        if isinstance(data, str):\n+            data = data.encode("utf8")\n+        return data\n+\n+    @property\n+    def include(self):\n+        if callable(self._include):\n+            # Note: at time of writing, this is not used in core Plone.\n+            # But upstream webresource has it, so let\'s keep it.\n+            return self._include()\n+        if not self._include:\n+            return False\n+        # We want to include the resource, but must evaluate the expression first.\n+        return self.eval_expression()\n+\n+    @include.setter\n+    def include(self, include):\n+        self._include = include\n+\n+    def eval_expression(self):\n+        if not self.expression:\n+            return True\n+        cache = queryUtility(ram.IRAMCache)\n+        cooked_expression = None\n+        if cache is not None:\n+            cooked_expression = cache.query(\n+                "plone.bundles.cooked_expressions",\n+                key=dict(prefix=self.name),\n+                default=None,\n+            )\n+        if cooked_expression is None or cooked_expression.text != self.expression:\n+            cooked_expression = Expression(self.expression)\n+            if cache is not None:\n+                cache.set(\n+                    cooked_expression,\n+                    "plone.bundles.cooked_expressions",\n+                    key=dict(prefix=self.name),\n+                )\n+        return evaluateExpression(cooked_expression, self.context)\n+\n+\n+class PloneScriptResource(PloneBaseResource, ScriptResource):\n+    """Webresource based ScriptResource for Plone"""\n+\n+\n+class PloneStyleResource(PloneBaseResource, StyleResource):\n+    """Webresource based StyleResource for Plone"""\ndiff --git a/Products/CMFPlone/setuphandlers.py b/Products/CMFPlone/setuphandlers.py\nindex 7215fdadfe..9bc454e82a 100644\n--- a/Products/CMFPlone/setuphandlers.py\n+++ b/Products/CMFPlone/setuphandlers.py\n@@ -1,8 +1,8 @@\n from Acquisition import aq_base\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.factory import _DEFAULT_PROFILE\n-from Products.CMFPlone.interfaces import IMigrationTool\n-from Products.CMFPlone.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME\n+from plone.base.interfaces import IMigrationTool\n+from plone.base.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME\n from Products.StandardCacheManagers.AcceleratedHTTPCacheManager \\\n     import AcceleratedHTTPCacheManager\n from Products.StandardCacheManagers.RAMCacheManager import RAMCacheManager\ndiff --git a/Products/CMFPlone/skins/plone_form_scripts/content_status_modify.cpy b/Products/CMFPlone/skins/plone_form_scripts/content_status_modify.cpy\ndeleted file mode 100644\nindex 6aaa1ba683..0000000000\n--- a/Products/CMFPlone/skins/plone_form_scripts/content_status_modify.cpy\n+++ /dev/null\n@@ -1,89 +0,0 @@\n-## Controller Python Script "content_status_modify"\n-##bind container=container\n-##bind context=context\n-##bind namespace=\n-##bind script=script\n-##bind state=state\n-##bind subpath=traverse_subpath\n-##parameters=workflow_action=None, comment=\'\', effective_date=None, expiration_date=None, *args\n-##title=handles the workflow transitions of objects\n-\n-from ZODB.POSException import ConflictError\n-from DateTime import DateTime\n-from Products.CMFPlone.utils import transaction_note\n-from Products.CMFPlone import PloneMessageFactory as _\n-from AccessControl import Unauthorized\n-from Products.CMFCore.utils import getToolByName\n-\n-plone_utils = getToolByName(context, \'plone_utils\')\n-contentEditSuccess = 0\n-portal_factory = getattr(context, \'portal_factory\', None)\n-if portal_factory is not None:\n-    new_context = context.portal_factory.doCreate(context)\n-else:\n-    new_context = context\n-portal_workflow = new_context.portal_workflow\n-transitions = portal_workflow.getTransitionsFor(new_context)\n-transition_ids = [t[\'id\'] for t in transitions]\n-\n-if workflow_action in transition_ids \\\n-        and not effective_date \\\n-        and context.EffectiveDate() ==\'None\':\n-    effective_date = DateTime()\n-\n-def editContent(obj, effective, expiry):\n-    kwargs = {}\n-    # may contain the year\n-    if effective and (isinstance(effective, DateTime) or len(effective) > 5):\n-        kwargs[\'effective_date\'] = effective\n-    # may contain the year\n-    if expiry and (isinstance(expiry, DateTime) or len(expiry) > 5):\n-        kwargs[\'expiration_date\'] = expiry\n-    new_context.plone_utils.contentEdit(obj, **kwargs)\n-\n-#You can transition content but not have the permission to ModifyPortalContent\n-try:\n-    editContent(new_context, effective_date, expiration_date)\n-    contentEditSuccess = 1\n-except Unauthorized:\n-    pass\n-\n-wfcontext = context\n-\n-# Create the note while we still have access to wfcontext\n-note = \'Changed status of %s at %s\' \\\n-            % (wfcontext.title_or_id(), wfcontext.absolute_url())\n-\n-if workflow_action in transition_ids:\n-    wfcontext = new_context.portal_workflow.doActionFor(context,\n-                                                        workflow_action,\n-                                                        comment=comment)\n-\n-if not wfcontext:\n-    wfcontext = new_context\n-\n-#The object post-transition could now have ModifyPortalContent permission.\n-if not contentEditSuccess:\n-    try:\n-        editContent(wfcontext, effective_date, expiration_date)\n-    except Unauthorized:\n-        pass\n-\n-transaction_note(note)\n-\n-# If this item is the default page in its parent, attempt to publish that\n-# too. It may not be possible, of course\n-if plone_utils.isDefaultPage(new_context):\n-    parent = new_context.aq_inner.aq_parent\n-    try:\n-        parent.content_status_modify(workflow_action,\n-                                     comment,\n-                                     effective_date=effective_date,\n-                                     expiration_date=expiration_date)\n-    except ConflictError:\n-        raise\n-    except Exception:\n-        pass\n-\n-context.plone_utils.addPortalMessage(_(u\'Item state changed.\'))\n-return state.set(context=wfcontext)\ndiff --git a/Products/CMFPlone/skins/plone_form_scripts/content_status_modify.cpy.metadata b/Products/CMFPlone/skins/plone_form_scripts/content_status_modify.cpy.metadata\ndeleted file mode 100644\nindex 98b6a5ffaf..0000000000\n--- a/Products/CMFPlone/skins/plone_form_scripts/content_status_modify.cpy.metadata\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-[validators]\n-validators = validate_content_status_modify\n- \n-[actions]\n-action.failure=traverse_to:string:content_status_history\n-action.success=redirect_to_action:string:view\ndiff --git a/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py b/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py\ndeleted file mode 100644\nindex 77a5ee90b0..0000000000\n--- a/Products/CMFPlone/skins/plone_form_scripts/plone_change_password.py\n+++ /dev/null\n@@ -1,54 +0,0 @@\n-## Script (Python) "plone_change_password"\n-##bind container=container\n-##bind context=context\n-##bind namespace=\n-##bind script=script\n-##bind subpath=traverse_subpath\n-##title=Action to change password\n-##parameters=password, password_confirm, current, domains=None\n-\n-from Products.CMFPlone import PloneMessageFactory as _\n-\n-REQUEST = context.REQUEST\n-if \'cancel\' in REQUEST.form:\n-    context.plone_utils.addPortalMessage(_(\'Password change was canceled.\'),\n-                                         \'warning\')\n-    return context.REQUEST.RESPONSE.redirect(\n-            \'%s/@@personal-preferences\' % context.absolute_url())\n-\n-mt = context.portal_membership\n-\n-if not mt.testCurrentPassword(current):\n-    failMessage = _(\'Does not match current password.\')\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-failMessage = context.portal_registration \\\n-                    .testPasswordValidity(password, password_confirm)\n-if failMessage:\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-member = mt.getAuthenticatedMember()\n-try:\n-    mt.setPassword(password, domains, REQUEST=context.REQUEST)\n-except AttributeError:\n-    failMessage = _(\'While changing your password an AttributeError \'\n-                    \'occurred. This is usually caused by your user being \'\n-                    \'defined outside the portal.\')\n-    context.plone_utils.addPortalMessage(failMessage, \'error\')\n-    return context.password_form(context,\n-                                 REQUEST,\n-                                 error=failMessage)\n-\n-from Products.CMFPlone.utils import transaction_note\n-transaction_note(\'Changed password for %s\' % (member.getUserName()))\n-\n-context.plone_utils.addPortalMessage(_(\'Password changed.\'))\n-\n-return context.REQUEST.RESPONSE.redirect(\n-            \'%s/@@personal-preferences\' % context.absolute_url())\ndiff --git a/Products/CMFPlone/skins/plone_form_scripts/validate_content_status_modify.vpy b/Products/CMFPlone/skins/plone_form_scripts/validate_content_status_modify.vpy\ndeleted file mode 100644\nindex ca371da369..0000000000\n--- a/Products/CMFPlone/skins/plone_form_scripts/validate_content_status_modify.vpy\n+++ /dev/null\n@@ -1,25 +0,0 @@\n-## Script (Python) "validate_content_status_history"\n-##bind container=container\n-##bind context=context\n-##bind namespace=\n-##bind script=script\n-##bind state=state\n-##bind subpath=traverse_subpath\n-##parameters=workflow_action=\'\'\n-##title=Validates content publishing\n-\n-from Products.CMFPlone import PloneMessageFactory as _\n-\n-if not workflow_action:\n-    state.setError(\'workflow_action\',\n-                   _(u\'This field is required, please provide some \'\n-                     u\'information.\'),\n-                   \'workflow_missing\')\n-\n-if state.getErrors():\n-    context.plone_utils.addPortalMessage(_(u\'Please correct the indicated \'\n-                                           u\'errors.\'),\n-                                         \'error\')\n-    return state.set(status=\'failure\')\n-else:\n-    return state\ndiff --git a/Products/CMFPlone/skins/plone_prefs/password_form.pt b/Products/CMFPlone/skins/plone_prefs/password_form.pt\ndeleted file mode 100644\nindex 01d7450483..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/password_form.pt\n+++ /dev/null\n@@ -1,98 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/prefs_main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<body>\n-\n-<metal:main fill-slot="prefs_configlet_main">\n-\n-    <h1 class="documentFirstHeading"\n-        i18n:translate="heading_change_password_for">\n-        Change password for <span tal:content="user/getUserName" tal:omit-tag="" i18n:name="user">user</span>\n-    </h1>\n-\n-    <div id="content-core">\n-        <a href=""\n-           class="link-parent"\n-           tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/dashboard"\n-           i18n:translate="label_to_dashboard">\n-            Up to my dashboard\n-        </a>\n-        <form action="plone_change_password"\n-              class="pat-formautofocus pat-formunloadalert"\n-              name="change_password"\n-              method="post">\n-\n-            <fieldset>\n-                <legend i18n:translate="legend_password_details">Password Details</legend>\n-\n-                <div class="field">\n-                    <label for="current" i18n:translate="label_current_password">Current password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_current_password">\n-                    Enter your current password.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="current"\n-                           name="current"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="field">\n-                    <label for="password" i18n:translate="label_new_password">New password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_new_password">\n-                    Enter your new password.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="password"\n-                           name="password"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="field">\n-                    <label for="password_confirm" i18n:translate="label_confirm_password">Confirm password</label>\n-\n-                    <div class="formHelp" i18n:translate="help_confirm_password">\n-                    Re-enter the password. Make sure the passwords are identical.\n-                    </div>\n-\n-                    <input type="password"\n-                           id="password_confirm"\n-                           name="password_confirm"\n-                           size="10"\n-                           />\n-                </div>\n-\n-                <div class="formControls">\n-                    <input class="context"\n-                           type="submit"\n-                           value="Change Password"\n-                           i18n:attributes="value label_change_password;"\n-                           />\n-                    <input class="standalone"\n-                           type="submit"\n-                           name="cancel"\n-                           value="Cancel"\n-                           i18n:attributes="value label_cancel;"\n-                           />\n-                </div>\n-\n-                <input tal:replace="structure context/@@authenticator/authenticator" />\n-\n-            </fieldset>\n-        </form>\n-    </div>\n-\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata b/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata\ndeleted file mode 100644\nindex 51853704e4..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/password_form.pt.metadata\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-[default]\n-title=Change password\ndiff --git a/Products/CMFPlone/skins/plone_prefs/plone_control_panel.pt b/Products/CMFPlone/skins/plone_prefs/plone_control_panel.pt\ndeleted file mode 100644\nindex ea31e1ab7e..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/plone_control_panel.pt\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-<tal:comment tal:condition="nothing">\n-  Deprecated; see the overview-controlpanel view in plone.app.controlpanel.\n-</tal:comment>\n-<tal:block tal:replace="structure context/@@overview-controlpanel"/>\ndiff --git a/Products/CMFPlone/skins/plone_prefs/plone_control_panel.pt.metadata b/Products/CMFPlone/skins/plone_prefs/plone_control_panel.pt.metadata\ndeleted file mode 100644\nindex 5c66fa7a36..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/plone_control_panel.pt.metadata\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-[default]\n-title=Site Setup\n-\n-[security]\n-View=0:Authenticated\ndiff --git a/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt b/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt\ndeleted file mode 100644\nindex 715c7c5c58..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt\n+++ /dev/null\n@@ -1,51 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      i18n:domain="plone">\n-<body>\n-<metal:portlet define-macro="portlet"\n-   tal:define="controlPanel python:modules[\'Products.CMFCore.utils\'].getToolByName(here, \'portal_controlpanel\');\n-               groups python:controlPanel.getGroups(\'site\');\n-               site_url controlPanel/site_url">\n-\n-<section class="portlet portletNavigationTree portletSiteSetup" role="section"\n-    id="portlet-prefs"\n-    tal:condition="controlPanel/maySeeSomeConfiglets">\n-  <header class="portletHeader">\n-        <a href=""\n-           tal:attributes="href string:${site_url}/@@overview-controlpanel"\n-           i18n:translate="">Site Setup</a>\n-  </header>\n-\n-  <nav class="portletContent">\n-    <ul class="configlets">\n-      <li><tal:group\n-          tal:repeat="group groups">\n-\n-          <tal:block tal:define="configlets python:controlPanel.enumConfiglets(group=group[\'id\'])"\n-                     tal:condition="configlets">\n-              <strong tal:content="group/title"\n-                      i18n:translate="">Plone Configlet Group Title</strong>\n-              <ul class="configlets">\n-                  <tal:configlets tal:repeat="configlet configlets">\n-                  <li tal:condition="configlet/visible">\n-                      <a href=""\n-                         tal:define="icon configlet/icon|nothing"\n-                         tal:attributes="href configlet/url">\n-                      <tal:configletname tal:content="configlet/title"\n-                                         i18n:translate=""></tal:configletname>\n-                      </a>\n-                  </li>\n-                  </tal:configlets>\n-              </ul>\n-          </tal:block>\n-      </tal:group></li>\n-    </ul>\n-  </nav>\n-\n-</section>\n-\n-</metal:portlet>\n-</body>\n-</html>\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_form.pt b/Products/CMFPlone/skins/plone_prefs/prefs_error_log_form.pt\ndeleted file mode 100644\nindex 9dcf8f6a23..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_form.pt\n+++ /dev/null\n@@ -1,190 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/prefs_main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<body>\n-\n-<metal:main fill-slot="prefs_configlet_main">\n-\n-    <a href=""\n-       id="setup-link"\n-       tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-       i18n:translate="">\n-        Site Setup\n-    </a>\n-\n-    <h1 class="documentFirstHeading"\n-        i18n:translate="heading_error_log">Error log</h1>\n-\n-    <div class="documentDescription" i18n:translate="description_error_log_setup">\n-        This page lists the exceptions that have occurred in this site\n-        recently. You can configure how many exceptions should be kept\n-        and whether the exceptions should be copied to Zope\'s event log\n-        file(s).\n-    </div>\n-\n-    <div id="content-core">\n-\n-        <p>\n-            <a href="https://docs.plone.org/appendices/error-reference.html"\n-               i18n:translate="description_error_rerference_link">\n-                Refer to the plone.org error reference for more information about\n-                these exceptions.\n-            </a>\n-        </p>\n-\n-        <form action="prefs_error_log_update" method="get">\n-\n-            <fieldset tal:define="entries context/error_log/getLogEntries">\n-\n-                <legend i18n:translate="legend_logexception">Exception Log (most recent first)</legend>\n-\n-                <div class="field">\n-                    <label for="search_entry"\n-                           i18n:translate="label_search_entry">Search for an error log entry <span class="formHelp"> (such as "1257962690.640.49636048561")</span></label>\n-\n-                    <input type="text"\n-                           name="search_entry"\n-                           id="search_entry"\n-                           size="35" />\n-                </div>\n-\n-                <div class="field" tal:condition="not:entries" i18n:translate="legend_lognoexceptions">\n-                    No exceptions logged.\n-                </div>\n-\n-                <div class="formControls">\n-                    <input class="context"\n-                           type="submit"\n-                           name="form.button.search"\n-                           value="Search"\n-                           i18n:attributes="value label_search;" />\n-                    <input class="standalone"\n-                           type="submit"\n-                           name="form.button.refresh"\n-                           value="Refresh"\n-                           i18n:attributes="value label_refresh;" />\n-                    <input class="standalone"\n-                           type="submit"\n-                           name="form.button.clear"\n-                           value="Clear Displayed Entries"\n-                           i18n:attributes="value label_clear_displayed_entries;" />\n-                    <input class="standalone"\n-                           type="submit"\n-                           name="form.button.showall"\n-                           value="Show all entries"\n-                           i18n:attributes="value label_show_all_entries;" />\n-                </div>\n-\n-                <table class="listing"\n-                       id="sortable"\n-                       summary="Exception Log (most recent first)"\n-                       i18n:attributes="summary summary_exception_log;"\n-                       tal:condition="entries">\n-                    <thead>\n-                        <tr>\n-                            <th i18n:translate="label_time">Time</th>\n-                            <th i18n:translate="label_user_name">User Name</th>\n-                            <th i18n:translate="label_exception">Exception</th>\n-                        </tr>\n-                    </thead>\n-\n-                    <tbody tal:define="member context/@@plone_portal_state/member;\n-                                       updatetime python:member.getProperty(\'error_log_update\', 0.0);\n-                                       updatetime python:updatetime and updatetime or 0.0;\n-                                       updatetime python:float(updatetime)">\n-\n-                        <tal:entry tal:repeat="entry entries">\n-                        <tr tal:define="oddrow repeat/entry/odd;"\n-                            tal:attributes="class python:test(oddrow, \'even\', \'odd\')"\n-                            tal:condition="python: test(entry[\'time\'] > updatetime,1,0)">\n-\n-                            <td\n-                                tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;"\n-                                tal:content="python:toLocalizedTime(DateTime(entry[\'time\']), long_format=True)">13:04:41</td>\n-                            <td tal:content="string:${entry/username} (${entry/userid})">joe</td>\n-                            <td>\n-                                <a href="showEntry"\n-                                   tal:attributes="href string:prefs_error_log_showEntry?id=${entry/id}">\n-                                    <span tal:replace="entry/type">AttributeError</span>:\n-                                    <span tal:define="value entry/value"\n-                                          tal:content="python: len(value) &lt; 70 and value or value[:70] + \'...\'">\n-                                    Application object has no attribute "gak"\n-                                    </span>\n-                                </a>\n-                            </td>\n-                        </tr>\n-                        </tal:entry>\n-                    </tbody>\n-                </table>\n-\n-            </fieldset>\n-        </form>\n-\n-        <form action="prefs_error_log_setProperties"\n-              method="post"\n-              class="pat-formunloadalert">\n-\n-            <fieldset tal:define="props context/error_log/getProperties">\n-\n-                <legend i18n:translate="legend_logdetails">Log details</legend>\n-\n-                <div class="field">\n-                    <label for="keep_entries"\n-                           i18n:translate="label_number_exceptions">Number of exceptions to keep</label>\n-\n-                    <div></div>\n-\n-                    <input type="text"\n-                           name="keep_entries"\n-                           id="keep_entries"\n-                           size="40"\n-                           tal:attributes="value props/keep_entries" />\n-                </div>\n-\n-                <div class="field">\n-                    <input type="checkbox"\n-                           class="noborder"\n-                           id="cb_copy_to_zlog"\n-                           name="copy_to_zlog"\n-                           tal:attributes="checked props/copy_to_zlog;\n-                                           disabled not:context/error_log/checkEventLogPermission|nothing" />\n-\n-                    <label for="cb_copy_to_zlog" i18n:translate="label_copy_exceptions">\n-                        Copy exceptions to the event log\n-                    </label>\n-\n-                </div>\n-\n-                <div class="field">\n-                    <label for="ignored_exceptions"\n-                           i18n:translate="label_ignored_exception">Ignored exception types</label>\n-\n-                    <textarea name="ignored_exceptions:lines"\n-                              id="ignored_exceptions"\n-                              cols="40"\n-                              rows="3"\n-                              tal:content="python: \'\\n\'.join(props[\'ignored_exceptions\'])"></textarea>\n-                </div>\n-\n-                <div class="formControls">\n-                    <input class="context"\n-                           type="submit"\n-                           name="submit"\n-                           value="Save"\n-                           i18n:attributes="value label_save;" />\n-                </div>\n-\n-            </fieldset>\n-\n-        </form>\n-    </div>\n-\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_form.pt.metadata b/Products/CMFPlone/skins/plone_prefs/prefs_error_log_form.pt.metadata\ndeleted file mode 100644\nindex d9c2bf48c9..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_form.pt.metadata\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-[default]\n-title=Error Log\n-\n-[security]\n-View = 0:Manager\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_setProperties.py b/Products/CMFPlone/skins/plone_prefs/prefs_error_log_setProperties.py\ndeleted file mode 100644\nindex 254eba829e..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_setProperties.py\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-## Script (Python) "prefs_error_log_setProperties"\n-##bind container=container\n-##bind context=context\n-##bind namespace=\n-##bind script=script\n-##bind subpath=traverse_subpath\n-##parameters=keep_entries,ignored_exceptions,copy_to_zlog=0\n-##title=\n-\n-from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.utils import safe_nativestring\n-\n-request = context.REQUEST\n-\n-ignored_exceptions = map(safe_nativestring, ignored_exceptions)\n-context.error_log.setProperties(keep_entries, copy_to_zlog, ignored_exceptions)\n-context.plone_utils.addPortalMessage(_(\'Changes made.\'))\n-\n-return request.RESPONSE.redirect(\n-            context.absolute_url() + \'/prefs_error_log_form\')\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt.metadata b/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt.metadata\ndeleted file mode 100644\nindex 3028b2bbc4..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt.metadata\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-[default]\n-title=Error Log Entry\n-\n-[security]\n-View=0:Authenticated\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_update.py b/Products/CMFPlone/skins/plone_prefs/prefs_error_log_update.py\ndeleted file mode 100644\nindex b636dda8f1..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_update.py\n+++ /dev/null\n@@ -1,26 +0,0 @@\n-## Script (Python) "prefs_error_log_update"\n-## Giorgio, Lorty - Plone Castle Sprint\n-\n-from Products.CMFPlone import PloneMessageFactory as _\n-\n-request = context.REQUEST\n-membership_tool = context.portal_membership\n-member = membership_tool.getAuthenticatedMember()\n-\n-if getattr(request, \'form.button.search\', None) is not None:\n-    search = request.form.get(\'search_entry\')\n-    if search == \'\':\n-        member.setProperties(error_log_update=0.0)\n-        context.plone_utils.addPortalMessage(_(\'Showing all entries\'))\n-        return request.RESPONSE.redirect(context.absolute_url() + \'/prefs_error_log_form\')\n-    return request.RESPONSE.redirect(context.absolute_url() + \'/prefs_error_log_showEntry?id=%s\' % search)\n-elif getattr(request, \'form.button.showall\', None) is not None:\n-    member.setProperties(error_log_update=0.0)\n-    context.plone_utils.addPortalMessage(_(\'Showing all entries\'))\n-    return request.RESPONSE.redirect(context.absolute_url() + \'/prefs_error_log_form\')\n-elif getattr(request, \'form.button.clear\', None) is not None:\n-    member.setProperties(error_log_update=DateTime().timeTime())\n-    context.plone_utils.addPortalMessage(_(\'Entries cleared\'))\n-    return request.RESPONSE.redirect(context.absolute_url() + \'/prefs_error_log_form\')\n-else:\n-    return request.RESPONSE.redirect(context.absolute_url() + \'/prefs_error_log_form\')\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt b/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt\ndeleted file mode 100644\nindex e9e1c666c2..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt\n+++ /dev/null\n@@ -1,37 +0,0 @@\n-<metal:page define-macro="master" i18n:domain="plone">\n-  <tal:block metal:use-macro="context/@@main_template/macros/master">\n-\n-    <metal:block fill-slot="top_slot">\n-        <metal:override define-slot="top_slot">\n-            <tal:defines tal:define="dummy python:request.set(\'disable_border\',1);\n-                                     controlPanel python:modules[\'Products.CMFCore.utils\'].getToolByName(here, \'portal_controlpanel\');\n-                                     show_leftcolumn controlPanel/maySeeSomeConfiglets;\n-                                     disable_column_one python:request.set(\'disable_plone.leftcolumn\', 1);\n-                                     disable_column_two python:request.set(\'disable_plone.rightcolumn\',not show_leftcolumn);"/>\n-        </metal:override>\n-    </metal:block>\n-\n-    <metal:override fill-slot="portlets_two_slot">\n-        <metal:override define-slot="column_two_slot">\n-            <metal:prefs use-macro="here/portlet_prefs/macros/portlet" />\n-        </metal:override>\n-    </metal:override>\n-\n-    <metal:override fill-slot="content">\n-        <metal:slot define-slot="prefs_configlet_wrapper">\n-          <metal:slot define-slot="prefs_configlet_content">\n-\n-            <metal:block metal:use-macro="context/@@main_template/macros/content">\n-              <metal:override metal:fill-slot="main">\n-                <metal:slot metal:define-slot="prefs_configlet_main" tal:content="nothing">\n-                  Page body text\n-                </metal:slot>\n-              </metal:override>\n-            </metal:block>\n-\n-          </metal:slot>\n-        </metal:slot>\n-    </metal:override>\n-\n-  </tal:block>\n-</metal:page>\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt.metadata b/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt.metadata\ndeleted file mode 100644\nindex c8a8d63f73..0000000000\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_main_template.pt.metadata\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-[default]\n-title=Group Properties\n-\n-[security]\n-View=0:Authenticated\ndiff --git a/Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py b/Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py\nindex b31ebce4ea..ad62e1c912 100644\n--- a/Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py\n+++ b/Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py\n@@ -16,11 +16,6 @@\n if mtool.isAnonymousUser():\n     return False\n \n-# Temporary content cannot be changed through EE (raises AttributeError)\n-portal_factory = getToolByName(portal, \'portal_factory\', None)\n-if portal_factory and portal_factory.isTemporary(context):\n-    return False\n-\n # Check if the member property\n member = mtool.getAuthenticatedMember()\n if not member.getProperty(\'ext_editor\', False):\ndiff --git a/Products/CMFPlone/skins/plone_templates/index_html.pt b/Products/CMFPlone/skins/plone_templates/index_html.pt\ndeleted file mode 100644\nindex bceba801f3..0000000000\n--- a/Products/CMFPlone/skins/plone_templates/index_html.pt\n+++ /dev/null\n@@ -1,24 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/@@main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<body>\n-\n-<metal:main fill-slot="main">\n-\n-    <h1 class="documentFirstHeading" i18n:translate="heading_welcome_to">Welcome to\n-        <span i18n:name="sitename" tal:omit-tag="" tal:content="context/Title">Portal title</span>\n-    </h1>\n-\n-    <p class="documentDescription" tal:content="context/description">\n-        Portal description\n-    </p>\n-\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/Products/CMFPlone/skins/plone_templates/index_html.pt.metadata b/Products/CMFPlone/skins/plone_templates/index_html.pt.metadata\ndeleted file mode 100644\nindex 6660362fbc..0000000000\n--- a/Products/CMFPlone/skins/plone_templates/index_html.pt.metadata\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-[default]\n-title=Default frontpage\ndiff --git a/Products/CMFPlone/skins/plone_templates/kss_generic_macros.pt b/Products/CMFPlone/skins/plone_templates/kss_generic_macros.pt\ndeleted file mode 100644\nindex 3e5a97ec6f..0000000000\n--- a/Products/CMFPlone/skins/plone_templates/kss_generic_macros.pt\n+++ /dev/null\n@@ -1,45 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml"\n-      xml:lang="en"\n-      lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      i18n:domain="plone">\n-  <head><title></title></head>\n-  <body>\n-\n-        <metal:title_view define-macro="generic_title_view">\n-            <tal:archetypes condition="exists:context/getField">\n-                <h1 metal:define-macro="title-field-view"\n-                    id="parent-fieldname-title"\n-                    tal:attributes="class string:documentFirstHeading;">\n-                    <span metal:define-slot="inside"\n-                          tal:replace="context/Title">title</span>\n-                </h1>\n-            </tal:archetypes>\n-            <h1 tal:content="context/Title" class="documentFirstHeading"\n-                tal:condition="not:exists:context/getField">\n-                Title or id\n-            </h1>\n-        </metal:title_view>\n-\n-        <metal:description_view define-macro="generic_description_view">\n-            <tal:archetypes condition="exists:context/getField">\n-                <div metal:define-macro="description-field-view"\n-                   id="parent-fieldname-description"\n-                   tal:condition="context/Description"\n-                   tal:attributes="class string:documentDescription;">\n-                   <span metal:define-slot="inside"\n-                         tal:replace="context/Description">Description</span>\n-                </div>\n-            </tal:archetypes>\n-            <div class="documentDescription description"\n-                 tal:content="context/Description"\n-                 tal:define="have_at exists:context/getField"\n-                 tal:condition="python:context.Description() and not have_at">\n-                Description\n-            </div>\n-        </metal:description_view>\n-\n-  </body>\n-</html>\ndiff --git a/Products/CMFPlone/skins/plone_templates/recently_modified.pt.metadata b/Products/CMFPlone/skins/plone_templates/recently_modified.pt.metadata\ndeleted file mode 100644\nindex 5d68938f48..0000000000\n--- a/Products/CMFPlone/skins/plone_templates/recently_modified.pt.metadata\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-[default]\n-title=Recently modified\ndiff --git a/Products/CMFPlone/skins/plone_templates/recently_published.pt.metadata b/Products/CMFPlone/skins/plone_templates/recently_published.pt.metadata\ndeleted file mode 100644\nindex 3e086cc76a..0000000000\n--- a/Products/CMFPlone/skins/plone_templates/recently_published.pt.metadata\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-[default]\n-title=Recently published\ndiff --git a/Products/CMFPlone/skins/plone_templates/test_rendering.pt b/Products/CMFPlone/skins/plone_templates/test_rendering.pt\ndeleted file mode 100644\nindex a44a0a5d5b..0000000000\n--- a/Products/CMFPlone/skins/plone_templates/test_rendering.pt\n+++ /dev/null\n@@ -1,570 +0,0 @@\n-<tal:block tal:define="dummy python:request.set(\'disable_plone.leftcolumn\', False);\n-                       dummy python:request.set(\'disable_plone.rightcolumn\', False)"/>\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/@@main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<body>\n-\n-<metal:main fill-slot="main">\n-\n-<h1 class="documentFirstHeading">Plone User Interface elements test page</h1>\n-\n-<div class="documentDescription">\n-This page lists the common user interface elements that exist in Plone, and\n-shows you how they are rendered. It also tests a couple of common Internet\n-Explorer rendering bugs, so you can see if your changes have triggered any\n-bad behaviour on this front.\n-</div>\n-\n-<div id="content-core">\n-<pre>\n-Headlines\n-</pre>\n-\n-<h1>Headline h1</h1>\n-<p>And a paragraph</p>\n-<h2>Headline h2</h2>\n-<p>And a paragraph</p>\n-<h3>Headline h3</h3>\n-<p>And a paragraph</p>\n-<h4>Headline h4</h4>\n-<p>And a paragraph</p>\n-<h5>Headline h5</h5>\n-<p>And a paragraph</p>\n-<h6>Headline h6</h6>\n-\n-<pre>Example document rendering</pre>\n-\n-<div class="portalMessage info" role="status">\n-    <strong>\n-        Info\n-    </strong>\n-    <span tal:omit-tag="">\n-        The portalMessage class, can also contain <a href="#">links</a> - used to\n-        give the user temporary status messages.\n-    </span>\n-</div>\n-\n-<dl class="portalMessage error" role="alert">\n-    <dt>\n-        Error\n-    </dt>\n-    <dd>\n-        The portalMessage \'error\' class, can also contain <a href="#">links</a> - used to\n-        give the user temporary status messages.\n-    </dd>\n-</dl>\n-\n-<dl class="portalMessage warning" role="status">\n-    <dt>\n-        Warning\n-    </dt>\n-    <dd>\n-        The portalMessage \'warning\' class, can also contain <a href="#">links</a> - used to\n-        give the user temporary status messages.\n-    </dd>\n-</dl>\n-\n-<h1 class="documentFirstHeading">Document Headline</h1>\n-\n-<div id="plone-document-byline" class="documentByLine">\n-    <span class="documentAuthor">\n-      by\n-      <a href="http://localhost:8080/Plone/author/admin">admin</a>\n-    </span>\n-\n-   <span class="documentModified">\n-     &mdash;\n-     <span>\n-       last modified\n-     </span>\n-     May 21, 2010 10:02 AM\n-   </span>\n-\n-   <span id="content-history" class="contentHistory">\n-     &mdash;\n-     <a href="http://localhost:8080/Plone/front-page/@@historyview" rel="#pb_4" class="link-overlay" style="cursor: pointer;">History</a>\n-   </span>\n-</div>\n-\n-<div class="documentDescription">\n-The document description\n-</div>\n-\n-<p>\n-Normal document body text,\n-<strong>strong text</strong>,\n-<em>emphasised text</em>,\n-Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Quisque odio sem, aliquam ut, suscipit at, aliquet non, justo. Vestibulum vitae urna et mi volutpat luctus. Nulla auctor, lacus ut consectetuer sagittis, erat odio vulputate sapien, eu placerat diam mauris id turpis. Aenean quis ipsum. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Pellentesque rutrum. Sed mattis turpis sit amet ipsum viverra pharetra. Nunc facilisis, augue non dapibus gravida, risus quam vulputate quam, non venenatis dui massa in leo. Maecenas scelerisque dapibus libero. Suspendisse potenti.\n-example <a href="#">Normal internal site link</a> inside a paragraph,\n-example <a href="http://plone.org">External link to plone.org</a>,\n-example <a href="https://plone.org">Secure (HTTPS) link to plone.org</a>,\n-example <a href="mailto:some@address">Mailto link</a>,\n-example <a href="ftp://some.site">FTP link</a>,\n-example <a href="news://some.site">NNTP (news) link</a>,\n-example <a href="webcal://some.site">WebCal link</a>,\n-example <a href="feed://some.site">RSS feed link</a>,\n-example <a href="irc://some.network/#channel">IRC link</a>.\n-</p>\n-\n-<ul>\n-    <li>Unordered list element 1\n-        <ul>\n-            <li>Unordered list subelement 1</li>\n-        </ul>\n-    </li>\n-    <li>Unordered list element 2</li>\n-    <li>Unordered list element 3</li>\n-</ul>\n-\n-<ol>\n-    <li>Ordered list element 1\n-        <ol><li>Ordered list subelement 1</li></ol>\n-    </li>\n-    <li>Ordered list element 2</li>\n-    <li>Ordered list element 3</li>\n-</ol>\n-\n-<dl>\n-    <dt>Definition list term</dt>\n-    <dd>Definition List description, Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Quisque odio sem, aliquam ut, suscipit at, aliquet non, justo.\n-    </dd>\n-    <dd>Another Definition List description, Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Quisque odio sem, aliquam ut, suscipit at, aliquet non, justo.\n-    </dd>\n-</dl>\n-\n-<h3>Definition List deprecation</h3>\n-\n-As of Plone 5, we try to get rid of Definition Lists where they don\'t act as\n-definition lists. We replace them in the following manners.\n-\n-\n-<h4>in portal messages</h4>\n-\n-<div class="portalMessage info" role="status">\n-  <strong>Not important</strong>\n-  This message is here to tell you something went just as you expected.\n-</div>\n-<div class="portalMessage warning" role="status">\n-  <strong>You might run into problems</strong>\n-  Please check your settings, be sure what you\'re doing is right.\n-</div>\n-<div class="portalMessage error" role="alert">\n-  <strong>Something went wrong</strong>\n-  This is bad, you must notice this.\n-</div>\n-\n-<h4>in listings</h4>\n-\n-<div>\n-  <article>\n-    <heading><a href="">Item one</a></heading>\n-    <p>Description</p>\n-  </article>\n-  <article>\n-    <heading><a href="">Item two</a></heading>\n-    <p>Description</p>\n-  </article>\n-</div>\n-\n-<h2>\n-Table of class <code>listing</code>\n-</h2>\n-\n-<table class="listing" id="someid" summary="Sortable table example">\n-    <!-- By giving a table an ID, it gets the sortable option.\n-         Use class="nosort" to override on a table or column basis. -->\n-    <thead>\n-        <tr>\n-            <th>Table heading</th>\n-            <th>Another heading (sortable, click to sort)</th>\n-            <th class="nosort">Fixed column (not sortable)</th>\n-        </tr>\n-    </thead>\n-    <tbody>\n-        <tr class="odd">\n-            <td>Odd table item</td>\n-            <td>Item 1</td>\n-            <td>Another item</td>\n-        </tr>\n-        <tr class="even">\n-            <td>Even table item</td>\n-            <td>Item 2</td>\n-            <td>Yet another item</td>\n-        </tr>\n-        <tr class="odd">\n-            <td>Odd table item</td>\n-            <td>Item 3</td>\n-            <td>And one more item</td>\n-        </tr>\n-    </tbody>\n-</table>\n-\n-<h2>\n-Table of class <code>vertical listing</code>\n-</h2>\n-\n-<table class="vertical listing" summary="Vertical listing example">\n-    <tbody>\n-        <tr>\n-            <th>Table heading</th>\n-            <td>Odd table item</td>\n-        </tr>\n-        <tr>\n-            <th>Another heading</th>\n-            <td>Even table item</td>\n-        </tr>\n-    </tbody>\n-</table>\n-\n-<h2>Forms</h2>\n-\n-<form>\n-    <fieldset>\n-        <legend>Fieldset legend</legend>\n-\n-        <div class="field">\n-            <label for="onefield">Text field</label>\n-            <span class="fieldRequired" title="Required"\n-                  i18n:attributes="title title_required;"\n-                  i18n:translate="label_required">(Required)</span>\n-            <div class="formHelp">\n-                This is the help for this form field. And <a href="#">links are also possible</a>.\n-            </div>\n-            <input type="text" id="onefield" value="Some content" />\n-        </div>\n-        <div class="field error">\n-            <label for="anotherfield">Text field with error</label>\n-            <span class="fieldRequired" title="Required"\n-                  i18n:attributes="title title_required;"\n-                  i18n:translate="label_required">(Required)</span>\n-            <div class="formHelp">\n-                This field is just here to demonstrate an error message.\n-            </div>\n-            <div>This is the error message.</div>\n-            <input type="text" id="anotherfield" value="Some content" />\n-        </div>\n-        <div class="field">\n-            <label for="onecheckbox">Checkbox</label>\n-            <span class="fieldRequired" title="Required"\n-                  i18n:attributes="title title_required;"\n-                  i18n:translate="label_required">(Required)</span>\n-            <div class="formHelp">\n-                This is a checkbox field.\n-            </div>\n-            <input type="checkbox" id="onecheckbox" />\n-        </div>\n-        <div class="field error">\n-            <label for="anothercheckbox">Checkbox with error</label>\n-            <span class="fieldRequired" title="Required"\n-                  i18n:attributes="title title_required;"\n-                  i18n:translate="label_required">(Required)</span>\n-            <div class="formHelp">\n-                This checkbox field is just here to demonstrate an error message.\n-            </div>\n-            <div>This is the error message.</div>\n-            <input type="checkbox" id="anothercheckbox" />\n-        </div>\n-        <div class="field">\n-            <label for="onestylishcheckbox">Checkbox without border</label>\n-            <span class="fieldRequired" title="Required"\n-                  i18n:attributes="title title_required;"\n-                  i18n:translate="label_required">(Required)</span>\n-            <div class="formHelp">\n-                This is a checkbox field.\n-            </div>\n-            <input type="checkbox"\n-                   class="noborder"\n-                   id="onestylishcheckbox" />\n-        </div>\n-        <div class="field error">\n-            <label for="anotherstylishcheckbox">\n-            Checkbox without border with error</label>\n-            <span class="fieldRequired" title="Required"\n-                  i18n:attributes="title title_required;"\n-                  i18n:translate="label_required">(Required)</span>\n-            <div class="formHelp">\n-                This checkbox field is just here to demonstrate an error message.\n-            </div>\n-            <div>This is the error message.</div>\n-            <input type="checkbox"\n-                   class="noborder"\n-                   id="anotherstylishcheckbox" />\n-        </div>\n-        <div class="field">\n-            <label>Radio</label>\n-            <span class="fieldRequired" title="Required"\n-                  i18n:attributes="title title_required;"\n-                  i18n:translate="label_required">(Required)</span>\n-            <div class="formHelp">\n-                This is a checkbox field.\n-            </div>\n-            <label>First\n-            <input class="noborder"\n-                   type="radio"\n-                   name="radio_group1" />\n-            </label>\n-            <br />\n-            <label>Second\n-            <input class="noborder"\n-                   type="radio"\n-                   name="radio_group1" />\n-            </label>\n-            <br />\n-            <label>Third\n-            <input class="noborder"\n-                   type="radio"\n-                   name="radio_group1" />\n-            </label>\n-            <br />\n-        </div>\n-        <div class="field error">\n-            <label>Radio with error</label>\n-            <span class="fieldRequired" title="Required"\n-                  i18n:attributes="title title_required;"\n-                  i18n:translate="label_required">(Required)</span>\n-            <div class="formHelp">\n-                This checkbox field is just here to demonstrate an error message.\n-            </div>\n-            <div>This is the error message.</div>\n-            <label>First\n-            <input class="noborder"\n-                   type="radio"\n-                   name="radio_group2" />\n-            </label>\n-            <br />\n-            <label>Second\n-            <input class="noborder"\n-                   type="radio"\n-                   name="radio_group2" />\n-            </label>\n-            <br />\n-            <label>Third\n-            <input class="noborder"\n-                   type="radio"\n-                   name="radio_group2" />\n-            </label>\n-            <br />\n-        </div>\n-        <div class="formControls">\n-            <input class="context"\n-                   type="submit"\n-                   value="Context submit" />\n-            <input class="standalone"\n-                   type="submit"\n-                   value="Standalone submit" />\n-            <input class="destructive"\n-                   type="submit"\n-                   value="Destructive submit" />\n-            <input type="submit"\n-                   value="Submit" />\n-        </div>\n-        <div class="formControls">\n-            <input class="context"\n-                   type="button"\n-                   value="Context button" />\n-            <input class="standalone"\n-                   type="button"\n-                   value="Standalone button" />\n-            <input class="destructive"\n-                   type="button"\n-                   value="Destructive button" />\n-            <input type="button"\n-                   value="Button" />\n-        </div>\n-    </fieldset>\n-</form>\n-\n-<h2>Table with form elements</h2>\n-\n-<form>\n-    <table id="sortable"\n-         class="listing"\n-         summary="Content listing"\n-         cellpadding="0" cellspacing="0">\n-        <thead>\n-            <tr>\n-                <th class="nosort">\n-                    <input class="noborder"\n-                           type="checkbox"\n-                           src="select_all_icon.png"\n-                           name="selectButton"\n-                           title="Select all items"\n-                           onClick="toggleSelect(this,\'paths:list\');"\n-                           tal:attributes="src string:${context/portal_url}/select_all_icon.png"\n-                           alt="Select all items"\n-                           i18n:attributes="title label_select_all_items; alt label_select_all_items;" />\n-                </th>\n-                <th>&nbsp;Title&nbsp;</th>\n-                <th>&nbsp;Stuff&nbsp;</th>\n-            </tr>\n-        </thead>\n-        <tbody>\n-            <tr class="odd">\n-                <td>\n-                   <input type="checkbox"\n-                          class="noborder"\n-                          name="paths:list" id="#"\n-                          value="#" />\n-                </td>\n-                <td><a href="#">Title</a></td>\n-                <td>with class noborder</td>\n-            </tr>\n-            <tr class="even">\n-                <td>\n-                   <input type="checkbox"\n-                          class="noborder"\n-                              name="paths:list" id="#"\n-                          value="#" />\n-                </td>\n-                <td><a href="#">Title</a></td>\n-                <td>with class noborder</td>\n-            </tr>\n-        </tbody>\n-    </table>\n-</form>\n-\n-<div>\n-    <h2>Collapsible form</h2>\n-    <form id="searchform" name="search" method="get" class="pat-formautofocus" action="search">\n-\n-        <div class="field collapsible">\n-            <label class="collapser collapsed" for="created">New items since</label>\n-\n-            <div class="collapse" style="display: none;">\n-                    <div class="formHelp">\n-                    Return items added since you were last logged on, the last week, etc.\n-                    </div>\n-\n-\n-                    <select id="created" name="created:list:date">\n-                        <option value="2010/09/06 17:50:45.971272 GMT-7">Last log-in</option>\n-                        <option value="2010/09/05"> Yesterday </option>\n-                        <option value="2010/08/30"> Last week </option>\n-                        <option value="2010/08/06"> Last month </option>\n-                        <option selected="selected" class="default_option" value="1970/02/01"> Ever </option>\n-                    </select>\n-\n-            </div>\n-\n-        </div>\n-\n-\n-        <div class="field collapsible">\n-            <label class="collapser collapsed" for="Creator">Author</label>\n-\n-            <div class="collapse" style="display: none;">\n-                <div class="formHelp">\n-                Return items created by a particular person.\n-                </div>\n-\n-\n-                <select id="Creator" name="Creator">\n-                    <option class="default_option" value="">Any Author</option>\n-\n-                        <option value="admin">admin</option>\n-\n-                </select>\n-            </div>\n-        </div>\n-\n-        <div id="clear-space-before-submit" class="visualClear"><!-- --></div>\n-\n-    </form>\n-</div>\n-\n-<div>\n-    <h2>Select All/None</h2>\n-    <form id="searchform" name="search" method="get" class="pat-formautofocus" action="search">\n-        <div>\n-            <label>Item type</label>\n-        </div>\n-        <div class="formHelp">\n-            Return items of a specific type.\n-        </div>\n-        <span class="optionsToggle">\n-            <input type="checkbox" checked="checked" class="noborder" id="pt_toggle" value="#" name="pt_toggle" onclick="javascript:toggleSelect(this, \'portal_type:list\', true)" src="http://localhost:8080/Plone/select_all_icon.png">\n-            <label for="pt_toggle">Select All/None</label>\n-        </span>\n-        <br>\n-        <div style="float: left; margin-right: 2em;">\n-            <input type="checkbox" id="portal_type_1_1" checked="checked" class="noborder" value="Document" name="portal_type:list">\n-            <label for="portal_type_1_1">Page</label>\n-            <br>\n-            <input type="checkbox" id="portal_type_1_2" checked="checked" class="noborder" value="Folder" name="portal_type:list">\n-            <label for="portal_type_1_2">Folder</label>\n-            <br>\n-        </div>\n-        <div style="float: left; margin-right: 2em;">\n-            <input type="checkbox" id="portal_type_2_1" checked="checked" class="noborder" value="Topic" name="portal_type:list">\n-            <label for="portal_type_2_1">Collection</label>\n-            <br>\n-        </div>\n-    </form>\n-    <div class="visualClear"></div>\n-</div>\n-\n-\n-<div>\n-    <h2>Action menu</h2>\n-    <dl class="actionMenu" id="actioMenuDemo">\n-        <dt class="actionMenuHeader">\n-            <a href="#">Action menu title</a>\n-        </dt>\n-        <dd class="actionMenuContent">\n-            Menu content\n-        </dd>\n-    </dl>\n-</div>\n-\n-<div>\n-    <h2>Collapsible section</h2>\n-    <dl class="collapsible">\n-        <dt class="collapsibleHeader">\n-            Collapsible section title\n-        </dt>\n-        <dd class="collapsibleContent">\n-            Collapsible section content\n-        </dd>\n-    </dl>\n-</div>\n-\n-\n-</div>\n-\n-</metal:main>\n-\n-<aside id="portal-column-one" metal:fill-slot="column_one_slot">\n-  <section class="portlet">\n-    <header class="portletHeader">Portlet header</header>\n-    <ul class="portletContent">\n-      <li class="portletItem">Item one</li>\n-      <li class="portletItem">Item two</li>\n-    </ul>\n-    <footer class="portletFooter">Portlet footer</footer>\n-  </section>\n-</aside>\n-\n-<aside id="portal-column-two" metal:fill-slot="column_two_slot">\n-  <section class="portlet">\n-    <header class="portletHeader">Portlet header</header>\n-    <div class="portletContent">\n-      There might be a login form here.\n-      <form>\n-        <input type="text" value="login" /> <br />\n-        <input type="password" value="password" /> <br />\n-        <input type="submit" />\n-      </form>\n-    </div>\n-    <footer class="portletFooter">Portlet footer</footer>\n-  </section>\n-</aside>\n-\n-</body>\n-</html>\n-\ndiff --git a/Products/CMFPlone/testing.py b/Products/CMFPlone/testing.py\nindex 3bf8591240..49548c9595 100644\n--- a/Products/CMFPlone/testing.py\n+++ b/Products/CMFPlone/testing.py\n@@ -31,6 +31,11 @@ def setUpZope(self, app, configurationContext):\n             Products.CMFPlone,\n             context=configurationContext\n         )\n+        xmlconfig.file(\n+            \'configure.zcml\',\n+            Products.CMFPlone.tests,\n+            context=configurationContext\n+        )\n \n     def setUpPloneSite(self, portal):\n         portal.acl_users.userFolderAddUser(\ndiff --git a/Products/CMFPlone/tests/900.jpg b/Products/CMFPlone/tests/900.jpg\nnew file mode 100644\nindex 0000000000..e9ef7dbb1a\nBinary files /dev/null and b/Products/CMFPlone/tests/900.jpg differ\ndiff --git a/Products/CMFPlone/tests/accesscontrol_direct.pt b/Products/CMFPlone/tests/accesscontrol_direct.pt\nnew file mode 100644\nindex 0000000000..0c981337b4\n--- /dev/null\n+++ b/Products/CMFPlone/tests/accesscontrol_direct.pt\n@@ -0,0 +1 @@\n+<span tal:condition="nocall:modules/AccessControl/SecurityManagement">hacked</span>\ndiff --git a/Products/CMFPlone/tests/accesscontrol_sm.pt b/Products/CMFPlone/tests/accesscontrol_sm.pt\nnew file mode 100644\nindex 0000000000..536add7541\n--- /dev/null\n+++ b/Products/CMFPlone/tests/accesscontrol_sm.pt\n@@ -0,0 +1 @@\n+<span tal:condition="nocall:modules/AccessControl/getSecurityManager">getSecurityManager is allowed</span>\ndiff --git a/Products/CMFPlone/tests/accesscontrol_via_dict.pt b/Products/CMFPlone/tests/accesscontrol_via_dict.pt\nnew file mode 100644\nindex 0000000000..46785bc666\n--- /dev/null\n+++ b/Products/CMFPlone/tests/accesscontrol_via_dict.pt\n@@ -0,0 +1,3 @@\n+<span tal:define="acc nocall:modules/AccessControl;\n+                  piggyback python:{\'unsafe\': acc}"\n+      tal:condition="nocall:piggyback/unsafe/users">hacked</span>\ndiff --git a/Products/CMFPlone/tests/accesscontrol_via_modules.pt b/Products/CMFPlone/tests/accesscontrol_via_modules.pt\nnew file mode 100644\nindex 0000000000..adb03fc5e5\n--- /dev/null\n+++ b/Products/CMFPlone/tests/accesscontrol_via_modules.pt\n@@ -0,0 +1 @@\n+<span tal:define="acc nocall:modules/AccessControl" tal:condition="nocall:acc/users">hacked</span>\ndiff --git a/Products/CMFPlone/tests/bad1.pt b/Products/CMFPlone/tests/bad1.pt\nnew file mode 100644\nindex 0000000000..856c36432e\n--- /dev/null\n+++ b/Products/CMFPlone/tests/bad1.pt\n@@ -0,0 +1,2 @@\n+Hello <span tal:define="sys nocall:random/_os/system"\n+            tal:content="python: sys(\'ls ~\')" />.\ndiff --git a/Products/CMFPlone/tests/bad2.pt b/Products/CMFPlone/tests/bad2.pt\nnew file mode 100644\nindex 0000000000..0372162e07\n--- /dev/null\n+++ b/Products/CMFPlone/tests/bad2.pt\n@@ -0,0 +1,2 @@\n+Hello <span tal:define="string python:modules[\'string\']"\n+            tal:content="string/_re/purge" />.\ndiff --git a/Products/CMFPlone/tests/bad3.pt b/Products/CMFPlone/tests/bad3.pt\nnew file mode 100644\nindex 0000000000..077d00f3f5\n--- /dev/null\n+++ b/Products/CMFPlone/tests/bad3.pt\n@@ -0,0 +1,3 @@\n+Hello <span tal:define="string nocall:modules/string;\n+                        get_field nocall:string/Formatter/get_field;\n+                        poc python:get_field(path(\'string/Formatter\'), \'0._re.purge\', [string], None)" tal:content="poc" />\ndiff --git a/Products/CMFPlone/tests/base_tag_not_present.txt b/Products/CMFPlone/tests/base_tag_not_present.txt\nindex 786e5cec3c..1a7960154a 100644\n--- a/Products/CMFPlone/tests/base_tag_not_present.txt\n+++ b/Products/CMFPlone/tests/base_tag_not_present.txt\n@@ -9,7 +9,7 @@ that in fact is not being injected in some other way.\n   >>> from plone.app.testing import SITE_OWNER_PASSWORD\n   >>> app = layer[\'app\']\n   >>> browser = Browser(app)\n-  \n+\n   >>> browser.open(\'http://nohost/plone/login_form\')\n   >>> browser.getControl(\'Login Name\').value = SITE_OWNER_NAME\n   >>> browser.getControl(\'Password\').value = SITE_OWNER_PASSWORD\n@@ -20,13 +20,13 @@ Create object\n   >>> browser.getLink(\'Page\').click()\n   >>> browser.getControl(\'Title\').value = \'Front Page\'\n   >>> browser.getControl(\'Save\').click()\n-  \n+\n Check object view\n \n   >>> browser.open(\'http://nohost/plone/front-page\')\n   >>> \'<base\' in browser.contents\n   False\n-  \n+\n Check edit view\n \n   >>> browser.open(\'http://nohost/plone/front-page/edit\')\ndiff --git a/Products/CMFPlone/tests/browser.txt b/Products/CMFPlone/tests/browser.txt\nindex 4e5bacb2b0..ccfa621c2d 100644\n--- a/Products/CMFPlone/tests/browser.txt\n+++ b/Products/CMFPlone/tests/browser.txt\n@@ -42,29 +42,29 @@ Test for "template id" in <body> tag. See tickets #9111/#8777\n \n     >>> browser.open(\'http://nohost/plone/front-page\')\n     >>> browser.contents\n-    \'...<body ... class="...template-document_view...\'\n+    \'...<body ...class="...template-document_view...\'\n \n     >>> browser.contents\n-    \'...<body ... class="...portaltype-document...\'\n+    \'...<body ...class="...portaltype-document...\'\n \n     >>> browser.contents\n-    \'...<body ... class="...site-plone...\'\n+    \'...<body ...class="...site-plone...\'\n \n     >>> browser.contents\n-    \'...<body ... class="...section-front-page...\'\n+    \'...<body ...class="...section-front-page...\'\n \n     >>> browser.open(\'http://nohost/plone/news\')\n     >>> browser.contents\n-    \'...<body ... class="...portaltype-collection...\'\n+    \'...<body ...class="...portaltype-collection...\'\n \n     >>> browser.contents\n-    \'...<body ... class="...template-summary_view...\'\n+    \'...<body ...class="...template-summary_view...\'\n \n     >>> browser.contents\n-    \'...<body ... class="...section-news...\'\n+    \'...<body ...class="...section-news...\'\n \n     >>> browser.contents\n-    \'...<body ... class="...site-plone...\'\n+    \'...<body ...class="...site-plone...\'\n \n Login\n \n@@ -77,10 +77,10 @@ Test explicit browser view\n \n     >>> browser.open(\'http://nohost/plone/@@dashboard\')\n     >>> browser.contents\n-    \'...<body ... class="...template-dashboard...\'\n+    \'...<body ...class="...template-dashboard...\'\n \n     >>> browser.contents\n-    \'...<body ... class="...portaltype-plone-site...\'\n+    \'...<body ...class="...portaltype-plone-site...\'\n \n     >>> browser.contents\n-    \'...<body ... class="...site-plone...\'\n+    \'...<body ...class="...site-plone...\'\ndiff --git a/Products/CMFPlone/tests/browser_collection_views.txt b/Products/CMFPlone/tests/browser_collection_views.txt\nindex 1410ef8387..c2458703d0 100644\n--- a/Products/CMFPlone/tests/browser_collection_views.txt\n+++ b/Products/CMFPlone/tests/browser_collection_views.txt\n@@ -48,6 +48,12 @@ Now let\'s login and visit the collection in the test browser:\n     >>> browser.getControl(\'Log in\').click()\n     >>> browser.open(\'http://nohost/plone/folder/collection\')\n \n+When checking if the collection text is in the output, we are not interested in differences in whitespace.\n+So we use a normalize function:\n+\n+    >>> def normalize(value):\n+    ...     return value.translate(str.maketrans({" ": None, "\\n": None, "\\t": None, "\\r": None}))\n+\n Lets check the listing_view (Standard view):\n \n     >>> browser.getLink(\'Standard view\').click()\n@@ -55,7 +61,7 @@ Lets check the listing_view (Standard view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the summary_view (Summary view):\n@@ -65,7 +71,7 @@ Lets check the summary_view (Summary view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the full_view (All content):\n@@ -75,7 +81,7 @@ Lets check the full_view (All content):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the tabular_view (Tabular view):\n@@ -86,7 +92,7 @@ Lets check the tabular_view (Tabular view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets ensure that the text field is not requested on a folder. We\n@@ -110,5 +116,5 @@ Lets ensure text is shown when Collection is default view of a folder\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\ndiff --git a/Products/CMFPlone/tests/configure.zcml b/Products/CMFPlone/tests/configure.zcml\nnew file mode 100644\nindex 0000000000..2d1cf3b401\n--- /dev/null\n+++ b/Products/CMFPlone/tests/configure.zcml\n@@ -0,0 +1,13 @@\n+<configure\n+    xmlns="http://namespaces.zope.org/zope"\n+    xmlns:browser="http://namespaces.zope.org/browser"\n+    i18n_domain="plone">\n+\n+    <browser:page\n+        name="hotfix-testing-view-name"\n+        for="*"\n+        template="view_name.pt"\n+        permission="zope2.View"\n+        />\n+\n+</configure>\ndiff --git a/Products/CMFPlone/tests/csrf.txt b/Products/CMFPlone/tests/csrf.txt\nindex 6dedd8de05..b5f8e22098 100644\n--- a/Products/CMFPlone/tests/csrf.txt\n+++ b/Products/CMFPlone/tests/csrf.txt\n@@ -50,8 +50,8 @@ outgoing mails would have to be handled making things unnecessarily\n complicated:\n \n   >>> from zope.component import getUtility\n-  >>> from Products.CMFPlone.interfaces import IMailSchema\n-  >>> from Products.CMFPlone.interfaces import ISecuritySchema\n+  >>> from plone.base.interfaces import IMailSchema\n+  >>> from plone.base.interfaces import ISecuritySchema\n   >>> from plone.registry.interfaces import IRegistry\n   >>> registry = getUtility(IRegistry)\n   >>> mail_settings = registry.forInterface(IMailSchema, prefix=\'plone\')\n@@ -143,13 +143,11 @@ existing invalid, in which case submitting should yield an error:\n Next up is the password form.  Well, technically an attacker would need to\n know the current passwort to exploit this, but we\'ll check nevertheless:\n \n-  >>> browser.open(\'http://nohost/plone/password_form\')\n+  >>> browser.open(\'http://nohost/plone/@@change-password\')\n   >>> browser.getControl(\'Current password\').value = TEST_USER_PASSWORD\n   >>> browser.getControl(\'New password\').value = \'y0d4Wg\'\n   >>> browser.getControl(\'Confirm password\').value = \'y0d4Wg\'\n-  >>> # import pdb; pdb.set_trace()\n   >>> browser.getControl(\'Change Password\').click()\n-  >>> # import pdb; pdb.set_trace()\n   >>> browser.contents\n   \'...Info...Password changed...\'\n \n@@ -195,12 +193,11 @@ Make sure users and roles can be managed through the control panel. First\n we need to alter the security settings so that no email roundtrip is required\n anymore (which at the same time tests the security control panel):\n \n-  >>> browser.open(\'http://nohost/plone/@@overview-controlpanel\')\n-  >>> browser.getLink(\'Security\').click()\n+  >>> browser.open(\'http://nohost/plone/@@security-controlpanel\')\n   >>> browser.getControl(name=\'form.widgets.enable_user_pwd_choice:list\').value = [\'selected\']\n   >>> browser.getControl(\'Save\').click()\n \n-  >>> browser.getLink(\'Users and Groups\').click()\n+  >>> browser.open(\'http://nohost/plone/@@usergroup-userprefs\')\n   >>> browser.getLink(\'Add New User\').click()\n   >>> browser.getControl(\'User Name\').value = \'johnny\'\n   >>> browser.getControl(\'Email\').value = \'john@foo-security.com\'\n@@ -210,7 +207,7 @@ anymore (which at the same time tests the security control panel):\n   >>> browser.contents\n   \'...Info...User added...\'\n \n-  >>> browser.getLink(\'Users and Groups\').click()\n+  >>> browser.getLink(\'Users\').click()\n   >>> browser.getControl(\'Show all\').click()\n   >>> browser.getControl(name=\'users.roles:list:records\').value = [\'Manager\'] * 3\n   >>> browser.getControl(\'Save\').click()\n@@ -227,8 +224,7 @@ anymore (which at the same time tests the security control panel):\n \n Let\'s also try adding that user to a group:\n \n-  >>> browser.open(\'http://nohost/plone/@@overview-controlpanel\')\n-  >>> browser.getLink(\'Users and Groups\').click()\n+  >>> browser.open(\'http://nohost/plone/@@usergroup-userprefs\')\n   >>> browser.getControl(\'Show all\').click()\n   >>> browser.getLink(\'johnny\').click()\n   >>> browser.getLink(\'Group Memberships\').click()\n@@ -251,9 +247,7 @@ There\'s an alternative way to adding a user to a group in which the group in\n question is selected first and the user can then be added via the "Group\n Members" tab:\n \n-  >>> browser.open(\'http://nohost/plone/@@overview-controlpanel\')\n-  >>> browser.getLink(\'Users and Groups\').click()\n-  >>> browser.getLink(url=\'/@@usergroup-groupprefs\').click()\n+  >>> browser.open(\'http://nohost/plone/@@usergroup-groupprefs\')\n   >>> browser.getLink(\'Reviewers\').click()\n   >>> browser.getControl(\'Show all\').click()\n \n@@ -319,7 +313,9 @@ Now rename\n   >>> browser.getControl(name=\'entries.role_Editor:records\').value\n   []\n \n-  >>> browser.getControl(name=\'_authenticator\', index=0).value = \'invalid!\'\n+Change the value of the second _authenticator and check for Exception\n+\n+  >>> browser.getControl(name=\'_authenticator\', index=1).value = \'invalid!\'\n   >>> browser.getControl(name=\'entries.role_Editor:records\').value = [\'True\']\n   >>> browser.getControl(\'Save\').click()\n   Traceback (most recent call last):\n@@ -404,7 +400,7 @@ haven\'t. Luckily most of them are using the same form handlers and template,\n so testing one of them already makes sure the protection works in most cases:\n \n   >>> browser.open(\'http://nohost/plone/@@overview-controlpanel\')\n-  >>> browser.getLink(\'Security\').click()\n+  >>> browser.getLink(url="/@@security-controlpanel").click()\n   >>> browser.getControl(name=\'form.widgets.enable_self_reg:list\').value\n   []\n   >>> browser.getControl(name=\'form.widgets.enable_self_reg:list\').value = [\'selected\']\n@@ -412,7 +408,7 @@ so testing one of them already makes sure the protection works in most cases:\n   >>> browser.contents\n   \'...Info...Changes saved...\'\n \n-  >>> browser.getLink(\'Security\').click()\n+  >>> browser.getLink(url="/@@security-controlpanel").click()\n   >>> browser.getControl(name=\'_authenticator\', index=0).value = \'invalid!\'\n   >>> browser.getControl(name=\'form.widgets.enable_self_reg:list\').value = []\n \ndiff --git a/Products/CMFPlone/tests/dummy.py b/Products/CMFPlone/tests/dummy.py\nindex c89a7b3852..e80bf009b4 100644\n--- a/Products/CMFPlone/tests/dummy.py\n+++ b/Products/CMFPlone/tests/dummy.py\n@@ -4,9 +4,8 @@\n from ComputedAttribute import ComputedAttribute\n from OFS.Folder import Folder as SimpleFolder\n from OFS.SimpleItem import SimpleItem\n-from Products.CMFPlone.interfaces import INonStructuralFolder\n-from Products.CMFPlone.interfaces import IWorkflowChain\n-from io import StringIO\n+from plone.base.interfaces import INonStructuralFolder\n+from plone.base.interfaces import IWorkflowChain\n from io import BytesIO\n from zope.interface import implementer\n from zope.interface import Interface\n@@ -21,6 +20,11 @@\n     os.path.dirname(__file__), os.pardir, \'tool.gif\')\n with open(GIF_FILE, \'rb\') as f:\n     GIF = f.read()\n+# jpeg file of 900x900 pixels\n+JPEG_FILE = os.path.join(\n+    os.path.dirname(__file__), \'900.jpg\')\n+with open(JPEG_FILE, \'rb\') as f:\n+    JPEG = f.read()\n \n \n class Dummy:\n@@ -106,6 +110,15 @@ class Image(File):\n     data = GIF\n \n \n+class JpegImage(File):\n+    """Dummy jpeg image upload object\n+\n+    900 by 900 pixels.\n+    """\n+    filename = "900.jpeg"\n+    data = JPEG\n+\n+\n class Folder(SimpleFolder):\n     \'\'\'Dummy Folder\n        First-class Zope object. Can be _setObject\'ed.\ndiff --git a/Products/CMFPlone/tests/messages.txt b/Products/CMFPlone/tests/messages.txt\ndeleted file mode 100644\nindex 0b8320c7fb..0000000000\n--- a/Products/CMFPlone/tests/messages.txt\n+++ /dev/null\n@@ -1,142 +0,0 @@\n-Test for Messages\n-=================\n-\n-  >>> from Products.CMFPlone import PloneMessageFactory as _\n-\n-Messages without translation service set up\n--------------------------------------------\n-\n-Very simple message:\n-\n-  >>> _(u\'hello\')\n-  u\'hello\'\n-\n-The domain is predefinied through the factory:\n-\n-  >>> _(u\'hello\').domain\n-  \'plone\'\n-\n-You can also define a default text:\n-\n-  >>> msg = _(u\'id\', default=u\'This is the text.\')\n-  >>> msg\n-  u\'id\'\n-\n-  >>> msg.default\n-  u\'This is the text.\'\n-\n-And at last there is the possibility of variable substition:\n-\n-  >>> project = u\'Plone\'\n-  >>> msg = _(u\'id\', default=u\'Hello ${name}\', mapping={u\'name\' : project})\n-\n-  >>> msg\n-  u\'id\'\n-\n-  >>> msg.default\n-  u\'Hello ${name}\'\n-\n-  >>> msg.mapping\n-  {u\'name\': u\'Plone\'}\n-\n-Messages with translation service set up\n-----------------------------------------\n-\n-Now we fake a translation domain. Usually you will have translations stored in\n-a po file and automatically translated by PTS or the Z3 translation service.\n-\n-  >>> from zope.i18n.simpletranslationdomain import SimpleTranslationDomain\n-  >>> from zope.i18n.interfaces import ITranslationDomain\n-\n-  >>> messages = {\n-  ...     (\'de\', u\'This is a message.\'): u\'Dieses ist eine Nachricht.\',\n-  ...     (\'de\', u\'mail-notification\'): u\'Sie haben ${number} neue E-Mails.\'}\n-  >>> mails = SimpleTranslationDomain(\'plone\', messages)\n-\n-  >>> from zope.component import provideUtility\n-  >>> provideUtility(mails, ITranslationDomain, name=\'plone\')\n-\n-Define the simple message:\n-\n-  >>> msg = _(u\'This is a message.\')\n-  >>> msg\n-  u\'This is a message.\'\n-\n-We are still using the plone domain:\n-\n-  >>> msg.domain\n-  \'plone\'\n-\n-Verify that the translation succeeds:\n-\n-  >>> from zope.i18n import translate\n-  >>> translate(msg, target_language=\'de\')\n-  u\'Dieses ist eine Nachricht.\'\n-\n-Now try a message with variable substitution:\n-\n-  >>> num = 42\n-  >>> note = _(u\'mail-notification\', default=u\'You have ${number} new mails.\',\n-  ...          mapping={u\'number\': num})\n-\n-  >>> note\n-  u\'mail-notification\'\n-\n-  >>> note.default\n-  u\'You have ${number} new mails.\'\n-\n-Try simple interpolation:\n-\n-  >>> translate(note, target_language=\'en\')\n-  u\'You have 42 new mails.\'\n-\n-And now try the real translation:\n-\n-  >>> translate(note, target_language=\'de\')\n-  u\'Sie haben 42 neue E-Mails.\'\n-\n-Messages inside page templates / tal\n-------------------------------------\n-\n-We need a simple tal engine for the tests. The DummyEngine automatically\n-upper-cases all text.\n-\n-  >>> from zope.tal.dummyengine import DummyEngine\n-  >>> engine = DummyEngine()\n-\n-We use the Messages defined earlier.\n-\n-  >>> msg\n-  u\'This is a message.\'\n-\n-  >>> note\n-  u\'mail-notification\'\n-\n-Inform the engine of our variables.\n-\n-  >>> engine.setLocal(\'msg\', msg)\n-  >>> engine.setLocal(\'note\', note)\n-\n-We also need a HTMLParser and TALInterpreter and add a simple convience function\n-to get the parsed and interpreted text.\n-\n-  >>> from zope.tal.htmltalparser import HTMLTALParser\n-  >>> from zope.tal.talinterpreter import TALInterpreter\n-  >>> from io import StringIO\n-\n-  >>> def compile(source):\n-  ...     parser = HTMLTALParser()\n-  ...     parser.parseString(source)\n-  ...     program, macros = parser.getCode()\n-  ...     result = StringIO()\n-  ...     interpreter = TALInterpreter(program, {}, engine, stream=result)\n-  ...     interpreter()\n-  ...     return result.getvalue()\n-\n-  >>> text = compile(\'<span i18n:translate="" tal:content="msg"/>\')\n-  >>> u\'<span>THIS IS A MESSAGE.</span>\' in text\n-  True\n-\n-  >>> text = compile(\'<span i18n:translate="" tal:content="note"/>\')\n-  >>> u\'<span>MAIL-NOTIFICATION</span>\' in text\n-  True\ndiff --git a/Products/CMFPlone/tests/options_authenticator.pt b/Products/CMFPlone/tests/options_authenticator.pt\nnew file mode 100644\nindex 0000000000..97e29c4a65\n--- /dev/null\n+++ b/Products/CMFPlone/tests/options_authenticator.pt\n@@ -0,0 +1 @@\n+<h1 tal:content="options/view/_authenticator" />\ndiff --git a/Products/CMFPlone/tests/options_name.pt b/Products/CMFPlone/tests/options_name.pt\nnew file mode 100644\nindex 0000000000..592dc3e98d\n--- /dev/null\n+++ b/Products/CMFPlone/tests/options_name.pt\n@@ -0,0 +1 @@\n+<h1 tal:content="view/__name__" />\ndiff --git a/Products/CMFPlone/tests/options_underscore.pt b/Products/CMFPlone/tests/options_underscore.pt\nnew file mode 100644\nindex 0000000000..172a01b9b1\n--- /dev/null\n+++ b/Products/CMFPlone/tests/options_underscore.pt\n@@ -0,0 +1 @@\n+<h1 tal:content="options/view/_" />\ndiff --git a/Products/CMFPlone/tests/options_view_name.pt b/Products/CMFPlone/tests/options_view_name.pt\nnew file mode 100644\nindex 0000000000..3a433ca22e\n--- /dev/null\n+++ b/Products/CMFPlone/tests/options_view_name.pt\n@@ -0,0 +1 @@\n+<h1 tal:content="options/view/__name__" />\ndiff --git a/Products/CMFPlone/tests/pwreset_browser.rst b/Products/CMFPlone/tests/pwreset_browser.rst\nindex e12dbcb9c1..da70832d02 100644\n--- a/Products/CMFPlone/tests/pwreset_browser.rst\n+++ b/Products/CMFPlone/tests/pwreset_browser.rst\n@@ -15,7 +15,7 @@ assumptions that are not true for Plone forms.\n   >>> from zope.component import getUtility\n   >>> registry = getUtility(IRegistry, context=layer[\'portal\'])\n \n-  >>> from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+  >>> from plone.base.interfaces.controlpanel import IMailSchema\n   >>> mail_settings = registry.forInterface(IMailSchema, prefix="plone")\n   >>> mail_settings.smtp_host = u\'localhost\'\n   >>> mail_settings.email_from_address = \'smith@example.com\'\n@@ -255,14 +255,9 @@ First, we want to login as the portal owner:\n   >>> "You are now logged in" in browser.contents\n   True\n \n-We navigate to the Users Overview page and register a new user:\n-\n-  >>> browser.getLink(\'Site Setup\').click()\n-  >>> browser.getLink(\'Users and Groups\').click()\n-  >>> browser.getLink(\'Add New User\').click()\n-  >>> browser.url\n-  \'http://nohost/plone/@@new-user\'\n+We navigate to the Users Add page and register a new user:\n \n+  >>> browser.open(\'http://nohost/plone/@@new-user\')\n   >>> browser.getControl(\'User Name\').value = \'wsmith\'\n   >>> browser.getControl(\'Email\').value = \'wsmith@example.com\'\n   >>> browser.getControl(\'Password\').value = \'supersecret\'\n@@ -296,8 +291,7 @@ Again, we want to login as the portal owner:\n \n We navigate to the Users Overview page and reset a password user:\n \n-  >>> browser.getLink(\'Site Setup\').click()\n-  >>> browser.getLink(\'Users and Groups\').click()\n+  >>> browser.open(\'http://nohost/plone/@@usergroup-userprefs\')\n   >>> resets = browser.getControl(name=\'users.resetpassword:records\')\n   >>> reset = resets.getControl(value=\'wsmith\')\n   >>> reset.selected = True\n@@ -472,14 +466,9 @@ First, we want to login as the portal owner:\n   >>> "You are now logged in" in browser.contents\n   True\n \n-We navigate to the Users Overview page and register a new user:\n-\n-  >>> browser.getLink(\'Site Setup\').click()\n-  >>> browser.getLink(\'Users and Groups\').click()\n-  >>> browser.getLink(\'Add New User\').click()\n-  >>> browser.url\n-  \'http://nohost/plone/@@new-user\'\n+We navigate to the Users Adding page and register a new user:\n \n+  >>> browser.open(\'http://nohost/plone/@@new-user\')\n   >>> browser.getControl(\'User Name\').value = \'wwwsmith\'\n   >>> browser.getControl(\'Email\').value = \'wwwsmith@example.com\'\n   >>> browser.getControl(\'Password\').value = \'secret\'\n@@ -534,7 +523,7 @@ Test passwordreset BrowserView\n \n     >>> portal = layer[\'portal\']\n     >>> mail_settings.email_from_name = u\'Old\\u0159ich a Bo\\u017eena\'\n-    >>> from Products.CMFPlone.interfaces.controlpanel import ISiteSchema\n+    >>> from plone.base.interfaces.controlpanel import ISiteSchema\n     >>> site_settings = registry.forInterface(ISiteSchema, prefix=\'plone\')\n     >>> site_settings.site_title = u\'Koko\\u0159\\xedn Portal\'\n \ndiff --git a/Products/CMFPlone/tests/robot/keywords.robot b/Products/CMFPlone/tests/robot/keywords.robot\nindex 75765ffc38..ca0c598c4b 100644\n--- a/Products/CMFPlone/tests/robot/keywords.robot\n+++ b/Products/CMFPlone/tests/robot/keywords.robot\n@@ -33,3 +33,7 @@ patterns are loaded\n a folder with a document \'${title}\'\n   ${folder_uid}=  Create content  type=Folder  title=folder\n   Create content  type=Document  container=${folder_uid}  title=${title}\n+\n+folder contents pattern loaded\n+    Page should contain element  css=.pat-structure\n+    Wait For Condition  return !!document.querySelector(\'.pat-structure div.navbar\')\ndiff --git a/Products/CMFPlone/tests/robot/plone-logo.png b/Products/CMFPlone/tests/robot/plone-logo.png\nnew file mode 100644\nindex 0000000000..4c109bab8d\nBinary files /dev/null and b/Products/CMFPlone/tests/robot/plone-logo.png differ\ndiff --git a/Products/CMFPlone/tests/robot/robodoc/README.rst b/Products/CMFPlone/tests/robot/robodoc/README.rst\nindex 225c445d98..d25585bf30 100644\n--- a/Products/CMFPlone/tests/robot/robodoc/README.rst\n+++ b/Products/CMFPlone/tests/robot/robodoc/README.rst\n@@ -62,7 +62,7 @@ or\n \n .. code:: bash\n \n-   $\xc2\xa0CONFIGURE_PACKAGES=plone.app.iterate APPLY_PROFILES=plone.app.contenttypes:plone-content,plone.app.iterate:plone.app.iterate bin/robot-server plone.app.robotframework.PLONE_ROBOT_TESTING\n+   $\xc2\xa0CONFIGURE_PACKAGES=plone.app.iterate APPLY_PROFILES=plone.app.contenttypes:plone-content,plone.app.iterate:default bin/robot-server plone.app.robotframework.PLONE_ROBOT_TESTING\n \n and\n \ndiff --git a/Products/CMFPlone/tests/robot/robodoc/collaboration-advanced_control.robot b/Products/CMFPlone/tests/robot/robodoc/collaboration-advanced_control.robot\nindex 4427dea3f3..a81141374d 100644\n--- a/Products/CMFPlone/tests/robot/robodoc/collaboration-advanced_control.robot\n+++ b/Products/CMFPlone/tests/robot/robodoc/collaboration-advanced_control.robot\n@@ -37,8 +37,8 @@ Show state menu\n \n     Click link  workflow-transition-advanced\n     Wait until element is visible\n-    ...   css=div.plone-modal-content\n+    ...   css=div.modal-content\n \n     Capture and crop page screenshot\n     ...  ${CURDIR}/_robot/workflow-advanced.png\n-    ...  css=div.plone-modal-wrapper\n+    ...  css=div.modal-wrapper\ndiff --git a/Products/CMFPlone/tests/robot/robodoc/config-screens.robot b/Products/CMFPlone/tests/robot/robodoc/config-screens.robot\nindex 230a0e4552..8422f57999 100644\n--- a/Products/CMFPlone/tests/robot/robodoc/config-screens.robot\n+++ b/Products/CMFPlone/tests/robot/robodoc/config-screens.robot\n@@ -47,7 +47,7 @@ Show Content setup screen\n \n     Click element  type_id\n \n-    Select From List  name=type_id  Document\n+    Select From List By Label  name=type_id  Document\n \n     Capture and crop page screenshot\n     ...  ${CURDIR}/_robot/content-document.png\n@@ -78,7 +78,7 @@ Show Editing setup screen\n     ...  css=#content\n \n Show Error log setup screen\n-    Go to  ${PLONE_URL}/prefs_error_log_form\n+    Go to  ${PLONE_URL}/@@error-log-form\n     Capture and crop page screenshot\n     ...  ${CURDIR}/_robot/errorlog-setup.png\n     ...  css=#content\n@@ -141,10 +141,6 @@ Show Resource Registry screen\n     Capture and crop page screenshot\n     ...  ${CURDIR}/_robot/resource-registry.png\n     ...  css=#content\n-    Click link  Less Variables\n-    Capture and crop page screenshot\n-    ...  ${CURDIR}/_robot/less-variables.png\n-    ...  css=#content\n \n Show Search setup screen\n     Go to  ${PLONE_URL}/@@search-controlpanel\n@@ -213,4 +209,4 @@ Changing the logo\n     Capture and crop page screenshot\n     ...    ${CURDIR}/_robot/change-logo-in-site-control-panel.png\n     ...    css=#content\n-    ...    css=#formfield-form-widgets-site_logo\n\\ No newline at end of file\n+    ...    css=#formfield-form-widgets-site_logo\ndiff --git a/Products/CMFPlone/tests/robot/robodoc/managing-working_copy.robot b/Products/CMFPlone/tests/robot/robodoc/managing-working_copy.robot\nindex 797e17ee51..6677e9cb83 100644\n--- a/Products/CMFPlone/tests/robot/robodoc/managing-working_copy.robot\n+++ b/Products/CMFPlone/tests/robot/robodoc/managing-working_copy.robot\n@@ -8,7 +8,7 @@ Suite Teardown  Common Suite Teardown\n *** Variables ***\n \n @{CONFIGURE_PACKAGES}  plone.app.iterate\n-@{APPLY_PROFILES}  plone.app.contenttypes:plone-content  plone.app.iterate:plone.app.iterate\n+@{APPLY_PROFILES}  plone.app.contenttypes:plone-content  plone.app.iterate:default\n # ${REGISTER_TRANSLATIONS}  ${CURDIR}/../../_locales\n \n *** Test Cases ***\ndiff --git a/Products/CMFPlone/tests/robot/robodoc/managing_content.robot b/Products/CMFPlone/tests/robot/robodoc/managing_content.robot\nindex 370363e6f5..1d5de8ccb7 100644\n--- a/Products/CMFPlone/tests/robot/robodoc/managing_content.robot\n+++ b/Products/CMFPlone/tests/robot/robodoc/managing_content.robot\n@@ -27,7 +27,7 @@ add rule\n     Click element  css=#form-widgets-description\n     Input text  css=#form-widgets-description  this rule is meant for folders where new staff is having a go\n     Click element  css=#formfield-form-widgets-event\n-    Select From List  id=form-widgets-event  Object modified\n+    Select From List By Label  id=form-widgets-event  Object modified\n \n \n     Capture and crop page screenshot\n@@ -195,4 +195,4 @@ Show right portlets\n \n     Capture and crop page screenshot\n     ...  ${CURDIR}/_robot/portlet-footer.png\n-    ...  css=#content\n\\ No newline at end of file\n+    ...  css=#content\ndiff --git a/Products/CMFPlone/tests/robot/robodoc/working_with_tinymce.robot b/Products/CMFPlone/tests/robot/robodoc/working_with_tinymce.robot\nindex acd9963e8a..296ba742c0 100644\n--- a/Products/CMFPlone/tests/robot/robodoc/working_with_tinymce.robot\n+++ b/Products/CMFPlone/tests/robot/robodoc/working_with_tinymce.robot\n@@ -39,14 +39,14 @@ Show TinyMCE image\n \n     Click element  css=#mceu_15 button\n     Wait until element is visible\n-    ...  css=h2.plone-modal-title\n+    ...  css=h2.modal-title\n     Wait until element is visible\n     ...  css=div.common-controls\n-    \n+\n     Capture and crop page screenshot\n     ...  ${CURDIR}/_robot/tinymce-imgdialog.png\n     ...  css=div.outer-wrapper\n-    ...  css=div.plone-modal-content\n+    ...  css=div.modal-content\n \n Show TinyMCE insert links\n     Go to  ${PLONE_URL}/samplepage\n@@ -61,7 +61,7 @@ Show TinyMCE insert links\n     Capture and crop page screenshot\n     ...  ${CURDIR}/_robot/tinymce-linkdialog.png\n     ...  css=div.outer-wrapper\n-    ...  css=div.plone-modal-content\n+    ...  css=div.modal-content\n \n Show TinyMCE insert tables\n     Go to  ${PLONE_URL}/samplepage\ndiff --git a/Products/CMFPlone/tests/robot/robot_setup.py b/Products/CMFPlone/tests/robot/robot_setup.py\nindex b32e25ec06..ae9760f5da 100644\n--- a/Products/CMFPlone/tests/robot/robot_setup.py\n+++ b/Products/CMFPlone/tests/robot/robot_setup.py\n@@ -3,8 +3,8 @@\n \n from zope.component import queryUtility\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import IMailSchema\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import IMailSchema\n+from plone.base.interfaces import ISecuritySchema\n \n \n class CMFPloneRemoteKeywords(RemoteLibrary):\ndiff --git a/Products/CMFPlone/tests/robot/test_actionmenu.robot b/Products/CMFPlone/tests/robot/test_actionmenu.robot\nindex 945faefd9a..58539cb3ec 100644\n--- a/Products/CMFPlone/tests/robot/test_actionmenu.robot\n+++ b/Products/CMFPlone/tests/robot/test_actionmenu.robot\n@@ -107,29 +107,12 @@ I click outside of menu\n \n workflow link is clicked\n     # store current state\n-    ${OLD_STATE} =  Get Text  xpath=(//span[contains(@class,\'state-\')])[2]\n+    ${OLD_STATE} =  Get Text  xpath=(//span[contains(@class,\'state-\')])\n     Set Suite Variable  ${OLD_STATE}  ${OLD_STATE}\n     Given patterns are loaded\n     Click Link  xpath=//li[@id=\'plone-contentmenu-workflow\']/a\n     Click Link  xpath=(//li[@id=\'plone-contentmenu-workflow\']/ul/li/a)[1]\n     Page Should Contain  Item state changed.\n-    # FIXME: The above \'Click Link\' fails on Internet Explorer, but the\n-    # following keywords \'workflow link is clicked softly\' passes. Until we\n-    # know why, we check if the above worked and if not, we try the other\n-    # approach.\n-    @{value} =  Run Keyword And Ignore Error\n-    ...         Page Should Contain  Item state changed.\n-    Run Keyword If  \'@{value}[0]\' == \'FAIL\'\n-    ...         workflow link is clicked softly\n-\n-workflow link is clicked softly\n-    [Documentation]  This works on Internet Explorer, but not on Firefox...\n-    Mouse Over  xpath=//*[@id=\'plone-contentmenu-workflow\']/a\n-    Click Link  xpath=//li[@id=\'plone-contentmenu-workflow\']/a\n-    Mouse Over  xpath=(//li[@id=\'plone-contentmenu-workflow\']//a)[1]\n-    Mouse Down  xpath=(//li[@id=\'plone-contentmenu-workflow\']//a)[1]\n-    Mouse Up  xpath=(//li[@id=\'plone-contentmenu-workflow\']//a)[1]\n-    Wait until page contains  Item state changed.\n \n Open Menu\n     [Arguments]  ${elementId}\n@@ -140,17 +123,17 @@ Open Menu\n Open Action Menu\n     Given patterns are loaded\n     Click link  xpath=//li[@id=\'plone-contentmenu-actions\']/a\n-    Wait until keyword succeeds  5  1  Element Should Be Visible  css=.plonetoolbar-content-action\n+    Wait until keyword succeeds  5  1  Element Should Be Visible  css=#plone-contentmenu-actions .dropdown-menu\n \n I copy the page\n     Open Action Menu\n-    Click Link  link=Copy\n+    Click Link  css=#plone-contentmenu-actions .actionicon-object_buttons-copy\n     Page should contain  copied\n \n I paste\n     Go to  ${PLONE_URL}\n     Open Action Menu\n-    Click Link  link=Paste\n+    Click Link  css=#plone-contentmenu-actions .actionicon-object_buttons-paste\n \n \n # --- THEN -------------------------------------------------------------------\n@@ -183,7 +166,7 @@ I should see \'${message}\' in the page\n \n state should have changed\n     Wait until page contains  Item state changed\n-    ${NEW_STATE} =  Get Text  xpath=(//span[contains(@class,\'state-\')])[2]\n+    ${NEW_STATE} =  Get Text  xpath=(//span[contains(@class,\'state-\')])\n     # Should Not Be Equal  ${NEW_STATE}  ${OLD_STATE}\n \n second menu should be visible\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_actions.robot b/Products/CMFPlone/tests/robot/test_controlpanel_actions.robot\nindex b8050c4097..8bb0a2513c 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_actions.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_actions.robot\n@@ -71,36 +71,36 @@ I modify an action title\n   Click Link    css=section:nth-child(3) li:first-child a\n   Wait until page contains  Action Settings\n   Input Text for sure  form.widgets.title  A new site map\n-  Click Element  css=.pattern-modal-buttons > input\n+  Wait For Then Click Element  css=.pattern-modal-buttons > button\n \n I change the actions order\n   Click Link    css=section:nth-child(3) li:first-child a\n   Wait until page contains  Action Settings\n   Input Text for sure  form.widgets.position  3\n-  Click Element  css=.pattern-modal-buttons > input\n+  Wait For Then Click Element  css=.pattern-modal-buttons > button\n \n I add a new action\n   Click Link  Add new action\n   Wait until page contains  New action\n   Select From List By Label   form.widgets.category:list   User actions\n   Input Text for sure  form.widgets.id  favorites\n-  Click Element  css=.pattern-modal-buttons > input\n+  Wait For Then Click Element  css=.pattern-modal-buttons > button\n   Wait until page contains  favorites\n-  Click Link    css=section:nth-child(7) li:last-child a\n+  Wait For Then Click Element  css=section.category:last-child li:last-child a\n   Wait until page contains  Action Settings\n   Input Text for sure  form.widgets.title  My favorites\n   Input Text for sure  form.widgets.url_expr  string:\\${globals_view/navigationRootUrl}/favorites\n-  Click Element  css=.pattern-modal-buttons > input\n+  Wait For Then Click Element  css=.pattern-modal-buttons > button\n \n I delete an action\n-  Click Button    css=section:nth-child(3) li:first-child input[name=delete]\n-  Confirm Action\n+  Click Button    css=section:nth-child(3) li:first-child button[name=delete]\n+  Handle alert\n \n I hide an action\n-  Click Button    css=section:nth-child(3) li:first-child input[name=hide]\n+  Click Button    css=section:nth-child(3) li:first-child button[name=hide]\n \n I unhide the action\n-  Click Button    css=section:nth-child(3) li:first-child input[name=show]\n+  Click Button    css=section:nth-child(3) li:first-child button[name=show]\n \n # --- THEN -------------------------------------------------------------------\n \ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_filter.robot b/Products/CMFPlone/tests/robot/test_controlpanel_filter.robot\nindex 1ff5b52680..bcdf3307aa 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_filter.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_filter.robot\n@@ -69,7 +69,21 @@ the filter control panel\n \n Input RichText\n   [Arguments]  ${input}\n-  Wait until keyword succeeds  5s  1s  Execute Javascript  tinyMCE.activeEditor.setContent(\'${input}\');\n+  # Sleep to avoid random failures where the text is not actually set.\n+  # This warning from the robotframework docs might be the cause:\n+  # "Starting from Robot Framework 2.5 errors caused by invalid syntax, timeouts,\n+  # or fatal exceptions are not caught by this keyword."\n+  # See https://robotframework.org/robotframework/2.6.1/libraries/BuiltIn.html#Wait%20Until%20Keyword%20Succeeds\n+  Sleep  1\n+  Wait until keyword succeeds  5s  1s  Set and Check TinyMCE Content  ${input}\n+\n+Set and Check TinyMCE Content\n+  [Arguments]  ${input}\n+  # Simply check if tinyMCE.getContent() isn\'t empty when we set an input\n+  Execute Javascript   tinyMCE.activeEditor.setContent(\'${input}\');\n+  Sleep  0.5\n+  ${check}=  Execute Javascript  return tinyMCE.activeEditor.getContent();\n+  Should not be empty  ${check}\n \n \n # --- WHEN -------------------------------------------------------------------\n@@ -77,26 +91,24 @@ Input RichText\n I add \'${tag}\' to the nasty tags list and remove it from the valid tags list\n   Input Text  name=form.widgets.nasty_tags  ${tag}\n   Remove line from textarea  form.widgets.valid_tags  ${tag}\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  I save the form\n \n I remove \'${tag}\' from the valid tags list\n   Remove line from textarea  form.widgets.valid_tags  ${tag}\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  I save the form\n \n I add \'${tag}\' to the valid tags list\n   Input Text  name=form.widgets.valid_tags  ${tag}\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  I save the form\n+  Page Should Contain  ${tag}\n \n I add \'${tag}\' to the custom attributes list\n   Input Text  name=form.widgets.custom_attributes  ${tag}\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  I save the form\n+  Page Should Contain  ${tag}\n \n I save the form\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n \n@@ -106,38 +118,43 @@ the \'h1\' tag is filtered out when a document is saved\n   ${doc1_uid}=  Create content  id=doc1  title=Document 1  type=Document\n   Go To  ${PLONE_URL}/doc1/edit\n   patterns are loaded\n-  Input RichText  <h1>h1 heading</h1><p>lorem ipsum</p>\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  Input RichText  <h1>h1 heading</h1><p>Spanish Inquisition</p>\n+  I save the form\n+  # We check that some standard text is there, before checking the interesting part.\n+  # If the standard text is invisible, then something completely different is wrong.\n+  # I see tests randomly fail where the safe html transform is not even called.\n+  # In fact, no text is saved.  Maybe some timing problem.\n+  # I suspect the Input RichText keyword, which is why I added Sleep in there.\n+  Page should contain  Spanish Inquisition\n   Page should not contain  heading\n \n the \'h1\' tag is stripped when a document is saved\n   ${doc1_uid}=  Create content  id=doc1  title=Document 1  type=Document\n   Go To  ${PLONE_URL}/doc1/edit\n   patterns are loaded\n-  Input RichText  <h1>h1 heading</h1><p>lorem ipsum</p>\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  Input RichText  <h1>h1 heading</h1><p>Spanish Inquisition</p>\n+  I save the form\n+  Page should contain  Spanish Inquisition\n   Page should contain  heading\n-  XPath Should Match X Times  //div[@id=\'content-core\']//h1  0  message=h1 should have been stripped out\n+  Page Should Contain Element  //div[@id=\'content-core\']//h1  limit=0  message=h1 should have been stripped out\n \n the \'${tag}\' tag is preserved when a document is saved\n   ${doc1_uid}=  Create content  id=doc1  title=Document 1  type=Document\n   Go To  ${PLONE_URL}/doc1/edit\n   patterns are loaded\n-  Input RichText  <${tag}>lorem ipsum</${tag}>\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n-  XPath Should Match X Times  //div[@id=\'content-core\']//${tag}  1  message=the ${tag} tag should have been preserved\n+  Input RichText  <${tag}>lorem ipsum</${tag}><p>Spanish Inquisition</p>\n+  I save the form\n+  Page should contain  Spanish Inquisition\n+  Page Should Contain Element  //div[@id=\'content-core\']//${tag}  limit=1  message=the ${tag} tag should have been preserved\n \n the \'${attribute}\' attribute is preserved when a document is saved\n   ${doc1_uid}=  Create content  id=doc1  title=Document 1  type=Document\n   Go To  ${PLONE_URL}/doc1/edit\n   patterns are loaded\n-  Input RichText  <span ${attribute}="foo">lorem ipsum</span>\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n-  XPath Should Match X Times  //span[@${attribute}]  1  message=the ${attribute} tag should have been preserved\n+  Input RichText  <span ${attribute}="foo">lorem ipsum</span><p>Spanish Inquisition</p>\n+  I save the form\n+  Page should contain  Spanish Inquisition\n+  Page Should Contain Element  //span[@${attribute}]  limit=1  message=the ${attribute} tag should have been preserved\n \n success message should contain information regarding caching\n-  Element Should Contain  css=.portalMessage.warning  HTML generation is heavily cached across Plone. You may have to edit existing content or restart your server to see the changes.\n+  Element Should Contain  css=.alert-warning  HTML generation is heavily cached across Plone. You may have to edit existing content or restart your server to see the changes.\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_language.robot b/Products/CMFPlone/tests/robot/test_controlpanel_language.robot\nindex ad4f28b367..163081cffa 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_language.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_language.robot\n@@ -47,5 +47,5 @@ I set the site language to German\n \n the Plone user interface is in German\n   Go to  ${PLONE_URL}\n-  Wait until page contains  Sie sind hier\n-  Page should contain  Sie sind hier\n+  Wait until page contains  Lizensiert unter der\n+  Page should contain  Lizensiert unter der\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot b/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot\nindex 80a85c8bf9..c277aedf52 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot\n@@ -68,27 +68,27 @@ a private document \'${title}\'\n \n I disable generate tabs\n   Unselect Checkbox  form.widgets.generate_tabs:list\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I disable non-folderish tabs\n   Unselect Checkbox  xpath=//input[@value=\'Document\']\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I remove \'${portal_type}\' from the displayed types list\n   Unselect Checkbox  xpath=//input[@value=\'Document\']\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I enable filtering by workflow states\n   Select Checkbox  name=form.widgets.filter_on_workflow:list\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I choose to show \'${workflow_state}\' items\n   Select Checkbox  xpath=//input[@value=\'${workflow_state}\']\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I choose to not show \'${workflow_state}\' items\n@@ -102,14 +102,14 @@ I choose to not show \'${workflow_state}\' items\n the document \'${title}\' shows up in the navigation\n   Go to  ${PLONE_URL}\n   Wait until page contains  Powered by Plone\n-  XPath Should Match X Times  //ul[@id=\'portal-globalnav\']/li/a[contains(text(), \'${title}\')]  1  message=The global navigation should have contained the item \'${title}\'\n+  Page Should Contain Element  //ul[@id=\'portal-globalnav\']/li/a[contains(text(), \'${title}\')]  limit=1  message=The global navigation should have contained the item \'${title}\'\n \n the document \'${title}\' does not show up in the navigation\n   Go to  ${PLONE_URL}\n   Wait until page contains  Powered by Plone\n-  XPath Should Match X Times  //ul[@id=\'portal-globalnav\']/li/a[contains(text(), \'${title}\')]  0  message=The global navigation should not have contained the item \'${title}\'\n+  Page Should Contain Element  //ul[@id=\'portal-globalnav\']/li/a[contains(text(), \'${title}\')]  limit=0  message=The global navigation should not have contained the item \'${title}\'\n \n the document \'${title}\' does not show up in the sitemap\n   Go to  ${PLONE_URL}/sitemap\n   Wait until page contains  Powered by Plone\n-  XPath Should Match X Times  //ul[@id=\'portal-sitemap\']/li/a/span[contains(text(), \'${title}\')]  0  message=The sitemap should not have contained the item \'${title}\'\n+  Page Should Contain Element  //ul[@id=\'portal-sitemap\']/li/a/span[contains(text(), \'${title}\')]  limit=0  message=The sitemap should not have contained the item \'${title}\'\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_search.robot b/Products/CMFPlone/tests/robot/test_controlpanel_search.robot\nindex 900fc832ad..de9c3b5cfe 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_search.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_search.robot\n@@ -49,14 +49,15 @@ the search control panel\n \n I enable livesearch\n   Select Checkbox  form.widgets.enable_livesearch:list\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I exclude the \'${portal_type}\' type from search\n   # Make sure we see the checkbox, in expanded in jenkins it gets a bit under the toolbar\n-  Click Link  css=a.plone-toolbar-logo\n-  Unselect Checkbox  xpath=//input[@name=\'form.widgets.types_not_searched:list\' and @value=\'${portal_type}\']\n-  Click Button  Save\n+  ${element}  Set Variable  xpath=//input[@name=\'form.widgets.types_not_searched:list\' and @value=\'${portal_type}\']\n+  Wait For Element  ${element}\n+  Unselect Checkbox  ${element}\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n \n@@ -75,6 +76,6 @@ searching for \'${search_term}\' will not return any results\n   Input Text  xpath=//form[@id=\'searchform\']//input[@name=\'SearchableText\']  ${search_term}\n   Submit Form  name=searchform\n   Wait until page contains  items matching your search terms\n-  XPath Should Match X Times  //strong[@id=\'search-results-number\' and contains(.,\'0\')]  1\n+  Page Should Contain Element  //span[@id=\'search-results-number\' and contains(.,\'0\')]  1\n \n \ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_security.robot b/Products/CMFPlone/tests/robot/test_controlpanel_security.robot\nindex cb91da1fff..535f96945e 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_security.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_security.robot\n@@ -11,7 +11,6 @@ Resource  keywords.robot\n Test Setup  Run keywords  Plone Test Setup\n Test Teardown  Run keywords  Plone Test Teardown\n \n-\n *** Test Cases ***************************************************************\n \n Scenario: Enable self registration in the Security Control Panel\n@@ -65,9 +64,9 @@ the security control panel\n \n a published test folder\n   Go to  ${PLONE_URL}/test-folder\n-  Wait until element is visible  css=#plone-contentmenu-workflow\n+  Wait For Element  css=#plone-contentmenu-workflow\n   Click link  xpath=//li[@id=\'plone-contentmenu-workflow\']/a\n-  Wait until element is visible  id=workflow-transition-publish\n+  Wait For Element  id=workflow-transition-publish\n   Click link  id=workflow-transition-publish\n   Wait until page contains  Item state changed\n \n@@ -143,7 +142,7 @@ A user folder should be created when a user registers and logs in to the site\n   Input Text for sure  form.widgets.email  joe@test.com\n   Input Text for sure  form.widgets.password  supersecret\n   Input Text for sure  form.widgets.password_ctl  supersecret\n-  Click Button  Register\n+  Wait For Then Click Element  css=#form-buttons-register\n \n   # I login to the site\n   Go to  ${PLONE_URL}/login\n@@ -155,8 +154,7 @@ A user folder should be created when a user registers and logs in to the site\n \n   # The user folder should be created\n   Go to  ${PLONE_URL}/Members/joe\n-  Wait until page contains  joe\n-  Element Should Contain  css=h1.documentFirstHeading  joe\n+  Wait until element contains  css=h1  joe\n   Page should Not contain  This page does not seem to exist\n \n Anonymous users can view \'about\' information\n@@ -176,7 +174,7 @@ UUID should be used for the user id\n   Input Text for sure  form.widgets.email  joe@test.com\n   Input Text for sure  form.widgets.password  supersecret\n   Input Text for sure  form.widgets.password_ctl  supersecret\n-  Click Button  Register\n+  Wait For Then Click Element  css=#form-buttons-register\n \n   # I login to the site\n   Go to  ${PLONE_URL}/login\n@@ -185,9 +183,8 @@ UUID should be used for the user id\n   Input text for sure  __ac_password  supersecret\n   Click Button  Log in\n   Wait until page contains  You are now logged in\n-\n   # XXX: Here we can\'t really test that this is a uuid, since it\'s random, so\n   # we just check that user id is not equal to username or email\n-  ${userid}=  Get Text  xpath=//li[@id=\'portal-personaltools\']//li[contains(@class, \'plone-toolbar-submenu-header\')]//span\n+  ${userid}=  Get Text  xpath=//a[@id=\'personaltools-menulink\']\n   Should Not Be Equal As Strings  ${userid}  joe\n   Should Not Be Equal As Strings  ${userid}  joe@test.com\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_site.robot b/Products/CMFPlone/tests/robot/test_controlpanel_site.robot\nindex e425f19b9c..1844ac2d65 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_site.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_site.robot\n@@ -63,32 +63,33 @@ the site control panel\n \n I enable the sitemap\n   Given patterns are loaded\n+  Wait For Element  css=#formfield-form-widgets-enable_sitemap\n   Select Checkbox  form.widgets.enable_sitemap:list\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I set the site title to \'${site_title}\'\n   Given patterns are loaded\n   Input Text  name=form.widgets.site_title  ${site_title}\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I set a custom logo\n   Given patterns are loaded\n   Choose File  name=form.widgets.site_logo  ${PATH_TO_TEST_FILES}/pixel.png\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I enable dublin core metadata\n   Given patterns are loaded\n   Select Checkbox  form.widgets.exposeDCMetaTags:list\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I add a Javascript snippet to the webstats javascript\n   Given patterns are loaded\n   Input Text  name=form.widgets.webstats_js  <script id="webstats_snippet"></script>\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n \ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_social.robot b/Products/CMFPlone/tests/robot/test_controlpanel_social.robot\nindex 233a36d829..2fae936771 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_social.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_social.robot\n@@ -44,16 +44,14 @@ the social control panel\n \n I disable social\n   UnSelect Checkbox  form.widgets.share_social_data:list\n-  Sleep  2\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I provide social settings\n   Input Text  name=form.widgets.twitter_username  plonecms\n   Input Text  name=form.widgets.facebook_app_id  123456\n   Input Text  name=form.widgets.facebook_username  plonecms\n-  Sleep  2\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n \ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_types.robot b/Products/CMFPlone/tests/robot/test_controlpanel_types.robot\nindex 4c211f255f..ad494dd09b 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_types.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_types.robot\n@@ -55,7 +55,7 @@ Globaly enabled comments\n # --- WHEN -------------------------------------------------------------------\n \n I select \'${content_type}\' in types dropdown\n-  Select from list  name=type_id  ${content_type}\n+  Select from list by label  name=type_id  ${content_type}\n   Wait until page contains  Globally addable\n \n Allow discussion\n@@ -63,7 +63,7 @@ Allow discussion\n   Click Button  Save\n \n I select \'${workflow}\' workflow\n-  Select from list  name=new_workflow  ${workflow}\n+  Select from list by label  name=new_workflow  ${workflow}\n   Click Button  Save\n \n I add new Link \'${id}\'\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_usergroups.robot b/Products/CMFPlone/tests/robot/test_controlpanel_usergroups.robot\nindex 9a1500597c..0a4a2a9e1c 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_usergroups.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_usergroups.robot\n@@ -26,29 +26,26 @@ Test Teardown  Run keywords  Plone Test Teardown\n \n Scenario: Show all users in users control panel\n   Given a logged-in site administrator\n-    and the usergroups control panel\n+    and the users control panel\n    When I click show all users\n    Then all users should be shown\n \n Scenario: Show all groups in groups control panel\n   Given a logged-in site administrator\n-    and the usergroups control panel\n-   When I go to Groups control panel\n-    and I click show all groups\n+    and the groups control panel\n+   When I click show all groups\n    Then all groups should be shown\n \n Scenario: Create new group\n   Given a logged-in site administrator\n-    and the usergroups control panel\n-   When I go to Groups control panel\n-    and I create new group\n+    and the groups control panel\n+   When I create new group\n    Then new group should show under all groups\n \n Scenario: Enable many groups and many users settings in usergroups control panel\n   Given a logged-in site administrator\n-    and the usergroups control panel\n-   When I go to Settings control panel\n-    and enable many groups and many users settings\n+    and the user group settings control panel\n+   When I enable many groups and many users settings\n    Then showing all users is disabled\n     and showing all groups is disabled\n \n@@ -60,9 +57,17 @@ Scenario: Enable many groups and many users settings in usergroups control panel\n a logged-in site administrator\n   Enable autologin as  Site Administrator\n \n-the usergroups control panel\n+the users control panel\n   Go to  ${PLONE_URL}/@@usergroup-userprefs\n-  Wait until page contains  Users and Groups\n+  Wait until page contains  User Search\n+\n+the groups control panel\n+  Go to  ${PLONE_URL}/@@usergroup-groupprefs\n+  Wait until page contains  Group Search\n+\n+the user group settings control panel\n+  Go to  ${PLONE_URL}/@@usergroup-controlpanel\n+  Wait until page contains  User and Groups Settings\n \n \n # --- WHEN -------------------------------------------------------------------\n@@ -71,16 +76,12 @@ I click show all users\n   Click button  Show all\n   Wait until page contains  User Search\n \n-I go to Groups control panel\n-  Click link  Groups\n-  Wait until page contains  Group Search\n-\n I click show all groups\n   Click button  Show all\n   Wait until page contains  Group Search\n \n I create new group\n-  Click button  Add New Group\n+  Click link  Add New Group\n   Wait until page contains element  name=addname\n   patterns are loaded\n   Input Text  name=addname  my-new-group\n@@ -92,11 +93,7 @@ I create new group\n   I click show all groups\n   Page should contain  my-new-group\n \n-I go to Settings control panel\n-  Click link  Settings\n-  Wait until page contains  User and groups settings\n-\n-enable many groups and many users settings\n+I enable many groups and many users settings\n   Select Checkbox  name=form.widgets.many_groups:list\n   Select Checkbox  name=form.widgets.many_users:list\n   Click button  Save\n@@ -115,13 +112,11 @@ all groups should be shown\n   Page should contain  Site Administrators\n \n showing all users is disabled\n-  Click link  Users\n-  Wait until page contains  User Search\n+  the users control panel\n   Page should not contain  Show all\n \n showing all groups is disabled\n-  Click link  Groups\n-  Wait until page contains  Group Search\n+  the users control panel\n   Page should not contain  Show all\n \n new group should show under all groups\ndiff --git a/Products/CMFPlone/tests/robot/test_edit.robot b/Products/CMFPlone/tests/robot/test_edit.robot\nindex 67ad46425e..9c8935560e 100644\n--- a/Products/CMFPlone/tests/robot/test_edit.robot\n+++ b/Products/CMFPlone/tests/robot/test_edit.robot\n@@ -106,12 +106,12 @@ I save the page\n    Click Button  Save\n \n I select a date using the dropdowns\n-    Select From List  xpath=//select[@id=\'edit_form_effectiveDate_0_year\']  2001\n-    Select From List  xpath=//select[@id=\'edit_form_effectiveDate_0_month\']  January\n-    Select From List  xpath=//select[@id=\'edit_form_effectiveDate_0_day\']  01\n-    Select From List  xpath=//select[@id=\'edit_form_effectiveDate_0_hour\']  01\n-    Select From List  xpath=//select[@id=\'edit_form_effectiveDate_0_minute\']  00\n-    Select From List  xpath=//select[@id=\'edit_form_effectiveDate_0_ampm\']  AM\n+    Select From List By Label  xpath=//select[@id=\'edit_form_effectiveDate_0_year\']  2001\n+    Select From List By Label  xpath=//select[@id=\'edit_form_effectiveDate_0_month\']  January\n+    Select From List By Label  xpath=//select[@id=\'edit_form_effectiveDate_0_day\']  01\n+    Select From List By Label  xpath=//select[@id=\'edit_form_effectiveDate_0_hour\']  01\n+    Select From List By Label  xpath=//select[@id=\'edit_form_effectiveDate_0_minute\']  00\n+    Select From List By Label  xpath=//select[@id=\'edit_form_effectiveDate_0_ampm\']  AM\n \n I click the calendar icon\n \ndiff --git a/Products/CMFPlone/tests/robot/test_edit_user_schema.robot b/Products/CMFPlone/tests/robot/test_edit_user_schema.robot\nindex ccec28c4c7..439bb5b074 100644\n--- a/Products/CMFPlone/tests/robot/test_edit_user_schema.robot\n+++ b/Products/CMFPlone/tests/robot/test_edit_user_schema.robot\n@@ -93,62 +93,56 @@ site registration enabled\n I add a new text field to the member fields\n   Go to  ${PLONE_URL}/@@member-fields\n   Wait until page contains element  css=#add-field\n-  Click Button  Add new field\xe2\x80\xa6\n+  Click Link  Add new field\xe2\x80\xa6\n   Wait Until Element Is visible  css=#add-field-form #form-widgets-title\n   Input Text  css=#add-field-form #form-widgets-title  Test Field\n-  Press Key  css=#add-field-form #form-widgets-title  \\\\09\n+  Press Keys  css=#add-field-form #form-widgets-title  TAB\n   Select From List By Label  css=#form-widgets-factory  Text line (String)\n-  Click button  css=.pattern-modal-buttons input#form-buttons-add\n-  # XXX: This is really really bad! We need a UI notification like:\n-  # Wait until page contains  Field created.\n-  Sleep  1\n+  Click button  css=.pattern-modal-buttons button#form-buttons-add\n+  Wait until page contains  Field added successfully.\n+\n+I Open the test_field Settings\n+  Go to  ${PLONE_URL}/@@member-fields\n+  Wait For Element  css=div[data-field_id=\'test_field\']\n+  Wait For Then Click Element  css=div[data-field_id=\'test_field\'] a.fieldSettings\n \n I add a new required text field to the member fields\n   Go to  ${PLONE_URL}/@@member-fields\n   Wait until page contains element  css=#add-field\n-  Click Button  Add new field\xe2\x80\xa6\n+  Click Link  Add new field\xe2\x80\xa6\n   Wait Until Element Is visible  css=#add-field-form #form-widgets-title\n   Input Text  css=#add-field-form #form-widgets-title  Test Field\n-  Press Key  css=#add-field-form #form-widgets-title  \\\\09\n+  Press Keys  css=#add-field-form #form-widgets-title  TAB\n   Select From List By Label  css=#form-widgets-factory  Text line (String)\n   Select Checkbox  form.widgets.required:list\n-  Click button  css=.pattern-modal-buttons input#form-buttons-add\n-  # XXX: This is really really bad! We need a UI notification like:\n-  # Wait until page contains  Field created.\n-  Sleep  1\n+  Click button  css=.pattern-modal-buttons button#form-buttons-add\n+  Wait until page contains  Field added successfully.\n \n choose to show the field on registration\n-  Go to  ${PLONE_URL}/@@member-fields\n-  Wait until page contains element  css=div[data-field_id=\'test_field\']\n-  Click link  css=div[data-field_id=\'test_field\'] a.fieldSettings\n+  I Open the test_field Settings\n   Wait Until Element Is visible  form.widgets.IUserFormSelection.forms:list\n   Select Checkbox  css=#form-widgets-IUserFormSelection-forms-0\n-  Click button  css=.pattern-modal-buttons input#form-buttons-save\n-  # XXX: This is really really bad! We need a UI notification like:\n-  # Wait until page contains  Field created.\n-  Sleep  1\n+  Click button  css=.pattern-modal-buttons button#form-buttons-save\n+  Wait until page contains  Data successfully updated.\n \n choose to show the field in the user profile\n-  Go to  ${PLONE_URL}/@@member-fields\n-  Wait until page contains element  css=div[data-field_id=\'test_field\']\n-  Click link  css=div[data-field_id=\'test_field\'] a.fieldSettings\n+  I Open the test_field Settings\n   Wait Until Element Is visible  form.widgets.IUserFormSelection.forms:list\n   Select Checkbox  css=#form-widgets-IUserFormSelection-forms-1\n-  Click button  css=.pattern-modal-buttons input#form-buttons-save\n-  # XXX: This is really really bad! We need a UI notification like:\n-  # Wait until page contains  Field created.\n-  Sleep  1\n+  Click button  css=.pattern-modal-buttons button#form-buttons-save\n+  Wait until page contains  Data successfully updated.\n \n I move the new field to the top\n   # XXX: Drag and drop is not working!!!\n   Drag And Drop  xpath=//div[@data-field_id="test_field"]//span[contains(@class, "draghandle")]  xpath=//div[@data-field_id="home_page"]\n \n add a min/max constraint to the field\n-  Click Link  xpath=//div[@data-field_id=\'test_field\']//a[contains(@class, \'fieldSettings\')]\n+  I Open the test_field Settings\n   Wait until page contains element  form.widgets.min_length\n   Input Text  form.widgets.min_length  4\n   Input Text  form.widgets.max_length  6\n-  Click Button  css=.pattern-modal-buttons input#form-buttons-save\n+  Wait Until Element Is visible  css=.pattern-modal-buttons button#form-buttons-save\n+  Click Button  css=.pattern-modal-buttons button#form-buttons-save\n   Sleep  1\n \n \n@@ -169,15 +163,17 @@ a logged-in user will see the field in the user profile\n \n a logged-in user will see the required field in the user profile\n   a logged-in user will see the field in the user profile\n-  XPath Should Match X Times  //div[@id=\'formfield-form-widgets-test_field\']//span[contains(@class, \'required\')]  1  message=test_field should be required\n+  Page Should Contain Element  //div[@id=\'formfield-form-widgets-test_field\']//span[contains(@class, \'required\')]  limit=1  message=test_field should be required\n \n a logged-in user will see the field on top of the user profile\n   a logged-in user will see the field in the user profile\n-  XPath Should Match X Times  //form[@id=\'form\']/div[1]//input[@id=\'form-widgets-test_field\']  1  message=test_field should be on top\n+  Page Should Contain Element  //form[@id=\'form\']/div[1]//input[@id=\'form-widgets-test_field\']  limit=1  message=test_field should be on top\n \n a logged-in user will see a field with min/max constraints\n   a logged-in user will see the field in the user profile\n+  Input Text  form.widgets.email  test@plone.org\n+  Wait For Element  css=#form-widgets-test_field\n   Input Text  form.widgets.test_field  1\n-  Click Button  Save\n+  Wait For Then Click Element  css=.formControls button#form-buttons-save\n   Wait until page contains  There were some errors.\n   Page should contain  Value is too short\ndiff --git a/Products/CMFPlone/tests/robot/test_folder_contents.robot b/Products/CMFPlone/tests/robot/test_folder_contents.robot\nindex 960b9dc068..98cee696e9 100644\n--- a/Products/CMFPlone/tests/robot/test_folder_contents.robot\n+++ b/Products/CMFPlone/tests/robot/test_folder_contents.robot\n@@ -14,6 +14,7 @@ Test Teardown  Run keywords  Plone Test Teardown\n \n *** Test cases ***************************************************************\n \n+\n Scenario: Select All items\n     Given a logged-in site administrator\n       and a folder with four pages\n@@ -23,26 +24,26 @@ Scenario: Select All items\n       and the four elements got selected\n       and the clear selection link appears\n \n-#Scenario: Clear selection\n-#    Given a site owner\n-#      And four dummy pages on test folder\n-#      And the folder contents view\n-#      And I select all the elements\n-#     When I clear the selection\n-#     Then no elements should be selected\n-\n-# XXX: This scenario only works on Firefox. In Chrome fails to do the Mouse Up\n-# and Mouse Down correctly.\n-#Scenario: Reorder Folder Contents\n-#    Given a site owner\n-#      And four dummy pages on test folder\n-#     When the folder contents view\n-#     Then the order should be 1 > 2 > 3 > 4\n-#     When I reorder the elements\n-#     Then the new order should be 4 > 3 > 2 > 1\n+Scenario: Clear selection\n+   Given a logged-in site administrator\n+     and a folder with four pages\n+     and the folder contents view\n+     And I select all the elements\n+    When I clear the selection\n+    Then no elements should be selected\n+\n+Scenario: Reorder Folder Contents\n+   Given a logged-in site administrator\n+     and a folder with four pages\n+     and the folder contents view\n+    Then The Order Should Be  1   2   3   4\n+    When I reorder the elements\n+    Then The Order Should Be  4   3   2   1\n+\n \n *** Keywords *****************************************************************\n \n+\n a folder with four pages\n     ${folder_uid}=  Create content  type=Folder  title=My Folder\n     Create content  type=Document  title=Doc1  container=${folder_uid}\n@@ -52,15 +53,17 @@ a folder with four pages\n \n the folder contents view\n     Go to  ${PLONE_URL}/my-folder/folder_contents\n-    Page should contain element  css=.pat-structure\n     Given folder contents pattern loaded\n \n I click the \'${link_name}\' link\n     Click Link  ${link_name}\n \n I select all the elements\n-    Element should be visible  css=.pat-structure .select-all\n-    Click Element  css=.pat-structure .select-all\n+    Wait until page contains element  css=.pat-structure .select-all\n+    Wait until page contains element  css=.itemRow\n+    ${select_all_selector}  Set Variable  .pat-structure .select-all\n+    Wait Until Element Is Visible  css=${select_all_selector}\n+    Click Element  css=${select_all_selector}\n \n the four elements got selected\n     Checkbox Should Be Selected  css=tr[data-id="doc1"] input\n@@ -76,7 +79,7 @@ the clear selection link appears\n     Page Should Contain Element  css=a.remove-all\n \n I clear the selection\n-    Click link  id=selected\n+    Click link  id=btn-selected-items\n     Click link  css=a.remove-all\n \n no elements should be selected\n@@ -85,41 +88,17 @@ no elements should be selected\n     Checkbox Should Not Be Selected  css=tr[data-id="doc3"] input\n     Checkbox Should Not Be Selected  css=tr[data-id="doc4"] input\n \n-the order should be 1 > 2 > 3 > 4\n-    Should be above  css=tr[data-id="doc1"]  css=tr[data-id="doc2"]\n-    Should be above  css=tr[data-id="doc2"]  css=tr[data-id="doc3"]\n-    Should be above  css=tr[data-id="doc3"]  css=tr[data-id="doc4"]\n-\n I reorder the elements\n-    # Moving items could fail on a fast computer\n-    Set Selenium Speed  0.1 seconds\n-\n-    # Moves the doc2 page above the doc1 page\n-    Reorder Element  folder-contents-item-doc1  folder-contents-item-doc2\n+    Click link  css=#btn-structure-rearrange\n+    Click element  name=reversed\n+    Click button  css=#popover-structure-rearrange .btn-primary\n+    Wait until page contains  Successfully rearranged folder\n \n-    # Moves the doc4 page above the doc2 page\n-    Reorder Element  folder-contents-item-doc4  folder-contents-item-doc3\n-    Reorder Element  folder-contents-item-doc4  folder-contents-item-doc1\n-    Reorder Element  folder-contents-item-doc4  folder-contents-item-doc2\n-\n-    # Moves the doc3 page above the doc2 page\n-    Reorder Element  folder-contents-item-doc3  folder-contents-item-doc1\n-    Reorder Element  folder-contents-item-doc3  folder-contents-item-doc2\n-\n-    # Go back to normal speed\n-    Set Selenium Speed  0 seconds\n-\n-the new order should be 4 > 3 > 2 > 1\n-    Should be above  css=tr#folder-contents-item-doc4  css=tr#folder-contents-item-doc3\n-    Should be above  css=tr#folder-contents-item-doc3  css=tr#folder-contents-item-doc2\n-    Should be above  css=tr#folder-contents-item-doc2  css=tr#folder-contents-item-doc1\n-\n-Reorder Element\n-    [arguments]  ${element}  ${destination}\n-\n-    Mouse Down  xpath=//tr[@id=\'${element}\']/td\n-    Mouse Up    xpath=//tr[@id=\'${destination}\']/td\n-    Mouse Out   xpath=//tr[@id=\'${element}\']/td\n+The Order Should Be\n+    [Arguments]  ${first}  ${second}  ${third}  ${fourth}\n+    Should be above  css=tr[data-id="doc${first}"]   css=tr[data-id="doc${second}"]\n+    Should be above  css=tr[data-id="doc${second}"]  css=tr[data-id="doc${third}"]\n+    Should be above  css=tr[data-id="doc${third}"]   css=tr[data-id="doc${fourth}"]\n \n Should be above\n     [Arguments]  ${locator1}  ${locator2}\n@@ -127,6 +106,3 @@ Should be above\n     ${locator1-position} =  Get vertical position  ${locator1}\n     ${locator2-position} =  Get vertical position  ${locator2}\n     Should be true  ${locator1-position} < ${locator2-position}\n-\n-folder contents pattern loaded\n-    Wait For Condition  return !!document.querySelector(\'.pat-structure div.navbar\')\ndiff --git a/Products/CMFPlone/tests/robot/test_linkintegrity.robot b/Products/CMFPlone/tests/robot/test_linkintegrity.robot\nindex 348211668b..b798d6a824 100644\n--- a/Products/CMFPlone/tests/robot/test_linkintegrity.robot\n+++ b/Products/CMFPlone/tests/robot/test_linkintegrity.robot\n@@ -69,79 +69,77 @@ a page to edit\n \n a link in rich text\n   Go To  ${PLONE_URL}/bar/edit\n-  Wait until element is visible  css=.mce-edit-area iframe\n-  Select Frame  css=.mce-edit-area iframe\n+  Wait until element is visible  css=.tox-edit-area iframe\n+  Select Frame  css=.tox-edit-area iframe\n   Input text  css=.mce-content-body  foo\n   Execute Javascript    function selectElementContents(el) {var range = document.createRange(); range.selectNodeContents(el); var sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);} var el = document.getElementById("tinymce"); selectElementContents(el);\n   UnSelect Frame\n-  Click Button  css=div[aria-label="Insert/edit link"] button\n+  Click Button  css=button[aria-label="Insert/edit link"]\n \n   Given patterns are loaded\n+  # Somehow this does not work:\n+  # Wait For Then Click Element  css=.pat-relateditems .select2-input.select2-default\n   Wait until element is visible  css=.pat-relateditems .select2-input.select2-default\n   Click Element  css=.pat-relateditems .select2-input.select2-default\n-  Wait until element is visible  css=.pattern-relateditems-result.one-level-up a.pattern-relateditems-result-browse\n-  Click Element  css=.pattern-relateditems-result.one-level-up a.pattern-relateditems-result-browse\n+  Wait until element is visible  css=.pat-relateditems-result.one-level-up a.pat-relateditems-result-browse\n+  Click Element  css=.pat-relateditems-result.one-level-up a.pat-relateditems-result-browse\n   Wait until element is visible  xpath=(//span[contains(., \'Foo\')])\n   Click Element  xpath=(//span[contains(., \'Foo\')])\n   Wait until page contains  Foo\n-\n-  Click Button  css=.plone-modal-footer .plone-btn-primary\n-  Click Button  css=#form-buttons-save\n+  Wait For Then Click Element  css=.modal-footer .btn-primary\n+  Wait For Then Click Element  css=#form-buttons-save\n \n \n should show warning when deleting page\n+\n   Go To  ${PLONE_URL}/foo\n-  Wait until element is visible  css=#plone-contentmenu-actions a\n-  Click Link  css=#plone-contentmenu-actions a\n-  Wait until element is visible  css=#plone-contentmenu-actions-delete\n-  Click Link  css=#plone-contentmenu-actions-delete\n+  Wait For Then Click Element  css=#plone-contentmenu-actions > a\n+  Wait For Then Click Element  css=#plone-contentmenu-actions-delete\n   Wait until page contains element  css=.breach-container .breach-item\n \n \n should show warning when deleting page from folder_contents\n   Go To  ${PLONE_URL}/folder_contents\n-  Wait until keyword succeeds  30  1  Page should contain element  css=tr[data-id="foo"] input\n-  Click Element  css=tr[data-id="foo"] input\n+  Given folder contents pattern loaded\n+  Wait For Then Click Element  css=tr[data-id="foo"] input\n   Checkbox Should Be Selected  css=tr[data-id="foo"] input\n   Wait until keyword succeeds  30  1  Page should not contain element  css=#btn-delete.disabled\n-  Click Element  css=#btngroup-mainbuttons #btn-delete\n+\n+  Wait For Then Click Element  css=#btngroup-mainbuttons #btn-delete\n   Wait until page contains element  css=.popover-content .btn-danger\n   Page should contain element  css=.breach-container .breach-item\n-  Click Element  css=#popover-delete .closeBtn\n+  Wait For Then Click Element  css=#popover-delete .closeBtn\n   Checkbox Should Be Selected  css=tr[data-id="foo"] input\n \n \n should not show warning when deleting page from folder_contents\n   Go To  ${PLONE_URL}/folder_contents\n-  Wait until page contains element  css=tr[data-id="foo"] input\n-  Click Element  css=tr[data-id="foo"] input\n+  Given folder contents pattern loaded\n+  Wait For Then Click Element  css=tr[data-id="foo"] input\n   Checkbox Should Be Selected  css=tr[data-id="foo"] input\n   Wait until keyword succeeds  30  1  Page should not contain element  css=#btn-delete.disabled\n-  Click Element  css=#btngroup-mainbuttons #btn-delete\n+  Wait For Then Click Element  css=#btngroup-mainbuttons #btn-delete\n   Wait until page contains element  css=.popover-content .btn-danger\n   Page should not contain element  css=.breach-container .breach-item\n-  Click Element  css=#popover-delete .applyBtn\n+  Wait For Then Click Element  css=#popover-delete .applyBtn\n   Wait until page contains  Successfully delete items\n   Wait until keyword succeeds  30  1  Page should not contain Element  css=tr[data-id="foo"] input\n \n \n should not show warning when deleting page\n   Go To  ${PLONE_URL}/foo\n-  Wait until element is visible  css=#plone-contentmenu-actions a\n-  Click Link  css=#plone-contentmenu-actions a\n-  Wait until element is visible  css=#plone-contentmenu-actions-delete\n-  Click Link  css=#plone-contentmenu-actions-delete\n+  Wait For Then Click Element  css=#plone-contentmenu-actions > a\n+  Wait For Then Click Element  css=#plone-contentmenu-actions-delete\n   Page should not contain element  css=.breach-container .breach-item\n \n \n remove link to page\n   Go To  ${PLONE_URL}/bar\n-  Wait until element is visible  css=#contentview-edit a\n-  Click Link  css=#contentview-edit a\n-  Wait until element is visible  css=.mce-edit-area iframe\n-  Select Frame  css=.mce-edit-area iframe\n+  Wait For Then Click Element  css=#contentview-edit a\n+  Wait For Element  css=.tox-edit-area iframe\n+  Select Frame  css=.tox-edit-area iframe\n   Input text  css=.mce-content-body  foo\n   Execute Javascript    function selectElementContents(el) {var range = document.createRange(); range.selectNodeContents(el); var sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);} var el = document.getElementById("tinymce"); selectElementContents(el);\n   UnSelect Frame\n-  Click Button  css=div[aria-label="Remove link"] button\n-  Click Button  css=#form-buttons-save\n+  Click Button  css=button[aria-label="Remove link"]\n+  Wait For Then Click Element  css=#form-buttons-save\ndiff --git a/Products/CMFPlone/tests/robot/test_livesearch.robot b/Products/CMFPlone/tests/robot/test_livesearch.robot\nindex 5fa969e01c..8bed725311 100644\n--- a/Products/CMFPlone/tests/robot/test_livesearch.robot\n+++ b/Products/CMFPlone/tests/robot/test_livesearch.robot\n@@ -6,6 +6,8 @@ Resource  plone/app/robotframework/selenium.robot\n \n Library  Remote  ${PLONE_URL}/RobotRemote\n \n+Variables  Products/CMFPlone/tests/robot/variables.py\n+\n Resource  keywords.robot\n \n Test Setup  Run keywords  Plone Test Setup\n@@ -14,58 +16,69 @@ Test Teardown  Run keywords  Plone Test Teardown\n \n *** Test cases ***************************************************************\n \n+\n Scenario: Simple Livesearch\n-    Pass Execution  Disabled until livesearch pattern is integrated\n     Given a logged-in site administrator\n       and a document  Welcome to Plone\n      When I search for  Welcome\n      Then the livesearch results should contain  Welcome to Plone\n-      and there should be \'2\' livesearch results\n+      and expected livesearch results  1\n \n-Scenario: Livesearch for documents\n-    Pass Execution  Disabled until livesearch pattern is integrated\n+Scenario: Livesearch with image results\n     Given a logged-in site administrator\n-      and a document  My document\n-     When I search for  My document\n-     Then the livesearch results should contain  My document\n-      and there should be \'2\' livesearch results\n+      and a news item  My News with Image\n+     When I search for  My News\n+     Then the livesearch results should contain  My News with Image\n+      and expected livesearch results  1\n+      and Page should contain image  css=.livesearch-results li.search-result .col.img img\n \n-Scenario: Livesearch for folder\n-    Pass Execution  Disabled until livesearch pattern is integrated\n-    Given a logged-in site administrator\n-      and a folder  My folder\n-     When I search for  My folder\n-     Then the livesearch results should contain  My folder\n-      and there should be \'2\' livesearch results\n-\n-Scenario: Livesearch in current folder only\n-    Pass Execution  Disabled until livesearch pattern is integrated\n-    Given a logged-in site administrator\n-      and a folder with a document \'Inside Document\'\n-      and a document  Outside Document\n-     When I search the currentfolder only for  Inside Document\n-     Then the livesearch results should contain  Inside Document\n-      and the livesearch results should not contain  Outside Document\n-      and there should be \'2\' livesearch results\n+     When I disable images in results in search controlpanel\n+      and I search for  My News\n+     Then Page should not contain image  css=.livesearch-results li.search-result .col.img img\n \n \n *** Keywords *****************************************************************\n \n+a document\n+    [Arguments]  ${title}\n+    Create content  type=Document  id=doc  title=${title}\n+\n+a news item\n+    [Arguments]  ${title}\n+    Go to  ${PLONE_URL}/++add++News Item\n+    Wait until page contains  Add News Item\n+    Input text  name=form.widgets.IDublinCore.title  ${title}\n+    Choose File  name=form.widgets.ILeadImageBehavior.image  ${PATH_TO_TEST_FILES}/plone-logo.png\n+    Click Button  Save\n+    Wait until page contains  Item created  error=Image could not be created.\n+\n I search for\n     [Arguments]  ${searchtext}\n     Input text  css=input#searchGadget  ${searchtext}\n-    Focus  css=input#searchGadget\n+    Wait For Element  css=input#searchGadget\n \n I search the currentfolder only for\n     [Arguments]  ${searchtext}\n     Select checkbox  id=searchbox_currentfolder_only\n     Input text  css=input#searchGadget  ${searchtext}\n-    Focus  css=input#searchGadget\n+    Wait For Element  css=input#searchGadget\n \n the livesearch results should contain\n     [Arguments]  ${text}\n-    Wait until keyword succeeds  5s  1s  Element should contain  css=#LSResult .LSRow a  ${text}\n+    Wait until keyword succeeds  5s  1s  Element should contain  css=.livesearch-results li a .heading  ${text}\n \n the livesearch results should not contain\n     [Arguments]  ${text}\n-    Wait until keyword succeeds  5s  1s  Page should not contain  css=#LSResult .LSRow a  ${text}\n+    Wait until keyword succeeds  5s  1s  Page should not contain  css=.livesearch-results li a .heading  ${text}\n+\n+expected livesearch results\n+    [Arguments]  ${num}\n+    ${count} =  Get Element Count  css=.livesearch-results li.search-result\n+    Should Be Equal as Numbers  ${count}  ${num}\n+\n+I disable images in results in search controlpanel\n+    Go to  ${PLONE_URL}/@@search-controlpanel\n+    Wait until page contains  Search Settings\n+    Unselect Checkbox  form.widgets.search_show_images:list\n+    Click Button  Save\n+    Wait until page contains  Changes saved\ndiff --git a/Products/CMFPlone/tests/robot/test_overlays.robot b/Products/CMFPlone/tests/robot/test_overlays.robot\nindex 0d57b15fde..83070070fc 100644\n--- a/Products/CMFPlone/tests/robot/test_overlays.robot\n+++ b/Products/CMFPlone/tests/robot/test_overlays.robot\n@@ -50,7 +50,7 @@ Scenario: Log in form overlay remains on wrong credentials\n     Given the \'Log in\' overlay\n      When I enter wrong credentials\n      Then overlay should remain open\n-      And overlay shows an error\n+      And login overlay shows an error\n \n Scenario: Log in form overlay closes on valid credentials\n     Go to  ${PLONE_URL}/logout\n@@ -180,7 +180,7 @@ Scenario: New user overlay remains on wrong data\n       And I trigger the add a new user action\n      When I send the register form\n      Then overlay should remain open\n-      And overlay shows an error\n+      And overlay requires to compile a field\n \n Scenario: New user overlay closes on valid data\n     Given a logged-in site administrator\n@@ -229,38 +229,44 @@ I click the \'${link_name}\' link\n the \'${link_name}\' overlay\n     Wait until page contains  ${link_name}\n     Click Link  xpath=//a[descendant-or-self::*[contains(text(), \'${link_name}\')]]\n-    Wait until keyword succeeds  30  1  Page should contain element  css=div.plone-modal-dialog\n+    Wait until keyword succeeds  30  1  Page should contain element  css=div.modal-dialog\n \n overlay should open\n-    Wait until keyword succeeds  30  1  Element Should Be Visible  css=div.plone-modal-dialog\n+    Wait until keyword succeeds  30  1  Element Should Be Visible  css=div.modal-dialog\n \n overlay should remain open\n-    Wait until page contains element  css=div.plone-modal-wrapper\n-    Wait until element is visible  css=div.plone-modal-wrapper\n+    Wait until page contains element  css=div.modal-wrapper\n+    Wait until element is visible  css=div.modal-wrapper\n \n I close the overlay\n-    Click Element  css=div.plone-modal-header a.plone-modal-close\n+    Click Element  css=div.modal-header button.modal-close\n \n overlay should close\n-    Wait until keyword succeeds  40  1  Page should not contain element  css=div.plone-modal-dialog\n+    Wait until keyword succeeds  40  1  Page should not contain element  css=div.modal-dialog\n \n-overlay shows an error\n+login overlay shows an error\n     Wait Until Page Contains  Error\n \n+overlay shows an error\n+    Wait Until Page Contains  There were errors\n+\n+overlay requires to compile a field\n+    Wait Until Page Contains  Required input is missing\n+\n I \'${action}\' the form\n-    Wait until keyword succeeds  30  1  Element Should Be Visible  css=div.plone-modal-footer input[name="form.buttons.${action}"]\n-    Click Element  css=div.plone-modal-footer input[name="form.buttons.${action}"]\n+    Wait until keyword succeeds  30  1  Element Should Be Visible  css=div.modal-footer button[name="form.buttons.${action}"]\n+    Click Element  css=div.modal-footer button[name="form.buttons.${action}"]\n \n I enter wrong credentials\n     Input text  __ac_name  wrong\n     Input text  __ac_password  user\n-    Click Button  css=div.plone-modal-footer input\n+    Wait For Then Click Element  css=div.modal-footer button\n \n I enter valid credentials\n     Wait until page contains element  name=__ac_name\n     Input text for sure  __ac_name  ${SITE_OWNER_NAME}\n     Input text for sure  __ac_password  ${SITE_OWNER_PASSWORD}\n-    Click Button  css=div.plone-modal-footer input\n+    Wait For Then Click Element  css=div.modal-footer button\n \n I enter valid user data\n     Wait until page contains element  name=form.widgets.password_ctl\n@@ -275,8 +281,8 @@ I enter valid register user data\n     Input text  form.widgets.email          my@email.eu\n \n I send the register form\n-    Wait until page contains element  css=div.plone-modal-footer #form-buttons-register\n-    Click Element  css=div.plone-modal-footer #form-buttons-register\n+    Wait until page contains element  css=div.modal-footer #form-buttons-register\n+    Click Element  css=div.modal-footer #form-buttons-register\n \n I trigger the add a new user action\n     Click Element  id=add-user\n@@ -301,7 +307,7 @@ a document as the default view of the test folder\n     Wait until element is visible  id=contextSetDefaultPage\n     Click link  id=contextSetDefaultPage\n     Click element  id=doc\n-    Click element  css=div.plone-modal-footer input[name="form.buttons.Save"]\n+    Click element  css=div.modal-footer button[name="form.buttons.Save"]\n \n I change the default content view of the test folder\n     Go to  ${PLONE_URL}/${TEST_FOLDER}\n@@ -317,11 +323,11 @@ I trigger the \'${action}\' action menu item of the test folder\n     Click link  xpath=//li[@id=\'plone-contentmenu-actions\']/a\n     Wait until element is visible  id=plone-contentmenu-actions-${action}\n     Click link  id=plone-contentmenu-actions-${action}\n-    Wait until page contains Element  css=div.plone-modal-dialog\n+    Wait until page contains Element  css=div.modal-dialog\n \n I confirm deletion of the content\n     # Note: The \'delete\' button has no standard z3c.form name attribute\n-    Wait until keyword succeeds  2  2  Click Element  css=div.plone-modal-footer input#form-buttons-Delete\n+    Wait until keyword succeeds  2  2  Click Element  css=div.modal-footer button#form-buttons-Delete\n \n modals loaded\n-    Wait For Condition  return window.jQuery(\'.plone-modal-wrapper\').size() > 0\n+    Wait For Condition  return window.jQuery(\'.modal-wrapper\').size() > 0\ndiff --git a/Products/CMFPlone/tests/robot/test_portlets.robot b/Products/CMFPlone/tests/robot/test_portlets.robot\nindex abfb6ddc21..6167adc91b 100644\n--- a/Products/CMFPlone/tests/robot/test_portlets.robot\n+++ b/Products/CMFPlone/tests/robot/test_portlets.robot\n@@ -28,10 +28,10 @@ a manage portlets view\n     Wait until page contains  Manage portlets\n \n I add a \'${portletname}\' portlet to the left column\n-    Select from list  xpath=//div[@id="portletmanager-plone-leftcolumn"]//select  ${portletname}\n+    Select from list by label  xpath=//div[@id="portletmanager-plone-leftcolumn"]//select  ${portletname}\n \n I add a \'${portletname}\' portlet to the right column\n-    Select from list  xpath=//div[@id="portletmanager-plone-rightcolumn"]//select  ${portletname}\n+    Select from list by label  xpath=//div[@id="portletmanager-plone-rightcolumn"]//select  ${portletname}\n \n I delete a \'${portlet}\'\' portlet from the left column\n     Click Link  xpath=//div[@id="portal-column-one"]//div[@class="portletHeader" and contains(.,"${portlet}")]//a[@class="delete"]  don\'t wait\ndiff --git a/Products/CMFPlone/tests/robot/test_querystring.robot b/Products/CMFPlone/tests/robot/test_querystring.robot\nindex 074d47da20..5a5e66fbf7 100644\n--- a/Products/CMFPlone/tests/robot/test_querystring.robot\n+++ b/Products/CMFPlone/tests/robot/test_querystring.robot\n@@ -72,8 +72,7 @@ Scenario: Searchable text query\n     When I open the criteria Searchable text\n     and I search for a\n     and Sleep  0.2\n-    and Wait Until Element Is Visible  css=div.querystring-preview\n-    and Click Element  css=div.querystring-preview\n+    and Wait For Then Click Element  css=div.querystring-preview\n     Then we expect 2 hits\n     When I open the criteria Searchable text\n     and I search for d\n@@ -86,21 +85,18 @@ Scenario: Tag query one\n     and the querystring pattern\n     When I activate the default operator in the criteria Tag\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-o\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-o\n+    ${base_option_selector}  Set Variable  li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option\n+    and Wait For Then Click Element  css=${base_option_selector}-o\n     Then we expect 4 hits\n     When I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-n\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-n\n+    and Wait For Then Click Element  css=${base_option_selector}-n\n     Then we expect 4 hits\n     When I delete my selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-p\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-p\n+    and Wait For Then Click Element  css=${base_option_selector}-p\n     Then we expect 1 hits\n     When I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-e\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-e\n+    and Wait For Then Click Element  css=${base_option_selector}-e\n     Then we expect 2 hits\n \n Scenario Tag query two\n@@ -110,21 +106,18 @@ Scenario Tag query two\n     and the querystring pattern\n     When I expect an empty result after open the operator Matches all of in the criteria Tag\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-o\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-o\n+    ${base_option_selector}  Set Variable  li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option\n+    and Wait For Then Click Element  css=${base_option_selector}-o\n     Then we expect 4 hits\n     When and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-n\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-n\n+    and Wait For Then Click Element  css=${base_option_selector}-n\n     Then we expect 3 hits\n     When I delete my selection\n     and and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-p\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-p\n+    and Wait For Then Click Element  css=${base_option_selector}-p\n     Then we expect 1 hits\n     When and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-e\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-e\n+    and Wait For Then Click Element  css=${base_option_selector}-e\n     Then we expect 1 hits\n \n \n@@ -134,10 +127,10 @@ Scenario Event end date query\n     and the querystring pattern\n     # Before date\n     When I activate the default operator in the criteria Event end date\n-    and Execute Javascript  $(\'.querystring-criteria-value .pattern-pickadate-date-wrapper > input[type="text"]\').pickadate(\'picker\').set(\'select\', new Date(2018, 7, 1))\n+    and Execute Javascript  $(\'.querystring-criteria-value input[type="date"]\').val(\'2018-07-01\')\n     Then we do not expect any hits\n \n-    # When Execute Javascript  $(\'.querystring-criteria-value .pattern-pickadate-date-wrapper > input[type="text"]\').pickadate(\'picker\').set(\'select\', new Date(2018, 7, 6))\n+    # When Execute Javascript  $(\'.querystring-criteria-value input[type="date"]\').val(\'2018-07-06\')\n \n     # !!! BUG in plone.app.robotframework?\n     # File "~/.buildout/shared-eggs/plone.app.event-3.2.1-py3.6.egg/plone/app/event/recurrence.py", line 77, in occurrences\n@@ -171,8 +164,7 @@ Scenario Review state query\n     and the querystring pattern\n     When I open the criteria Review State\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-private\n-    and Click Element  css=li.select2-option-private\n+    and Wait For Then Click Element  css=li.select2-option-private\n     Then we expect 7 hits\n \n Scenario Type query\n@@ -181,32 +173,26 @@ Scenario Type query\n     and the querystring pattern\n     When I open the criteria Type\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-event\n-    and Click Element  css=li.select2-option-event\n+    and Wait For Then Click Element  css=li.select2-option-event\n     Then we expect 4 hits\n     When I delete one selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-file\n-    and Click Element  css=li.select2-option-file\n+    and Wait For Then Click Element  css=li.select2-option-file\n     Then we do not expect any hits\n     When I delete one selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-folder\n-    and Click Element  css=li.select2-option-folder\n+    and Wait For Then Click Element  css=li.select2-option-folder\n     Then we expect 5 hits\n     When I delete one selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-link\n-    and Click Element  css=li.select2-option-link\n+    and Wait For Then Click Element  css=li.select2-option-link\n     Then we expect 1 hits\n     When I delete one selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-document\n-    and Click Element  css=li.select2-option-document\n+    and Wait For Then Click Element  css=li.select2-option-document\n     Then we expect 2 hits\n     When I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-link\n-    and Click Element  css=li.select2-option-link\n+    and Wait For Then Click Element  css=li.select2-option-link\n     Then we expect 3 hits\n \n Scenario Creator query\n@@ -227,6 +213,8 @@ the querystring pattern\n     Go to  ${PLONE_URL}/a/++add++Collection\n     Wait until page contains element  css=.pat-querystring\n     Given querystring pattern loaded\n+    # Set a title, otherwise you see \'Please fill out this field\'\n+    Execute Javascript  $(\'#form-widgets-IDublinCore-title\').val(\'A Collection\'); return 0;\n     # for some unknown reason unload protection pops up, but only in robot tests\n     Execute Javascript  $(window).unbind(\'beforeunload\')\n \n@@ -245,9 +233,9 @@ a bunch of folders\n \n a bunch of events\n     ${F1}=  a bunch of folders\n-    Create content  type=Event  title=Event1  start=2018-08-01 15:00  end=2018-08-01 17:00  container=${F1}\n-    Create content  type=Event  title=Event2  start=2018-08-05 16:00  end=2018-08-07 11:00  container=${F1}\n-    Create content  type=Event  title=Event3  start=2018-08-05 16:30  open_end-empty-marker=1  container=${F1}\n+    Create content  type=Event  title=Event1  start=2018-08-01T15:00  end=2018-08-01T17:00  container=${F1}\n+    Create content  type=Event  title=Event2  start=2018-08-05T16:00  end=2018-08-07T11:00  container=${F1}\n+    Create content  type=Event  title=Event3  start=2018-08-05T16:30  open_end-empty-marker=1  container=${F1}\n     Create content  type=Event  title=Event4  start=2018-08-06  end=2018-08-06  whole_day-empty-marker=1  container=${F1}\n \n I activate the default operator in the criteria ${CRITERIA}\n@@ -264,7 +252,6 @@ I activate the operator ${OPERATOR} in the criteria ${CRITERIA}\n I expect an empty result after open the operator ${OPERATOR} in the criteria ${CRITERIA}\n     open the select box titled index\n     select index type ${CRITERIA}\n-    sleep  0.75\n     Wait for condition  return $("dl.searchResults").length == 0\n     open the select box titled operator\n     select index type ${OPERATOR}\n@@ -274,60 +261,69 @@ I open the criteria ${CRITERIA}\n     select index type ${CRITERIA}\n \n I search for ${KEYWORD}\n-    Wait Until Element Is Visible  css=input.querystring-criteria-value-StringWidget\n-    Click Element  css=input.querystring-criteria-value-StringWidget\n-    Input Text  css=input.querystring-criteria-value-StringWidget  ${KEYWORD}\n+    ${keyword_selector}  Set Variable  input.querystring-criteria-value-StringWidget\n+    Wait For Then Click Element  css=${keyword_selector}\n+    Input Text  css=${keyword_selector}  ${KEYWORD}\n     Click Element  css=div#content-core\n \n I open the Selection Widget\n-    wait until element is visible  css=div.select2-container-multi.querystring-criteria-value-MultipleSelectionWidget\n-    click element  css=div.select2-container-multi.querystring-criteria-value-MultipleSelectionWidget\n+    Wait For Then Click Element  css=div.select2-container-multi.querystring-criteria-value-MultipleSelectionWidget\n \n I delete one selection\n     #deletes one element\n-    Click Element  css=a.select2-search-choice-close\n+    Wait For Then Click Element  jquery=a.select2-search-choice-close:visible\n \n I delete my selection\n     #deletes two elements\n-    Click Element  css=a.select2-search-choice-close\n-    Click Element  css=a.select2-search-choice-close\n+    Wait For Then Click Element  jquery=a.select2-search-choice-close:visible:first\n+    Sleep  0.1\n+    Wait For Then Click Element  jquery=a.select2-search-choice-close:visible\n \n I search in ${NAME} subfolder in the related items widget\n     mark results\n-    Click Element  css=ul.select2-choices\n+    Wait For Then Click Element  jquery=.pat-relateditems-container ul.select2-choices:visible\n     Wait Until Page Contains  ${NAME}\n-    Click Element  //a[contains(concat(\' \', normalize-space(@class), \' \'), \' pattern-relateditems-result-select \')]//span[contains(text(),\'${NAME}\')]\n+    # I have seen this fail sometimes, where the screen shot showed the NAME just fine.\n+    Sleep  0.1\n+    Click Element  //a[contains(concat(\' \', normalize-space(@class), \' \'), \' pat-relateditems-result-select \')]//span[contains(text(),\'${NAME}\')]\n \n I expect to be in Advanced mode\n     open the select box titled operator\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Navigation Path\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Absolute Path\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Relative Path\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Simple Mode\n-    Click Element  css=div#select2-drop-mask\n-    Wait Until Element Is Not Visible  css=div#select2-drop-mask\n+    ${selector}  Set Variable  .select2-drop-active[style*="display: block;"]\n+    Element Should Contain  jquery=${selector}   Navigation Path\n+    Element Should Contain  jquery=${selector}   Absolute Path\n+    Element Should Contain  jquery=${selector}   Relative Path\n+    Element Should Contain  jquery=${selector}   Simple Mode\n+    ${selector}  Set Variable  div#select2-drop-mask\n+    Wait For Then Click Invisible Element  css=${selector}\n+    Wait Until Element Is Not Visible  css=${selector}\n \n I expect to be in Simple mode\n     open the select box titled operator\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Custom\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Parent (../)\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Current (./)\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Advanced Mode\n-    Click Element  css=div#select2-drop-mask\n-    Wait Until Element Is Not Visible  css=div#select2-drop-mask\n+    ${selector}  Set Variable  .select2-drop-active[style*="display: block;"]\n+    Element Should Contain  jquery=${selector}   Custom\n+    Element Should Contain  jquery=${selector}   Parent (../)\n+    Element Should Contain  jquery=${selector}   Current (./)\n+    Element Should Contain  jquery=${selector}   Advanced Mode\n+    ${selector}  Set Variable  div#select2-drop-mask\n+    Wait For Then Click Invisible Element  css=${selector}\n+    Wait Until Element Is Not Visible  css=${selector}\n \n open the select box titled ${NAME}\n     Click Element  css=body\n-    Click Element  css=.querystring-criteria-${NAME} .select2-container a\n+    Wait For Then Click Element  jquery=.querystring-criteria-${NAME} .select2-container:first\n \n select index type ${INDEX}\n-    Input Text  jquery=.select2-drop-active[style*="display: block;"] input   text=${INDEX}\n-    Press Key  jquery=:focus  \\\\13\n+    ${input_selector}  Set Variable  .select2-drop-active[style*="display: block;"] input\n+    Wait For Element  css=${input_selector}\n+    Input Text  css=${input_selector}   text=${INDEX}\n+    Press Keys  jquery=:focus  RETURN\n \n we expect ${NUM} hits\n     #This assumes we have the 2 "Test document" and "Test folder" items from the\n     #robot setup, as well as the 4 additional items from the "a bunch of folders" macro\n     #works only for ${NUM} > 0\n+    Sleep  0.5s\n     Wait until result is no longer marked\n     ${hits}=  Execute Javascript  return $(\'.searchResults > dd\').length\n     Should Be Equal As Integers  ${hits}  ${NUM}\ndiff --git a/Products/CMFPlone/tests/robot/test_thememapper.robot b/Products/CMFPlone/tests/robot/test_thememapper.robot\ndeleted file mode 100644\nindex 4701ca2e07..0000000000\n--- a/Products/CMFPlone/tests/robot/test_thememapper.robot\n+++ /dev/null\n@@ -1,118 +0,0 @@\n-*** Settings *****************************************************************\n-\n-Resource  plone/app/robotframework/keywords.robot\n-Resource  plone/app/robotframework/saucelabs.robot\n-Resource  plone/app/robotframework/selenium.robot\n-\n-Library  Remote  ${PLONE_URL}/RobotRemote\n-\n-Resource  keywords.robot\n-\n-Test Setup  Run keywords  Plone Test Setup\n-Test Teardown  Run keywords  Plone Test Teardown\n-\n-*** Variables ***\n-\n-${LESS}     @color: blue; body { background: @color; }\n-${LESSFILE}     test.less\n-${CSSFILE}      output.less\n-${CSS}      background: blue;\n-\n-*** Test Cases **************************************************************\n-\n-Scenario: Thememapper basic functionality\n-    Given a logged-in site administrator\n-    and a new theme to edit\n-    When I open rules.xml\n-    Then I expect 2 tabs to be open\n-    and I expect a tab labeled "rules.xml" to be open\n-\n-    When I close the tab labeled "rules.xml"\n-    Then I expect 1 tabs to be open\n-\n-    When I create a new file called "${LESSFILE}"\n-    Then I expect 2 tabs to be open\n-    and I expect a tab labeled "${LESSFILE}" to be open\n-\n-    When I type some code into the editor\n-    and I save the current document\n-    I expect the document ${LESSFILE} to contain ${LESS}\n-\n-Scenario: Thememapper LESS builder\n-    Given a logged-in site administrator\n-    and a new theme to edit\n-    and I create a new file called "${LESSFILE}"\n-    and I type some code into the editor\n-    and I save the current document\n-    When I use the LESS builder on "${LESSFILE}"\n-    Then I expect the compiled CSS to contain "${CSS}"\n-\n-*** Keywords ****************************************************************\n-\n-a new theme to edit\n-    Go to  ${PLONE_URL}/theming-controlpanel\n-    Wait until page contains  Theme settings\n-    Click Element   jquery=a[href="#modal-copy-barceloneta"]\n-    Wait Until Element Is Visible   jquery=.plone-modal-body input[type="text"]\n-    Input Text  jquery=.plone-modal-body input[type="text"]   Test\n-    Click Element   jquery=.plone-modal-body input[type="submit"]\n-    Wait Until Element Is Visible   css=.nav-and-editor\n-    Page Should Contain     backend.xml\n-\n-I open ${NAME}\n-    Click Element   jquery=.jqtree-element:contains("${NAME}")\n-\n-I expect ${NUM} tabs to be open\n-    Sleep  1\n-    ${hits}=    Execute Javascript  return window.jQuery(\'.navbar-nav li\').length.toString();\n-    Should Be Equal     ${hits}     ${NUM}\n-\n-I expect a tab labeled "${LABEL}" to be open\n-    Wait Until Element Is Visible   jquery=.navbar-nav li:contains("${LABEL}")\n-\n-I close the tab labeled "${LABEL}"\n-    Click Element   jquery=.navbar-nav li:contains("${LABEL}") .remove\n-\n-I create a new file called "${NAME}"\n-    Click Element   css=#btngroup-main #btngroup-dropdown-file_menu #dropdown-menu-\n-    Click Element   css=#alink-addnew\n-    Input Text  jquery=.addnew input[type="text"]   ${NAME}\n-    Click Element   jquery=.addnew .btn-primary\n-    Sleep   1\n-\n-I type some code into the editor\n-    Click Element   css=.ace_content\n-    ${ace_id}=     Execute Javascript   return window.jQuery(\'.ace_editor\').attr(\'id\');\n-    Execute Javascript      ace.edit(${ace_id}).setValue("${LESS}");\n-\n-I expect the editors value to be "${MESSAGE}"\n-    ${ace_id}=      Execute Javascript  return window.jQuery(\'.ace_editor\').attr(\'id\');\n-    ${value}=   Execute Javascript      return ace.edit(\'${ace_id}\').getValue();\n-    Should Be Equal     ${value}    ${MESSAGE}\n-\n-I expect the editors value to contain "${MESSAGE}"\n-    ${ace_id}=      Execute Javascript  return window.jQuery(\'.ace_editor\').attr(\'id\');\n-    ${value}=   Execute Javascript      return ace.edit(\'${ace_id}\').getValue();\n-    Should Contain  ${value}    ${MESSAGE}\n-\n-I save the current document\n-    Click Element   css=#btn-save\n-    Sleep   1\n-\n-I expect the document ${NAME} to contain ${MESSAGE}\n-    Go To   ${PLONE_URL}/++theme++test/@@theming-controlpanel-mapper\n-    Wait Until Element Is Visible    css=.ace_editor\n-    I open ${NAME}\n-    I expect the editors value to be "${MESSAGE}"\n-\n-I use the LESS builder on "${file}"\n-    I open ${file}\n-    Click Element   css=#btngroup-mapper #btngroup-dropdown-file_menu #dropdown-menu-\n-    Click Element   css=#alink-buildless\n-    Input Text      css=#lessFileName   ${CSSFILE}\n-    Click element   css=#compileBtn\n-    Sleep   1\n-\n-I expect the compiled CSS to contain "${TEXT}"\n-    I open ${CSSFILE}\n-    I expect the editors value to contain "${TEXT}"\ndiff --git a/Products/CMFPlone/tests/robot/test_tinymce.robot b/Products/CMFPlone/tests/robot/test_tinymce.robot\nindex 5714364366..75eb8d00c7 100644\n--- a/Products/CMFPlone/tests/robot/test_tinymce.robot\n+++ b/Products/CMFPlone/tests/robot/test_tinymce.robot\n@@ -28,13 +28,8 @@ Scenario: A page is opened to edit in TinyMCE\n       and insert link\n       and insert image\n \n-    Click Button  css=#form-buttons-save\n-    # in FF 34 this fails. in FF46 or chrome this is not a problem at all.\n-    # remove "Run Keyword And Ignore Error" when https://github.com/plone/jenkins.plone.org/issues/179\n-    # was solved\n-    Run Keyword And Ignore Error  Element Should Be Visible  css=#parent-fieldname-text img[alt="SomeAlt"]\n-    Run Keyword And Ignore Error  Element Should Be Visible  css=#parent-fieldname-text img[title="SomeTitle"]\n-    Element Should Be Visible  css=#parent-fieldname-text a\n+    Wait For Then Click Element  css=#form-buttons-save\n+    Wait until page contains  Changes saved\n \n \n *** Keywords *****************************************************************\n@@ -50,35 +45,33 @@ an uploaded image\n     Create content  type=Image  title=an-image\n \n text inserted into wysiwyg\n-    Select Frame  css=.mce-edit-area iframe\n+    Wait Until Element Is Visible  css=.tox-edit-area iframe\n+    Select Frame  css=.tox-edit-area iframe\n     Input text  css=.mce-content-body  foobar\n     UnSelect Frame\n \n insert link\n-    Select Frame  css=.mce-edit-area iframe\n+    Select Frame  css=.tox-edit-area iframe\n     Execute Javascript    function selectElementContents(el) {var range = document.createRange(); range.selectNodeContents(el); var sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);} var el = document.getElementById("tinymce"); selectElementContents(el);\n     UnSelect Frame\n-    Click Button  css=div[aria-label="Insert/edit link"] button\n-    Click Button  css=.pattern-relateditems-container button.favorites\n-    Click Link  css=.pattern-relateditems-container .favorites a.fav[href=\'/\']\n-    Wait Until Element Is Visible  css=.pattern-relateditems-result-select.selectable\n-    Click Link  css=.pattern-relateditems-result-select.selectable\n-    Input Text  css=.plone-modal-body [name="title"]  SomeTitle\n-    Click Button  css=.plone-modal-footer .plone-btn-primary\n-    Select Frame  css=.mce-edit-area iframe\n+    Click Button  css=button[aria-label="Insert/edit link"]\n+    Click Button  css=.pat-relateditems-container button.favorites\n+    Click Link  css=.pat-relateditems-container .favorites a.fav[href=\'/\']\n+    Wait Until Element Is Visible  css=.pat-relateditems-result-select.selectable\n+    Click Link  css=.pat-relateditems-result-select.selectable\n+    Click Button  css=.modal-footer input[name="insert"]\n+    Select Frame  css=.tox-edit-area iframe\n     Execute Javascript  window.getSelection().removeAllRanges()\n     UnSelect Frame\n-    Wait Until Element Is Not Visible  css=.plone-modal-footer .plone-btn-primary\n+    Wait Until Element Is Not Visible  css=.modal-footer input[name="insert"]\n \n insert image\n-    Click Button  css=div[aria-label="Insert/edit image"] button\n-    Click Button  css=.pattern-relateditems-container button.favorites\n-    Click Link  css=.pattern-relateditems-container .favorites a.fav[href=\'/\']\n-    Wait Until Element Is Visible  css=.pattern-relateditems-result-select.selectable\n-    Click Link  css=.pattern-relateditems-result-select.selectable\n-    Input Text  css=.plone-modal-body [name="title"]  SomeTitle\n-    Input Text  css=.plone-modal-body [name="alt"]  SomeAlt\n-    Click Button  css=.plone-modal-footer .plone-btn-primary[name=\'insert\']\n-    # in FF 34 we need to click twice. in FF46 or chrome this is not a problem at all.\n-    Run Keyword And Ignore Error  Click Button  css=.plone-modal-footer .plone-btn-primary[name=\'insert\']\n-    Wait Until Element Is Not Visible  css=.plone-modal-footer .plone-btn-primary[name=\'insert\']\n+    Click Button  css=button[aria-label="Insert/edit image"]\n+    Click Button  css=.pat-relateditems-container button.favorites\n+    Click Link  css=.pat-relateditems-container .favorites a.fav[href=\'/\']\n+    Wait Until Element Is Visible  css=.pat-relateditems-result-select.selectable\n+    Click Link  css=.pat-relateditems-result-select.selectable\n+    Input Text  css=.modal-body [name="title"]  SomeTitle\n+    Input Text  css=.modal-body [name="alt"]  SomeAlt\n+    Click Button  css=.modal-footer input[name="insert"]\n+    Wait Until Element Is Not Visible  css=.modal-footer input[name="insert"]\ndiff --git a/Products/CMFPlone/tests/testActionsTool.py b/Products/CMFPlone/tests/testActionsTool.py\nindex 1b304e438b..8bcaed7d3a 100644\n--- a/Products/CMFPlone/tests/testActionsTool.py\n+++ b/Products/CMFPlone/tests/testActionsTool.py\n@@ -64,7 +64,7 @@ def testMissingActionProvider(self):\n             self.fail_tb(\'Should not bomb out if a provider is missing\')\n \n     def testBrokenActionProvider(self):\n-        self.portal.portal_types = None\n+        self.portal.portal_types = self.portal.portal_catalog\n         try:\n             self.actions.listFilteredActionsFor(self.portal)\n         except:\ndiff --git a/Products/CMFPlone/tests/testBatch.py b/Products/CMFPlone/tests/testBatch.py\nindex 5964e2ecfd..f892192e5d 100644\n--- a/Products/CMFPlone/tests/testBatch.py\n+++ b/Products/CMFPlone/tests/testBatch.py\n@@ -1,53 +1,13 @@\n-from Products.CMFPlone.PloneBatch import Batch\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from ZTUtils.Lazy import LazyMap\n \n import unittest\n \n-\n-class TestBatch(unittest.TestCase):\n-\n-    def test_batch_no_lazy(self):\n-        batch = Batch(range(100), size=10, start=10)\n-        self.assertEqual([b for b in batch],\n-                         [10, 11, 12, 13, 14, 15, 16, 17, 18, 19])\n-\n-    def test_batch_lazy_map(self):\n-        def get(key):\n-            return key\n-        sequence = LazyMap(get, range(80, 90), actual_result_count=95)\n-        batch = Batch(sequence, size=10, start=80)\n-        self.assertEqual(\n-            [b for b in batch],\n-            [80, 81, 82, 83, 84, 85, 86, 87, 88, 89])\n-\n-        self.assertEqual(batch.numpages, 10)\n-        self.assertEqual(batch.pagenumber, 9)\n-        self.assertEqual(batch.navlist, range(6, 11))\n-        self.assertEqual(batch.leapback, [])\n-        self.assertEqual(batch.prevlist, range(6, 9))\n-        self.assertEqual(batch.previous.length, 10)\n-        self.assertEqual(batch.next.length, 5)\n-        self.assertEqual(batch.pageurl({}), \'b_start:int=80\')\n-        self.assertListEqual(\n-            list(batch.prevurls({})),\n-            [\n-                (6, \'b_start:int=50\'),\n-                (7, \'b_start:int=60\'),\n-                (8, \'b_start:int=70\'),\n-            ]\n-        )\n-        self.assertListEqual(\n-            list(batch.nexturls({})),\n-            [(10, \'b_start:int=90\')],\n-        )\n-\n-\n class TestBatchIntegration(unittest.TestCase):\n \n     layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n \n     def test_batch_brains(self):\n+        from plone.base.batch import Batch\n         portal = self.layer[\'portal\']\n         obj_ids = [\'%stest\' % chr(c) for c in range(97, 123)]\n         for obj_id in obj_ids:\ndiff --git a/Products/CMFPlone/tests/testBrowserDefault.py b/Products/CMFPlone/tests/testBrowserDefault.py\nindex 3d8bc83e4d..ace5f9a80e 100644\n--- a/Products/CMFPlone/tests/testBrowserDefault.py\n+++ b/Products/CMFPlone/tests/testBrowserDefault.py\n@@ -9,8 +9,7 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from Products.CMFPlone.utils import _createObjectByType\n-from Products.CMFPlone.utils import safe_nativestring\n-from Products.CMFPlone.PloneFolder import ReplaceableWrapper\n+from plone.base.utils import safe_text\n from zope.component import getUtility\n \n import difflib\n@@ -80,8 +79,8 @@ def compareLayoutVsView(self, obj, path="", viewaction=None):\n         transaction.commit()\n \n         self.browser.open(obj.absolute_url() + path)\n-        body = safe_nativestring(self.browser.contents)\n-        resolved = safe_nativestring(resolved)\n+        body = safe_text(self.browser.contents)\n+        resolved = safe_text(resolved)\n \n         # request/ACTUAL_URL is fubar in tests, remove lines that depend on it\n         resolved = RE_REMOVE_DOCCONT.sub(\'\', resolved)\n@@ -166,7 +165,7 @@ def testBrowserDefaultMixinFileDumpsContent(self):\n         data = self.portal.file.file.data\n         self.assertEqual(self.browser.contents.encode(\'utf8\'), data)\n \n-    # Ensure index_html acquisition and replaceablewrapper\n+    # Ensure index_html acquisition\n \n     def testIndexHtmlNotAcquired(self):\n         self.portal.folder.invokeFactory(\'Document\', \'index_html\')\n@@ -177,12 +176,6 @@ def testIndexHtmlNotAcquired(self):\n             (self.portal.folder.subfolder, [layout])\n         )\n \n-    def testIndexHtmlReplaceableWrapper(self):\n-        self.portal.document.index_html = ReplaceableWrapper(None)\n-        layout = self.portal.document.getLayout()\n-        self.assertEqual(self.putils.browserDefault(self.portal.document),\n-                         (self.portal.document, [layout]))\n-\n     # Test behaviour of __call__\n \n     def testCallDocumentGivesTemplate(self):\n@@ -278,10 +271,10 @@ def testCall(self):\n         self.assertFalseDiff(resolved, target)\n \n     def testDefaultViews(self):\n-        self.assertEqual(self.portal.getLayout(), \'listing_view\')\n+        self.assertEqual(self.portal.getLayout(), \'document_view\')\n         self.assertEqual(self.portal.getDefaultPage(), \'front-page\')\n         self.assertEqual(self.portal.defaultView(), \'front-page\')\n-        self.assertEqual(self.portal.getDefaultLayout(), \'listing_view\')\n+        self.assertEqual(self.portal.getDefaultLayout(), \'document_view\')\n         layoutKeys = [v[0] for v in self.portal.getAvailableLayouts()]\n         self.assertTrue(\'listing_view\' in layoutKeys)\n         self.assertEqual(self.portal.__browser_default__(None),\n@@ -297,7 +290,7 @@ def testSetLayout(self):\n         self.assertEqual(self.portal.getLayout(), \'summary_view\')\n         self.assertEqual(self.portal.getDefaultPage(), None)\n         self.assertEqual(self.portal.defaultView(), \'summary_view\')\n-        self.assertEqual(self.portal.getDefaultLayout(), \'listing_view\')\n+        self.assertEqual(self.portal.getDefaultLayout(), \'document_view\')\n         layoutKeys = [v[0] for v in self.portal.getAvailableLayouts()]\n         self.assertTrue(\'summary_view\' in layoutKeys)\n \n@@ -327,8 +320,8 @@ def testSetDefaultPage(self):\n                          (self.portal, [\'ad\', ]))\n \n         # still have layout settings\n-        self.assertEqual(self.portal.getLayout(), \'listing_view\')\n-        self.assertEqual(self.portal.getDefaultLayout(), \'listing_view\')\n+        self.assertEqual(self.portal.getLayout(), \'document_view\')\n+        self.assertEqual(self.portal.getDefaultLayout(), \'document_view\')\n         layoutKeys = [v[0] for v in self.portal.getAvailableLayouts()]\n         self.assertTrue(\'listing_view\' in layoutKeys)\n \n@@ -373,13 +366,13 @@ def testSetLayoutUnsetsDefaultPage(self):\n \n     def testMissingTemplatesIgnored(self):\n         self.portal.getTypeInfo() \\\n-            .manage_changeProperties(view_methods=[\'listing_view\', \'foo\'])\n+            .manage_changeProperties(view_methods=[\'document_view\', \'foo\'])\n         views = [v[0] for v in self.portal.getAvailableLayouts()]\n-        self.assertTrue(views == [\'listing_view\'])\n+        self.assertTrue(views == [\'document_view\'])\n \n     def testMissingPageIgnored(self):\n         self.portal.setDefaultPage(\'inexistent\')\n         self.assertEqual(self.portal.getDefaultPage(), None)\n-        self.assertEqual(self.portal.defaultView(), \'listing_view\')\n+        self.assertEqual(self.portal.defaultView(), \'document_view\')\n         self.assertEqual(self.portal.__browser_default__(None),\n-                         (self.portal, [\'listing_view\', ]))\n+                         (self.portal, [\'document_view\', ]))\ndiff --git a/Products/CMFPlone/tests/testCSSandJSRegistry.py b/Products/CMFPlone/tests/testCSSandJSRegistry.py\ndeleted file mode 100644\nindex cf8ee57a78..0000000000\n--- a/Products/CMFPlone/tests/testCSSandJSRegistry.py\n+++ /dev/null\n@@ -1,73 +0,0 @@\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import IBundleRegistry\n-from Products.CMFPlone.interfaces import IResourceRegistry\n-from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n-from zope.component import getUtility\n-\n-\n-class TestCSSRegistry(PloneTestCase):\n-\n-    def afterSetUp(self):\n-        self.registry = getUtility(IRegistry)\n-\n-    def testDefaultCssIsInstalled(self):\n-        installedResources = self.registry.collectionOfInterface(\n-            IResourceRegistry,\n-            prefix=\'plone.resources\'\n-        )\n-        expected = [\n-            \'++plone++static/plone.less\',\n-        ]\n-        css_files = [y for x in installedResources.values() for y in x.css]\n-        for e in expected:\n-            self.assertTrue(e in css_files, e)\n-\n-    def testBundleIsInstalled(self):\n-        installedBundles = self.registry.collectionOfInterface(\n-            IBundleRegistry, prefix=\'plone.bundles\')\n-        expected = [\n-            \'plone\',\n-            \'plone-legacy\'\n-        ]\n-        for e in expected:\n-            self.assertTrue(e in installedBundles.keys(), e)\n-\n-    # def testRTLShouldHaveHigherPrecedence(self):\n-    #     installedStylesheetIds = self.tool.getResourceIds()\n-    #     indexRTLStylesheet = self.tool.getResourcePosition(\'RTL.css\')\n-    #     comes_before = [\'++resource++plone.css\']\n-    #     for cb in comes_before:\n-    #         self.assertTrue(\n-    #             cb in installedStylesheetIds[:indexRTLStylesheet],\n-    #             cb\n-    #         )\n-\n-    def testJSIsInsertedInPage(self):\n-        self.registry[\'plone.resources.development\'] = True\n-        self.registry[\'plone.bundles/plone.develop_css\'] = True\n-        page = self.portal.view()\n-        self.assertTrue(\'++plone++static/plone.less\' in page)\n-\n-\n-class TestJSRegistry(PloneTestCase):\n-\n-    def afterSetUp(self):\n-        self.registry = getUtility(IRegistry)\n-\n-    def testDefaultJSIsInstalled(self):\n-        installedResources = self.registry.collectionOfInterface(\n-            IResourceRegistry,\n-            prefix=\'plone.resources\'\n-        )\n-        expected = [\n-            \'++resource++plone.js\',\n-        ]\n-        js_files = {x.js for x in installedResources.values()}\n-        for e in expected:\n-            self.assertTrue(e in js_files, e)\n-\n-    def testJSIsInsertedInPage(self):\n-        self.registry[\'plone.resources.development\'] = True\n-        self.registry[\'plone.bundles/plone.develop_javascript\'] = True\n-        page = self.portal.view()\n-        self.assertTrue(\'++resource++plone.js\' in page)\ndiff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py\nindex 87cb05456b..50ab21231a 100644\n--- a/Products/CMFPlone/tests/testCatalogTool.py\n+++ b/Products/CMFPlone/tests/testCatalogTool.py\n@@ -31,7 +31,7 @@\n group2 = \'g2\'\n \n base_content = [\'Members\', \'aggregator\', \'aggregator\',\n-                \'events\', \'news\', TEST_USER_ID, \'front-page\', \'doc\']\n+                \'events\', \'news\', \'plone\', TEST_USER_ID, \'doc\']\n \n \n class TestCatalogSetup(PloneTestCase):\ndiff --git a/Products/CMFPlone/tests/testCheckId.py b/Products/CMFPlone/tests/testCheckId.py\nindex 9ca7796556..89017a733b 100644\n--- a/Products/CMFPlone/tests/testCheckId.py\n+++ b/Products/CMFPlone/tests/testCheckId.py\n@@ -6,45 +6,6 @@\n from ZODB.POSException import ConflictError\n \n \n-class TestIsIDAutoGenerated(PloneTestCase):\n-\n-    def testAutoGeneratedId(self):\n-        plone_utils = getToolByName(self.portal, \'plone_utils\')\n-        r = plone_utils.isIDAutoGenerated(\'document.2004-11-09.0123456789\')\n-        self.assertEqual(r, True)\n-\n-    def testAutoGeneratedIdWithUnderScores(self):\n-        plone_utils = getToolByName(self.portal, \'plone_utils\')\n-        portal_types = getToolByName(self.portal, \'portal_types\')\n-        portal_types.test_type = self.portal.portal_types.Event\n-        portal_types.test_type.id = "test_type"\n-\n-        r = plone_utils.isIDAutoGenerated(\'test_type.2004-11-09.0123456789\')\n-\n-        del portal_types.test_type\n-\n-        self.assertEqual(r, True)\n-\n-    def testEmptyId(self):\n-        plone_utils = getToolByName(self.portal, \'plone_utils\')\n-        r = plone_utils.isIDAutoGenerated(\'\')\n-        self.assertEqual(r, False)\n-\n-    def testValidPortalTypeNameButNotAutoGeneratedId(self):\n-        plone_utils = getToolByName(self.portal, \'plone_utils\')\n-        # This was raising an IndexError exception for\n-        # Zope < 2.7.3 (DateTime.py < 1.85.12.11) and a\n-        # SyntaxError for Zope >= 2.7.3 (DateTime.py >= 1.85.12.11)\n-        r = plone_utils.isIDAutoGenerated(\'document.tar.gz\')\n-        self.assertEqual(r, False)\n-        # check DateError\n-        r = plone_utils.isIDAutoGenerated(\'document.tar.12/32/2004\')\n-        self.assertEqual(r, False)\n-        # check TimeError\n-        r = plone_utils.isIDAutoGenerated(\'document.tar.12/31/2004 12:62\')\n-        self.assertEqual(r, False)\n-\n-\n class TestCheckId(PloneTestCase):\n \n     def testGoodId(self):\ndiff --git a/Products/CMFPlone/tests/testContentPublishing.py b/Products/CMFPlone/tests/testContentPublishing.py\ndeleted file mode 100644\nindex ab11407398..0000000000\n--- a/Products/CMFPlone/tests/testContentPublishing.py\n+++ /dev/null\n@@ -1,108 +0,0 @@\n-# Tests security of content publishing operations\n-# code inspired by Ween\n-\n-from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n-from Products.CMFPlone.utils import isExpired\n-\n-text = """I lick my brain in silence\n-Rather squeeze my head instead\n-Midget man provoking violence\n-Listen not to what I said\n-\n-I said please calm it down\n-Everything is turning brown\n-\n-Mutilated lips give a kiss on the wrist\n-Of the worm like tips of tentacles expanding\n-In my mind, I\'m fine, accepting only fresh brine\n-You can get another drop of this, yeah you wish...\n-[repeat]\n-\n-Laughing lady living lover\n-Ooo you sassy frassy lassie\n-Find me the skull of Haile Sellase, I...\n-Give me shoes so I can tapsy\n-Tap all over this big world\n-Take my hand you ugly girl """\n-\n-props = {\'description\': \'song by ween\',\n-         \'contributors\': [\'dean ween\', \'gene ween\'],\n-         \'effective_date\': \'2004-01-12\',\n-         \'expiration_date\': \'2004-12-12\',\n-         \'format\': \'text/plain\',\n-         \'language\': \'english\',\n-         \'rights\': \'ween music\',\n-         \'title\': \'mutalitated lips\',\n-         \'subject\': [\'psychedelic\', \'pop\', \'13th floor elevators\']}\n-\n-\n-class TestContentPublishing(PloneTestCase):\n-    """ The instant publishing drop down UI.\n-\n-        This testcase was written to prevent collector/2914 regressions\n-\n-        In addition, some more general tests of content_status_modify\n-        have been added, since this seems a logical place to keep them.\n-    """\n-\n-    def afterSetUp(self):\n-        self.portal.acl_users._doAddUser(\'user1\', \'secret\', [\'Member\'], [])\n-        self.membership = self.portal.portal_membership\n-        self.createMemberarea(\'user1\')\n-        self.workflow = self.portal.portal_workflow\n-        self.setupAuthenticator()\n-\n-    # Test the recursive behaviour of content_status_modify:\n-\n-    def testPublishingNonDefaultPageLeavesFolderAlone(self):\n-        self.setRoles([\'Manager\'])  # Make sure we can publish directly\n-        self.folder.invokeFactory(\'Document\', id=\'d1\', title=\'Doc 1\')\n-        self.folder.d1.content_status_modify(\'publish\')\n-        self.assertEqual(self.workflow.getInfoFor(self.folder, \'review_state\'),\n-                         \'visible\')\n-        self.assertEqual(\n-            self.workflow.getInfoFor(self.folder.d1, \'review_state\'),\n-            \'published\')\n-\n-    def testPublishingDefaultPagePublishesFolder(self):\n-        self.setRoles([\'Manager\'])  # Make sure we can publish directly\n-        self.folder.invokeFactory(\'Document\', id=\'d1\', title=\'Doc 1\')\n-        self.folder.setDefaultPage(\'d1\')\n-        self.folder.d1.content_status_modify(\'publish\')\n-        self.assertEqual(self.workflow.getInfoFor(self.folder, \'review_state\'),\n-                         \'published\')\n-        self.assertEqual(\n-            self.workflow.getInfoFor(self.folder.d1, \'review_state\'),\n-            \'published\')\n-\n-    def testPublishingDefaultPageWhenFolderCannotBePublished(self):\n-        self.setRoles([\'Manager\'])  # Make sure we can publish directly\n-        self.folder.invokeFactory(\'Document\', id=\'d1\', title=\'Doc 1\')\n-        self.folder.setDefaultPage(\'d1\')\n-        # make parent be published already when publishing its default document\n-        # results in an attempt to do it again\n-        self.folder.content_status_modify(\'publish\')\n-        self.assertEqual(self.workflow.getInfoFor(self.folder, \'review_state\'),\n-                         \'published\')\n-        self.folder.d1.content_status_modify(\'publish\')\n-        self.assertEqual(self.workflow.getInfoFor(self.folder, \'review_state\'),\n-                         \'published\')\n-        self.assertEqual(\n-            self.workflow.getInfoFor(self.folder.d1, \'review_state\'),\n-            \'published\')\n-\n-    # test setting effective/expiration date and isExpired method\n-\n-    def testIsExpiredWithExplicitExpiredContent(self):\n-        self.setRoles([\'Manager\'])\n-        self.folder.invokeFactory(\'Document\', id=\'d1\', title=\'Doc 1\')\n-        self.folder.d1.content_status_modify(workflow_action=\'publish\',\n-                                             effective_date=\'1/1/2001\',\n-                                             expiration_date=\'1/2/2001\')\n-        self.assertTrue(isExpired(self.folder.d1))\n-\n-    def testIsExpiredWithExplicitNonExpiredContent(self):\n-        self.setRoles([\'Manager\'])\n-        self.folder.invokeFactory(\'Document\', id=\'d1\', title=\'Doc 1\')\n-        self.folder.d1.content_status_modify(workflow_action=\'publish\')\n-        self.assertFalse(isExpired(self.folder.d1))\ndiff --git a/Products/CMFPlone/tests/testContentSecurity.py b/Products/CMFPlone/tests/testContentSecurity.py\nindex a5c8b86eab..5d8945cd30 100644\n--- a/Products/CMFPlone/tests/testContentSecurity.py\n+++ b/Products/CMFPlone/tests/testContentSecurity.py\n@@ -2,10 +2,13 @@\n from Acquisition import aq_base\n from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n from zExceptions.unauthorized import Unauthorized as zUnauthorized\n+from zope.component import getMultiAdapter\n+\n \n class TestContentSecurity(PloneTestCase):\n \n     def afterSetUp(self):\n+        self.request = self.layer["request"]\n         self.portal.acl_users._doAddUser(\'user1\', \'secret\', [\'Member\'], [])\n         self.portal.acl_users._doAddUser(\'user2\', \'secret\', [\'Member\'], [])\n         #_ender_\'s member who\'s not a Member usecase\n@@ -15,6 +18,16 @@ def afterSetUp(self):\n         self.createMemberarea(\'user1\')\n         self.createMemberarea(\'user2\')\n \n+    def setup_authenticator(self):\n+        from plone.protect.authenticator import createToken\n+\n+        self.request.form["_authenticator"] = createToken()\n+\n+    def get_content_status_modify_view(self, obj):\n+        self.setup_authenticator()\n+        view = getMultiAdapter((obj, self.request), name="content_status_modify")\n+        return view\n+\n     def testCreateMemberContent(self):\n         self.login(\'user1\')\n         folder = self.membership.getHomeFolder(\'user1\')\n@@ -108,7 +121,8 @@ def testViewAllowedOnContentInAcquisitionBlockedFolder(self):\n         subfolder.unrestrictedTraverse(\'@@sharing\').update_inherit(False)\n         # Turn off local role acquisition\n         subfolder.invokeFactory(\'Document\', id=\'new\')\n-        subfolder.new.content_status_modify(workflow_action=\'publish\')\n+        view = self.get_content_status_modify_view(subfolder.new)\n+        view(workflow_action=\'publish\')\n         subfolder.new.manage_addLocalRoles(\'user2\', (\'Member\',))\n         self.login(\'user2\')\n         # This should not raise Unauthorized\n@@ -117,10 +131,12 @@ def testViewAllowedOnContentInAcquisitionBlockedFolder(self):\n     def testViewAllowedOnContentInPrivateFolder(self):\n         self.login(\'user1\')\n         folder = self.membership.getHomeFolder(\'user1\')\n-        folder.content_status_modify(workflow_action=\'private\')\n+        view = self.get_content_status_modify_view(folder)\n+        view(workflow_action=\'private\')\n         folder.invokeFactory(\'Document\', id=\'doc1\')\n         doc = folder.doc1\n-        doc.content_status_modify(workflow_action=\'publish\')\n+        view = self.get_content_status_modify_view(doc)\n+        view(workflow_action=\'publish\')\n         doc.manage_addLocalRoles(\'user2\', (\'Owner\',))\n         self.login(\'user2\')\n         # This should not raise Unauthorized\n@@ -160,7 +176,8 @@ def testViewAllowedOnContentInAcquisitionBlockedFolderWithCustomWorkflow(self):\n         subfolder = folder.subfolder\n         subfolder.unrestrictedTraverse(\'@@sharing\').update_inherit(False)\n         subfolder.invokeFactory(\'Document\', id=\'new\')\n-        subfolder.new.content_status_modify(workflow_action=\'publish\')\n+        view = self.get_content_status_modify_view(subfolder.new)\n+        view(workflow_action=\'publish\')\n         subfolder.new.manage_addLocalRoles(\'user3\', (\'Member\',))\n         self.login(\'user3\')\n         # This shouldn\'t either, but strangely it never does even if the script\ndiff --git a/Products/CMFPlone/tests/testContentTypeScripts.py b/Products/CMFPlone/tests/testContentTypeScripts.py\nindex 325238d92a..0a0b5207c6 100644\n--- a/Products/CMFPlone/tests/testContentTypeScripts.py\n+++ b/Products/CMFPlone/tests/testContentTypeScripts.py\n@@ -5,72 +5,74 @@\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.tests import dummy\n \n-AddPortalTopics = \'Add portal topics\'\n+AddPortalTopics = "Add portal topics"\n \n \n class TestContentTypeScripts(PloneTestCase.PloneTestCase):\n-\n     def afterSetUp(self):\n-        perms = self.getPermissionsOfRole(\'Member\')\n-        self.setPermissions(perms + [AddPortalTopics], \'Member\')\n+        perms = self.getPermissionsOfRole("Member")\n+        self.setPermissions(perms + [AddPortalTopics], "Member")\n         self.request = self.app.REQUEST\n \n     def getPermissionsOfRole(self, role):\n         perms = self.portal.permissionsOfRole(role)\n-        return [p[\'name\'] for p in perms if p[\'selected\']]\n+        return [p["name"] for p in perms if p["selected"]]\n \n     def testDocumentCreate(self):\n-        self.folder.invokeFactory(\n-            \'Document\', id=\'doc\', text=RichTextValue(\'data\'))\n-        self.assertEqual(self.folder.doc.text.raw, \'data\')\n-        self.assertEqual(self.folder.doc.Format(), \'text/html\')\n+        self.folder.invokeFactory("Document", id="doc", text=RichTextValue("data"))\n+        self.assertEqual(self.folder.doc.text.raw, "data")\n+        self.assertEqual(self.folder.doc.Format(), "text/html")\n \n     def testEventCreate(self):\n-        self.folder.invokeFactory(\'Event\', id=\'event\',\n-                                  title=\'Foo\',\n-                                  start=datetime(year=2003, month=9, day=18),\n-                                  end=datetime(year=2003, month=9, day=19))\n-        self.assertEqual(self.folder.event.Title(), \'Foo\')\n-        self.assertTrue(self.folder.event.start.isoformat()\n-                            .startswith(\'2003-09-18T00:00:00\'))\n-        self.assertTrue(self.folder.event.end.isoformat()\n-                            .startswith(\'2003-09-19T00:00:00\'))\n+        self.folder.invokeFactory(\n+            "Event",\n+            id="event",\n+            title="Foo",\n+            start=datetime(year=2003, month=9, day=18),\n+            end=datetime(year=2003, month=9, day=19),\n+        )\n+        self.assertEqual(self.folder.event.Title(), "Foo")\n+        self.assertTrue(\n+            self.folder.event.start.isoformat().startswith("2003-09-18T00:00:00")\n+        )\n+        self.assertTrue(\n+            self.folder.event.end.isoformat().startswith("2003-09-19T00:00:00")\n+        )\n \n     def testFileCreate(self):\n-        self.folder.invokeFactory(\n-            \'File\', id=\'file\', file=NamedFile(dummy.File()))\n+        self.folder.invokeFactory("File", id="file", file=NamedFile(dummy.File()))\n         self.assertEqual(self.folder.file.file.data, dummy.TEXT)\n \n     def testImageCreate(self):\n-        self.folder.invokeFactory(\n-            \'Image\', id=\'image\', image=NamedImage(dummy.Image()))\n+        self.folder.invokeFactory("Image", id="image", image=NamedImage(dummy.Image()))\n         self.assertEqual(self.folder.image.image.data, dummy.GIF)\n \n     def testFolderCreate(self):\n-        self.folder.invokeFactory(\'Folder\', id=\'folder\', title=\'Foo\',\n-                                  description=\'Bar\')\n-        self.assertEqual(self.folder.folder.Title(), \'Foo\')\n-        self.assertEqual(self.folder.folder.Description(), \'Bar\')\n+        self.folder.invokeFactory("Folder", id="folder", title="Foo", description="Bar")\n+        self.assertEqual(self.folder.folder.Title(), "Foo")\n+        self.assertEqual(self.folder.folder.Description(), "Bar")\n \n     def testLinkCreate(self):\n-        self.folder.invokeFactory(\'Link\', id=\'link\',\n-                                  remoteUrl=\'http://foo.com\', title=\'Foo\')\n-        self.assertEqual(self.folder.link.Title(), \'Foo\')\n-        self.assertEqual(self.folder.link.remoteUrl, \'http://foo.com\')\n+        self.folder.invokeFactory(\n+            "Link", id="link", remoteUrl="http://foo.com", title="Foo"\n+        )\n+        self.assertEqual(self.folder.link.Title(), "Foo")\n+        self.assertEqual(self.folder.link.remoteUrl, "http://foo.com")\n \n     def testNewsItemCreate(self):\n-        self.folder.invokeFactory(\'News Item\', id=\'newsitem\',\n-                                  text=RichTextValue(\'data\'), title=\'Foo\')\n-        self.assertEqual(self.folder.newsitem.text.raw, \'data\')\n-        self.assertEqual(self.folder.newsitem.Title(), \'Foo\')\n+        self.folder.invokeFactory(\n+            "News Item", id="newsitem", text=RichTextValue("data"), title="Foo"\n+        )\n+        self.assertEqual(self.folder.newsitem.text.raw, "data")\n+        self.assertEqual(self.folder.newsitem.Title(), "Foo")\n \n     # Bug tests\n \n     def test_listMetaTypes(self):\n-        self.folder.invokeFactory(\'Document\', id=\'doc\')\n+        self.folder.invokeFactory("Document", id="doc")\n         tool = self.portal.plone_utils\n         doc = self.folder.doc\n-        doc.setTitle(\'title\')\n+        doc.setTitle("title")\n         tool.listMetaTags(doc)\n         # TODO: atm it checks only of the script can be called w/o an error\n \n@@ -81,15 +83,12 @@ class TestFileURL(PloneTestCase.PloneTestCase):\n     # NOTABUG: This is how urlparse.urlparse() works.\n \n     def testFileURLWithHost(self):\n-        self.folder.invokeFactory(\'Link\', id=\'link\',\n-                                  remoteUrl=\'file://foo.com/baz.txt\')\n-        self.assertEqual(self.folder.link.remoteUrl,\n-                         \'file://foo.com/baz.txt\')\n+        self.folder.invokeFactory("Link", id="link", remoteUrl="file://foo.com/baz.txt")\n+        self.assertEqual(self.folder.link.remoteUrl, "file://foo.com/baz.txt")\n \n     def testFileURLNoHost(self):\n-        self.folder.invokeFactory(\'Link\', id=\'link\',\n-                                  remoteUrl=\'file:///foo.txt\')\n-        self.assertEqual(self.folder.link.remoteUrl, \'file:///foo.txt\')\n+        self.folder.invokeFactory("Link", id="link", remoteUrl="file:///foo.txt")\n+        self.assertEqual(self.folder.link.remoteUrl, "file:///foo.txt")\n \n     # DX does not pass url trough urlparse/urlunparse like setRemoteUrl does.\n     # def testFileURLFourSlash(self):\n@@ -115,17 +114,13 @@ def testFileURLNoHost(self):\n \n \n class TestImageProps(PloneTestCase.PloneTestCase):\n-\n     def testImageComputedProps(self):\n         from OFS.Image import Image\n+\n         tag = Image.tag\n-        kw = {\'_title\': \'some title\',\n-              \'_alt\': \'alt tag\',\n-              \'height\': 100,\n-              \'width\': 100}\n+        kw = {"_title": "some title", "_alt": "alt tag", "height": 100, "width": 100}\n         # Wrap object so that ComputedAttribute gets executed.\n         self.ob = dummy.ImageComputedProps(**kw).__of__(self.folder)\n \n-        endswith = (\'alt="alt tag" title="some title" \'\n-                    \'height="100" width="100" />\')\n-        self.assertEqual(tag(self.ob)[-len(endswith):], endswith)\n+        endswith = \'alt="alt tag" title="some title" \' \'height="100" width="100" />\'\n+        self.assertEqual(tag(self.ob)[-len(endswith) :], endswith)\ndiff --git a/Products/CMFPlone/tests/testControlPanel.py b/Products/CMFPlone/tests/testControlPanel.py\nindex 159e1ee627..0ce80c7acf 100644\n--- a/Products/CMFPlone/tests/testControlPanel.py\n+++ b/Products/CMFPlone/tests/testControlPanel.py\n@@ -13,8 +13,8 @@ def setUp(self):\n         # get the expected default groups and configlets\n         self.groups = [\'Plone\', \'Products\']\n         self.configlets = [\'QuickInstaller\', \'MailHost\',\n-                           \'UsersGroups\', \'MemberPrefs\', \'PortalSkin\',\n-                           \'MemberPassword\', \'ZMI\', \'SecuritySettings\',\n+                           \'UsersGroups\', \'PortalSkin\',\n+                           \'ZMI\', \'SecuritySettings\',\n                            \'NavigationSettings\', \'SearchSettings\',\n                            \'errorLog\', \'PloneReconfig\', \'TypesSettings\',\n                            \'FilterSettings\',\ndiff --git a/Products/CMFPlone/tests/testControlPanelScripts.py b/Products/CMFPlone/tests/testControlPanelScripts.py\nindex e0428af4cb..d37e54f2ef 100644\n--- a/Products/CMFPlone/tests/testControlPanelScripts.py\n+++ b/Products/CMFPlone/tests/testControlPanelScripts.py\n@@ -1,35 +1,7 @@\n-from DateTime import DateTime\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n-from plone.app.testing import TEST_USER_NAME\n-from plone.app.testing import TEST_USER_PASSWORD\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n-from zExceptions import Forbidden\n-\n-import unittest\n-\n-\n-class TestPrefsUserManage(unittest.TestCase):\n-\n-    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-\n-    def setUp(self):\n-        self.portal = self.layer[\'portal\']\n-        self.membership = self.portal.portal_membership\n-        self.membership.memberareaCreationFlag = 0\n-        # self.setupAuthenticator()\n-\n-    def test_ploneChangePasswordPostOnly(self):\n-        # self.login(TEST_USER_NAME)\n-        self.layer[\'request\'].method = \'GET\'\n-        with self.assertRaises(Forbidden):\n-            self.portal.plone_change_password(\n-                current=TEST_USER_PASSWORD,\n-                password=TEST_USER_PASSWORD,\n-                password_confirm=TEST_USER_PASSWORD,\n-            )\n \n \n class TestAccessControlPanelScripts(PloneTestCase):\ndiff --git a/Products/CMFPlone/tests/testCookieAuth.py b/Products/CMFPlone/tests/testCookieAuth.py\nindex 4b6e8a8c0b..98071cc2be 100644\n--- a/Products/CMFPlone/tests/testCookieAuth.py\n+++ b/Products/CMFPlone/tests/testCookieAuth.py\n@@ -31,7 +31,7 @@ def testAutoLoginPage(self):\n         self.assertIn(\'200\', self.browser.headers[\'status\'])\n         self.assertEqual(\n             self.browser.url,\n-            \'http://nohost/plone/login?came_from=http%3A//nohost/plone/test-folder\'  # noqa: E501\n+            \'http://nohost/plone/login?came_from=/plone/test-folder\'  # noqa: E501\n         )\n \n     def testInsufficientPrivileges(self):\n@@ -42,7 +42,7 @@ def testInsufficientPrivileges(self):\n         self.assertIn(\'200\', self.browser.headers[\'status\'])\n         self.assertEqual(\n             self.browser.url,\n-            \'http://nohost/plone/login?came_from=http%3A//nohost/plone/test-folder\'  # noqa: E501\n+            \'http://nohost/plone/login?came_from=/plone/test-folder\'  # noqa: E501\n         )\n \n     def testSetSessionCookie(self):\ndiff --git a/Products/CMFPlone/tests/testEmailLogin.py b/Products/CMFPlone/tests/testEmailLogin.py\nindex b603237a4a..075b3bc6b8 100644\n--- a/Products/CMFPlone/tests/testEmailLogin.py\n+++ b/Products/CMFPlone/tests/testEmailLogin.py\n@@ -2,7 +2,7 @@\n from plone.app.testing import SITE_OWNER_NAME\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISecuritySchema\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.utils import set_own_login_name\n from Products.CMFPlone.RegistrationTool import get_member_by_login_name\ndiff --git a/Products/CMFPlone/tests/testIImagingSchema.py b/Products/CMFPlone/tests/testIImagingSchema.py\nindex 3f42d990d8..20b302c059 100644\n--- a/Products/CMFPlone/tests/testIImagingSchema.py\n+++ b/Products/CMFPlone/tests/testIImagingSchema.py\n@@ -1,6 +1,6 @@\n from plone.app.testing import PLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces.controlpanel import IImagingSchema\n+from plone.base.interfaces.controlpanel import IImagingSchema\n from zope.component import getUtility\n \n import unittest\ndiff --git a/Products/CMFPlone/tests/testInterfaces.py b/Products/CMFPlone/tests/testInterfaces.py\nindex e8ffa50302..833ef3b456 100644\n--- a/Products/CMFPlone/tests/testInterfaces.py\n+++ b/Products/CMFPlone/tests/testInterfaces.py\n@@ -4,9 +4,6 @@\n from Products.CMFPlone.MigrationTool import MigrationTool\n from Products.CMFPlone.PloneControlPanel import PloneConfiglet\n from Products.CMFPlone.PloneControlPanel import PloneControlPanel\n-from Products.CMFPlone.PloneFolder import BasePloneFolder\n-from Products.CMFPlone.PloneFolder import OrderedContainer\n-from Products.CMFPlone.PloneFolder import PloneFolder\n from Products.CMFPlone.PloneTool import PloneTool\n from Products.CMFPlone.Portal import PloneSite\n from Products.CMFPlone.PropertiesTool import PropertiesTool\n@@ -261,7 +258,6 @@ def _testStuff(self):\n     (CatalogTool, ()),\n     (MigrationTool, ()),\n     (PloneControlPanel, ()), (PloneConfiglet, ()),\n-    (OrderedContainer, ()), (BasePloneFolder, ()), (PloneFolder, ()),\n     (PloneTool, ()),\n     (PloneSite, ()),\n     (PropertiesTool, ()), (SimpleItemWithProperties, ()),\ndiff --git a/Products/CMFPlone/tests/testNavTree.py b/Products/CMFPlone/tests/testNavTree.py\nindex 4003b842bc..efd469252c 100644\n--- a/Products/CMFPlone/tests/testNavTree.py\n+++ b/Products/CMFPlone/tests/testNavTree.py\n@@ -1,26 +1,21 @@\n-from Products.CMFPlone.tests import PloneTestCase\n-\n-from Products.CMFCore.utils import getToolByName\n-\n from plone.app.layout.navigation.interfaces import INavigationRoot\n-\n-from plone.app.layout.navigation.navtree import NavtreeStrategyBase\n from plone.app.layout.navigation.navtree import buildFolderTree\n+from plone.app.layout.navigation.navtree import NavtreeStrategyBase\n from plone.app.layout.navigation.root import getNavigationRoot\n-\n+from plone.base.interfaces import INonStructuralFolder\n+from Products.CMFCore.CMFCatalogAware import CatalogAware\n+from Products.CMFCore.PortalFolder import PortalFolderBase\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.tests import PloneTestCase\n from zope.interface import directlyProvides\n from zope.interface import implementer\n \n \n-from Products.CMFPlone.PloneFolder import PloneFolder\n-from Products.CMFPlone.interfaces import INonStructuralFolder\n-\n default_user = PloneTestCase.default_user\n \n \n-\n @implementer(INonStructuralFolder)\n-class DummyNonStructuralFolder(PloneFolder):\n+class DummyNonStructuralFolder(CatalogAware, PortalFolderBase):\n     pass\n \n \ndiff --git a/Products/CMFPlone/tests/testNavigationView.py b/Products/CMFPlone/tests/testNavigationView.py\nindex cb6acb4844..ee8b3b64e8 100644\n--- a/Products/CMFPlone/tests/testNavigationView.py\n+++ b/Products/CMFPlone/tests/testNavigationView.py\n@@ -3,9 +3,9 @@\n from Products.CMFPlone.browser.navigation import CatalogNavigationTabs\n from Products.CMFPlone.browser.navigation import CatalogSiteMap\n from Products.CMFPlone.browser.navigation import PhysicalNavigationBreadcrumbs\n-from Products.CMFPlone.interfaces import IHideFromBreadcrumbs\n-from Products.CMFPlone.interfaces import INavigationSchema\n-from Products.CMFPlone.interfaces import ITypesSchema\n+from plone.base.interfaces import IHideFromBreadcrumbs\n+from plone.base.interfaces import INavigationSchema\n+from plone.base.interfaces import ITypesSchema\n from Products.CMFPlone.tests import dummy\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.tests.utils import folder_position\n@@ -463,7 +463,7 @@ def testSitemapWithNavigationRoot(self):\n         view = self.view_class(self.portal, self.request)\n         sitemap = view.siteMap()\n         self.assertEqual(sitemap[\'children\'][-1][\'item\'].getPath(),\n-                         \'/plone/folder2/file21\')\n+                         \'/plone/folder2/doc23\')\n \n \n class TestBasePortalTabs(PloneTestCase.PloneTestCase):\n@@ -502,12 +502,12 @@ def testCreateTopLevelTabs(self):\n         # Everything shows up by default\n         tabs = view.topLevelTabs(actions=[])\n         self.assertTrue(tabs)\n-        self.assertEqual(len(tabs), 8)\n+        self.assertEqual(len(tabs), 7)\n \n         # Only the folders show up (Members, news, events, folder1, folder2)\n         self.navigation_settings.nonfolderish_tabs = False\n         tabs = view.topLevelTabs(actions=[])\n-        self.assertEqual(len(tabs), 5)\n+        self.assertEqual(len(tabs), 4)\n \n     def testTabsRespectFolderOrder(self):\n         # See if reordering causes a change in the tab order\n@@ -604,18 +604,18 @@ def testTabsExcludeItemsWithExcludeProperty(self):\n         tab_names = [t[\'id\'] for t in tabs]\n         self.assertNotIn(\'folder2\', tab_names)\n \n-        # but if we\'re inside, it should be visible\n+        # if we\'re inside, it also should stay hidden\n         view = self.view_class(self.portal.folder2, self.request)\n         tabs = view.topLevelTabs(actions=[])\n         tab_names = [t[\'id\'] for t in tabs]\n-        self.assertIn(\'folder2\', tab_names)\n+        self.assertNotIn(\'folder2\', tab_names)\n \n         # Now we flip the setting for plone.show_excluded_items\n-        self.navigation_settings.show_excluded_items = False\n+        self.navigation_settings.show_excluded_items = True\n         view = self.view_class(self.portal.folder2, self.request)\n         tabs = view.topLevelTabs(actions=[])\n         tab_names = [t[\'id\'] for t in tabs]\n-        self.assertNotIn(\'folder2\', tab_names)\n+        self.assertIn(\'folder2\', tab_names)\n \n     def testTabsRespectsTypesWithViewAction(self):\n         # With a type in types_use_view_action_in_listings as current action it\ndiff --git a/Products/CMFPlone/tests/testPloneFolder.py b/Products/CMFPlone/tests/testPloneFolder.py\ndeleted file mode 100644\nindex 3ccbc81431..0000000000\n--- a/Products/CMFPlone/tests/testPloneFolder.py\n+++ /dev/null\n@@ -1,176 +0,0 @@\n-from Products.CMFPlone.tests import PloneTestCase\n-from Products.CMFPlone.tests import dummy\n-\n-from Products.CMFPlone.utils import _createObjectByType\n-\n-from AccessControl import Unauthorized\n-from Products.CMFCore.permissions import DeleteObjects\n-\n-from zExceptions import BadRequest\n-from zExceptions.unauthorized import Unauthorized as zUnauthorized\n-\n-\n-class TestPloneFolder(PloneTestCase.PloneTestCase):\n-\n-    def afterSetUp(self):\n-        # Create a bunch of subfolders\n-        self.folder.invokeFactory(\'Folder\', id=\'sub1\')\n-        self.folder.invokeFactory(\'Folder\', id=\'sub2\')\n-        self.folder.invokeFactory(\'Folder\', id=\'sub3\')\n-\n-    def testGetObjectPosition(self):\n-        self.assertEqual(self.folder.getObjectPosition(\'sub1\'), 0)\n-\n-    def testGetObjectPositionRaisesError(self):\n-        self.assertRaises(ValueError, self.folder.getObjectPosition, \'foobar\')\n-\n-    def testSortOrder(self):\n-        self.assertEqual(self.folder.objectIds(),\n-                         [\'sub1\', \'sub2\', \'sub3\'])\n-\n-    def testCanViewManagementScreen(self):\n-        # Make sure the ZMI management screen works\n-        self.folder.manage_main()\n-\n-\n-class TestCheckIdAvailable(PloneTestCase.PloneTestCase):\n-    # PortalFolder.checkIdAvailable() did not properly catch\n-    # zExceptions.BadRequest.\n-    # Fixed in CMFCore.PortalFolder, not Plone.\n-\n-    def testSetObjectRaisesBadRequest(self):\n-        # _setObject() should raise zExceptions.BadRequest\n-        # on duplicate id.\n-        self.folder._setObject(\'foo\', dummy.Item())\n-        try:\n-            self.folder._setObject(\'foo\', dummy.Item())\n-        except BadRequest:\n-            pass\n-\n-    def testCheckIdRaisesBadRequest(self):\n-        # _checkId() should raise zExceptions.BadRequest\n-        # on duplicate id.\n-        self.folder._setObject(\'foo\', dummy.Item())\n-        try:\n-            self.folder._checkId(\'foo\')\n-        except BadRequest:\n-            pass\n-\n-    def testCheckIdAvailableCatchesBadRequest(self):\n-        # checkIdAvailable() should catch zExceptions.BadRequest\n-        self.folder._setObject(\'foo\', dummy.Item())\n-        self.assertFalse(self.folder.checkIdAvailable(\'foo\'))\n-\n-\n-class TestFolderListing(PloneTestCase.PloneTestCase):\n-    # Tests for http://dev.plone.org/plone/ticket/3512\n-\n-    def afterSetUp(self):\n-        self.workflow = self.portal.portal_workflow\n-        # Create some objects to list\n-        self.folder.invokeFactory(\'Folder\', id=\'sub1\')\n-        self.folder.invokeFactory(\'Folder\', id=\'sub2\')\n-        self.folder.invokeFactory(\'Document\', id=\'doc1\')\n-        self.folder.invokeFactory(\'Document\', id=\'doc2\')\n-        self.setupAuthenticator()\n-\n-    def _contentIds(self, folder):\n-        return [ob.getId() for ob in folder.listFolderContents()]\n-\n-    def testListFolderContentsOmitsPrivateObjects(self):\n-        self.workflow.doActionFor(self.folder.doc1, \'hide\')\n-        self.logout()\n-        self.assertEqual(self._contentIds(self.folder),\n-                         [\'sub1\', \'sub2\', \'doc2\'])\n-\n-    def testListFolderContentsOmitsPrivateFolders(self):\n-        self.workflow.doActionFor(self.folder.sub1, \'hide\')\n-        self.logout()\n-        self.assertEqual(self._contentIds(self.folder),\n-                         [\'sub2\', \'doc1\', \'doc2\'])\n-\n-    def testBugReport(self):\n-        # Perform the steps-to-reproduce in the collector issue:\n-\n-        # 2)\n-        self.folder.invokeFactory(\'Folder\', id=\'A\')\n-        self.workflow.doActionFor(self.folder.A, \'publish\')\n-\n-        self.logout()\n-        self.assertEqual(self._contentIds(self.folder.A), [])\n-\n-        # 3)\n-        self.login()\n-        self.folder.A.invokeFactory(\'Document\', id=\'B\')\n-        self.folder.A.B.manage_permission(\'View\', [\'Manager\', \'Reviewer\'],\n-                                          acquire=0)\n-\n-        self.logout()\n-        self.assertEqual(self._contentIds(self.folder.A), [])\n-\n-        # 4)\n-        self.login()\n-        self.folder.A.invokeFactory(\'Folder\', id=\'C\')\n-        self.folder.A.C.manage_permission(\'View\', [\'Manager\', \'Reviewer\'],\n-                                          acquire=0)\n-\n-        # Here comes the reported bug:\n-        self.logout()\n-        self.assertEqual(self._contentIds(self.folder.A), [\'C\'])\n-\n-        # 4a)\n-        # BUT: removing \'View\' is simply not enough!\n-        # When using the workflow all is fine:\n-        self.login()\n-        self.workflow.doActionFor(self.folder.A.C, \'hide\')\n-\n-        self.logout()\n-        self.assertEqual(self._contentIds(self.folder.A), [])\n-\n-\n-class TestManageDelObjects(PloneTestCase.PloneTestCase):\n-    # manage_delObjects should check \'Delete objects\'\n-    # permission on contained items.\n-\n-    def afterSetUp(self):\n-        # Create a bunch of folders\n-        self.folder.invokeFactory(\'Folder\', id=\'sub1\')\n-        self.sub1 = self.folder.sub1\n-        self.sub1.invokeFactory(\'Folder\', id=\'sub2\')\n-        self.sub2 = self.sub1.sub2\n-\n-    def testManageDelObjects(self):\n-        # Should be able to delete sub1\n-        self.folder.manage_delObjects(\'sub1\')\n-        self.assertFalse(\'sub1\' in self.folder.objectIds())\n-\n-    def testManageDelObjectsIfSub1Denied(self):\n-        # Should NOT be able to delete sub1 due to permission checks in\n-        # Archetypes.BaseFolder.manage_delObjects().\n-        self.sub1.manage_permission(DeleteObjects, [\'Manager\'], acquire=0)\n-        self.assertRaises(zUnauthorized, self.folder.manage_delObjects, \'sub1\')\n-\n-    def testManageDelObjectsIfSub2Denied(self):\n-        # We are able to delete sub1 if sub2 is denied\n-        # -> the check is only 1 level deep!\n-        self.sub2.manage_permission(DeleteObjects, [\'Manager\'], acquire=0)\n-        self.folder.manage_delObjects(\'sub1\')\n-        self.assertFalse(\'sub1\' in self.folder.objectIds())\n-\n-\n-class TestManageDelObjectsInPortal(PloneTestCase.PloneTestCase):\n-\n-    def afterSetUp(self):\n-        _createObjectByType(\'Folder\', self.portal, id=\'sub1\')\n-        self.sub1 = self.portal.sub1\n-\n-    def testManageDelObjects(self):\n-        # Should be able to delete sub1\n-        self.portal.manage_delObjects(\'sub1\')\n-        self.assertFalse(\'sub1\' in self.portal.objectIds())\n-\n-    def testManageDelObjectsIfSub1Denied(self):\n-        # Should be able to delete sub1 as the portal does not implement\n-        # additional permission checks.\n-        self.sub1.manage_permission(DeleteObjects, [\'Manager\'], acquire=0)\n-        self.assertRaises(zUnauthorized, self.portal.manage_delObjects, \'sub1\')\ndiff --git a/Products/CMFPlone/tests/testPloneTool.py b/Products/CMFPlone/tests/testPloneTool.py\nindex 7546d7a0d1..459d21d01e 100644\n--- a/Products/CMFPlone/tests/testPloneTool.py\n+++ b/Products/CMFPlone/tests/testPloneTool.py\n@@ -2,8 +2,8 @@\n from plone.app.testing import SITE_OWNER_NAME\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.interfaces import IReorderedEvent\n-from Products.CMFPlone.interfaces import ISearchSchema\n+from plone.base.interfaces import IReorderedEvent\n+from plone.base.interfaces import ISearchSchema\n from Products.CMFPlone.tests import PloneTestCase\n from zope.component import getGlobalSiteManager\n from zope.component import getUtility\n@@ -552,21 +552,6 @@ class TestIDGenerationMethods(PloneTestCase.PloneTestCase):\n     def afterSetUp(self):\n         self.utils = self.portal.plone_utils\n \n-    def testAutoGeneratedId(self):\n-        r = self.utils.isIDAutoGenerated(\'document.2004-11-09.0123456789\')\n-        self.assertEqual(r, True)\n-\n-    def testValidPortalTypeNameButNotAutoGeneratedId(self):\n-        # This was raising an IndexError exception for\n-        # Zope < 2.7.3 (DateTime.py < 1.85.12.11) and a\n-        # SyntaxError for Zope >= 2.7.3 (DateTime.py >= 1.85.12.11)\n-        r = self.utils.isIDAutoGenerated(\'document.tar.gz\')\n-        self.assertEqual(r, False)\n-        r = self.utils.isIDAutoGenerated(\'document.tar.12/32/2004\')\n-        self.assertEqual(r, False)\n-        r = self.utils.isIDAutoGenerated(\'document.tar.12/31/2004 12:62\')\n-        self.assertEqual(r, False)\n-\n     def test_pretty_title_or_id_returns_title(self):\n         self.folder.setTitle(\'My pretty title\')\n         self.assertEqual(self.utils.pretty_title_or_id(self.folder),\n@@ -577,17 +562,6 @@ def test_pretty_title_or_id_returns_id(self):\n         self.assertEqual(self.utils.pretty_title_or_id(self.folder),\n                          self.folder.getId())\n \n-    def test_pretty_title_or_id_when_autogenerated(self):\n-        self.setRoles([\'Manager\', \'Member\'])\n-        self.folder.setTitle(\'\')\n-        self.folder.__parent__.manage_renameObject(\n-            self.folder.id, \'folder.2004-11-09.0123456789\')\n-        self.folder.reindexObject()\n-        self.assertEqual(self.utils.pretty_title_or_id(self.folder),\n-                         self.utils.getEmptyTitle())\n-        self.assertEqual(self.utils.pretty_title_or_id(self.folder, \'Marker\'),\n-                         \'Marker\')\n-\n     def test_pretty_title_or_id_works_with_method_that_needs_context(self):\n         self.setRoles([\'Manager\', \'Member\'])\n         # Create a dummy class that looks at it\'s context to find the title\n@@ -621,19 +595,6 @@ def test_pretty_title_or_id_on_catalog_brain_returns_id(self):\n         self.assertEqual(self.utils.pretty_title_or_id(results[0]),\n                          self.folder.getId())\n \n-    def test_pretty_title_or_id_on_catalog_brain_autogenerated(self):\n-        cat = self.portal.portal_catalog\n-        self.setRoles([\'Manager\', \'Member\'])\n-        self.folder.__parent__.manage_renameObject(\n-            self.folder.id, \'folder.2004-11-09.0123456789\')\n-        self.folder.title = \'\'\n-        self.folder.subject = (\'foobar\',)\n-        self.folder.reindexObject()\n-        results = cat(Subject=\'foobar\')\n-        self.assertEqual(len(results), 1)\n-        self.assertEqual(self.utils.pretty_title_or_id(results[0], \'Marker\'),\n-                         \'Marker\')\n-\n     def test_pretty_title_or_id_on_catalog_brain_no_title(self):\n         cat = self.portal.portal_catalog\n         self.setRoles([\'Manager\', \'Member\'])\ndiff --git a/Products/CMFPlone/tests/testPloneView.py b/Products/CMFPlone/tests/testPloneView.py\nindex 4f68681a98..5efdcc84bd 100644\n--- a/Products/CMFPlone/tests/testPloneView.py\n+++ b/Products/CMFPlone/tests/testPloneView.py\n@@ -151,3 +151,8 @@ def testCropText(self):\n     def testSiteEncoding(self):\n         view = Plone(self.portal, self.app.REQUEST)\n         self.assertEqual(\'utf-8\', view.site_encoding())\n+\n+    def test_human_readable_size(self):\n+        view = Plone(self.portal, self.app.REQUEST)\n+        from Products.CMFPlone.utils import human_readable_size\n+        self.assertIs(view.human_readable_size, human_readable_size)\ndiff --git a/Products/CMFPlone/tests/testPortalCreation.py b/Products/CMFPlone/tests/testPortalCreation.py\nindex fca5d5358a..08498041e6 100644\n--- a/Products/CMFPlone/tests/testPortalCreation.py\n+++ b/Products/CMFPlone/tests/testPortalCreation.py\n@@ -10,9 +10,9 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import setuphandlers\n from Products.CMFPlone.factory import _DEFAULT_PROFILE\n-from Products.CMFPlone.interfaces import IFilterSchema\n-from Products.CMFPlone.interfaces import INavigationSchema\n-from Products.CMFPlone.interfaces import ISearchSchema\n+from plone.base.interfaces import IFilterSchema\n+from plone.base.interfaces import INavigationSchema\n+from plone.base.interfaces import ISearchSchema\n from Products.CMFPlone.tests import dummy\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.UnicodeSplitter import I18NNormalizer\n@@ -86,6 +86,13 @@ def testWorkflowIsActionProvider(self):\n             \'portal_workflow\' in self.actions.listActionProviders()\n         )\n \n+    def testPortalIsIndexed(self):\n+        # The Plone site should be cataloged\n+        res = self.catalog(getId="plone")\n+        self.assertEqual(len(res), 1)\n+        self.assertEqual(res[0].getId, "plone")\n+        self.assertEqual(res[0].Title, "Welcome to Plone")\n+\n     def testMembersFolderMetaType(self):\n         # Members folder should have meta_type \'Dexterity Container\'\n         members = self.membership.getMembersFolder()\n@@ -419,18 +426,16 @@ def testTTWLockableProperty(self):\n         self.assertEqual(True, registry[\'plone.lock_on_ttw_edit\'])\n \n     def testPortalFTIIsDynamicFTI(self):\n-        # Plone Site FTI should be a DynamicView FTI\n+        # Plone Site FTI should be a Dexterity FTI\n         fti = self.portal.getTypeInfo()\n-        self.assertEqual(\n-            fti.meta_type, \'Factory-based Type Information with dynamic views\'\n-        )\n+        self.assertEqual(fti.meta_type, \'Dexterity FTI\')\n \n     def testPloneSiteFTIHasMethodAliases(self):\n         # Should add method aliases to the Plone Site FTI\n         expected_aliases = {\n             \'(Default)\': \'(dynamic view)\',\n             \'view\': \'(selected layout)\',\n-            \'edit\': \'@@site-controlpanel\',\n+            \'edit\': \'@@edit\',\n             \'sharing\': \'@@sharing\',\n         }\n         fti = self.portal.getTypeInfo()\n@@ -532,13 +537,6 @@ def testSyndicationTabDisabled(self):\n                     "Actions tool still has visible \'syndication\' action"\n                 )\n \n-    def testObjectButtonActionsInvisibleOnPortalRoot(self):\n-        # only a manager would have proper permissions\n-        self.setRoles([\'Manager\', \'Member\'])\n-        acts = self.actions.listFilteredActionsFor(self.portal)\n-        buttons = acts.get(\'object_buttons\', [])\n-        self.assertEqual(0, len(buttons))\n-\n     def testObjectButtonActionsInvisibleOnPortalDefaultDocument(self):\n         # only a manager would have proper permissions\n         self.setRoles([\'Manager\', \'Member\'])\n@@ -1023,8 +1021,11 @@ def test_addsite_en_as_nl(self):\n         self.request.form[\'default_language\'] = \'en\'\n         self.addsite()\n         plonesite = self.app.plonesite1\n-        fp = plonesite[\'front-page\']\n         # Unfortunately, the next test passes even without the fix (overriding\n         # HTTP_ACCEPT_LANGUAGE on the request in factory.py).  This seems to be\n         # because translations are not available in the tests.\n-        self.assertIn(\'Learn more about Plone\', fp.text.raw)\n+        self.assertIn(\'Learn more about Plone\', plonesite.text.raw)\n+\n+        # XXX maybe it is better to reset the sire in the @@plone-addsite view\n+        # or somewhere else?\n+        setSite(None)\ndiff --git a/Products/CMFPlone/tests/testQueryCatalog.py b/Products/CMFPlone/tests/testQueryCatalog.py\nindex 6bafb5856b..2073903c67 100644\n--- a/Products/CMFPlone/tests/testQueryCatalog.py\n+++ b/Products/CMFPlone/tests/testQueryCatalog.py\n@@ -1,9 +1,9 @@\n # Test queryCatalog and plone search forms\n from plone.app.textfield.value import RichTextValue\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import INavigationSchema\n-from Products.CMFPlone.interfaces import ISearchSchema\n-from Products.CMFPlone.interfaces.syndication import ISiteSyndicationSettings\n+from plone.base.interfaces import INavigationSchema\n+from plone.base.interfaces import ISearchSchema\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from Products.CMFPlone.tests import PloneTestCase\n from Products.ZCTextIndex.ParseTree import ParseError\n from zExceptions import NotFound\ndiff --git a/Products/CMFPlone/tests/testRegistrationTool.py b/Products/CMFPlone/tests/testRegistrationTool.py\nindex a10869da25..f9e722d42d 100644\n--- a/Products/CMFPlone/tests/testRegistrationTool.py\n+++ b/Products/CMFPlone/tests/testRegistrationTool.py\n@@ -3,7 +3,7 @@\n from AccessControl import Unauthorized\n from Products.CMFCore.permissions import AddPortalMember\n from Products.CMFPlone.RegistrationTool import _checkEmail\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema, ISiteSchema\n+from plone.base.interfaces.controlpanel import IMailSchema, ISiteSchema\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.tests.utils import MockMailHost\n from Products.MailHost.interfaces import IMailHost\n@@ -242,7 +242,7 @@ def testMailPasswordEncoding(self):\n         mail_settings.email_from_address = \'bar@baz.com\'\n \n         # Set the portal email encoding\n-        mail_settings.email_charset = \'us-ascii\'\n+        self.assertEqual(mail_settings.email_charset, \'utf-8\')\n \n         from zope.publisher.browser import TestRequest\n         self.registration.mailPassword(member_id, TestRequest())\n@@ -250,7 +250,7 @@ def testMailPasswordEncoding(self):\n         msg = message_from_bytes(mails.messages[0])\n \n         # Ensure charset (and thus Content-Type) were set via template\n-        self.assertEqual(msg[\'Content-Type\'], \'text/plain; charset="us-ascii"\')\n+        self.assertEqual(msg[\'Content-Type\'], \'text/plain; charset="utf-8"\')\n \n \n class TestPasswordGeneration(PloneTestCase.PloneTestCase):\ndiff --git a/Products/CMFPlone/tests/testResourceRegistries.py b/Products/CMFPlone/tests/testResourceRegistries.py\nindex d17106da82..a619d4679e 100644\n--- a/Products/CMFPlone/tests/testResourceRegistries.py\n+++ b/Products/CMFPlone/tests/testResourceRegistries.py\n@@ -1,609 +1,418 @@\n from plone.app.testing import logout\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.base.interfaces import IBundleRegistry\n+from plone.registry import field as regfield\n+from plone.registry import Record\n from plone.registry.interfaces import IRegistry\n-from plone.resource.interfaces import IResourceDirectory\n-from plone.subrequest import subrequest\n-from Products.CMFPlone.controlpanel.browser.resourceregistry import OverrideFolderManager  # noqa\n-from Products.CMFPlone.controlpanel.browser.resourceregistry import ResourceRegistryControlPanelView  # noqa\n-from Products.CMFPlone.interfaces import IBundleRegistry\n-from Products.CMFPlone.interfaces import IResourceRegistry\n-from Products.CMFPlone.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME  # noqa\n+from plone.testing.zope import Browser\n from Products.CMFPlone.resources import add_bundle_on_request\n-from Products.CMFPlone.resources import add_resource_on_request\n from Products.CMFPlone.resources import remove_bundle_on_request\n-from Products.CMFPlone.resources.browser.cook import cookWhenChangingSettings\n-from Products.CMFPlone.resources.browser.scripts import ScriptsView\n-from Products.CMFPlone.resources.browser.styles import StylesView\n-from Products.CMFPlone.resources.bundle import Bundle\n-from Products.CMFPlone.resources.exportimport.resourceregistry import ResourceRegistryNodeAdapter  # noqa\n+from Products.CMFPlone.resources.browser.resource import ScriptsView\n+from Products.CMFPlone.resources.browser.resource import StylesView\n from Products.CMFPlone.tests import PloneTestCase\n-from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from zope.component import getUtility\n \n-import json\n-from unittest import mock\n-import os\n \n-\n-class TestResourceRegistries(PloneTestCase.PloneTestCase):\n-\n-    def test_cooking_resources(self):\n+class TestScriptsViewlet(PloneTestCase.PloneTestCase):\n+    def _make_test_bundle(self):\n         registry = getUtility(IRegistry)\n-        bundles = registry.collectionOfInterface(IBundleRegistry,\n-                                                 prefix="plone.bundles")\n-        bundle = bundles.add(\'foobar\')\n-        bundle.jscompilation = \'++plone++static/foobar-compiled.js\'\n-        bundle.csscompilation = \'++plone++static/foobar-compiled.css\'\n-\n-        resources = registry.collectionOfInterface(IResourceRegistry,\n-                                                   prefix="plone.resources")\n-        resource = resources.add(\'foobar\')\n-\n-        resource.js = \'++plone++static/foobar.js\'\n-        resource.css = [\'++plone++static/foobar.css\']\n-        bundle.resources = [\'foobar\']\n-\n-        persistent_directory = getUtility(\n-            IResourceDirectory, name="persistent")\n-        if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:\n-            persistent_directory.makeDirectory(\n-                OVERRIDE_RESOURCE_DIRECTORY_NAME)\n-        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-        container.makeDirectory(\'static\')\n-        directory = container[\'static\']\n-        directory.writeFile(\'foobar.js\', \'alert("Hi!");\\n\\nalert("Ho!");\')\n-        directory.writeFile(\'foobar.css\', \'body {\\ncolor: blue;\\n}\')\n-\n-        cookWhenChangingSettings(self.portal, bundle)\n-\n-        resp_js = subrequest(\n-            \'{}/++plone++static/foobar-compiled.js\'.format(\n-                self.portal.absolute_url()\n-            )\n-        )\n-        self.assertIn(b\'alert("Hi!");alert("Ho!");\', resp_js.getBody())\n \n-        resp_css = subrequest(\n-            \'{}/++plone++static/foobar-compiled.css\'.format(\n-                self.portal.absolute_url()\n-            )\n+        bundles = registry.collectionOfInterface(\n+            IBundleRegistry, prefix="plone.bundles"\n         )\n-        self.assertIn(b\'body{color:blue}\', resp_css.getBody())\n+        bundle = bundles.add("foobar")\n+        bundle.name = "foobar"\n+        bundle.jscompilation = "http://foo.bar/foobar.js"\n+        bundle.csscompilation = "http://foo.bar/foobar.css"\n+        bundle.resources = ["foobar"]\n+        return bundle\n+\n+    def test_bundle_defernot_asyncnot(self):\n+        bundle = self._make_test_bundle()\n+        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n+        view.update()\n+        rendered = view.render()\n+        self.assertTrue("async=" not in rendered)\n+        self.assertTrue("defer=" not in rendered)\n \n-    def test_dont_minify_already_minified(self):\n-        registry = getUtility(IRegistry)\n-        bundles = registry.collectionOfInterface(IBundleRegistry,\n-                                                 prefix="plone.bundles")\n-        bundle = bundles.add(\'foobar\')\n-        bundle.jscompilation = \'++plone++static/foobar-compiled.js\'\n-        bundle.csscompilation = \'++plone++static/foobar-compiled.css\'\n-\n-        resources = registry.collectionOfInterface(IResourceRegistry,\n-                                                   prefix="plone.resources")\n-        resource = resources.add(\'foobar\')\n-\n-        resource.js = \'++plone++static/foobar.min.js\'\n-        resource.css = [\'++plone++static/foobar.min.css\']\n-        bundle.resources = [\'foobar\']\n-\n-        persistent_directory = getUtility(\n-            IResourceDirectory, name="persistent")\n-        if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:\n-            persistent_directory.makeDirectory(\n-                OVERRIDE_RESOURCE_DIRECTORY_NAME)\n-        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-        container.makeDirectory(\'static\')\n-        directory = container[\'static\']\n-        directory.writeFile(\'foobar.min.js\', b\'alert("Hi!");\\n\\nalert("Ho!");\')\n-        directory.writeFile(\'foobar.min.css\', b\'body {\\ncolor: blue;\\n}\')\n-\n-        cookWhenChangingSettings(self.portal, bundle)\n-\n-        resp_js = subrequest(\n-            \'{}/++plone++static/foobar-compiled.js\'.format(\n-                self.portal.absolute_url()\n-            )\n-        )\n-        self.assertIn(b\'alert("Hi!");\\n\\nalert("Ho!");\', resp_js.getBody())\n+    def test_bundle_defernot_async(self):\n+        bundle = self._make_test_bundle()\n+        bundle.load_async = True\n+        bundle.load_defer = False\n+        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n+        view.update()\n+        rendered = view.render()\n \n-        resp_css = subrequest(\n-            \'{}/++plone++static/foobar-compiled.css\'.format(\n-                self.portal.absolute_url()\n-            )\n-        )\n-        self.assertIn(b\'body {\\ncolor: blue;\\n}\', resp_css.getBody())\n+    def test_bundle_defer_asyncnot(self):\n+        bundle = self._make_test_bundle()\n+        bundle.load_async = False\n+        bundle.load_defer = True\n+        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n+        view.update()\n+        rendered = view.render()\n+        self.assertTrue("async=" not in rendered)\n+        self.assertTrue("defer=" in rendered)\n \n-    def test_cook_only_css(self):\n-        registry = getUtility(IRegistry)\n-        bundles = registry.collectionOfInterface(IBundleRegistry,\n-                                                 prefix="plone.bundles")\n-        bundle = bundles.add(\'foobar\')\n-        bundle.jscompilation = \'\'\n-        bundle.csscompilation = \'++plone++static/foobar-compiled.css\'\n-\n-        resources = registry.collectionOfInterface(IResourceRegistry,\n-                                                   prefix="plone.resources")\n-        resource = resources.add(\'foobar\')\n-\n-        resource.css = [\'++plone++static/foobar.min.css\']\n-        bundle.resources = [\'foobar\']\n-\n-        persistent_directory = getUtility(\n-            IResourceDirectory, name="persistent")\n-        if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:\n-            persistent_directory.makeDirectory(\n-                OVERRIDE_RESOURCE_DIRECTORY_NAME)\n-        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-        container.makeDirectory(\'static\')\n-        directory = container[\'static\']\n-        directory.writeFile(\'foobar.min.css\', \'body {\\ncolor: red;\\n}\')\n-\n-        cookWhenChangingSettings(self.portal, bundle)\n-\n-        resp_css = subrequest(\n-            \'{}/++plone++static/foobar-compiled.css\'.format(\n-                self.portal.absolute_url()\n-            )\n-        )\n-        self.assertIn(b\'body {\\ncolor: red;\\n}\', resp_css.getBody())\n+    def test_bundle_defernot_async(self):\n+        bundle = self._make_test_bundle()\n+        bundle.load_async = True\n+        bundle.load_defer = False\n+        request = self.app.REQUEST\n+        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n+        view.update()\n+        rendered = view.render()\n+        self.assertTrue("async=" in rendered)\n+        self.assertTrue("defer=" not in rendered)\n \n-    def test_cooking_missing(self):\n-        registry = getUtility(IRegistry)\n-        bundles = registry.collectionOfInterface(IBundleRegistry,\n-                                                 prefix="plone.bundles")\n-        bundle = bundles.add(\'foobar\')\n-        bundle.jscompilation = \'++plone++static/foobar-compiled.js\'\n-        bundle.csscompilation = \'++plone++static/foobar-compiled.css\'\n-\n-        resources = registry.collectionOfInterface(IResourceRegistry,\n-                                                   prefix="plone.resources")\n-        resource = resources.add(\'foobar\')\n-\n-        resource.js = \'++plone++static/foobar.js\'\n-        bundle.resources = [\'foobar\']\n-\n-        bundle = Bundle(bundle)\n-\n-        cookWhenChangingSettings(self.portal, bundle)\n-        resp = subrequest(\n-            \'{}/++plone++static/foobar-compiled.js\'.format(\n-                self.portal.absolute_url()\n-            )\n-        )\n-        self.assertIn(b\'Could not find resource\', resp.getBody())\n+    def test_bundle_defer_async(self):\n+        bundle = self._make_test_bundle()\n+        bundle.load_async = True\n+        bundle.load_defer = True\n+        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n+        view.update()\n+        rendered = view.render()\n+        self.assertTrue("async=" in rendered)\n+        self.assertTrue("defer=" in rendered)\n \n-    def test_cooking_missing_browserresource(self):\n-        registry = getUtility(IRegistry)\n-        registry[\'plone.resources.development\'] = True\n-        bundles = registry.collectionOfInterface(IBundleRegistry,\n-                                                 prefix="plone.bundles")\n-        bundle = bundles.add(\'barbar\')\n-        bundle.jscompilation = \'++resource++notfound/barbar-compiled.js\'\n-        bundle.csscompilation = \'++resource++notfound/barbar-compiled.css\'\n-        bundle.compile = False\n-        bundle.merge_with = \'default\'\n-\n-        bundle = Bundle(bundle)\n-\n-        # cookWhenChangingSettings(self.portal, bundle)\n-        scripts = ScriptsView(\n-            self.layer[\'portal\'],\n-            self.layer[\'request\'],\n-            None\n-        )\n+    def test_scripts_viewlet(self):\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n         scripts.update()\n-        results = scripts.scripts()\n-        # at least have jquery.min.js, config.js, require.js, etc.\n-        self.assertTrue(len(results)>2)\n+        results = scripts.render()\n+        self.assertIn("++plone++static/bundle-plone/bundle.min.js", results)\n+        self.assertIn("http://nohost/plone/++webresource++", results)\n \n-    def test_error(self):\n-        registry = getUtility(IRegistry)\n-        bundles = registry.collectionOfInterface(IBundleRegistry,\n-                                                 prefix="plone.bundles")\n-        bundle = bundles.add(\'foobar\')\n-        bundle.jscompilation = \'++plone++static/foobar-compiled.js\'\n-        bundle.csscompilation = \'++plone++static/foobar-compiled.css\'\n-\n-        resources = registry.collectionOfInterface(IResourceRegistry,\n-                                                   prefix="plone.resources")\n-        resource = resources.add(\'foobar\')\n-\n-        resource.js = \'++plone++static/foobar.js\'\n-        bundle.resources = [\'foobar\']\n-\n-        persistent_directory = getUtility(\n-            IResourceDirectory, name="persistent")\n-        if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:\n-            persistent_directory.makeDirectory(\n-                OVERRIDE_RESOURCE_DIRECTORY_NAME)\n-        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-        container.makeDirectory(\'static\')\n-        directory = container[\'static\']\n-        directory.writeFile(\'foobar.js\', \'sdlfk ldsf lksdjfl s\')\n-\n-        cookWhenChangingSettings(self.portal, bundle)\n-        resp = subrequest(\n-            \'{}/++plone++static/foobar-compiled.js\'.format(\n-                self.portal.absolute_url()\n-            )\n-        )\n-        self.assertIn(b\'error cooking\', resp.getBody())\n+    def test_scripts_viewlet_anonymous(self):\n+        logout()\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        scripts.update()\n+        results = scripts.render()\n+        self.assertIn("++plone++static/bundle-plone/bundle.min.js", results)\n+        self.assertIn("http://nohost/plone/++webresource++", results)\n \n-    def test_bundle_defer_async(self):\n-        registry = getUtility(IRegistry)\n+    def test_request_bundles_not_add_same_twice(self):\n+        req = self.layer["request"]\n+        add_bundle_on_request(req, "foo")\n+        add_bundle_on_request(req, "foo")\n \n-        bundles = registry.collectionOfInterface(\n-            IBundleRegistry,\n-            prefix="plone.bundles"\n-        )\n-        bundle = bundles.add(\'foobar\')\n-        bundle.name = \'foobar\'\n-        bundle.jscompilation = \'foobar.js\'\n-        bundle.csscompilation = \'foobar.css\'\n-        bundle.resources = [\'foobar\']\n+        self.assertEqual(len(req.enabled_bundles), 1)\n \n-        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n-        view.get_cooked_bundles = lambda: [(\'foobar\', bundle)]\n+    def test_disabled_bundle_not_rendered(self):\n+        # request\n+        req = self.layer["request"]\n \n-        import Products.CMFPlone.resources.browser\n-        path = os.path.dirname(Products.CMFPlone.resources.browser.__file__)\n-        view.index = ViewPageTemplateFile(\'scripts.pt\', path)\n-        view.update()\n+        # create a subrequest.\n+        subreq = req.clone()\n+        subreq["PARENT_REQUEST"] = req\n \n-        self.assertTrue(\'async="async"\' not in view.index(view))\n-        self.assertTrue(\'defer="defer"\' not in view.index(view))\n+        scripts = ScriptsView(self.layer["portal"], subreq, None)\n \n-        bundle.load_async = True\n-        bundle.load_defer = False\n-        self.assertTrue(\'async="async"\' in view.index(view))\n-        self.assertTrue(\'defer="defer"\' not in view.index(view))\n+        # add some bundle to test with\n+        bundle = self._make_test_bundle()\n+        bundle.enabled = False\n+        scripts.update()\n+        result = scripts.render()\n+        self.assertNotIn("http://foo.bar/foobar.js", result)\n \n-        bundle.load_async = False\n-        bundle.load_defer = True\n-        self.assertTrue(\'async="async"\' not in view.index(view))\n-        self.assertTrue(\'defer="defer"\' in view.index(view))\n+    def test_add_bundle_on_request_with_subrequest(self):\n+        # request\n+        req = self.layer["request"]\n \n-        bundle.load_async = True\n-        bundle.load_defer = True\n+        # create a subrequest.\n+        subreq = req.clone()\n+        subreq["PARENT_REQUEST"] = req\n+\n+        # add a bundle via the main request\n+        add_bundle_on_request(req, "foobar")\n \n-        self.assertTrue(\'async="async"\' in view.index(view))\n-        self.assertTrue(\'defer="defer"\' in view.index(view))\n+        scripts = ScriptsView(self.layer["portal"], subreq, None)\n \n-        bundle.load_async = False\n-        bundle.load_defer = False\n+        # add some bundle to test with\n+        bundle = self._make_test_bundle()\n+        bundle.enabled = False\n+        scripts.update()\n+        result = scripts.render()\n+        self.assertIn("http://foo.bar/foobar.js", result)\n \n-        self.assertTrue(\'async="async"\' not in view.index(view))\n-        self.assertTrue(\'defer="defer"\' not in view.index(view))\n+    def test_remove_bundle_on_request_with_subrequest(self):\n+        # request\n+        req = self.layer["request"]\n \n-    def test_bundle_defer_async_production(self):\n-        """The default and logged-in production bundles should never be loaded\n-        async or defered.\n-        For bundles to be loaded async or defered, you need to empty merge_with\n-        """\n-        registry = getUtility(IRegistry)\n+        # create a subrequest.\n+        subreq = req.clone()\n+        subreq["PARENT_REQUEST"] = req\n \n-        bundles = registry.collectionOfInterface(\n-            IBundleRegistry,\n-            prefix="plone.bundles"\n-        )\n-        bundles[\'plone\'].load_async = False\n-        bundles[\'plone\'].load_defer = False\n-        bundles[\'plone-logged-in\'].load_async = False\n-        bundles[\'plone-logged-in\'].load_defer = False\n+        # add a bundle via the main request\n+        add_bundle_on_request(req, "foobar")\n \n-        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n+        scripts = ScriptsView(self.layer["portal"], subreq, None)\n \n-        import Products.CMFPlone.resources.browser\n-        path = os.path.dirname(Products.CMFPlone.resources.browser.__file__)\n-        view.index = ViewPageTemplateFile(\'scripts.pt\', path)\n+        # add some bundle to test with\n+        bundle = self._make_test_bundle()\n+        bundle.enabled = True\n+        scripts.update()\n+        result = scripts.render()\n+        self.assertNotIn("http://test.foo/test.css", result)\n+\n+    def test_bundle_depends(self):\n+        bundle = self._make_test_bundle()\n+        bundle.depends = "plone"\n+        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n         view.update()\n+        results = view.render()\n+        self.assertIn("http://foo.bar/foobar.js", results)\n \n-        self.assertTrue(\'async="async"\' not in view.index(view))\n-        self.assertTrue(\'defer="defer"\' not in view.index(view))\n-\n-        bundles[\'plone\'].load_async = True\n-        bundles[\'plone\'].load_defer = True\n-        self.assertEqual(view.index(view).count(\'async="async"\'), 0)\n-        self.assertEqual(view.index(view).count(\'defer="defer"\'), 0)\n-\n-        bundles[\'plone\'].merge_with = \'\'\n-        bundles[\'plone\'].load_async = True\n-        bundles[\'plone\'].load_defer = True\n-        self.assertEqual(view.index(view).count(\'async="async"\'), 1)\n-        self.assertEqual(view.index(view).count(\'defer="defer"\'), 1)\n-\n-        bundles[\'plone\'].merge_with = \'\'\n-        bundles[\'plone\'].load_async = True\n-        bundles[\'plone\'].load_defer = True\n-        bundles[\'plone-logged-in\'].merge_with = \'\'\n-        bundles[\'plone-logged-in\'].load_async = True\n-        bundles[\'plone-logged-in\'].load_defer = True\n-        self.assertEqual(view.index(view).count(\'async="async"\'), 2)\n-        self.assertEqual(view.index(view).count(\'defer="defer"\'), 2)\n-\n-\n-class TestConfigJs(PloneTestCase.PloneTestCase):\n-\n-    def test_init_shim_works_with_function(self):\n-        config = self.portal.restrictedTraverse(\'config.js\')()\n-        self.assertTrue(\'init: function\' in config)\n-\n-\n-class TestControlPanel(PloneTestCase.PloneTestCase):\n-\n-    def test_save_override_file(self):\n-        req = self.layer[\'request\']\n-        req.environ[\'PATH_INFO\'] = \'++plone++foo/bar.css\'\n-        mng = OverrideFolderManager(self.portal)\n-        mng.save_file(\'foo/bar.css\', \'foobar\')\n-        value = self.portal.restrictedTraverse(\'++plone++foo/bar.css\')\n-        self.assertEqual(value.data, b\'foobar\')\n-\n-    def test_override_rewrite_links(self):\n-        req = self.layer[\'request\']\n-        req.environ[\'PATH_INFO\'] = \'++plone++foo/bar.css\'\n-        mng = OverrideFolderManager(self.portal)\n-        css = """\n-.foo {{\n-    background-image: url("{site_url}/foobar.css");\n-}}\n-.bar {{\n-    background-image: url("{site_url}/++plone++foo/bar/foobar.css");\n-}}\n-.foobar {{\n-    background-image: url("{site_url}/foo/bar/foobar.css");\n-}}""".format(site_url=self.portal.absolute_url())\n-        mng.save_file(\'foo/bar.css\', css)\n-        value = self.portal.restrictedTraverse(\'++plone++foo/bar.css\')\n-        match = b"""\n-.foo {\n-    background-image: url("../foobar.css");\n-}\n-.bar {\n-    background-image: url("bar/foobar.css");\n-}\n-.foobar {\n-    background-image: url("../foo/bar/foobar.css");\n-}"""\n-        self.assertEqual(value.data, match)\n-\n-    def test_get_require_js_config_uses_stub_modules(self):\n-        view = ResourceRegistryControlPanelView(\n-            self.portal, self.layer[\'request\'])\n-        self.layer[\'request\'].form[\'bundle\'] = \'plone-logged-in\'\n-        config = json.loads(view.js_build_config())\n-        self.assertEqual(config[\'paths\'][\'jquery\'], \'empty:\')\n-\n-\n-class DummyResource:\n-    def __init__(self, name):\n-        self.js = name\n-        self.css = [name, ]\n-\n-\n-class DummyBundle:\n-    def __init__(self, name, enabled=True):\n-        self.__prefix__ = \'test/\' + name\n-        self.compile = True\n-        self.conditionalcomment = None\n-        self.csscompilation = \'++resource++\' + name + \'.css\'\n-        self.depends = None\n-        self.enabled = enabled\n-        self.expression = None\n-        self.jscompilation = \'++resource++\' + name + \'.js\'\n-        self.last_compilation = \'123\'\n-        self.resources = []\n+    def test_bundle_depends_on_multiple(self):\n+        bundle = self._make_test_bundle()\n+        bundle.depends = "plone,eventedit"\n+        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n+        view.update()\n+        results = view.render()\n+        self.assertIn("http://foo.bar/foobar.js", results)\n \n+    def test_bundle_depends_on_missing(self):\n+        bundle = self._make_test_bundle()\n+        bundle.depends = "nonexistsinbundle"\n+        view = ScriptsView(self.app, self.app.REQUEST, None, None)\n+        view.update()\n+        results = view.render()\n+        # bundle should be skipped when rendering\n+        self.assertNotIn("http://foo.bar/foobar.js", results)\n \n-class TestScriptsViewlet(PloneTestCase.PloneTestCase):\n \n-    def test_scripts_viewlet(self):\n-        scripts = ScriptsView(\n-            self.layer[\'portal\'],\n-            self.layer[\'request\'],\n-            None\n-        )\n-        scripts.update()\n-        results = scripts.scripts()\n-        self.assertEqual(results[0][\'bundle\'], \'production\')\n-        self.assertTrue(results[0][\'src\'].startswith(\n-            \'http://nohost/plone/++plone++production/++unique++\'))\n-        self.assertTrue(results[0][\'src\'].endswith(\'/default.js\'))\n-        self.assertEqual(results[1][\'bundle\'], \'production\')\n-        self.assertTrue(results[1][\'src\'].startswith(\n-            \'http://nohost/plone/++plone++production/++unique++\'))\n-        self.assertTrue(results[1][\'src\'].endswith(\'/logged-in.js\'))\n-        self.assertEqual(len(results), 2)\n+class TestStylesViewlet(PloneTestCase.PloneTestCase):\n+    def test_styles_viewlet(self):\n+        styles = StylesView(self.layer["portal"], self.layer["request"], None)\n+        styles.update()\n+        results = styles.render()\n+        self.assertIn("++theme++barceloneta/css/barceloneta.min.css", results)\n+        self.assertIn("http://nohost/plone/++webresource++", results)\n \n-    def test_scripts_viewlet_anonymous(self):\n+    def test_styles_viewlet_anonymous(self):\n         logout()\n-        scripts = ScriptsView(\n-            self.layer[\'portal\'],\n-            self.layer[\'request\'],\n-            None\n-        )\n-        scripts.update()\n-        results = scripts.scripts()\n-        self.assertEqual(results[0][\'bundle\'], \'production\')\n-        self.assertTrue(results[0][\'src\'].startswith(\n-            \'http://nohost/plone/++plone++production/++unique++\'))\n-        self.assertTrue(results[0][\'src\'].endswith(\'/default.js\'))\n-        self.assertEqual(len(results), 1)\n-\n-    @mock.patch.object(\n-        ScriptsView,\n-        \'get_resources\',\n-        new=lambda self: {\'foo\': DummyResource(\'++resource++foo.js\')}\n-    )\n-    def test_request_resources(self):\n-        add_resource_on_request(self.layer[\'request\'], \'foo\')\n-        scripts = ScriptsView(\n-            self.layer[\'portal\'],\n-            self.layer[\'request\'],\n-            None\n-        )\n-        scripts.update()\n-        results = scripts.scripts()\n-        self.assertEqual(\n-            results[-1], {\'src\': \'http://nohost/plone/++resource++foo.js\',\n-                          \'conditionalcomment\': \'\',\n-                          \'resetrjs\': False,\n-                          \'bundle\': \'none\'})\n-\n-    def test_request_resources_not_add_same_twice(self):\n-        req = self.layer[\'request\']\n-        add_resource_on_request(req, \'foo\')\n-        add_resource_on_request(req, \'foo\')\n-\n-        self.assertEqual(len(req.enabled_resources), 1)\n+        styles = StylesView(self.layer["portal"], self.layer["request"], None)\n+        styles.update()\n+        results = styles.render()\n+        self.assertIn("++theme++barceloneta/css/barceloneta.min.css", results)\n+        self.assertIn("http://nohost/plone/++webresource++", results)\n \n     def test_request_bundles_not_add_same_twice(self):\n-        req = self.layer[\'request\']\n-        add_bundle_on_request(req, \'foo\')\n-        add_bundle_on_request(req, \'foo\')\n-\n+        req = self.layer["request"]\n+        add_bundle_on_request(req, "foo")\n+        add_bundle_on_request(req, "foo")\n         self.assertEqual(len(req.enabled_bundles), 1)\n \n-    @mock.patch.object(\n-        ScriptsView,\n-        \'get_bundles\',\n-        new=lambda self: {\'foo\': Bundle(DummyBundle(\'foo\', enabled=False))}\n-    )\n     def test_add_bundle_on_request_with_subrequest(self):\n-        req = self.layer[\'request\']\n+        # request\n+        req = self.layer["request"]\n \n         # create a subrequest.\n         subreq = req.clone()\n-        subreq[\'PARENT_REQUEST\'] = req\n+        subreq["PARENT_REQUEST"] = req\n \n         # add a bundle via the main request\n-        add_bundle_on_request(req, \'foo\')\n-\n-        scripts = ScriptsView(self.layer[\'portal\'], subreq, None)\n-\n-        # Send resource registry in development mode\n-        # Via a fake registry to allow accessing like this:\n-        # self.registry.records[\'plone.resources.development\'].value\n-        scripts.registry = type(\n-            \'reg\',\n-            (object, ),\n-            {\'records\': {\n-                \'plone.resources.development\': type(\n-                    \'val\',\n-                    (object, ),\n-                    {\'value\': True}\n-                )()\n-            }}\n-        )()\n-        self.assertTrue(scripts.development)\n+        add_bundle_on_request(req, "testbundle")\n+\n+        scripts = ScriptsView(self.layer["portal"], subreq, None)\n+\n+        # add some bundle to test with\n+        registry = getUtility(IRegistry)\n+        data = {\n+            "jscompilation": ("http://test.foo/test.min.js", regfield.TextLine()),\n+            "csscompilation": ("http://test.foo/test.css", regfield.TextLine()),\n+            "expression": ("", regfield.TextLine()),\n+            "enabled": (False, regfield.Bool()),\n+            "depends": ("", regfield.TextLine()),\n+            "load_async": (True, regfield.Bool()),\n+            "load_defer": (True, regfield.Bool()),\n+        }\n+        for key, regdef in data.items():\n+            record = Record(regdef[1])\n+            record.value = regdef[0]\n+            registry.records[f"plone.bundles/testbundle.{key}"] = record\n \n         scripts.update()\n-        result = scripts.scripts()[-1]\n-        self.assertEqual(\n-            result[\'src\'],\n-            \'http://nohost/plone/++resource++foo.js?version=123\'\n-        )\n-        self.assertEqual(\n-             result[\'conditionalcomment\'],\n-             None\n-        )\n-        self.assertEqual(\n-            result[\'bundle\'],\n-            \'foo\',\n-        )\n-        self.assertEqual(\n-            result[\'async\'],\n-            None\n-        )\n-        self.assertEqual(\n-            result[\'defer\'],\n-            None\n-        )\n+        result = scripts.render()\n+        self.assertIn("http://test.foo/test.min.js", result)\n \n-    @mock.patch.object(\n-        ScriptsView,\n-        \'get_bundles\',\n-        new=lambda self: {\'foo\': Bundle(DummyBundle(\'foo\', enabled=True))}\n-    )\n     def test_remove_bundle_on_request_with_subrequest(self):\n-        req = self.layer[\'request\']\n+        # request\n+        req = self.layer["request"]\n \n         # create a subrequest.\n         subreq = req.clone()\n-        subreq[\'PARENT_REQUEST\'] = req\n-\n-        # remove the enabled \'foo\' bundle\n-        remove_bundle_on_request(req, \'foo\')\n-\n-        scripts = ScriptsView(self.layer[\'portal\'], subreq, None)\n-\n-        # Send resource registry in development mode\n-        # Via a fake registry to allow accessing like this:\n-        # self.registry.records[\'plone.resources.development\'].value\n-        scripts.registry = type(\n-            \'reg\',\n-            (object, ),\n-            {\'records\': {\n-                \'plone.resources.development\': type(\n-                    \'val\',\n-                    (object, ),\n-                    {\'value\': True}\n-                )()\n-            }}\n-        )()\n-        self.assertTrue(scripts.development)\n+        subreq["PARENT_REQUEST"] = req\n \n-        scripts.update()\n-        results = scripts.scripts()\n-        self.assertEqual(\n-            [i for i in results if \'foo\' in i[\'src\']],\n-            []\n-        )\n+        # remove a bundle via the main request\n+        remove_bundle_on_request(req, "testbundle")\n \n-    @mock.patch.object(\n-        ScriptsView,\n-        \'get_resources\',\n-        new=lambda self: {\'foo\': DummyResource(\'++resource++foo.js\')}\n-    )\n-    @mock.patch.object(\n-        StylesView,\n-        \'get_resources\',\n-        new=lambda self: {\'foo\': DummyResource(\'++resource++foo.css\')}\n-    )\n-    def test_add_resource_on_request_with_subrequest(self):\n-        """Check, if a resource added at a main request is picked up from a\n-        subrequest for creating the header scripts section.\n-        """\n-        req = self.layer[\'request\']\n+        scripts = ScriptsView(self.layer["portal"], subreq, None)\n+\n+        # add some bundle to test with\n+        registry = getUtility(IRegistry)\n+        data = {\n+            "jscompilation": ("http://test.foo/test.min.js", regfield.TextLine()),\n+            "csscompilation": ("http://test.foo/test.css", regfield.TextLine()),\n+            "expression": ("", regfield.TextLine()),\n+            "enabled": (True, regfield.Bool()),\n+            "depends": ("", regfield.TextLine()),\n+            "load_async": (True, regfield.Bool()),\n+            "load_defer": (True, regfield.Bool()),\n+        }\n+        for key, regdef in data.items():\n+            record = Record(regdef[1])\n+            record.value = regdef[0]\n+            registry.records[f"plone.bundles/testbundle.{key}"] = record\n+\n+        scripts.update()\n+        result = scripts.render()\n+        self.assertNotIn("http://test.foo/test.min.js", result)\n \n-        # create a subrequest.\n-        subreq = req.clone()\n-        subreq[\'PARENT_REQUEST\'] = req\n \n-        # add a resource to main request\n-        add_resource_on_request(req, \'foo\')\n+class TestExpressions(PloneTestCase.PloneTestCase):\n \n-        scripts = ScriptsView(self.layer[\'portal\'], subreq, None)\n+    def setUp(self):\n+        # Add three bundles with three different expressions.\n+        registry = getUtility(IRegistry)\n+        data = {\n+            "jscompilation": ("http://test.foo/test.min.js", regfield.TextLine()),\n+            "csscompilation": ("http://test.foo/test.css", regfield.TextLine()),\n+            "expression": ("python: False", regfield.TextLine()),\n+            "enabled": (True, regfield.Bool()),\n+            "depends": ("", regfield.TextLine()),\n+            "load_async": (True, regfield.Bool()),\n+            "load_defer": (True, regfield.Bool()),\n+        }\n+        for key, regdef in data.items():\n+            record = Record(regdef[1])\n+            record.value = regdef[0]\n+            registry.records[f"plone.bundles/testbundle.{key}"] = record\n+\n+        data = {\n+            "jscompilation": ("http://test2.foo/member.min.js", regfield.TextLine()),\n+            "csscompilation": ("http://test2.foo/member.css", regfield.TextLine()),\n+            "expression": ("python: member is not None", regfield.TextLine()),\n+            "enabled": (True, regfield.Bool()),\n+            "depends": ("", regfield.TextLine()),\n+            "load_async": (True, regfield.Bool()),\n+            "load_defer": (True, regfield.Bool()),\n+        }\n+        for key, regdef in data.items():\n+            record = Record(regdef[1])\n+            record.value = regdef[0]\n+            registry.records[f"plone.bundles/testbundle2.{key}"] = record\n+\n+        data = {\n+            "jscompilation": ("http://test3.foo/test.min.js", regfield.TextLine()),\n+            "csscompilation": ("http://test3.foo/test.css", regfield.TextLine()),\n+            "expression": ("python: True", regfield.TextLine()),\n+            "enabled": (True, regfield.Bool()),\n+            "depends": ("", regfield.TextLine()),\n+            "load_async": (True, regfield.Bool()),\n+            "load_defer": (True, regfield.Bool()),\n+        }\n+        for key, regdef in data.items():\n+            record = Record(regdef[1])\n+            record.value = regdef[0]\n+            registry.records[f"plone.bundles/testbundle3.{key}"] = record\n+\n+    def test_styles_authenticated(self):\n+        styles = StylesView(self.layer["portal"], self.layer["request"], None)\n+        styles.update()\n+        results = styles.render()\n+        # Check that standard resources are still there, signalling that\n+        # rendering works without throwing an exception.\n+        self.assertIn("++theme++barceloneta/css/barceloneta.min.css", results)\n+        self.assertIn("http://nohost/plone/++webresource++", results)\n+        # Test our additional bundles.\n+        # self.assertNotIn("http://test.foo/test.css", results)\n+        self.assertIn("http://test2.foo/member.css", results)\n+        self.assertIn("http://test3.foo/test.css", results)\n+\n+    def test_styles_anonymous(self):\n+        logout()\n+        styles = StylesView(self.layer["portal"], self.layer["request"], None)\n+        styles.update()\n+        results = styles.render()\n+        # Check that standard resources are still there, signalling that\n+        # rendering works without throwing an exception.\n+        self.assertIn("++theme++barceloneta/css/barceloneta.min.css", results)\n+        self.assertIn("http://nohost/plone/++webresource++", results)\n+        # Test our additional bundles.\n+        # self.assertNotIn("http://test.foo/test.css", results)\n+        self.assertNotIn("http://test2.foo/member.css", results)\n+        self.assertIn("http://test3.foo/test.css", results)\n+\n+    def test_scripts_authenticated(self):\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n         scripts.update()\n-        results = scripts.scripts()\n-        self.assertEqual(\n-            results[-1],\n-            {\n-                \'src\': \'http://nohost/plone/++resource++foo.js\',\n-                \'conditionalcomment\': \'\',\n-                \'resetrjs\': False,\n-                \'bundle\': \'none\',\n-            }\n+        results = scripts.render()\n+        # Check that standard resources are still there, signalling that\n+        # rendering works without throwing an exception.\n+        self.assertIn("++plone++static/bundle-plone/bundle.min.js", results)\n+        # The first one should be included, the second one not.\n+        # self.assertNotIn("http://test.foo/test.min.js", results)\n+        self.assertIn("http://test2.foo/member.min.js", results)\n+        self.assertIn("http://test3.foo/test.min.js", results)\n+\n+    def test_scripts_anonymous(self):\n+        logout()\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        scripts.update()\n+        results = scripts.render()\n+        # Check that standard resources are still there, signalling that\n+        # rendering works without throwing an exception.\n+        self.assertIn("++plone++static/bundle-plone/bundle.min.js", results)\n+        # The first one should be included, the second one not.\n+        # self.assertNotIn("http://test.foo/test.min.js", results)\n+        self.assertNotIn("http://test2.foo/member.min.js", results)\n+        self.assertIn("http://test3.foo/test.min.js", results)\n+\n+\n+class TestRRControlPanel(PloneTestCase.PloneTestCase):\n+\n+    def setUp(self):\n+        self.portal = self.layer[\'portal\']\n+        self.app = self.layer[\'app\']\n+        self.browser = Browser(self.app)\n+        self.browser.handleErrors = False\n+        self.browser.addHeader(\n+            \'Authorization\',\n+            f\'Basic {SITE_OWNER_NAME}:{SITE_OWNER_PASSWORD}\'\n+        )\n+        self.browser.open(self.portal.absolute_url() + "/@@resourceregistry-controlpanel")\n+\n+    def test_controlpanel(self):\n+        self.assertIn("<h1 class=\\"documentFirstHeading\\">Resource Registry</h1>", self.browser.contents)\n+        self.assertIn("++plone++static/bundle-plone/bundle.min.js", self.browser.contents)\n+\n+    def test_add_resource(self):\n+        # the last form is the add form\n+        add_form = self.browser.getForm(index=5)\n+        add_form.getControl(name="name").value = "my-resource"\n+        add_form.getControl(name="jscompilation").value = "++resource++my.resource.js"\n+        add_form.getControl(name="enabled").value = "checked"\n+        add_form.getControl("add").click()\n+\n+        self.assertIn(\n+            "<h2 class=\\"accordion-header\\" id=\\"heading-my-resource\\">",\n+            self.browser.contents,\n         )\n \n-        styles = StylesView(self.layer[\'portal\'], subreq, None)\n-        styles.update()\n-        results = styles.styles()\n-        self.assertListEqual(\n-            list(filter(lambda it: \'foo\' in it[\'src\'], results)),\n-            [{\n-                \'src\': \'http://nohost/plone/++resource++foo.css\',\n-                \'conditionalcomment\': \'\',\n-                \'rel\': \'stylesheet\',\n-                \'bundle\': \'none\',\n-            }]\n+    def test_update_resource(self):\n+        # try to set already existing name should fail\n+        form = self.browser.getForm(index=4)\n+        form.getControl(name="name").value = "plone"\n+        form.getControl("update").click()\n+\n+        self.assertIn("Record name plone already taken.", self.browser.contents)\n+\n+        # set new name\n+        form = self.browser.getForm(index=4)\n+        form.getControl(name="name").value = "new-resource-name"\n+        form.getControl("update").click()\n+\n+        self.assertIn(\n+             "<h2 class=\\"accordion-header\\" id=\\"heading-new-resource-name\\">",\n+            self.browser.contents,\n         )\ndiff --git a/Products/CMFPlone/tests/testSearch.py b/Products/CMFPlone/tests/testSearch.py\nindex e331876b9e..0e6f786e55 100644\n--- a/Products/CMFPlone/tests/testSearch.py\n+++ b/Products/CMFPlone/tests/testSearch.py\n@@ -11,7 +11,7 @@\n from zope.component import getUtility\n from plone.registry.interfaces import IRegistry\n \n-from Products.CMFPlone.interfaces import ISearchSchema\n+from plone.base.interfaces import ISearchSchema\n \n from plone.app.contentlisting.interfaces import IContentListing\n from plone.app.textfield import RichTextValue\n@@ -27,7 +27,6 @@\n from plone.app.testing import applyProfile\n from plone.app.testing import PLONE_FIXTURE\n from plone.app.testing import IntegrationTesting\n-from plone.testing import z2\n \n \n def test_request():\n@@ -257,6 +256,110 @@ def test_filter_with_plone3_query(self):\n         res = view.results(batch=False)\n         self.assertEqual([], [r for r in res])\n \n+    def test_quoted_phrase(self):\n+        portal = self.layer[\'portal\']\n+        # searching for ""\n+        view = portal.restrictedTraverse(\'@@search\')\n+        # unqoted\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'spam ham\')).sequence_length, 12)\n+        # quoted -> same result\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'"spam ham"\')).sequence_length, 12)\n+        # unquoted reverse order -> all results\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'ham spam\')).sequence_length, 12)\n+        # quoted reverse order -> no results!\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'"ham spam"\')).sequence_length, 0)\n+\n+        # arbitrary words within index\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'spam eggs\')).sequence_length, 12)\n+        # arbitrary words within index quoted -> no results\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'"spam eggs"\')).sequence_length, 0)\n+\n+        # unquoted subtring search\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'egg\')).sequence_length, 12)\n+        # quoted substring search -> exact match\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'"egg"\')).sequence_length, 0)\n+\n+        # unquoted multi substring search\n+        # XXX: this is munged to "egg AND spa*" and doesn\'t find any results\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'egg spa\')).sequence_length, 0)\n+\n+        # weird input\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'"eggs" ham spam\')).sequence_length, 12)\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'"eggs ham spam\')).sequence_length, 12)\n+        self.assertEqual(view.results(\n+            query=dict(SearchableText=\'eggs ham spam"\')).sequence_length, 12)\n+\n+    def test_munge_search_term(self):\n+        from Products.CMFPlone.browser.search import BAD_CHARS\n+        from Products.CMFPlone.browser.search import munge_search_term\n+\n+        search_term_tests = [\n+            (\n+                # search term\n+                \'spam ham\',\n+                \'spam AND ham*\',\n+            ),\n+            (\n+                # quoted term\n+                \'"spam ham"\',\n+                \'"spam ham"\',\n+            ),\n+            (\n+                # cleanup quoted terms\n+                \'" spam ham   "\',\n+                \'"spam ham"\',\n+            ),\n+            (\n+                # mixed cases\n+                \'Spam hAm\',\n+                \'Spam AND hAm*\',\n+            ),\n+            (\n+                # mix quoting and unquoted\n+                \'let\\\'s eat some "ham and eggs " without spam \',\n+                \'"ham and eggs" AND let\\\'s AND eat AND some \'\n+                \'AND without AND spam*\',\n+            ),\n+            (\n+                \'test "Welcome" to "Plone" retest\',\n+                \'"Welcome" AND "Plone" AND test AND to AND retest*\',\n+            ),\n+            (\n+                # parentheses\n+                \'spam (ham)\',\n+                \'spam AND "("ham")"*\',\n+            ),\n+            (\n+                # special keywords\n+                \'spam or not ham and eggs\',\n+                \'spam AND "or" AND "not" AND ham AND "and" AND eggs*\',\n+            ),\n+            (\n+                # bad characters\n+                " ".join(BAD_CHARS),\n+                "",\n+            ),\n+            (\n+                # weird input\n+                \'test ""Welcome" to "Plone"" retest\',\n+                \'"to" AND test AND WelcomePlone AND retest*\',\n+            )\n+        ]\n+\n+        for _in, _out in search_term_tests:\n+            self.assertEqual(munge_search_term(_in), _out)\n+\n \n def test_suite():\n     """This sets up a test suite that actually runs the tests in the class\ndiff --git a/Products/CMFPlone/tests/testSecurity.py b/Products/CMFPlone/tests/testSecurity.py\nindex e254ab3b1d..5286d8ee2a 100644\n--- a/Products/CMFPlone/tests/testSecurity.py\n+++ b/Products/CMFPlone/tests/testSecurity.py\n@@ -1,10 +1,19 @@\n from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n from Testing.makerequest import makerequest\n+from plone.app.testing import login\n+from plone.app.testing import logout\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.testing.zope import Browser\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n+from Testing.makerequest import makerequest\n+from zExceptions import NotFound\n from zExceptions import Unauthorized\n \n import re\n+import transaction\n import unittest\n \n \n@@ -133,3 +142,127 @@ def test_formatColumns(self):\n         # formatColumns is unused and was removed\n         res = self.publish(\'/plone/formatColumns?items:list=\')\n         self.assertIn(res.status, [403, 404])\n+\n+\n+class TestFunctional(unittest.TestCase):\n+    # The class above is rather old-style.\n+    # Let\'s try a more modern approach, with a layer.\n+    layer = PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n+    def get_admin_browser(self):\n+        browser = Browser(self.layer["app"])\n+        browser.handleErrors = False\n+        browser.addHeader(\n+            "Authorization",\n+            "Basic {0}:{1}".format(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),\n+        )\n+        return browser\n+\n+    def test_plonetool(self):\n+        portal_url = self.layer["portal"].absolute_url()\n+        base_url = portal_url + "/plone_utils"\n+        browser = self.get_admin_browser()\n+        method_names = (\n+            "addPortalMessage",\n+            "browserDefault",\n+            "getReviewStateTitleFor",\n+            "portal_utf8",\n+            "urlparse",\n+            "urlunparse",\n+            "utf8_portal",\n+            "getOwnerName",\n+            "normalizeString",\n+            "getEmptyTitle",\n+        )\n+        # First open a url that actually works.\n+        # This avoids an error with zope.component 5+.\n+        browser.open(portal_url)\n+        for method_name in method_names:\n+            with self.assertRaises(NotFound):\n+                browser.open(base_url + "/" + method_name)\n+\n+    def test_hotfix_20160419(self):\n+        """Test old hotfix.\n+\n+        CMFPlone has patches/publishing.py, containing\n+        the publishing patch from Products.PloneHotfix20160419.\n+        This avoids publishing some methods inherited from Zope or CMF,\n+        which upstream does not want to fix, considering it no problem\n+        to have these methods available.  I can imagine that.\n+        But in Plone we have decided otherwise.\n+\n+        Problem: the patch did not work on Python 3.\n+        This was fixed in hotfix 20210518.\n+        """\n+        portal = self.layer["portal"]\n+        portal.invokeFactory("Document", "doc")\n+        transaction.commit()\n+        portal_url = portal.absolute_url()\n+        doc_url = portal.doc.absolute_url()\n+        browser = self.get_admin_browser()\n+        method_names = (\n+            "EffectiveDate",\n+            "ExpirationDate",\n+            "getAttributes",\n+            "getChildNodes",\n+            "getFirstChild",\n+            "getLastChild",\n+            "getLayout",\n+            "getNextSibling",\n+            "getNodeName",\n+            "getNodeType",\n+            "getNodeValue",\n+            "getOwnerDocument",\n+            "getParentNode",\n+            "getPhysicalPath",\n+            "getPreviousSibling",\n+            "getTagName",\n+            "hasChildNodes",\n+            "Type",\n+            # From PropertyManager:\n+            "getProperty",\n+            "propertyValues",\n+            "propertyItems",\n+            "propertyMap",\n+            "hasProperty",\n+            "getPropertyType",\n+            "propertyIds",\n+            "propertyLabel",\n+            "propertyDescription",\n+        )\n+        # First open a url that actually works.\n+        # This avoids an error with zope.component 5+.\n+        browser.open(portal_url)\n+        for method_name in method_names:\n+            with self.assertRaises(NotFound):\n+                browser.open(portal_url + "/" + method_name)\n+            with self.assertRaises(NotFound):\n+                browser.open(doc_url + "/" + method_name)\n+\n+    def test_quick_installer_security(self):\n+        # Products.CMFQuickInstallerTool has a fix.\n+        # But CMFPlone overrides the tool class, so let\'s check.\n+        portal = self.layer["portal"]\n+        qi = getToolByName(portal, "portal_quickinstaller", None)\n+        if qi is None:\n+            return\n+\n+        # Make sure we are anonymous.\n+        logout()\n+        logout()\n+        # Unrestricted traversal should work, restricted not.\n+        qi = portal.unrestrictedTraverse("portal_quickinstaller")\n+        with self.assertRaises(Unauthorized):\n+            portal.restrictedTraverse("portal_quickinstaller")\n+        for obj_id in qi.objectIds():\n+            qi.unrestrictedTraverse(obj_id)\n+            with self.assertRaises(Unauthorized):\n+                qi.restrictedTraverse(obj_id)\n+\n+        # Authenticated with role Manager, we can view whatever we want.\n+        login(portal, SITE_OWNER_NAME)\n+        qi = portal.unrestrictedTraverse("portal_quickinstaller")\n+        qi = portal.restrictedTraverse("portal_quickinstaller")\n+        for obj_id in qi.objectIds():\n+            qi.unrestrictedTraverse(obj_id)\n+            qi.restrictedTraverse(obj_id)\ndiff --git a/Products/CMFPlone/tests/testSyndication.py b/Products/CMFPlone/tests/testSyndication.py\nindex 88da13ded3..4dd52fe92a 100644\n--- a/Products/CMFPlone/tests/testSyndication.py\n+++ b/Products/CMFPlone/tests/testSyndication.py\n@@ -3,12 +3,12 @@\n from AccessControl import Unauthorized\n from plone.app.textfield import RichTextValue\n from Products.CMFPlone.tests import PloneTestCase\n-from Products.CMFPlone.interfaces.syndication import IFeedSettings\n-from Products.CMFPlone.interfaces.syndication import ISiteSyndicationSettings\n+from plone.base.interfaces.syndication import IFeedSettings\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\n from zExceptions import NotFound\n-from Products.CMFPlone.interfaces.syndication import IFeed\n+from plone.base.interfaces.syndication import IFeed\n from Products.CMFPlone.browser.syndication.adapters import DexterityItem\n \n \ndiff --git a/Products/CMFPlone/tests/testURLTool.py b/Products/CMFPlone/tests/testURLTool.py\nindex 78d38eb845..a84271b953 100644\n--- a/Products/CMFPlone/tests/testURLTool.py\n+++ b/Products/CMFPlone/tests/testURLTool.py\n@@ -6,7 +6,7 @@\n \n from Acquisition import aq_parent\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import ILoginSchema\n+from plone.base.interfaces import ILoginSchema\n from zope.component import getSiteManager\n \n \ndiff --git a/Products/CMFPlone/tests/testWebDAV.py b/Products/CMFPlone/tests/testWebDAV.py\nindex 63ca592faa..7ab89b0644 100644\n--- a/Products/CMFPlone/tests/testWebDAV.py\n+++ b/Products/CMFPlone/tests/testWebDAV.py\n@@ -303,8 +303,6 @@ def testPUTIndexHtml(self):\n     def testPUTIndexHtmlIntoPortal(self):\n         # Create an index_html document in the portal via FTP/DAV\n         self.assertFalse(\'index_html\' in self.portal)\n-        self.assertEqual(self.portal.index_html.meta_type,\n-                         \'Filesystem Page Template\')\n         self.setRoles([\'Manager\'])\n \n         response = self.publish(\ndiff --git a/Products/CMFPlone/tests/test_defaultpage.py b/Products/CMFPlone/tests/test_defaultpage.py\nindex 1bab2cbc4b..9b4e86fe11 100644\n--- a/Products/CMFPlone/tests/test_defaultpage.py\n+++ b/Products/CMFPlone/tests/test_defaultpage.py\n@@ -3,6 +3,7 @@\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+\n import unittest\n \n \n@@ -22,7 +23,7 @@ def test_get_default_page_step_1(self):\n         self.folder.setDefaultPage(\'d1\')\n         self.folder.invokeFactory(\'Document\', \'index_html\', title="Doc 2")\n \n-        from Products.CMFPlone.defaultpage import get_default_page\n+        from plone.base.defaultpage import get_default_page\n         self.assertEqual(\'index_html\', get_default_page(self.folder))\n \n     def test_get_default_page_step_2(self):\n@@ -55,7 +56,7 @@ def test_get_default_page_step_2(self):\n         )\n \n         # now test since we\'re sure everythings set up correctly\n-        from Products.CMFPlone.defaultpage import get_default_page\n+        from plone.base.defaultpage import get_default_page\n         self.assertEqual(\'d1\', get_default_page(self.folder))\n \n         # missing here:\n@@ -67,7 +68,7 @@ def test_get_default_page_step_3_1(self):\n         #    acquisition in place\n         # 3.1 look for a content in the container with the id, no acquisition!\n         self.folder.invokeFactory(\'Document\', \'d1\', title="Doc 1")\n-        from Products.CMFPlone.defaultpage import get_default_page\n+        from plone.base.defaultpage import get_default_page\n \n         # set doc d1 must work\n         self.folder.default_page = \'d1\'\n@@ -97,17 +98,11 @@ def test_get_default_page_step_3_2(self):\n         # 3.2 look for a content at portal, with acquisition\n         self.portal.invokeFactory(\'Document\', \'d1\', title="Doc 1")\n         self.folder.default_page = \'d1\'\n-        from Products.CMFPlone.defaultpage import get_default_page\n+        from plone.base.defaultpage import get_default_page\n \n         # now it must acquire from portal\n         self.assertEqual(\'d1\', get_default_page(self.folder))\n \n-        # fetch from i.e. portal_skins by acquisition\n-        # test_rendering.pt is in portal_skins/plone_templates and so available\n-        # by acquisition\n-        self.folder.default_page = \'test_rendering\'\n-        self.assertEqual(\'test_rendering\', get_default_page(self.folder))\n-\n     def test_get_default_page_step_4(self):\n         # 4. Else, look up the property default_page in site_properties for\n         #   magic ids and test these\n@@ -115,5 +110,5 @@ def test_get_default_page_step_4(self):\n         registry[\'plone.default_page\'] = [\'d1\']\n         self.folder.invokeFactory(\'Document\', \'d1\', title="Doc 1")\n \n-        from Products.CMFPlone.defaultpage import get_default_page\n+        from plone.base.defaultpage import get_default_page\n         self.assertEqual(\'d1\', get_default_page(self.folder))\ndiff --git a/Products/CMFPlone/tests/test_doctests.py b/Products/CMFPlone/tests/test_doctests.py\nindex 14c5b17659..3c2a3596b8 100644\n--- a/Products/CMFPlone/tests/test_doctests.py\n+++ b/Products/CMFPlone/tests/test_doctests.py\n@@ -1,24 +1,9 @@\n from unittest import TestSuite\n \n import doctest\n-import re\n-\n-\n-class Py23DocChecker(doctest.OutputChecker):\n-\n-    def check_output(self, want, got, optionflags):\n-        # TODO: Fix tests to check Python 3 style\n-        want = re.sub("u\'(.*?)\'", "\'\\\\1\'", want)\n-        return doctest.OutputChecker.check_output(self, want, got, optionflags)\n-\n \n def test_suite():\n     suites = (\n-        doctest.DocFileSuite(\n-            \'messages.txt\',\n-            package=\'Products.CMFPlone.tests\',\n-            checker=Py23DocChecker(),\n-            ),\n         doctest.DocTestSuite(\'Products.CMFPlone.TranslationServiceTool\'),\n         doctest.DocTestSuite(\'Products.CMFPlone.utils\'),\n         doctest.DocTestSuite(\'Products.CMFPlone.workflow\'),\ndiff --git a/Products/CMFPlone/tests/test_expressions.py b/Products/CMFPlone/tests/test_expressions.py\nnew file mode 100644\nindex 0000000000..9d950fae46\n--- /dev/null\n+++ b/Products/CMFPlone/tests/test_expressions.py\n@@ -0,0 +1,270 @@\n+# -*- coding: utf-8 -*-\n+from AccessControl.class_init import InitializeClass\n+from AccessControl.Permissions import view_management_screens\n+from AccessControl.SecurityInfo import ClassSecurityInfo\n+from OFS.SimpleItem import SimpleItem\n+from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+# Expressions.boboAwareZopeTraverse is a function\n+# expression(s).BoboAwareZopeTraverse is a class\n+# Import them with names that are easier to tell apart.\n+from Products.PageTemplates.expression import BoboAwareZopeTraverse as TraverseClass\n+from Products.PageTemplates.expression import TrustedBoboAwareZopeTraverse as TrustedTraverseClass\n+from Products.PageTemplates.Expressions import boboAwareZopeTraverse as traverse_function\n+from Products.PageTemplates.Expressions import trustedBoboAwareZopeTraverse as trusted_traverse_function\n+from Products.PageTemplates.PageTemplateFile import PageTemplateFile\n+from zExceptions import NotFound\n+from zExceptions import Unauthorized\n+\n+import AccessControl\n+import os\n+import random\n+import re\n+import string\n+import sys\n+import unittest\n+\n+\n+# Path of this directory:\n+path = os.path.dirname(__file__)\n+\n+\n+class DummyView(object):\n+\n+    __name__ = "dummy-view"\n+    _authenticator = "secret"\n+    _ = "translation"\n+    # Even via weird names, some items should not be reachable:\n+    os_hack = os\n+    sys_hack = sys\n+    Formatter_hack = string.Formatter\n+\n+\n+class DummyContent(SimpleItem):\n+    """Dummy content class to show the (un)restrictedTraverse works."""\n+    security = ClassSecurityInfo()\n+\n+    @security.public\n+    def public(self):\n+        """Public method"""\n+        return "I am public"\n+\n+    @security.private\n+    def private(self):\n+        """Private method"""\n+        return "I am private"\n+\n+    @security.protected(view_management_screens)\n+    def protected(self):\n+        """Protected method"""\n+        return "I am protected"\n+\n+\n+InitializeClass(DummyContent)\n+\n+\n+class TestAttackVector(unittest.TestCase):\n+    layer = PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n+    def _makeOne(self, name):\n+        return PageTemplateFile(os.path.join(path, name)).__of__(self.layer["portal"])\n+\n+    def test_template_bad1(self):\n+        template = self._makeOne("bad1.pt")\n+        # In some versions, random is not globally available, so we get a NameError.\n+        # Otherwise our patch should make sure we get a NotFound.\n+        with self.assertRaises((NotFound, NameError)):\n+            template()\n+\n+    def test_template_bad2(self):\n+        template = self._makeOne("bad2.pt")\n+        with self.assertRaises(NotFound):\n+            template()\n+\n+    def test_template_bad3(self):\n+        template = self._makeOne("bad3.pt")\n+        with self.assertRaises(NotFound):\n+            template()\n+\n+    def test_template_single_underscore(self):\n+        # Allow accessing \'_\' in a skin template or TTW template.\n+        # In the merge of the hotfix, Zope allows this, to avoid a test failure.\n+        template = self._makeOne("options_underscore.pt")\n+        # Pass view in the options.\n+        self.assertIn("translation", template(view=DummyView()))\n+\n+    def test_browser_template_with_name(self):\n+        # Allow accessing __name__ in a browser view template.\n+        browser = Browser(self.layer["app"])\n+        browser.handleErrors = False\n+        browser.open(self.layer["portal"].absolute_url() + "/hotfix-testing-view-name")\n+        self.assertIn("<h1>hotfix-testing-view-name</h1>", browser.contents)\n+\n+    def test_template_accesscontrol_sm(self):\n+        # Only AccessControl.getSecurityManager is allowed.\n+        template = self._makeOne("accesscontrol_sm.pt")\n+        self.assertIn("getSecurityManager is allowed", template())\n+\n+    def test_template_accesscontrol_direct(self):\n+        # Via AccessControl you can access too much.\n+        template = self._makeOne("accesscontrol_direct.pt")\n+        with self.assertRaises(NotFound):\n+            template()\n+\n+    def test_template_accesscontrol_via_modules(self):\n+        template = self._makeOne("accesscontrol_via_modules.pt")\n+        with self.assertRaises(NotFound):\n+            template()\n+\n+    def test_template_accesscontrol_via_dict(self):\n+        template = self._makeOne("accesscontrol_via_dict.pt")\n+        with self.assertRaises(NotFound):\n+            template()\n+\n+\n+class TestDirectAttackVector(unittest.TestCase):\n+    layer = PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n+    def test_traverse_function_random(self):\n+        with self.assertRaises(NotFound):\n+            traverse_function(random, ("_os", "system"), None)\n+        # trusted traverse should work fine\n+        result = trusted_traverse_function(random, ("_os", "system"), None)\n+        self.assertEqual(result, os.system)\n+\n+    def test_traverse_function_string(self):\n+        with self.assertRaises(NotFound):\n+            traverse_function(string, ("_re", "purge"), None)\n+        result = trusted_traverse_function(string, ("_re", "purge"), None)\n+        self.assertEqual(result, re.purge)\n+\n+    def test_traverse_function_formatter(self):\n+        with self.assertRaises(NotFound):\n+            traverse_function(string, ("Formatter",), None)\n+        result = trusted_traverse_function(string, ("Formatter",), None)\n+        self.assertEqual(result, string.Formatter)\n+\n+    def test_traverse_function_formatter_get_field(self):\n+        with self.assertRaises(NotFound):\n+            traverse_function(string, ("Formatter", "get_field"), None)\n+        result = trusted_traverse_function(string, ("Formatter", "get_field"), None)\n+        self.assertEqual(result, string.Formatter.get_field)\n+\n+    def test_traverse_function_hacked_names(self):\n+        view = DummyView()\n+        with self.assertRaises(NotFound):\n+            traverse_function(view, ("os_hack",), None)\n+        with self.assertRaises(NotFound):\n+            traverse_function(view, ("sys_hack",), None)\n+        with self.assertRaises(NotFound):\n+            traverse_function(view, ("Formatter_hack",), None)\n+        result = trusted_traverse_function(view, ("os_hack",), None)\n+        self.assertEqual(result, os)\n+        result = trusted_traverse_function(view, ("sys_hack",), None)\n+        self.assertEqual(result, sys)\n+        result = trusted_traverse_function(view, ("Formatter_hack",), None)\n+        self.assertEqual(result, string.Formatter)\n+\n+    def test_traverse_function_single_underscore(self):\n+        # We allow access to \'_\' always as a special case.\n+        view = DummyView()\n+        self.assertEqual(traverse_function(view, ("_",), None), "translation")\n+        self.assertEqual(trusted_traverse_function(view, ("_",), None), "translation")\n+\n+    def test_traverse_function_content(self):\n+        content = DummyContent("dummy")\n+        self.assertEqual(traverse_function(content, ("public",), None)(), "I am public")\n+        with self.assertRaises(Unauthorized):\n+            traverse_function(content, ("private",), None)\n+        with self.assertRaises(Unauthorized):\n+            traverse_function(content, ("protected",), None)\n+\n+        self.assertEqual(trusted_traverse_function(content, ("public",), None)(), "I am public")\n+        self.assertEqual(trusted_traverse_function(content, ("private",), None)(), "I am private")\n+        self.assertEqual(trusted_traverse_function(content, ("protected",), None)(), "I am protected")\n+\n+    def test_traverse_function_accesscontrol_getSecurityManager(self):\n+        # Only getSecurityManager is allowed.\n+        self.assertEqual(traverse_function(AccessControl, ("getSecurityManager",), None), AccessControl.getSecurityManager)\n+        self.assertEqual(trusted_traverse_function(AccessControl, ("getSecurityManager",), None), AccessControl.getSecurityManager)\n+\n+    def test_traverse_function_accesscontrol_direct(self):\n+        with self.assertRaises(NotFound):\n+            traverse_function(AccessControl, ("SecurityManagement",), None)\n+        self.assertEqual(trusted_traverse_function(AccessControl, ("SecurityManagement",), None), AccessControl.SecurityManagement)\n+\n+    def test_traverse_function_accesscontrol_via_modules(self):\n+        from Products.PageTemplates.ZRPythonExpr import _SecureModuleImporter\n+\n+        modules = _SecureModuleImporter()\n+        with self.assertRaises(NotFound):\n+            traverse_function(modules, ("AccessControl", "users"), None)\n+        self.assertEqual(trusted_traverse_function(modules, ("AccessControl", "users"), None), AccessControl.users)\n+\n+    def test_traverse_function_accesscontrol_via_dict(self):\n+        piggyback = {"unsafe": AccessControl}\n+        with self.assertRaises(NotFound):\n+            traverse_function(piggyback, ("unsafe", "users"), None)\n+        self.assertEqual(trusted_traverse_function(piggyback, ("unsafe", "users"), None), AccessControl.users)\n+\n+    def test_traverse_class_random(self):\n+        with self.assertRaises(NotFound):\n+            # Note: here the second argument is the request.  None works in the tests.\n+            TraverseClass.traverse(random, None, ("_os", "system"))\n+        # trusted traverse should work fine\n+        result = TrustedTraverseClass.traverse(random, None, ("_os", "system"))\n+        self.assertEqual(result, os.system)\n+\n+    def test_traverse_class_string(self):\n+        with self.assertRaises(NotFound):\n+            TraverseClass.traverse(string, None, ("_re", "purge"))\n+        result = TrustedTraverseClass.traverse(string, None, ("_re", "purge"))\n+        self.assertEqual(result, re.purge)\n+\n+    def test_traverse_class_formatter(self):\n+        with self.assertRaises(NotFound):\n+            TraverseClass.traverse(string, None, ("Formatter",))\n+        result = TrustedTraverseClass.traverse(string, None, ("Formatter",))\n+        self.assertEqual(result, string.Formatter)\n+\n+    def test_traverse_class_formatter_get_field(self):\n+        with self.assertRaises(NotFound):\n+            TraverseClass.traverse(string, None, ("Formatter", "get_field"))\n+        result = TrustedTraverseClass.traverse(string, None, ("Formatter", "get_field"))\n+        self.assertEqual(result, string.Formatter.get_field)\n+\n+    def test_traverse_class_content(self):\n+        content = DummyContent("dummy")\n+        self.assertEqual(TraverseClass.traverse(content, None, ("public",))(), "I am public")\n+        with self.assertRaises(Unauthorized):\n+            TraverseClass.traverse(content, None, ("private",))\n+        with self.assertRaises(Unauthorized):\n+            TraverseClass.traverse(content, None, ("protected",))\n+\n+        self.assertEqual(TrustedTraverseClass.traverse(content, None, ("public",))(), "I am public")\n+        self.assertEqual(TrustedTraverseClass.traverse(content, None, ("private",))(), "I am private")\n+        self.assertEqual(TrustedTraverseClass.traverse(content, None, ("protected",))(), "I am protected")\n+\n+    def test_traverse_class_accesscontrol_getSecurityManager(self):\n+        # AccessControl.getSecurityManager is the only item allowed.\n+        self.assertEqual(TraverseClass.traverse(AccessControl, None, ("getSecurityManager",)), AccessControl.getSecurityManager)\n+        self.assertEqual(TrustedTraverseClass.traverse(AccessControl, None, ("getSecurityManager",)), AccessControl.getSecurityManager)\n+\n+    def test_traverse_class_accesscontrol_direct(self):\n+        with self.assertRaises(NotFound):\n+            TraverseClass.traverse(AccessControl, None, ("SecurityManagement",))\n+        self.assertEqual(TrustedTraverseClass.traverse(AccessControl, None, ("SecurityManagement",)), AccessControl.SecurityManagement)\n+\n+    def test_traverse_class_accesscontrol_via_modules(self):\n+        from Products.PageTemplates.ZRPythonExpr import _SecureModuleImporter\n+\n+        modules = _SecureModuleImporter()\n+        with self.assertRaises(NotFound):\n+            TraverseClass.traverse(modules, None, ("AccessControl", "users"))\n+        self.assertEqual(TrustedTraverseClass.traverse(modules, None, ("AccessControl", "users")), AccessControl.users)\n+\n+    def test_traverse_class_accesscontrol_via_dict(self):\n+        piggyback = {"unsafe": AccessControl}\n+        with self.assertRaises(NotFound):\n+            TraverseClass.traverse(piggyback, None, ("unsafe", "users"))\n+        self.assertEqual(TrustedTraverseClass.traverse(piggyback, None, ("unsafe", "users")), AccessControl.users)\ndiff --git a/Products/CMFPlone/tests/test_factory.py b/Products/CMFPlone/tests/test_factory.py\nindex e542972258..a797e54ad0 100644\n--- a/Products/CMFPlone/tests/test_factory.py\n+++ b/Products/CMFPlone/tests/test_factory.py\n@@ -3,6 +3,8 @@\n from Products.CMFPlone.utils import get_installer\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import queryUtility\n+from zope.component import getUtility\n+from plone.registry.interfaces import IRegistry\n \n import unittest\n \n@@ -53,3 +55,10 @@ def test_site_creation_without_content_but_with_content_types(self):\n         # Folder\n         fti = queryUtility(IDexterityFTI, name=\'Folder\')\n         self.assertIsNotNone(fti)\n+\n+    def test_site_creation_title_is_set_in_registry(self):\n+        """ Plone site title should be stored in registry """\n+        ploneSite = addPloneSite(\n+            self.app, \'ploneFoo\', title=\'Foo\', setup_content=False)\n+        registry = getUtility(IRegistry, context=ploneSite)\n+        self.assertEqual(registry[\'plone.site_title\'], \'Foo\')\ndiff --git a/Products/CMFPlone/tests/test_icons.py b/Products/CMFPlone/tests/test_icons.py\nnew file mode 100644\nindex 0000000000..9b720c546f\n--- /dev/null\n+++ b/Products/CMFPlone/tests/test_icons.py\n@@ -0,0 +1,74 @@\n+from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+\n+import unittest\n+\n+\n+class IconsTest(unittest.TestCase):\n+    """Test the icon resolver view."""\n+\n+    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+\n+    def setUp(self):\n+        self.app = self.layer[\'app\']\n+        self.portal = self.layer[\'portal\']\n+\n+    def test_icons_browser(self):\n+        browser = Browser(self.app)\n+        portal_url = self.portal.absolute_url()\n+        url = portal_url + \'/@@iconresolver/bug\'\n+        browser.open(url)\n+        self.assertIn(b\'bi bi-bug\', browser.contents)\n+\n+    def test_icons_view(self):\n+        page = self.app\n+        view = page.restrictedTraverse(\'@@iconresolver\')\n+        self.assertIn(b\'bi bi-bug\', view.tag(\'bug\'))\n+\n+    def test_icons_url(self):\n+        page = self.app\n+        view = page.restrictedTraverse(\'@@iconresolver\')\n+        self.assertIn(\n+            \'++plone++bootstrap-icons/bug.svg\',\n+            view.url(\'bug\')\n+        )\n+\n+    def test_icons_tag(self):\n+        page = self.app\n+        view = page.restrictedTraverse(\'@@iconresolver\')\n+        self.assertIn(b\'bi bi-bug\', view.tag(\'bug\'))\n+\n+\n+\n+class IconTraverserTest(unittest.TestCase):\n+    """Test the icon traverser or PloneBundlesTraverser."""\n+\n+    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+\n+    def setUp(self):\n+        self.portal = self.layer[\'portal\']\n+        self.request = self.layer[\'request\']\n+\n+    def test_default_icon(self):\n+        self.portal.restrictedTraverse("++plone++icons/plone.svg")\n+\n+    def test_bootstrap_icon(self):\n+        self.portal.restrictedTraverse("++plone++bootstrap-icons/clock.svg")\n+\n+    def test_bootstrap_icon_with_path_info(self):\n+        """Get bootstrap icon while request has a PATH_INFO.\n+\n+        When the request has PATH_INFO, which it normally has,\n+        the code originally ignored the remaining name (clock.svg)\n+        and tried to traverse based on this PATH_INFO.\n+        This works fine when the url of the request is for an icon.\n+        But when the url is for a normal page which tries to load an icon\n+        in the template, it fails.\n+\n+        I don\'t know why most of the time it goes right.\n+        But I have occasionally seen failures.\n+        And it happens at least in plone.i18n tests.\n+        https://github.com/plone/plone.i18n/pull/41\n+        """\n+        self.request.environ["PATH_INFO"] = "plone"\n+        self.portal.restrictedTraverse("++plone++bootstrap-icons/clock.svg")\ndiff --git a/Products/CMFPlone/tests/test_l18nl10n.py b/Products/CMFPlone/tests/test_l18nl10n.py\ndeleted file mode 100644\nindex 3a56a06736..0000000000\n--- a/Products/CMFPlone/tests/test_l18nl10n.py\n+++ /dev/null\n@@ -1,24 +0,0 @@\n-""" Unit tests for Products.CMFPlone.i18nl10n module. """\n-\n-import unittest\n-\n-class BasicI18nl10nTests(unittest.TestCase):\n-\n-    def test_regexp_dt_format_string_regexp(self):\n-        from Products.CMFPlone.i18nl10n import _dt_format_string_regexp\n-        dt_string = "%Y-%m-%d %H:%M"\n-        locales_string = "${H}:${M}"\n-\n-        # test for strftime format string\n-        self.assertTrue(bool(_dt_format_string_regexp.findall(dt_string)))\n-        self.assertFalse(bool(_dt_format_string_regexp.findall(locales_string)))\n-\n-    def test_regexp_interp_regex(self):\n-        from Products.CMFPlone.i18nl10n import _interp_regex\n-        locales_string = "${H}:${M}"\n-\n-        # test for locale string elements:\n-        self.assertEquals(\n-            _interp_regex.findall(locales_string),\n-            ["${H}", "${M}"],\n-        )\ndiff --git a/Products/CMFPlone/tests/test_mails.py b/Products/CMFPlone/tests/test_mails.py\nindex 431a616899..751718a6c1 100644\n--- a/Products/CMFPlone/tests/test_mails.py\n+++ b/Products/CMFPlone/tests/test_mails.py\n@@ -4,7 +4,7 @@\n from plone.app.testing import PloneSandboxLayer\n from plone.registry.interfaces import IRegistry\n from plone.testing import layered\n-from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+from plone.base.interfaces.controlpanel import IMailSchema\n from zope.component import getUtility\n \n import doctest\ndiff --git a/Products/CMFPlone/tests/test_metabundles.py b/Products/CMFPlone/tests/test_metabundles.py\ndeleted file mode 100644\nindex 57874b4b3f..0000000000\n--- a/Products/CMFPlone/tests/test_metabundles.py\n+++ /dev/null\n@@ -1,144 +0,0 @@\n-from plone.resource.interfaces import IResourceDirectory\n-from Products.CMFPlone.interfaces.resources import (\n-    OVERRIDE_RESOURCE_DIRECTORY_NAME,\n-)\n-from zope.component import getUtility\n-\n-from Products.CMFPlone.resources.browser.combine import (\n-    PRODUCTION_RESOURCE_DIRECTORY,\n-    combine_bundles,\n-)\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from Products.GenericSetup.tests import common\n-\n-import unittest\n-\n-\n-class DummyImportContext(common.DummyImportContext):\n-    # Copied from plone.app.registry tests.\n-    # This expands the context with directories.\n-\n-    _directories = {}\n-\n-    def listDirectory(self, path):\n-        return self._directories.get(path, [])\n-\n-    def isDirectory(self, path):\n-        return path in self._directories\n-\n-\n-class ProductsCMFPloneSetupTest(unittest.TestCase):\n-\n-    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-\n-    def setUp(self):\n-        self.portal = self.layer[\'portal\']\n-        combine_bundles(self.portal)\n-        persistent_directory = getUtility(\n-            IResourceDirectory, name="persistent")\n-        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-        self.production_folder = container[PRODUCTION_RESOURCE_DIRECTORY]\n-\n-    def test_production_directory(self):\n-        self.assertEqual(\n-            self.production_folder.listDirectory(),\n-            [\n-                \'default.css\',\n-                \'default.js\',\n-                \'logged-in.css\',\n-                \'logged-in.js\',\n-                \'timestamp.txt\'\n-            ]\n-        )\n-\n-    def test_default_js_bundle(self):\n-        self.assertIn(\n-            b"jQuery",\n-            self.production_folder.readFile(\'default.js\')\n-        )\n-\n-    def test_overrides(self):\n-        persistent_directory = getUtility(\n-            IResourceDirectory, name="persistent")\n-        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n-        container.makeDirectory(\'static\')\n-        static = container[\'static\']\n-        static.writeFile(\'plone-legacy-compiled.js\', \'alert("Overrided legacy!");\')\n-        combine_bundles(self.portal)\n-        self.assertIn(\n-            b\'alert("Overrided legacy!");\',\n-            self.production_folder.readFile(\'default.js\')\n-        )\n-\n-    def test_import(self):\n-        # If IBundleRegistry is in registry.xml, the combine-bundles import step\n-        # will call combine_bundles.\n-        from Products.CMFPlone.resources.exportimport.bundles import combine\n-        # from Products.CMFPlone.resources.browser.combine import get_override_directory\n-        # from Products.CMFPlone.resources.browser.combine import PRODUCTION_RESOURCE_DIRECTORY\n-\n-        # Prepare some registry xml files with or without the key IBundleRegistry.\n-        xml_with = b\'<registry>with IBundleRegistry</registry>\'\n-        xml_without = b\'<registry>without bundle registry</registry>\'\n-        xml_without2 = b\'<registry>without bundle registry</registry>\'\n-        context = DummyImportContext(self.portal, purge=False)\n-\n-        def get_timestamp():\n-            # If combine_bundles is run, a timestamp is updated.\n-            return self.production_folder.readFile(\'timestamp.txt\')\n-\n-        ts1 = get_timestamp()\n-        self.assertTrue(ts1)\n-\n-        # call the import step on a file without bundles\n-        context._files = {\'registry.xml\': xml_without}\n-        combine(context)\n-        ts2 = get_timestamp()\n-        self.assertEqual(ts1, ts2)\n-\n-        # call the import step on a file with bundles\n-        context._files = {\'registry.xml\': xml_with}\n-        combine(context)\n-        ts3 = get_timestamp()\n-        self.assertLess(ts2, ts3)\n-\n-        # call the import step on a file without bundles\n-        context._files = {\'registry.xml\': xml_without2}\n-        combine(context)\n-        ts4 = get_timestamp()\n-        self.assertEqual(ts3, ts4)\n-\n-        # Since Plone 5.1 the registry xml can also be a directory.\n-        # Set one file with bundles.\n-        context._files = {\n-            \'registry.xml\': xml_without,\n-            \'registry/foo2.xml\': xml_with,\n-            \'registry/foo3.xml\': xml_without2,\n-        }\n-        context._directories = {\n-            \'registry\': [\n-                \'foo2.xml\',\n-                \'foo3.xml\',\n-            ]\n-        }\n-        combine(context)\n-        ts10 = get_timestamp()\n-        self.assertLess(ts4, ts10)\n-\n-        # The registry.xml file itself may be missing.\n-        context._files = {\n-            \'registry/foo2.xml\': xml_with,\n-            \'registry/foo3.xml\': xml_without2,\n-        }\n-        combine(context)\n-        ts11 = get_timestamp()\n-        self.assertLess(ts10, ts11)\n-\n-        # Now without any bundle info.\n-        context._files = {\n-            \'registry/foo2.xml\': xml_without,\n-            \'registry/foo3.xml\': xml_without2,\n-        }\n-        combine(context)\n-        ts12 = get_timestamp()\n-        self.assertEqual(ts11, ts12)\ndiff --git a/Products/CMFPlone/tests/test_patternsettings.py b/Products/CMFPlone/tests/test_patternsettings.py\nindex 6872091250..9a70e75faa 100644\n--- a/Products/CMFPlone/tests/test_patternsettings.py\n+++ b/Products/CMFPlone/tests/test_patternsettings.py\n@@ -1,7 +1,7 @@\n from plone.app.testing import login\n from plone.app.testing import TEST_USER_NAME\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.interfaces import ITinyMCESchema\n+from plone.base.interfaces import ITinyMCESchema\n from Products.CMFPlone.patterns.view import PatternsSettingsView\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\ndiff --git a/Products/CMFPlone/tests/test_redirect_after_login.py b/Products/CMFPlone/tests/test_redirect_after_login.py\nindex 4c0aec9a81..821e762be8 100644\n--- a/Products/CMFPlone/tests/test_redirect_after_login.py\n+++ b/Products/CMFPlone/tests/test_redirect_after_login.py\n@@ -2,8 +2,8 @@\n from plone.app.testing import TEST_USER_PASSWORD\n from plone.testing.zope import Browser\n from Products.CMFPlone.browser.login.login import LoginForm\n-from Products.CMFPlone.interfaces import IInitialLogin\n-from Products.CMFPlone.interfaces import IRedirectAfterLogin\n+from plone.base.interfaces import IInitialLogin\n+from plone.base.interfaces import IRedirectAfterLogin\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.interface import implementer\ndiff --git a/Products/CMFPlone/tests/test_robots_txt.py b/Products/CMFPlone/tests/test_robots_txt.py\nindex 23a54ba1fb..e7f73966b5 100644\n--- a/Products/CMFPlone/tests/test_robots_txt.py\n+++ b/Products/CMFPlone/tests/test_robots_txt.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/tests/test_safe_formatter.py b/Products/CMFPlone/tests/test_safe_formatter.py\nindex bb90285cdd..65076d1c8a 100644\n--- a/Products/CMFPlone/tests/test_safe_formatter.py\n+++ b/Products/CMFPlone/tests/test_safe_formatter.py\n@@ -118,7 +118,7 @@ def test_cook_zope2_page_templates_good_format_attr_str(self):\n         hack_pt(pt, self.portal)\n         self.assertEqual(\n             pt.pt_render().strip(),\n-            \'<p>title of &lt;PloneSite at plone&gt; is Plone site</p>\')\n+            \'<p>title of &lt;PloneSite at plone&gt; is Welcome to Plone</p>\')\n \n     def test_cook_zope2_page_templates_good_format_attr_unicode(self):\n         from Products.PageTemplates.ZopePageTemplate import ZopePageTemplate\n@@ -126,7 +126,7 @@ def test_cook_zope2_page_templates_good_format_attr_unicode(self):\n         hack_pt(pt, self.portal)\n         self.assertEqual(\n             pt.pt_render().strip(),\n-            \'<p>title of &lt;PloneSite at plone&gt; is Plone site</p>\')\n+            \'<p>title of &lt;PloneSite at plone&gt; is Welcome to Plone</p>\')\n \n     def test_access_to_private_content_not_allowed_via_rich_text(self):\n         try:\n@@ -324,28 +324,6 @@ def test_standard_error_message(self):\n         # We expect a json string back.\n         self.assertTrue(response.body, \'{"error_type": "None"}\')\n \n-    def test_resource_registry_vector(self):\n-        for vector in (\'less-variables.js\', \'less-modify.js\'):\n-            src = \'\'\'\n-class ctx:\n-  def format(self, *args, **kwargs):\n-    self.foo=context\n-    return "foo"\n-\n-context.portal_registry[\'plone.lessvariables\'][\'foo\'] = ctx()\n-context.portal_registry[\'plone.lessvariables\'][\'bar\'] = "{foo.foo.__class__}"\n-js = context.restrictedTraverse("%s")\n-return js()\n-\'\'\' % vector\n-            from Products.PythonScripts.PythonScript import PythonScript\n-            script = PythonScript(\'evil\')\n-            script._filepath = \'evil\'\n-            script.write(src)\n-            self.portal.evil = script\n-            output = self.publish(\'/plone/evil\')\n-            self.assertFalse(\n-                b\'Products.CMFPlone.Portal.PloneSite\' in output.body)\n-\n     def test_cook_zope2_page_templates_bad_key_str(self):\n         from Products.PageTemplates.ZopePageTemplate import ZopePageTemplate\n         pt = ZopePageTemplate(\'mytemplate\', BAD_KEY_STR)\ndiff --git a/Products/CMFPlone/tests/test_sitelogo.py b/Products/CMFPlone/tests/test_sitelogo.py\nindex 1f1f8340f9..0f07e67ac0 100644\n--- a/Products/CMFPlone/tests/test_sitelogo.py\n+++ b/Products/CMFPlone/tests/test_sitelogo.py\n@@ -1,4 +1,4 @@\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/tests/test_utils.py b/Products/CMFPlone/tests/test_utils.py\nindex 64ef7ea302..eb30c720bf 100644\n--- a/Products/CMFPlone/tests/test_utils.py\n+++ b/Products/CMFPlone/tests/test_utils.py\n@@ -6,11 +6,9 @@\n from Products.CMFCore.tests.base.content import SIMPLE_STRUCTUREDTEXT\n from Products.CMFCore.tests.base.content import SIMPLE_XHTML\n from Products.CMFCore.tests.base.content import STX_WITH_HTML\n-from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getUtility\n-from zope.interface import alsoProvides\n-from plone.subrequest.interfaces import ISubRequest\n \n import unittest\n \n@@ -36,159 +34,6 @@ def test_bodyfinder(self):\n         self.assertEqual(bodyfinder(STX_WITH_HTML),\n                          \'<p>Hello world, I am Bruce.</p>\')\n \n-    def test_safe_encode(self):\n-        """safe_encode should always encode unicode to the specified encoding.\n-        """\n-        from Products.CMFPlone.utils import safe_encode\n-        self.assertEqual(safe_encode(\'sp\xc3\xa4m\'), b\'sp\\xc3\\xa4m\')\n-        self.assertEqual(safe_encode(\'sp\xc3\xa4m\', \'utf-8\'), b\'sp\\xc3\\xa4m\')\n-        self.assertEqual(safe_encode(\'sp\xc3\xa4m\', encoding=\'latin-1\'), b\'sp\\xe4m\')\n-\n-    def test_get_top_request(self):\n-        """If in a subrequest, ``get_top_request`` should always return the top\n-        most request.\n-        """\n-        from Products.CMFPlone.utils import get_top_request\n-\n-        class MockRequest:\n-\n-            def __init__(self, parent_request=None):\n-                self._dict = {}\n-                if parent_request:\n-                    self._dict[\'PARENT_REQUEST\'] = parent_request\n-                    alsoProvides(self, ISubRequest)\n-\n-            def get(self, key, default=None):\n-                return self._dict.get(key, default)\n-\n-        req0 = MockRequest()\n-        req1 = MockRequest(req0)\n-        req2 = MockRequest(req1)\n-\n-        self.assertEqual(get_top_request(req0), req0)\n-        self.assertEqual(get_top_request(req1), req0)\n-        self.assertEqual(get_top_request(req2), req0)\n-\n-    def test_get_top_site_from_url(self):\n-        """Unit test for ``get_top_site_from_url`` with context and request\n-        mocks.\n-\n-        Test content structure:\n-        /approot/PloneSite/folder/SubSite/folder\n-        PloneSite and SubSite implement ISite\n-        """\n-        from plone.app.content.browser.contents import get_top_site_from_url\n-        from urllib.parse import urlparse\n-        from zope.component.interfaces import ISite\n-\n-        class MockContext:\n-            vh_url = \'http://nohost\'\n-            vh_root = \'\'\n-\n-            def __init__(self, physical_path):\n-                self.physical_path = physical_path\n-                if self.physical_path.split(\'/\')[-1] in (\'PloneSite\', \'SubSite\'):  # noqa\n-                    alsoProvides(self, ISite)\n-\n-            @property\n-            def id(self):\n-                return self.physical_path.split(\'/\')[-1]\n-\n-            def absolute_url(self):\n-                return self.vh_url + self.physical_path[len(self.vh_root):] or \'/\'  # noqa\n-\n-            def restrictedTraverse(self, path):\n-                return MockContext(self.vh_root + path)\n-\n-        class MockRequest:\n-            vh_url = \'http://nohost\'\n-            vh_root = \'\'\n-\n-            def physicalPathFromURL(self, url):\n-                # Return the physical path from a URL.\n-                # The outer right \'/\' is not part of the path.\n-                path = self.vh_root + urlparse(url).path.rstrip(\'/\')\n-                return path.split(\'/\')\n-\n-        # NO VIRTUAL HOSTING\n-\n-        req = MockRequest()\n-\n-        # Case 1:\n-        ctx = MockContext(\'/approot/PloneSite\')\n-        self.assertEqual(get_top_site_from_url(ctx, req).id, \'PloneSite\')\n-\n-        # Case 2\n-        ctx = MockContext(\'/approot/PloneSite/folder\')\n-        self.assertEqual(get_top_site_from_url(ctx, req).id, \'PloneSite\')\n-\n-        # Case 3:\n-        ctx = MockContext(\'/approot/PloneSite/folder/SubSite/folder\')\n-        self.assertEqual(get_top_site_from_url(ctx, req).id, \'PloneSite\')\n-\n-        # Case 4, using unicode paths accidentially:\n-        ctx = MockContext(\'/approot/PloneSite/folder/SubSite/folder\')\n-        self.assertEqual(get_top_site_from_url(ctx, req).id, \'PloneSite\')\n-\n-        # VIRTUAL HOSTING ON SUBSITE\n-\n-        req = MockRequest()\n-        req.vh_root = \'/approot/PloneSite/folder/SubSite\'\n-\n-        # Case 4:\n-        ctx = MockContext(\'/approot/PloneSite/folder/SubSite\')\n-        ctx.vh_root = \'/approot/PloneSite/folder/SubSite\'\n-        self.assertEqual(get_top_site_from_url(ctx, req).id, \'SubSite\')\n-\n-        # Case 5:\n-        ctx = MockContext(\'/approot/PloneSite/folder/SubSite/folder\')\n-        ctx.vh_root = \'/approot/PloneSite/folder/SubSite\'\n-        self.assertEqual(get_top_site_from_url(ctx, req).id, \'SubSite\')\n-\n-    def test_human_readable_size_int(self):\n-        from Products.CMFPlone.utils import human_readable_size\n-\n-        self.assertEqual(human_readable_size(0), \'0 KB\')\n-        self.assertEqual(human_readable_size(1), \'1 KB\')\n-        size = 1000\n-        self.assertEqual(human_readable_size(size), \'1 KB\')\n-        size += 24\n-        self.assertEqual(human_readable_size(size), \'1.0 KB\')\n-        size += 512\n-        self.assertEqual(human_readable_size(size), \'1.5 KB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1.5 MB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1.5 GB\')\n-        size *= 1024\n-        self.assertEqual(human_readable_size(size), \'1536.0 GB\')\n-\n-    def test_human_readable_size_float(self):\n-        from Products.CMFPlone.utils import human_readable_size\n-\n-        self.assertEqual(human_readable_size(0.), \'0 KB\')\n-        self.assertEqual(human_readable_size(1.), \'1 KB\')\n-        size = 1000.\n-        self.assertEqual(human_readable_size(size), \'1 KB\')\n-        size += 24.\n-        self.assertEqual(human_readable_size(size), \'1.0 KB\')\n-        size += 512.\n-        self.assertEqual(human_readable_size(size), \'1.5 KB\')\n-        size *= 1024.\n-        self.assertEqual(human_readable_size(size), \'1.5 MB\')\n-        size *= 1024.\n-        self.assertEqual(human_readable_size(size), \'1.5 GB\')\n-        size *= 1024.\n-        self.assertEqual(human_readable_size(size), \'1536.0 GB\')\n-\n-    def test_human_readable_size_special(self):\n-        from Products.CMFPlone.utils import human_readable_size\n-\n-        self.assertEqual(human_readable_size(None), \'0 KB\')\n-        self.assertEqual(human_readable_size(\'\'), \'0 KB\')\n-        self.assertEqual(human_readable_size(\'barney\'), \'barney\')\n-\n-\n class LogoTests(unittest.TestCase):\n \n     layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n@@ -198,13 +43,22 @@ def test_getSiteLogo_with_setting(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(ISiteSchema, prefix=\'plone\')\n         settings.site_logo = SITE_LOGO_BASE64\n+        logo_url, logo_type = getSiteLogo(include_type=True)\n \n         self.assertTrue(\n             \'http://nohost/plone/@@site-logo/pixel.png\'\n-            in getSiteLogo())\n+            in logo_url)\n+\n+        self.assertEqual(\n+            "image/png", logo_type\n+        )\n \n     def test_getSiteLogo_with_no_setting(self):\n         from Products.CMFPlone.utils import getSiteLogo\n+        logo_url, logo_type = getSiteLogo(include_type=True)\n         self.assertTrue(\n-            \'http://nohost/plone/logo.png\'\n-            in getSiteLogo())\n+            \'http://nohost/plone/++resource++plone-logo.svg\'\n+            in logo_url)\n+        self.assertEqual(\n+            "image/svg+xml", logo_type\n+        )\ndiff --git a/Products/CMFPlone/tests/test_zmi.py b/Products/CMFPlone/tests/test_zmi.py\nindex 19ecdc4d6d..33ac444e52 100644\n--- a/Products/CMFPlone/tests/test_zmi.py\n+++ b/Products/CMFPlone/tests/test_zmi.py\n@@ -95,11 +95,6 @@ def test_portal_diff(self):\n         view = self.portal.restrictedTraverse(url)\n         self.assertTrue(view(), msg=f\'{url} is broken\')\n \n-    def test_portal_form_controller(self):\n-        url = \'portal_form_controller/manage_overview\'\n-        view = self.portal.restrictedTraverse(url)\n-        self.assertTrue(view(), msg=f\'{url} is broken\')\n-\n     def test_portal_historiesstorage(self):\n         url = \'portal_historiesstorage/storageStatistics\'\n         view = self.portal.restrictedTraverse(url)\ndiff --git a/Products/CMFPlone/tests/view_name.pt b/Products/CMFPlone/tests/view_name.pt\nnew file mode 100644\nindex 0000000000..592dc3e98d\n--- /dev/null\n+++ b/Products/CMFPlone/tests/view_name.pt\n@@ -0,0 +1 @@\n+<h1 tal:content="view/__name__" />\ndiff --git a/Products/CMFPlone/traversal.py b/Products/CMFPlone/traversal.py\nindex ebeb4a9120..8b56473dc4 100644\n--- a/Products/CMFPlone/traversal.py\n+++ b/Products/CMFPlone/traversal.py\n@@ -2,7 +2,7 @@\n from zope.component import queryUtility\n from plone.resource.interfaces import IResourceDirectory\n from plone.resource.interfaces import IUniqueResourceRequest\n-from Products.CMFPlone.interfaces.resources import (\n+from plone.base.interfaces.resources import (\n     OVERRIDE_RESOURCE_DIRECTORY_NAME)\n from Products.PageTemplates.Expressions import getEngine\n from Products.PageTemplates.Expressions import getTrustedEngine\n@@ -33,7 +33,14 @@ def traverse(self, name, remaining):\n             return super().traverse(name, remaining)\n \n         resource_path = req.environ[\'PATH_INFO\'].split(\'++plone++\')[-1]\n-        resource_name, resource_filepath = resource_path.split(\'/\', 1)\n+        try:\n+            resource_name, resource_filepath = resource_path.split(\'/\', 1)\n+        except ValueError:\n+            # Not the path info / url that we expected.\n+            # So the request is not for a resource,\n+            # but for a page that traverses to a resource.\n+            # The standard resource traverser can handle this.\n+            return super().traverse(name, remaining)\n \n         # If we have additional traversers in the path we should not use them\n         # in the file lookup\ndiff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py\nindex 1e3c29fe07..7f6c0a1af6 100644\n--- a/Products/CMFPlone/utils.py\n+++ b/Products/CMFPlone/utils.py\n@@ -12,56 +12,48 @@\n from App.ImageFile import ImageFile\n from DateTime import DateTime\n from DateTime.interfaces import DateTimeError\n+from html import escape\n from OFS.CopySupport import CopyError\n from os.path import abspath\n from os.path import join\n from os.path import split\n+from plone.base import PloneMessageFactory as _\n+from plone.base import utils as base_utils\n from plone.i18n.normalizer.interfaces import IIDNormalizer\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.permissions import AddPortalContent\n from Products.CMFCore.permissions import ManageUsers\n-from Products.CMFCore.utils import ToolInit as CMFCoreToolInit\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFCore.utils import ToolInit as CMFCoreToolInit\n from Products.CMFPlone import bbb\n-from Products.CMFPlone.interfaces.controlpanel import IImagingSchema\n-from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot\n-from Products.CMFPlone.log import log\n-from Products.CMFPlone.log import log_deprecated\n-from Products.CMFPlone.log import log_exc\n-from urllib.parse import urlparse\n+from plone.base.interfaces.controlpanel import IImagingSchema\n+from plone.base.interfaces.siteroot import IPloneSiteRoot\n+from Products.CMFPlone.log import log  # noqa - for python scripts\n+from Products.CMFPlone.log import log_exc  # noqa - for python scripts\n+from Products.CMFPlone.log import log_deprecated  # noqa - for python scripts\n from ZODB.POSException import ConflictError\n-from zope import schema\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.component import providedBy\n from zope.component import queryUtility\n from zope.component.hooks import getSite\n-from zope.component.interfaces import ISite\n from zope.deferredimport import deprecated as deprecated_import\n-from zope.deprecation import deprecated\n+from zope.deprecation import deprecate\n+from zope.deprecation import deprecated  # noqa\n from zope.i18n import translate\n from zope.interface import implementedBy\n from zope.publisher.interfaces.browser import IBrowserRequest\n \n-import json\n import OFS\n import pkg_resources\n import re\n import sys\n import transaction\n-import warnings\n import zope.interface\n \n-try:\n-    from html import escape\n-except ImportError:\n-    from cgi import escape\n \n-try:\n-    from types import ClassType\n-except ImportError:\n-    ClassType = type\n+# todo: check below if this is still needed\n+ClassType = type\n \n if bbb.HAS_ZSERVER:\n     from webdav.interfaces import IWriteLock\n@@ -69,11 +61,33 @@\n     from OFS.interfaces import IWriteLock\n \n deprecated_import(\n-    "Import from Products.CMFPlone.defaultpage instead",\n-    isDefaultPage=\'Products.CMFPlone.defaultpage:check_default_page_via_view\',\n-    getDefaultPage=\'Products.CMFPlone.defaultpage:get_default_page_via_view\',\n+    "Import from plone.base.utils instead (will be removed in Plone 7)",\n+    human_readable_size=\'plone.base.utils:human_readable_size\',\n+    safeToInt=\'plone.base.utils:safeToInt\',\n+    safe_bytes=\'plone.base.utils:safe_bytes\',\n+    safe_text=\'plone.base.utils:safe_text\',\n+    get_installer=\'plone.base.utils:get_installer\',\n+    get_top_request=\'plone.base.utils:get_top_request\',\n+    get_top_site_from_url=\'plone.base.utils:get_top_site_from_url\',\n )\n \n+@deprecate("Use plone.base.utils.safe_bytes instead (will be removed in Plone 7)")\n+def safe_encode(*args, **kwargs):\n+    return base_utils.safe_bytes(*args, **kwargs)\n+\n+@deprecate("Use plone.base.utils.safe_text instead (will be removed in Plone 7)")\n+def safe_unicode(*args, **kwargs):\n+    return base_utils.safe_text(*args, **kwargs)\n+\n+@deprecate("Use plone.base.utils.safe_text instead (will be removed in Plone 7)")\n+def safe_nativestring(value, encoding=\'utf-8\'):\n+    """Convert a value to str in py2 and to text in py3\n+    """\n+    if isinstance(value, bytes):\n+        value = base_utils.safe_text(value, encoding)\n+    return value\n+\n+\n security = ModuleSecurityInfo()\n security.declarePrivate(\'deprecated\')\n security.declarePrivate(\'abspath\')\n@@ -96,8 +110,6 @@\n QUALITY_DEFAULT = 88\n pattern = re.compile(r\'^(.*)\\s+(\\d+)\\s*:\\s*(\\d+)$\')\n \n-# Log methods\n-log_exc  # pyflakes.  Keep this, as someone may import it.\n _marker = []\n \n \n@@ -128,31 +140,6 @@ def createSiteMap(context, request, sitemap=False):\n     return view.siteMap()\n \n \n-def isIDAutoGenerated(context, id):\n-    # In 2.1 non-autogenerated is the common case, caught exceptions are\n-    # expensive, so let\'s make a cheap check first\n-    if id.count(\'.\') < 2:\n-        return False\n-\n-    pt = getToolByName(context, \'portal_types\')\n-    portaltypes = pt.listContentTypes()\n-    portaltypes.extend([t.lower() for t in portaltypes])\n-\n-    try:\n-        parts = id.split(\'.\')\n-        random_number = parts.pop()\n-        date_created = parts.pop()\n-        obj_type = \'.\'.join(parts)\n-        type = \' \'.join(obj_type.split(\'_\'))\n-        # New autogenerated ids may have a lower case portal type\n-        if ((type in portaltypes or obj_type in portaltypes) and\n-                DateTime(date_created) and float(random_number)):\n-            return True\n-    except (ValueError, AttributeError, IndexError, DateTimeError):\n-        pass\n-\n-    return False\n-\n \n def isExpired(content):\n     """ Find out if the object is expired (copied from skin script) """\n@@ -205,20 +192,13 @@ def pretty_title_or_id(context, obj, empty_value=_marker):\n     item_id = getattr(obj, \'getId\', None)\n     if safe_callable(item_id):\n         item_id = item_id()\n-    if item_id and not isIDAutoGenerated(context, item_id):\n+    if item_id:\n         return item_id\n     if empty_value is _marker:\n         empty_value = getEmptyTitle(context)\n     return empty_value\n \n \n-def getSiteEncoding(context):\n-    return \'utf-8\'\n-deprecated(\'getSiteEncoding\',\n-           (\'`getSiteEncoding` is deprecated. Plone only supports UTF-8 \'\n-            \'currently. This method always returns "utf-8"\'))\n-\n-\n def getEmptyTitle(context, translated=True):\n     """Returns string to be used for objects with no title or id"""\n     # The default is an extra fancy unicode elipsis\n@@ -337,32 +317,6 @@ def _createObjectByType(type_name, container, id, *args, **kw):\n     return fti._constructInstance(container, id, *args, **kw)\n \n \n-def safeToInt(value, default=0):\n-    """Convert value to integer or just return 0 if we can\'t\n-\n-       >>> safeToInt(45)\n-       45\n-\n-       >>> safeToInt("42")\n-       42\n-\n-       >>> safeToInt("spam")\n-       0\n-\n-       >>> safeToInt([])\n-       0\n-\n-       >>> safeToInt(None)\n-       0\n-\n-       >>> safeToInt(None, default=-1)\n-       -1\n-    """\n-    try:\n-        return int(value)\n-    except (ValueError, TypeError):\n-        return default\n-\n release_levels = (\'alpha\', \'beta\', \'candidate\', \'final\')\n rl_abbr = {\'a\': \'alpha\', \'b\': \'beta\', \'rc\': \'candidate\'}\n \n@@ -393,7 +347,7 @@ def versionTupleFromString(v_str):\n     else:\n         groups = list(match.groups())\n         for i in (0, 1, 2, 4):\n-            groups[i] = safeToInt(groups[i])\n+            groups[i] = base_utils.safe_int(groups[i])\n         if groups[3] is None:\n             groups[3] = \'final\'\n         elif groups[3] in rl_abbr.keys():\n@@ -414,7 +368,7 @@ def transaction_note(note):\n     if (len(T.description) + len(note)) >= 65533:\n         log(\'Transaction note too large omitting %s\' % str(note))\n     else:\n-        T.note(safe_unicode(note))\n+        T.note(base_utils.safe_text(note))\n \n \n def base_hasattr(obj, name):\n@@ -438,66 +392,10 @@ def safe_callable(obj):\n     if safe_hasattr(obj, \'__class__\'):\n         if safe_hasattr(obj, \'__call__\'):\n             return True\n-        else:\n-            return isinstance(obj, ClassType)\n-    else:\n-        return callable(obj)\n-\n-\n-def safe_text(value, encoding=\'utf-8\'):\n-    """Converts a value to text, even it is already a text string.\n-\n-        >>> from Products.CMFPlone.utils import safe_unicode\n-        >>> test_bytes = u\'\\u01b5\'.encode(\'utf-8\')\n-        >>> safe_unicode(\'spam\') == u\'spam\'\n-        True\n-        >>> safe_unicode(b\'spam\') == u\'spam\'\n-        True\n-        >>> safe_unicode(u\'spam\') == u\'spam\'\n-        True\n-        >>> safe_unicode(u\'spam\'.encode(\'utf-8\')) == u\'spam\'\n-        True\n-        >>> safe_unicode(test_bytes) == u\'\\u01b5\'\n-        True\n-        >>> safe_unicode(u\'\\xc6\\xb5\'.encode(\'iso-8859-1\')) == u\'\\u01b5\'\n-        True\n-        >>> safe_unicode(test_bytes, encoding=\'ascii\') == u\'\\u01b5\'\n-        True\n-        >>> safe_unicode(1) == 1\n-        True\n-        >>> print(safe_unicode(None))\n-        None\n-    """\n-    if isinstance(value, str):\n-        return value\n-    elif isinstance(value, bytes):\n-        try:\n-            value = str(value, encoding)\n-        except (UnicodeDecodeError):\n-            value = value.decode(\'utf-8\', \'replace\')\n-    return value\n-\n-\n-safe_unicode = safe_text\n+        return isinstance(obj, ClassType)\n+    return callable(obj)\n \n \n-def safe_bytes(value, encoding=\'utf-8\'):\n-    """Convert text to bytes of the specified encoding.\n-    """\n-    if isinstance(value, str):\n-        value = value.encode(encoding)\n-    return value\n-\n-\n-safe_encode = safe_bytes\n-\n-\n-def safe_nativestring(value, encoding=\'utf-8\'):\n-    """Convert a value to str in py2 and to text in py3\n-    """\n-    if isinstance(value, bytes):\n-        value = safe_text(value, encoding)\n-    return value\n \n \n def tuplize(value):\n@@ -522,10 +420,12 @@ def flatten(interfaces):\n     return tuple(flattened)\n \n \n+@deprecate("Use zope.interface.directlyProvides instead (will be removed in Plone 7)")\n def directlyProvides(obj, *interfaces):\n     return zope.interface.directlyProvides(obj, *interfaces)\n \n \n+@deprecate("Use zope.interface.classImplements instead (will be removed in Plone 7)")\n def classImplements(class_, *interfaces):\n     return zope.interface.classImplements(class_, *interfaces)\n \n@@ -543,10 +443,7 @@ def webdav_enabled(obj, container):\n     """WebDAV check used in externalEditorEnabled.py"""\n \n     # Object implements lock interface\n-    if IWriteLock.providedBy(obj):\n-        return True\n-\n-    return False\n+    return IWriteLock.providedBy(obj)\n \n \n # Copied \'unrestricted_rename\' from ATCT migrations to avoid\n@@ -623,13 +520,6 @@ def _getSecurity(klass, create=True):\n     return security\n \n \n-def isLinked(obj):\n-    """Check if the given content object is linked from another one."""\n-    log_deprecated("utils.isLinked is deprecated, you should use plone.app.linkintegrity.utils.hasIncomingLinks")  # noqa\n-    from plone.app.linkintegrity.utils import hasIncomingLinks\n-    return hasIncomingLinks(obj)\n-\n-\n def set_own_login_name(member, loginname):\n     """Allow the user to set his/her own login name.\n \n@@ -656,25 +546,6 @@ def ajax_load_url(url):\n     return url\n \n \n-def validate_json(value):\n-    warnings.warn(\n-        \'Moved to the only place where it was used in order to avoid circular \'\n-        \'imports between ./interfaces/* and ./utils. Now relocated to \'\n-        \'"./interfaces/controlpanel.py"\',\n-        DeprecationWarning)\n-    try:\n-        json.loads(value)\n-    except ValueError as exc:\n-        class JSONError(schema.ValidationError):\n-            __doc__ = _("Must be empty or a valid JSON-formatted "\n-                        "configuration \xe2\x80\x93 ${message}.", mapping={\n-                            \'message\': str(exc)})\n-\n-        raise JSONError(value)\n-\n-    return True\n-\n-\n def bodyfinder(text):\n     """ Return body or unchanged text if no body tags found.\n \n@@ -720,20 +591,16 @@ def getQuality():\n     return QUALITY_DEFAULT\n \n \n-def getRetinaScales():\n-    warnings.warn(\n-        \'use getHighPixelDensityScales instead\',\n-        DeprecationWarning)\n-    return getHighPixelDensityScales()\n-\n def getHighPixelDensityScales():\n     from plone.namedfile.utils import getHighPixelDensityScales as func\n     return func()\n \n \n-def getSiteLogo(site=None):\n-    from Products.CMFPlone.interfaces import ISiteSchema\n+def getSiteLogo(site=None, include_type=False):\n+    from plone.base.interfaces import ISiteSchema\n     from plone.formwidget.namedfile.converter import b64decode_file\n+    import mimetypes\n+\n     if site is None:\n         site = getSite()\n     registry = getUtility(IRegistry)\n@@ -742,65 +609,17 @@ def getSiteLogo(site=None):\n \n     if getattr(settings, \'site_logo\', False):\n         filename, data = b64decode_file(settings.site_logo)\n-        return \'{}/@@site-logo/{}\'.format(\n+        site_logo_url = \'{}/@@site-logo/{}\'.format(\n             site_url, filename)\n+        site_logo_type = mimetypes.guess_type(filename)[0]\n     else:\n-        return \'%s/logo.png\' % site_url\n-\n-\n-def get_installer(context, request=None):\n-    if request is None:\n-        request = aq_get(context, \'REQUEST\', None)\n-    view = getMultiAdapter((context, request), name=\'installer\')\n-    return view\n-\n-\n-def get_top_request(request):\n-    """Get highest request from a subrequest.\n-    """\n-\n-    def _top_request(req):\n-        parent_request = req.get(\'PARENT_REQUEST\', None)\n-        return _top_request(parent_request) if parent_request else req\n-    return _top_request(request)\n-\n-\n-def get_top_site_from_url(context, request):\n-    """Find the top-most site, which is still in the url path.\n-\n-    If the current context is within a subsite within a PloneSiteRoot and no\n-    virtual hosting is in place, the PloneSiteRoot is returned.\n-    When at the same context but in a virtual hosting environment with the\n-    virtual host root pointing to the subsite, it returns the subsite instead\n-    the PloneSiteRoot.\n+        site_logo_url = \'%s/++resource++plone-logo.svg\' % site_url\n+        site_logo_type = "image/svg+xml"\n \n-    For this given content structure:\n+    if not include_type:\n+        return site_logo_url\n \n-    /Plone/Subsite\n-\n-    It should return the following in these cases:\n-\n-    - No virtual hosting, URL path: /Plone, Returns: Plone Site\n-    - No virtual hosting, URL path: /Plone/Subsite, Returns: Plone\n-    - Virtual hosting roots to Subsite, URL path: /, Returns: Subsite\n-    """\n-    site = getSite()\n-    try:\n-        url_path = urlparse(context.absolute_url()).path.split(\'/\')\n-        for idx in range(len(url_path)):\n-            _path = \'/\'.join(url_path[:idx + 1]) or \'/\'\n-            site_path = \'/\'.join(request.physicalPathFromURL(_path)) or \'/\'\n-            _site = context.restrictedTraverse(site_path)\n-            if ISite.providedBy(_site):\n-                break\n-        if _site:\n-            site = _site\n-    except (ValueError, AttributeError):\n-        # On error, just return getSite.\n-        # Refs: https://github.com/plone/plone.app.content/issues/103\n-        # Also, TestRequest doesn\'t have physicalPathFromURL\n-        pass\n-    return site\n+    return (site_logo_url, site_logo_type)\n \n \n def _safe_format(inst, method):\n@@ -812,34 +631,6 @@ def _safe_format(inst, method):\n     return SafeFormatter(inst).safe_format\n \n \n-SIZE_CONST = {\'KB\': 1024, \'MB\': 1024 * 1024, \'GB\': 1024 * 1024 * 1024}\n-SIZE_ORDER = (\'GB\', \'MB\', \'KB\')\n-\n-\n-def human_readable_size(size):\n-    """ Get a human readable size string. """\n-    smaller = SIZE_ORDER[-1]\n-\n-    # if the size is a float, then make it an int\n-    # happens for large files\n-    try:\n-        size = int(size)\n-    except (ValueError, TypeError):\n-        pass\n-\n-    if not size:\n-        return \'0 %s\' % smaller\n-\n-    if isinstance(size, int):\n-        if size < SIZE_CONST[smaller]:\n-            return \'1 %s\' % smaller\n-        for c in SIZE_ORDER:\n-            if size // SIZE_CONST[c] > 0:\n-                break\n-        return \'{:.1f} {}\'.format(float(size / float(SIZE_CONST[c])), c)\n-    return size\n-\n-\n def check_id(\n         context, id=None, required=0, alternative_id=None, contained_by=None,\n         **kwargs):\ndiff --git a/Products/CMFPlone/workflow.py b/Products/CMFPlone/workflow.py\nindex ac939662d3..199fdfbc40 100644\n--- a/Products/CMFPlone/workflow.py\n+++ b/Products/CMFPlone/workflow.py\n@@ -2,7 +2,7 @@\n from zope.component import adapter\n from Acquisition import aq_base\n from Products.CMFCore.interfaces import IWorkflowTool\n-from Products.CMFPlone.interfaces import IWorkflowChain\n+from plone.base.interfaces import IWorkflowChain\n \n \n @adapter(Interface, IWorkflowTool)\ndiff --git a/Products/CMFPlone/www/addPropertySheet.zpt b/Products/CMFPlone/www/addPropertySheet.zpt\nindex 33287009f0..2d01f3bcda 100644\n--- a/Products/CMFPlone/www/addPropertySheet.zpt\n+++ b/Products/CMFPlone/www/addPropertySheet.zpt\n@@ -1,4 +1,4 @@\n-<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">\n+<tal:doctype tal:replace="structure string:&lt;!DOCTYPE html&gt;" />\n <html>\n <head>\n <meta http-equiv="content-type" content="text/html;charset=utf-8"\ndiff --git a/README.rst b/README.rst\nindex 4638a5788f..8c1fdee108 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -3,7 +3,7 @@ About Plone\n \n Plone is a mature, secure and user-friendly Content Management System (CMS).\n \n-Plone - and the Open Source community behind it - aggregates more than 15 years experience in content management.\n+Plone - and the Open Source community behind it - aggregates more than 20 years of experience in content management.\n It offers all major features expected by a modern CMS out-of-the-box.\n \n Lots of customizations can be made trough-the-web, such as creating content types, themes, workflows and much more.\n@@ -39,10 +39,10 @@ What is Plone?\n Plone is a ready-to-run content management system, offering a complete set of features needed by a wide variety of organizations.\n \n Security is built into Plone\'s architecture from the ground up.\n-Plone offers fine grained permission control over content and actions.\n+Plone offers fine-grained permission control over content and actions.\n \n Plone is easy to set up, extremely flexible,\n-and provides you with a system for managing web content that is ideal for project groups, communities, web sites, extranets and intranets.\n+and provides you with a system for managing web content that is ideal for project groups, communities, websites, extranets and intranets.\n \n - *Plone is easy to install.*\n   Several installation options are available for either your local machine or on servers in the cloud.\n@@ -82,15 +82,14 @@ It builds upon Zope, an Open Source web application server and development syste\n Python is the easy-to-learn, widely-used and supported Open Source programming language.\n Python can be used to add new features to Plone, and used to understand or make changes to the way that Plone works.\n \n-Plone stores its contents in Zope\'s built-in transactional hierachical object database, the ZODB.\n+Plone stores its contents in Zope\'s built-in transactional hierarchical object database, the ZODB.\n The ZODB can be connected to simple file-storages, scalable ZEO-Servers or Postgres, MySQL and Oracle.\n-There are addon and techniques, however, to share information with other sources, such as relational databases, LDAP, filesystem\n+There are addons and techniques, however, to share information with other sources, such as relational databases, LDAP, filesystem\n files, etc.\n \n \n Official Resources\n ------------------\n-* `plone.com <https://plone.com/>`_ - Official website for decision makers and evaluators.\n * `plone.org <https://plone.org/>`_ - Official website for developers and community.\n * `Plone support <https://plone.org/support>`_ - Where to find help.\n * `community.plone.org <https://community.plone.org/>`_ - Official community forum, the best place to get help.\n@@ -98,5 +97,5 @@ Official Resources\n * `training.plone.org <https://training.plone.org/>`_ - Training classes for developers/integrators/users/designers.\n * `plone.api <https://docs.plone.org/develop/plone.api/docs/index.html>`_ - Documentation for plone.api.\n * `plone.restapi <https://plonerestapi.readthedocs.io/en/latest/>`_ - Documentation for plone.restapi.\n-* `official Gitter chat <https://gitter.im/plone/public>`_ - monitored.\n+* `official Discord chat <https://discord.gg/w8e5WCAKGs>`_ - Join link.\n \ndiff --git a/docs/HISTORY.txt b/docs/HISTORY.rst\nsimilarity index 95%\nrename from docs/HISTORY.txt\nrename to docs/HISTORY.rst\nindex 06a08a99aa..15e39e0977 100644\n--- a/docs/HISTORY.txt\n+++ b/docs/HISTORY.rst\n@@ -1,7 +1,663 @@\n Historical release notes\n ========================\n \n-For what\'s new in this release, see CHANGES.txt.\n+This contains the changelogs from older releases.\n+Note that there are large gaps, for example there is nothing between 4.3.3 and 5.0.0.\n+So the value of this historical record is currently doubtful.\n+\n+For what\'s new in the current release, see CHANGES.txt.\n+\n+\n+5.2.2 (2020-08-16)\n+------------------\n+\n+Bug fixes:\n+\n+\n+- Release Plone 5.2.2 final.\n+  No changes with last release candidate, except that the versions will contain Products.isurlinportal 1.1.0 with a minor security hardening fix.\n+  [maurits] (#3510)\n+\n+\n+5.2.2rc3 (2020-08-16)\n+---------------------\n+\n+Bug fixes:\n+\n+\n+- Return a Zope aware engine for page templates based on ``zope.pagetemplate`` instead of ``Products.PageTemplates``.\n+  Fixes possible problems with such templates, for example z3c.form ones, with Zope 4.4 and higher.\n+  See `issue 3141 <https://github.com/plone/Products.CMFPlone/issues/3141>`_.\n+  [maurits] (#3141)\n+- Depend on new package ``Products.isurlinportal``.\n+  This contains the ``isURLInPortal`` method that was split off from our ``URLTool``.\n+  See `issue 3150 <https://github.com/plone/Products.CMFPlone/issues/3150>`_.\n+  [maurits] (#3150)\n+- Redirection view: refactor our navigation root editing to a separate method ``edit_for_navigation_root``.\n+  Since Plone 5.2 the redirectiontool respects INavigationroot:\n+  with a manual redirect you cannot enter a path starting with ``/`` which \'escapes\' the NavigationRoot to the SiteRoot to link to another part of the Plone instance.\n+  This refactor makes it possible to override this method to return the redirection unchanged, brining back the pre Plone 5.2 behavior of the ``Products.RedirectionTool`` add-on.\n+  [maurits] (#3153)\n+- Control panel configlets: first check visibility, then check condition.\n+  Visibility is cheaper to check.\n+  Also fixes `bug 3154 <https://github.com/plone/Products.CMFPlone/issues/3154>`_.\n+  [maurits] (#3154)\n+\n+\n+5.2.2rc2 (2020-07-17)\n+---------------------\n+\n+Bug fixes:\n+\n+\n+- Fix an issue in mail_password_template.pt in the message showing the ip to really try the request.REMOTE_ADDR variable if request.HTTP_X_FORWARDED_FOR is empty (when you\'re not behind apache or nginx).\n+  [vincentfretin] (#2949)\n+- mail_password form: Do not crash if the userid is not provided or the user doesn\'t have an email configured\n+  [frapell] (#3008)\n+\n+\n+5.2.2rc1 (2020-06-28)\n+---------------------\n+\n+New features:\n+\n+\n+- Image caption support\n+  Allow ``figcaption`` in rich text editor as a valid tag.\n+  Add registry setting for plone.image_caption outputfilter transform.\n+  [thet] (#2887)\n+- Add markdown extension settings to markup control panel.\n+  [thomasmassmann] (#3076)\n+- Insert virtual custom.css bundle into the header after diazo bundle.\n+  Only add this when custom css is set in the theming control panel.\n+  [MrTango] (#3086)\n+\n+\n+Bug fixes:\n+\n+\n+- Change control panel item sorting and sort them by title\n+  [erral] (#721)\n+- Update HTMLFilter settings to enable TinyMCE styling features. See #2329, #2482, #2535\n+  [petschki] (#2482)\n+- If \'tinymce-content-css\' option is missing in themes manifest.cfg prevent unnecessary loading of a css at nav_root_url while editing a page.  [krissik] (#2861)\n+- Redirect (when possible) also ajax requests and do not return an unuseful body\n+  [ale-rt] (#3014)\n+- Merge Hotfix20200121 Check of the strength of password could be skipped. (#3021)\n+- Merge Hotfix20200121: isURLInPortal could be tricked into accepting malicious links. (#3021)\n+- Improve tests for the workflow tool method listWFStatesByTitle (#3032)\n+- Fix index_html on PortalRoot: ReplaceableWrapper did not work.\n+  [jensens] (#3060)\n+- Allow accessing ``plone_view.patterns_settings``.\n+  This was no problem until now, but a newer ``Zope/zope.tales/Chameleon``  is rightly stricter.\n+  [maurits] (#3066)\n+- Fix Python 3.8 ``time.clock`` removal in CatalogTool [jensens] (#3082)\n+- Fixed TypeError when adding both a group and a user to a group.\n+  [maurits] (#3084)\n+- Make the resource registry scripts output more robust when a bundle resource is missing. This prevents\n+  breaking your whole Plone site and access to the resource registry control panel after inserting\n+  one missing resource.\n+  [fredvd] (#3096)\n+- Bugfix for #3103\n+  [petschki] (#3105)\n+- Fixed saving ignored exception types in Python 3.  [maurits] (#3115)\n+\n+\n+5.2.1 (2020-01-13)\n+------------------\n+\n+New features:\n+\n+\n+- Add plone.staticresources to list of addons which are automatically upgraded if upgrade steps are available.\n+  [thet] (#2976)\n+\n+\n+Bug fixes:\n+\n+\n+- fix creation of Plone site not adding default Dexterity content types if example content not explicitily selected by user.\n+  [ericof] (#1318)\n+- fix default value for email msgid\n+  [erral] (#2790)\n+- Fix: PasswordResetView::getErrors is called, this ensures password is validated through RegistrationTool before attempting to reset password.\n+  [nazrulword] (#2917)\n+- Breadcrumbs: consider hidden folders when creating urls [ksuess] (#2935)\n+- Add Collection to the default_page_types list\n+  [erral] (#2956)\n+- Fix localization of "Site setup" in some control panels [vincentfretin] (#2958)\n+- Fix TTW Bundle compilation broken.\n+  [thet] (#2969)\n+- Do not save type settings in "content-controlpanel" when switching between types.\n+  [cekk] (#2986)\n+- Correctly fire events when user autologin after the password has been reset.\n+  [ericof] (#2993)\n+\n+\n+5.2.0 (2019-07-10)\n+------------------\n+\n+Bug fixes:\n+\n+\n+- Don\'t activate all sorting tabs when no sort option has been chosen.\n+  [gyst, rodfersou, jensens] (#1789)\n+- Fix test failures exposed in Python 3.8\n+  [pbauer] (#2903)\n+\n+\n+5.2rc5 (2019-06-27)\n+-------------------\n+\n+New features:\n+\n+\n+- Add support for Python 3.8 [pbauer] (#2896)\n+\n+\n+Bug fixes:\n+\n+\n+- Add missing i18n:translate calls\n+  [erral] (#2891)\n+- Fix login-help layout on mobile.\n+  [jensens] (#2893)\n+\n+\n+5.2rc4 (2019-06-20)\n+-------------------\n+\n+New features:\n+\n+\n+- Remove verifydb, it was moved to standalone package zodbverify.\n+  [jensens] (#2858)\n+\n+\n+Bug fixes:\n+\n+\n+- If specified in the registry, let the user autologin after the password has been reset (#2439)\n+- Allow empty ``default_page`` registry setting\n+  [petschki] (#2813)\n+- Always add ``data-default-sort`` attribute to search results.  [maurits] (#2854)\n+- Fix deprecation warnings.\n+  [jensens] (#2862)\n+- Use the shared \'Plone test setup\' and \'Plone test teardown\' keywords in Robot tests.\n+  [Rotonen] (#2864)\n+- Fix script resource parsing error because of self closing tags.\n+  [Netroxen] (#2870)\n+\n+\n+5.2rc3 (2019-05-04)\n+-------------------\n+\n+New features:\n+\n+\n+- Allow filtering on date and manual/automatic in redirection controlpanel. (#2799)\n+- Add a button to export the alternative urls in redirection controlpanel. (#2799)\n+- Add a button to remove all alternative urls that match the filter.\n+  See `issue 2799 <https://github.com/plone/Products.CMFPlone/issues/2799>`_.\n+  [maurits] (#2799)\n+\n+\n+Bug fixes:\n+\n+\n+- gracefully handle tracebacks during addon installation\n+  [petschki] (#2228)\n+- Add workaround for the case when a inifite recusion in a page-template that uses the main-template crashes the instance instead of raising a RecursionError.\n+  [pbauer, esteele] (#2666)\n+- Fixed unstable Markup Control Panel robot test again.  [maurits] (#2809)\n+- add a missing space in an error message in the redirects control panel and replace "deffered" by "deferred" [vincentfretin] (#2821)\n+- Fixes: Cooking resources with non ASCII resulted in encoding error.\n+  Further, writing legacy resources resulted in ValueError. [jensens] (#2827)\n+- restore ``exclude_from_nav`` combined with ``show_excluded_items`` handling\n+  [petschki] (#2828)\n+- Fix DeprecationWarning in syndication-view. [jensens] (#2831)\n+- Fix malformed url when redirecting to external login. [ericof] (#2842)\n+- Make navigation (CatalogNavigationTabs) subclassing easier. [iham] (#2849)\n+\n+\n+5.2rc2 (2019-03-21)\n+-------------------\n+\n+Bug fixes:\n+\n+\n+- Fix excluded items in navigation [ale-rt] (#2516)\n+- Add basic validators for the portal action controlpanel forms (#2689)\n+- Fix wrong msgids in link management control panel [erral] (#2788)\n+- Fix errors that abort the verification when debugging a DB with ./bin/instance verifydb -D.\n+  [pbauer] (#2792)\n+- Add summary of all errors when verifying a DB with ./bin/instance verifydb.\n+  [pbauer] (#2798)\n+- Fixed unstable SearchableText and Scenario Type querystring robot tests.  [maurits] (#2808)\n+- Fixed unstable Markup Control Panel and other robot tests.   [maurits] (#2809)\n+\n+\n+5.2rc1 (2019-03-04)\n+-------------------\n+\n+New features:\n+\n+\n+- Views for title and description. [iham] (#2740)\n+- Display wsgi-state plus name and version of the server in the controlpanel\n+  [pbauer] (#2770)\n+- Enable dropdown-navigation for new sites by default. [pbauer] (#2772)\n+\n+\n+Bug fixes:\n+\n+\n+- Resolve circular dependency between `Products.CMFPlone` and `plone.i18n` by\n+  moving `ILanguageSchema` there. [sallner] (#2049)\n+- Use correct permission for mail controlpanel form so that Site Administrators\n+  can also edit. [fredvd] (#2688)\n+- Make linkintegrity robot test more reliable [MrTango] (#2752)\n+- Check only once if Products.ATContentTypes is available. [gforcada] (#2765)\n+- Fix redirection to `came_from` when url matches LOGIN_TEMPLATE_ID partly\n+  [petschki] (#2771)\n+\n+\n+5.2b1 (2019-02-13)\n+------------------\n+\n+Breaking changes:\n+\n+\n+- Factor out all static resources and the ``plone-compile-resources`` script\n+  into plone.staticresources. [thet] (#2542)\n+\n+\n+New features:\n+\n+\n+- PLIP 1486: Merge Products.RedirectionTool into core. Allow users to manage\n+  redirects on their site and aliases to content. See\n+  https://github.com/plone/Products.CMFPlone/issues/1486 [staeff, maurits]\n+  (#1486)\n+- Added multilevel dropdown navigation [agitator] (#2516)\n+- No longer mark special links by default. [pbauer] (#2736)\n+\n+\n+Bug fixes:\n+\n+\n+- Switched allowedRolesAndUsers indexer from \'View\' to the correct permission\n+  \'Access contents information\' for displaying metadata. \'View\' permission\n+  should be used on the item itself. The change should not matter for default\n+  Plone workflows, since they always use those permissions together. [agitator]\n+  (#260)\n+- deprecate catalog_get_all(catalog) in favor of catalog.getAllBrains()\n+  [pbauer] (#2258)\n+- Restore the possibility to sort catalog query results with multiple indexes\n+  (#2464)\n+- Review list portlet showed nothing to review with plone.app.multilingual, As\n+  WorkflowTool bypassed languages only for p.a.m<2.x or linguaplone. fixed and\n+  now compatible to both lang-bypassing methods. [iham] (#2595)\n+- Fixed fallback to default view when selected layout does not exist for\n+  Folder. [gbastien] (#2645)\n+- The patched init method for the class zope.sendmail.mailer.SMTPMailer has\n+  been updated, fixing a bug that was preventing to send emails. [ale-rt,\n+  nazrulworld] (#2665)\n+- a11y: Added role attribute for portalMessage [nzambello] (#2675)\n+- Fix several warnings shown when running tests on Python 3+. [gforcada]\n+  (#2683)\n+- fixed Python 3 related str decoding issue in breadcrumbs (#2694)\n+- Fixed unstable robot test Scenario: A page is opened to edit in TinyMCE.\n+  [maurits] (#2707)\n+\n+\n+5.2a2 (2018-12-30)\n+------------------\n+\n+New features:\n+\n+\n+- New robot tests for querystring in Collection type. Now almost all\n+  querystring types are robot tested. [llisa123] (#2489)\n+- Add ``load_async`` and ``load_defer`` attributes to resource registries\n+  bundle settings. When set, ``<script>`` tags are rendered with\n+  ``async="async"`` resp. ``defer="defer"`` attributes. You also need to empty\n+  the ``merge_with`` property of your bundle, because production bundles\n+  (``default.js`` and ``logged-in.js``) are never loaded with async or defer.\n+  The default.js includes jQuery and requirejs and those are needed at many\n+  places and therefore cannot be loaded asynchronously. Refs: #2649, #2657.\n+  [thet] (#2649)\n+\n+\n+Bug fixes:\n+\n+\n+- Delete ``fa_ir.js``. Keep ```fa_IR.js``. [maurits] (#2620)\n+- Forward port TinyMCE fixes from 5.1 [vangheem] (#2630)\n+- Fix robot test test_edit_user_schema: Fieldname was set duplicate (first by\n+  JS, then by robot). [jensens] (#2669)\n+\n+5.2a1 (2018-11-08)\n+------------------\n+\n+Breaking changes:\n+\n+- Removed generateUniqueId.py skins script (after it was added to Products.Archetypes).\n+  This script is no longer available outside Archetypes world.\n+  #1801\n+  [jensens]\n+\n+- Remove all dependencies on plone.app.controlpanel.\n+  Third party code need either to depend on plone.app.controlpanel 4.0,\n+  which is a backward compatibility package only, or also update to not depend on it anymore.\n+  [jensens]\n+\n+- Removed check_id.py skin script.  Replaced with utils.check_id function.\n+  #1801 and #2582.\n+  [maurits]\n+\n+- Removed my_worklist.py skin script. #1801\n+  [reinhardt]\n+\n+- Removed getObjectsFromPathList.py skin script. #1801\n+  [reinhardt]\n+\n+- Removed isExpired.py skin script. #1801\n+  [reinhardt]\n+\n+- Removed redirectToReferrer.py skin script. #1801\n+  [tlotze]\n+\n+- Removed enableHTTPCompression.py skin script. #1801\n+  [tlotze]\n+\n+- Removed setAuthCookie.py skin script. #1801\n+  [tlotze]\n+\n+- Stop configuring \'View History\' permission which was removed from Zope.\n+  [davisagli]\n+\n+- Removed legacy resource registries portal_css and portal_javascripts;\n+  no conditional handling.\n+  [ksuess]\n+\n+New features:\n+\n+- Factored out human_readable_size method for replacing getObjSize.py;\n+  removed getObjSize.py. #1801\n+  [reinhardt]\n+\n+- Update TinyMCE to 4.7.13\n+  [erral]\n+\n+- New browser view based login code - merged from plone.login (credits to esteele, pbauer, agitator, jensens, et al).\n+  `portal_skins/plone_login` is now gone, see PLIP #2092.\n+  Also, password reset view moved to login subfolder to keep things together.\n+  Some testbrowser based tests needed changes because of z3c.form based login form .\n+  The Plone specific, rarely used cross site __ac cookie SSO feature/hack was removed.\n+  In case somebody needs this, please make it an addon package.\n+  Better use a field proven, more secure way, like OAuth2, Shibboleth or someting similar.\n+  [jensens, et al]\n+\n+- Upgrade grunt + plugins to same versions as in\n+  mockup https://github.com/plone/mockup/pull/870\n+  [sunew]\n+\n+- Upgrade less in bower.json to the same version as already used\n+  in the generated package.json in compile_resources.py.\n+  [sunew]\n+\n+- Add utility-method safe_nativestring.\n+  [pbauer]\n+\n+- Rename safe_unicode to safe_text and safe_encode to safe_bytes. Keep old aliases.\n+  [pbauer]\n+- Add a ``bin/instance verifydb`` command which can be used to check\n+  that all records in the database can be successfully loaded.\n+  This is intended to help with verifying a database conversion\n+  from Python 2 to Python 3.\n+  [davisagli]\n+\n+Bug fixes:\n+\n+- Modernize robot keywords that use "Get Element Attribute"\n+  [ale-rt]\n+\n+- remove plone.app.folder dependency\n+  [petschki]\n+\n+- move GopipIndex Class to plone.folder\n+  [petschki]\n+\n+- Fixed getObjSize indexer for Python 3. #2526\n+  [reinhardt]\n+- Fix toolbar menu on mobile #2333.\n+- make groups_modify_roles test more robust.\n+  [tschorr]\n+\n+-- Fix wrong CSS property to allow correct word-break.\n+  [tmassman]\n+\n+ Fix toolbar menu on mobile #2333.\n+  [tmassman]\n+\n+- Removed the ``raiseUnauthorized`` skin script.\n+  If you use this, please do permission checking in your own Python code instead (likely in a browser view).\n+  Refs `issue 1801 <https://github.com/plone/Products.CMFPlone/issues/1801>`_.\n+  [maurits]\n+\n+- Remove the devdependencies from bower.json - they are just used for running tests in mockup, not here.\n+  [sunew]\n+\n+- Adapt tests to `Products.GenericSetup >= 2.0` thus requiring at least that\n+  version.\n+  [icemac]\n+\n+- Some tools from CMFCore are now utilities\n+  [pbauer]\n+\n+- Fix failing thememapper robot test after rebuild of thememapper bundle in p.a.theming PR 148\n+  [sunew]\n+\n+- Remove five.pt for Zope 4\n+  [jensens]\n+\n+- Changes for Zope 4 compatibility in maintenance controlpanel.\n+  [thet]\n+\n+- Render exceptions using an exception view instead of standard_error_message.\n+  [davisagli]\n+\n+- Remove old PlacelessTranslationService.\n+  [jensens, ksuess]\n+\n+- Fix controlpanel quickinstaller view:\n+  A not yet installed product must not return any upgrade info.\n+  [jensens]\n+\n+- Fix to make plone/plone.session#11 work:\n+  Make test for installation of  plone.session more explicit.\n+  [jensens]\n+\n+- Advanced Catalog Clear And Rebuild feature showed wrong processing time due to new queue processing.\n+  This was fixed bei calling ``processQueue()`` after indexing.\n+  [jensens]\n+\n+- Some nested `section id="edit-bar"` tag in folder_contents page #2322\n+  [terapyon]\n+\n+- Remove ``plone-generate-gruntfile`` (it is all available through ``plone-compile-resources``).\n+  [jensens]\n+\n+- Migrate from ``slimit`` to ``calmjs.parse`` for the JavaScript cooker #2616\n+  [metatoaster]\n+\n+\n+New Features:\n+\n+- Update to latest mockup\n+  [frapell]\n+\n+- Provide an utility ``dump_json_to_text`` that works both on Python 2.7 an Python 3.\n+  [ale-rt]\n+\n+- Prepare for Python 2 / 3 compatibility.\n+  [pbauer]\n+\n+- Fix imports to work with Python 3.\n+  [pbauer]\n+\n+- Mockup update.\n+  [thet]\n+\n+- add link to Plone.org VPAT accessibility statement\n+  [tkimnguyen]\n+\n+Bug Fixes:\n+\n+- Remove last legacy Javascript ``highlight-searchterms.js``.\n+  Removes also the skins folder ``plone_ecmascript``.\n+  It was broken for all (Google, other search engines, own live search);\n+  JS worked only when coming from Plone detailed search.\n+  [jensens]\n+\n+- Fix an undefined variable in a test helper function\n+  [ale-rt]\n+\n+- Let the ``combine-bundles`` import step also work when the ``IBundleRegistry`` keyword is not in ``registry.xml``, but in a ``registry`` directory.\n+  `Issue 2520 <https://github.com/plone/Products.CMFPlone/issues/2502>`_.\n+  [maurits]\n+\n+- Get rid of obsolete ``X-UA-Compatible`` header.\n+  [hvelarde]\n+\n+- Fix registration of ``robots.txt`` browser view to avoid ``AttributeError`` on Zope\'s root (fixes `#2052 <https://github.com/plone/Products.CMFPlone/issues/2052>`_).\n+  [hvelarde]\n+\n+- Get rid of obsolete ``X-UA-Compatible`` header.\n+  [hvelarde]\n+\n+- Add test for issue #2469.\n+  [jensens]\n+\n+- Fixed tests when IRichText behavior is used.\n+  IRichText -> IRichTextBehavior\n+  This is a follow up to `issue 476 <https://github.com/plone/plone.app.contenttypes/issues/476>`_.\n+  [iham]\n+\n+- Remove unused mail_password.py from skins/plone_scripts\n+  [agitator]\n+\n+- Hide ``plone.app.querystring`` from add-ons control panel.\n+  Fixes `issue 2426 <https://github.com/plone/Products.CMFPlone/issues/2426>`_.\n+  [maurits]\n+\n+- Fix tests after changes in disallowed object ids in Zope.\n+  [pbauer]\n+\n+- Do not include too new upgrades when upgrading Plone Site.\n+  Otherwise the Plone Site ends up at a newer version that the filesystem code supports,\n+  giving an error when upgrading, and resulting in possibly missed upgrades later.\n+  Fixes `issue 2377 <https://github.com/plone/Products.CMFPlone/issues/2377>`_.\n+  [maurits]\n+\n+- After site creation, do not render the add-site template: we redirect anyway.\n+  [maurits]\n+\n+- Unflakied a unit test.\n+  [Rotonen]\n+\n+- Do not show TinyMCE menu items with no subitems, Fixes #2245.\n+  [mrsaicharan1]\n+\n+- Fix Exception-View when main_template can\'t be rendered. Fixes #2325.\n+  [pbauer]\n+\n+- Render exceptions as text, not html to fix format of infos after traceback.\n+  Display as <pre> for basic and normal error templates.\n+  [pbauer]\n+\n+- Removed extra methods and tests for CMFQuickInstallerTool.\n+  Moved those to the Products.CMFQuickInstallerTool package.\n+  [maurits]\n+\n+- Added tests for add-ons control panel.\n+  Add a link to the Site Setup.\n+  Let ``get_product_version`` work when you call it with ``CMFPlacefulWorkflow`` too.\n+  [maurits]\n+\n+- Fix bad domain for translating password reset mails.\n+  [allusa]\n+\n+- Ignore invalid ``sort_on`` parameters in catalog ``searchResults``.\n+  Otherwise you get a ``CatalogError``.\n+  I get crazy sort_ons like \'194\' or \'null\'.\n+  [maurits]\n+\n+- Register the ``ExceptionView`` for the unspecific ``zope.interface.Interface`` for easier overloading.\n+  Fixes a problem, where plone.rest couldn\'t overload the ExceptionView with an adapter bound to ``plone.rest.interfaces.IAPIRequest``.\n+  [thet]\n+\n+- Fixed linkintegrity robot tests.  [maurits]\n+\n+- Fixed flaky actions controlpanel tests by waiting longer.  [maurits]\n+\n+- Require AccessControl 4.0b1 so ``guarded_getitem`` is used.\n+  Part of PloneHotfix20171128.  [maurits]\n+\n+- Improved isURLInPortal according to PloneHotfix20171128.\n+  Accept only http/https, and doubly check escaped urls.  [maurits]\n+\n+- Fix exception view when called on Zope-root. Fixes #2203.\n+  [pbauer]\n+\n+- added CSS hyphenation support for toolbar for avoiding ugly text wrapping\n+  Fixes `issue 723 <https://github.com/plone/Products.CMFPlone/issues/723>`_.\n+  [ajung]\n+\n+- Increase compatibility with Python3.\n+  [ale-rt]\n+\n+- Show example for expression in actions control panel.\n+  [maurits]\n+\n+- Fix test where you cannot instanciate a PythonScript with the id script.\n+  [pbauer]\n+\n+- Set the status of an exception view according to the exception type.\n+  Fixes `issue 2187 <https://github.com/plone/Products.CMFPlone/issues/2187>`_.\n+  [maurits]\n+\n+- Use absolute imports for Python3 compatibility\n+  [ale-rt]\n+\n+- Fallback for missing date in DefaultDublinCoreImpl no longer relies on\n+  bobobase_modification_time.\n+  [pbauer]\n+\n+- Display real version of Zope, not of the empty meta-package Zope2.\n+  [pbauer]\n+\n+- Add zcml-condition plone-52 for conditional configuration.\n+  [pbauer]\n+\n+- Use getSite in set_own_login_name to get the portals acl_users.\n+  [pbauer]\n+\n+- Fix test issue with rarely used multi-site SSO feature.\n+  ``came_from`` on ``@register`` link would point to wrong site.\n+  Completly removed ``came_from`` on ``@@register`` link.\n+  It does not make much sense anyway and we test nowhere if there is a came_from on that link.\n+  [jensens]\n+\n+- Remove depricated ``type`` attribute from ``script`` and ``link`` tags.\n+  [newbazz]\n+\n+- Render tinymce attributes correctly in Python3.\n+  [sallner]\n+\n+- Remove unresolved dependencies of plone-final to cssregistry and jsregistry.\n+  [pbauer]\n \n \n 5.1rc2 (unreleased)\n@@ -155,7 +811,7 @@ Bug fixes:\n - Gruntfile generation no longer fails on introspecting resourceDirectory\n   configurations using a plone.browserlayer layer, by loading all layers\n   configured for the site used during generation.\n-  Fixes Issue `#2080`_.\n+  Fixes `issue 2080 <https://github.com/plone/Products.CMFPlone/issues/2080>`_.\n   [seanupton]\n \n - fixed css-classes for thumb scales ...\n@@ -2380,7 +3036,7 @@ Fixes:\n \n \n 4.2.1.1 (2012-08-23)\n-------------------\n+--------------------\n \n - Fixed i18n of image view improvement introduced in 4.2.1.\n   [vincentfretin]\n@@ -2400,8 +3056,10 @@ Fixes:\n   [thomasdesvenain]\n \n - Improve image view:\n+\n     - Add a download button.\n     - Display View button only if image is a web format (jpeg, png, gif...)\n+\n   [thomasdesvenain]\n \n - zope.globalrequest is a required dependency on tests.\ndiff --git a/news/1775.breaking b/news/1775.breaking\ndeleted file mode 100644\nindex 57adb5939b..0000000000\n--- a/news/1775.breaking\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-Removed our CMFQuickInstallerTool code completely.\n-See `PLIP 1775 <https://github.com/plone/Products.CMFPlone/issues/1775>`_.\n-[maurits]\ndiff --git a/news/1924.bugfix b/news/1924.bugfix\ndeleted file mode 100644\nindex 2e529f9963..0000000000\n--- a/news/1924.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-No longer doubly undo a response Content-Type change when combining bundles.\n-[maurits]\ndiff --git a/news/3007.bugfix b/news/3007.bugfix\ndeleted file mode 100644\nindex a451e1cb14..0000000000\n--- a/news/3007.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fix issue with @@search view when filtering by creation date\n-[frapell]\ndiff --git a/news/3021.bugfix.1 b/news/3021.bugfix.1\ndeleted file mode 100644\nindex 23fa8a5e79..0000000000\n--- a/news/3021.bugfix.1\n+++ /dev/null\n@@ -1 +0,0 @@\n-Merge Hotfix20200121 Check of the strength of password could be skipped.\ndiff --git a/news/3021.bugfix.2 b/news/3021.bugfix.2\ndeleted file mode 100644\nindex b48698a2db..0000000000\n--- a/news/3021.bugfix.2\n+++ /dev/null\n@@ -1 +0,0 @@\n-Merge Hotfix20200121: isURLInPortal could be tricked into accepting malicious links.\ndiff --git a/news/3032.bugfix b/news/3032.bugfix\ndeleted file mode 100644\nindex b39fbdbd46..0000000000\n--- a/news/3032.bugfix\n+++ /dev/null\n@@ -1 +0,0 @@\n-Improve tests for the workflow tool method listWFStatesByTitle\ndiff --git a/news/3039.bugfix b/news/3039.bugfix\ndeleted file mode 100644\nindex b6bbf9b03a..0000000000\n--- a/news/3039.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-A default WSGI configuration requires Paste which is only installed with the Zope[wsgi] extra..\n-[tschorr]\ndiff --git a/news/3041.breaking b/news/3041.breaking\ndeleted file mode 100644\nindex 35dd0001eb..0000000000\n--- a/news/3041.breaking\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-A part of "Drop Python 2 Support for Plone 6" #2812:\n-Reflect dropping of Python 2 support in setup.py.\n-Bump version to 6.0\n-[jensens]\n\\ No newline at end of file\ndiff --git a/news/3057.breaking b/news/3057.breaking\ndeleted file mode 100644\nindex 2a3f6fe38a..0000000000\n--- a/news/3057.breaking\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-Removed ``folder_publish.cpy`` script.\n-Replaced with folder_publish browser view in ``plone.app.content``.\n-Removed deprecated transitionObjectsByPaths.\n-[maurits]\ndiff --git a/news/3084.feature b/news/3084.feature\ndeleted file mode 100644\nindex f0401c53cf..0000000000\n--- a/news/3084.feature\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-Custom date format strings from registry can be in the ``${}`` format as in the locales files. \n-If theres a day or month name used, this will be translated. \n-For bbb the classic strftime ``%`` strings are still behaving like before.\n-[jensens]\ndiff --git a/news/3130.bugfix.1 b/news/3130.bugfix.1\ndeleted file mode 100644\nindex 8d468956a7..0000000000\n--- a/news/3130.bugfix.1\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fixed deprecation warning for zope.site.hooks.\n-[maurits]\ndiff --git a/news/3130.bugfix.2 b/news/3130.bugfix.2\ndeleted file mode 100644\nindex eaf1dfb681..0000000000\n--- a/news/3130.bugfix.2\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fixed invalid escape sequences in regular expressions.\n-[maurits]\ndiff --git a/news/3130.bugfix.3 b/news/3130.bugfix.3\ndeleted file mode 100644\nindex cd3f6d8005..0000000000\n--- a/news/3130.bugfix.3\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fixed use of own ``utils.isDefaultPage``, which should be ``defaultpage.check_default_page_via_view``.\n-[maurits]\ndiff --git a/news/3175.bugfix b/news/3175.bugfix\ndeleted file mode 100644\nindex 87c3366fe6..0000000000\n--- a/news/3175.bugfix\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-PloneBatch: define ``__bool__`` as copy of ``__nonzero__``.\n-Python 3 calls ``__bool__`` when doing ``bool(batch)``.\n-[maurits]\ndiff --git a/news/3176.bugfix b/news/3176.bugfix\ndeleted file mode 100644\nindex 56e075e5e5..0000000000\n--- a/news/3176.bugfix\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-No longer consider calling ``len(batch)`` as deprecated.\n-The deprecation warning is unvoidable with current ``Products.PageTemplates`` code.\n-Fixes `issue 3176 <https://github.com/plone/Products.CMFPlone/issues/3176>`_.\n-maurits\ndiff --git a/news/3178.bugfix b/news/3178.bugfix\ndeleted file mode 100644\nindex c62697d906..0000000000\n--- a/news/3178.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fix tests with Products.MailHost 4.10.\n-[maurits]\ndiff --git a/news/3183.breaking.1 b/news/3183.breaking.1\ndeleted file mode 100644\nindex 5e033098be..0000000000\n--- a/news/3183.breaking.1\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Remove six at all places where used. [jensens]\n-\ndiff --git a/news/3183.breaking.2 b/news/3183.breaking.2\ndeleted file mode 100644\nindex 471fabfa1e..0000000000\n--- a/news/3183.breaking.2\n+++ /dev/null\n@@ -1 +0,0 @@\n-Remove ``portal_utf8`` and it twin ``utf8_portal`` from ``utils`` and ``PloneTool`` since its never used nowhere. [jensens]\ndiff --git a/news/3185.bugfix b/news/3185.bugfix\ndeleted file mode 100644\nindex c5811901a6..0000000000\n--- a/news/3185.bugfix\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-Applied: `find . -name "*.py" |grep -v skins|xargs pyupgrade --py36-plus --py3-only`.\n-This auto-rewrites Python 2.7 specific syntax and code to Python 3.6+.\n-[jensens]\ndiff --git a/news/3195.bugfix b/news/3195.bugfix\ndeleted file mode 100644\nindex 85ee3939e4..0000000000\n--- a/news/3195.bugfix\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-Robot tests: Do not use jQuery.size() but use ``.length`` instead.\n-``.size()`` is deprecated since 1.8.\n-[thet]\ndiff --git a/news/3208.breaking b/news/3208.breaking\ndeleted file mode 100644\nindex 8b3631dc40..0000000000\n--- a/news/3208.breaking\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-Remove `meta_type` index and metadata from catalog. \n-Both were unused in Plone core and rarely used in addons.\n-[jensens]\ndiff --git a/news/3214.bugfix b/news/3214.bugfix\ndeleted file mode 100644\nindex 8404902d38..0000000000\n--- a/news/3214.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Remove traces of Archetypes\n-[pbauer]\n\\ No newline at end of file\ndiff --git a/news/3382.bugfix b/news/3382.bugfix\nnew file mode 100644\nindex 0000000000..6060ed990a\n--- /dev/null\n+++ b/news/3382.bugfix\n@@ -0,0 +1,2 @@\n+Changed \'Powered by\' text\n+[rohnsha0]\ndiff --git a/news/3475.bugfix b/news/3475.bugfix\nnew file mode 100644\nindex 0000000000..cb38b56977\n--- /dev/null\n+++ b/news/3475.bugfix\n@@ -0,0 +1,2 @@\n+Fix active tab in ``@@test-rendering-icons``.\n+[petschki]\ndiff --git a/news/3536.bugfix b/news/3536.bugfix\nnew file mode 100644\nindex 0000000000..b5bbe81cbc\n--- /dev/null\n+++ b/news/3536.bugfix\n@@ -0,0 +1,2 @@\n+Do not create title tag for svg icons when tag_alt is not given.\n+[agitator]\n\\ No newline at end of file\ndiff --git a/news/3568.bugfix b/news/3568.bugfix\nnew file mode 100644\nindex 0000000000..450997a173\n--- /dev/null\n+++ b/news/3568.bugfix\n@@ -0,0 +1,2 @@\n+Fixed all known instances of plone.com in plone/Products.CMFPlone\n+[rohnsha0]\ndiff --git a/news/3581.bugfix b/news/3581.bugfix\nnew file mode 100644\nindex 0000000000..32eba96b1f\n--- /dev/null\n+++ b/news/3581.bugfix\n@@ -0,0 +1,2 @@\n+Allow access to the macros of the main_template, also from skin templates.\n+[maurits]\ndiff --git a/news/3582.bugfix b/news/3582.bugfix\nnew file mode 100644\nindex 0000000000..805f4bdb48\n--- /dev/null\n+++ b/news/3582.bugfix\n@@ -0,0 +1,2 @@\n+Robot tests: be more specific when clicking some elements.\n+[maurits]\ndiff --git a/news/3584.bugfix b/news/3584.bugfix\nnew file mode 100644\nindex 0000000000..b83dbc1f59\n--- /dev/null\n+++ b/news/3584.bugfix\n@@ -0,0 +1,2 @@\n+Set portal title in registry when creating a new Plone site\n+[erral]\ndiff --git a/news/3587.bugfix b/news/3587.bugfix\nnew file mode 100644\nindex 0000000000..dd9e106c25\n--- /dev/null\n+++ b/news/3587.bugfix\n@@ -0,0 +1,2 @@\n+Change test to make sure e-mail is sent in utf-8\n+[erral]\ndiff --git a/news/3605.bugfix b/news/3605.bugfix\nnew file mode 100644\nindex 0000000000..eb2d6e2a4a\n--- /dev/null\n+++ b/news/3605.bugfix\n@@ -0,0 +1,2 @@\n+Fixed an error where Main Template (line: 42) referenced plone.com istead of plone.org\n+[rohnsha0]\ndiff --git a/news/6007.bugfix b/news/6007.bugfix\nnew file mode 100644\nindex 0000000000..c0a2a0215b\n--- /dev/null\n+++ b/news/6007.bugfix\n@@ -0,0 +1,2 @@\n+Updated metadata version to 6007.\n+[maurits]\ndiff --git a/news/721.bugfix b/news/721.bugfix\ndeleted file mode 100644\nindex d6b094302b..0000000000\n--- a/news/721.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Change control panel item sorting and sort them by title\n-[erral]\ndiff --git a/setup.cfg b/setup.cfg\nindex 77b09549f4..a9ab3befbf 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -2,12 +2,10 @@\n extra-message = [ci skip]\n \n [bdist_wheel]\n-universal = 1\n+universal = 0\n \n [isort]\n+profile = black\n force_alphabetical_sort=True\n force_single_line=True\n lines_after_imports=2\n-line_length=80\n-not_skip=__init__.py\n-\ndiff --git a/setup.py b/setup.py\nindex 3c586e5684..2f0a3c5e0f 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -1,7 +1,7 @@\n from setuptools import setup\n from setuptools import find_packages\n \n-version = \'6.0a1.dev0\'\n+version = \'6.0.0b2.dev0\'\n \n \n setup(\n@@ -15,15 +15,14 @@\n         "Environment :: Web Environment",\n         "Framework :: Plone",\n         "Framework :: Plone :: 6.0",\n-        "Framework :: Zope",\n-        "Framework :: Zope :: 4",\n+        "Framework :: Plone :: Core",\n+        "Framework :: Zope :: 5",\n         "License :: OSI Approved :: GNU General Public License v2 (GPLv2)",\n         "Operating System :: OS Independent",\n         "Programming Language :: Python",\n-        "Programming Language :: Python :: 3.6",\n         "Programming Language :: Python :: 3.7",\n         "Programming Language :: Python :: 3.8",\n-        "Topic :: Internet :: WWW/HTTP :: Dynamic Content",\n+        "Programming Language :: Python :: 3.9",\n     ],\n     keywords=\'Plone CMF Python Zope CMS Webapplication\',\n     author=\'Plone Foundation\',\n@@ -35,27 +34,20 @@\n     include_package_data=True,\n     zip_safe=False,\n     install_requires=[\n-        \'AccessControl >= 4.0b1\',\n-        \'Acquisition\',\n         \'borg.localrole\',\n-        \'calmjs.parse\',\n-        \'DateTime\',\n-        \'ExtensionClass\',\n         \'five.customerize\',\n-        \'five.localsitemanager\',\n-        \'mockup\',\n-        \'Pillow\',\n+        \'lxml\',\n         \'plone.api >= 1.4.4\',\n         \'plone.app.content\',\n         \'plone.app.contentlisting\',\n-        \'plone.app.contentmenu >= 1.1.6dev-r22380\',\n+        \'plone.app.contentmenu >= 2.0.1\',\n         \'plone.app.contentrules\',\n         \'plone.app.contenttypes\',\n         \'plone.app.customerize\',\n         \'plone.app.dexterity\',\n         \'plone.app.discussion\',\n         \'plone.app.i18n\',\n-        \'plone.app.layout >=1.1.7dev-r23744\',\n+        \'plone.app.layout >= 2.5.15\',\n         \'plone.app.linkintegrity >=1.0.3\',\n         \'plone.app.locales\',\n         \'plone.app.multilingual\',\n@@ -68,11 +60,11 @@\n         \'plone.app.viewletmanager\',\n         \'plone.app.vocabularies\',\n         \'plone.app.workflow\',\n-        \'plone.batching\',\n-        \'plone.browserlayer >= 1.0rc4\',\n+        \'plone.base\',\n+        \'plone.browserlayer >= 2.1.5\',\n         \'plone.contentrules\',\n         \'plone.folder\',\n-        \'plone.i18n >= 4.0.4.dev0\',\n+        \'plone.i18n >= 4.0.5\',\n         \'plone.indexer\',\n         \'plone.intelligenttext\',\n         \'plone.locking\',\n@@ -81,68 +73,45 @@\n         \'plone.portlet.collection\',\n         \'plone.portlet.static\',\n         \'plone.portlets\',\n-        \'plone.protect >= 3.0.0a1\',\n-        \'plone.registry\',\n+        \'plone.protect >= 3.0.0\',\n+        \'plone.resource\',\n         \'plone.schema\',\n         \'plone.session\',\n         \'plone.staticresources\',\n-        \'plone.subrequest\',\n         \'plone.theme\',\n         \'plonetheme.barceloneta\',\n-        \'Products.CMFCore\',\n-        \'Products.CMFDiffTool\',\n-        \'Products.CMFDynamicViewFTI\',\n         \'Products.CMFEditions\',\n-        \'Products.CMFFormController\',\n-        \'Products.CMFUid\',\n         \'Products.DCWorkflow\',\n         \'Products.ExtendedPathIndex\',\n-        \'Products.GenericSetup >= 2.0.dev0\',\n         \'Products.isurlinportal\',\n         \'Products.MimetypesRegistry\',\n         \'Products.PlonePAS\',\n-        \'Products.PluggableAuthService\',\n-        \'Products.PluginRegistry\',\n         \'Products.PortalTransforms\',\n-        \'Products.Sessions\',\n         \'Products.SiteErrorLog\',\n         \'Products.statusmessages\',\n-        \'Products.TemporaryFolder\',\n-        \'pyScss\',\n         \'setuptools>=36.2\',\n-        \'transaction\',\n-        \'z3c.autoinclude\',\n-        \'ZODB3\',\n-        \'Zope[wsgi] >= 4.0b5\',\n+        \'plone.autoinclude\',\n+        \'webresource>=1.1\',\n+        \'Zope[wsgi] >= 5.0\',\n         \'zope.app.locales >= 3.6.0\',\n         \'zope.cachedescriptors\',\n-        \'zope.component\',\n-        \'zope.container\',\n         \'zope.deferredimport\',\n         \'zope.deprecation\',\n         \'zope.dottedname\',\n-        \'zope.event\',\n         \'zope.i18n\',\n         \'zope.i18nmessageid\',\n-        \'zope.interface\',\n-        \'zope.location\',\n-        \'zope.pagetemplate\',\n-        \'zope.publisher\',\n-        \'zope.site\',\n         \'zope.structuredtext\',\n-        \'zope.tal\',\n-        \'zope.tales\',\n-        \'zope.traversing\',\n     ],\n     extras_require={\n         \'test\': [\n             \'lxml\',\n             \'mock\',\n-            \'plone.app.robotframework>0.9.16\',\n+            \'plone.app.robotframework>=1.0\',\n             \'robotframework-debuglibrary\',\n             \'plone.app.testing\',\n             \'zope.globalrequest\',\n             \'zope.testing\',\n+            \'gunicorn\',\n         ]\n     },\n )\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-08-20T12:28:22+05:30
Author: Rohan Shaw (rohnsha0) <86848116+rohnsha0@users.noreply.github.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/4cc9b61a75ec7d63ff456bf6181a712f1d021c40

Merge branch 'master' into issue_3223

Files changed:
A news/3601.bugfix
A news/3609.bugfix
A news/3610.bugfix
A news/3614-2.bugfix
A news/3614.bugfix
A news/3615.bugfix
A news/3616.bugfix
M Products/CMFPlone/ActionsTool.py
M Products/CMFPlone/PloneBaseTool.py
M Products/CMFPlone/PloneTool.py
M Products/CMFPlone/RegistrationTool.py
M Products/CMFPlone/TranslationServiceTool.py
M Products/CMFPlone/__init__.py
M Products/CMFPlone/browser/author.py
M Products/CMFPlone/browser/navigation.py
M Products/CMFPlone/browser/ploneview.py
M Products/CMFPlone/browser/sendto.py
M Products/CMFPlone/browser/templates/main_template.pt
M Products/CMFPlone/configure.zcml
M Products/CMFPlone/controlpanel/browser/actions.pt
M Products/CMFPlone/controlpanel/browser/relations.py
M Products/CMFPlone/controlpanel/events.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py
M Products/CMFPlone/patches/csrf.py
M Products/CMFPlone/patterns/view.py
M Products/CMFPlone/profiles/default/actions.xml
M Products/CMFPlone/resources/browser/resource.py
M Products/CMFPlone/tests/testBrowserDefault.py
M Products/CMFPlone/tests/testPloneTool.py
M Products/CMFPlone/tests/testPloneView.py
M Products/CMFPlone/tests/testPortalCreation.py
M Products/CMFPlone/tests/test_PloneTool.py
M Products/CMFPlone/traversal.py
M Products/CMFPlone/utils.py

b'diff --git a/Products/CMFPlone/ActionsTool.py b/Products/CMFPlone/ActionsTool.py\nindex c8d4f8c92c..5ae39fb5f0 100644\n--- a/Products/CMFPlone/ActionsTool.py\n+++ b/Products/CMFPlone/ActionsTool.py\n@@ -2,55 +2,58 @@\n from AccessControl.class_init import InitializeClass\n from Products.CMFCore.ActionInformation import ActionInfo\n from Products.CMFCore.ActionsTool import ActionsTool as BaseTool\n+from Products.CMFCore.interfaces import IActionCategory\n from Products.CMFCore.interfaces import IActionProvider\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n-from Products.CMFCore.interfaces import IActionCategory\n \n \n class ActionsTool(PloneBaseTool, BaseTool):\n \n-    meta_type = \'Plone Actions Tool\'\n-    toolicon = \'skins/plone_images/confirm_icon.png\'\n+    meta_type = "Plone Actions Tool"\n+    toolicon = "skins/plone_images/confirm_icon.png"\n \n     security = ClassSecurityInfo()\n \n     #\n     #   ActionProvider interface\n     #\n-    security.declarePrivate(\'listActions\')\n-\n-    def listActions(self, info=None, object=None,\n-                    categories=None, ignore_categories=None):\n-        """ List all the actions defined by a provider.\n-        """\n+    @security.private\n+    def listActions(\n+        self, info=None, object=None, categories=None, ignore_categories=None\n+    ):\n+        """List all the actions defined by a provider."""\n         actions = list(self._actions)\n \n         if ignore_categories is None:\n             ignore_categories = ()\n \n         if categories is None:\n-            categories = [cat for cat in self\n-                          if cat not in ignore_categories]\n+            categories = [cat for cat in self if cat not in ignore_categories]\n         else:\n-            categories = [cat for cat in self\n-                          if cat in categories]\n+            categories = [cat for cat in self if cat in categories]\n \n         for category in categories:\n             if IActionCategory.providedBy(self[category]):\n                 actions.extend(self[category].listActions())\n         return tuple(actions)\n \n-    security.declarePublic(\'listActionInfos\')\n-\n-    def listActionInfos(self, action_chain=None, object=None,\n-                        check_visibility=1, check_permissions=1,\n-                        check_condition=1, max=-1,\n-                        categories=None, ignore_categories=None):\n+    @security.public\n+    def listActionInfos(\n+        self,\n+        action_chain=None,\n+        object=None,\n+        check_visibility=1,\n+        check_permissions=1,\n+        check_condition=1,\n+        max=-1,\n+        categories=None,\n+        ignore_categories=None,\n+    ):\n         # List ActionInfo objects.\n         # (method is without docstring to disable publishing)\n-        actions = self.listActions(object=object,\n-                                   categories=categories,\n-                                   ignore_categories=ignore_categories)\n+        actions = self.listActions(\n+            object=object, categories=categories, ignore_categories=ignore_categories\n+        )\n         if not actions:\n             return []\n \n@@ -60,26 +63,25 @@ def listActionInfos(self, action_chain=None, object=None,\n         if action_chain:\n             filtered_actions = []\n             if isinstance(action_chain, str):\n-                action_chain = (action_chain, )\n+                action_chain = (action_chain,)\n             for action_ident in action_chain:\n-                sep = action_ident.rfind(\'/\')\n-                category, id = action_ident[:sep], action_ident[sep + 1:]\n+                sep = action_ident.rfind("/")\n+                category, id = action_ident[:sep], action_ident[sep + 1 :]\n                 for ai in actions:\n-                    if id == ai[\'id\'] and category == ai[\'category\']:\n+                    if id == ai["id"] and category == ai["category"]:\n                         filtered_actions.append(ai)\n             actions = filtered_actions\n \n         if ignore_categories is not None:\n-            actions = [ai for ai in actions\n-                       if ai[\'category\'] not in ignore_categories]\n+            actions = [ai for ai in actions if ai["category"] not in ignore_categories]\n \n         action_infos = []\n         for ai in actions:\n-            if check_visibility and not ai[\'visible\']:\n+            if check_visibility and not ai["visible"]:\n                 continue\n-            if check_permissions and not ai[\'allowed\']:\n+            if check_permissions and not ai["allowed"]:\n                 continue\n-            if check_condition and not ai[\'available\']:\n+            if check_condition and not ai["available"]:\n                 continue\n             action_infos.append(ai)\n             if max + 1 and len(action_infos) >= max:\n@@ -89,16 +91,16 @@ def listActionInfos(self, action_chain=None, object=None,\n     #\n     #   \'portal_actions\' interface methods\n     #\n-    security.declarePublic(\'listFilteredActionsFor\')\n-\n-    def listFilteredActionsFor(self, object=None,\n-                               ignore_providers=(),\n-                               ignore_categories=None):\n+    @security.public\n+    def listFilteredActionsFor(\n+        self, object=None, ignore_providers=(), ignore_categories=None\n+    ):\n         # List all actions available to the user.\n         actions = []\n \n-        providers = [name for name in self.listActionProviders()\n-                     if name not in ignore_providers]\n+        providers = [\n+            name for name in self.listActionProviders() if name not in ignore_providers\n+        ]\n \n         # Include actions from specific tools.\n         for provider_name in providers:\n@@ -107,11 +109,12 @@ def listFilteredActionsFor(self, object=None,\n             if provider is None:\n                 continue\n             if IActionProvider.providedBy(provider):\n-                if provider_name == \'portal_actions\':\n-                    actions.extend(provider.listActionInfos(\n-                                   object=object,\n-                                   ignore_categories=ignore_categories\n-                                   ))\n+                if provider_name == "portal_actions":\n+                    actions.extend(\n+                        provider.listActionInfos(\n+                            object=object, ignore_categories=ignore_categories\n+                        )\n+                    )\n                 else:\n                     actions.extend(provider.listActionInfos(object=object))\n \n@@ -121,17 +124,19 @@ def listFilteredActionsFor(self, object=None,\n                 actions.extend(object.listActionInfos(object=object))\n \n         # Reorganize the actions by category.\n-        filtered_actions = {\'user\': [],\n-                            \'folder\': [],\n-                            \'object\': [],\n-                            \'global\': [],\n-                            \'workflow\': [],\n-                            }\n+        filtered_actions = {\n+            "user": [],\n+            "folder": [],\n+            "object": [],\n+            "global": [],\n+            "workflow": [],\n+        }\n \n         for action in actions:\n-            catlist = filtered_actions.setdefault(action[\'category\'], [])\n+            catlist = filtered_actions.setdefault(action["category"], [])\n             catlist.append(action)\n \n         return filtered_actions\n \n+\n InitializeClass(ActionsTool)\ndiff --git a/Products/CMFPlone/PloneBaseTool.py b/Products/CMFPlone/PloneBaseTool.py\nindex d0d0a9860d..e3ce889ede 100644\n--- a/Products/CMFPlone/PloneBaseTool.py\n+++ b/Products/CMFPlone/PloneBaseTool.py\n@@ -1,40 +1,39 @@\n-from AccessControl.class_init import InitializeClass\n from AccessControl import ClassSecurityInfo\n-from plone.base.interfaces import IPloneBaseTool\n+from AccessControl.class_init import InitializeClass\n from Acquisition import aq_base\n-from Acquisition import aq_parent\n from Acquisition import aq_inner\n-\n+from Acquisition import aq_parent\n+from plone.base.interfaces import IPloneBaseTool\n from Products.CMFCore import Expression\n+from Products.CMFCore.ActionInformation import oai\n from Products.CMFCore.utils import getToolByName\n-\n-from zope.interface import implementer\n from zope.component import getMultiAdapter\n+from zope.interface import implementer\n+\n \n # getOAI() and getExprContext copied from CMF 1.5.1+cvs\n # Copyright (c) 2002 Zope Corporation and Contributors. All Rights Reserved.\n # ZPL 2.1\n-from Products.CMFCore.ActionInformation import oai\n \n \n def getOAI(context, object=None):\n-    request = getattr(context, \'REQUEST\', None)\n+    request = getattr(context, "REQUEST", None)\n     if request:\n-        cache = request.get(\'_oai_cache\', None)\n+        cache = request.get("_oai_cache", None)\n         if cache is None:\n-            request[\'_oai_cache\'] = cache = {}\n+            request["_oai_cache"] = cache = {}\n         info = cache.get(id(object), None)\n     else:\n         info = None\n     if info is None:\n-        if object is None or not hasattr(object, \'aq_base\'):\n+        if object is None or not hasattr(object, "aq_base"):\n             folder = None\n         else:\n             folder = object\n             # Search up the containment hierarchy until we find an\n             # object that claims it\'s a folder.\n             while folder is not None:\n-                if getattr(aq_base(folder), \'isPrincipiaFolderish\', 0):\n+                if getattr(aq_base(folder), "isPrincipiaFolderish", 0):\n                     # found it.\n                     break\n                 else:\n@@ -53,59 +52,59 @@ def createExprContext(folder, portal, object):\n         view_obj = portal\n     req = view_obj.REQUEST\n \n-    expr_context.setGlobal(\'portal\', portal)\n+    expr_context.setGlobal("portal", portal)\n \n-    globals_view = getMultiAdapter((view_obj, req), name=\'plone\')\n-    expr_context.setGlobal(\'globals_view\', globals_view)\n+    globals_view = getMultiAdapter((view_obj, req), name="plone")\n+    expr_context.setGlobal("globals_view", globals_view)\n \n     # TODO: For some reason, when using getMultiAdapter() here we get\n     # authoriziation problems in some cases (e.g. when using one of these\n     # in a python: expression in an action).\n \n-    plone_portal_state = view_obj.restrictedTraverse(\'@@plone_portal_state\')\n-    expr_context.setGlobal(\'plone_portal_state\', plone_portal_state)\n+    plone_portal_state = view_obj.restrictedTraverse("@@plone_portal_state")\n+    expr_context.setGlobal("plone_portal_state", plone_portal_state)\n \n-    plone_context_state = view_obj.restrictedTraverse(\'@@plone_context_state\')\n-    expr_context.setGlobal(\'plone_context_state\', plone_context_state)\n+    plone_context_state = view_obj.restrictedTraverse("@@plone_context_state")\n+    expr_context.setGlobal("plone_context_state", plone_context_state)\n \n-    plone_tools = view_obj.restrictedTraverse(\'@@plone_tools\')\n-    expr_context.setGlobal(\'plone_tools\', plone_tools)\n+    plone_tools = view_obj.restrictedTraverse("@@plone_tools")\n+    expr_context.setGlobal("plone_tools", plone_tools)\n \n     # Add checkPermission to the action expression context to make cleaner\n     # faster expressions\n-    membership_tool = getToolByName(view_obj, \'portal_membership\')\n+    membership_tool = getToolByName(view_obj, "portal_membership")\n     checkPerm = membership_tool.checkPermission\n-    expr_context.setGlobal(\'checkPermission\', checkPerm)\n+    expr_context.setGlobal("checkPermission", checkPerm)\n \n     # add \'context\' as an alias for \'object\'\n-    expr_context.setGlobal(\'context\', object)\n+    expr_context.setGlobal("context", object)\n \n     # need this for resolving in Unicode expressions\n-    expr_context.setContext(\'context\', object)\n+    expr_context.setContext("context", object)\n \n     return expr_context\n \n \n def getExprContext(context, object=None):\n-    request = getattr(context, \'REQUEST\', None)\n+    request = getattr(context, "REQUEST", None)\n     if request:\n-        cache = request.get(\'_plone_ec_cache\', None)\n+        cache = request.get("_plone_ec_cache", None)\n         if cache is None:\n-            request[\'_plone_ec_cache\'] = cache = {}\n+            request["_plone_ec_cache"] = cache = {}\n         ec = cache.get(id(object), None)\n     else:\n         ec = None\n     if ec is None:\n-        utool = getToolByName(context, \'portal_url\')\n+        utool = getToolByName(context, "portal_url")\n         portal = utool.getPortalObject()\n-        if object is None or not hasattr(object, \'aq_base\'):\n+        if object is None or not hasattr(object, "aq_base"):\n             folder = portal\n         else:\n             folder = object\n             # Search up the containment hierarchy until we find an\n             # object that claims it\'s a folder.\n             while folder is not None:\n-                if getattr(aq_base(folder), \'isPrincipiaFolderish\', 0):\n+                if getattr(aq_base(folder), "isPrincipiaFolderish", 0):\n                     # found it.\n                     break\n                 else:\n@@ -119,8 +118,7 @@ def getExprContext(context, object=None):\n \n @implementer(IPloneBaseTool)\n class PloneBaseTool:\n-    """Base class of all tools used in CMFPlone and Plone Core\n-    """\n+    """Base class of all tools used in CMFPlone and Plone Core"""\n \n     security = ClassSecurityInfo()\n \ndiff --git a/Products/CMFPlone/PloneTool.py b/Products/CMFPlone/PloneTool.py\nindex 87f6c09683..f3939235be 100644\n--- a/Products/CMFPlone/PloneTool.py\n+++ b/Products/CMFPlone/PloneTool.py\n@@ -11,7 +11,23 @@\n from email.utils import getaddresses\n from OFS.ObjectManager import bad_id\n from OFS.SimpleItem import SimpleItem\n+from plone.base.defaultpage import check_default_page_via_view\n+from plone.base.defaultpage import get_default_page_via_view\n+from plone.base.interfaces import INonStructuralFolder\n+from plone.base.interfaces import IPloneTool\n+from plone.base.interfaces import ISearchSchema\n+from plone.base.interfaces import ISecuritySchema\n+from plone.base.interfaces import ISiteSchema\n+from plone.base.utils import _marker\n+from plone.base.utils import base_hasattr\n+from plone.base.utils import get_empty_title\n+from plone.base.utils import pretty_title_or_id\n+from plone.base.utils import safe_callable\n+from plone.base.utils import safe_hasattr\n from plone.base.utils import safe_text\n+from plone.base.utils import transaction_note\n+from plone.protect import CheckAuthenticator\n+from plone.protect import protect\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.interfaces import IDublinCore\n from Products.CMFCore.interfaces import IMutableDublinCore\n@@ -25,21 +41,10 @@\n from Products.CMFCore.WorkflowCore import WorkflowException\n from Products.CMFDynamicViewFTI.interfaces import IBrowserDefault\n from Products.CMFPlone import utils\n-from plone.base.defaultpage import check_default_page_via_view\n-from plone.base.defaultpage import get_default_page_via_view\n from Products.CMFPlone.events import ReorderedEvent\n-from plone.base.interfaces import INonStructuralFolder\n-from plone.base.interfaces import IPloneTool\n-from plone.base.interfaces import ISearchSchema\n-from plone.base.interfaces import ISecuritySchema\n-from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.log import log\n-from Products.CMFPlone.log import log_deprecated\n from Products.CMFPlone.log import log_exc\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n-from Products.CMFPlone.utils import base_hasattr\n-from Products.CMFPlone.utils import safe_hasattr\n-from Products.CMFPlone.utils import transaction_note\n from Products.statusmessages.interfaces import IStatusMessage\n from urllib import parse\n from ZODB.POSException import ConflictError\n@@ -53,9 +58,9 @@\n import re\n import sys\n import transaction\n+import warnings\n \n \n-_marker = utils._marker\n _icons = {}\n \n CEILING_DATE = DateTime(2500, 0)  # never expires\n@@ -100,6 +105,7 @@ class PloneTool(PloneBaseTool, UniqueObject, SimpleItem):\n     field_prefix = \'field_\'\n \n     @security.protected(ManageUsers)\n+    @protect(CheckAuthenticator)\n     def setMemberProperties(self, member, REQUEST=None, **properties):\n         pas = getToolByName(self, \'acl_users\')\n         if safe_hasattr(member, \'getId\'):\n@@ -341,6 +347,7 @@ def getReviewStateTitleFor(self, obj):\n         return None\n \n     @security.protected(ManagePortal)\n+    @protect(CheckAuthenticator)\n     def changeOwnershipOf(self, object, userid, recursive=0, REQUEST=None):\n         """Changes the ownership of an object."""\n         membership = getToolByName(self, \'portal_membership\')\n@@ -734,6 +741,7 @@ def isStructuralFolder(self, obj):\n         )\n \n     @security.public\n+    @protect(CheckAuthenticator)\n     def acquireLocalRoles(self, obj, status=1, REQUEST=None):\n         # If status is 1, allow acquisition of local roles (regular\n         # behaviour).\n@@ -937,14 +945,14 @@ def reindexOnReorder(self, parent):\n     def getEmptyTitle(self, translated=True):\n         # Returns string to be used for objects with no title or id.\n         # Note: no docstring please, to avoid reflected XSS.\n-        return utils.getEmptyTitle(self, translated)\n+        return get_empty_title(self, translated)\n \n     @security.public\n     def pretty_title_or_id(self, obj, empty_value=_marker):\n         # Return the best possible title or id of an item, regardless\n         # of whether obj is a catalog brain or an object, but returning an\n         # empty title marker if the id is not set (i.e. it\'s auto-generated).\n-        return utils.pretty_title_or_id(self, obj, empty_value=empty_value)\n+        return pretty_title_or_id(self, obj, empty_value=empty_value)\n \n     @security.public\n     def getMethodAliases(self, typeInfo):\n@@ -952,19 +960,24 @@ def getMethodAliases(self, typeInfo):\n         # FTI. If there are no method aliases (i.e. this FTI doesn\'t support\n         # it), return None.\n         getMethodAliases = getattr(typeInfo, \'getMethodAliases\', None)\n-        if getMethodAliases is not None \\\n-                and utils.safe_callable(getMethodAliases):\n+        if getMethodAliases is not None and safe_callable(getMethodAliases):\n             return getMethodAliases()\n-        else:\n-            return None\n+        return None\n \n     # This is public because we don\'t know what permissions the user\n     # has on the objects to be deleted.  The restrictedTraverse and\n     # manage_delObjects calls should handle permission checks for us.\n     @security.public\n+    @protect(CheckAuthenticator)\n+    @postonly\n     def deleteObjectsByPaths(self, paths, handle_errors=True, REQUEST=None):\n-        log_deprecated("deleteObjectsByPaths is deprecated, you should use. "\n-                       "plone.api.content.delete. This method no longer does link integrity checks")  # noqa\n+        # we need to use Python warnings direct instead of @deprecate,\n+        # otherwise plone.protect fails.\n+        warnings.warn(\n+            "Use plone.api.content.delete instead of deleteObjectsByPaths. "\n+            "This method no longer does link integrity checks. Will be removed in Plone 7",\n+            DeprecationWarning\n+        )\n         failure = {}\n         success = []\n         # use the portal for traversal in case we have relative paths\n@@ -990,9 +1003,9 @@ def deleteObjectsByPaths(self, paths, handle_errors=True, REQUEST=None):\n                     raise\n         transaction_note(\'Deleted %s\' % (\', \'.join(success)))\n         return success, failure\n-    deleteObjectsByPaths = postonly(deleteObjectsByPaths)\n \n     @security.public\n+    @protect(CheckAuthenticator)\n     def renameObjectsByPaths(self, paths, new_ids, new_titles,\n                              handle_errors=True, REQUEST=None):\n         failure = {}\ndiff --git a/Products/CMFPlone/RegistrationTool.py b/Products/CMFPlone/RegistrationTool.py\nindex fa17f700ad..976f7d3f04 100644\n--- a/Products/CMFPlone/RegistrationTool.py\n+++ b/Products/CMFPlone/RegistrationTool.py\n@@ -12,6 +12,8 @@\n from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISecuritySchema\n from plone.base.permissions import ManagePortal\n+from plone.protect import CheckAuthenticator\n+from plone.protect import protect\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.interfaces import ISiteRoot\n from Products.CMFCore.permissions import AddPortalMember\n@@ -453,6 +455,7 @@ def registeredNotify(self, new_member_id):\n     security.declareProtected(ManagePortal, \'editMember\')\n \n     @postonly\n+    @protect(CheckAuthenticator)\n     def editMember(self, member_id, properties=None, password=None,\n                    roles=None, domains=None, REQUEST=None):\n         """ Edit a user\'s properties and security settings\ndiff --git a/Products/CMFPlone/TranslationServiceTool.py b/Products/CMFPlone/TranslationServiceTool.py\nindex 086af2ae6a..82854b270f 100644\n--- a/Products/CMFPlone/TranslationServiceTool.py\n+++ b/Products/CMFPlone/TranslationServiceTool.py\n@@ -4,20 +4,20 @@\n """\n \n from AccessControl import ClassSecurityInfo\n-from Acquisition import aq_get\n from AccessControl.class_init import InitializeClass\n-from .i18nl10n import monthname_english\n-from .i18nl10n import monthname_msgid\n-from .i18nl10n import monthname_msgid_abbr\n-from .i18nl10n import ulocalized_time\n-from .i18nl10n import weekdayname_english\n-from .i18nl10n import weekdayname_msgid\n-from .i18nl10n import weekdayname_msgid_abbr\n-from .i18nl10n import weekdayname_msgid_short\n+from Acquisition import aq_get\n from OFS.SimpleItem import SimpleItem\n from plone.base import PloneLocalesMessageFactory as PLMF\n-from Products.CMFCore.utils import UniqueObject\n+from plone.base.i18nl10n import monthname_english\n+from plone.base.i18nl10n import monthname_msgid\n+from plone.base.i18nl10n import monthname_msgid_abbr\n+from plone.base.i18nl10n import ulocalized_time\n+from plone.base.i18nl10n import weekdayname_english\n+from plone.base.i18nl10n import weekdayname_msgid\n+from plone.base.i18nl10n import weekdayname_msgid_abbr\n+from plone.base.i18nl10n import weekdayname_msgid_short\n from plone.base.interfaces import ITranslationServiceTool\n+from Products.CMFCore.utils import UniqueObject\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from zope.i18n import translate\n from zope.interface import implementer\ndiff --git a/Products/CMFPlone/__init__.py b/Products/CMFPlone/__init__.py\nindex 207ba2cdec..4edd033abe 100644\n--- a/Products/CMFPlone/__init__.py\n+++ b/Products/CMFPlone/__init__.py\n@@ -1,10 +1,12 @@\n from App.ImageFile import ImageFile\n \n import os\n-import sys\n import pkg_resources\n+import sys\n+import warnings\n import zope.deferredimport\n \n+\n __version__ = pkg_resources.require("Products.CMFPlone")[0].version\n \n \n@@ -12,22 +14,25 @@\n this_module = sys.modules[__name__]\n _marker = []\n \n-ADD_CONTENT_PERMISSION = \'Add portal content\'\n-misc_ = {\'plone_icon\': ImageFile(\n-    os.path.join(\'skins\', \'plone_images\', \'logoIcon.png\'),\n-    cmfplone_globals)}\n+ADD_CONTENT_PERMISSION = "Add portal content"\n+misc_ = {\n+    "plone_icon": ImageFile(\n+        os.path.join("skins", "plone_images", "logoIcon.png"), cmfplone_globals\n+    )\n+}\n \n zope.deferredimport.initialize()\n zope.deferredimport.deprecated(\n     "Import from plone.base instead (to be removed in Plone 7)",\n-    PloneMessageFactory=\'plone.base:PloneMessageFactory\',\n-    PloneLocalesMessageFactory=\'plone.base:PloneMessageFactory\',\n+    PloneMessageFactory="plone.base:PloneMessageFactory",\n+    PloneLocalesMessageFactory="plone.base:PloneMessageFactory",\n )\n zope.deferredimport.deprecated(\n     "Import from plone.app.discussion.interfaces instead (to be removed in Plone 7)",\n-    DISCUSSION_ANNOTATION_KEY=\'plone.app.discussion.interfaces:DISCUSSION_ANNOTATION_KEY\',\n+    DISCUSSION_ANNOTATION_KEY="plone.app.discussion.interfaces:DISCUSSION_ANNOTATION_KEY",\n )\n \n+\n def initialize(context):\n \n     # Stuff has been moved from module level to this method for a\n@@ -36,119 +41,117 @@ def initialize(context):\n     # For test authors (and people who use parts of Plone only)\n     # it does speed up import *significantly*.\n \n-    from AccessControl import ModuleSecurityInfo\n     from AccessControl import allow_class\n     from AccessControl import allow_module\n+    from AccessControl import ModuleSecurityInfo\n \n     # protect OFS.ObjectManager\n-    ModuleSecurityInfo(\'OFS.ObjectManager\').setDefaultAccess(0)\n-    ModuleSecurityInfo(\'OFS.ObjectManager\').declareObjectPrivate()\n-    ModuleSecurityInfo(\'OFS.ObjectManager\').declarePublic(\n-        \'BeforeDeleteException\')\n+    ModuleSecurityInfo("OFS.ObjectManager").setDefaultAccess(0)\n+    ModuleSecurityInfo("OFS.ObjectManager").declareObjectPrivate()\n+    ModuleSecurityInfo("OFS.ObjectManager").declarePublic("BeforeDeleteException")\n \n     # allow logging\n-    ModuleSecurityInfo(\'logging\').declarePublic(\'getLogger\')\n+    ModuleSecurityInfo("logging").declarePublic("getLogger")\n     from logging import Logger\n+\n     allow_class(Logger)\n \n     # various small utils functions\n     # added for unescaping view names in urls when finding selected action\n-    ModuleSecurityInfo(\'urllib\').declarePublic(\'unquote\')\n+    ModuleSecurityInfo("urllib").declarePublic("unquote")\n \n-    allow_module(\'Products.CMFPlone.utils\')\n+    allow_module("Products.CMFPlone.utils")\n \n     # For content_status_modify\n     from Products.CMFCore.WorkflowCore import ObjectDeleted\n     from Products.CMFCore.WorkflowCore import ObjectMoved\n     from Products.CMFCore.WorkflowCore import WorkflowException\n-    ModuleSecurityInfo(\n-        \'Products.CMFCore.WorkflowCore\').declarePublic(\'ObjectDeleted\')\n-    ModuleSecurityInfo(\n-        \'Products.CMFCore.WorkflowCore\').declarePublic(\'ObjectMoved\')\n-    ModuleSecurityInfo(\n-        \'Products.CMFCore.WorkflowCore\').declarePublic(\'WorkflowException\')\n+\n+    ModuleSecurityInfo("Products.CMFCore.WorkflowCore").declarePublic("ObjectDeleted")\n+    ModuleSecurityInfo("Products.CMFCore.WorkflowCore").declarePublic("ObjectMoved")\n+    ModuleSecurityInfo("Products.CMFCore.WorkflowCore").declarePublic(\n+        "WorkflowException"\n+    )\n     allow_class(ObjectDeleted)\n     allow_class(ObjectMoved)\n     allow_class(WorkflowException)\n \n     # bbb - remove in Plone 7\n-    from Products.CMFPlone.PloneBatch import Batch\n+    with warnings.catch_warnings():\n+        warnings.filterwarnings("ignore", category=DeprecationWarning)\n+        from Products.CMFPlone.PloneBatch import Batch\n     allow_class(Batch)\n \n     # Make Batch available at module level\n     this_module.Batch = Batch\n \n-    ModuleSecurityInfo(\'StringIO\').declarePublic(\'StringIO\')\n+    ModuleSecurityInfo("StringIO").declarePublic("StringIO")\n \n     # Make Unauthorized importable TTW\n-    ModuleSecurityInfo(\'AccessControl\').declarePublic(\'Unauthorized\')\n+    ModuleSecurityInfo("AccessControl").declarePublic("Unauthorized")\n \n     # Make Forbidden importable TTW\n-    ModuleSecurityInfo(\'zExceptions\').declarePublic(\'Forbidden\')\n+    ModuleSecurityInfo("zExceptions").declarePublic("Forbidden")\n \n     # Make ConflictError importable TTW\n-    ModuleSecurityInfo(\'ZODB.POSException\').declarePublic(\'ConflictError\')\n+    ModuleSecurityInfo("ZODB.POSException").declarePublic("ConflictError")\n \n     # Make ZCTextIndex ParseError importable TTW\n-    ModuleSecurityInfo(\'Products.ZCTextIndex.ParseTree\') \\\n-        .declarePublic(\'ParseError\')\n+    ModuleSecurityInfo("Products.ZCTextIndex.ParseTree").declarePublic("ParseError")\n \n     # Make DateTimeError importable TTW\n-    ModuleSecurityInfo(\'DateTime.interfaces\').declarePublic(\'DateTimeError\')\n-    ModuleSecurityInfo(\'DateTime.interfaces\').declarePublic(\'SyntaxError\')\n+    ModuleSecurityInfo("DateTime.interfaces").declarePublic("DateTimeError")\n+    ModuleSecurityInfo("DateTime.interfaces").declarePublic("SyntaxError")\n \n     # BBB support for DateTime < 3\n-    ModuleSecurityInfo(\'DateTime.DateTime\').declarePublic(\'DateTimeError\')\n-    ModuleSecurityInfo(\'DateTime.DateTime\').declarePublic(\'SyntaxError\')\n+    ModuleSecurityInfo("DateTime.DateTime").declarePublic("DateTimeError")\n+    ModuleSecurityInfo("DateTime.DateTime").declarePublic("SyntaxError")\n \n     # Make CopyError importable TTW\n-    ModuleSecurityInfo(\'OFS.CopySupport\').declarePublic(\'CopyError\')\n+    ModuleSecurityInfo("OFS.CopySupport").declarePublic("CopyError")\n \n     # Make AllowSendto importable TTW\n-    ModuleSecurityInfo(\'Products.CMFPlone.PloneTool\') \\\n-        .declarePublic(\'AllowSendto\')\n+    ModuleSecurityInfo("Products.CMFPlone.PloneTool").declarePublic("AllowSendto")\n \n     # Make ZCatalog\'s mergeResults importable TTW\n-    ModuleSecurityInfo(\'Products.ZCatalog.Catalog\') \\\n-        .declarePublic(\'mergeResults\')\n+    ModuleSecurityInfo("Products.ZCatalog.Catalog").declarePublic("mergeResults")\n \n     # Make the navtree constructs available TTW\n-    allow_module(\'Products.CMFPlone.browser.navtree\')\n+    allow_module("Products.CMFPlone.browser.navtree")\n \n     # Allow access to the exception in the folder_delete script\n     from OFS.ObjectManager import BeforeDeleteException\n-    allow_module(\'OFS.ObjectManager\')\n+\n+    allow_module("OFS.ObjectManager")\n     allow_class(BeforeDeleteException)\n \n     # Make cgi.escape available TTW\n-    ModuleSecurityInfo(\'cgi\').declarePublic(\'escape\')\n+    ModuleSecurityInfo("cgi").declarePublic("escape")\n \n     # Make warnings available TTW\n-    ModuleSecurityInfo(\'warnings\').declarePublic(\'warn\')\n+    ModuleSecurityInfo("warnings").declarePublic("warn")\n \n     # Apply monkey patches\n-    from Products.CMFPlone import patches  # noqa\n-\n-    # Register unicode splitter w/ ZCTextIndex\n-    # pipeline registry\n-    from Products.CMFPlone import UnicodeSplitter  # noqa\n-\n     # CMFCore tools\n     from Products.CMFCore import CachingPolicyManager\n \n     # Plone tools\n-    from Products.CMFPlone import PloneTool\n+    # Register unicode splitter w/ ZCTextIndex\n+    # pipeline registry\n+    from Products.CMFPlone import ActionsTool\n+    from Products.CMFPlone import CatalogTool\n     from Products.CMFPlone import MigrationTool\n+    from Products.CMFPlone import patches  # noqa\n     from Products.CMFPlone import PloneControlPanel\n-    from Products.CMFPlone import WorkflowTool\n-    from Products.CMFPlone import URLTool\n-    from Products.CMFPlone import RegistrationTool\n+    from Products.CMFPlone import PloneTool\n     from Products.CMFPlone import PropertiesTool\n-    from Products.CMFPlone import ActionsTool\n-    from Products.CMFPlone import TypesTool\n-    from Products.CMFPlone import CatalogTool\n+    from Products.CMFPlone import RegistrationTool\n     from Products.CMFPlone import SkinsTool\n     from Products.CMFPlone import TranslationServiceTool\n+    from Products.CMFPlone import TypesTool\n+    from Products.CMFPlone import UnicodeSplitter  # noqa\n+    from Products.CMFPlone import URLTool\n+    from Products.CMFPlone import WorkflowTool\n \n     tools = (\n         PloneTool.PloneTool,\n@@ -171,32 +174,32 @@ def initialize(context):\n \n     # Register tools and content\n     ToolInit(\n-        \'Plone Tool\',\n+        "Plone Tool",\n         tools=tools,\n-        icon=\'tool.gif\',\n+        icon="tool.gif",\n     ).initialize(context)\n \n-\n     from AccessControl.Permissions import view_management_screens\n-    from Products.CMFPlone.Portal import PloneSite\n     from Products.CMFPlone.factory import zmi_constructor\n+    from Products.CMFPlone.Portal import PloneSite\n+\n     context.registerClass(\n         instance_class=PloneSite,\n         permission=view_management_screens,\n-        constructors=(zmi_constructor, ),\n+        constructors=(zmi_constructor,),\n     )\n \n     from plone.folder import nogopip\n+\n     context.registerClass(\n         nogopip.GopipIndex,\n-        permission=\'Add Pluggable Index\',\n-        constructors=(nogopip.manage_addGopipForm,\n-                      nogopip.manage_addGopipIndex),\n-        icon=\'index.gif\',\n-        visibility=None\n+        permission="Add Pluggable Index",\n+        constructors=(nogopip.manage_addGopipForm, nogopip.manage_addGopipIndex),\n+        icon="index.gif",\n+        visibility=None,\n     )\n \n+\n # Apply early monkey patches.  For these patches, it is too late if we do this\n # in the initialize method.\n from Products.CMFPlone import earlypatches  # noqa\n-\ndiff --git a/Products/CMFPlone/browser/author.py b/Products/CMFPlone/browser/author.py\nindex 05d92acabf..741d365606 100644\n--- a/Products/CMFPlone/browser/author.py\n+++ b/Products/CMFPlone/browser/author.py\n@@ -1,27 +1,21 @@\n+from .interfaces import IAuthorFeedbackForm\n from AccessControl import Unauthorized\n-\n-from Products.CMFCore.interfaces import IPropertiesTool\n-from Products.CMFPlone import PloneMessageFactory as _\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISecuritySchema\n from plone.base.interfaces.controlpanel import IMailSchema\n-from Products.CMFPlone.utils import getToolByName\n-from Products.CMFPlone.utils import pretty_title_or_id\n+from plone.base.utils import pretty_title_or_id\n+from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.interfaces import IPropertiesTool\n+from Products.CMFCore.utils import getToolByName\n from Products.Five.browser import BrowserView\n from Products.MailHost.interfaces import IMailHost\n from Products.statusmessages.interfaces import IStatusMessage\n-\n-from ZODB.POSException import ConflictError\n-\n-from .interfaces import IAuthorFeedbackForm\n-\n-from plone.registry.interfaces import IRegistry\n from urllib.parse import quote_plus\n-\n from z3c.form import button\n from z3c.form import field\n from z3c.form import form\n from z3c.form.interfaces import HIDDEN_MODE\n-\n+from ZODB.POSException import ConflictError\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.interface import implementer\n@@ -29,6 +23,7 @@\n \n import logging\n \n+\n logger = logging.getLogger("Plone")\n \n \ndiff --git a/Products/CMFPlone/browser/navigation.py b/Products/CMFPlone/browser/navigation.py\nindex eb76b1d18d..e6799e20b7 100644\n--- a/Products/CMFPlone/browser/navigation.py\n+++ b/Products/CMFPlone/browser/navigation.py\n@@ -3,16 +3,18 @@\n from plone.app.layout.navigation.interfaces import INavtreeStrategy\n from plone.app.layout.navigation.navtree import buildFolderTree\n from plone.app.layout.navigation.root import getNavigationRoot\n+from plone.base.defaultpage import check_default_page_via_view\n+from plone.base.interfaces import IHideFromBreadcrumbs\n+from plone.base.interfaces import INavigationSchema\n+from plone.base.utils import pretty_title_or_id\n+from plone.base.utils import safe_callable\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import utils\n from Products.CMFPlone.browser.interfaces import INavigationBreadcrumbs\n from Products.CMFPlone.browser.interfaces import INavigationTabs\n from Products.CMFPlone.browser.interfaces import ISiteMap\n from Products.CMFPlone.browser.navtree import SitemapQueryBuilder\n-from plone.base.defaultpage import check_default_page_via_view\n-from plone.base.interfaces import IHideFromBreadcrumbs\n-from plone.base.interfaces import INavigationSchema\n+from Products.CMFPlone.utils import parent\n from Products.Five import BrowserView\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n@@ -32,7 +34,7 @@ def get_id(item):\n     if not item:\n         return None\n     getId = getattr(item, "getId")\n-    if not utils.safe_callable(getId):\n+    if not safe_callable(getId):\n         # Looks like a brain\n         return getId\n     return getId()\n@@ -72,7 +74,7 @@ def _getNavQuery(self):\n             INavigationSchema, prefix="plone", check=False\n         )\n         customQuery = getattr(self.context, "getCustomNavQuery", False)\n-        if customQuery is not None and utils.safe_callable(customQuery):\n+        if customQuery is not None and safe_callable(customQuery):\n             query = customQuery()\n         else:\n             query = {}\n@@ -150,7 +152,7 @@ def _get_url(item):\n                 continue\n             cid, item_url = _get_url(item)\n             data = {\n-                "name": utils.pretty_title_or_id(context, item),\n+                "name": pretty_title_or_id(context, item),\n                 "id": item.getId,\n                 "url": item_url,\n                 "description": item.Description,\n@@ -176,7 +178,7 @@ def breadcrumbs(self):\n         # Check to see if the current page is a folder default view, if so\n         # get breadcrumbs from the parent folder\n         if check_default_page_via_view(context, self.request):\n-            currentPath = "/".join(utils.parent(context).getPhysicalPath())\n+            currentPath = "/".join(parent(context).getPhysicalPath())\n         else:\n             currentPath = "/".join(context.getPhysicalPath())\n         query["path"] = {"query": currentPath, "navtree": 1, "depth": 0}\n@@ -201,7 +203,7 @@ def breadcrumbs(self):\n \n             cid, item_url = get_view_url(item)\n             data = {\n-                "Title": utils.pretty_title_or_id(context, item),\n+                "Title": pretty_title_or_id(context, item),\n                 "absolute_url": item_url,\n             }\n             result.append(data)\n@@ -213,7 +215,7 @@ class PhysicalNavigationBreadcrumbs(BrowserView):\n     def breadcrumbs(self):\n         context = aq_inner(self.context)\n         request = self.request\n-        container = utils.parent(context)\n+        container = parent(context)\n \n         name, item_url = get_view_url(context)\n \n@@ -221,7 +223,7 @@ def breadcrumbs(self):\n             return (\n                 {\n                     "absolute_url": item_url,\n-                    "Title": utils.pretty_title_or_id(context, context),\n+                    "Title": pretty_title_or_id(context, context),\n                 },\n             )\n \n@@ -242,7 +244,7 @@ def breadcrumbs(self):\n         ) and not rootPath.startswith(itemPath):\n             entry = {\n                 "absolute_url": item_url,\n-                "Title": utils.pretty_title_or_id(context, context),\n+                "Title": pretty_title_or_id(context, context),\n             }\n             self.customize_entry(entry, context)\n             base += (entry,)\ndiff --git a/Products/CMFPlone/browser/ploneview.py b/Products/CMFPlone/browser/ploneview.py\nindex 43dab697fb..4b4c5fe297 100644\n--- a/Products/CMFPlone/browser/ploneview.py\n+++ b/Products/CMFPlone/browser/ploneview.py\n@@ -1,14 +1,18 @@\n from Acquisition import aq_inner\n+from plone.base.utils import human_readable_size\n+from plone.base.utils import safe_text\n from plone.memoize.view import memoize\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import utils\n from Products.CMFPlone.browser.interfaces import IPlone\n from Products.Five import BrowserView\n from zope.component import getMultiAdapter\n+from zope.deprecation import deprecate\n from zope.i18n import translate\n from zope.interface import implementer\n from zope.size import byteDisplay\n \n+\n _marker = []\n \n \n@@ -23,73 +27,77 @@ def uniqueItemIndex(self, pos=0):\n         return utils.RealIndexIterator(pos=pos)\n \n     def toLocalizedTime(self, time, long_format=None, time_only=None):\n-        """Convert time to localized time\n-        """\n+        """Convert time to localized time"""\n         context = aq_inner(self.context)\n-        util = getToolByName(context, \'translation_service\')\n-        return util.ulocalized_time(time, long_format, time_only,\n-                                    context=context, domain=\'plonelocales\',\n-                                    request=self.request)\n+        util = getToolByName(context, "translation_service")\n+        return util.ulocalized_time(\n+            time,\n+            long_format,\n+            time_only,\n+            context=context,\n+            domain="plonelocales",\n+            request=self.request,\n+        )\n \n     def toLocalizedSize(self, size):\n-        """Convert an integer to a localized size string\n-        """\n+        """Convert an integer to a localized size string"""\n         return translate(byteDisplay(size), context=self.request)\n \n     # This can\'t be request-memoized, because it won\'t necessarily remain\n     # valid across traversals. For example, you may get tabs on an error\n     # message.\n     def showToolbar(self):\n-        """Determine if the editable border should be shown\n-        """\n+        """Determine if the editable border should be shown"""\n         request = self.request\n-        if \'disable_border\' in request or \'disable_toolbar\' in request:\n+        if "disable_border" in request or "disable_toolbar" in request:\n             return False\n-        if \'enable_border\' in request or \'enable_toolbar\' in request:\n+        if "enable_border" in request or "enable_toolbar" in request:\n             return True\n \n         context = aq_inner(self.context)\n \n-        portal_membership = getToolByName(context, \'portal_membership\')\n+        portal_membership = getToolByName(context, "portal_membership")\n         checkPerm = portal_membership.checkPermission\n \n-        if (checkPerm(\'Modify portal content\', context) or\n-            checkPerm(\'Add portal content\', context) or\n-                checkPerm(\'Review portal content\', context)):\n+        if (\n+            checkPerm("Modify portal content", context)\n+            or checkPerm("Add portal content", context)\n+            or checkPerm("Review portal content", context)\n+        ):\n             return True\n \n         if portal_membership.isAnonymousUser():\n             return False\n \n-        context_state = getMultiAdapter(\n-            (context, request),\n-            name="plone_context_state"\n-        )\n+        context_state = getMultiAdapter((context, request), name="plone_context_state")\n         actions = context_state.actions\n \n-        if actions(\'workflow\', max=1):\n+        if actions("workflow", max=1):\n             return True\n \n-        if actions(\'batch\', max=1):\n+        if actions("batch", max=1):\n             return True\n \n-        for action in actions(\'object\'):\n-            if action.get(\'id\', \'\') != \'view\':\n+        for action in actions("object"):\n+            if action.get("id", "") != "view":\n                 return True\n \n         template_id = None\n-        if \'PUBLISHED\' in request:\n-            if getattr(request[\'PUBLISHED\'], \'getId\', None):\n-                template_id = request[\'PUBLISHED\'].getId()\n+        if "PUBLISHED" in request:\n+            if getattr(request["PUBLISHED"], "getId", None):\n+                template_id = request["PUBLISHED"].getId()\n \n         idActions = {}\n-        for obj in actions(\'object\') + actions(\'folder\'):\n-            idActions[obj.get(\'id\', \'\')] = 1\n-\n-        if \'edit\' in idActions:\n-            if (template_id in idActions or\n-                template_id in [\'synPropertiesForm\', \'folder_contents\',\n-                                \'folder_listing\', \'listing_view\']):\n+        for obj in actions("object") + actions("folder"):\n+            idActions[obj.get("id", "")] = 1\n+\n+        if "edit" in idActions:\n+            if template_id in idActions or template_id in [\n+                "synPropertiesForm",\n+                "folder_contents",\n+                "folder_listing",\n+                "listing_view",\n+            ]:\n                 return True\n \n         # Check to see if the user is able to add content\n@@ -100,118 +108,152 @@ def showToolbar(self):\n         return False\n \n     def normalizeString(self, text):\n-        """Normalizes a title to an id.\n-        """\n+        """Normalizes a title to an id."""\n         return utils.normalizeString(text, context=self)\n \n-    def cropText(self, text, length, ellipsis=\'...\'):\n-        """Crop text on a word boundary\n-        """\n+    def cropText(self, text, length, ellipsis="..."):\n+        """Crop text on a word boundary"""\n         if not length:\n             return text\n         converted = False\n         if not isinstance(text, str):\n-            text = utils.safe_text(text)\n+            text = safe_text(text)\n             converted = True\n         if len(text) > length:\n             text = text[:length]\n-            l = text.rfind(\' \')\n+            l = text.rfind(" ")\n             if l > length / 2:\n-                text = text[:l + 1]\n+                text = text[: l + 1]\n             text += ellipsis\n         if converted:\n             # encode back from unicode\n-            text = text.encode(\'utf-8\')\n+            text = text.encode("utf-8")\n         return text\n \n-    def site_encoding(self):\n-        return \'utf-8\'\n+    @property\n+    def human_readable_size(self):\n+        return human_readable_size\n \n-    # Deprecated in favour of @@plone_context_state and @@plone_portal_state\n+    @deprecate("Site encoding is fixed to utf8. Will be removed in Plone 7")\n+    def site_encoding(self):\n+        return "utf-8"\n \n+    @deprecate(\n+        "Use method current_page_url from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     def getCurrentUrl(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.current_page_url()\n \n+    @deprecate(\n+        "Use method is_default_page from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     def isDefaultPageInFolder(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.is_default_page()\n \n+    @deprecate(\n+        "Use method is_structural_folder from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     def isStructuralFolder(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.is_structural_folder()\n \n+    @deprecate(\n+        "Use method navigation_root_path from @@plone_portal_state instead. Will be removed in Plone 7"\n+    )\n     def navigationRootPath(self):\n         portal_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_portal_state\')\n+            (aq_inner(self.context), self.request), name="plone_portal_state"\n+        )\n         return portal_state.navigation_root_path()\n \n+    @deprecate(\n+        "Use method navigation_root_url from @@plone_portal_state instead. Will be removed in Plone 7"\n+    )\n     def navigationRootUrl(self):\n         portal_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_portal_state\')\n+            (aq_inner(self.context), self.request), name="plone_portal_state"\n+        )\n         return portal_state.navigation_root_url()\n \n+    @deprecate(\n+        "Use method parent from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     def getParentObject(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.parent()\n \n+    @deprecate(\n+        "Use method folder from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     def getCurrentFolder(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.folder()\n \n+    @deprecate(\n+        "Use method folder().absolute_url() from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     def getCurrentFolderUrl(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.folder().absolute_url()\n \n+    @deprecate(\n+        "Use method canonical_object_url from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     @memoize\n     def getCurrentObjectUrl(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.canonical_object_url()\n \n+    @deprecate(\n+        "Use method is_structural_folder from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     @memoize\n     def isFolderOrFolderDefaultPage(self):\n         state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return state.is_structural_folder() or state.is_default_page()\n \n+    @deprecate(\n+        "Use method is_portal_root from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     @memoize\n     def isPortalOrPortalDefaultPage(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.is_portal_root()\n \n+    @deprecate(\n+        "Use method view_template_id from @@plone_context_state instead. Will be removed in Plone 7"\n+    )\n     @memoize\n     def getViewTemplateId(self):\n         context_state = getMultiAdapter(\n-            (aq_inner(self.context), self.request),\n-            name=\'plone_context_state\')\n+            (aq_inner(self.context), self.request), name="plone_context_state"\n+        )\n         return context_state.view_template_id()\n \n+    @deprecate("Use method __call__ from @@plone_patterns_settings instead")\n     @memoize\n     def patterns_settings(self):\n         context = aq_inner(self.context)\n         return getMultiAdapter(\n-            (context, self.request),\n-            name=\'plone_patterns_settings\')()\n-\n-    @property\n-    def human_readable_size(self):\n-        return utils.human_readable_size\n+            (context, self.request), name="plone_patterns_settings"\n+        )()\ndiff --git a/Products/CMFPlone/browser/sendto.py b/Products/CMFPlone/browser/sendto.py\nindex 384d7d5ff3..864dc1f27a 100644\n--- a/Products/CMFPlone/browser/sendto.py\n+++ b/Products/CMFPlone/browser/sendto.py\n@@ -1,23 +1,18 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n+from .interfaces import ISendToForm\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces.controlpanel import IMailSchema\n-from Products.CMFPlone.utils import pretty_title_or_id\n+from plone.base.utils import pretty_title_or_id\n+from plone.registry.interfaces import IRegistry\n+from plone.z3cform import layout\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.MailHost.interfaces import IMailHost\n from Products.statusmessages.interfaces import IStatusMessage\n-\n+from z3c.form import button\n+from z3c.form import field\n+from z3c.form import form\n from ZODB.POSException import ConflictError\n-\n-from plone.registry.interfaces import IRegistry\n-from plone.z3cform import layout\n-\n from zope.component import getUtility\n \n-from z3c.form import form\n-from z3c.form import field\n-from z3c.form import button\n-\n-from .interfaces import ISendToForm\n-\n import logging\n \n logger = logging.getLogger("Plone")\ndiff --git a/Products/CMFPlone/browser/templates/main_template.pt b/Products/CMFPlone/browser/templates/main_template.pt\nindex 50c5be24f0..9bffd9a9bb 100644\n--- a/Products/CMFPlone/browser/templates/main_template.pt\n+++ b/Products/CMFPlone/browser/templates/main_template.pt\n@@ -49,7 +49,7 @@\n                     body_class python:plone_layout.bodyClass(template, view);"\n         tal:attributes="class body_class;\n                         dir python:isRTL and \'rtl\' or \'ltr\';\n-                        python:plone_view.patterns_settings()"\n+                        python:context.restrictedTraverse(\'@@plone_patterns_settings\')();"\n         id="visual-portal-wrapper">\n \n     <div tal:replace="structure provider:plone.toolbar" />\ndiff --git a/Products/CMFPlone/configure.zcml b/Products/CMFPlone/configure.zcml\nindex 0433f5a7e7..97b6876913 100644\n--- a/Products/CMFPlone/configure.zcml\n+++ b/Products/CMFPlone/configure.zcml\n@@ -127,18 +127,6 @@\n   <subscriber for="ZPublisher.interfaces.IPubAfterTraversal"\n               handler=".events.removeBase"/>\n \n-  <!-- configure sizes lookup for `plone.namedfile` -->\n-  <utility\n-      component=".utils.getAllowedSizes"\n-      provides="plone.namedfile.interfaces.IAvailableSizes"\n-      />\n-\n-  <!-- quality lookup for IScaledImageQuality -->\n-  <utility\n-      component=".utils.getQuality"\n-      provides="plone.scale.interfaces.IScaledImageQuality"\n-      />\n-\n   <adapter\n       for="zope.pagetemplate.engine.ZopeBaseEngine"\n       factory=".traversal.get_zope_page_template_engine"\ndiff --git a/Products/CMFPlone/controlpanel/browser/actions.pt b/Products/CMFPlone/controlpanel/browser/actions.pt\nindex ed8c89431a..fae8e140f2 100644\n--- a/Products/CMFPlone/controlpanel/browser/actions.pt\n+++ b/Products/CMFPlone/controlpanel/browser/actions.pt\n@@ -34,7 +34,7 @@\n               class="list-group-item bg-transparent d-flex align-items-center justify-content-between">\n             <span><span tal:replace="repeat/action/number" />. <span tal:replace="action/title" i18n:translate="" /></span>\n             <form action="@@actions-controlpanel"\n-                  class="plone-action-${action/id}"\n+                  class="plone-action-${action/id} flex-shrink-0"\n                   method="POST">\n               <input type="hidden" name="actionid"\n                 tal:attributes="value action/id" />\ndiff --git a/Products/CMFPlone/controlpanel/browser/relations.py b/Products/CMFPlone/controlpanel/browser/relations.py\nindex 03aa2141dc..97a3ce2038 100644\n--- a/Products/CMFPlone/controlpanel/browser/relations.py\n+++ b/Products/CMFPlone/controlpanel/browser/relations.py\n@@ -1,7 +1,7 @@\n from collections import defaultdict\n from operator import itemgetter\n+from plone.base import PloneMessageFactory as _\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.relationhelper import get_relations_stats\n from Products.CMFPlone.relationhelper import rebuild_relations\n from Products.Five.browser import BrowserView\ndiff --git a/Products/CMFPlone/controlpanel/events.py b/Products/CMFPlone/controlpanel/events.py\nindex fdbced0807..4d4d34df0f 100644\n--- a/Products/CMFPlone/controlpanel/events.py\n+++ b/Products/CMFPlone/controlpanel/events.py\n@@ -1,17 +1,17 @@\n-from Products.CMFCore.ActionInformation import Action\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.controlpanel.utils import migrate_to_email_login\n-from Products.CMFPlone.controlpanel.utils import migrate_from_email_login\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IConfigurationChangedEvent\n from plone.base.interfaces import ISecuritySchema\n-from Products.CMFPlone.utils import safe_hasattr\n+from plone.base.utils import safe_hasattr\n from plone.registry.interfaces import IRecordModifiedEvent\n+from Products.CMFCore.ActionInformation import Action\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.controlpanel.utils import migrate_from_email_login\n+from Products.CMFPlone.controlpanel.utils import migrate_to_email_login\n from zope.component import adapter\n from zope.component import queryUtility\n+from zope.component.hooks import getSite\n from zope.interface import implementer\n from zope.ramcache.interfaces.ram import IRAMCache\n-from zope.component.hooks import getSite\n \n \n @implementer(IConfigurationChangedEvent)\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py\nindex 6bfd822039..abf44c5cdd 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py\n@@ -2,11 +2,11 @@\n from plone.app.redirector.interfaces import IRedirectionStorage\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.base.batch import Batch\n from plone.testing.zope import Browser\n from Products.CMFPlone.controlpanel.browser.redirects import RedirectionSet\n-from Products.CMFPlone.PloneBatch import Batch\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from Products.CMFPlone.utils import safe_bytes\n+from plone.base.utils import safe_bytes\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py\nindex a99d71950a..dd9a2b76ed 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py\n@@ -1,9 +1,9 @@\n-import unittest\n-\n from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.testing.zope import Browser\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n \n+import unittest\n+\n \n class RelationsControlPanelFunctionalTest(unittest.TestCase):\n     """Test that links and actions in controlpanel starts with to absolute portal url."""\ndiff --git a/Products/CMFPlone/patches/csrf.py b/Products/CMFPlone/patches/csrf.py\nindex 4c484fffcf..e93f68d5a0 100644\n--- a/Products/CMFPlone/patches/csrf.py\n+++ b/Products/CMFPlone/patches/csrf.py\n@@ -7,28 +7,18 @@\n def applyPatches():\n     """ apply csrf-protection decorator to all relevant methods """\n \n-    from Products.CMFPlone.PloneTool import PloneTool as PT\n-    PT.setMemberProperties = patch(PT.setMemberProperties)\n-    PT.changeOwnershipOf = patch(PT.changeOwnershipOf)\n-    PT.acquireLocalRoles = patch(PT.acquireLocalRoles)\n-    PT.deleteObjectsByPaths = patch(PT.deleteObjectsByPaths)\n-    PT.renameObjectsByPaths = patch(PT.renameObjectsByPaths)\n+    from Products.PlonePAS.tools.membership import MembershipTool as PMT\n+    PMT.setPassword = patch(PMT.setPassword)\n \n     from Products.CMFCore.MembershipTool import MembershipTool as MT\n-    from Products.PlonePAS.tools.membership import MembershipTool as PMT\n     MT.setPassword = patch(MT.setPassword)\n-    PMT.setPassword = patch(PMT.setPassword)\n     MT.setRoleMapping = patch(MT.setRoleMapping)\n     MT.deleteMemberArea = patch(MT.deleteMemberArea)\n     MT.setLocalRoles = patch(MT.setLocalRoles)\n     MT.deleteLocalRoles = patch(MT.deleteLocalRoles)\n     MT.deleteMembers = patch(MT.deleteMembers)\n \n-    try:\n-        # XXX CMF 2.3 compatibility, but does it still make sense?\n-        from Products.CMFCore.MemberDataTool import MemberAdapter as MD\n-    except ImportError:\n-        from Products.CMFCore.MemberDataTool import MemberData as MD\n+    from Products.CMFCore.MemberDataTool import MemberAdapter as MD\n     original_setProperties = MD.setProperties\n \n     def setProperties(self, properties=None, REQUEST=None, **kw):\n@@ -37,9 +27,6 @@ def setProperties(self, properties=None, REQUEST=None, **kw):\n     setProperties.__doc__ = original_setProperties.__doc__\n     MD.setProperties = patch(setProperties)\n \n-    from Products.CMFPlone.RegistrationTool import RegistrationTool\n-    RegistrationTool.editMember = patch(RegistrationTool.editMember)\n-\n     from Products.PlonePAS.tools.groupdata import GroupData\n     GroupData.addMember = patch(GroupData.addMember)\n     GroupData.removeMember = patch(GroupData.removeMember)\ndiff --git a/Products/CMFPlone/patterns/view.py b/Products/CMFPlone/patterns/view.py\nindex 5f7b8e311b..138f740343 100644\n--- a/Products/CMFPlone/patterns/view.py\n+++ b/Products/CMFPlone/patterns/view.py\n@@ -1,6 +1,7 @@\n # This module delivers the global patterns settings\n-from plone.registry.interfaces import IRegistry\n from plone.base.interfaces import IPatternsSettings\n+from plone.memoize.view import memoize\n+from plone.registry.interfaces import IRegistry\n from zope.component import getAdapters\n from zope.component import getMultiAdapter\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/profiles/default/actions.xml b/Products/CMFPlone/profiles/default/actions.xml\nindex 0f79034d3f..19ed40366d 100644\n--- a/Products/CMFPlone/profiles/default/actions.xml\n+++ b/Products/CMFPlone/profiles/default/actions.xml\n@@ -47,7 +47,7 @@\n   <object name="sitemap" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Site Map</property>\n    <property name="description" i18n:translate=""></property>\n-   <property name="url_expr">string:${globals_view/navigationRootUrl}/sitemap</property>\n+   <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/sitemap"</property>\n    <property name="icon_expr">string:plone-sitemap</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n@@ -59,7 +59,7 @@\n    <property name="title" i18n:translate="">Accessibility</property>\n    <property name="description" i18n:translate=""></property>\n    <property\n-      name="url_expr">string:${globals_view/navigationRootUrl}/accessibility-info</property>\n+      name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/accessibility-info"</property>\n    <property name="icon_expr">string:plone-accessibility</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n@@ -70,7 +70,7 @@\n   <object name="contact" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Contact</property>\n    <property name="description" i18n:translate=""></property>\n-   <property name="url_expr">string:${globals_view/navigationRootUrl}/contact-info</property>\n+   <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/contact-info"</property>\n    <property name="icon_expr">string:plone-contact-info</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n@@ -86,7 +86,7 @@\n    <property name="title" i18n:translate="">Contents</property>\n    <property name="description" i18n:translate=""></property>\n    <property\n-      name="url_expr">string:${globals_view/getCurrentFolderUrl}/folder_contents</property>\n+      name="url_expr">python:f"{plone_context_state.folder().absolute_url()}/folder_contents"</property>\n    <property name="icon_expr">string:toolbar-action/folderContents</property>\n    <property name="permissions">\n     <element value="List folder contents"/>\n@@ -151,7 +151,7 @@\n       name="url_expr">string:$object_url/object_cut</property>\n    <property name="icon_expr">string:plone-cut</property>\n    <property\n-      name="available_expr">python:checkPermission("Delete objects", globals_view.getParentObject()) and checkPermission("Copy or Move", object) and not globals_view.isPortalOrPortalDefaultPage()</property>\n+      name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and checkPermission("Copy or Move", object) and not plone_context_state.is_portal_root()</property>\n    <property name="permissions">\n     <element value="Delete objects"/>\n    </property>\n@@ -164,7 +164,7 @@\n       name="url_expr">string:$object_url/object_copy</property>\n    <property name="icon_expr">string:plone-copy</property>\n    <property\n-      name="available_expr">python:checkPermission("Copy or Move", object) and not globals_view.isPortalOrPortalDefaultPage()</property>\n+      name="available_expr">python:checkPermission("Copy or Move", object) and not plone_context_state.is_portal_root()</property>\n    <property name="permissions">\n     <element value="View"/>\n    </property>\n@@ -173,7 +173,7 @@\n   <object name="paste" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Paste</property>\n    <property name="description" i18n:translate=""></property>\n-   <property name="url_expr">string:${globals_view/getCurrentFolderUrl}/object_paste</property>\n+   <property name="url_expr">python:f"{plone_context_state.folder().absolute_url()}/object_paste"</property>\n    <property name="icon_expr">string:plone-paste</property>\n    <property name="available_expr">folder/cb_dataValid|nothing</property>\n    <property name="permissions">\n@@ -188,7 +188,7 @@\n       name="url_expr">string:$object_url/delete_confirmation</property>\n    <property name="icon_expr">string:plone-delete</property>\n    <property\n-      name="available_expr">python:checkPermission("Delete objects", globals_view.getParentObject()) and not globals_view.isPortalOrPortalDefaultPage()</property>\n+      name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and not plone_context_state.is_portal_root()</property>\n    <property name="permissions">\n     <element value="Delete objects"/>\n    </property>\n@@ -202,7 +202,7 @@\n       name="url_expr">string:$object_url/object_rename</property>\n    <property name="icon_expr">string:plone-rename</property>\n    <property\n-      name="available_expr">python:checkPermission("Delete objects", globals_view.getParentObject()) and checkPermission("Copy or Move", object) and checkPermission("Add portal content", object) and not globals_view.isPortalOrPortalDefaultPage()</property>\n+      name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and checkPermission("Copy or Move", object) and checkPermission("Add portal content", object) and not plone_context_state.is_portal_root()</property>\n    <property name="permissions">\n     <element value="Add portal content"/>\n    </property>\n@@ -215,7 +215,7 @@\n    <property\n       name="url_expr">string: ${object_url}/@@manage-aliases</property>\n    <property name="icon_expr">string:plone-redirection</property>\n-   <property name="available_expr">python:not globals_view.isPortalOrPortalDefaultPage()</property>\n+   <property name="available_expr">python:not plone_context_state.is_portal_root()</property>\n    <property name="permissions">\n     <element value="Manage Context Aliases"/>\n    </property>\n@@ -227,8 +227,7 @@\n   <object name="index_html" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Home</property>\n    <property name="description" i18n:translate=""></property>\n-   <property\n-      name="url_expr">string:${globals_view/navigationRootUrl}</property>\n+   <property name="url_expr">python:plone_portal_state.navigation_root_url()</property>\n    <property name="icon_expr">string:plone-home</property>\n    <property name="available_expr"></property>\n    <property name="permissions">\n@@ -243,7 +242,7 @@\n    <property name="title" i18n:translate="">Preferences</property>\n    <property name="description" i18n:translate=""></property>\n    <property\n-      name="url_expr">string:${globals_view/navigationRootUrl}/@@personal-preferences</property>\n+      name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/@@personal-preferences"</property>\n    <property name="icon_expr">string:plone-user</property>\n    <property name="available_expr">python:member is not None</property>\n    <property name="permissions">\n@@ -266,7 +265,7 @@\n   <object name="login" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Log in</property>\n    <property name="description" i18n:translate=""></property>\n-   <property name="url_expr">string:${globals_view/navigationRootUrl}/login</property>\n+   <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/login"</property>\n    <property name="icon_expr">string:plone-login</property>\n    <property name="available_expr">python:member is None</property>\n    <property name="permissions">\n@@ -278,7 +277,7 @@\n   <object name="join" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Register</property>\n    <property name="description" i18n:translate=""></property>\n-   <property name="url_expr">string:${globals_view/navigationRootUrl}/@@register</property>\n+   <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/@@register"</property>\n    <property name="icon_expr">string:plone-register</property>\n    <property name="available_expr">python:member is None</property>\n    <property name="permissions">\n@@ -290,7 +289,7 @@\n   <object name="undo" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Undo</property>\n    <property name="description" i18n:translate=""></property>\n-   <property name="url_expr">string:${globals_view/navigationRootUrl}/undo_form</property>\n+   <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/undo_form"</property>\n    <property name="icon_expr">string:plone-undo</property>\n    <property name="available_expr">python:member is not None</property>\n    <property name="permissions">\n@@ -313,7 +312,7 @@\n   <object name="logout" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Log out</property>\n    <property name="description" i18n:translate=""></property>\n-   <property name="url_expr">string:${globals_view/navigationRootUrl}/logout</property>\n+   <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/logout"</property>\n    <property name="icon_expr">string:plone-logout</property>\n    <property name="available_expr">python:member is not None</property>\n    <property name="permissions">\ndiff --git a/Products/CMFPlone/resources/browser/resource.py b/Products/CMFPlone/resources/browser/resource.py\nindex 14d0412a26..194ca8ce55 100644\n--- a/Products/CMFPlone/resources/browser/resource.py\n+++ b/Products/CMFPlone/resources/browser/resource.py\n@@ -131,7 +131,7 @@ def check_dependencies(bundle_name, depends, bundles):\n                     # ignore dependency on bundle outside "bundles"\n                     continue\n \n-                msg = f"Bundle \'{bundle_name}\' has a non existing dependeny on \'{name}\'. "\n+                msg = f"Bundle \'{bundle_name}\' has a non existing dependency on \'{name}\'. "\n \n                 if name in GRACEFUL_DEPENDENCY_REWRITE:\n                     # gracefully rewrite old bundle names\ndiff --git a/Products/CMFPlone/tests/testBrowserDefault.py b/Products/CMFPlone/tests/testBrowserDefault.py\nindex ace5f9a80e..65ad4d8943 100644\n--- a/Products/CMFPlone/tests/testBrowserDefault.py\n+++ b/Products/CMFPlone/tests/testBrowserDefault.py\n@@ -1,15 +1,15 @@\n from Acquisition import aq_base\n+from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n-from plone.app.testing import setRoles\n+from plone.base.utils import safe_text\n+from plone.base.utils import unrestricted_construct_instance\n from plone.namedfile.file import NamedBlobFile\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from Products.CMFPlone.utils import _createObjectByType\n-from plone.base.utils import safe_text\n from zope.component import getUtility\n \n import difflib\n@@ -17,6 +17,7 @@\n import transaction\n import unittest\n \n+\n RE_REMOVE_DOCCONT = re.compile(r\'\\s*href="http://.*?#content"\')\n RE_REMOVE_SKIPNAV = re.compile(r\'\\s*href="http://.*?#portal-globalnav-wrapper"\')\n RE_REMOVE_TABS = re.compile(r\'<div id="portal-header".*?</nav>\', re.S)\n@@ -42,9 +43,9 @@ def setUp(self):\n         from plone.protect import auto\n         auto.CSRF_DISABLED = True\n \n-        _createObjectByType(\'Folder\', self.portal, \'folder\')\n-        _createObjectByType(\'Document\', self.portal, \'document\')\n-        _createObjectByType(\'File\', self.portal, \'file\')\n+        unrestricted_construct_instance(\'Folder\', self.portal, \'folder\')\n+        unrestricted_construct_instance(\'Document\', self.portal, \'document\')\n+        unrestricted_construct_instance(\'File\', self.portal, \'file\')\n         self.portal.file.file = NamedBlobFile(\'foo\', \'text/plain\', \'foo.txt\')\n         transaction.commit()\n \ndiff --git a/Products/CMFPlone/tests/testPloneTool.py b/Products/CMFPlone/tests/testPloneTool.py\nindex 459d21d01e..86a8d2b365 100644\n--- a/Products/CMFPlone/tests/testPloneTool.py\n+++ b/Products/CMFPlone/tests/testPloneTool.py\n@@ -1,33 +1,32 @@\n from Acquisition import Implicit\n from plone.app.testing import SITE_OWNER_NAME\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import IReorderedEvent\n from plone.base.interfaces import ISearchSchema\n+from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.tests import PloneTestCase\n from zope.component import getGlobalSiteManager\n from zope.component import getUtility\n from zope.interface import Interface\n \n+\n default_user = PloneTestCase.default_user\n portal_name = PloneTestCase.portal_name\n \n \n class DummyTitle(Implicit):\n-\n     def Title(self):\n         # Should just return \'portal_catalog\'\n-        tool = getToolByName(self, \'portal_catalog\')\n+        tool = getToolByName(self, "portal_catalog")\n         # Use implicit acquisition even, the horror\n         tool = self.portal_catalog\n         return tool.getId()\n \n     def getId(self):\n-        return \'foobar\'\n+        return "foobar"\n \n \n class TestPloneTool(PloneTestCase.PloneTestCase):\n-\n     def afterSetUp(self):\n         self.utils = self.portal.plone_utils\n \n@@ -35,99 +34,102 @@ def testvalidateSingleEmailAddress(self):\n         # Any RFC 822 email address allowed, but address list must fail\n         val = self.utils.validateSingleEmailAddress\n         validInputs = (\n-            \'user@example.org\',\n-            \'user@host.example.org\',\n-            \'m@t.nu\',\n-            \'USER@EXAMPLE.ORG\',\n-            \'USER@HOST.EXAMPLE.ORG\',\n-            \'USER@hoST.Example.Org\',\n+            "user@example.org",\n+            "user@host.example.org",\n+            "m@t.nu",\n+            "USER@EXAMPLE.ORG",\n+            "USER@HOST.EXAMPLE.ORG",\n+            "USER@hoST.Example.Org",\n         )\n         invalidInputs = (\n-            \'user@example.org, user2@example.org\',  # only single address allowed\n-            \'user@example.org,user2@example.org\',\n-            \'user@example.org\\n\\nfoo\',  # double new lines\n-            \'user@example.org\\n\\rfoo\',\n-            \'user@example.org\\r\\nfoo\',\n-            \'user@example.org\\r\\rfoo\',\n+            "user@example.org, user2@example.org",  # only single address allowed\n+            "user@example.org,user2@example.org",\n+            "user@example.org\\n\\nfoo",  # double new lines\n+            "user@example.org\\n\\rfoo",\n+            "user@example.org\\r\\nfoo",\n+            "user@example.org\\r\\rfoo",\n             # only single address allowed, even if given one per line\n-            \'user@example.org\\nfoo@example.org\',\n-            \'user@example.org\\nBcc: user@example.org\',\n-            \'user@example.org\\nCc: user@example.org\',\n-            \'user@example.org\\nSubject: Spam\',\n+            "user@example.org\\nfoo@example.org",\n+            "user@example.org\\nBcc: user@example.org",\n+            "user@example.org\\nCc: user@example.org",\n+            "user@example.org\\nSubject: Spam",\n             # and a full email (note the missing ,!)\n-            \'From: foo@example.org\\n\'\n-            \'To: bar@example.org, spam@example.org\\n\'\n-            \'Cc: egg@example.org\\n\'\n-            \'Subject: Spam me plenty\\n\'\n-            \'Spam Spam Spam\\n\'\n-            \'I hate spam\',\n+            "From: foo@example.org\\n"\n+            "To: bar@example.org, spam@example.org\\n"\n+            "Cc: egg@example.org\\n"\n+            "Subject: Spam me plenty\\n"\n+            "Spam Spam Spam\\n"\n+            "I hate spam",\n         )\n         for address in validInputs:\n-            self.assertTrue(val(address), \'%s should validate\' % address)\n+            self.assertTrue(val(address), "%s should validate" % address)\n         for address in invalidInputs:\n-            self.assertFalse(val(address), \'%s should fail\' % address)\n+            self.assertFalse(val(address), "%s should fail" % address)\n \n     def testvalidateEmailAddresses(self):\n         # Any RFC 822 email address allowed and address list allowed\n         val = self.utils.validateEmailAddresses\n \n         validInputs = (\n-            \'user@example.org\',\n-            \'user@example.org,\\n user2@example.org\',\n-            \'user@example.org\\n user2@example.org\',  # omitting comma is ok\n-            \'USER@EXAMPLE.ORG,\\n User2@Example.Org\',\n+            "user@example.org",\n+            "user@example.org,\\n user2@example.org",\n+            "user@example.org\\n user2@example.org",  # omitting comma is ok\n+            "USER@EXAMPLE.ORG,\\n User2@Example.Org",\n         )\n         invalidInputs = (\n-            \'user@example.org\\n\\nfoo\',  # double new lines\n-            \'user@example.org\\n\\rfoo\',\n-            \'user@example.org\\r\\nfoo\',\n-            \'user@example.org\\r\\rfoo\',\n+            "user@example.org\\n\\nfoo",  # double new lines\n+            "user@example.org\\n\\rfoo",\n+            "user@example.org\\r\\nfoo",\n+            "user@example.org\\r\\rfoo",\n         )\n         for address in validInputs:\n-            self.assertTrue(val(address), \'%s should validate\' % address)\n+            self.assertTrue(val(address), "%s should validate" % address)\n         for address in invalidInputs:\n-            self.assertFalse(val(address), \'%s should fail\' % address)\n+            self.assertFalse(val(address), "%s should fail" % address)\n \n     def testNormalizeStringPunctuation(self):\n         # Punctuation and spacing is removed and replaced by \'-\'\n-        self.assertEqual(self.utils.normalizeString("a string with spaces"),\n-                         \'a-string-with-spaces\')\n-        self.assertEqual(self.utils.normalizeString("p.u,n;c(t)u!a@t#i$o%n"),\n-                         \'p-u-n-c-t-u-a-t-i-o-n\')\n+        self.assertEqual(\n+            self.utils.normalizeString("a string with spaces"), "a-string-with-spaces"\n+        )\n+        self.assertEqual(\n+            self.utils.normalizeString("p.u,n;c(t)u!a@t#i$o%n"), "p-u-n-c-t-u-a-t-i-o-n"\n+        )\n \n     def testNormalizeStringFileExtensions(self):\n         # The plone tool version uses the id normalizer, so it doesn\'t\n         # preservce file extensions. Use the file name normalizer from\n         # plone.i18n if you need the behavior.\n-        self.assertEqual(self.utils.normalizeString("this is a file.gif"),\n-                         \'this-is-a-file-gif\')\n-        self.assertEqual(self.utils.normalizeString("its. also. a file.html"),\n-                         \'its-also-a-file-html\')\n+        self.assertEqual(\n+            self.utils.normalizeString("this is a file.gif"), "this-is-a-file-gif"\n+        )\n+        self.assertEqual(\n+            self.utils.normalizeString("its. also. a file.html"), "its-also-a-file-html"\n+        )\n \n     def testNormalizeStringIgnoredCharacters(self):\n         # Some characters should be ignored\n-        self.assertEqual(self.utils.normalizeString("test\'test"), \'testtest\')\n+        self.assertEqual(self.utils.normalizeString("test\'test"), "testtest")\n \n     def testNormalizeStringObject(self):\n         # Objects should be converted to strings using repr()\n-        self.assertEqual(self.utils.normalizeString(None), \'none\')\n-        self.assertEqual(self.utils.normalizeString(True), \'true\')\n-        self.assertEqual(self.utils.normalizeString(False), \'false\')\n+        self.assertEqual(self.utils.normalizeString(None), "none")\n+        self.assertEqual(self.utils.normalizeString(True), "true")\n+        self.assertEqual(self.utils.normalizeString(False), "false")\n \n     def testNormalizeStringDangerousCharsInExtension(self):\n         # Punctuation and spacing is removed and replaced by \'-\'\n-        self.assertEqual(self.utils.normalizeString("A String.a#b"),\n-                         \'a-string-a-b\')\n+        self.assertEqual(self.utils.normalizeString("A String.a#b"), "a-string-a-b")\n \n     def testTypesToList(self):\n         # Make sure typesToList() returns the expected types\n         wl = self.utils.typesToList()\n-        self.assertTrue(\'Folder\' in wl)\n-        self.assertTrue(\'Document\' in wl)\n-        self.assertFalse(\'ATReferenceCriterion\' in wl)\n+        self.assertTrue("Folder" in wl)\n+        self.assertTrue("Document" in wl)\n+        self.assertFalse("ATReferenceCriterion" in wl)\n \n     def testGetUserFriendlyTypes(self):\n-        ttool = getToolByName(self.portal, \'portal_types\')\n+        ttool = getToolByName(self.portal, "portal_types")\n         types = set(ttool.keys())\n         registry = getUtility(IRegistry)\n         search_settings = registry.forInterface(ISearchSchema, prefix="plone")\n@@ -137,15 +139,17 @@ def testGetUserFriendlyTypes(self):\n         # so we filter that out.\n         blacklistedTypes = {t for t in blacklistedTypes if t in types}\n         # No black listed types should be returned.\n-        self.assertEqual([t for t in self.utils.getUserFriendlyTypes()\n-                          if t in blacklistedTypes], [])\n-        self.assertEqual(len(self.utils.getUserFriendlyTypes()),\n-                         len(types) - len(blacklistedTypes))\n+        self.assertEqual(\n+            [t for t in self.utils.getUserFriendlyTypes() if t in blacklistedTypes], []\n+        )\n+        self.assertEqual(\n+            len(self.utils.getUserFriendlyTypes()), len(types) - len(blacklistedTypes)\n+        )\n         # Non-existing types should be filtered out.\n-        self.assertEqual(self.utils.getUserFriendlyTypes(\n-            [\'File\']), [\'File\'])\n-        self.assertEqual(self.utils.getUserFriendlyTypes(\n-            [\'File\', \'Non Existing Type\']), [\'File\'])\n+        self.assertEqual(self.utils.getUserFriendlyTypes(["File"]), ["File"])\n+        self.assertEqual(\n+            self.utils.getUserFriendlyTypes(["File", "Non Existing Type"]), ["File"]\n+        )\n \n     def testReindexOnReorder(self):\n         gsm = getGlobalSiteManager()\n@@ -153,6 +157,7 @@ def testReindexOnReorder(self):\n \n         def my_handler(obj, event):\n             reordered_parents.append(obj)\n+\n         gsm.registerHandler(my_handler, (Interface, IReorderedEvent))\n \n         try:\n@@ -163,16 +168,15 @@ def my_handler(obj, event):\n \n \n class TestOwnershipStuff(PloneTestCase.PloneTestCase):\n-\n     def afterSetUp(self):\n         self.utils = self.portal.plone_utils\n         self.membership = self.portal.portal_membership\n-        self.membership.addMember(\'new_owner\', \'secret\', [\'Member\'], [])\n-        self.folder.invokeFactory(\'Folder\', \'folder1\')\n+        self.membership.addMember("new_owner", "secret", ["Member"], [])\n+        self.folder.invokeFactory("Folder", "folder1")\n         self.folder1 = self.folder.folder1\n-        self.folder1.invokeFactory(\'Folder\', \'folder2\')\n+        self.folder1.invokeFactory("Folder", "folder2")\n         self.folder2 = self.folder1.folder2\n-        self.folder2.invokeFactory(\'Folder\', \'folder3\')\n+        self.folder2.invokeFactory("Folder", "folder3")\n         self.folder3 = self.folder2.folder3\n \n     def assertList(self, result, expect):\n@@ -186,345 +190,343 @@ def assertList(self, result, expect):\n     def testChangeOwnershipOf(self):\n         # Should take ownership\n         self.assertEqual(self.folder1.getOwnerTuple()[1], default_user)\n-        self.assertList(self.folder1.get_local_roles_for_userid(default_user),\n-                        [\'Owner\'])\n+        self.assertList(\n+            self.folder1.get_local_roles_for_userid(default_user), ["Owner"]\n+        )\n \n-        self.utils.changeOwnershipOf(self.folder1, \'new_owner\')\n-        self.assertEqual(self.folder1.getOwnerTuple()[0], [portal_name,\n-                                                           \'acl_users\'])\n-        self.assertEqual(self.folder1.getOwnerTuple()[1], \'new_owner\')\n-        self.assertList(self.folder1.get_local_roles_for_userid(\'new_owner\'),\n-                        [\'Owner\'])\n+        self.utils.changeOwnershipOf(self.folder1, "new_owner")\n+        self.assertEqual(self.folder1.getOwnerTuple()[0], [portal_name, "acl_users"])\n+        self.assertEqual(self.folder1.getOwnerTuple()[1], "new_owner")\n+        self.assertList(self.folder1.get_local_roles_for_userid("new_owner"), ["Owner"])\n \n         # Initial creator no longer has Owner role.\n-        self.assertList(\n-            self.folder1.get_local_roles_for_userid(default_user), [])\n+        self.assertList(self.folder1.get_local_roles_for_userid(default_user), [])\n \n     def testChangeOwnershipOfWithTopAclUsers(self):\n         # Should be able to give ownership to a user in the top level\n         # acl_users folder (even if this is not offered TTW).\n         self.utils.changeOwnershipOf(self.folder1, SITE_OWNER_NAME)\n-        self.assertEqual(self.folder1.getOwnerTuple()[0], [\'acl_users\'])\n+        self.assertEqual(self.folder1.getOwnerTuple()[0], ["acl_users"])\n         self.assertEqual(self.folder1.getOwnerTuple()[1], SITE_OWNER_NAME)\n         self.assertList(\n-            self.folder1.get_local_roles_for_userid(SITE_OWNER_NAME),\n-            [\'Owner\'])\n+            self.folder1.get_local_roles_for_userid(SITE_OWNER_NAME), ["Owner"]\n+        )\n \n         # Initial creator no longer has Owner role.\n-        self.assertList(\n-            self.folder1.get_local_roles_for_userid(default_user), [])\n+        self.assertList(self.folder1.get_local_roles_for_userid(default_user), [])\n \n     def testChangeOwnershipOfKeepsOtherRoles(self):\n         # Should preserve roles other than Owner\n-        self.folder1.manage_addLocalRoles(\'new_owner\', (\'Reviewer\',))\n-        self.assertList(self.folder1.get_local_roles_for_userid(\'new_owner\'),\n-                        [\'Reviewer\'])\n-        self.utils.changeOwnershipOf(self.folder1, \'new_owner\')\n-        self.assertEqual(self.folder1.getOwnerTuple()[1], \'new_owner\')\n-        self.assertList(self.folder1.get_local_roles_for_userid(\'new_owner\'),\n-                        [\'Owner\', \'Reviewer\'])\n+        self.folder1.manage_addLocalRoles("new_owner", ("Reviewer",))\n         self.assertList(\n-            self.folder1.get_local_roles_for_userid(default_user), [])\n+            self.folder1.get_local_roles_for_userid("new_owner"), ["Reviewer"]\n+        )\n+        self.utils.changeOwnershipOf(self.folder1, "new_owner")\n+        self.assertEqual(self.folder1.getOwnerTuple()[1], "new_owner")\n+        self.assertList(\n+            self.folder1.get_local_roles_for_userid("new_owner"), ["Owner", "Reviewer"]\n+        )\n+        self.assertList(self.folder1.get_local_roles_for_userid(default_user), [])\n \n     def testChangeOwnershipOfRecursive(self):\n         # Should take ownership of subobjects as well\n-        self.utils.changeOwnershipOf(self.folder1, \'new_owner\', recursive=1)\n-        self.assertEqual(self.folder1.getOwnerTuple()[1], \'new_owner\')\n-        self.assertList(self.folder1.get_local_roles_for_userid(\'new_owner\'),\n-                        [\'Owner\'])\n-        self.assertList(\n-            self.folder1.get_local_roles_for_userid(default_user), [])\n-        self.assertEqual(self.folder2.getOwnerTuple()[1], \'new_owner\')\n-        self.assertList(self.folder2.get_local_roles_for_userid(\'new_owner\'),\n-                        [\'Owner\'])\n-        self.assertList(\n-            self.folder2.get_local_roles_for_userid(default_user), [])\n-        self.assertEqual(self.folder3.getOwnerTuple()[1], \'new_owner\')\n-        self.assertList(self.folder3.get_local_roles_for_userid(\'new_owner\'),\n-                        [\'Owner\'])\n-        self.assertList(\n-            self.folder3.get_local_roles_for_userid(default_user), [])\n+        self.utils.changeOwnershipOf(self.folder1, "new_owner", recursive=1)\n+        self.assertEqual(self.folder1.getOwnerTuple()[1], "new_owner")\n+        self.assertList(self.folder1.get_local_roles_for_userid("new_owner"), ["Owner"])\n+        self.assertList(self.folder1.get_local_roles_for_userid(default_user), [])\n+        self.assertEqual(self.folder2.getOwnerTuple()[1], "new_owner")\n+        self.assertList(self.folder2.get_local_roles_for_userid("new_owner"), ["Owner"])\n+        self.assertList(self.folder2.get_local_roles_for_userid(default_user), [])\n+        self.assertEqual(self.folder3.getOwnerTuple()[1], "new_owner")\n+        self.assertList(self.folder3.get_local_roles_for_userid("new_owner"), ["Owner"])\n+        self.assertList(self.folder3.get_local_roles_for_userid(default_user), [])\n \n     def testGetOwnerName(self):\n         # Test that getOwnerName gets the Owner name\n         self.assertEqual(self.utils.getOwnerName(self.folder1), default_user)\n-        self.utils.changeOwnershipOf(self.folder1, \'new_owner\')\n-        self.assertEqual(self.utils.getOwnerName(self.folder1), \'new_owner\')\n+        self.utils.changeOwnershipOf(self.folder1, "new_owner")\n+        self.assertEqual(self.utils.getOwnerName(self.folder1), "new_owner")\n \n     def testGetInheritedLocalRoles(self):\n         # Test basic local roles acquisition is dealt with by\n         # getInheritedLocalRoles\n         gILR = self.utils.getInheritedLocalRoles\n-        self.folder1.manage_addLocalRoles(\'new_owner\', (\'Reviewer\',))\n+        self.folder1.manage_addLocalRoles("new_owner", ("Reviewer",))\n         # Test Normal role acquisition is returned\n-        filtered_roles = [r for r in gILR(self.folder2)\n-                          if r[0] == \'new_owner\'][0]\n-        self.assertList(filtered_roles[1], [\'Reviewer\'])\n-        filtered_roles = [r for r in gILR(self.folder3)\n-                          if r[0] == \'new_owner\'][0]\n-        self.assertList(filtered_roles[1], [\'Reviewer\'])\n+        filtered_roles = [r for r in gILR(self.folder2) if r[0] == "new_owner"][0]\n+        self.assertList(filtered_roles[1], ["Reviewer"])\n+        filtered_roles = [r for r in gILR(self.folder3) if r[0] == "new_owner"][0]\n+        self.assertList(filtered_roles[1], ["Reviewer"])\n \n     def testGetInheritedLocalRolesMultiLevel(self):\n         # Test for http://dev.plone.org/plone/ticket/3901\n         # make sure local roles are picked up from all folders in tree.\n         gILR = self.utils.getInheritedLocalRoles\n-        self.folder1.manage_addLocalRoles(\'new_owner\', (\'Reviewer\',))\n-        self.folder2.manage_addLocalRoles(\'new_owner\', (\'Owner\',))\n+        self.folder1.manage_addLocalRoles("new_owner", ("Reviewer",))\n+        self.folder2.manage_addLocalRoles("new_owner", ("Owner",))\n \n         # folder2 should have only the inherited role\n-        filtered_roles = [r for r in gILR(self.folder2)\n-                          if r[0] == \'new_owner\'][0]\n-        self.assertList(filtered_roles[1], [\'Reviewer\'])\n+        filtered_roles = [r for r in gILR(self.folder2) if r[0] == "new_owner"][0]\n+        self.assertList(filtered_roles[1], ["Reviewer"])\n \n         # folder3 should have roles inherited from parent and grand-parent\n-        filtered_roles = [r for r in gILR(self.folder3)\n-                          if r[0] == \'new_owner\'][0]\n-        self.assertList(filtered_roles[1], [\'Owner\', \'Reviewer\'])\n+        filtered_roles = [r for r in gILR(self.folder3) if r[0] == "new_owner"][0]\n+        self.assertList(filtered_roles[1], ["Owner", "Reviewer"])\n \n \n class TestEditMetadata(PloneTestCase.PloneTestCase):\n-\n     def afterSetUp(self):\n         self.utils = self.portal.plone_utils\n-        self.folder.invokeFactory(\'Document\', id=\'doc\')\n+        self.folder.invokeFactory("Document", id="doc")\n         self.doc = self.folder.doc\n \n     def testSetTitle(self):\n-        self.assertEqual(self.doc.Title(), \'\')\n-        self.utils.editMetadata(self.doc, title=\'Foo\')\n-        self.assertEqual(self.doc.Title(), \'Foo\')\n+        self.assertEqual(self.doc.Title(), "")\n+        self.utils.editMetadata(self.doc, title="Foo")\n+        self.assertEqual(self.doc.Title(), "Foo")\n \n     def testClearTitle(self):\n-        self.utils.editMetadata(self.doc, title=\'Foo\')\n-        self.assertEqual(self.doc.Title(), \'Foo\')\n-        self.utils.editMetadata(self.doc, title=\'\')\n-        self.assertEqual(self.doc.Title(), \'\')\n+        self.utils.editMetadata(self.doc, title="Foo")\n+        self.assertEqual(self.doc.Title(), "Foo")\n+        self.utils.editMetadata(self.doc, title="")\n+        self.assertEqual(self.doc.Title(), "")\n \n     def testSetDescription(self):\n-        self.assertEqual(self.doc.Description(), \'\')\n-        self.utils.editMetadata(self.doc, description=\'Foo\')\n-        self.assertEqual(self.doc.Description(), \'Foo\')\n+        self.assertEqual(self.doc.Description(), "")\n+        self.utils.editMetadata(self.doc, description="Foo")\n+        self.assertEqual(self.doc.Description(), "Foo")\n \n     def testClearDescription(self):\n-        self.utils.editMetadata(self.doc, description=\'Foo\')\n-        self.assertEqual(self.doc.Description(), \'Foo\')\n-        self.utils.editMetadata(self.doc, description=\'\')\n-        self.assertEqual(self.doc.Description(), \'\')\n+        self.utils.editMetadata(self.doc, description="Foo")\n+        self.assertEqual(self.doc.Description(), "Foo")\n+        self.utils.editMetadata(self.doc, description="")\n+        self.assertEqual(self.doc.Description(), "")\n \n     def testSetSubject(self):\n         self.assertEqual(self.doc.Subject(), ())\n-        self.utils.editMetadata(self.doc, subject=[\'Foo\'])\n-        self.assertEqual(self.doc.Subject(), (\'Foo\',))\n+        self.utils.editMetadata(self.doc, subject=["Foo"])\n+        self.assertEqual(self.doc.Subject(), ("Foo",))\n \n     def testClearSubject(self):\n-        self.utils.editMetadata(self.doc, subject=[\'Foo\'])\n-        self.assertEqual(self.doc.Subject(), (\'Foo\',))\n+        self.utils.editMetadata(self.doc, subject=["Foo"])\n+        self.assertEqual(self.doc.Subject(), ("Foo",))\n         self.utils.editMetadata(self.doc, subject=[])\n         self.assertEqual(self.doc.Subject(), ())\n \n     def testSetContributors(self):\n         self.assertEqual(self.doc.Contributors(), ())\n-        self.utils.editMetadata(self.doc, contributors=[\'Foo\'])\n-        self.assertEqual(self.doc.Contributors(), (\'Foo\',))\n+        self.utils.editMetadata(self.doc, contributors=["Foo"])\n+        self.assertEqual(self.doc.Contributors(), ("Foo",))\n \n     def testClearContributors(self):\n-        self.utils.editMetadata(self.doc, contributors=[\'Foo\'])\n-        self.assertEqual(self.doc.Contributors(), (\'Foo\',))\n+        self.utils.editMetadata(self.doc, contributors=["Foo"])\n+        self.assertEqual(self.doc.Contributors(), ("Foo",))\n         self.utils.editMetadata(self.doc, contributors=[])\n         self.assertEqual(self.doc.Contributors(), ())\n \n     def testSetFormat(self):\n-        self.assertEqual(self.doc.Format(), \'text/html\')\n-        self.assertEqual(self.doc.format, \'text/html\')\n-        self.utils.editMetadata(self.doc, format=\'text/x-rst\')\n-        self.assertEqual(self.doc.format, \'text/x-rst\')\n-        self.assertEqual(self.doc.Format(), \'text/x-rst\')\n+        self.assertEqual(self.doc.Format(), "text/html")\n+        self.assertEqual(self.doc.format, "text/html")\n+        self.utils.editMetadata(self.doc, format="text/x-rst")\n+        self.assertEqual(self.doc.format, "text/x-rst")\n+        self.assertEqual(self.doc.Format(), "text/x-rst")\n \n     def testClearFormat(self):\n-        self.utils.editMetadata(self.doc, format=\'text/x-rst\')\n-        self.assertEqual(self.doc.format, \'text/x-rst\')\n-        self.assertEqual(self.doc.Format(), \'text/x-rst\')\n-        self.utils.editMetadata(self.doc, format=\'\')\n-        self.assertEqual(self.doc.Format(), \'\')\n-        self.assertEqual(self.doc.format, \'\')\n+        self.utils.editMetadata(self.doc, format="text/x-rst")\n+        self.assertEqual(self.doc.format, "text/x-rst")\n+        self.assertEqual(self.doc.Format(), "text/x-rst")\n+        self.utils.editMetadata(self.doc, format="")\n+        self.assertEqual(self.doc.Format(), "")\n+        self.assertEqual(self.doc.format, "")\n \n     def testSetLanguage(self):\n-        self.assertEqual(self.doc.Language(), \'\')\n-        self.utils.editMetadata(self.doc, language=\'de\')\n-        self.assertEqual(self.doc.Language(), \'de\')\n+        self.assertEqual(self.doc.Language(), "")\n+        self.utils.editMetadata(self.doc, language="de")\n+        self.assertEqual(self.doc.Language(), "de")\n \n     def testClearLanguage(self):\n-        self.utils.editMetadata(self.doc, language=\'de\')\n-        self.assertEqual(self.doc.Language(), \'de\')\n-        self.utils.editMetadata(self.doc, language=\'\')\n-        self.assertEqual(self.doc.Language(), \'\')\n+        self.utils.editMetadata(self.doc, language="de")\n+        self.assertEqual(self.doc.Language(), "de")\n+        self.utils.editMetadata(self.doc, language="")\n+        self.assertEqual(self.doc.Language(), "")\n \n     def testSetRights(self):\n-        self.assertEqual(self.doc.Rights(), \'\')\n-        self.utils.editMetadata(self.doc, rights=\'Foo\')\n-        self.assertEqual(self.doc.Rights(), \'Foo\')\n+        self.assertEqual(self.doc.Rights(), "")\n+        self.utils.editMetadata(self.doc, rights="Foo")\n+        self.assertEqual(self.doc.Rights(), "Foo")\n \n     def testClearRights(self):\n-        self.utils.editMetadata(self.doc, rights=\'Foo\')\n-        self.assertEqual(self.doc.Rights(), \'Foo\')\n-        self.utils.editMetadata(self.doc, rights=\'\')\n-        self.assertEqual(self.doc.Rights(), \'\')\n+        self.utils.editMetadata(self.doc, rights="Foo")\n+        self.assertEqual(self.doc.Rights(), "Foo")\n+        self.utils.editMetadata(self.doc, rights="")\n+        self.assertEqual(self.doc.Rights(), "")\n \n     # Also test the various dates\n \n     def testSetEffectiveDate(self):\n-        self.assertEqual(self.doc.EffectiveDate(), \'None\')\n-        self.utils.editMetadata(self.doc, effective_date=\'2001-01-01\')\n-        self.assertTrue(self.doc.effective_date.ISO8601()\n-                            .startswith(\'2001-01-01T00:00:00\'))\n+        self.assertEqual(self.doc.EffectiveDate(), "None")\n+        self.utils.editMetadata(self.doc, effective_date="2001-01-01")\n+        self.assertTrue(\n+            self.doc.effective_date.ISO8601().startswith("2001-01-01T00:00:00")\n+        )\n \n     def testClearEffectiveDate(self):\n-        self.utils.editMetadata(self.doc, effective_date=\'2001-01-01\')\n-        self.assertTrue(self.doc.effective_date.ISO8601()\n-                            .startswith(\'2001-01-01T00:00:00\'))\n-        self.utils.editMetadata(self.doc, effective_date=\'None\')\n-        self.assertEqual(self.doc.EffectiveDate(), \'None\')\n+        self.utils.editMetadata(self.doc, effective_date="2001-01-01")\n+        self.assertTrue(\n+            self.doc.effective_date.ISO8601().startswith("2001-01-01T00:00:00")\n+        )\n+        self.utils.editMetadata(self.doc, effective_date="None")\n+        self.assertEqual(self.doc.EffectiveDate(), "None")\n         self.assertEqual(self.doc.effective_date, None)\n \n     def testSetExpirationDate(self):\n-        self.assertEqual(self.doc.ExpirationDate(), \'None\')\n-        self.utils.editMetadata(self.doc, expiration_date=\'2001-01-01\')\n-        self.assertTrue(self.doc.expiration_date.ISO8601()\n-                            .startswith(\'2001-01-01T00:00:00\'))\n+        self.assertEqual(self.doc.ExpirationDate(), "None")\n+        self.utils.editMetadata(self.doc, expiration_date="2001-01-01")\n+        self.assertTrue(\n+            self.doc.expiration_date.ISO8601().startswith("2001-01-01T00:00:00")\n+        )\n \n     def testClearExpirationDate(self):\n-        self.utils.editMetadata(self.doc, expiration_date=\'2001-01-01\')\n-        self.assertTrue(self.doc.expiration_date.ISO8601()\n-                            .startswith(\'2001-01-01T00:00:00\'))\n-        self.utils.editMetadata(self.doc, expiration_date=\'None\')\n-        self.assertEqual(self.doc.ExpirationDate(), \'None\')\n+        self.utils.editMetadata(self.doc, expiration_date="2001-01-01")\n+        self.assertTrue(\n+            self.doc.expiration_date.ISO8601().startswith("2001-01-01T00:00:00")\n+        )\n+        self.utils.editMetadata(self.doc, expiration_date="None")\n+        self.assertEqual(self.doc.ExpirationDate(), "None")\n         self.assertEqual(self.doc.expiration_date, None)\n \n     # Test special cases of tuplification\n \n     def testTuplifySubject_1(self):\n-        self.utils.editMetadata(self.doc, subject=[\'Foo\', \'Bar\', \'Baz\'])\n-        self.assertEqual(self.doc.Subject(), (\'Foo\', \'Bar\', \'Baz\'))\n+        self.utils.editMetadata(self.doc, subject=["Foo", "Bar", "Baz"])\n+        self.assertEqual(self.doc.Subject(), ("Foo", "Bar", "Baz"))\n \n     def testTuplifySubject_2(self):\n-        self.utils.editMetadata(self.doc, subject=[\'Foo\', \'\', \'Bar\', \'Baz\'])\n+        self.utils.editMetadata(self.doc, subject=["Foo", "", "Bar", "Baz"])\n         # Note that empty entries are filtered\n-        self.assertEqual(self.doc.Subject(), (\'Foo\', \'Bar\', \'Baz\'))\n+        self.assertEqual(self.doc.Subject(), ("Foo", "Bar", "Baz"))\n \n     def DISABLED_testTuplifySubject_3(self):\n-        self.utils.editMetadata(self.doc, subject=\'Foo, Bar, Baz\')\n+        self.utils.editMetadata(self.doc, subject="Foo, Bar, Baz")\n         # TODO: Wishful thinking\n-        self.assertEqual(self.doc.Subject(), (\'Foo\', \'Bar\', \'Baz\'))\n+        self.assertEqual(self.doc.Subject(), ("Foo", "Bar", "Baz"))\n \n     def testTuplifyContributors_1(self):\n-        self.utils.editMetadata(self.doc, contributors=[\'Foo\', \'Bar\', \'Baz\'])\n-        self.assertEqual(self.doc.Contributors(), (\'Foo\', \'Bar\', \'Baz\'))\n+        self.utils.editMetadata(self.doc, contributors=["Foo", "Bar", "Baz"])\n+        self.assertEqual(self.doc.Contributors(), ("Foo", "Bar", "Baz"))\n \n     def testTuplifyContributors_2(self):\n-        self.utils.editMetadata(self.doc,\n-                                contributors=[\'Foo\', \'\', \'Bar\', \'Baz\'])\n+        self.utils.editMetadata(self.doc, contributors=["Foo", "", "Bar", "Baz"])\n         # Note that empty entries are filtered\n-        self.assertEqual(self.doc.Contributors(), (\'Foo\', \'Bar\', \'Baz\'))\n+        self.assertEqual(self.doc.Contributors(), ("Foo", "Bar", "Baz"))\n \n     def DISABLED_testTuplifyContributors_3(self):\n-        self.utils.editMetadata(self.doc, contributors=\'Foo; Bar; Baz\')\n+        self.utils.editMetadata(self.doc, contributors="Foo; Bar; Baz")\n         # TODO: Wishful thinking\n-        self.assertEqual(self.doc.Contributors(), (\'Foo\', \'Bar\', \'Baz\'))\n+        self.assertEqual(self.doc.Contributors(), ("Foo", "Bar", "Baz"))\n \n \n class TestEditMetadataIndependence(PloneTestCase.PloneTestCase):\n-\n     def afterSetUp(self):\n         self.utils = self.portal.plone_utils\n-        self.folder.invokeFactory(\'Document\', id=\'doc\')\n+        self.folder.invokeFactory("Document", id="doc")\n         self.doc = self.folder.doc\n-        self.utils.editMetadata(self.doc,\n-                                title=\'Foo\',\n-                                subject=(\'Bar\',),\n-                                description=\'Baz\',\n-                                contributors=(\'Fred\',),\n-                                effective_date=\'2001-01-01\',\n-                                expiration_date=\'2003-01-01\',\n-                                format=\'text/html\',\n-                                language=\'de\',\n-                                rights=\'Copyleft\',\n-                                )\n+        self.utils.editMetadata(\n+            self.doc,\n+            title="Foo",\n+            subject=("Bar",),\n+            description="Baz",\n+            contributors=("Fred",),\n+            effective_date="2001-01-01",\n+            expiration_date="2003-01-01",\n+            format="text/html",\n+            language="de",\n+            rights="Copyleft",\n+        )\n \n     def testEditTitleOnly(self):\n-        self.utils.editMetadata(self.doc, title=\'Oh Happy Day\')\n-        self.assertEqual(self.doc.Title(), \'Oh Happy Day\')\n+        self.utils.editMetadata(self.doc, title="Oh Happy Day")\n+        self.assertEqual(self.doc.Title(), "Oh Happy Day")\n         # Other elements must not change\n-        self.assertEqual(self.doc.Subject(), (\'Bar\',))\n-        self.assertEqual(self.doc.Description(), \'Baz\')\n-        self.assertEqual(self.doc.Contributors(), (\'Fred\',))\n-        self.assertTrue(self.doc.effective_date.ISO8601()\n-                            .startswith(\'2001-01-01T00:00:00\'))\n-        self.assertTrue(self.doc.expiration_date.ISO8601()\n-                            .startswith(\'2003-01-01T00:00:00\'))\n-        self.assertEqual(self.doc.Format(), \'text/html\')\n-        self.assertEqual(self.doc.Language(), \'de\')\n-        self.assertEqual(self.doc.Rights(), \'Copyleft\')\n+        self.assertEqual(self.doc.Subject(), ("Bar",))\n+        self.assertEqual(self.doc.Description(), "Baz")\n+        self.assertEqual(self.doc.Contributors(), ("Fred",))\n+        self.assertTrue(\n+            self.doc.effective_date.ISO8601().startswith("2001-01-01T00:00:00")\n+        )\n+        self.assertTrue(\n+            self.doc.expiration_date.ISO8601().startswith("2003-01-01T00:00:00")\n+        )\n+        self.assertEqual(self.doc.Format(), "text/html")\n+        self.assertEqual(self.doc.Language(), "de")\n+        self.assertEqual(self.doc.Rights(), "Copyleft")\n \n     def testEditSubjectOnly(self):\n-        self.utils.editMetadata(self.doc, subject=(\'Oh\', \'Happy\', \'Day\'))\n-        self.assertEqual(self.doc.Subject(), (\'Oh\', \'Happy\', \'Day\'))\n+        self.utils.editMetadata(self.doc, subject=("Oh", "Happy", "Day"))\n+        self.assertEqual(self.doc.Subject(), ("Oh", "Happy", "Day"))\n         # Other elements must not change\n-        self.assertEqual(self.doc.Title(), \'Foo\')\n-        self.assertEqual(self.doc.Description(), \'Baz\')\n-        self.assertEqual(self.doc.Contributors(), (\'Fred\',))\n-        self.assertTrue(self.doc.effective_date.ISO8601()\n-                            .startswith(\'2001-01-01T00:00:00\'))\n-        self.assertTrue(self.doc.expiration_date.ISO8601()\n-                            .startswith(\'2003-01-01T00:00:00\'))\n-        self.assertEqual(self.doc.Format(), \'text/html\')\n-        self.assertEqual(self.doc.Language(), \'de\')\n-        self.assertEqual(self.doc.Rights(), \'Copyleft\')\n+        self.assertEqual(self.doc.Title(), "Foo")\n+        self.assertEqual(self.doc.Description(), "Baz")\n+        self.assertEqual(self.doc.Contributors(), ("Fred",))\n+        self.assertTrue(\n+            self.doc.effective_date.ISO8601().startswith("2001-01-01T00:00:00")\n+        )\n+        self.assertTrue(\n+            self.doc.expiration_date.ISO8601().startswith("2003-01-01T00:00:00")\n+        )\n+        self.assertEqual(self.doc.Format(), "text/html")\n+        self.assertEqual(self.doc.Language(), "de")\n+        self.assertEqual(self.doc.Rights(), "Copyleft")\n \n     def testEditEffectiveDateOnly(self):\n-        self.utils.editMetadata(self.doc, effective_date=\'2001-12-31\')\n-        self.assertTrue(self.doc.effective_date.ISO8601()\n-                            .startswith(\'2001-12-31T00:00:00\'))\n+        self.utils.editMetadata(self.doc, effective_date="2001-12-31")\n+        self.assertTrue(\n+            self.doc.effective_date.ISO8601().startswith("2001-12-31T00:00:00")\n+        )\n         # Other elements must not change\n-        self.assertEqual(self.doc.Title(), \'Foo\')\n-        self.assertEqual(self.doc.Subject(), (\'Bar\',))\n-        self.assertEqual(self.doc.Description(), \'Baz\')\n-        self.assertEqual(self.doc.Contributors(), (\'Fred\',))\n-        self.assertTrue(self.doc.expiration_date.ISO8601()\n-                            .startswith(\'2003-01-01T00:00:00\'))\n-        self.assertEqual(self.doc.Format(), \'text/html\')\n-        self.assertEqual(self.doc.Language(), \'de\')\n-        self.assertEqual(self.doc.Rights(), \'Copyleft\')\n+        self.assertEqual(self.doc.Title(), "Foo")\n+        self.assertEqual(self.doc.Subject(), ("Bar",))\n+        self.assertEqual(self.doc.Description(), "Baz")\n+        self.assertEqual(self.doc.Contributors(), ("Fred",))\n+        self.assertTrue(\n+            self.doc.expiration_date.ISO8601().startswith("2003-01-01T00:00:00")\n+        )\n+        self.assertEqual(self.doc.Format(), "text/html")\n+        self.assertEqual(self.doc.Language(), "de")\n+        self.assertEqual(self.doc.Rights(), "Copyleft")\n \n     def testEditLanguageOnly(self):\n-        self.utils.editMetadata(self.doc, language=\'fr\')\n-        self.assertEqual(self.doc.Language(), \'fr\')\n+        self.utils.editMetadata(self.doc, language="fr")\n+        self.assertEqual(self.doc.Language(), "fr")\n         # Other elements must not change\n-        self.assertEqual(self.doc.Title(), \'Foo\')\n-        self.assertEqual(self.doc.Subject(), (\'Bar\',))\n-        self.assertEqual(self.doc.Description(), \'Baz\')\n-        self.assertEqual(self.doc.Contributors(), (\'Fred\',))\n-        self.assertTrue(self.doc.effective_date.ISO8601()\n-                            .startswith(\'2001-01-01T00:00:00\'))\n-        self.assertTrue(self.doc.expiration_date.ISO8601()\n-                            .startswith(\'2003-01-01T00:00:00\'))\n-        self.assertEqual(self.doc.Format(), \'text/html\')\n-        self.assertEqual(self.doc.Rights(), \'Copyleft\')\n+        self.assertEqual(self.doc.Title(), "Foo")\n+        self.assertEqual(self.doc.Subject(), ("Bar",))\n+        self.assertEqual(self.doc.Description(), "Baz")\n+        self.assertEqual(self.doc.Contributors(), ("Fred",))\n+        self.assertTrue(\n+            self.doc.effective_date.ISO8601().startswith("2001-01-01T00:00:00")\n+        )\n+        self.assertTrue(\n+            self.doc.expiration_date.ISO8601().startswith("2003-01-01T00:00:00")\n+        )\n+        self.assertEqual(self.doc.Format(), "text/html")\n+        self.assertEqual(self.doc.Rights(), "Copyleft")\n \n \n class TestBreadCrumbs(PloneTestCase.PloneTestCase):\n-    \'\'\'Tests for the portal tabs query\'\'\'\n+    """Tests for the portal tabs query"""\n \n     def afterSetUp(self):\n         self.utils = self.portal.plone_utils\n         self.populateSite()\n \n     def populateSite(self):\n-        self.setRoles([\'Manager\'])\n-        self.portal.invokeFactory(\'Folder\', \'folder1\')\n-        folder1 = getattr(self.portal, \'folder1\')\n-        folder1.invokeFactory(\'Document\', \'doc11\')\n-        folder1.invokeFactory(\'File\', \'file11\')\n-        self.setRoles([\'Member\'])\n+        self.setRoles(["Manager"])\n+        self.portal.invokeFactory("Folder", "folder1")\n+        folder1 = getattr(self.portal, "folder1")\n+        folder1.invokeFactory("Document", "doc11")\n+        folder1.invokeFactory("File", "file11")\n+        self.setRoles(["Member"])\n \n     def testCreateBreadCrumbs(self):\n         # See if we can create one at all\n@@ -532,9 +534,8 @@ def testCreateBreadCrumbs(self):\n         crumbs = self.utils.createBreadCrumbs(doc)\n         self.assertTrue(crumbs)\n         self.assertEqual(len(crumbs), 2)\n-        self.assertEqual(crumbs[-1][\'absolute_url\'], doc.absolute_url())\n-        self.assertEqual(crumbs[-2][\'absolute_url\'],\n-                         doc.aq_parent.absolute_url())\n+        self.assertEqual(crumbs[-1]["absolute_url"], doc.absolute_url())\n+        self.assertEqual(crumbs[-2]["absolute_url"], doc.aq_parent.absolute_url())\n \n     def testBreadcrumbsRespectTypesWithViewAction(self):\n         # With a type in types_use_view_action_in_listings as current action it\n@@ -542,75 +543,71 @@ def testBreadcrumbsRespectTypesWithViewAction(self):\n         file = self.portal.folder1.file11\n         crumbs = self.utils.createBreadCrumbs(file)\n         self.assertTrue(crumbs)\n-        self.assertEqual(crumbs[-1][\'absolute_url\'][-5:], \'/view\')\n+        self.assertEqual(crumbs[-1]["absolute_url"][-5:], "/view")\n \n \n class TestIDGenerationMethods(PloneTestCase.PloneTestCase):\n-    """Tests the isIDAutoGenerated method and pretty_title_or_id\n-    """\n+    """Tests the isIDAutoGenerated method and pretty_title_or_id"""\n \n     def afterSetUp(self):\n         self.utils = self.portal.plone_utils\n \n     def test_pretty_title_or_id_returns_title(self):\n-        self.folder.setTitle(\'My pretty title\')\n-        self.assertEqual(self.utils.pretty_title_or_id(self.folder),\n-                         \'My pretty title\')\n+        self.folder.setTitle("My pretty title")\n+        self.assertEqual(self.utils.pretty_title_or_id(self.folder), "My pretty title")\n \n     def test_pretty_title_or_id_returns_id(self):\n-        self.folder.setTitle(\'\')\n-        self.assertEqual(self.utils.pretty_title_or_id(self.folder),\n-                         self.folder.getId())\n+        self.folder.setTitle("")\n+        self.assertEqual(\n+            self.utils.pretty_title_or_id(self.folder), self.folder.getId()\n+        )\n \n     def test_pretty_title_or_id_works_with_method_that_needs_context(self):\n-        self.setRoles([\'Manager\', \'Member\'])\n+        self.setRoles(["Manager", "Member"])\n         # Create a dummy class that looks at it\'s context to find the title\n         new_obj = DummyTitle()\n         new_obj = new_obj.__of__(self.folder)\n         try:\n             title = self.utils.pretty_title_or_id(new_obj)\n         except AttributeError as e:\n-            self.fail(\'pretty_title_or_id failed to include context %s\' % e)\n-        self.assertEqual(title, \'portal_catalog\')\n+            self.fail("pretty_title_or_id failed to include context %s" % e)\n+        self.assertEqual(title, "portal_catalog")\n \n     def test_pretty_title_or_id_on_catalog_brain(self):\n         cat = self.portal.portal_catalog\n-        self.setRoles([\'Manager\', \'Member\'])\n-        self.folder.title = \'My pretty title\'\n-        self.folder.subject = (\'foobar\',)\n+        self.setRoles(["Manager", "Member"])\n+        self.folder.title = "My pretty title"\n+        self.folder.subject = ("foobar",)\n         self.folder.reindexObject()\n-        results = cat(Subject=\'foobar\')\n+        results = cat(Subject="foobar")\n         self.assertEqual(len(results), 1)\n-        self.assertEqual(self.utils.pretty_title_or_id(results[0]),\n-                         \'My pretty title\')\n+        self.assertEqual(self.utils.pretty_title_or_id(results[0]), "My pretty title")\n \n     def test_pretty_title_or_id_on_catalog_brain_returns_id(self):\n         cat = self.portal.portal_catalog\n-        self.setRoles([\'Manager\', \'Member\'])\n-        self.folder.title = \'\'\n-        self.folder.subject = (\'foobar\',)\n+        self.setRoles(["Manager", "Member"])\n+        self.folder.title = ""\n+        self.folder.subject = ("foobar",)\n         self.folder.reindexObject()\n-        results = cat(Subject=\'foobar\')\n+        results = cat(Subject="foobar")\n         self.assertEqual(len(results), 1)\n-        self.assertEqual(self.utils.pretty_title_or_id(results[0]),\n-                         self.folder.getId())\n+        self.assertEqual(self.utils.pretty_title_or_id(results[0]), self.folder.getId())\n \n     def test_pretty_title_or_id_on_catalog_brain_no_title(self):\n         cat = self.portal.portal_catalog\n-        self.setRoles([\'Manager\', \'Member\'])\n+        self.setRoles(["Manager", "Member"])\n         # Remove Title from catalog metadata to simulate a catalog with no\n         # Title metadata and similar pathological cases.\n-        cat.delColumn(\'Title\')\n-        self.folder.title = \'\'\n-        self.folder.subject = (\'foobar\',)\n+        cat.delColumn("Title")\n+        self.folder.title = ""\n+        self.folder.subject = ("foobar",)\n         self.folder.reindexObject()\n-        results = cat(Subject=\'foobar\')\n+        results = cat(Subject="foobar")\n         self.assertEqual(len(results), 1)\n         # Give the portal a title because this is what will show up on\n         # failure\n-        self.portal.title = \'This is not the title you are looking for\'\n-        self.assertEqual(self.utils.pretty_title_or_id(results[0]),\n-                         self.folder.getId())\n+        self.portal.title = "This is not the title you are looking for"\n+        self.assertEqual(self.utils.pretty_title_or_id(results[0]), self.folder.getId())\n \n     def testGetMethodAliases(self):\n         fti = self.folder.getTypeInfo()\ndiff --git a/Products/CMFPlone/tests/testPloneView.py b/Products/CMFPlone/tests/testPloneView.py\nindex 5efdcc84bd..f80af2e4b4 100644\n--- a/Products/CMFPlone/tests/testPloneView.py\n+++ b/Products/CMFPlone/tests/testPloneView.py\n@@ -2,6 +2,8 @@\n from Products.CMFPlone.tests import dummy\n from Products.CMFPlone.tests import PloneTestCase\n \n+import warnings\n+\n \n class TestPloneView(PloneTestCase.PloneTestCase):\n \n@@ -27,111 +29,131 @@ def testToLocalizedSize(self):\n         self.assertEqual(value, \'3 KB\')\n \n     def testIsStructuralFolderWithNonFolder(self):\n-        i = dummy.Item()\n-        self.assertFalse(Plone(i, self.app.REQUEST).isStructuralFolder())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            i = dummy.Item()\n+            self.assertFalse(Plone(i, self.app.REQUEST).isStructuralFolder())\n \n     def testIsStructuralFolderWithFolder(self):\n-        f = dummy.Folder(\'struct_folder\')\n-        self.assertTrue(Plone(f, self.app.REQUEST).isStructuralFolder())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            f = dummy.Folder(\'struct_folder\')\n+            self.assertTrue(Plone(f, self.app.REQUEST).isStructuralFolder())\n \n     def testIsStructuralFolderWithNonStructuralFolder(self):\n-        f = dummy.NonStructuralFolder(\'ns_folder\')\n-        self.assertFalse(Plone(f, self.app.REQUEST).isStructuralFolder())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            f = dummy.NonStructuralFolder(\'ns_folder\')\n+            self.assertFalse(Plone(f, self.app.REQUEST).isStructuralFolder())\n \n     def testIsDefaultPageInFolder(self):\n-        view = Plone(self.folder.test, self.app.REQUEST)\n-        self.assertFalse(view.isDefaultPageInFolder())\n-        self.assertTrue(self.folder.canSetDefaultPage())\n-        self.folder.setDefaultPage(\'test\')\n-        # re-create the view, because the old value is cached\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.test, self.app.REQUEST)\n-        self.assertTrue(view.isDefaultPageInFolder())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            view = Plone(self.folder.test, self.app.REQUEST)\n+            self.assertFalse(view.isDefaultPageInFolder())\n+            self.assertTrue(self.folder.canSetDefaultPage())\n+            self.folder.setDefaultPage(\'test\')\n+            # re-create the view, because the old value is cached\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.test, self.app.REQUEST)\n+            self.assertTrue(view.isDefaultPageInFolder())\n \n     def testNavigationRootPath(self):\n-        view = Plone(self.folder, self.app.REQUEST)\n-        self.assertEqual(view.navigationRootPath(),\n-                         self.portal.portal_url.getPortalPath())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            view = Plone(self.folder, self.app.REQUEST)\n+            self.assertEqual(view.navigationRootPath(),\n+                            self.portal.portal_url.getPortalPath())\n \n     def testNavigationRootUrl(self):\n-        view = Plone(self.folder, self.app.REQUEST)\n-        self.assertEqual(view.navigationRootUrl(), self.portal.absolute_url())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            view = Plone(self.folder, self.app.REQUEST)\n+            self.assertEqual(view.navigationRootUrl(), self.portal.absolute_url())\n \n     def testGetParentObject(self):\n-        view = Plone(self.folder.test, self.app.REQUEST)\n-        self.assertEqual(view.getParentObject(), self.folder)\n-        # Make sure this looks only at containment\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.test.__of__(self.portal), self.app.REQUEST)\n-        self.assertEqual(view.getParentObject(), self.folder)\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            view = Plone(self.folder.test, self.app.REQUEST)\n+            self.assertEqual(view.getParentObject(), self.folder)\n+            # Make sure this looks only at containment\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.test.__of__(self.portal), self.app.REQUEST)\n+            self.assertEqual(view.getParentObject(), self.folder)\n \n     def testIsFolderOrFolderDefaultPage(self):\n-        # an actual folder whould return true\n-        view = Plone(self.folder, self.app.REQUEST)\n-        self.assertTrue(view.isFolderOrFolderDefaultPage())\n-        # But not a document\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.test, self.app.REQUEST)\n-        self.assertFalse(view.isFolderOrFolderDefaultPage())\n-        # Unless we make it the default view\n-        self.folder.setDefaultPage(\'test\')\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.test, self.app.REQUEST)\n-        self.assertTrue(view.isFolderOrFolderDefaultPage())\n-        # And if we have a non-structural folder it should not be true\n-        f = dummy.NonStructuralFolder(\'ns_folder\')\n-        self.folder._setObject(\'ns_folder\', f)\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.ns_folder, self.app.REQUEST)\n-        self.assertFalse(view.isFolderOrFolderDefaultPage())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            # an actual folder whould return true\n+            view = Plone(self.folder, self.app.REQUEST)\n+            self.assertTrue(view.isFolderOrFolderDefaultPage())\n+            # But not a document\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.test, self.app.REQUEST)\n+            self.assertFalse(view.isFolderOrFolderDefaultPage())\n+            # Unless we make it the default view\n+            self.folder.setDefaultPage(\'test\')\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.test, self.app.REQUEST)\n+            self.assertTrue(view.isFolderOrFolderDefaultPage())\n+            # And if we have a non-structural folder it should not be true\n+            f = dummy.NonStructuralFolder(\'ns_folder\')\n+            self.folder._setObject(\'ns_folder\', f)\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.ns_folder, self.app.REQUEST)\n+            self.assertFalse(view.isFolderOrFolderDefaultPage())\n \n     def testIsPortalOrPortalDefaultPage(self):\n-        # an actual folder whould return true\n-        view = Plone(self.portal, self.app.REQUEST)\n-        self.assertTrue(view.isPortalOrPortalDefaultPage())\n-        # But not a document\n-        self.setRoles([\'Manager\'])\n-        self.portal.invokeFactory(\'Document\', \'portal_test\',\n-                                  title=\'Test default page\')\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.portal.portal_test, self.app.REQUEST)\n-        self.assertFalse(view.isPortalOrPortalDefaultPage())\n-        # Unless we make it the default view\n-        self.portal.setDefaultPage(\'portal_test\')\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.portal.portal_test, self.app.REQUEST)\n-        self.assertTrue(view.isPortalOrPortalDefaultPage())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            # an actual folder whould return true\n+            view = Plone(self.portal, self.app.REQUEST)\n+            self.assertTrue(view.isPortalOrPortalDefaultPage())\n+            # But not a document\n+            self.setRoles([\'Manager\'])\n+            self.portal.invokeFactory(\'Document\', \'portal_test\',\n+                                    title=\'Test default page\')\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.portal.portal_test, self.app.REQUEST)\n+            self.assertFalse(view.isPortalOrPortalDefaultPage())\n+            # Unless we make it the default view\n+            self.portal.setDefaultPage(\'portal_test\')\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.portal.portal_test, self.app.REQUEST)\n+            self.assertTrue(view.isPortalOrPortalDefaultPage())\n \n     def testGetCurrentFolder(self):\n-        # If context is a folder, then the folder is returned\n-        view = Plone(self.folder, self.app.REQUEST)\n-        self.assertEqual(view.getCurrentFolder(), self.folder)\n-\n-        # If context is not a folder, then the parent is returned\n-        # A bit crude ... we need to make sure our memos don\'t stick in the\n-        # tests\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.test, self.app.REQUEST)\n-        self.assertEqual(view.getCurrentFolder(), self.folder)\n-\n-        # The real container is returned regardless of context\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.test.__of__(self.portal), self.app.REQUEST)\n-        self.assertEqual(view.getCurrentFolder(), self.folder)\n-\n-        # A non-structural folder does not count as a folder`\n-        f = dummy.NonStructuralFolder(\'ns_folder\')\n-        self.folder._setObject(\'ns_folder\', f)\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.ns_folder, self.app.REQUEST)\n-        self.assertEqual(view.getCurrentFolder(), self.folder)\n-\n-        # And even a structural folder that is used as a default page\n-        # returns its parent\n-        self.folder.setDefaultPage(\'ns_folder\')\n-        self._invalidateRequestMemoizations()\n-        view = Plone(self.folder.ns_folder, self.app.REQUEST)\n-        self.assertEqual(view.getCurrentFolder(), self.folder)\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            # If context is a folder, then the folder is returned\n+            view = Plone(self.folder, self.app.REQUEST)\n+            self.assertEqual(view.getCurrentFolder(), self.folder)\n+\n+            # If context is not a folder, then the parent is returned\n+            # A bit crude ... we need to make sure our memos don\'t stick in the\n+            # tests\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.test, self.app.REQUEST)\n+            self.assertEqual(view.getCurrentFolder(), self.folder)\n+\n+            # The real container is returned regardless of context\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.test.__of__(self.portal), self.app.REQUEST)\n+            self.assertEqual(view.getCurrentFolder(), self.folder)\n+\n+            # A non-structural folder does not count as a folder`\n+            f = dummy.NonStructuralFolder(\'ns_folder\')\n+            self.folder._setObject(\'ns_folder\', f)\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.ns_folder, self.app.REQUEST)\n+            self.assertEqual(view.getCurrentFolder(), self.folder)\n+\n+            # And even a structural folder that is used as a default page\n+            # returns its parent\n+            self.folder.setDefaultPage(\'ns_folder\')\n+            self._invalidateRequestMemoizations()\n+            view = Plone(self.folder.ns_folder, self.app.REQUEST)\n+            self.assertEqual(view.getCurrentFolder(), self.folder)\n \n     def testCropText(self):\n         view = Plone(self.portal, self.app.REQUEST)\n@@ -149,10 +171,12 @@ def testCropText(self):\n         self.assertEqual(view.cropText(text, 5), b\'Koko\\xc5\\x99...\')\n \n     def testSiteEncoding(self):\n-        view = Plone(self.portal, self.app.REQUEST)\n-        self.assertEqual(\'utf-8\', view.site_encoding())\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            view = Plone(self.portal, self.app.REQUEST)\n+            self.assertEqual(\'utf-8\', view.site_encoding())\n \n     def test_human_readable_size(self):\n         view = Plone(self.portal, self.app.REQUEST)\n-        from Products.CMFPlone.utils import human_readable_size\n+        from plone.base.utils import human_readable_size\n         self.assertIs(view.human_readable_size, human_readable_size)\ndiff --git a/Products/CMFPlone/tests/testPortalCreation.py b/Products/CMFPlone/tests/testPortalCreation.py\nindex 08498041e6..0fc4b4aa12 100644\n--- a/Products/CMFPlone/tests/testPortalCreation.py\n+++ b/Products/CMFPlone/tests/testPortalCreation.py\n@@ -681,7 +681,7 @@ def testHomeActionUsesView(self):\n         homeAction = [x for x in actions if x.id == \'index_html\'][0]\n         self.assertEqual(\n             homeAction.getInfoData()[0][\'url\'].text,\n-            \'string:${globals_view/navigationRootUrl}\',\n+            \'python:plone_portal_state.navigation_root_url()\',\n         )\n \n     def testPloneLexicon(self):\ndiff --git a/Products/CMFPlone/tests/test_PloneTool.py b/Products/CMFPlone/tests/test_PloneTool.py\nindex c28a337cbf..405ce35460 100644\n--- a/Products/CMFPlone/tests/test_PloneTool.py\n+++ b/Products/CMFPlone/tests/test_PloneTool.py\n@@ -7,6 +7,7 @@\n from Products.statusmessages.interfaces import IStatusMessage\n \n import unittest\n+import warnings\n \n \n class TestPloneTool(unittest.TestCase):\n@@ -20,10 +21,12 @@ def setUp(self):\n         self.tool = getToolByName(self.portal, \'plone_utils\', None)\n \n     def test_getSiteEncoding(self):\n-        self.assertEqual(\n-            self.tool.getSiteEncoding(),\n-            \'utf-8\'\n-        )\n+        with warnings.catch_warnings():\n+            warnings.filterwarnings("ignore", category=DeprecationWarning)\n+            self.assertEqual(\n+                self.tool.getSiteEncoding(),\n+                \'utf-8\'\n+            )\n \n     def test_getMailHost(self):\n         self.assertTrue(\ndiff --git a/Products/CMFPlone/traversal.py b/Products/CMFPlone/traversal.py\nindex 8b56473dc4..cc19aac322 100644\n--- a/Products/CMFPlone/traversal.py\n+++ b/Products/CMFPlone/traversal.py\n@@ -1,40 +1,33 @@\n-from plone.resource.traversal import ResourceTraverser\n-from zope.component import queryUtility\n+from plone.base.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME\n from plone.resource.interfaces import IResourceDirectory\n from plone.resource.interfaces import IUniqueResourceRequest\n-from plone.base.interfaces.resources import (\n-    OVERRIDE_RESOURCE_DIRECTORY_NAME)\n+from plone.resource.traversal import ResourceTraverser\n from Products.PageTemplates.Expressions import getEngine\n from Products.PageTemplates.Expressions import getTrustedEngine\n+from Products.PageTemplates.interfaces import IZopeAwareEngine\n+from zope.component import queryUtility\n from zope.globalrequest import getRequest\n from zope.interface import implementer\n from zope.interface import Interface\n from zope.pagetemplate import engine as zpt_engine\n \n \n-try:\n-    # This was introduced in Zope 4.5.\n-    # We try not to make this a hard dependency yet.\n-    from Products.PageTemplates.interfaces import IZopeAwareEngine\n-except ImportError:\n-    # Zope 4.4-\n-    class IZopeAwareEngine(Interface):\n-        pass\n-\n-\n class PloneBundlesTraverser(ResourceTraverser):\n+    # the name is missleading - it is used not only for bundles.\n+    # in fact in Plone 6 bundles are no longer used, despite that the traverser\n+    # might be in use for other use cases.\n \n-    name = \'plone\'\n+    name = "plone"\n \n     def traverse(self, name, remaining):\n         # in case its not a request get the default one\n         req = getRequest()\n-        if not req or \'PATH_INFO\' not in req.environ:\n+        if not req or "PATH_INFO" not in req.environ:\n             return super().traverse(name, remaining)\n \n-        resource_path = req.environ[\'PATH_INFO\'].split(\'++plone++\')[-1]\n+        resource_path = req.environ["PATH_INFO"].split("++plone++")[-1]\n         try:\n-            resource_name, resource_filepath = resource_path.split(\'/\', 1)\n+            resource_name, resource_filepath = resource_path.split("/", 1)\n         except ValueError:\n             # Not the path info / url that we expected.\n             # So the request is not for a resource,\n@@ -44,15 +37,15 @@ def traverse(self, name, remaining):\n \n         # If we have additional traversers in the path we should not use them\n         # in the file lookup\n-        more_traversal = (resource_filepath.startswith(\'++\') or\n-                          resource_filepath.startswith(\'@@\'))\n-        if more_traversal:\n-            resource_filepath = resource_filepath.split(\'/\')[-1]\n+        if resource_filepath.startswith("++") or resource_filepath.startswith("@@"):\n+            resource_filepath = resource_filepath.split("/")[-1]\n \n         persistentDirectory = queryUtility(IResourceDirectory, name="persistent")\n         directory = None\n-        if (persistentDirectory is not None and\n-                OVERRIDE_RESOURCE_DIRECTORY_NAME in persistentDirectory):\n+        if (\n+            persistentDirectory is not None\n+            and OVERRIDE_RESOURCE_DIRECTORY_NAME in persistentDirectory\n+        ):\n             container = persistentDirectory[OVERRIDE_RESOURCE_DIRECTORY_NAME]\n             if resource_name in container:\n                 directory = container[resource_name]\ndiff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py\nindex 7f6c0a1af6..6a2da74b8e 100644\n--- a/Products/CMFPlone/utils.py\n+++ b/Products/CMFPlone/utils.py\n@@ -19,6 +19,8 @@\n from os.path import split\n from plone.base import PloneMessageFactory as _\n from plone.base import utils as base_utils\n+from plone.base.interfaces.controlpanel import IImagingSchema\n+from plone.base.interfaces.siteroot import IPloneSiteRoot\n from plone.i18n.normalizer.interfaces import IIDNormalizer\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.permissions import AddPortalContent\n@@ -26,11 +28,9 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFCore.utils import ToolInit as CMFCoreToolInit\n from Products.CMFPlone import bbb\n-from plone.base.interfaces.controlpanel import IImagingSchema\n-from plone.base.interfaces.siteroot import IPloneSiteRoot\n from Products.CMFPlone.log import log  # noqa - for python scripts\n-from Products.CMFPlone.log import log_exc  # noqa - for python scripts\n from Products.CMFPlone.log import log_deprecated  # noqa - for python scripts\n+from Products.CMFPlone.log import log_exc  # noqa - for python scripts\n from ZODB.POSException import ConflictError\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n@@ -62,13 +62,26 @@\n \n deprecated_import(\n     "Import from plone.base.utils instead (will be removed in Plone 7)",\n+    base_hasattr=\'plone.base.utils:base_hasattr\',\n+    getEmptyTitle=\'plone.base.utils:get_empty_title\',\n     human_readable_size=\'plone.base.utils:human_readable_size\',\n-    safeToInt=\'plone.base.utils:safeToInt\',\n+    safeToInt=\'plone.base.utils:safe_int\',\n     safe_bytes=\'plone.base.utils:safe_bytes\',\n+    safe_callable=\'plone.base.utils:safe_callable\',\n+    safe_hasattr=\'plone.base.utils:safe_hasattr\',\n     safe_text=\'plone.base.utils:safe_text\',\n     get_installer=\'plone.base.utils:get_installer\',\n     get_top_request=\'plone.base.utils:get_top_request\',\n     get_top_site_from_url=\'plone.base.utils:get_top_site_from_url\',\n+    pretty_title_or_id=\'plone.base.utils:pretty_title_or_id\',\n+    _createObjectByType=\'plone.base.utils:unrestricted_construct_instance\',\n+)\n+\n+deprecated_import(\n+    "Import from plone.namedfile.utils instead (will be removed in Plone 7)",\n+    getHighPixelDensityScales="plone.namedfile.utils.getHighPixelDensityScales",\n+    getAllowedSizes="plone.namedfile.utils.getAllowedSizes",\n+    getQuality="plone.namedfile.utils.getQuality",\n )\n \n @deprecate("Use plone.base.utils.safe_bytes instead (will be removed in Plone 7)")\n@@ -162,7 +175,7 @@ def isExpired(content):\n         expiry = content.expires\n \n     # See if we have a callable\n-    if safe_callable(expiry):\n+    if base_utils.safe_callable(expiry):\n         expiry = expiry()\n \n     # Convert to DateTime if necessary, ExpirationDate may return \'None\'\n@@ -174,44 +187,6 @@ def isExpired(content):\n     return 0\n \n \n-def pretty_title_or_id(context, obj, empty_value=_marker):\n-    """Return the best possible title or id of an item, regardless\n-       of whether obj is a catalog brain or an object, but returning an\n-       empty title marker if the id is not set (i.e. it\'s auto-generated).\n-    """\n-    # if safe_hasattr(obj, \'aq_explicit\'):\n-    #    obj = obj.aq_explicit\n-    # title = getattr(obj, \'Title\', None)\n-    title = None\n-    if base_hasattr(obj, \'Title\'):\n-        title = getattr(obj, \'Title\', None)\n-    if safe_callable(title):\n-        title = title()\n-    if title:\n-        return title\n-    item_id = getattr(obj, \'getId\', None)\n-    if safe_callable(item_id):\n-        item_id = item_id()\n-    if item_id:\n-        return item_id\n-    if empty_value is _marker:\n-        empty_value = getEmptyTitle(context)\n-    return empty_value\n-\n-\n-def getEmptyTitle(context, translated=True):\n-    """Returns string to be used for objects with no title or id"""\n-    # The default is an extra fancy unicode elipsis\n-    empty = b\'\\x5b\\xc2\\xb7\\xc2\\xb7\\xc2\\xb7\\x5d\'.decode(\'utf8\')\n-    if translated:\n-        if context is not None:\n-            if not IBrowserRequest.providedBy(context):\n-                context = aq_get(context, \'REQUEST\', None)\n-        empty = translate(\'title_unset\', domain=\'plone\',\n-                          context=context, default=empty)\n-    return empty\n-\n-\n def typesToList(context):\n     registry = getUtility(IRegistry)\n     return registry.get(\'plone.displayed_types\', ())\n@@ -297,26 +272,6 @@ def initialize(self, context):\n                     getattr(misc, pid)[name] = icon\n \n \n-def _createObjectByType(type_name, container, id, *args, **kw):\n-    """Create an object without performing security checks\n-\n-    invokeFactory and fti.constructInstance perform some security checks\n-    before creating the object. Use this function instead if you need to\n-    skip these checks.\n-\n-    This method uses\n-    CMFCore.TypesTool.FactoryTypeInformation._constructInstance\n-    to create the object without security checks.\n-    """\n-    id = str(id)\n-    typesTool = getToolByName(container, \'portal_types\')\n-    fti = typesTool.getTypeInfo(type_name)\n-    if not fti:\n-        raise ValueError(\'Invalid type %s\' % type_name)\n-\n-    return fti._constructInstance(container, id, *args, **kw)\n-\n-\n release_levels = (\'alpha\', \'beta\', \'candidate\', \'final\')\n rl_abbr = {\'a\': \'alpha\', \'b\': \'beta\', \'rc\': \'candidate\'}\n \n@@ -371,33 +326,6 @@ def transaction_note(note):\n         T.note(base_utils.safe_text(note))\n \n \n-def base_hasattr(obj, name):\n-    """Like safe_hasattr, but also disables acquisition."""\n-    return safe_hasattr(aq_base(obj), name)\n-\n-\n-def safe_hasattr(obj, name, _marker=object()):\n-    """Make sure we don\'t mask exceptions like hasattr().\n-\n-    We don\'t want exceptions other than AttributeError to be masked,\n-    since that too often masks other programming errors.\n-    Three-argument getattr() doesn\'t mask those, so we use that to\n-    implement our own hasattr() replacement.\n-    """\n-    return getattr(obj, name, _marker) is not _marker\n-\n-\n-def safe_callable(obj):\n-    """Make sure our callable checks are ConflictError safe."""\n-    if safe_hasattr(obj, \'__class__\'):\n-        if safe_hasattr(obj, \'__call__\'):\n-            return True\n-        return isinstance(obj, ClassType)\n-    return callable(obj)\n-\n-\n-\n-\n def tuplize(value):\n     if isinstance(value, tuple):\n         return value\n@@ -564,41 +492,10 @@ def bodyfinder(text):\n     return text[bodystart:bodyend]\n \n \n-def getAllowedSizes():\n-    registry = queryUtility(IRegistry)\n-    if not registry:\n-        return None\n-    settings = registry.forInterface(\n-        IImagingSchema, prefix="plone", check=False)\n-    if not settings.allowed_sizes:\n-        return None\n-    sizes = {}\n-    for line in settings.allowed_sizes:\n-        line = line.strip()\n-        if line:\n-            name, width, height = pattern.match(line).groups()\n-            name = name.strip().replace(\' \', \'_\')\n-            sizes[name] = int(width), int(height)\n-    return sizes\n-\n-\n-def getQuality():\n-    registry = queryUtility(IRegistry)\n-    if registry:\n-        settings = registry.forInterface(\n-            IImagingSchema, prefix="plone", check=False)\n-        return settings.quality or QUALITY_DEFAULT\n-    return QUALITY_DEFAULT\n-\n-\n-def getHighPixelDensityScales():\n-    from plone.namedfile.utils import getHighPixelDensityScales as func\n-    return func()\n-\n-\n def getSiteLogo(site=None, include_type=False):\n     from plone.base.interfaces import ISiteSchema\n     from plone.formwidget.namedfile.converter import b64decode_file\n+\n     import mimetypes\n \n     if site is None:\ndiff --git a/news/3601.bugfix b/news/3601.bugfix\nnew file mode 100644\nindex 0000000000..32921649a6\n--- /dev/null\n+++ b/news/3601.bugfix\n@@ -0,0 +1,2 @@\n+Fix visual issue with long action name in @@actions-controlpanel.\n+[petschki]\ndiff --git a/news/3609.bugfix b/news/3609.bugfix\nnew file mode 100644\nindex 0000000000..47ffdc293f\n--- /dev/null\n+++ b/news/3609.bugfix\n@@ -0,0 +1,2 @@\n+In traversal.py remoe a Zope 4 BBB code, add a comment about bundle traverser and apply black.isort on the file.\n+[jensens]\ndiff --git a/news/3610.bugfix b/news/3610.bugfix\nnew file mode 100644\nindex 0000000000..009d99d62a\n--- /dev/null\n+++ b/news/3610.bugfix\n@@ -0,0 +1,2 @@\n+Supress warning of intentional deprecated import for BBB.\n+[jensens]\ndiff --git a/news/3614-2.bugfix b/news/3614-2.bugfix\nnew file mode 100644\nindex 0000000000..6e01b0f8c7\n--- /dev/null\n+++ b/news/3614-2.bugfix\n@@ -0,0 +1,2 @@\n+Moved CSFR patches addressing CMFPlone itself to decorators.\n+[jensens]\ndiff --git a/news/3614.bugfix b/news/3614.bugfix\nnew file mode 100644\nindex 0000000000..c1691ac58c\n--- /dev/null\n+++ b/news/3614.bugfix\n@@ -0,0 +1,7 @@\n+Use plone.base and reduce deprecation warnings.\n+In utils remove functions already moved to plone.base and add deferred import with message.\n+Deprecate correct, where prior only comments or old logging.\n+Some black/isort where touched.\n+[jensens]\n+\n+\ndiff --git a/news/3615.bugfix b/news/3615.bugfix\nnew file mode 100644\nindex 0000000000..45df6ff908\n--- /dev/null\n+++ b/news/3615.bugfix\n@@ -0,0 +1,3 @@\n+Move utils.getQuality and utils.getAllowedSizes to plone.namedfile.utils.\n+This helps untangling circular dependencies.\n+[jensens]\ndiff --git a/news/3616.bugfix b/news/3616.bugfix\nnew file mode 100644\nindex 0000000000..178ec178c5\n--- /dev/null\n+++ b/news/3616.bugfix\n@@ -0,0 +1,3 @@\n+Do not use deprecated calls in actions expressions.\n+ActionsTool and PloneBasetool got an code style overhaul.\n+[jensens]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-03-12T16:50:50+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/b3a102680ecd636ba69e91110e9e8b0e0851e94c

Merge branch 'master' into issue_3223

Files changed:
A CHANGES.md
A CONTRIBUTING.md
A Products/CMFPlone/browser/login/utils.py
A Products/CMFPlone/tests/test_redirection.py
A README.md
A docs/changelog_template.jinja
A news/3733.bugfix
A news/6014.bugfix
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/MigrationTool.py
M Products/CMFPlone/PasswordResetTool.py
M Products/CMFPlone/PloneBatch.py
M Products/CMFPlone/PloneControlPanel.py
M Products/CMFPlone/Portal.py
M Products/CMFPlone/PropertiesTool.py
M Products/CMFPlone/TypesTool.py
M Products/CMFPlone/URLTool.py
M Products/CMFPlone/WorkflowTool.py
M Products/CMFPlone/bbb.py
M Products/CMFPlone/browser/admin.py
M Products/CMFPlone/browser/atd.py
M Products/CMFPlone/browser/contact_info.py
M Products/CMFPlone/browser/defaultpage.py
M Products/CMFPlone/browser/favicon.py
M Products/CMFPlone/browser/global_statusmessage.py
M Products/CMFPlone/browser/icons.py
M Products/CMFPlone/browser/interfaces.py
M Products/CMFPlone/browser/login/login.py
M Products/CMFPlone/browser/login/login_help.py
M Products/CMFPlone/browser/login/password_reset.py
M Products/CMFPlone/browser/login/templates/login.pt
M Products/CMFPlone/browser/navtree.py
M Products/CMFPlone/browser/robots.py
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/browser/sendto.py
M Products/CMFPlone/browser/sitemap.py
M Products/CMFPlone/browser/static/plone-admin-ui.css
M Products/CMFPlone/browser/syndication/adapters.py
M Products/CMFPlone/browser/syndication/settings.py
M Products/CMFPlone/browser/syndication/tool.py
M Products/CMFPlone/browser/syndication/utils.py
M Products/CMFPlone/browser/syndication/views.py
M Products/CMFPlone/browser/templates/plone-addsite.pt
M Products/CMFPlone/browser/templates/plone-frontpage.pt
M Products/CMFPlone/browser/templates/plone-overview.pt
M Products/CMFPlone/browser/templates/plone-upgrade.pt
M Products/CMFPlone/browser/templates/search.pt
M Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt
M Products/CMFPlone/browser/test_rendering.py
M Products/CMFPlone/controlpanel/bbb/editing.py
M Products/CMFPlone/controlpanel/bbb/language.py
M Products/CMFPlone/controlpanel/bbb/mail.py
M Products/CMFPlone/controlpanel/bbb/navigation.py
M Products/CMFPlone/controlpanel/bbb/search.py
M Products/CMFPlone/controlpanel/bbb/security.py
M Products/CMFPlone/controlpanel/bbb/site.py
M Products/CMFPlone/controlpanel/bbb/usergroups.py
M Products/CMFPlone/controlpanel/browser/actions.py
M Products/CMFPlone/controlpanel/browser/dateandtime.py
M Products/CMFPlone/controlpanel/browser/editing.py
M Products/CMFPlone/controlpanel/browser/error_log_form.py
M Products/CMFPlone/controlpanel/browser/filter.py
M Products/CMFPlone/controlpanel/browser/imaging.py
M Products/CMFPlone/controlpanel/browser/language.py
M Products/CMFPlone/controlpanel/browser/mail.py
M Products/CMFPlone/controlpanel/browser/maintenance.pt
M Products/CMFPlone/controlpanel/browser/maintenance.py
M Products/CMFPlone/controlpanel/browser/markup.py
M Products/CMFPlone/controlpanel/browser/navigation.py
M Products/CMFPlone/controlpanel/browser/overview.py
M Products/CMFPlone/controlpanel/browser/quickinstaller.py
M Products/CMFPlone/controlpanel/browser/redirects.py
M Products/CMFPlone/controlpanel/browser/relations.py
M Products/CMFPlone/controlpanel/browser/relations_inspect.pt
M Products/CMFPlone/controlpanel/browser/search.py
M Products/CMFPlone/controlpanel/browser/security.py
M Products/CMFPlone/controlpanel/browser/site.py
M Products/CMFPlone/controlpanel/browser/socialmedia.py
M Products/CMFPlone/controlpanel/browser/syndication.py
M Products/CMFPlone/controlpanel/browser/tinymce.py
M Products/CMFPlone/controlpanel/browser/types.py
M Products/CMFPlone/controlpanel/browser/usergroups.py
M Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py
M Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py
M Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt
M Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py
M Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py
M Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_actions.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_language_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_language.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_maintenance.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_syndication.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_doctest.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_installer.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_language.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py
M Products/CMFPlone/controlpanel/tests/test_doctests.py
M Products/CMFPlone/defaultpage.py
M Products/CMFPlone/earlypatches/security.py
M Products/CMFPlone/exportimport/controlpanel.py
M Products/CMFPlone/exportimport/memberdata_properties.py
M Products/CMFPlone/exportimport/propertiestool.py
M Products/CMFPlone/exportimport/tests/base.py
M Products/CMFPlone/exportimport/tests/testControlPanel.py
M Products/CMFPlone/exportimport/tests/testPropertiesTool.py
M Products/CMFPlone/factory.py
M Products/CMFPlone/i18nl10n.py
M Products/CMFPlone/image_scales/adapters.py
M Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py
M Products/CMFPlone/interfaces/__init__.py
M Products/CMFPlone/interfaces/atd.py
M Products/CMFPlone/interfaces/basetool.py
M Products/CMFPlone/interfaces/breadcrumbs.py
M Products/CMFPlone/interfaces/constrains.py
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/interfaces/defaultpage.py
M Products/CMFPlone/interfaces/events.py
M Products/CMFPlone/interfaces/installable.py
M Products/CMFPlone/interfaces/interface.py
M Products/CMFPlone/interfaces/language.py
M Products/CMFPlone/interfaces/login.py
M Products/CMFPlone/interfaces/migration.py
M Products/CMFPlone/interfaces/password_reset.py
M Products/CMFPlone/interfaces/patterns.py
M Products/CMFPlone/interfaces/properties.py
M Products/CMFPlone/interfaces/resources.py
M Products/CMFPlone/interfaces/siteroot.py
M Products/CMFPlone/interfaces/structure.py
M Products/CMFPlone/interfaces/syndication.py
M Products/CMFPlone/interfaces/translationservice.py
M Products/CMFPlone/log.py
M Products/CMFPlone/patches/__init__.py
M Products/CMFPlone/patches/addzmiplonesite.py
M Products/CMFPlone/patches/addzmisecuritywarning.py
M Products/CMFPlone/patches/csrf.py
M Products/CMFPlone/patches/dateIndexPatch.py
M Products/CMFPlone/patches/gtbn.py
M Products/CMFPlone/patches/publishing.py
M Products/CMFPlone/patches/sendmail.py
M Products/CMFPlone/patches/speed.py
M Products/CMFPlone/patches/templatecookcheck.py
M Products/CMFPlone/patches/unicodeFallbackPatch.py
M Products/CMFPlone/patches/unicodehacks.py
M Products/CMFPlone/patterns/__init__.py
M Products/CMFPlone/patterns/settings.py
M Products/CMFPlone/patterns/tinymce.py
M Products/CMFPlone/permissions.py
M Products/CMFPlone/profiles/default/memberdata_properties.xml
M Products/CMFPlone/profiles/default/metadata.xml
M Products/CMFPlone/relationhelper.py
M Products/CMFPlone/resources/browser/resource.py
M Products/CMFPlone/resources/utils.py
M Products/CMFPlone/setuphandlers.py
M Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py
M Products/CMFPlone/skins/plone_scripts/external_edit.py
M Products/CMFPlone/skins/plone_scripts/getFolderContents.py
M Products/CMFPlone/skins/plone_scripts/queryCatalog.py
M Products/CMFPlone/skins/plone_scripts/translate.py
M Products/CMFPlone/skins/plone_scripts/utranslate.py
M Products/CMFPlone/testing.py
M Products/CMFPlone/tests/LoginAndLogout.rst
M Products/CMFPlone/tests/PloneTestCase.py
M Products/CMFPlone/tests/csrf.txt
M Products/CMFPlone/tests/dummy.py
M Products/CMFPlone/tests/emaillogin.rst
M Products/CMFPlone/tests/pwreset_browser.rst
M Products/CMFPlone/tests/robot/robot_setup.py
M Products/CMFPlone/tests/robot/test_overlays.robot
M Products/CMFPlone/tests/robot/variables.py
M Products/CMFPlone/tests/search_form.rst
M Products/CMFPlone/tests/testActionsTool.py
M Products/CMFPlone/tests/testBatch.py
M Products/CMFPlone/tests/testBrowserLayerPrecedence.py
M Products/CMFPlone/tests/testCSRFProtection.py
M Products/CMFPlone/tests/testCatalogTool.py
M Products/CMFPlone/tests/testContentSecurity.py
M Products/CMFPlone/tests/testContentTypeScripts.py
M Products/CMFPlone/tests/testCookieAuth.py
M Products/CMFPlone/tests/testCutPasteSecurity.py
M Products/CMFPlone/tests/testDateIndexRanges.py
M Products/CMFPlone/tests/testDateTimeIntegration.py
M Products/CMFPlone/tests/testEmailLogin.py
M Products/CMFPlone/tests/testExternalEditorEnabled.py
M Products/CMFPlone/tests/testIImagingSchema.py
M Products/CMFPlone/tests/testInterfaces.py
M Products/CMFPlone/tests/testMigrationTool.py
M Products/CMFPlone/tests/testNavTree.py
M Products/CMFPlone/tests/testNavigationView.py
M Products/CMFPlone/tests/testNextPrevious.py
M Products/CMFPlone/tests/testPloneTool.py
M Products/CMFPlone/tests/testPortalCreation.py
M Products/CMFPlone/tests/testQueryCatalog.py
M Products/CMFPlone/tests/testRegistrationTool.py
M Products/CMFPlone/tests/testResourceRegistries.py
M Products/CMFPlone/tests/testRestrictedAcquisition.py
M Products/CMFPlone/tests/testSearch.py
M Products/CMFPlone/tests/testSecurity.py
M Products/CMFPlone/tests/testSecurityDeclarations.py
M Products/CMFPlone/tests/testSyndication.py
M Products/CMFPlone/tests/testTranslationServiceTool.py
M Products/CMFPlone/tests/testURLTool.py
M Products/CMFPlone/tests/testUnicodeSplitter.py
M Products/CMFPlone/tests/testUserFolderBasics.py
M Products/CMFPlone/tests/testWebDAV.py
M Products/CMFPlone/tests/testWorkflowTool.py
M Products/CMFPlone/tests/test_defaultpage.py
M Products/CMFPlone/tests/test_doctests.py
M Products/CMFPlone/tests/test_expressions.py
M Products/CMFPlone/tests/test_factory.py
M Products/CMFPlone/tests/test_functional.py
M Products/CMFPlone/tests/test_login_form.py
M Products/CMFPlone/tests/test_login_logout.py
M Products/CMFPlone/tests/test_mails.py
M Products/CMFPlone/tests/test_patternsettings.py
M Products/CMFPlone/tests/test_redirect_after_login.py
M Products/CMFPlone/tests/test_robot.py
M Products/CMFPlone/tests/test_robots_txt.py
M Products/CMFPlone/tests/test_safe_formatter.py
M Products/CMFPlone/tests/test_sitelogo.py
M Products/CMFPlone/tests/test_sitemap.py
M Products/CMFPlone/tests/test_utils.py
M Products/CMFPlone/tests/test_zmi.py
M Products/CMFPlone/tests/utils.py
M Products/CMFPlone/unicodeconflictresolver.py
M Products/CMFPlone/utils.py
M Products/CMFPlone/workflow.py
M pyproject.toml
M setup.py
D CHANGES.rst
D CONTRIBUTING.rst
D Products/CMFPlone/tests/redirection.txt
D README.rst
D news/3382.bugfix
D news/3475.bugfix
D news/3536.bugfix
D news/3568.bugfix
D news/3581.bugfix
D news/3582.bugfix
D news/3584.bugfix
D news/3587.bugfix
D news/3601.bugfix
D news/3605.bugfix
D news/3609.bugfix
D news/3610.bugfix
D news/3614-2.bugfix
D news/3614.bugfix
D news/3615.bugfix
D news/3616.bugfix
D news/6007.bugfix

b'diff --git a/CHANGES.rst b/CHANGES.md\nsimilarity index 73%\nrename from CHANGES.rst\nrename to CHANGES.md\nindex 57fafe41c8..a956f98c6a 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.md\n@@ -1,21 +1,191 @@\n-.. This file should contain the changes for the last release only, which\n+<!--\n+   This file should contain the changes for the last release only, which\n    will be included on the package\'s page on pypi. All older entries are\n    kept in docs/HISTORY.rst\n+-->\n \n-Changelog\n-=========\n+# Changelog\n \n-.. You should *NOT* be adding new change log entries to this file.\n+<!--\n+   You should *NOT* be adding new change log entries to this file.\n    You should create a file in the news directory instead.\n    For helpful instructions, please see:\n    https://github.com/plone/plone.releaser/blob/master/ADD-A-NEWS-ITEM.rst\n+-->\n \n-.. towncrier release notes start\n+<!-- towncrier release notes start -->\n \n-6.0.0b1 (2022-07-23)\n---------------------\n+## 6.0.2 (2023-02-27)\n \n-Breaking changes:\n+\n+### Bug fixes:\n+\n+- Apply Barceloneta upgrades when upgrading Plone.\n+  [maurits] #3726\n+\n+\n+## 6.0.2rc1 (2023-02-23)\n+\n+\n+### Bug fixes:\n+\n+- Fix editing `modal` property of an action in `@@actions-controlpanel`.\n+  [petschki] #3709\n+- Updated metadata version to 6013.  [maurits] #6013\n+\n+\n+## 6.0.1 (2023-01-31)\n+\n+\n+### Bug fixes:\n+\n+- Prepare 6.0.1 final. No changes compared to the release candidate.\n+  [maurits] #601\n+\n+\n+## 6.0.1rc1 (2023-01-30)\n+\n+\n+### New features:\n+\n+- Add data-bundle attributes on javascript and styles resources.  [aormazabal] #3707\n+\n+\n+### Bug fixes:\n+\n+- During login, when login_time is invalid, warn and reset it to 2000/01/01.\n+  Fixes [issue 3656](https://github.com/plone/Products.CMFPlone/issues/3656>).\n+  [maurits] #3656\n+- When autologin after password reset is enabled, use the same adapters as during normal login.\n+  Specifically: the ``IInitialLogin`` and ``IRedirectAfterLogin`` adapters.\n+  Autologin is enabled by default.\n+  Fixes [issue 3713](https://github.com/plone/Products.CMFPlone/issues/3713).\n+  [maurits] #3713\n+- Updated metadata version to 6012.  [maurits] #6012\n+\n+\n+## 6.0.0 (2022-12-12)\n+\n+\n+### Bug fixes:\n+\n+- Add help label to create Plone site page for difference between Volto and ClassicUI with link to docs. [fredvd] #3072\n+- Change the search control panel to select types not searched instead of searchable types. This fixes an inconsistency with Volto. [danalvrz] #3694\n+- Update default home page for installers for Plone 6 final release. [stevepiercy] #3700\n+- Updated metadata version to 6011.  [maurits] #6011\n+\n+\n+## 6.0.0rc2 (2022-12-05)\n+\n+### Bug fixes:\n+\n+\n+- Fix duplicated ``<article id="content">`` in login form.\n+  [petschki] (#3680)\n+- Fix caching of rendered resources.\n+  [petschki] (#3683)\n+- Update package metadata in pypi.\n+  [ericof] (#3687)\n+- Updated metadata version to 6010.  [maurits] (#6010)\n+\n+\n+## 6.0.0rc1 (2022-11-18)\n+\n+### Bug fixes:\n+\n+\n+- Don\'t create news, events, and users folders for Volto sites. [davisagli] (#3628)\n+- Fix password used in a test. [davisagli] (#3653)\n+- Bootstrap fix for numbering `.list-group-numbered`.\n+  See suggestions here https://github.com/twbs/bootstrap/issues/37345\n+  [petschki] (#3661)\n+- Fix \'KeyError: file\' in browser tests on Python 3.11.\n+  [maurits] (#3663)\n+- Updated metadata version to 6009.  [maurits] (#6009)\n+\n+\n+## 6.0.0b3 (2022-10-04)\n+\n+### Bug fixes:\n+\n+\n+- Deprecate the portal_properties tool, remove obsolete code (#125)\n+- Require Python 3.8 or higher.  [maurits] (#3635)\n+- Actually load theme-specified styles CSS in TinyMCE. [Rudd-O] (#3638)\n+- Minor visual fixes in admin UI [jensens] (#3640)\n+- Fix aliased helpers\n+  [ale-rt] (#3641)\n+- Fix tests to work with longer minimum password length. [davisagli] (#3646)\n+- Improve tinymce table settings [MrTango] (#3650)\n+- Make add classic Plone site button better visible [MrTango] (#3651)\n+- Updated metadata version to 6008.  [maurits] (#6008)\n+\n+\n+## 6.0.0b2 (2022-09-10)\n+\n+### Breaking changes:\n+\n+\n+- Officially drop Python 3.7 support and add 3.10 support.\n+  Currently everything still work in 3.7, all tests pass, but beta 2 is the last release where this is the case.\n+  See discussion in `this issue <https://github.com/plone/Products.CMFPlone/issues/3635>`_ and especially `this community poll <https://community.plone.org/t/plone-6-0-drop-support-for-python-3-7-and-3-8/15549>`_.\n+  [maurits] (#3635)\n+\n+\n+### Bug Fixes:\n+\n+\n+- Moved CSFR patches addressing CMFPlone itself to decorators.\n+  [jensens] (3614-2)\n+- Fixed an issue that prevented the user to select the preferred timezone (#1290)\n+- Fixed adding control panel action via ZMI.\n+  [maurits] (#1959)\n+- Changed \'Powered by\' text\n+  [rohnsha0] (#3382)\n+- Fix active tab in ``@@test-rendering-icons``.\n+  [petschki] (#3475)\n+- Do not create title tag for svg icons when tag_alt is not given.\n+  [agitator] (#3536)\n+- Fixed all known instances of plone.com in plone/Products.CMFPlone\n+  [rohnsha0] (#3568)\n+- Allow access to the macros of the main_template, also from skin templates.\n+  [maurits] (#3581)\n+- Robot tests: be more specific when clicking some elements.\n+  [maurits] (#3582)\n+- Set portal title in registry when creating a new Plone site\n+  [erral] (#3584)\n+- Change test to make sure e-mail is sent in utf-8\n+  [erral] (#3587)\n+- Fixed \'Site Setup\' link appearing on various parts of Control Panel\n+  [rohnsha0] (#3599)\n+- Fixed Inconsistent font issues in Control Panel\n+  [rohnsha0] (#3600)\n+- Fix visual issue with long action name in @@actions-controlpanel.\n+  [petschki] (#3601)\n+- Fixed an error where Main Template (line: 42) referenced plone.com istead of plone.org\n+  [rohnsha0] (#3605)\n+- In traversal.py remove a Zope 4 BBB code, add a comment about bundle traverser and apply black.isort on the file.\n+  [jensens] (#3609)\n+- Supress warning of intentional deprecated import for BBB.\n+  [jensens] (#3610)\n+- Use plone.base and reduce deprecation warnings.\n+  In utils remove functions already moved to plone.base and add deferred import with message.\n+  Deprecate correct, where prior only comments or old logging.\n+  Some black/isort where touched.\n+  [jensens] (#3614)\n+- Move utils.getQuality and utils.getAllowedSizes to plone.namedfile.utils.\n+  This helps untangling circular dependencies.\n+  [jensens] (#3615)\n+- Do not use deprecated calls in actions expressions.\n+  ActionsTool and PloneBasetool got an code style overhaul.\n+  [jensens] (#3616)\n+- Updated metadata version to 6007.\n+  [maurits] (#6007)\n+\n+\n+## 6.0.0b1 (2022-07-23)\n+\n+### Breaking changes:\n \n \n - Removed our expressions patch.\n@@ -25,7 +195,7 @@ Breaking changes:\n   [maurits] (#3567)\n \n \n-New features:\n+### New features:\n \n \n - Initially open accordions in resource registry. Hide via JS when no errors occur.\n@@ -34,7 +204,7 @@ New features:\n   [petschki] (#3570)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Reduce dependencies in setup.py here, when already fulfilled in the packages where in use.\n@@ -49,10 +219,9 @@ Bug fixes:\n   [maurits] (#6006)\n \n \n-6.0.0a6 (2022-06-27)\n---------------------\n+## 6.0.0a6 (2022-06-27)\n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Remove the use of f-strings for translations\n@@ -63,10 +232,9 @@ Bug fixes:\n   [petschki] (#3566)\n \n \n-6.0.0a5 (2022-06-24)\n---------------------\n+## 6.0.0a5 (2022-06-24)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - Remove Archtypes specific ``isIDAutoGenerated`` helper.\n@@ -82,7 +250,7 @@ Breaking changes:\n   [jensens] (#3520)\n \n \n-New features:\n+### New features:\n \n \n - Added customisable batch_size for redirects controlpanel\n@@ -106,7 +274,7 @@ New features:\n   [petschki] (#3558)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Make compatible with robotframework 3-5.\n@@ -139,10 +307,9 @@ Bug fixes:\n   [maurits] (#6005)\n \n \n-6.0.0a4 (2022-04-08)\n---------------------\n+## 6.0.0a4 (2022-04-08)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - PLIP 3211:\n@@ -175,7 +342,7 @@ Breaking changes:\n   [jensens, pbauer] (#3485)\n \n \n-New features:\n+### New features:\n \n \n - PLIP #3279: Implement modern images scales. Add huge (1600px), great (1200px), larger (1000px), teaser (600px). Amend preview and mini (remove height constraint).\n@@ -193,7 +360,7 @@ New features:\n   [agitator] (#3489)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Fixed evaluating expressions on resources, and especially loading ``plone.session`` resources.\n@@ -248,10 +415,9 @@ Bug fixes:\n   [maurits] (#6004)\n \n \n-6.0.0a3 (2022-01-28)\n---------------------\n+## 6.0.0a3 (2022-01-28)\n \n-New features:\n+### New features:\n \n \n - add a new entry in site-controlpanel to change the favicon and its MIME-type\n@@ -265,7 +431,7 @@ New features:\n   [jensens] (#3377)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Cleanup Error Log Form after Review\n@@ -281,10 +447,9 @@ Bug fixes:\n - Updated metadata version to 6003.  [maurits] (#6003)\n \n \n-6.0.0a2 (2021-12-03)\n---------------------\n+## 6.0.0a2 (2021-12-03)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - PLIP 3339: Replace ``z3c.autoinclude`` with ``plone.autoinclude``.\n@@ -292,14 +457,14 @@ Breaking changes:\n   [maurits, tschorr] (#3339)\n \n \n-New features:\n+### New features:\n \n \n - On Zope root, create Volto site by default.\n   [maurits] (#3344)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Move prefs_error_log* from skins to browser views\n@@ -322,10 +487,9 @@ Bug fixes:\n - Updated metadata version to 6002.  [maurits] (#6002)\n \n \n-6.0.0a1 (2021-10-22)\n---------------------\n+## 6.0.0a1 (2021-10-22)\n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Release Plone 6.0.0a1.\n@@ -333,10 +497,9 @@ Bug fixes:\n   [maurits] (#3341)\n \n \n-6.0.0a1.dev1 (2021-10-16)\n--------------------------\n+## 6.0.0a1.dev1 (2021-10-16)\n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Use HTML5 meta charset.\n@@ -367,10 +530,9 @@ Bug fixes:\n   [maurits] (#6001)\n \n \n-6.0.0a1.dev0 (2021-09-15)\n--------------------------\n+## 6.0.0a1.dev0 (2021-09-15)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - Removed our CMFQuickInstallerTool code completely.\n@@ -411,7 +573,7 @@ Breaking changes:\n   tschorr] (#3249)\n \n \n-New features:\n+### New features:\n \n \n - Custom date format strings from registry can be in the ``${}`` format as in the locales files.\n@@ -428,7 +590,7 @@ New features:\n   [pbauer] (#3297)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Add ``plone.app.caching`` to the list of add-ons that is upgraded when upgrading Plone.\ndiff --git a/CONTRIBUTING.md b/CONTRIBUTING.md\nnew file mode 100644\nindex 0000000000..5826e4eca3\n--- /dev/null\n+++ b/CONTRIBUTING.md\n@@ -0,0 +1 @@\n+Please see [Developer Guidelines](https://docs.plone.org/develop/coredev/docs/guidelines.html)\ndiff --git a/CONTRIBUTING.rst b/CONTRIBUTING.rst\ndeleted file mode 100644\nindex fc637ac8aa..0000000000\n--- a/CONTRIBUTING.rst\n+++ /dev/null\n@@ -1 +0,0 @@\n-Please see http://docs.plone.org/develop/coredev/docs/guidelines.html\ndiff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 54a24caf45..64e11a1a10 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -45,7 +45,6 @@\n import urllib\n \n \n-\n logger = logging.getLogger(\'Plone\')\n \n _marker = object()\n@@ -151,8 +150,8 @@ def allowedRolesAndUsers(obj):\n @indexer(Interface)\n def object_provides(obj):\n     return tuple(\n-        [i.__identifier__ for i in providedBy(obj).flattened()\n-         if i.__identifier__ not in DENIED_INTERFACES]\n+        i.__identifier__ for i in providedBy(obj).flattened()\n+         if i.__identifier__ not in DENIED_INTERFACES\n     )\n \n \ndiff --git a/Products/CMFPlone/MigrationTool.py b/Products/CMFPlone/MigrationTool.py\nindex 7b56c901ee..98285bd0c8 100644\n--- a/Products/CMFPlone/MigrationTool.py\n+++ b/Products/CMFPlone/MigrationTool.py\n@@ -1,16 +1,16 @@\n from AccessControl import ClassSecurityInfo\n-from AccessControl.requestmethod import postonly\n from AccessControl.class_init import InitializeClass\n+from AccessControl.requestmethod import postonly\n from App.config import getConfiguration\n+from io import StringIO\n from OFS.SimpleItem import SimpleItem\n+from plone.base.interfaces import IMigrationTool\n from Products.CMFCore.permissions import ManagePortal\n from Products.CMFCore.utils import getToolByName\n from Products.CMFCore.utils import registerToolInterface\n from Products.CMFCore.utils import UniqueObject\n from Products.CMFPlone.factory import _DEFAULT_PROFILE\n-from plone.base.interfaces import IMigrationTool\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n-from io import StringIO\n from ZODB.POSException import ConflictError\n from zope.interface import implementer\n \n@@ -19,6 +19,7 @@\n import sys\n import transaction\n \n+\n logger = logging.getLogger(\'plone.app.upgrade\')\n _upgradePaths = {}\n \n@@ -120,6 +121,7 @@ def upgrade_all(self, context):\n         profile_id=\'plone.volto:default\',\n         check_module=\'plone.volto\'\n     ),\n+    Addon(profile_id=\'plonetheme.barceloneta:default\'),\n ])\n \n \ndiff --git a/Products/CMFPlone/PasswordResetTool.py b/Products/CMFPlone/PasswordResetTool.py\nindex 2f5f74e4e2..620a34a0b7 100644\n--- a/Products/CMFPlone/PasswordResetTool.py\n+++ b/Products/CMFPlone/PasswordResetTool.py\n@@ -8,16 +8,17 @@\n from AccessControl.class_init import InitializeClass\n from BTrees.OOBTree import OOBTree\n from OFS.SimpleItem import SimpleItem\n+from plone.base.interfaces import IPWResetTool\n+from plone.base.interfaces import ISecuritySchema\n from plone.registry.interfaces import IRegistry\n from plone.uuid.interfaces import IUUIDGenerator\n from Products.CMFCore.permissions import ManagePortal\n from Products.CMFCore.utils import getToolByName\n from Products.CMFCore.utils import UniqueObject\n-from plone.base.interfaces import IPWResetTool\n-from plone.base.interfaces import ISecuritySchema\n from Products.CMFPlone.RegistrationTool import get_member_by_login_name\n from zope.component import getUtility\n from zope.interface import implementer\n+\n import datetime\n \n \ndiff --git a/Products/CMFPlone/PloneBatch.py b/Products/CMFPlone/PloneBatch.py\nindex f0f2c5eaa2..b96f72402a 100644\n--- a/Products/CMFPlone/PloneBatch.py\n+++ b/Products/CMFPlone/PloneBatch.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n+\n moved(\'plone.base.batch\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/PloneControlPanel.py b/Products/CMFPlone/PloneControlPanel.py\nindex 0748f25765..fa04987c11 100644\n--- a/Products/CMFPlone/PloneControlPanel.py\n+++ b/Products/CMFPlone/PloneControlPanel.py\n@@ -3,16 +3,18 @@\n from App.special_dtml import DTMLFile\n from OFS.Folder import Folder\n from OFS.PropertyManager import PropertyManager\n+from plone.base.interfaces import IControlPanel\n from Products.CMFCore.ActionInformation import ActionInformation\n from Products.CMFCore.ActionProviderBase import ActionProviderBase\n-from Products.CMFCore.Expression import Expression, createExprContext\n-from Products.CMFCore.permissions import ManagePortal, View\n+from Products.CMFCore.Expression import createExprContext\n+from Products.CMFCore.Expression import Expression\n+from Products.CMFCore.permissions import ManagePortal\n+from Products.CMFCore.permissions import View\n from Products.CMFCore.utils import _checkPermission\n from Products.CMFCore.utils import getToolByName\n from Products.CMFCore.utils import registerToolInterface\n from Products.CMFCore.utils import UniqueObject\n from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import IControlPanel\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from zope.component.hooks import getSite\n from zope.i18n import translate\n@@ -224,7 +226,7 @@ def addAction(self,\n                   description=\'\',\n                   REQUEST=None,\n                   ):\n-        # Add an action to our list.\n+        """Add an action to our list."""\n         if not name:\n             raise ValueError(\'A name is required.\')\n \ndiff --git a/Products/CMFPlone/Portal.py b/Products/CMFPlone/Portal.py\nindex a3057b0a6a..15541f38b8 100644\n--- a/Products/CMFPlone/Portal.py\n+++ b/Products/CMFPlone/Portal.py\n@@ -116,7 +116,7 @@ def __delattr__(self, name):\n \n     # From PortalObjectBase\n     def __init__(self, id, title=\'\'):\n-        super(PloneSite, self).__init__(id, title=title)\n+        super().__init__(id, title=title)\n         components = PersistentComponents(\'++etc++site\')\n         components.__parent__ = self\n         self.setSiteManager(components)\n@@ -135,7 +135,7 @@ def __before_publishing_traverse__(self, arg1, arg2=None):\n             pass\n         self.setupCurrentSkin(REQUEST)\n \n-        super(PloneSite, self).__before_publishing_traverse__(arg1, arg2)\n+        super().__before_publishing_traverse__(arg1, arg2)\n \n     # Concept from OFS.OrderSupport\n     @security.protected(permissions.AccessContentsInformation)\ndiff --git a/Products/CMFPlone/PropertiesTool.py b/Products/CMFPlone/PropertiesTool.py\nindex d8ce537a1d..f0ea227709 100644\n--- a/Products/CMFPlone/PropertiesTool.py\n+++ b/Products/CMFPlone/PropertiesTool.py\n@@ -1,24 +1,24 @@\n-from Acquisition import aq_parent, aq_inner\n-from Products.CMFCore.permissions import ManagePortal\n-from Products.CMFCore.utils import UniqueObject\n-\n-from Products.PageTemplates.PageTemplateFile import PageTemplateFile\n-from OFS.Folder import Folder\n+from AccessControl import ClassSecurityInfo\n from AccessControl.class_init import InitializeClass\n+from Acquisition import aq_inner\n+from Acquisition import aq_parent\n from App.special_dtml import DTMLFile\n-from zope.interface import implementer\n-\n+from OFS.Folder import Folder\n from OFS.PropertyManager import PropertyManager\n from OFS.SimpleItem import SimpleItem\n-from AccessControl import ClassSecurityInfo\n+from plone.base.interfaces import IPropertiesTool\n+from plone.base.interfaces import ISimpleItemWithProperties\n+from Products.CMFCore.interfaces import ISiteRoot\n+from Products.CMFCore.permissions import ManagePortal\n+from Products.CMFCore.utils import UniqueObject\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n-from plone.base.interfaces \\\n-    import IPropertiesTool, ISimpleItemWithProperties\n from Products.CMFPlone.utils import WWW_DIR\n from Products.MailHost.interfaces import IMailHost\n+from Products.PageTemplates.PageTemplateFile import PageTemplateFile\n from zope.component import getUtility\n from zope.component import queryUtility\n-from Products.CMFCore.interfaces import ISiteRoot\n+from zope.deprecation import deprecate\n+from zope.interface import implementer\n \n \n @implementer(IPropertiesTool)\n@@ -106,6 +106,17 @@ def title(self):\n     def smtp_server(self):\n         return getUtility(IMailHost).smtp_host\n \n+\n+    @deprecate(\n+        "The portal portal_properties tool will be removed in Plone 6.1. "\n+        "Use the portal_registry instead. "\n+        "Check https://github.com/plone/Products.CMFPlone/issues/125 "\n+        "for more details."\n+    )\n+    def hasProperty(self, id):\n+        return super().hasProperty(id)\n+\n+\n InitializeClass(PropertiesTool)\n \n \n@@ -125,4 +136,14 @@ def __init__(self, id, title=\'\'):\n     manage_options = (PropertyManager.manage_options\n                       + SimpleItem.manage_options)\n \n+    @deprecate(\n+        "The portal portal_properties tool will be removed in Plone 6.1. "\n+        "Use the portal_registry instead. "\n+        "Check https://github.com/plone/Products.CMFPlone/issues/125 "\n+        "for more details."\n+    )\n+    def hasProperty(self, id):\n+        return super().hasProperty(id)\n+\n+\n InitializeClass(SimpleItemWithProperties)\ndiff --git a/Products/CMFPlone/TypesTool.py b/Products/CMFPlone/TypesTool.py\nindex cf94213cdd..4a4c773db4 100644\n--- a/Products/CMFPlone/TypesTool.py\n+++ b/Products/CMFPlone/TypesTool.py\n@@ -1,10 +1,8 @@\n from AccessControl import ClassSecurityInfo\n from AccessControl.class_init import InitializeClass\n-\n from Products.CMFCore.ActionInformation import ActionInfo\n from Products.CMFCore.interfaces import IAction\n from Products.CMFCore.TypesTool import TypesTool as BaseTool\n-\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n \n \ndiff --git a/Products/CMFPlone/URLTool.py b/Products/CMFPlone/URLTool.py\nindex c7d22bf174..87683ac434 100644\n--- a/Products/CMFPlone/URLTool.py\n+++ b/Products/CMFPlone/URLTool.py\n@@ -1,11 +1,11 @@\n from AccessControl import ClassSecurityInfo\n+from AccessControl.class_init import InitializeClass\n from Acquisition import aq_inner\n from Acquisition import aq_parent\n-from AccessControl.class_init import InitializeClass\n from Products.CMFCore.interfaces import ISiteRoot\n from Products.CMFCore.URLTool import URLTool as BaseTool\n-from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from Products.CMFPlone.patches.gtbn import rewrap_in_request_container\n+from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from zope.component import getUtility\n \n \ndiff --git a/Products/CMFPlone/WorkflowTool.py b/Products/CMFPlone/WorkflowTool.py\nindex 7085bb42c5..53ab7b1732 100644\n--- a/Products/CMFPlone/WorkflowTool.py\n+++ b/Products/CMFPlone/WorkflowTool.py\n@@ -1,19 +1,19 @@\n-from zope.component import getMultiAdapter\n-\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFCore.WorkflowTool import WorkflowTool as BaseTool\n-from plone.base.interfaces import IWorkflowChain\n-from ZODB.POSException import ConflictError\n-from Acquisition import aq_base\n-\n+from AccessControl import ClassSecurityInfo\n+from AccessControl import getSecurityManager\n from AccessControl.class_init import InitializeClass\n-from AccessControl import getSecurityManager, ClassSecurityInfo\n+from Acquisition import aq_base\n+from plone.base.interfaces import IWorkflowChain\n from Products.CMFCore.permissions import ManagePortal\n-from Products.DCWorkflow.Transitions import TRIGGER_USER_ACTION\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFCore.WorkflowTool import WorkflowTool as BaseTool\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n+from Products.DCWorkflow.Transitions import TRIGGER_USER_ACTION\n+from ZODB.POSException import ConflictError\n+from zope.component import getMultiAdapter\n \n import pkg_resources\n \n+\n try:\n     pkg_resources.get_distribution(\'plone.app.multilingual\')\n except pkg_resources.DistributionNotFound:\n@@ -258,7 +258,7 @@ def getWorklistsResults(self):\n                                 objects_by_path[absurl] = (o.modified(), o)\n \n         results = objects_by_path.values()\n-        return tuple([obj[1] for obj in sorted(results)])\n+        return tuple(obj[1] for obj in sorted(results))\n \n     security.declareProtected(ManagePortal, \'getChainForPortalType\')\n \ndiff --git a/Products/CMFPlone/bbb.py b/Products/CMFPlone/bbb.py\nindex ee3d242008..c92083cb24 100644\n--- a/Products/CMFPlone/bbb.py\n+++ b/Products/CMFPlone/bbb.py\n@@ -1,5 +1,6 @@\n import pkg_resources\n \n+\n HAS_ZSERVER = True\n try:\n     dist = pkg_resources.get_distribution(\'ZServer\')\ndiff --git a/Products/CMFPlone/browser/admin.py b/Products/CMFPlone/browser/admin.py\nindex e7728186d3..98d4a3256c 100644\n--- a/Products/CMFPlone/browser/admin.py\n+++ b/Products/CMFPlone/browser/admin.py\n@@ -13,7 +13,8 @@\n from Products.CMFPlone.factory import _DEFAULT_PROFILE\n from Products.CMFPlone.factory import addPloneSite\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-from Products.GenericSetup import BASE, EXTENSION\n+from Products.GenericSetup import BASE\n+from Products.GenericSetup import EXTENSION\n from Products.GenericSetup import profile_registry\n from Products.GenericSetup.upgrade import normalize_version\n from urllib import parse\n@@ -24,7 +25,8 @@\n from zope.component import queryMultiAdapter\n from zope.component import queryUtility\n from zope.i18n.interfaces import IUserPreferredLanguages\n-from zope.i18n.locales import locales, LoadLocaleError\n+from zope.i18n.locales import LoadLocaleError\n+from zope.i18n.locales import locales\n from zope.interface import alsoProvides\n from zope.interface import Interface\n from zope.publisher.browser import BrowserView\n@@ -158,10 +160,8 @@ class AddPloneSite(BrowserView):\n     # Let\'s have a separate list for Volto.\n     volto_default_extension_profiles = (\n         \'plone.app.caching:default\',\n-        # We could choose to not install Barceloneta:\n         \'plonetheme.barceloneta:default\',\n         \'plone.volto:default\',\n-        \'plone.volto:default-homepage\'\n     )\n \n     def profiles(self):\n@@ -292,6 +292,7 @@ def __call__(self):\n             else:\n                 # we have a keymanager, check csrf protection manually now\n                 checkCSRF(self.request)\n+\n             site = addPloneSite(\n                 context, site_id,\n                 title=form.get(\'title\', \'\'),\ndiff --git a/Products/CMFPlone/browser/atd.py b/Products/CMFPlone/browser/atd.py\nindex a4dc2d4201..161c430f33 100644\n--- a/Products/CMFPlone/browser/atd.py\n+++ b/Products/CMFPlone/browser/atd.py\n@@ -1,9 +1,9 @@\n-from Products.CMFCore.utils import getToolByName\n-from zope.component import getUtility\n-from plone.registry.interfaces import IRegistry\n from http import client as http_client\n from plone.base.interfaces import ITinyMCESchema\n from plone.base.interfaces.atd import IATDProxyView\n+from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from zope.component import getUtility\n from zope.interface import implementer\n \n \ndiff --git a/Products/CMFPlone/browser/contact_info.py b/Products/CMFPlone/browser/contact_info.py\nindex 1c2dcd3fc5..5b113269a3 100644\n--- a/Products/CMFPlone/browser/contact_info.py\n+++ b/Products/CMFPlone/browser/contact_info.py\n@@ -1,19 +1,21 @@\n+from email.mime.text import MIMEText\n+from plone.autoform.form import AutoExtensibleForm\n+from plone.base.interfaces.controlpanel import IMailSchema\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.browser.interfaces import IContactForm\n-from plone.base.interfaces.controlpanel import IMailSchema\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n-from email.mime.text import MIMEText\n-from plone.autoform.form import AutoExtensibleForm\n-from plone.registry.interfaces import IRegistry\n from smtplib import SMTPException\n-from z3c.form import form, button\n+from z3c.form import button\n+from z3c.form import form\n from zope.component import getUtility\n from zope.component.hooks import getSite\n \n import logging\n \n+\n log = logging.getLogger(__name__)\n \n \ndiff --git a/Products/CMFPlone/browser/defaultpage.py b/Products/CMFPlone/browser/defaultpage.py\nindex b8523814e3..026b54e94b 100644\n--- a/Products/CMFPlone/browser/defaultpage.py\n+++ b/Products/CMFPlone/browser/defaultpage.py\n@@ -1,7 +1,7 @@\n from Acquisition import aq_inner\n-from plone.base.interfaces.defaultpage import IDefaultPage\n from plone.base.defaultpage import get_default_page\n from plone.base.defaultpage import is_default_page\n+from plone.base.interfaces.defaultpage import IDefaultPage\n from Products.Five.browser import BrowserView\n from zope.interface import implementer\n \ndiff --git a/Products/CMFPlone/browser/favicon.py b/Products/CMFPlone/browser/favicon.py\nindex a6812cfb84..d2583794d5 100644\n--- a/Products/CMFPlone/browser/favicon.py\n+++ b/Products/CMFPlone/browser/favicon.py\n@@ -1,9 +1,9 @@\n-from Products.CMFPlone.interfaces import ISiteSchema\n from plone.formwidget.namedfile.converter import b64decode_file\n from plone.memoize import ram\n from plone.namedfile.browser import DisplayFile\n from plone.namedfile.file import NamedImage\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.interfaces import ISiteSchema\n from zope.component import getUtility\n \n import os.path\ndiff --git a/Products/CMFPlone/browser/global_statusmessage.py b/Products/CMFPlone/browser/global_statusmessage.py\nindex 552bc9e4af..b0971d10f6 100644\n--- a/Products/CMFPlone/browser/global_statusmessage.py\n+++ b/Products/CMFPlone/browser/global_statusmessage.py\n@@ -1,9 +1,7 @@\n-from zope.interface import implementer\n-\n+from Products.CMFPlone.browser.interfaces import IGlobalStatusMessage\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-\n-from Products.CMFPlone.browser.interfaces import IGlobalStatusMessage\n+from zope.interface import implementer\n \n \n @implementer(IGlobalStatusMessage)\ndiff --git a/Products/CMFPlone/browser/icons.py b/Products/CMFPlone/browser/icons.py\nindex 572fe3cf1c..6858edb649 100644\n--- a/Products/CMFPlone/browser/icons.py\n+++ b/Products/CMFPlone/browser/icons.py\n@@ -1,9 +1,8 @@\n-# -*- coding: utf-8 -*-\n from lxml import etree\n from OFS.Image import File\n from plone.registry.interfaces import IRegistry\n-from Products.Five.browser import BrowserView\n from Products.CMFCore.interfaces import ISiteRoot\n+from Products.Five.browser import BrowserView\n from zExceptions import NotFound\n from zope.component import adapter\n from zope.component import getUtility\n@@ -11,12 +10,12 @@\n from zope.interface import implementer\n from zope.interface import Interface\n from zope.location.interfaces import LocationError\n-from zope.traversing.interfaces import ITraversable\n from zope.publisher.interfaces import IPublishTraverse\n-from zExceptions import NotFound\n+from zope.traversing.interfaces import ITraversable\n \n import logging\n \n+\n logger = logging.getLogger(__name__)\n \n \ndiff --git a/Products/CMFPlone/browser/interfaces.py b/Products/CMFPlone/browser/interfaces.py\nindex 9a09561e91..732f11e05a 100644\n--- a/Products/CMFPlone/browser/interfaces.py\n+++ b/Products/CMFPlone/browser/interfaces.py\n@@ -1,13 +1,11 @@\n+from plone.schema import Email\n+from Products.CMFPlone import PloneMessageFactory as _\n from zope import schema\n from zope.interface import Attribute\n from zope.interface import Interface\n \n-from plone.schema import Email\n-\n import zope.deferredimport\n \n-from Products.CMFPlone import PloneMessageFactory as _\n-\n \n # This is used as a persistent marker interface, we need to provide an upgrade\n # step to update the class reference before removing it.\ndiff --git a/Products/CMFPlone/browser/login/login.py b/Products/CMFPlone/browser/login/login.py\nindex d655c226ea..8bc062b1ba 100644\n--- a/Products/CMFPlone/browser/login/login.py\n+++ b/Products/CMFPlone/browser/login/login.py\n@@ -1,14 +1,14 @@\n-from DateTime import DateTime\n+from .utils import has_logged_in\n from plone.app.users.browser.passwordpanel import PasswordPanel\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from plone.base.interfaces import IForcePasswordChange\n from plone.base.interfaces import IInitialLogin\n from plone.base.interfaces import ILoginForm\n from plone.base.interfaces import ILoginFormSchema\n from plone.base.interfaces import IRedirectAfterLogin\n from plone.base.interfaces import ISecuritySchema\n+from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five.browser import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\n from urllib import parse\n@@ -21,7 +21,10 @@\n from zope.component import queryUtility\n from zope.interface import implementer\n \n+import logging\n+\n \n+logger = logging.getLogger(__name__)\n # TODO: Scale down this list now that we\'ve removed a lot of\n # templates.\n LOGIN_TEMPLATE_IDS = [\n@@ -135,10 +138,8 @@ def _post_login(self):\n         membership_tool = getToolByName(self.context, \'portal_membership\')\n         member = membership_tool.getAuthenticatedMember()\n         must_change_password = member.getProperty(\'must_change_password\', 0)\n-        login_time = member.getProperty(\'login_time\', \'2000/01/01\')\n-        if not isinstance(login_time, DateTime):\n-            login_time = DateTime(login_time)\n-        is_initial_login = login_time == DateTime(\'2000/01/01\')\n+        login_time = member.getProperty(\'login_time\', None)\n+        is_initial_login = not has_logged_in(login_time)\n \n         membership_tool.loginUser(self.request)\n         if is_initial_login:\n@@ -251,7 +252,7 @@ def __call__(self):\n             url = f\'{portal.absolute_url():s}/login\'\n             came_from = self.request.get(\'came_from\', None)\n             if came_from:\n-                url += \'?came_from={:s}\'.format(parse.quote(came_from))\n+                url += f\'?came_from={parse.quote(came_from):s}\'\n         else:\n             url = f\'{portal.absolute_url():s}/insufficient-privileges\'\n \ndiff --git a/Products/CMFPlone/browser/login/login_help.py b/Products/CMFPlone/browser/login/login_help.py\nindex 7409a585e8..5ad934823c 100644\n--- a/Products/CMFPlone/browser/login/login_help.py\n+++ b/Products/CMFPlone/browser/login/login_help.py\n@@ -1,13 +1,13 @@\n from email import message_from_string\n from email.header import Header\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from plone.base.interfaces import ILoginHelpForm\n from plone.base.interfaces import ILoginHelpFormSchema\n from plone.base.interfaces import ISecuritySchema\n from plone.base.interfaces.controlpanel import IMailSchema\n from plone.base.utils import safe_text\n+from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n from smtplib import SMTPException\n@@ -54,7 +54,7 @@ class RequestResetPassword(form.Form):\n     render = ViewPageTemplateFile(\'templates/subform_render.pt\')\n \n     def updateActions(self):\n-        super(RequestResetPassword, self).updateActions()\n+        super().updateActions()\n         self.actions[\'reset\'].addClass(\'btn-primary\')\n \n     def updateWidgets(self):\n@@ -107,7 +107,7 @@ class RequestUsername(form.Form):\n     render = ViewPageTemplateFile(\'templates/subform_render.pt\')\n \n     def updateActions(self):\n-        super(RequestUsername, self).updateActions()\n+        super().updateActions()\n         self.actions[\'get_username\'].addClass(\'btn-primary\')\n \n     @button.buttonAndHandler(\n@@ -188,7 +188,7 @@ def encoded_mail_sender(self):\n         mail_settings = registry.forInterface(IMailSchema, prefix="plone")\n         from_ = mail_settings.email_from_name\n         mail = mail_settings.email_from_address\n-        return \'"{}" <{}>\'.format(self.encode_mail_header(from_), mail)\n+        return f\'"{self.encode_mail_header(from_)}" <{mail}>\'\n \n \n @implementer(ILoginHelpForm)\ndiff --git a/Products/CMFPlone/browser/login/password_reset.py b/Products/CMFPlone/browser/login/password_reset.py\nindex f2369f35d6..2728b126ac 100644\n--- a/Products/CMFPlone/browser/login/password_reset.py\n+++ b/Products/CMFPlone/browser/login/password_reset.py\n@@ -1,7 +1,8 @@\n+from .utils import has_logged_in\n from AccessControl.SecurityManagement import getSecurityManager\n-from DateTime import DateTime\n+from AccessControl.SecurityManagement import newSecurityManager\n+from AccessControl.SecurityManagement import setSecurityManager\n from email.header import Header\n-from plone.app.layout.navigation.interfaces import INavigationRoot\n from plone.base.interfaces import IPasswordResetToolView\n from plone.base.interfaces.controlpanel import IMailSchema\n from plone.base.utils import safe_text\n@@ -10,19 +11,18 @@\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n+from plone.base.interfaces import IInitialLogin\n+from plone.base.interfaces import IRedirectAfterLogin\n from Products.CMFPlone.PasswordResetTool import ExpiredRequestError\n from Products.CMFPlone.PasswordResetTool import InvalidRequestError\n from Products.CMFPlone.RegistrationTool import get_member_by_login_name\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-from Products.PlonePAS.events import UserInitialLoginInEvent\n-from Products.PlonePAS.events import UserLoggedInEvent\n-from Products.PluggableAuthService.interfaces.plugins import \\\n-    ICredentialsUpdatePlugin\n+from Products.PluggableAuthService.interfaces.plugins import ICredentialsUpdatePlugin\n from Products.statusmessages.interfaces import IStatusMessage\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n-from zope.event import notify\n+from zope.component import queryMultiAdapter\n from zope.i18n import translate\n from zope.interface import implementer\n from zope.publisher.interfaces import IPublishTraverse\n@@ -48,7 +48,7 @@ def encoded_mail_sender(self):\n         mail_settings = registry.forInterface(IMailSchema, prefix="plone")\n         from_ = mail_settings.email_from_name\n         mail = mail_settings.email_from_address\n-        return \'"{}" <{}>\'.format(self.encode_mail_header(from_).encode(), mail)\n+        return f\'"{self.encode_mail_header(from_).encode()}" <{mail}>\'\n \n     def registered_notify_subject(self):\n         portal_name = self.portal_state().portal_title()\n@@ -101,34 +101,71 @@ def _auto_login(self, userid, password):\n                 password\n             )\n \n+        is_initial_login = False\n+\n+        # Find member by login name or user id.\n+        # If this fails, then this is strange.\n         member = get_member_by_login_name(context, userid, False)\n+        if not member:\n+            self.request.response.redirect(self.context.absolute_url())\n+            IStatusMessage(self.request).addStatusMessage(\n+                _(\n+                    \'password_reset_failed\',\n+                    default=\'Password reset failed.\',\n+                ),\n+                \'info\',\n+            )\n+            return\n \n-        if member:\n-            user = member.getUser()\n-        else:\n-            # Fallback in case we cannot find a user\n-            # with the given userid\n-            user = getSecurityManager().getUser()\n-\n-        default = DateTime(\'2000/01/01\')\n-        login_time = user.getProperty(\'login_time\', default)\n-        if login_time == default:\n-            notify(UserInitialLoginInEvent(user))\n-        else:\n-            notify(UserLoggedInEvent(user))\n+        user = member.getUser()\n+        orig_sm = getSecurityManager()\n+        try:\n+            newSecurityManager(self.request, user)\n+            is_initial_login = self._post_login()\n+            IStatusMessage(self.request).addStatusMessage(\n+                _(\n+                    \'password_reset_successful\',\n+                    default=\'Password reset successful, \'\n+                            \'you are logged in now!\',\n+                ),\n+                \'info\',\n+            )\n+            self.redirect_after_login(is_initial_login=is_initial_login)\n+        finally:\n+            setSecurityManager(orig_sm)\n \n-        IStatusMessage(self.request).addStatusMessage(\n-            _(\n-                \'password_reset_successful\',\n-                default=\'Password reset successful, \'\n-                        \'you are logged in now!\',\n-            ),\n-            \'info\',\n-        )\n-        url = INavigationRoot(self.context).absolute_url()\n-        self.request.response.redirect(url)\n         return\n \n+    def _post_login(self):\n+        membership_tool = getToolByName(self.context, \'portal_membership\')\n+        member = membership_tool.getAuthenticatedMember()\n+        login_time = member.getProperty(\'login_time\', None)\n+        is_initial_login = not has_logged_in(login_time)\n+        membership_tool.loginUser(self.request)\n+        if is_initial_login:\n+            self.handle_initial_login()\n+        return is_initial_login\n+\n+    def handle_initial_login(self):\n+        handler = queryMultiAdapter((self.context, self.request), IInitialLogin)\n+        if handler:\n+            handler()\n+\n+    def redirect_after_login(self, came_from=None, is_initial_login=False):\n+        # Note: for password reset a came_from parameter seems illogical.\n+        # But let\'s allow it, to be the same as in login.py.\n+        # The default implementation does not pass it in though.\n+        adapter = queryMultiAdapter(\n+            (self.context, self.request),\n+            IRedirectAfterLogin\n+        )\n+        if adapter:\n+            came_from = adapter(came_from, is_initial_login)\n+        if not came_from:\n+            came_from = self.context.absolute_url()\n+\n+        self.request.response.redirect(came_from)\n+\n     def _reset_password(self, pw_tool, randomstring):\n         state = self.getErrors()\n         if state:\ndiff --git a/Products/CMFPlone/browser/login/templates/login.pt b/Products/CMFPlone/browser/login/templates/login.pt\nindex 96bb0257e8..8b2b5a8b9e 100644\n--- a/Products/CMFPlone/browser/login/templates/login.pt\n+++ b/Products/CMFPlone/browser/login/templates/login.pt\n@@ -10,7 +10,7 @@\n   <metal:main fill-slot="main">\n     <metal:main-macro define-macro="main">\n \n-      <article id="content" class="login-wrapper">\n+      <div class="login-wrapper">\n \n         <div class="card">\n           <div class="card-body">\n@@ -48,7 +48,7 @@\n           </div>\n         </div>\n \n-      </article>\n+      </div>\n \n     </metal:main-macro>\n   </metal:main>\ndiff --git a/Products/CMFPlone/browser/login/utils.py b/Products/CMFPlone/browser/login/utils.py\nnew file mode 100644\nindex 0000000000..3d347c8c9c\n--- /dev/null\n+++ b/Products/CMFPlone/browser/login/utils.py\n@@ -0,0 +1,28 @@\n+from DateTime import DateTime\n+from DateTime.interfaces import SyntaxError as DateTimeSyntaxError\n+\n+import logging\n+\n+\n+logger = logging.getLogger(__name__)\n+\n+\n+def has_logged_in(login_time):\n+    """Is this a valid login time?\n+\n+    The login time for new users is set to January 1, 2000.\n+    If that is the login time, the user has not logged in yet.\n+    """\n+    if not login_time:\n+        return False\n+    if not isinstance(login_time, DateTime):\n+        try:\n+            login_time = DateTime(login_time)\n+        except DateTimeSyntaxError:\n+            # https://github.com/plone/Products.CMFPlone/issues/3656\n+            logger.warning(\'%r is not a valid login_time.\', login_time)\n+            return False\n+    # We used to compare login_time with DateTime(\'2000/01/01\'),\n+    # but it may have a timezone: I have seen both UTC and GTM+1.\n+    # So compare only the date part.\n+    return login_time.Date() != \'2000/01/01\'\ndiff --git a/Products/CMFPlone/browser/navtree.py b/Products/CMFPlone/browser/navtree.py\nindex d066dc4e12..bba401a21b 100644\n--- a/Products/CMFPlone/browser/navtree.py\n+++ b/Products/CMFPlone/browser/navtree.py\n@@ -8,15 +8,17 @@\n from plone.app.layout.navigation.interfaces import INavtreeStrategy\n from plone.app.layout.navigation.navtree import NavtreeStrategyBase\n from plone.app.layout.navigation.root import getNavigationRoot\n+from plone.base.interfaces import INavigationSchema\n from plone.i18n.normalizer.interfaces import IIDNormalizer\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import utils\n-from plone.base.interfaces import INavigationSchema\n-from zope.component import getMultiAdapter, queryUtility\n+from zope.component import getMultiAdapter\n from zope.component import getUtility\n+from zope.component import queryUtility\n from zope.interface import implementer\n \n+\n # Strategy objects for the navtree creation code. You can subclass these\n # to expand the default navtree behaviour, and pass instances of your\n # subclasses to buildFolderTree().\ndiff --git a/Products/CMFPlone/browser/robots.py b/Products/CMFPlone/browser/robots.py\nindex eb4e2535bb..a80557d91d 100644\n--- a/Products/CMFPlone/browser/robots.py\n+++ b/Products/CMFPlone/browser/robots.py\n@@ -1,8 +1,8 @@\n from plone.base.interfaces.controlpanel import ISiteSchema\n-from Products.Five.browser import BrowserView\n from plone.registry.interfaces import IRegistry\n-from zope.component import getUtility\n+from Products.Five.browser import BrowserView\n from zope.component import getMultiAdapter\n+from zope.component import getUtility\n \n \n class Robots(BrowserView):\ndiff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py\nindex 08709607c8..4d3e25cd2d 100644\n--- a/Products/CMFPlone/browser/search.py\n+++ b/Products/CMFPlone/browser/search.py\n@@ -18,6 +18,7 @@\n import json\n import re\n \n+\n _ = MessageFactory(\'plone\')\n \n # We should accept both a simple space, unicode u\'\\u0020 but also a\ndiff --git a/Products/CMFPlone/browser/sendto.py b/Products/CMFPlone/browser/sendto.py\nindex 864dc1f27a..95d63034a4 100644\n--- a/Products/CMFPlone/browser/sendto.py\n+++ b/Products/CMFPlone/browser/sendto.py\n@@ -15,6 +15,7 @@\n \n import logging\n \n+\n logger = logging.getLogger("Plone")\n \n \ndiff --git a/Products/CMFPlone/browser/sitemap.py b/Products/CMFPlone/browser/sitemap.py\nindex 08b7071994..b835a89ea2 100644\n--- a/Products/CMFPlone/browser/sitemap.py\n+++ b/Products/CMFPlone/browser/sitemap.py\n@@ -1,11 +1,9 @@\n from Acquisition import aq_inner\n-from zope.component import getMultiAdapter\n-from zope.interface import implementer\n-\n+from Products.CMFPlone.browser.interfaces import ISitemapView\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-\n-from Products.CMFPlone.browser.interfaces import ISitemapView\n+from zope.component import getMultiAdapter\n+from zope.interface import implementer\n \n \n @implementer(ISitemapView)\ndiff --git a/Products/CMFPlone/browser/static/plone-admin-ui.css b/Products/CMFPlone/browser/static/plone-admin-ui.css\nindex 822b02697a..93745280cc 100644\n--- a/Products/CMFPlone/browser/static/plone-admin-ui.css\n+++ b/Products/CMFPlone/browser/static/plone-admin-ui.css\n@@ -5,3 +5,8 @@ body {\n   background: rgba(255,255,255,.95);\n   max-width: 800px;\n }\n+#go-to-site-link,\n+#go-to-site-link:visited,\n+#go-to-site-link:active {\n+  color: #fff;\n+}\ndiff --git a/Products/CMFPlone/browser/syndication/adapters.py b/Products/CMFPlone/browser/syndication/adapters.py\nindex 8963610609..aa7c48a47e 100644\n--- a/Products/CMFPlone/browser/syndication/adapters.py\n+++ b/Products/CMFPlone/browser/syndication/adapters.py\n@@ -1,32 +1,26 @@\n-from zope.component.hooks import getSite\n-from zope.component import adapts\n-from zope.interface import implementer\n-from zope.interface import Interface\n-from zope.component import getMultiAdapter\n-from zope.component import queryMultiAdapter\n-from zope.component import getUtility\n-\n from DateTime import DateTime\n from OFS.interfaces import IItem\n-\n-from Products.CMFCore.utils import getToolByName\n-from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-\n+from plone.app.contenttypes.behaviors.leadimage import ILeadImage\n from plone.base.interfaces.syndication import IFeed\n from plone.base.interfaces.syndication import IFeedItem\n-from plone.base.interfaces.syndication import ISearchFeed\n from plone.base.interfaces.syndication import IFeedSettings\n-from Products.CMFPlone.utils import getSiteLogo\n-\n+from plone.base.interfaces.syndication import ISearchFeed\n+from plone.dexterity.interfaces import IDexterityContent\n+from plone.namedfile.interfaces import INamedField\n from plone.registry.interfaces import IRegistry\n+from plone.rfc822.interfaces import IPrimaryFieldInfo\n from plone.uuid.interfaces import IUUID\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.utils import getSiteLogo\n+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from zope.cachedescriptors.property import Lazy as lazy_property\n-\n-from plone.dexterity.interfaces import IDexterityContent\n-from plone.rfc822.interfaces import IPrimaryFieldInfo\n-from plone.namedfile.interfaces import INamedField\n-\n-from plone.app.contenttypes.behaviors.leadimage import ILeadImage\n+from zope.component import adapts\n+from zope.component import getMultiAdapter\n+from zope.component import getUtility\n+from zope.component import queryMultiAdapter\n+from zope.component.hooks import getSite\n+from zope.interface import implementer\n+from zope.interface import Interface\n \n \n class BaseFeedData:\ndiff --git a/Products/CMFPlone/browser/syndication/settings.py b/Products/CMFPlone/browser/syndication/settings.py\nindex 9158f83858..da4daca293 100644\n--- a/Products/CMFPlone/browser/syndication/settings.py\n+++ b/Products/CMFPlone/browser/syndication/settings.py\n@@ -1,12 +1,13 @@\n-from zope.component import adapts\n-from zope.interface import implementer\n+from persistent.dict import PersistentDict\n from plone.base.interfaces.syndication import IFeedSettings\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from plone.base.interfaces.syndication import ISyndicatable\n+from plone.registry.interfaces import IRegistry\n from zope.annotation.interfaces import IAnnotations\n-from persistent.dict import PersistentDict\n-from plone.base.interfaces.syndication import ISiteSyndicationSettings\n+from zope.component import adapts\n from zope.component import getUtility\n-from plone.registry.interfaces import IRegistry\n+from zope.interface import implementer\n+\n \n FEED_SETTINGS_KEY = \'syndication_settings\'\n \ndiff --git a/Products/CMFPlone/browser/syndication/tool.py b/Products/CMFPlone/browser/syndication/tool.py\nindex ba622337e6..94a93823e0 100644\n--- a/Products/CMFPlone/browser/syndication/tool.py\n+++ b/Products/CMFPlone/browser/syndication/tool.py\n@@ -1,21 +1,17 @@\n-from Acquisition import aq_parent\n from AccessControl import Unauthorized\n-\n-from zope.component import getAdapter\n-from zope.interface import implementer\n-from zope.component import getUtility\n-\n-from Products.CMFCore.interfaces import ISyndicationTool\n-from Products.CMFCore.utils import registerToolInterface\n-from Products.CMFCore.utils import _checkPermission\n-from Products.CMFCore.permissions import ModifyPortalContent\n-from Products.CMFCore.permissions import ManagePortal\n-\n+from Acquisition import aq_parent\n from plone.base.interfaces.syndication import IFeed\n-from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from plone.base.interfaces.syndication import IFeedSettings\n-\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.interfaces import ISyndicationTool\n+from Products.CMFCore.permissions import ManagePortal\n+from Products.CMFCore.permissions import ModifyPortalContent\n+from Products.CMFCore.utils import _checkPermission\n+from Products.CMFCore.utils import registerToolInterface\n+from zope.component import getAdapter\n+from zope.component import getUtility\n+from zope.interface import implementer\n \n \n @implementer(ISyndicationTool)\ndiff --git a/Products/CMFPlone/browser/syndication/utils.py b/Products/CMFPlone/browser/syndication/utils.py\nindex 9e3171ba61..2fac9a8d9b 100644\n--- a/Products/CMFPlone/browser/syndication/utils.py\n+++ b/Products/CMFPlone/browser/syndication/utils.py\n@@ -1,17 +1,14 @@\n-from zExceptions import NotFound\n-from Products.Five import BrowserView\n-\n-from zope.schema.interfaces import IVocabularyFactory\n-from zope.interface import implementer\n-from zope.component import getUtility\n-\n-from plone.base.interfaces.syndication import ISyndicationUtil\n from plone.base.interfaces.syndication import IFeedSettings\n from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from plone.base.interfaces.syndication import ISyndicatable\n-\n-from plone.registry.interfaces import IRegistry\n+from plone.base.interfaces.syndication import ISyndicationUtil\n from plone.memoize.view import memoize\n+from plone.registry.interfaces import IRegistry\n+from Products.Five import BrowserView\n+from zExceptions import NotFound\n+from zope.component import getUtility\n+from zope.interface import implementer\n+from zope.schema.interfaces import IVocabularyFactory\n \n \n @implementer(ISyndicationUtil)\ndiff --git a/Products/CMFPlone/browser/syndication/views.py b/Products/CMFPlone/browser/syndication/views.py\nindex cda7137a35..8e41e7233e 100644\n--- a/Products/CMFPlone/browser/syndication/views.py\n+++ b/Products/CMFPlone/browser/syndication/views.py\n@@ -1,9 +1,9 @@\n from DateTime import DateTime\n-from plone.z3cform.layout import wrap_form\n-from Products.CMFPlone import PloneMessageFactory as _\n from plone.base.interfaces.syndication import IFeed\n from plone.base.interfaces.syndication import IFeedSettings\n from plone.base.interfaces.syndication import ISearchFeed\n+from plone.z3cform.layout import wrap_form\n+from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five import BrowserView\n from uuid import NAMESPACE_OID\n from uuid import uuid3\ndiff --git a/Products/CMFPlone/browser/templates/plone-addsite.pt b/Products/CMFPlone/browser/templates/plone-addsite.pt\nindex 95641ab424..c4ff0769e1 100644\n--- a/Products/CMFPlone/browser/templates/plone-addsite.pt\n+++ b/Products/CMFPlone/browser/templates/plone-addsite.pt\n@@ -1,5 +1,4 @@\n-<!DOCTYPE html\n-  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n+<!DOCTYPE html>\n <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:tal="http://xml.zope.org/namespaces/tal"\n   xmlns:metal="http://xml.zope.org/namespaces/metal" xmlns:i18n="http://xml.zope.org/namespaces/i18n" lang="en"\n   i18n:domain="plone">\n@@ -14,9 +13,9 @@\n   <link rel="stylesheet"\n         type="text/css"\n         href="${string:${context/absolute_url}/++resource++plone-admin-ui.css}" />\n-  <script type="text/javascript" tal:attributes="src string:${context/absolute_url}/++resource++jstz-1.0.4.min.js">\n+  <script tal:attributes="src string:${context/absolute_url}/++resource++jstz-1.0.4.min.js">\n   </script>\n-  <script type="text/javascript" tal:attributes="src string:${context/absolute_url}/++resource++plone-admin-ui.js">\n+  <script tal:attributes="src string:${context/absolute_url}/++resource++plone-admin-ui.js">\n   </script>\n </head>\n \ndiff --git a/Products/CMFPlone/browser/templates/plone-frontpage.pt b/Products/CMFPlone/browser/templates/plone-frontpage.pt\nindex 99f000f8bf..5e4e00e568 100644\n--- a/Products/CMFPlone/browser/templates/plone-frontpage.pt\n+++ b/Products/CMFPlone/browser/templates/plone-frontpage.pt\n@@ -16,7 +16,7 @@\n   </div>\n \n   <p class="discreet">\n-If you\'re seeing this instead of the web site you were expecting, the owner of\n+If you\'re seeing this text instead of the web site you were expecting, the owner of\n this web site has just installed Plone. Do not contact the Plone Team or the\n Plone support channels about this.\n </p>\n@@ -29,9 +29,9 @@ Before you start exploring your newly created Plone site, please do the followin\n \n <ol>\n     <li>Make sure you are logged in as an admin/manager user.\n-        <span class="discreet">(You should have a Site Setup entry in the user menu)</span></li>\n-    <li><a href="@@mail-controlpanel" target="_blank">Set up your mail server</a>. <span class="discreet">(Plone needs a valid SMTP server to verify users and send out password reminders)</span></li>\n-    <li><a href="@@security-controlpanel" target="_blank">Decide what security level you want on your site</a>. <span class="discreet">(Allow self registration, password policies, etc)</span></li>\n+        <span class="discreet">You should have a Site Setup entry in the user menu.</span></li>\n+    <li><a href="@@mail-controlpanel" target="_blank">Set up your mail server</a>. <span class="discreet">Plone needs a valid SMTP server to verify users and send out password reminders.</span></li>\n+    <li><a href="@@security-controlpanel" target="_blank">Decide what security level you want on your site</a>. <span class="discreet">Allow self registration, password policies, and more.</span></li>\n </ol>\n \n <h2>Get comfortable</h2>\n@@ -39,17 +39,16 @@ Before you start exploring your newly created Plone site, please do the followin\n <p>After that, we suggest you do one or more of the following:</p>\n \n <ul>\n-    <li>Get the latest <a class="link-plain" href="https://plone.org/what-is-plone/plone" target="_blank">news</a> about Plone.</li>\n-    <li>Read the <a class="link-plain" href="https://docs.plone.org" target="_blank">documentation</a>.</li>\n+    <li>Get the latest <a class="link-plain" href="https://plone.org/news" target="_blank">news</a> about Plone.</li>\n+    <li>Read the <a class="link-plain" href="https://6.docs.plone.org" target="_blank">documentation</a>.</li>\n     <li>Follow a <a class="link-plain" href="https://training.plone.org" target="_blank">training</a>.</li>\n     <li>Explore the <a class="link-plain" href="https://plone.org/download/add-ons" target="_blank">available add-ons</a> for Plone.</li>\n-    <li>Read and/or subscribe to the <a class="link-plain" href="https://plone.org/support" target="_blank">support channels</a>.</li>\n-    <li>Find out <a class="link-plain" href="https://plone.com/success-stories/" target="_blank">how others are using Plone</a>.</li>\n+    <li>Read or subscribe to the <a class="link-plain" href="https://plone.org/support" target="_blank">support channels</a>.</li>\n </ul>\n \n <h2>Make it your own</h2>\n \n-<p>Plone has a lot of different settings that can be used to make it do what you want it to. Some examples:</p>\n+<p>Plone has many settings to make it do what you want. Some examples include:</p>\n \n <ul>\n     <li>\n@@ -57,23 +56,23 @@ Before you start exploring your newly created Plone site, please do the followin\n     <a href="@@theming-controlpanel" target="_blank">the included ones</a>, or one of the\n     <a class="link-plain"\n        href="https://plone.org/download/add-ons" target="_blank">available themes\n-       from plone.org</a>. <span class="discreet">(Make sure the theme is\n-       compatible with the version of Plone you are currently using)</span>\n+       from plone.org</a>. <span class="discreet">Make sure the theme is\n+       compatible with the version of Plone you are currently using.</span>\n     </li>\n \n     <li>\n     <a href="@@content-controlpanel" target="_blank">\n     Decide what kind of workflow you want in your site.</a>\n-    <span class="discreet">(The default is typical for a\n+    <span class="discreet">The default is typical for a\n     public web site; if you want to use Plone as a closed intranet or extranet,\n-    you can choose a different workflow.)</span>\n+    you can choose a different workflow.</span>\n     </li>\n \n     <li>\n     By default, Plone uses a visual editor for content.\n-    <span class="discreet">(If you prefer text-based syntax and/or wiki\n+    <span class="discreet">If you prefer text-based syntax and/or wiki\n         syntax, you can change this in the\n-    <a href="@@markup-controlpanel" target="_blank">markup control panel</a>)</span>\n+    <a href="@@markup-controlpanel" target="_blank">markup control panel</a></span>\n     </li>\n \n     <li>\xe2\x80\xa6and many more settings are available in the\n@@ -92,28 +91,19 @@ solutions?\n \n <ul>\n     <li>Add your company as a <a class="link-plain"\n-        href="https://plone.com/providers/" target="_blank">Plone provider</a>.</li>\n+        href="https://plone.org/providers/" target="_blank">Plone provider</a>.</li>\n     <li>Add a <a class="link-plain"\n-        href="https://plone.com/success-stories/" target="_blank">success story</a> describing your\n+        href="https://plone.org/news/plone-news-by-category/success-story" target="_blank">success story</a> describing your\n         deployed project and customer.</li>\n </ul>\n \n <h2>Find out more about Plone</h2>\n \n <p>\n-Plone is a powerful content management system built on a rock-solid application stack written using the Python programming\n-language. More about these technologies:\n+Plone is a powerful content management system built on a rock-solid application stack.\n+Read about its technology on the <a class="link-plain" href="https://plone.org/what-is-plone" target="_blank">Plone web site</a>.\n </p>\n \n-<ul>\n-<li>The <a class="link-plain" href="https://plone.com" target="_blank">Plone open source\n-    Content Management System</a> web site for evaluators and decision makers.</li>\n-<li>The <a class="link-plain" href="https://plone.org" target="_blank">Plone community\n-    </a> web site for developers.</li>\n-<li>The <a class="link-plain" href="https://www.python.org" target="_blank">Python\n-    programming language</a> web site.</li>\n-</ul>\n-\n <h2>Support the Plone Foundation</h2>\n \n <p>\n@@ -122,12 +112,12 @@ individuals and hundreds of companies. The Plone Foundation:\n </p>\n <ul>\n     <li>\xe2\x80\xa6protects and promotes Plone.</li>\n-    <li>\xe2\x80\xa6is a registered 501(c)(3) charitable organization.</li>\n-    <li>\xe2\x80\xa6donations are tax-deductible.</li>\n+    <li>\xe2\x80\xa6is a recognized 501(c)(3) charitable organization with the United States Internal Revenue Service.</li>\n+    <li>\xe2\x80\xa6receives donations that may be tax-deductible.</li>\n     <li><a href="https://plone.org/sponsors/be-a-hero" target="_blank">Support the Foundation and help make Plone better!</a></li>\n </ul>\n \n-<p>Thanks for using our product; we hope you like it!</p>\n+<p>Thanks for using our product. We hope you like it!</p>\n \n <p>\xe2\x80\x94The Plone Team</p>\n </body>\ndiff --git a/Products/CMFPlone/browser/templates/plone-overview.pt b/Products/CMFPlone/browser/templates/plone-overview.pt\nindex 9081f153d7..dbf2b3c608 100644\n--- a/Products/CMFPlone/browser/templates/plone-overview.pt\n+++ b/Products/CMFPlone/browser/templates/plone-overview.pt\n@@ -46,7 +46,7 @@\n                 <div tal:define="outdated python: view.outdated(site);"\n                      class="mb-3 ${python: \'p-3 alert-warning\' if outdated else \'\'}">\n                     <p tal:condition="outdated" i18n:translate="">This site configuration is outdated and needs to be upgraded:</p>\n-                    <a href="#" class="btn btn-primary ${python:\'btn-lg\' if not many and not outdated  else \'\'}"\n+                    <a href="#" id="go-to-site-link" class="btn btn-primary ${python:\'btn-lg\' if not many and not outdated  else \'\'}"\n                         tal:attributes="href site/absolute_url"\n                         title="Go to your instance"\n                         i18n:attributes="title;">\n@@ -88,11 +88,7 @@\n                 <button type="submit"\n                         class="btn btn-${python:\'success\' if sites else \'primary\'}"\n                         i18n:translate="">Create a new Plone site</button>\n-                <tal:comment condition="nothing">\n-                  When we have Volto, the button above will create a Volto site,\n-                  and we need an extra button below to create a Classic Plone site.\n-                </tal:comment>\n-                <a class="btn btn-secondary"\n+                <a class="btn btn-info"\n                     i18n:translate=""\n                     tal:condition="view/has_volto"\n                     href="${action}?site_id=Plone${site_number}&amp;classic=1"\n@@ -102,6 +98,25 @@\n                     href="${action}?site_id=Plone${site_number}&amp;advanced=1"\n                     >Advanced</a>\n             </form>\n+            <br/>\n+            <p i18n:translate="help_create_plone_site_buttons_1">\n+                Starting with Plone 6, \'Create a new Plone site\' applies a\n+                profile and creates default content for the new React based\n+                default frontend Volto. You are however required to set up and run\n+                an additional frontend service to use this setup.\n+            </p>\n+            <p i18n:translate="help_create_plone_site_buttons_2">\n+                The \'Create Classic Plone site\' button creates a Plone site configured\n+                for HTML based output, as was already supported by previous Plone versions.\n+                Please consult our\n+                <a href="https://6.docs.plone.org/" title="Plone 6 developer documentation"\n+                   i18n:translate=""\n+                   i18n:name="docs_link"\n+                   i18n:attributes="title">developer documentation overview </a>\n+                for more information about differences and requirements for\n+                these frontends and possible upgrade paths from older Plone versions\n+                to Plone 6.\n+            </p>\n         </div>\n     </article>\n \ndiff --git a/Products/CMFPlone/browser/templates/plone-upgrade.pt b/Products/CMFPlone/browser/templates/plone-upgrade.pt\nindex 3d899aa99c..de42615fe6 100644\n--- a/Products/CMFPlone/browser/templates/plone-upgrade.pt\n+++ b/Products/CMFPlone/browser/templates/plone-upgrade.pt\n@@ -33,7 +33,8 @@\n             <h1>\n               <span i18n:translate="">Upgrade this site</span>\n             </h1>\n-            <h2>${context/Title} <small>(${context/getId})</small></h2>\n+            <h2>${context/Title}</h2>\n+            <p><span i18n:translate="">at path</span> <a href="${context/absolute_url}">${python:\'/\'.join(context.getPhysicalPath())}</a></p>\n             <p class="lead" i18n:translate="">\n                 More information about the upgrade procedure can be found in the documentation section of plone.org in the\n                 <a href="http://docs.plone.org/manage/upgrading"\ndiff --git a/Products/CMFPlone/browser/templates/search.pt b/Products/CMFPlone/browser/templates/search.pt\nindex 31f2004a97..2c707bb178 100644\n--- a/Products/CMFPlone/browser/templates/search.pt\n+++ b/Products/CMFPlone/browser/templates/search.pt\n@@ -198,8 +198,9 @@\n                                          use_view_action python:context.portal_registry.get(\'plone.types_use_view_action_in_listings\', []);\n                                          allowAnonymousViewAbout python:context.portal_registry[\'plone.allow_anon_views_about\'];\n                                          show_about python:not isAnon or allowAnonymousViewAbout;\n-                                         image_scale portal/@@image_scale">\n-                <ol class="searchResults list-group list-group-numbered" start="${python:request.get(\'b_start\', 0) + 1}">\n+                                         image_scale portal/@@image_scale;\n+                                         count_offset python:request.get(\'b_start\', 0)">\n+                <ol class="searchResults list-group list-group-numbered" start="${python:count_offset + 1}" style="--list-start: ${count_offset}; counter-reset: section var(--list-start, 0)">\n                   <tal:results repeat="item batch">\n                     <li tal:define="hasIcon item/getIcon" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start  fs-4">\n                       <div class="ms-2 me-auto">\ndiff --git a/Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt b/Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt\nindex d22c353640..d6f964111f 100644\n--- a/Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt\n+++ b/Products/CMFPlone/browser/templates/test_rendering_cheatsheet.pt\n@@ -15,7 +15,7 @@\n           background-color: #fff;\n         }\n \n-    </style>    \n+    </style>\n \n     <ul class="nav nav-tabs mb-3">\n       <li class="nav-item">\n@@ -36,12 +36,12 @@\n     </p>\n \n     <!--\n-      \n+\n       Todos to fix markup\n \n       Change <div class="bd-cheatsheet container-fluid bg-body"> to <div class="bd-cheatsheet bg-body">\n       Search and replace /docs/5.1 by https://getbootstrap.com/docs/5.1\n-    \n+\n     -->\n \n     <!-- Bootstrap Cheatsheet -->\n@@ -230,7 +230,7 @@\n                 <td>Cell</td>\n                 <td>Cell</td>\n               </tr>\n-              \n+\n               <tr class="table-primary">\n                 <th scope="row">Primary</th>\n                 <td>Cell</td>\n@@ -669,7 +669,7 @@\n \n           <div>\n             <div class="bd-example">\n-            \n+\n             <div class="alert alert-primary alert-dismissible fade show" role="alert">\n               A simple primary alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.\n               <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n@@ -733,7 +733,7 @@\n             </div>\n \n             <div class="bd-example">\n-            \n+\n             <span class="badge rounded-pill bg-primary">Primary</span>\n             <span class="badge rounded-pill bg-secondary">Secondary</span>\n             <span class="badge rounded-pill bg-success">Success</span>\n@@ -771,7 +771,7 @@\n \n           <div>\n             <div class="bd-example">\n-            \n+\n             <button type="button" class="btn btn-primary">Primary</button>\n             <button type="button" class="btn btn-secondary">Secondary</button>\n             <button type="button" class="btn btn-success">Success</button>\n@@ -785,7 +785,7 @@\n             </div>\n \n             <div class="bd-example">\n-            \n+\n             <button type="button" class="btn btn-outline-primary">Primary</button>\n             <button type="button" class="btn btn-outline-secondary">Secondary</button>\n             <button type="button" class="btn btn-outline-success">Success</button>\n@@ -1167,7 +1167,7 @@\n             <div class="bd-example">\n             <div class="list-group">\n               <a href="#" class="list-group-item list-group-item-action">A simple default list group item</a>\n-              \n+\n               <a href="#" class="list-group-item list-group-item-action list-group-item-primary">A simple primary list group item</a>\n               <a href="#" class="list-group-item list-group-item-action list-group-item-secondary">A simple secondary list group item</a>\n               <a href="#" class="list-group-item list-group-item-action list-group-item-success">A simple success list group item</a>\n@@ -1518,7 +1518,7 @@\n \n           <div>\n             <div class="bd-example">\n-            \n+\n             <div class="spinner-border text-primary" role="status">\n               <span class="visually-hidden">Loading...</span>\n             </div>\n@@ -1546,7 +1546,7 @@\n             </div>\n \n             <div class="bd-example">\n-            \n+\n             <div class="spinner-grow text-primary" role="status">\n               <span class="visually-hidden">Loading...</span>\n             </div>\n@@ -1692,4 +1692,4 @@\n \n </body>\n \n-</html>\n\\ No newline at end of file\n+</html>\ndiff --git a/Products/CMFPlone/browser/test_rendering.py b/Products/CMFPlone/browser/test_rendering.py\nindex b3c567068d..b4c42e9cc0 100644\n--- a/Products/CMFPlone/browser/test_rendering.py\n+++ b/Products/CMFPlone/browser/test_rendering.py\n@@ -1,4 +1,3 @@\n-# -*- coding: utf-8 -*-\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n \ndiff --git a/Products/CMFPlone/controlpanel/bbb/editing.py b/Products/CMFPlone/controlpanel/bbb/editing.py\nindex 41649f4eff..f5614a8cd9 100644\n--- a/Products/CMFPlone/controlpanel/bbb/editing.py\n+++ b/Products/CMFPlone/controlpanel/bbb/editing.py\n@@ -1,10 +1,9 @@\n+from plone.base.interfaces import IEditingSchema\n+from plone.base.interfaces import IPloneSiteRoot\n+from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n-from zope.interface import implementer\n from zope.component import getUtility\n-from plone.registry.interfaces import IRegistry\n-from plone.base.interfaces import IPloneSiteRoot\n-\n-from plone.base.interfaces import IEditingSchema\n+from zope.interface import implementer\n \n \n @implementer(IEditingSchema)\ndiff --git a/Products/CMFPlone/controlpanel/bbb/language.py b/Products/CMFPlone/controlpanel/bbb/language.py\nindex 1094d8b49c..8085b28cfb 100644\n--- a/Products/CMFPlone/controlpanel/bbb/language.py\n+++ b/Products/CMFPlone/controlpanel/bbb/language.py\n@@ -1,10 +1,9 @@\n-from zope.component import adapts\n-from zope.interface import implementer\n-from zope.component import getUtility\n-from plone.i18n.interfaces import ILanguageSchema\n from plone.base.interfaces import IPloneSiteRoot\n-\n+from plone.i18n.interfaces import ILanguageSchema\n from plone.registry.interfaces import IRegistry\n+from zope.component import adapts\n+from zope.component import getUtility\n+from zope.interface import implementer\n \n \n @implementer(ILanguageSchema)\ndiff --git a/Products/CMFPlone/controlpanel/bbb/mail.py b/Products/CMFPlone/controlpanel/bbb/mail.py\nindex 5ec1135f69..15ab993922 100644\n--- a/Products/CMFPlone/controlpanel/bbb/mail.py\n+++ b/Products/CMFPlone/controlpanel/bbb/mail.py\n@@ -1,11 +1,11 @@\n from plone.base.interfaces import IPloneSiteRoot\n from plone.base.interfaces.controlpanel import IMailSchema\n-from Products.CMFPlone.utils import safe_hasattr\n+from plone.base.utils import safe_hasattr\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\n-from zope.interface import implementer\n from zope.component.hooks import getSite\n+from zope.interface import implementer\n \n \n @implementer(IMailSchema)\ndiff --git a/Products/CMFPlone/controlpanel/bbb/navigation.py b/Products/CMFPlone/controlpanel/bbb/navigation.py\nindex 85bf7108b5..05705ccb77 100644\n--- a/Products/CMFPlone/controlpanel/bbb/navigation.py\n+++ b/Products/CMFPlone/controlpanel/bbb/navigation.py\n@@ -1,6 +1,6 @@\n-from plone.registry.interfaces import IRegistry\n from plone.base.interfaces import INavigationSchema\n from plone.base.interfaces import IPloneSiteRoot\n+from plone.registry.interfaces import IRegistry\n from zope.component import adapter\n from zope.component import getUtility\n from zope.interface import implementer\ndiff --git a/Products/CMFPlone/controlpanel/bbb/search.py b/Products/CMFPlone/controlpanel/bbb/search.py\nindex 6d0ec1f510..784a30d448 100644\n--- a/Products/CMFPlone/controlpanel/bbb/search.py\n+++ b/Products/CMFPlone/controlpanel/bbb/search.py\n@@ -3,8 +3,8 @@\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\n-from zope.interface import implementer\n from zope.component.hooks import getSite\n+from zope.interface import implementer\n \n \n @implementer(ISearchSchema)\ndiff --git a/Products/CMFPlone/controlpanel/bbb/security.py b/Products/CMFPlone/controlpanel/bbb/security.py\nindex 5870b25910..b1b48f16ae 100644\n--- a/Products/CMFPlone/controlpanel/bbb/security.py\n+++ b/Products/CMFPlone/controlpanel/bbb/security.py\n@@ -1,11 +1,11 @@\n-from Products.CMFCore.utils import getToolByName\n-from plone.base.interfaces.siteroot import IPloneSiteRoot\n from plone.base.interfaces import ISecuritySchema\n+from plone.base.interfaces.siteroot import IPloneSiteRoot\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n from zope.component import adapts\n from zope.component import getUtility\n-from zope.interface import implementer\n from zope.component.hooks import getSite\n+from zope.interface import implementer\n \n \n @implementer(ISecuritySchema)\ndiff --git a/Products/CMFPlone/controlpanel/bbb/site.py b/Products/CMFPlone/controlpanel/bbb/site.py\nindex 9098791b27..73402b154d 100644\n--- a/Products/CMFPlone/controlpanel/bbb/site.py\n+++ b/Products/CMFPlone/controlpanel/bbb/site.py\n@@ -1,10 +1,10 @@\n-from zope.schema.fieldproperty import FieldProperty\n from plone.base.interfaces import IPloneSiteRoot\n from plone.base.interfaces import ISiteSchema\n from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\n from zope.interface import implementer\n+from zope.schema.fieldproperty import FieldProperty\n \n \n @implementer(ISiteSchema)\ndiff --git a/Products/CMFPlone/controlpanel/bbb/usergroups.py b/Products/CMFPlone/controlpanel/bbb/usergroups.py\nindex ce88769f52..0c819c7136 100644\n--- a/Products/CMFPlone/controlpanel/bbb/usergroups.py\n+++ b/Products/CMFPlone/controlpanel/bbb/usergroups.py\n@@ -1,10 +1,10 @@\n+from plone.base.interfaces import IPloneSiteRoot\n+from plone.base.interfaces import IUserGroupsSettingsSchema\n+from plone.registry.interfaces import IRegistry\n from zope.component import adapts\n from zope.component import getUtility\n-from zope.interface import implementer\n from zope.component.hooks import getSite\n-from plone.registry.interfaces import IRegistry\n-from plone.base.interfaces import IUserGroupsSettingsSchema\n-from plone.base.interfaces import IPloneSiteRoot\n+from zope.interface import implementer\n \n \n @implementer(IUserGroupsSettingsSchema)\ndiff --git a/Products/CMFPlone/controlpanel/browser/actions.py b/Products/CMFPlone/controlpanel/browser/actions.py\nindex 2037fd95cb..f8bd8cd049 100644\n--- a/Products/CMFPlone/controlpanel/browser/actions.py\n+++ b/Products/CMFPlone/controlpanel/browser/actions.py\n@@ -1,9 +1,12 @@\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base.interfaces import IActionSchema\n+from plone.base.interfaces import INewActionSchema\n+from plone.base.utils import base_hasattr\n from Products.CMFCore.ActionInformation import Action\n-from Products.CMFCore.interfaces import IAction, IActionCategory\n+from Products.CMFCore.interfaces import IAction\n+from Products.CMFCore.interfaces import IActionCategory\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import IActionSchema, INewActionSchema\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import form\n@@ -12,6 +15,8 @@\n from zope.interface import implementer\n from zope.lifecycleevent import ObjectCreatedEvent\n \n+import json\n+\n \n class ActionListControlPanel(BrowserView):\n     """Control panel for the portal actions."""\n@@ -161,6 +166,22 @@ def set_position(self, value):\n \n     position = property(get_position, set_position)\n \n+    def get_modal(self):\n+        return self.context.modal\n+\n+    def set_modal(self, value):\n+        # This property may not exist yet on the context.\n+        if not self.context.hasProperty("modal"):\n+            if base_hasattr(self.context, "modal"):\n+                # We cannot define a property when an attribute with the same\n+                # name already exists.\n+                delattr(self.context, "modal")\n+            self.context._setProperty(\'modal\', value, \'string\')\n+        else:\n+            self.context._setPropValue(\'modal\', value)\n+\n+    modal = property(get_modal, set_modal)\n+\n \n class ActionControlPanel(AutoExtensibleForm, form.EditForm):\n     """A form to edit a portal action."""\ndiff --git a/Products/CMFPlone/controlpanel/browser/dateandtime.py b/Products/CMFPlone/controlpanel/browser/dateandtime.py\nindex 9eec7408bb..a5d1ab3a2f 100644\n--- a/Products/CMFPlone/controlpanel/browser/dateandtime.py\n+++ b/Products/CMFPlone/controlpanel/browser/dateandtime.py\n@@ -1,7 +1,7 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import IDateAndTimeSchema\n from plone.app.registry.browser.controlpanel import ControlPanelFormWrapper\n from plone.app.registry.browser.controlpanel import RegistryEditForm\n+from plone.base.interfaces import IDateAndTimeSchema\n+from Products.CMFPlone import PloneMessageFactory as _\n \n \n class DateAndTimeControlPanelForm(RegistryEditForm):\ndiff --git a/Products/CMFPlone/controlpanel/browser/editing.py b/Products/CMFPlone/controlpanel/browser/editing.py\nindex fef3947988..3c48883959 100644\n--- a/Products/CMFPlone/controlpanel/browser/editing.py\n+++ b/Products/CMFPlone/controlpanel/browser/editing.py\n@@ -1,6 +1,6 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import IEditingSchema\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n+from plone.base.interfaces import IEditingSchema\n from z3c.form import interfaces\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/error_log_form.py b/Products/CMFPlone/controlpanel/browser/error_log_form.py\nindex c2d2d2f495..2500840461 100644\n--- a/Products/CMFPlone/controlpanel/browser/error_log_form.py\n+++ b/Products/CMFPlone/controlpanel/browser/error_log_form.py\n@@ -1,9 +1,10 @@\n-import plone.api as api\n from DateTime import DateTime\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.utils import safe_nativestring\n from Products.Five import BrowserView\n \n+import plone.api as api\n+\n \n class ErrorLogUpdate(BrowserView):\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/filter.py b/Products/CMFPlone/controlpanel/browser/filter.py\nindex ff021fe988..9e9955eb5b 100644\n--- a/Products/CMFPlone/controlpanel/browser/filter.py\n+++ b/Products/CMFPlone/controlpanel/browser/filter.py\n@@ -1,7 +1,7 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import IFilterSchema\n from plone.z3cform import layout\n from Products.CMFPlone import PloneMessageFactory as _  # NOQA\n-from plone.base.interfaces import IFilterSchema\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n from z3c.form import button\ndiff --git a/Products/CMFPlone/controlpanel/browser/imaging.py b/Products/CMFPlone/controlpanel/browser/imaging.py\nindex 369c78a410..f1ac6b1461 100644\n--- a/Products/CMFPlone/controlpanel/browser/imaging.py\n+++ b/Products/CMFPlone/controlpanel/browser/imaging.py\n@@ -1,7 +1,8 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces.controlpanel import IImagingSchema\n from logging import getLogger\n from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces.controlpanel import IImagingSchema\n+from Products.CMFPlone import PloneMessageFactory as _\n+\n \n log = getLogger(\'Plone\')\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/language.py b/Products/CMFPlone/controlpanel/browser/language.py\nindex 4c8714ae9c..9b4085c63d 100644\n--- a/Products/CMFPlone/controlpanel/browser/language.py\n+++ b/Products/CMFPlone/controlpanel/browser/language.py\n@@ -1,7 +1,6 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n from plone.app.registry.browser import controlpanel\n-\n from plone.i18n.interfaces import ILanguageSchema\n+from Products.CMFPlone import PloneMessageFactory as _\n from Products.statusmessages.interfaces import IStatusMessage\n from z3c.form import button\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/mail.py b/Products/CMFPlone/controlpanel/browser/mail.py\nindex 6f09498c3e..44714bd389 100644\n--- a/Products/CMFPlone/controlpanel/browser/mail.py\n+++ b/Products/CMFPlone/controlpanel/browser/mail.py\n@@ -1,11 +1,11 @@\n+from logging import getLogger\n+from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces.controlpanel import IMailSchema\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces.controlpanel import IMailSchema\n from Products.MailHost.MailHost import MailHostError\n from Products.statusmessages.interfaces import IStatusMessage\n-from logging import getLogger\n-from plone.app.registry.browser import controlpanel\n-from plone.registry.interfaces import IRegistry\n from z3c.form import button\n from zope.component import getUtility\n \n@@ -13,6 +13,7 @@\n import socket\n import sys\n \n+\n log = getLogger(\'Plone\')\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/maintenance.pt b/Products/CMFPlone/controlpanel/browser/maintenance.pt\nindex ecd8f30279..5440bff8fe 100644\n--- a/Products/CMFPlone/controlpanel/browser/maintenance.pt\n+++ b/Products/CMFPlone/controlpanel/browser/maintenance.pt\n@@ -1,3 +1,4 @@\n+<!DOCTYPE html>\n <html xmlns="http://www.w3.org/1999/xhtml"\n       xmlns:metal="http://xml.zope.org/namespaces/metal"\n       xmlns:tal="http://xml.zope.org/namespaces/tal"\n@@ -27,13 +28,6 @@\n          </metal:block>\n \n          <header>\n-            <a href=""\n-                id="setup-link"\n-                tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-                i18n:translate="">\n-                Site Setup\n-            </a>\n-\n             <h1 class="documentFirstHeading"\n                 i18n:translate=""\n                 tal:condition="view/label"\n@@ -145,7 +139,7 @@\n \n             </form>\n \n-            <script type="text/javascript"\n+            <script\n                 tal:define="extra_script view/extra_script | nothing"\n                 tal:condition="extra_script"\n                 tal:content="structure extra_script">\ndiff --git a/Products/CMFPlone/controlpanel/browser/maintenance.py b/Products/CMFPlone/controlpanel/browser/maintenance.py\nindex 58d1da57fb..6e0d91c356 100644\n--- a/Products/CMFPlone/controlpanel/browser/maintenance.py\n+++ b/Products/CMFPlone/controlpanel/browser/maintenance.py\n@@ -3,11 +3,11 @@\n from Acquisition import aq_inner\n from App.config import getConfiguration\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base.interfaces import IMaintenanceSchema\n from plone.memoize.view import memoize\n from plone.protect import CheckAuthenticator\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import IMaintenanceSchema\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import button\n from z3c.form import form\n@@ -17,6 +17,7 @@\n import os\n import time\n \n+\n LIFETIME = True\n try:\n     from Lifetime import shutdown\ndiff --git a/Products/CMFPlone/controlpanel/browser/markup.py b/Products/CMFPlone/controlpanel/browser/markup.py\nindex dc97a36c8d..6c3db1588c 100644\n--- a/Products/CMFPlone/controlpanel/browser/markup.py\n+++ b/Products/CMFPlone/controlpanel/browser/markup.py\n@@ -1,6 +1,6 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import IMarkupSchema\n from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import IMarkupSchema\n+from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form.browser.checkbox import CheckBoxFieldWidget\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/navigation.py b/Products/CMFPlone/controlpanel/browser/navigation.py\nindex 8149211b00..e6a3d8b117 100644\n--- a/Products/CMFPlone/controlpanel/browser/navigation.py\n+++ b/Products/CMFPlone/controlpanel/browser/navigation.py\n@@ -1,6 +1,6 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import INavigationSchema\n from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import INavigationSchema\n+from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form.browser.checkbox import CheckBoxFieldWidget\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/overview.py b/Products/CMFPlone/controlpanel/browser/overview.py\nindex f0e275ce5b..ab5be04ade 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.py\n+++ b/Products/CMFPlone/controlpanel/browser/overview.py\n@@ -1,19 +1,20 @@\n from AccessControl import getSecurityManager\n from Acquisition import aq_inner\n from App.config import getConfiguration\n+from plone.app.registry.browser import controlpanel\n from plone.base.interfaces.controlpanel import IMailSchema\n+from plone.memoize.instance import memoize\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.permissions import ManagePortal\n from Products.CMFCore.utils import getToolByName\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-from plone.app.registry.browser import controlpanel\n-from plone.memoize.instance import memoize\n-from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\n from ZPublisher.HTTPRequest import WSGIRequest\n \n import pkg_resources\n import warnings\n \n+\n try:\n     import plone.app.event\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/quickinstaller.py b/Products/CMFPlone/controlpanel/browser/quickinstaller.py\nindex 3a8b574afb..9d4533a3d8 100644\n--- a/Products/CMFPlone/controlpanel/browser/quickinstaller.py\n+++ b/Products/CMFPlone/controlpanel/browser/quickinstaller.py\n@@ -1,13 +1,14 @@\n+from plone.base.interfaces import INonInstallable\n+from plone.memoize import view\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import INonInstallable\n from Products.Five.browser import BrowserView\n from Products.GenericSetup import EXTENSION\n from Products.GenericSetup.tool import UNKNOWN\n from Products.statusmessages.interfaces import IStatusMessage\n-from plone.memoize import view\n from zope.component import getAllUtilitiesRegisteredFor\n from zope.i18n import translate\n+\n import logging\n import pkg_resources\n import transaction\ndiff --git a/Products/CMFPlone/controlpanel/browser/redirects.py b/Products/CMFPlone/controlpanel/browser/redirects.py\nindex e1488abf06..7216c4520c 100644\n--- a/Products/CMFPlone/controlpanel/browser/redirects.py\n+++ b/Products/CMFPlone/controlpanel/browser/redirects.py\n@@ -20,6 +20,7 @@\n import logging\n import tempfile\n \n+\n try:\n     # use this to stream csv data if we can\n     from ZPublisher.Iterators import filestream_iterator\ndiff --git a/Products/CMFPlone/controlpanel/browser/relations.py b/Products/CMFPlone/controlpanel/browser/relations.py\nindex 97a3ce2038..843623f4aa 100644\n--- a/Products/CMFPlone/controlpanel/browser/relations.py\n+++ b/Products/CMFPlone/controlpanel/browser/relations.py\n@@ -15,6 +15,7 @@\n \n import logging\n \n+\n logger = logging.getLogger(__name__)\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/relations_inspect.pt b/Products/CMFPlone/controlpanel/browser/relations_inspect.pt\nindex c1601d78e0..e1187c5460 100644\n--- a/Products/CMFPlone/controlpanel/browser/relations_inspect.pt\n+++ b/Products/CMFPlone/controlpanel/browser/relations_inspect.pt\n@@ -13,12 +13,6 @@\n       tal:define="inspect_backrelation python: view.inspect_backrelation;\n                   relation python: view.relation;">\n \n-      <a id="setup-link" class="link-parent"\n-         tal:attributes="href string:$portal_url/@@overview-controlpanel"\n-         i18n:translate="">\n-          Site Setup\n-      </a>\n-\n     <header>\n       <h1 class="documentFirstHeading"\n           tal:condition="python: not inspect_backrelation">\ndiff --git a/Products/CMFPlone/controlpanel/browser/search.py b/Products/CMFPlone/controlpanel/browser/search.py\nindex de2fc54a14..8d60d4bc3e 100644\n--- a/Products/CMFPlone/controlpanel/browser/search.py\n+++ b/Products/CMFPlone/controlpanel/browser/search.py\n@@ -1,7 +1,7 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import ISearchSchema\n-from Products.CMFPlone.controlpanel.widgets import ReverseCheckBoxFieldWidget\n from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import ISearchSchema\n+from Products.CMFPlone import PloneMessageFactory as _\n+from z3c.form.browser.checkbox import CheckBoxFieldWidget\n from zope.component import queryUtility\n from zope.schema.interfaces import IVocabularyFactory\n \n@@ -16,7 +16,7 @@ class SearchControlPanelForm(controlpanel.RegistryEditForm):\n     def updateFields(self):\n         super().updateFields()\n         self.fields[\'types_not_searched\'].widgetFactory = \\\n-            ReverseCheckBoxFieldWidget\n+            CheckBoxFieldWidget\n \n     def updateWidgets(self):\n         super().updateWidgets()\ndiff --git a/Products/CMFPlone/controlpanel/browser/security.py b/Products/CMFPlone/controlpanel/browser/security.py\nindex ae52e9ac63..3b45e30195 100644\n--- a/Products/CMFPlone/controlpanel/browser/security.py\n+++ b/Products/CMFPlone/controlpanel/browser/security.py\n@@ -1,15 +1,16 @@\n from Acquisition import aq_inner\n+from collections import defaultdict\n+from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import ISecuritySchema\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.controlpanel.utils import migrate_to_email_login\n from Products.CMFPlone.controlpanel.utils import migrate_from_email_login\n-from plone.base.interfaces import ISecuritySchema\n+from Products.CMFPlone.controlpanel.utils import migrate_to_email_login\n from Products.Five.browser import BrowserView\n-from collections import defaultdict\n-from plone.app.registry.browser import controlpanel\n \n import logging\n \n+\n logger = logging.getLogger(\'Products.CMFPlone\')\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/site.py b/Products/CMFPlone/controlpanel/browser/site.py\nindex 2bd9e99418..f9412964f0 100644\n--- a/Products/CMFPlone/controlpanel/browser/site.py\n+++ b/Products/CMFPlone/controlpanel/browser/site.py\n@@ -1,7 +1,7 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import ISiteSchema\n from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import ISiteSchema\n from plone.formwidget.namedfile.widget import NamedImageFieldWidget\n+from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form import interfaces\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/socialmedia.py b/Products/CMFPlone/controlpanel/browser/socialmedia.py\nindex dc48368a0e..9704671325 100644\n--- a/Products/CMFPlone/controlpanel/browser/socialmedia.py\n+++ b/Products/CMFPlone/controlpanel/browser/socialmedia.py\n@@ -1,6 +1,6 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from plone.base.interfaces import ISocialMediaSchema\n from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import ISocialMediaSchema\n+from Products.CMFPlone import PloneMessageFactory as _\n \n \n class SocialControlPanelForm(controlpanel.RegistryEditForm):\ndiff --git a/Products/CMFPlone/controlpanel/browser/syndication.py b/Products/CMFPlone/controlpanel/browser/syndication.py\nindex be92de8e60..452ec185da 100644\n--- a/Products/CMFPlone/controlpanel/browser/syndication.py\n+++ b/Products/CMFPlone/controlpanel/browser/syndication.py\n@@ -1,10 +1,10 @@\n-from Products.CMFCore.utils import getToolByName\n-from zope.i18nmessageid import MessageFactory\n-from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from plone.app.registry.browser import controlpanel\n-from z3c.form import button\n-from Products.statusmessages.interfaces import IStatusMessage\n from plone.app.z3cform.widget import SelectFieldWidget\n+from plone.base.interfaces.syndication import ISiteSyndicationSettings\n+from Products.CMFCore.utils import getToolByName\n+from Products.statusmessages.interfaces import IStatusMessage\n+from z3c.form import button\n+from zope.i18nmessageid import MessageFactory\n \n \n _ = MessageFactory(\'plone\')\ndiff --git a/Products/CMFPlone/controlpanel/browser/tinymce.py b/Products/CMFPlone/controlpanel/browser/tinymce.py\nindex e70c93525d..c2d30b50c0 100644\n--- a/Products/CMFPlone/controlpanel/browser/tinymce.py\n+++ b/Products/CMFPlone/controlpanel/browser/tinymce.py\n@@ -1,11 +1,11 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n+from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import ITinyMCEAdvancedSchema\n from plone.base.interfaces import ITinyMCELayoutSchema\n-from plone.base.interfaces import ITinyMCESpellCheckerSchema\n+from plone.base.interfaces import ITinyMCEPluginSchema\n from plone.base.interfaces import ITinyMCEResourceTypesSchema\n-from plone.base.interfaces import ITinyMCEAdvancedSchema\n from plone.base.interfaces import ITinyMCESchema\n-from plone.base.interfaces import ITinyMCEPluginSchema\n-from plone.app.registry.browser import controlpanel\n+from plone.base.interfaces import ITinyMCESpellCheckerSchema\n+from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form import field\n from z3c.form import group\n from z3c.form.browser.checkbox import CheckBoxFieldWidget\ndiff --git a/Products/CMFPlone/controlpanel/browser/types.py b/Products/CMFPlone/controlpanel/browser/types.py\nindex e534c0318c..41a2f62bb0 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.py\n+++ b/Products/CMFPlone/controlpanel/browser/types.py\n@@ -1,24 +1,24 @@\n from Acquisition import aq_inner\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.controlpanel.events import ConfigurationChangedEvent\n-from plone.base.interfaces import ISearchSchema\n-from plone.base.interfaces import ITypesSchema\n-from plone.base.utils import safe_text\n-from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-from Products.statusmessages.interfaces import IStatusMessage\n from operator import itemgetter\n from plone.app.workflow.remap import remap_workflow\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base.interfaces import ISearchSchema\n+from plone.base.interfaces import ITypesSchema\n+from plone.base.utils import safe_text\n+from plone.dexterity.interfaces import IDexterityFTI\n from plone.memoize.instance import memoize\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.controlpanel.events import ConfigurationChangedEvent\n+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n+from Products.statusmessages.interfaces import IStatusMessage\n from z3c.form import button\n from z3c.form import form\n from zope.component import getUtility\n from zope.event import notify\n from zope.i18n import translate\n from zope.schema.interfaces import IVocabularyFactory\n-from plone.dexterity.interfaces import IDexterityFTI\n \n \n def format_description(text, request=None):\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups.py b/Products/CMFPlone/controlpanel/browser/usergroups.py\nindex 2819742a47..fbe30201c8 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups.py\n@@ -1,22 +1,21 @@\n-from Products.CMFCore.permissions import ManagePortal\n-from ZTUtils import make_query\n-from itertools import chain\n+from AccessControl import getSecurityManager\n from Acquisition import aq_inner\n-from Products.CMFPlone.utils import normalizeString\n-from zope.component import getAdapter\n+from itertools import chain\n+from plone.autoform.form import AutoExtensibleForm\n from plone.base.interfaces import ISecuritySchema\n-from zope.component import getMultiAdapter\n-from AccessControl import getSecurityManager\n-from Products.Five.browser import BrowserView\n-from Products.CMFCore.utils import getToolByName\n-from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n+from plone.base.interfaces import IUserGroupsSettingsSchema\n from plone.z3cform import layout\n-from plone.autoform.form import AutoExtensibleForm\n+from Products.CMFCore.permissions import ManagePortal\n+from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import PloneMessageFactory as _\n-from z3c.form import form\n-\n-from plone.base.interfaces import IUserGroupsSettingsSchema\n+from Products.CMFPlone.utils import normalizeString\n+from Products.Five.browser import BrowserView\n+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import button\n+from z3c.form import form\n+from zope.component import getAdapter\n+from zope.component import getMultiAdapter\n+from ZTUtils import make_query\n \n \n class UserGroupsSettingsControlPanel(AutoExtensibleForm, form.EditForm):\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py b/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py\nindex 0e405fac45..a5cd6c9110 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py\n@@ -1,9 +1,10 @@\n from Acquisition import aq_inner\n-from Products.CMFPlone.controlpanel.browser.usergroups import \\\n-    UsersGroupsControlPanelView\n from plone.protect import CheckAuthenticator\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.controlpanel.browser.usergroups import (\n+    UsersGroupsControlPanelView,\n+)\n from Products.statusmessages.interfaces import IStatusMessage\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\nindex b2ba666721..9dad09d7d0 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\n@@ -1,9 +1,10 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from zExceptions import Forbidden\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.controlpanel.browser.usergroups import \\\n-    UsersGroupsControlPanelView\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.controlpanel.browser.usergroups import (\n+    UsersGroupsControlPanelView,\n+)\n from Products.CMFPlone.utils import normalizeString\n+from zExceptions import Forbidden\n \n \n class GroupMembershipControlPanel(UsersGroupsControlPanelView):\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt b/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt\nindex 2bab236cfb..8fa939eafc 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.pt\n@@ -30,7 +30,7 @@\n             Portal status message\n         </div>\n \n-        <div class="text-muted mt-2">\n+        <div class="lead">\n             <span tal:omit-tag=""\n                     i18n:translate="description_groups_management">\n                 Groups are logical collections of users, such as\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py b/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py\nindex 276ca39f40..2ea0089388 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py\n@@ -1,13 +1,14 @@\n-from itertools import chain\n from Acquisition import aq_inner\n-from Products.CMFPlone.controlpanel.browser.usergroups import \\\n-    UsersGroupsControlPanelView\n-from Products.PluggableAuthService.interfaces.plugins import IRolesPlugin\n+from itertools import chain\n from plone.protect import CheckAuthenticator\n-from zope.component import getMultiAdapter\n-from zExceptions import Forbidden\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.controlpanel.browser.usergroups import (\n+    UsersGroupsControlPanelView,\n+)\n+from Products.PluggableAuthService.interfaces.plugins import IRolesPlugin\n+from zExceptions import Forbidden\n+from zope.component import getMultiAdapter\n \n \n class GroupsOverviewControlPanel(UsersGroupsControlPanelView):\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py b/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py\nindex 5e46e792af..0089076bdc 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py\n@@ -1,9 +1,10 @@\n-from Products.CMFPlone import PloneMessageFactory as _\n-from zExceptions import Forbidden\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.controlpanel.browser.usergroups import \\\n-    UsersGroupsControlPanelView\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.controlpanel.browser.usergroups import (\n+    UsersGroupsControlPanelView,\n+)\n from Products.CMFPlone.utils import normalizeString\n+from zExceptions import Forbidden\n \n \n class UserMembershipControlPanel(UsersGroupsControlPanelView):\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py b/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py\nindex 2a4a97d278..c4e08cdbb6 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py\n@@ -1,21 +1,21 @@\n from Acquisition import aq_inner\n-from zExceptions import Forbidden\n from itertools import chain\n-\n-from Products.PluggableAuthService.interfaces.plugins import IRolesPlugin\n-from zope.component import getUtility\n from plone.protect import CheckAuthenticator\n-from zope.component import getMultiAdapter\n from Products.CMFCore.interfaces import ISiteRoot\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFCore.utils import getToolByName\n-\n+from Products.CMFPlone import PloneMessageFactory as _\n+from Products.CMFPlone.controlpanel.browser.usergroups import (\n+    UsersGroupsControlPanelView,\n+)\n from Products.CMFPlone.utils import normalizeString\n-from Products.CMFPlone.controlpanel.browser.usergroups import \\\n-    UsersGroupsControlPanelView\n+from Products.PluggableAuthService.interfaces.plugins import IRolesPlugin\n+from zExceptions import Forbidden\n+from zope.component import getMultiAdapter\n+from zope.component import getUtility\n \n import logging\n \n+\n logger = logging.getLogger(\'Products.CMFPlone\')\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_actions.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_actions.py\nindex 98202efb60..4261a8e4e8 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_actions.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_actions.py\n@@ -1,6 +1,7 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py\nindex a1ca337498..4cb4c82690 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_editing_adapter.py\n@@ -1,10 +1,11 @@\n-from plone.base.interfaces import IEditingSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n+from plone.base.interfaces import IEditingSchema\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py\nindex ef03ef4699..1558e1d814 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_filter_adapter.py\n@@ -1,10 +1,11 @@\n-from plone.base.interfaces import IFilterSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n+from plone.base.interfaces import IFilterSchema\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_language_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_language_adapter.py\nindex ff02c08697..724b1f20f4 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_language_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_language_adapter.py\n@@ -1,11 +1,10 @@\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-\n-from plone.app.testing import TEST_USER_ID, setRoles\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from plone.i18n.interfaces import ILanguageSchema\n from plone.registry.interfaces import IRegistry\n-from zope.component import getUtility\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n+from zope.component import getUtility\n \n import unittest\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py\nindex d936b92091..ecf2feb855 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_mail_adapter.py\n@@ -1,10 +1,10 @@\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from plone.base.interfaces import IMailSchema\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID, setRoles\n from plone.registry.interfaces import IRegistry\n-from zope.component import getUtility\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n+from zope.component import getUtility\n \n import unittest\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py\nindex c002629e18..ab48904965 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_maintenance_adapter.py\n@@ -1,10 +1,11 @@\n-from plone.base.interfaces import IMaintenanceSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n+from plone.base.interfaces import IMaintenanceSchema\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py\nindex f5f3c8135a..7ec8e09c4e 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_markup_adapter.py\n@@ -1,10 +1,12 @@\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from plone.base.interfaces import IMarkupSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from zope.component import getAdapter\n from zope.component import getUtility\n+\n import unittest\n-from plone.app.testing import TEST_USER_ID, setRoles\n-from zope.component import getAdapter\n \n \n class MarkupControlPanelAdapterTest(unittest.TestCase):\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py\nindex fdec408974..819c4a8ebb 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_navigation_adapter.py\n@@ -1,9 +1,11 @@\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from plone.base.interfaces import INavigationSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID, setRoles\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py\nindex c2bf2ecd91..28905f2dec 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_search_adapter.py\n@@ -1,9 +1,11 @@\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from plone.base.interfaces import ISearchSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID, setRoles\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py\nindex a98e190663..8be6d76154 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_security_adapter.py\n@@ -1,8 +1,7 @@\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.base.interfaces import ISecuritySchema\n-from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n+from plone.base.interfaces import ISecuritySchema\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n \n import unittest\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py\nindex 443f5f20c8..5901222888 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_site_adapter.py\n@@ -1,10 +1,11 @@\n-from plone.base.interfaces import ISiteSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n+from plone.base.interfaces import ISiteSchema\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py\nindex 2f7229a9ad..7140b64110 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_bbb_usergroups_adapter.py\n@@ -1,15 +1,13 @@\n from plone.app.testing import setRoles\n-from plone.base.interfaces import IUserGroupsSettingsSchema\n-from zope.component import getAdapter\n from plone.app.testing import TEST_USER_ID\n+from plone.base.interfaces import IUserGroupsSettingsSchema\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from zope.component import getAdapter\n from zope.component import getUtility\n \n import unittest\n \n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-\n \n class UserGroupsControlPanelAdapterTest(unittest.TestCase):\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py\nindex 3b0be82fb7..2157771f56 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_editing.py\n@@ -1,11 +1,12 @@\n-from plone.base.interfaces import IEditingSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.app.linkintegrity.utils import linkintegrity_enabled\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.base.interfaces import IEditingSchema\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py\nindex ae797cd070..2ec0ca1b1b 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py\n@@ -1,11 +1,11 @@\n-import unittest\n-\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getMultiAdapter\n \n+import unittest\n+\n \n class ErrorLogControlPanelFunctionalTest(unittest.TestCase):\n     """Test for Controlpanel Error Log\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py\nindex 5ede8606b1..60eb00aaf8 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_filter.py\n@@ -1,12 +1,14 @@\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.base.interfaces import IFilterSchema\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n from Products.CMFCore.utils import getToolByName\n-from plone.base.interfaces import IFilterSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from Products.PortalTransforms.data import datastream\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_language.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_language.py\nindex cff39080e8..35ebc885fc 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_language.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_language.py\n@@ -1,14 +1,12 @@\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.i18n.interfaces import ILanguageSchema\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n-\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n \n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-\n import unittest\n import webtest\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py\nindex c575f7f438..23b62dec2f 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_mail.py\n@@ -1,14 +1,12 @@\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.base.interfaces import IMailSchema\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n-\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n \n-from plone.base.interfaces import IMailSchema\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_maintenance.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_maintenance.py\nindex 868bf1fe6c..c8add25703 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_maintenance.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_maintenance.py\n@@ -1,11 +1,13 @@\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+from App.ApplicationManager import ApplicationManager\n+from pkg_resources import get_distribution\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n from plone.testing.zope import Browser\n from plone.testing.zope import login\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n import unittest\n-from App.ApplicationManager import ApplicationManager\n-from pkg_resources import get_distribution\n+\n \n has_zope4 = get_distribution(\'Zope2\').version.startswith(\'4\')\n \n@@ -26,14 +28,14 @@ def setUp(self):\n         self.browser.handleErrors = False\n         # we have to create a user on the zope root. this just does not work\n         # with plone.app.testing and TEST_USER or SITE_OWNER\n-        self.app.acl_users.userFolderAddUser(\'app\', \'secret\', [\'Manager\'], [])\n+        self.app.acl_users.userFolderAddUser(\'app\', TEST_USER_PASSWORD, [\'Manager\'], [])\n         login(self.app[\'acl_users\'], \'app\')\n \n         import transaction\n         transaction.commit()\n         self.browser.addHeader(\n             \'Authorization\',\n-            \'Basic {}:{}\'.format(\'app\', \'secret\')\n+            \'Basic {}:{}\'.format(\'app\', TEST_USER_PASSWORD)\n         )\n \n         self.site_administrator_browser = Browser(self.app)\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py\nindex cd34913f44..8436d3fb3f 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_markup.py\n@@ -1,10 +1,12 @@\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.base.interfaces import IMarkupSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py\nindex 66e79d0d0e..93f614c828 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_navigation.py\n@@ -1,10 +1,12 @@\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.base.interfaces import INavigationSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py\nindex abf44c5cdd..ffc779744c 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_redirection.py\n@@ -3,10 +3,10 @@\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.base.batch import Batch\n+from plone.base.utils import safe_bytes\n from plone.testing.zope import Browser\n from Products.CMFPlone.controlpanel.browser.redirects import RedirectionSet\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from plone.base.utils import safe_bytes\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n \n@@ -139,8 +139,8 @@ def test_redirection_controlpanel_set(self):\n         now = DateTime(\'2022-02-03\')\n         for i in range(1000):\n             storage.add(\n-                \'{:s}/foo/{:s}\'.format(portal_path, str(i)),\n-                \'{:s}/bar/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo/{str(i):s}\',\n+                f\'{portal_path:s}/bar/{str(i):s}\',\n                 now=now,\n             )\n         redirects = RedirectionSet()\n@@ -182,8 +182,8 @@ def test_redirection_controlpanel_batching(self):\n         portal_path = self.layer[\'portal\'].absolute_url_path()\n         for i in range(1000):\n             storage.add(\n-                \'{:s}/foo/{:s}\'.format(portal_path, str(i)),\n-                \'{:s}/bar/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo/{str(i):s}\',\n+                f\'{portal_path:s}/bar/{str(i):s}\',\n             )\n         view = getMultiAdapter(\n             (self.layer[\'portal\'], self.layer[\'request\']),\n@@ -225,13 +225,13 @@ def test_redirection_controlpanel_filtering(self):\n         portal_path = self.layer[\'portal\'].absolute_url_path()\n         for i in range(1000):\n             storage.add(\n-                \'{:s}/foo1/{:s}\'.format(portal_path, str(i)),\n-                \'{:s}/bar/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo1/{str(i):s}\',\n+                f\'{portal_path:s}/bar/{str(i):s}\',\n             )\n         for i in range(1000):\n             storage.add(\n-                \'{:s}/foo2/{:s}\'.format(portal_path, str(i)),\n-                \'{:s}/bar/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo2/{str(i):s}\',\n+                f\'{portal_path:s}/bar/{str(i):s}\',\n             )\n \n         redirects = RedirectionSet()\n@@ -282,14 +282,14 @@ def test_redirection_controlpanel_filter_manual(self):\n         portal_path = self.layer[\'portal\'].absolute_url_path()\n         for i in range(100):\n             storage.add(\n-                \'{:s}/foo/{:s}\'.format(portal_path, str(i)),\n-                \'{:s}/bar/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo/{str(i):s}\',\n+                f\'{portal_path:s}/bar/{str(i):s}\',\n                 manual=False,\n             )\n         for i in range(100, 300):\n             storage.add(\n-                \'{:s}/foo/{:s}\'.format(portal_path, str(i)),\n-                \'{:s}/bar/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo/{str(i):s}\',\n+                f\'{portal_path:s}/bar/{str(i):s}\',\n                 manual=True,\n             )\n \n@@ -333,8 +333,8 @@ def test_redirection_controlpanel_filter_date(self):\n         time0 = DateTime(\'2001-01-01\')\n         for i in range(400):\n             storage.add(\n-                \'{:s}/foo/{:s}\'.format(portal_path, str(i)),\n-                \'{:s}/bar/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo/{str(i):s}\',\n+                f\'{portal_path:s}/bar/{str(i):s}\',\n                 now=time0 + i,\n             )\n \n@@ -471,8 +471,8 @@ def test_manage_aliases_remove(self):\n         self.assertEqual(storage.get(\'/plone/alias3\'), \'/plone/test-folder\')\n \n     def test_manage_aliases_navigation_root(self):\n-        from zope.interface import alsoProvides\n         from plone.app.layout.navigation.interfaces import INavigationRoot\n+        from zope.interface import alsoProvides\n \n         storage = getUtility(IRedirectionStorage)\n         folder = self.portal[\'test-folder\']\n@@ -802,8 +802,8 @@ def test_download_bigger(self):\n         now = DateTime(\'2019/01/27 10:00:00 GMT-3\')\n         for i in range(2000):\n             storage.add(\n-                \'{:s}/foo/{:s}\'.format(portal_path, str(i)),\n-                \'{:s}/bar/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo/{str(i):s}\',\n+                f\'{portal_path:s}/bar/{str(i):s}\',\n                 now=now,\n                 manual=True,\n             )\n@@ -839,7 +839,7 @@ def test_download_upload(self):\n         now = DateTime(\'2019/01/27 10:00:00 GMT-3\')\n         for i in range(10):\n             storage.add(\n-                \'{:s}/foo/{:s}\'.format(portal_path, str(i)),\n+                f\'{portal_path:s}/foo/{str(i):s}\',\n                 f\'{portal_path:s}/test-folder\',\n                 now=now,\n                 manual=True,\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py\nindex dd9a2b76ed..258a2aa9f9 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_relations.py\n@@ -1,4 +1,5 @@\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.testing.zope import Browser\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n \n@@ -11,13 +12,14 @@ class RelationsControlPanelFunctionalTest(unittest.TestCase):\n     layer = PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n \n     def _add_broken_relation(self):\n-        import transaction\n         from persistent.list import PersistentList\n         from z3c.relationfield import RelationValue\n         from zope.component import getUtility\n         from zope.intid.interfaces import IIntIds\n         from zope.lifecycleevent import modified\n \n+        import transaction\n+\n         self.portal.invokeFactory("Document", id="doc1", title="doc1")\n         doc1 = self.portal["doc1"]\n         self.portal.invokeFactory("Document", id="doc2", title="doc2")\n@@ -42,7 +44,6 @@ def setUp(self):\n \n     def test_inspect_realtions_form_action(self):\n         from io import StringIO\n-\n         from lxml import etree\n \n         self.browser.open(f"{self.portal_url}/@@inspect-relations")\n@@ -55,7 +56,6 @@ def test_inspect_realtions_form_action(self):\n \n     def test_rebuild_relations_links(self):\n         from io import StringIO\n-\n         from lxml import etree\n \n         # first we need a broken relation\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\nindex 3b2d7d17c0..ebcf1f3b02 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\n@@ -1,10 +1,12 @@\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.base.interfaces import ISearchSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \n@@ -69,5 +71,5 @@ def test_types_not_searched(self):\n \n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(ISearchSchema, prefix="plone")\n-        self.assertFalse(\'Discussion Item\' in settings.types_not_searched)\n-        self.assertFalse(\'News Item Item\' in settings.types_not_searched)\n+        self.assertTrue(\'Discussion Item\' in settings.types_not_searched)\n+        self.assertTrue(\'News Item\' in settings.types_not_searched)\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py\nindex 89c57b5113..fb1f64ecf9 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_security.py\n@@ -1,9 +1,9 @@\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.base.interfaces import ISecuritySchema\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getUtility\n \n import unittest\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py\nindex e5cf80998d..3bf8436942 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_site.py\n@@ -1,14 +1,16 @@\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n+from io import BytesIO\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.base.interfaces import ISiteSchema\n from plone.registry.interfaces import IRegistry\n from plone.testing.zope import Browser\n-from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from io import BytesIO\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n \n import unittest\n \n+\n # Red pixel with filename pixel.png\n SITE_LOGO_BASE64 = b\'filenameb64:cGl4ZWwucG5n;datab64:iVBORw0KGgoAAAANSUhEUgA\'\\\n                    b\'AAAEAAAABCAIAAACQd1PeAAAADElEQVQI12P4z8AAAAMBAQAY3Y2wAAA\'\\\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_syndication.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_syndication.py\nindex c014f9dfe2..60da102499 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_syndication.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_syndication.py\n@@ -1,7 +1,9 @@\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.testing.zope import Browser\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getMultiAdapter\n+\n import transaction\n import unittest\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\nindex ae275bde1a..0cf2a5624f 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n@@ -1,6 +1,8 @@\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\nindex 4a24a758fe..ad954f6288 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\n@@ -1,13 +1,12 @@\n-from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD\n-from Products.CMFCore.utils import getToolByName\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.testing.zope import Browser\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from Products.CMFPlone.utils import normalizeString\n \n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n-\n-import unittest\n import transaction\n+import unittest\n \n \n class UserGroupsControlPanelFunctionalTest(unittest.TestCase):\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\nindex 9b567ea24c..d2803c0cde 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\n@@ -21,9 +21,9 @@ class TestSiteAdministratorRoleFunctional(unittest.TestCase):\n \n     def _generateUsers(self):\n         rtool = getToolByName(self.portal, \'portal_registration\')\n-        rtool.addMember(\'DIispfuF\', \'secret\', [\'Member\'], [])\n-        rtool.addMember(\'siteadmin\', \'secret\', [\'Site Administrator\'], [])\n-        rtool.addMember(\'root\', \'secret\', [\'Manager\'], [])\n+        rtool.addMember(\'DIispfuF\', TEST_USER_PASSWORD, [\'Member\'], [])\n+        rtool.addMember(\'siteadmin\', TEST_USER_PASSWORD, [\'Site Administrator\'], [])\n+        rtool.addMember(\'root\', TEST_USER_PASSWORD, [\'Manager\'], [])\n \n     def setUp(self):\n         self.app = self.layer[\'app\']\n@@ -108,7 +108,7 @@ def testManagerCanDelegateManagerRoleForUsers(self):\n     def testNonManagersCannotDelegateManagerRoleForUsers(self):\n         # a user without the Manager role cannot delegate the Manager role\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n         self.browser.open(self.usergroups_url)\n         form = {\n             \'_authenticator\': self._get_authenticator(),\n@@ -127,7 +127,7 @@ def testNonManagersCanEditOtherRolesOfUsersWithManagerRole(self):\n         roles = self.portal.acl_users.getUserById(\'root\').getRoles()\n         self.assertEqual([\'Manager\', \'Authenticated\'], roles)\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n         self.browser.open(self.usergroups_url)\n         form = {\n             \'_authenticator\': self._get_authenticator(),\n@@ -143,7 +143,7 @@ def testNonManagersCanEditOtherRolesOfUsersWithManagerRole(self):\n \n     def testGroupManagerRoleCheckboxIsDisabledForNonManagers(self):\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n         self.browser.open(self.groups_url)\n         contents = self._simplify_white_space(self.browser.contents)\n         self.assertTrue(\'<input type="checkbox" class="noborder" \'\n@@ -173,7 +173,7 @@ def testManagerCanDelegateManagerRoleForGroups(self):\n     def testNonManagersCannotDelegateManagerRoleForGroups(self):\n         # a user without the Manager role cannot delegate the Manager role\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n \n         self.browser.open(self.groups_url)\n         form = {\n@@ -191,7 +191,7 @@ def testNonManagersCannotDelegateManagerRoleForGroups(self):\n \n     def testNonManagersCanEditOtherRolesOfGroupsWithManagerRole(self):\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n \n         roles = self.portal.acl_users.getUserById(\'root\').getRoles()\n         self.assertEqual([\'Manager\', \'Authenticated\'], roles)\n@@ -210,7 +210,7 @@ def testNonManagersCanEditOtherRolesOfGroupsWithManagerRole(self):\n \n     def test_usergroup_usermembership_blocks_escalation(self):\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n \n         # groups granting the Manager role shouldn\'t show as a valid option to\n         # add\n@@ -241,7 +241,7 @@ def test_usergroup_groupmembership_blocks_escalation(self):\n         # should not show section to add users for groups granting the Manager\n         # role\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n \n         self.browser.open(\n             self.portal_url + \'/@@usergroup-groupmembership?groupname=Administrators\'\n@@ -268,7 +268,7 @@ def test_user_registration_form_blocks_escalation(self):\n         # groups granting the Manager role should not be available for\n         # selection\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n         self.browser.open(self.portal_url + \'/@@new-user\')\n         contents = self._simplify_white_space(self.browser.contents)\n         self.assertFalse(\n@@ -281,8 +281,8 @@ def test_user_registration_form_blocks_escalation(self):\n             \'_authenticator\': self._get_authenticator(),\n             \'form.widgets.username\': \'newuser\',\n             \'form.widgets.email\': \'newuser@example.com\',\n-            \'form.widgets.password\': \'secret\',\n-            \'form.widgets.password_ctl\': \'secret\',\n+            \'form.widgets.password\': TEST_USER_PASSWORD,\n+            \'form.widgets.password_ctl\': TEST_USER_PASSWORD,\n             \'form.widgets.groups:list\': \'Administrators\',\n             \'form.widgets.groups-empty-marker\': \'1\',\n             \'form.buttons.register\': \'Register\',\n@@ -297,7 +297,7 @@ def test_users_overview_blocks_deleting_managers(self):\n         # a user without the Manager role cannot delete a user with the\n         # Manager role\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n \n         self.browser.open(self.usergroups_url)\n         contents = self._simplify_white_space(self.browser.contents)\n@@ -324,7 +324,7 @@ def test_groups_overview_blocks_deleting_managers(self):\n         # a user without the Manager role cannot delete a group with the\n         # Manager role\n         self.browser.addHeader(\n-            \'Authorization\', \'Basic siteadmin:secret\')\n+            \'Authorization\', f\'Basic siteadmin:{TEST_USER_PASSWORD}\')\n \n         self.browser.open(self.groups_url)\n         contents = self._simplify_white_space(self.browser.contents)\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py\nindex 9a86dee7be..37c6e41dbd 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_dateandtime.py\n@@ -1,7 +1,8 @@\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from plone.base.interfaces import IDateAndTimeSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID\n-from plone.app.testing import setRoles\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_doctest.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_doctest.py\nindex 03926c62ca..764cb3781d 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_doctest.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_doctest.py\n@@ -1,7 +1,8 @@\n """Functional Doctests for control panel.\n """\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.testing import layered\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n import doctest\n import pprint\n import unittest\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py\nindex 037d4b166e..1d86e488b7 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_editing.py\n@@ -1,9 +1,10 @@\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import IEditingSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py\nindex 0e053ff69f..eba74102c5 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_events.py\n@@ -1,9 +1,8 @@\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from Products.CMFCore.utils import getToolByName\n-from plone.base.interfaces import ISecuritySchema\n-from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n+from plone.base.interfaces import ISecuritySchema\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getAdapter\n \n import unittest\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py\nindex 44b5fcd01f..1970bb4cf7 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_filter.py\n@@ -1,9 +1,10 @@\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import IFilterSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_installer.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_installer.py\nindex 5ebfd94772..b2d95e779a 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_installer.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_installer.py\n@@ -32,8 +32,7 @@ def test_addons_in_controlpanel(self):\n         ])\n \n     def test_installer_view(self):\n-        from Products.CMFPlone.controlpanel.browser.quickinstaller import \\\n-            InstallerView\n+        from Products.CMFPlone.controlpanel.browser.quickinstaller import InstallerView\n         view = getMultiAdapter((self.portal, self.portal.REQUEST),\n                                name="installer")\n         self.assertTrue(isinstance(view, InstallerView))\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_language.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_language.py\nindex b5277dd0e3..41e509718c 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_language.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_language.py\n@@ -1,11 +1,9 @@\n-from zope.component import getMultiAdapter\n-from zope.component import getUtility\n from plone.i18n.interfaces import ILanguageSchema\n from plone.registry.interfaces import IRegistry\n-\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from zope.component import getMultiAdapter\n+from zope.component import getUtility\n \n import unittest\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py\nindex 0de6c66436..dfbbb241dd 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_mail.py\n@@ -1,11 +1,9 @@\n-from zope.component import getMultiAdapter\n-from zope.component import getUtility\n+from plone.base.interfaces import IMailSchema\n from plone.registry.interfaces import IRegistry\n-\n from Products.CMFCore.utils import getToolByName\n-from plone.base.interfaces import IMailSchema\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from zope.component import getMultiAdapter\n+from zope.component import getUtility\n \n import unittest\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py\nindex 248e27602c..ffdae9d135 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_markup.py\n@@ -1,9 +1,10 @@\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import IMarkupSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py\nindex 955ed19c40..70c54a5fd5 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_navigation.py\n@@ -1,9 +1,10 @@\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import INavigationSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py\nindex 974d6c3828..54b4fe1e78 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_overview.py\n@@ -1,9 +1,10 @@\n from plone.app.testing import PLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID\n from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from plone.registry.interfaces import IRegistry\n-from zope.component import getUtility\n from unittest import mock\n+from zope.component import getUtility\n+\n import os\n import unittest\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\nindex a6bf021866..67a37b5fe8 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\n@@ -1,5 +1,6 @@\n from persistent.list import PersistentList\n-from plone.app.testing import TEST_USER_ID, setRoles\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from Products.CMFPlone.controlpanel.browser.relations import get_relations_stats\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from z3c.relationfield import RelationValue\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py\nindex 8cab7e457c..ebf06c1e1f 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_search.py\n@@ -1,9 +1,10 @@\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import ISearchSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py\nindex 12898194be..c7025e5f33 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_security.py\n@@ -1,9 +1,9 @@\n-from Products.CMFCore.utils import getToolByName\n+from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n from plone.base.interfaces import ISecuritySchema\n-from Products.CMFPlone.testing import \\\n-    PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from plone.app.testing import TEST_USER_ID, setRoles\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py\nindex d8786bbb95..d3eedb379b 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_site.py\n@@ -1,9 +1,10 @@\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import ISiteSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py\nindex 311d29b9e3..76e96669d7 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_types.py\n@@ -1,9 +1,10 @@\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import ITypesSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py\nindex 7e92c90e83..26c7085fe2 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_usergroups.py\n@@ -1,6 +1,6 @@\n+from plone.base.interfaces import IUserGroupsSettingsSchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from plone.base.interfaces import IUserGroupsSettingsSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getMultiAdapter\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_doctests.py b/Products/CMFPlone/controlpanel/tests/test_doctests.py\nindex 9a93a8552e..75788e32b8 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_doctests.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_doctests.py\n@@ -1,5 +1,5 @@\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from plone.testing import layered\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n \n import doctest\n import re\ndiff --git a/Products/CMFPlone/defaultpage.py b/Products/CMFPlone/defaultpage.py\nindex bdf7402894..b83a13acf1 100644\n--- a/Products/CMFPlone/defaultpage.py\n+++ b/Products/CMFPlone/defaultpage.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n+\n moved(\'plone.base.defaultpage\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/earlypatches/security.py b/Products/CMFPlone/earlypatches/security.py\nindex 5be72b0e7a..f0ad36b657 100644\n--- a/Products/CMFPlone/earlypatches/security.py\n+++ b/Products/CMFPlone/earlypatches/security.py\n@@ -1,10 +1,14 @@\n # 1. make sure allow_module can\'t be called from restricted code\n import AccessControl\n+\n+\n AccessControl.allow_module.__roles__ = ()\n \n # 2. make sure /@@ doesn\'t traverse to annotations\n from zope.traversing import namespace\n from zope.traversing.interfaces import TraversalError\n+\n+\n old_traverse = namespace.view.traverse\n \n \n@@ -16,10 +20,12 @@ def traverse(self, name, ignored):\n \n # 3. be sure to check Access contents information permission for FTP users\n from Products.CMFPlone import bbb\n+\n+\n if bbb.HAS_ZSERVER:\n     from AccessControl import getSecurityManager\n-    from zExceptions import Unauthorized\n     from OFS.ObjectManager import ObjectManager\n+    from zExceptions import Unauthorized\n     ObjectManager.__old_manage_FTPlist = ObjectManager.manage_FTPlist\n \n \n@@ -40,6 +46,8 @@ def manage_FTPlist(self, REQUEST):\n \n # 4. Make sure z3c.form widgets don\'t get declared as public\n from AccessControl.metaconfigure import ClassDirective\n+\n+\n old_require = ClassDirective.require\n \n \n@@ -54,15 +62,20 @@ def require(self, *args, **kw):\n \n # 6. Protect some methods in ZCatalog\n from Products.ZCatalog.ZCatalog import ZCatalog\n+\n+\n ZCatalog.resolve_path__roles__ = ()\n ZCatalog.resolve_url__roles__ = ()\n \n-# 7. Prevent publish traversal of the request\n-from ZPublisher.BaseRequest import BaseRequest\n-from ZPublisher.HTTPRequest import HTTPRequest\n from zope.publisher.base import BaseRequest as ZPBaseRequest\n from zope.publisher.ftp import FTPRequest\n from zope.publisher.http import HTTPRequest as ZPHTTPRequest\n+\n+# 7. Prevent publish traversal of the request\n+from ZPublisher.BaseRequest import BaseRequest\n+from ZPublisher.HTTPRequest import HTTPRequest\n+\n+\n for c in [BaseRequest, HTTPRequest, ZPBaseRequest, FTPRequest, ZPHTTPRequest]:\n     try:\n         del c.__doc__\ndiff --git a/Products/CMFPlone/exportimport/controlpanel.py b/Products/CMFPlone/exportimport/controlpanel.py\nindex 48ca8c891d..0870d8f25a 100644\n--- a/Products/CMFPlone/exportimport/controlpanel.py\n+++ b/Products/CMFPlone/exportimport/controlpanel.py\n@@ -14,16 +14,13 @@\n \n $Id$\n """\n-from zope.i18nmessageid import Message\n-\n+from plone.base.interfaces import IControlPanel\n+from Products.CMFCore.interfaces import IActionProvider\n+from Products.CMFCore.utils import getToolByName\n from Products.GenericSetup.utils import exportObjects\n from Products.GenericSetup.utils import importObjects\n from Products.GenericSetup.utils import XMLAdapterBase\n-\n-from Products.CMFCore.interfaces import IActionProvider\n-from Products.CMFCore.utils import getToolByName\n-\n-from plone.base.interfaces import IControlPanel\n+from zope.i18nmessageid import Message\n \n \n class ControlPanelXMLAdapter(XMLAdapterBase):\ndiff --git a/Products/CMFPlone/exportimport/memberdata_properties.py b/Products/CMFPlone/exportimport/memberdata_properties.py\nindex 28583460a8..5a7c948d07 100644\n--- a/Products/CMFPlone/exportimport/memberdata_properties.py\n+++ b/Products/CMFPlone/exportimport/memberdata_properties.py\n@@ -3,9 +3,10 @@\n $Id:$\n """\n \n-from zope.component import queryMultiAdapter\n from Products.CMFCore.utils import getToolByName\n from Products.GenericSetup.interfaces import IBody\n+from zope.component import queryMultiAdapter\n+\n \n _FILENAME = \'memberdata_properties.xml\'\n \ndiff --git a/Products/CMFPlone/exportimport/propertiestool.py b/Products/CMFPlone/exportimport/propertiestool.py\nindex 3bc7ea923b..5838ef5d17 100644\n--- a/Products/CMFPlone/exportimport/propertiestool.py\n+++ b/Products/CMFPlone/exportimport/propertiestool.py\n@@ -3,17 +3,17 @@\n $Id:$\n """\n \n-from zope.component import queryMultiAdapter\n+from plone.base.interfaces import IPropertiesTool as IPlonePropertiesTool\n+from plone.base.interfaces import ISimpleItemWithProperties\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.PropertiesTool import SimpleItemWithProperties\n from Products.GenericSetup.interfaces import IBody\n from Products.GenericSetup.interfaces import INode\n-from Products.GenericSetup.utils import XMLAdapterBase\n from Products.GenericSetup.utils import ObjectManagerHelpers\n from Products.GenericSetup.utils import PropertyManagerHelpers\n-from Products.CMFPlone.PropertiesTool import SimpleItemWithProperties\n-from plone.base.interfaces \\\n-    import IPropertiesTool as IPlonePropertiesTool\n-from plone.base.interfaces import ISimpleItemWithProperties\n+from Products.GenericSetup.utils import XMLAdapterBase\n+from zope.component import queryMultiAdapter\n+\n \n _FILENAME = \'propertiestool.xml\'\n \ndiff --git a/Products/CMFPlone/exportimport/tests/base.py b/Products/CMFPlone/exportimport/tests/base.py\nindex fdbb490224..dd27aa8351 100644\n--- a/Products/CMFPlone/exportimport/tests/base.py\n+++ b/Products/CMFPlone/exportimport/tests/base.py\n@@ -1,6 +1,7 @@\n from plone.testing.zca import UNIT_TESTING\n from Products.GenericSetup.testing import BodyAdapterTestCase\n from Products.GenericSetup.testing import NodeAdapterTestCase\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/exportimport/tests/testControlPanel.py b/Products/CMFPlone/exportimport/tests/testControlPanel.py\nindex cb016c97c0..dbe17bd76a 100644\n--- a/Products/CMFPlone/exportimport/tests/testControlPanel.py\n+++ b/Products/CMFPlone/exportimport/tests/testControlPanel.py\n@@ -1,9 +1,10 @@\n from OFS.Folder import Folder\n-from Products.CMFPlone.exportimport.tests.base import BodyAdapterTestCase\n from plone.base.interfaces import IControlPanel\n+from Products.CMFPlone.exportimport.tests.base import BodyAdapterTestCase\n from Products.CMFPlone.PloneControlPanel import PloneControlPanel\n-from zope.component import provideUtility\n from zope.component import provideAdapter\n+from zope.component import provideUtility\n+\n \n _CONTROLPANEL_XML = b"""\\\n <?xml version="1.0" encoding="utf-8"?>\n@@ -22,8 +23,7 @@\n class ControlPanelXMLAdapterTests(BodyAdapterTestCase):\n \n     def _getTargetClass(self):\n-        from Products.CMFPlone.exportimport.controlpanel \\\n-            import ControlPanelXMLAdapter\n+        from Products.CMFPlone.exportimport.controlpanel import ControlPanelXMLAdapter\n         return ControlPanelXMLAdapter\n \n     def _populate(self, obj):\n@@ -39,8 +39,8 @@ def _populate(self, obj):\n         )\n \n     def setUp(self):\n-        from Products.GenericSetup.interfaces import ISetupEnviron\n         from Products.GenericSetup.interfaces import IBody\n+        from Products.GenericSetup.interfaces import ISetupEnviron\n         self.site = Folder(\'site\')\n         self.site.portal_control_panel = PloneControlPanel()\n         provideUtility(self.site.portal_control_panel, IControlPanel)\n@@ -51,7 +51,8 @@ def setUp(self):\n \n \n def test_suite():\n-    from unittest import TestSuite, makeSuite\n+    from unittest import makeSuite\n+    from unittest import TestSuite\n     suite = TestSuite()\n     suite.addTest(makeSuite(ControlPanelXMLAdapterTests))\n     return suite\ndiff --git a/Products/CMFPlone/exportimport/tests/testPropertiesTool.py b/Products/CMFPlone/exportimport/tests/testPropertiesTool.py\nindex 317b19100d..44dcbaa8a5 100644\n--- a/Products/CMFPlone/exportimport/tests/testPropertiesTool.py\n+++ b/Products/CMFPlone/exportimport/tests/testPropertiesTool.py\n@@ -3,6 +3,7 @@\n from Products.CMFPlone.PropertiesTool import SimpleItemWithProperties\n from zope.component import provideAdapter\n \n+\n _PROPERTYSHEET_XML = b"""\\\n <?xml version="1.0" encoding="utf-8"?>\n <object name="site_properties" meta_type="Plone Property Sheet">\n@@ -27,8 +28,9 @@\n class PropertySheetXMLAdapterTests(BodyAdapterTestCase):\n \n     def _getTargetClass(self):\n-        from Products.CMFPlone.exportimport.propertiestool \\\n-            import SimpleItemWithPropertiesXMLAdapter\n+        from Products.CMFPlone.exportimport.propertiestool import (\n+            SimpleItemWithPropertiesXMLAdapter,\n+        )\n         return SimpleItemWithPropertiesXMLAdapter\n \n     def _populate(self, obj):\n@@ -38,8 +40,8 @@ def _populate(self, obj):\n \n     def setUp(self):\n         from plone.base.interfaces import ISimpleItemWithProperties\n-        from Products.GenericSetup.interfaces import ISetupEnviron\n         from Products.GenericSetup.interfaces import IBody\n+        from Products.GenericSetup.interfaces import ISetupEnviron\n         provideAdapter(\n             self._getTargetClass(),\n             (ISimpleItemWithProperties, ISetupEnviron), IBody)\n@@ -51,8 +53,9 @@ def setUp(self):\n class PropertiesToolXMLAdapterTests(BodyAdapterTestCase):\n \n     def _getTargetClass(self):\n-        from Products.CMFPlone.exportimport.propertiestool \\\n-            import PlonePropertiesToolXMLAdapter\n+        from Products.CMFPlone.exportimport.propertiestool import (\n+            PlonePropertiesToolXMLAdapter,\n+        )\n         return PlonePropertiesToolXMLAdapter\n \n     def _populate(self, obj):\n@@ -64,12 +67,13 @@ def _populate(self, obj):\n             \'displayPublicationDateInByline\', True, \'boolean\')\n \n     def setUp(self):\n-        from Products.CMFPlone.exportimport.propertiestool \\\n-            import SimpleItemWithPropertiesXMLAdapter\n         from plone.base.interfaces import IPropertiesTool\n         from plone.base.interfaces import ISimpleItemWithProperties\n-        from Products.GenericSetup.interfaces import ISetupEnviron\n+        from Products.CMFPlone.exportimport.propertiestool import (\n+            SimpleItemWithPropertiesXMLAdapter,\n+        )\n         from Products.GenericSetup.interfaces import IBody\n+        from Products.GenericSetup.interfaces import ISetupEnviron\n         provideAdapter(\n             self._getTargetClass(), (IPropertiesTool, ISetupEnviron), IBody)\n         provideAdapter(\n@@ -81,7 +85,8 @@ def setUp(self):\n \n \n def test_suite():\n-    from unittest import TestSuite, makeSuite\n+    from unittest import makeSuite\n+    from unittest import TestSuite\n     suite = TestSuite()\n     suite.addTest(makeSuite(PropertySheetXMLAdapterTests))\n     suite.addTest(makeSuite(PropertiesToolXMLAdapterTests))\ndiff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py\nindex 550784c1a0..afa1dbb5b6 100644\n--- a/Products/CMFPlone/factory.py\n+++ b/Products/CMFPlone/factory.py\n@@ -1,8 +1,8 @@\n from logging import getLogger\n+from plone.base.interfaces import INonInstallable\n from plone.registry.interfaces import IRegistry\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.events import SiteManagerCreatedEvent\n-from plone.base.interfaces import INonInstallable\n from Products.CMFPlone.Portal import PloneSite\n from Products.GenericSetup.tool import SetupTool\n from zope.component import queryUtility\n@@ -11,6 +11,7 @@\n from zope.interface import implementer\n from zope.lifecycleevent import ObjectCreatedEvent\n \n+\n _TOOL_ID = \'portal_setup\'\n _DEFAULT_PROFILE = \'Products.CMFPlone:plone\'\n _TYPES_PROFILE = \'plone.app.contenttypes:default\'\n@@ -116,7 +117,7 @@ def zmi_constructor(context):\n \n def addPloneSite(context, site_id, title=\'Plone site\', description=\'\',\n                  profile_id=_DEFAULT_PROFILE,\n-                 content_profile_id=_CONTENT_PROFILE, snapshot=False,\n+                 content_profile_id=None, snapshot=False,\n                  extension_ids=(), setup_content=True,\n                  default_language=\'en\', portal_timezone=\'UTC\'):\n     """Add a PloneSite to the context."""\n@@ -153,9 +154,21 @@ def addPloneSite(context, site_id, title=\'Plone site\', description=\'\',\n \n         # Install default content types profile if user do not select "example content"\n         # during site creation.\n-        content_types_profile = content_profile_id if setup_content else _TYPES_PROFILE\n+        if setup_content:\n+            if content_profile_id:\n+                content_profiles = [content_profile_id]\n+            elif "plone.volto:default" in extension_ids:\n+                content_profiles = [\n+                    _TYPES_PROFILE,\n+                    "plone.volto:default-homepage",\n+                ]\n+            else:\n+                content_profiles = [_CONTENT_PROFILE]\n+        else:\n+            content_profiles = [_TYPES_PROFILE]\n \n-        setup_tool.runAllImportStepsFromProfile(f\'profile-{content_types_profile}\')\n+        for profile_id in content_profiles:\n+            setup_tool.runAllImportStepsFromProfile(f\'profile-{profile_id}\')\n \n         props = dict(\n             title=title,\ndiff --git a/Products/CMFPlone/i18nl10n.py b/Products/CMFPlone/i18nl10n.py\nindex d9980a07e9..5c7eea59ea 100644\n--- a/Products/CMFPlone/i18nl10n.py\n+++ b/Products/CMFPlone/i18nl10n.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n+\n moved(\'plone.base.i18nl10n\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/image_scales/adapters.py b/Products/CMFPlone/image_scales/adapters.py\nindex 6fc7230b48..88a79e9ff2 100644\n--- a/Products/CMFPlone/image_scales/adapters.py\n+++ b/Products/CMFPlone/image_scales/adapters.py\n@@ -1,8 +1,8 @@\n from Acquisition import aq_inner\n-from plone.dexterity.interfaces import IDexterityContent\n-from plone.dexterity.utils import iterSchemata\n from plone.base.interfaces import IImageScalesAdapter\n from plone.base.interfaces import IImageScalesFieldAdapter\n+from plone.dexterity.interfaces import IDexterityContent\n+from plone.dexterity.utils import iterSchemata\n from zope.component import adapter\n from zope.component import queryMultiAdapter\n from zope.interface import implementer\ndiff --git a/Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py b/Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py\nindex 0cc5c2c1e0..6ae04f3c46 100644\n--- a/Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py\n+++ b/Products/CMFPlone/image_scales/tests/test_image_scales_metadata.py\n@@ -1,10 +1,10 @@\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n+from plone.base.interfaces import IImageScalesAdapter\n+from plone.base.interfaces import IImageScalesFieldAdapter\n from plone.dexterity.fti import DexterityFTI\n from plone.dexterity.utils import iterSchemata\n from plone.namedfile.file import NamedImage\n-from plone.base.interfaces import IImageScalesAdapter\n-from plone.base.interfaces import IImageScalesFieldAdapter\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from Products.CMFPlone.tests import dummy\n from zope.component import queryMultiAdapter\ndiff --git a/Products/CMFPlone/interfaces/__init__.py b/Products/CMFPlone/interfaces/__init__.py\nindex f5e6813e6b..f00871004f 100644\n--- a/Products/CMFPlone/interfaces/__init__.py\n+++ b/Products/CMFPlone/interfaces/__init__.py\n@@ -1,5 +1,6 @@\n from zope.deferredimport import deprecated\n \n+\n deprecated(\n     "Moved to plone.base.interfaces, import from there instead (will be removed in Plone 7).",\n     IPloneBaseTool="plone.base.interfaces.basetool:IPloneBaseTool",\ndiff --git a/Products/CMFPlone/interfaces/atd.py b/Products/CMFPlone/interfaces/atd.py\nindex f43019c7d8..e19354b987 100644\n--- a/Products/CMFPlone/interfaces/atd.py\n+++ b/Products/CMFPlone/interfaces/atd.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.atd\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.atd\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/basetool.py b/Products/CMFPlone/interfaces/basetool.py\nindex 2ddb20e69b..3d9ab298f7 100644\n--- a/Products/CMFPlone/interfaces/basetool.py\n+++ b/Products/CMFPlone/interfaces/basetool.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.basetool\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.basetool\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/breadcrumbs.py b/Products/CMFPlone/interfaces/breadcrumbs.py\nindex 5be8cc296c..7f3ab83bdc 100644\n--- a/Products/CMFPlone/interfaces/breadcrumbs.py\n+++ b/Products/CMFPlone/interfaces/breadcrumbs.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.breadcrumbs\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.breadcrumbs\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/constrains.py b/Products/CMFPlone/interfaces/constrains.py\nindex 720eed0ec3..f4ac92580c 100644\n--- a/Products/CMFPlone/interfaces/constrains.py\n+++ b/Products/CMFPlone/interfaces/constrains.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.constrains\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.constrains\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py\nindex 9731ce70f2..9139510242 100644\n--- a/Products/CMFPlone/interfaces/controlpanel.py\n+++ b/Products/CMFPlone/interfaces/controlpanel.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n+\n moved(\'plone.base.interfaces.controlpanel\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/defaultpage.py b/Products/CMFPlone/interfaces/defaultpage.py\nindex 4b9a4c610b..2a4e02ccbe 100644\n--- a/Products/CMFPlone/interfaces/defaultpage.py\n+++ b/Products/CMFPlone/interfaces/defaultpage.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.defaultpage\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.defaultpage\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/events.py b/Products/CMFPlone/interfaces/events.py\nindex 57f9fb71b6..b2d28b6eb0 100644\n--- a/Products/CMFPlone/interfaces/events.py\n+++ b/Products/CMFPlone/interfaces/events.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.events\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.events\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/installable.py b/Products/CMFPlone/interfaces/installable.py\nindex 79006705e0..884cd3b384 100644\n--- a/Products/CMFPlone/interfaces/installable.py\n+++ b/Products/CMFPlone/interfaces/installable.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.installable\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.installable\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/interface.py b/Products/CMFPlone/interfaces/interface.py\nindex 1d12e69c6c..33f962c53a 100644\n--- a/Products/CMFPlone/interfaces/interface.py\n+++ b/Products/CMFPlone/interfaces/interface.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.interface\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.interface\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/language.py b/Products/CMFPlone/interfaces/language.py\nindex e8f180cf11..0a984adc0f 100644\n--- a/Products/CMFPlone/interfaces/language.py\n+++ b/Products/CMFPlone/interfaces/language.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.language\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.language\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/login.py b/Products/CMFPlone/interfaces/login.py\nindex 19e30f8a8f..a6a2b31292 100644\n--- a/Products/CMFPlone/interfaces/login.py\n+++ b/Products/CMFPlone/interfaces/login.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.login\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.login\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/migration.py b/Products/CMFPlone/interfaces/migration.py\nindex 5672aac457..7c337fbe0b 100644\n--- a/Products/CMFPlone/interfaces/migration.py\n+++ b/Products/CMFPlone/interfaces/migration.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.migration\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.migration\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/password_reset.py b/Products/CMFPlone/interfaces/password_reset.py\nindex 97fd367189..dd7d2f429b 100644\n--- a/Products/CMFPlone/interfaces/password_reset.py\n+++ b/Products/CMFPlone/interfaces/password_reset.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.password_reset\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.password_reset\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/patterns.py b/Products/CMFPlone/interfaces/patterns.py\nindex 91983316aa..38419fac65 100644\n--- a/Products/CMFPlone/interfaces/patterns.py\n+++ b/Products/CMFPlone/interfaces/patterns.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.patterns\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.patterns\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/properties.py b/Products/CMFPlone/interfaces/properties.py\nindex 4c4b228fff..9619c121f0 100644\n--- a/Products/CMFPlone/interfaces/properties.py\n+++ b/Products/CMFPlone/interfaces/properties.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.properties\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.properties\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/resources.py b/Products/CMFPlone/interfaces/resources.py\nindex 5e1cab52d3..198a1045e4 100644\n--- a/Products/CMFPlone/interfaces/resources.py\n+++ b/Products/CMFPlone/interfaces/resources.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n+\n moved(\'plone.base.interfaces.resources\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/siteroot.py b/Products/CMFPlone/interfaces/siteroot.py\nindex e05bac1d96..85df8e7c18 100644\n--- a/Products/CMFPlone/interfaces/siteroot.py\n+++ b/Products/CMFPlone/interfaces/siteroot.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.siteroot\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.siteroot\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/structure.py b/Products/CMFPlone/interfaces/structure.py\nindex 1de8c04966..dd4bb753ce 100644\n--- a/Products/CMFPlone/interfaces/structure.py\n+++ b/Products/CMFPlone/interfaces/structure.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.structure\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.structure\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/syndication.py b/Products/CMFPlone/interfaces/syndication.py\nindex e2bdf7315c..e6a459d7a7 100644\n--- a/Products/CMFPlone/interfaces/syndication.py\n+++ b/Products/CMFPlone/interfaces/syndication.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.syndication\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.syndication\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/interfaces/translationservice.py b/Products/CMFPlone/interfaces/translationservice.py\nindex f840d67732..c91a2ec402 100644\n--- a/Products/CMFPlone/interfaces/translationservice.py\n+++ b/Products/CMFPlone/interfaces/translationservice.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.interfaces.translationservice\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.interfaces.translationservice\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/log.py b/Products/CMFPlone/log.py\nindex 7cf1dfa8ca..4b2df2ba85 100644\n--- a/Products/CMFPlone/log.py\n+++ b/Products/CMFPlone/log.py\n@@ -6,6 +6,7 @@\n \n import logging\n \n+\n logger = logging.getLogger(\'Plone\')\n \n \ndiff --git a/Products/CMFPlone/patches/__init__.py b/Products/CMFPlone/patches/__init__.py\nindex 2a66068710..5adf744414 100644\n--- a/Products/CMFPlone/patches/__init__.py\n+++ b/Products/CMFPlone/patches/__init__.py\n@@ -2,30 +2,34 @@\n # from . import addzmiplonesite          # Add an explicit link to add a new Plone\n # site to the ZMI for faster access\n \n-from . import addzmisecuritywarning    # Add a warning to the ZMI security tab\n+from . import addzmisecuritywarning  # Add a warning to the ZMI security tab\n+from . import csrf  # Protects most important methods from\n+from . import dateIndexPatch  # Avoid OverflowErrors in Date*Indexes\n+from . import unicodeFallbackPatch  # Makes the TAL engine in Zope 2.10+ accept\n+\n+\n # that you shouldn\'t use it\n \n-from . import dateIndexPatch           # Avoid OverflowErrors in Date*Indexes\n \n-from . import unicodeFallbackPatch     # Makes the TAL engine in Zope 2.10+ accept\n # utf-8 encoded strings as well as Unicode\n \n-from . import csrf                     # Protects most important methods from\n csrf.applyPatches()             # CSRF attacks\n \n-from . import speed                    # Various caching patches to improve speed\n+from . import iso8601  # use `DateTime.ISO8601` for `DateTime.ISO`\n+from . import speed  # Various caching patches to improve speed\n+\n \n-from . import iso8601                  # use `DateTime.ISO8601` for `DateTime.ISO`\n iso8601.applyPatches()\n \n from . import sendmail\n-sendmail.applyPatches()\n \n-from . import templatecookcheck        # Make sure templates aren\'t re-read in\n-# production sites\n \n-from . import publishing\n+sendmail.applyPatches()\n \n+from . import gtbn\n+from . import publishing\n+from . import templatecookcheck  # Make sure templates aren\'t re-read in\n from . import z3c_form\n \n-from . import gtbn\n+\n+# production sites\ndiff --git a/Products/CMFPlone/patches/addzmiplonesite.py b/Products/CMFPlone/patches/addzmiplonesite.py\nindex 9bf09e93ce..922157ab20 100644\n--- a/Products/CMFPlone/patches/addzmiplonesite.py\n+++ b/Products/CMFPlone/patches/addzmiplonesite.py\n@@ -1,5 +1,6 @@\n from OFS.ObjectManager import ObjectManager\n \n+\n # FIXME: This no longer works with the new ZMI\n \n ADD_PLONE_SITE_HTML = \'\'\'\ndiff --git a/Products/CMFPlone/patches/addzmisecuritywarning.py b/Products/CMFPlone/patches/addzmisecuritywarning.py\nindex 373de8a3c7..edc8a821ab 100644\n--- a/Products/CMFPlone/patches/addzmisecuritywarning.py\n+++ b/Products/CMFPlone/patches/addzmisecuritywarning.py\n@@ -1,5 +1,6 @@\n from OFS.role import RoleManager\n \n+\n ADD_SECURITY_WARNING = \'\'\'\n <!-- Added security warning -->\n <dtml-unless expr="getattr(context, \'meta_type\') == \'Plone Site\' or \'PloneSite\' not in [o.__class__.__name__ for o in this().aq_chain]">\ndiff --git a/Products/CMFPlone/patches/csrf.py b/Products/CMFPlone/patches/csrf.py\nindex e93f68d5a0..fed69d0da3 100644\n--- a/Products/CMFPlone/patches/csrf.py\n+++ b/Products/CMFPlone/patches/csrf.py\n@@ -1,4 +1,6 @@\n-from plone.protect import protect, CheckAuthenticator\n+from plone.protect import CheckAuthenticator\n+from plone.protect import protect\n+\n \n # apply csrf-protection decorator to the given callable\n patch = protect(CheckAuthenticator)\n@@ -36,8 +38,9 @@ def setProperties(self, properties=None, REQUEST=None, **kw):\n     GroupsTool.removePrincipalFromGroup = patch(\n         GroupsTool.removePrincipalFromGroup)\n \n-    from Products.PluggableAuthService.PluggableAuthService import \\\n-        PluggableAuthService as PAS\n+    from Products.PluggableAuthService.PluggableAuthService import (\n+        PluggableAuthService as PAS,\n+    )\n     PAS.userFolderAddUser = patch(PAS.userFolderAddUser)\n     PAS.userFolderEditUser = patch(PAS.userFolderEditUser)\n     PAS.userFolderDelUsers = patch(PAS.userFolderDelUsers)\ndiff --git a/Products/CMFPlone/patches/dateIndexPatch.py b/Products/CMFPlone/patches/dateIndexPatch.py\nindex fe8c9d6188..f4b5b0a66d 100644\n--- a/Products/CMFPlone/patches/dateIndexPatch.py\n+++ b/Products/CMFPlone/patches/dateIndexPatch.py\n@@ -1,8 +1,9 @@\n # Avoid OverflowErrors in Date*Indexes\n \n+from DateTime import DateTime\n from Products.PluginIndexes.DateIndex.DateIndex import DateIndex\n from Products.PluginIndexes.DateRangeIndex.DateRangeIndex import DateRangeIndex\n-from DateTime import DateTime\n+\n \n maxDate = DateTime(4008, 0)\n \ndiff --git a/Products/CMFPlone/patches/gtbn.py b/Products/CMFPlone/patches/gtbn.py\nindex 5f358b1aad..f5855776ae 100644\n--- a/Products/CMFPlone/patches/gtbn.py\n+++ b/Products/CMFPlone/patches/gtbn.py\n@@ -1,4 +1,6 @@\n-from Acquisition import aq_parent, aq_base, aq_inner\n+from Acquisition import aq_base\n+from Acquisition import aq_inner\n+from Acquisition import aq_parent\n from Acquisition import IAcquirer\n from Products.CMFCore import utils\n from zope.globalrequest import getRequest\ndiff --git a/Products/CMFPlone/patches/publishing.py b/Products/CMFPlone/patches/publishing.py\nindex 340f372c33..5c86d0c274 100644\n--- a/Products/CMFPlone/patches/publishing.py\n+++ b/Products/CMFPlone/patches/publishing.py\n@@ -2,9 +2,9 @@\n # Plus extras for properties.\n # Plus Products.PloneHotfix20210518.\n from OFS.PropertyManager import PropertyManager\n-from Products.CMFPlone.Portal import PloneSite\n-from plone.dexterity.content import Item\n from plone.dexterity.content import Container\n+from plone.dexterity.content import Item\n+from Products.CMFPlone.Portal import PloneSite\n \n \n def delete_method_docstring(klass, method_name):\ndiff --git a/Products/CMFPlone/patches/sendmail.py b/Products/CMFPlone/patches/sendmail.py\nindex d699ceee01..5d048674f0 100644\n--- a/Products/CMFPlone/patches/sendmail.py\n+++ b/Products/CMFPlone/patches/sendmail.py\n@@ -1,5 +1,5 @@\n-from plone.registry.interfaces import IRegistry\n from plone.base.interfaces import IMailSchema\n+from plone.registry.interfaces import IRegistry\n from transaction._transaction import Status\n from zope.component import getUtility\n from zope.sendmail.mailer import _SMTPState\ndiff --git a/Products/CMFPlone/patches/speed.py b/Products/CMFPlone/patches/speed.py\nindex ad73b017d1..17297da87b 100644\n--- a/Products/CMFPlone/patches/speed.py\n+++ b/Products/CMFPlone/patches/speed.py\n@@ -1,5 +1,6 @@\n-from plone.memoize import forever\n from os import environ\n+from plone.memoize import forever\n+\n \n # Remember the installed products and packages (unless running tests)\n if not \'ZOPETESTCASE\' in environ:\n@@ -17,6 +18,8 @@ def new_init(*args, **kwargs):\n     return new_init\n \n from zope.tal.talinterpreter import TALInterpreter\n+\n+\n TALInterpreter.__init__ = wrap_init(TALInterpreter.__init__)\n \n \n@@ -30,4 +33,6 @@ def opaqueItems(self):\n     return ()\n \n from Products.CMFCore.CMFCatalogAware import OpaqueItemManager\n+\n+\n OpaqueItemManager.opaqueItems = opaqueItems\ndiff --git a/Products/CMFPlone/patches/templatecookcheck.py b/Products/CMFPlone/patches/templatecookcheck.py\nindex 4fdb35222f..e9255b1dad 100644\n--- a/Products/CMFPlone/patches/templatecookcheck.py\n+++ b/Products/CMFPlone/patches/templatecookcheck.py\n@@ -5,6 +5,7 @@\n \n from App.config import getConfiguration\n from zope.pagetemplate.pagetemplatefile import PageTemplateFile\n+\n import logging\n import os\n \ndiff --git a/Products/CMFPlone/patches/unicodeFallbackPatch.py b/Products/CMFPlone/patches/unicodeFallbackPatch.py\nindex 577108cb3f..fc3a186961 100644\n--- a/Products/CMFPlone/patches/unicodeFallbackPatch.py\n+++ b/Products/CMFPlone/patches/unicodeFallbackPatch.py\n@@ -10,15 +10,16 @@\n # Therefor these patches will probably stay here for quite a while.\n \n # import hacks\n-from .unicodehacks import new__call__\n from .unicodehacks import _nulljoin\n from .unicodehacks import _unicode_replace\n from .unicodehacks import FasterStringIO\n+from .unicodehacks import new__call__\n+from zope.pagetemplate import pagetemplate\n \n # import the poor victims of our monkey patches\n from zope.tal import talinterpreter\n from zope.tales import expressions\n-from zope.pagetemplate import pagetemplate\n+\n \n # Enable use of utf-8 text in tales inserts, until all code is changed to use\n # pure Unicode only. This will only work for sites with a portal encoding of\ndiff --git a/Products/CMFPlone/patches/unicodehacks.py b/Products/CMFPlone/patches/unicodehacks.py\nindex ab13277482..c6ebf7499f 100644\n--- a/Products/CMFPlone/patches/unicodehacks.py\n+++ b/Products/CMFPlone/patches/unicodehacks.py\n@@ -14,11 +14,11 @@ def _nulljoin(valuelist):\n \n def new__call__(self, econtext):\n     try:\n-        return self._expr % tuple([var(econtext) for var in self._vars])\n+        return self._expr % tuple(var(econtext) for var in self._vars)\n     except UnicodeDecodeError:\n         pass\n-    return self._expr % tuple([_unicode_replace(var(econtext))\n-                               for var in self._vars])\n+    return self._expr % tuple(_unicode_replace(var(econtext))\n+                               for var in self._vars)\n \n \n class FasterStringIO(list):\ndiff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py\nindex d55d4a7d11..77887c6779 100644\n--- a/Products/CMFPlone/patterns/__init__.py\n+++ b/Products/CMFPlone/patterns/__init__.py\n@@ -1,5 +1,6 @@\n from zope.deferredimport import deprecated\n \n+\n deprecated(\n     "Import from Products.CMFPlone.patterns.tinymce instead",\n     TinyMCESettingsGenerator="Products.CMFPlone.patterns.tinymce.TinyMCESettingsGenerator",  # noqa: E501\ndiff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex a8fe05d5a2..73fbfddd47 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -4,13 +4,13 @@\n from plone.app.content.browser.interfaces import IFolderContentsView\n from plone.app.widgets.utils import get_relateditems_options\n from plone.app.z3cform.utils import call_callables\n-from plone.registry.interfaces import IRegistry\n-from plone.uuid.interfaces import IUUID\n-from Products.CMFCore.interfaces._content import IFolderish\n from plone.base.interfaces import IImagingSchema\n from plone.base.interfaces import ILinkSchema\n from plone.base.interfaces import IPatternsSettings\n from plone.base.interfaces import IPloneSiteRoot\n+from plone.registry.interfaces import IRegistry\n+from plone.uuid.interfaces import IUUID\n+from Products.CMFCore.interfaces._content import IFolderish\n from Products.CMFPlone.patterns.tinymce import TinyMCESettingsGenerator\n from Products.CMFPlone.utils import get_portal\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/patterns/tinymce.py b/Products/CMFPlone/patterns/tinymce.py\nindex 0ae8528f46..43206c8384 100644\n--- a/Products/CMFPlone/patterns/tinymce.py\n+++ b/Products/CMFPlone/patterns/tinymce.py\n@@ -1,12 +1,12 @@\n from lxml import html\n from plone.app.layout.navigation.root import getNavigationRootObject\n from plone.app.theming.utils import theming_policy\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFCore.utils import getToolByName\n from plone.base.interfaces import IFilterSchema\n from plone.base.interfaces import ITinyMCESchema\n-from Products.CMFPlone.utils import get_portal\n from plone.base.utils import safe_text\n+from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.utils import get_portal\n from zope.component import getUtility\n \n import json\n@@ -97,14 +97,17 @@ def get_tiny_config(self):\n         importcss_file_filter = "tinymce-formats.css"\n \n         theme = self.get_theme()\n+        extra_content_css = ""\n         if theme and getattr(theme, "tinymce_styles_css", None):\n-            importcss_file_filter += ",{}/{}".format(\n+            extra = ",{}/{}".format(\n                 self.nav_root_url, theme.tinymce_styles_css.lstrip("/")\n             )\n+            extra_content_css += extra\n+            importcss_file_filter += extra\n \n         tiny_config = {\n             "resize": "both" if settings.resizing else False,\n-            "content_css": self.get_content_css(),\n+            "content_css": self.get_content_css() + extra_content_css,\n             "plugins": ["plonelink", "ploneimage", "importcss"] + settings.plugins,\n             "external_plugins": {},\n             "toolbar": settings.toolbar,\n@@ -112,6 +115,13 @@ def get_tiny_config(self):\n             "importcss_append": True,\n             "importcss_file_filter": importcss_file_filter,\n             "browser_spellcheck": True,\n+            "table_default_styles": {},\n+            "table_default_attributes": {"class": "listing"},\n+            "table_advtab": False,\n+            "table_row_advtab": False,\n+            "table_cell_advtab": False,\n+            "table_style_by_css": False,\n+            "table_appearance_options": False,\n         }\n         toolbar_additions = settings.custom_buttons or []\n \ndiff --git a/Products/CMFPlone/permissions.py b/Products/CMFPlone/permissions.py\nindex 4230ff54eb..27b024b1de 100644\n--- a/Products/CMFPlone/permissions.py\n+++ b/Products/CMFPlone/permissions.py\n@@ -1,3 +1,4 @@\n from zope.deprecation import moved\n \n-moved(\'plone.base.permissions\', \'Version 7.0\')\n\\ No newline at end of file\n+\n+moved(\'plone.base.permissions\', \'Version 7.0\')\ndiff --git a/Products/CMFPlone/profiles/default/memberdata_properties.xml b/Products/CMFPlone/profiles/default/memberdata_properties.xml\nindex 18098a8179..0dc2ac7ceb 100644\n--- a/Products/CMFPlone/profiles/default/memberdata_properties.xml\n+++ b/Products/CMFPlone/profiles/default/memberdata_properties.xml\n@@ -14,4 +14,5 @@\n  <property name="ext_editor" type="boolean">False</property>\n  <property name="wysiwyg_editor" type="string"></property>\n  <property name="visible_ids" type="boolean">False</property>\n+ <property name="timezone" type="string"></property>\n </object>\ndiff --git a/Products/CMFPlone/profiles/default/metadata.xml b/Products/CMFPlone/profiles/default/metadata.xml\nindex a51ef8dc57..09e062981a 100644\n--- a/Products/CMFPlone/profiles/default/metadata.xml\n+++ b/Products/CMFPlone/profiles/default/metadata.xml\n@@ -1,4 +1,4 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>6007</version>\n+  <version>6014</version>\n </metadata>\ndiff --git a/Products/CMFPlone/relationhelper.py b/Products/CMFPlone/relationhelper.py\nindex da92cccb97..14b4c37c9e 100644\n--- a/Products/CMFPlone/relationhelper.py\n+++ b/Products/CMFPlone/relationhelper.py\n@@ -26,6 +26,7 @@\n import logging\n import pkg_resources\n \n+\n try:\n     # "iterate" is not a dependency of CMFPlone, but a consumer of it\n     pkg_resources.get_distribution("plone.app.iterate")\n@@ -62,7 +63,7 @@ def get_relations_stats():\n             rel = relation_catalog.resolveRelationToken(token)\n         except ObjectMissingError:\n             broken[\'Object is missing\'] += 1\n-            logger.info(\'Token {} has no object.\'.format(token))\n+            logger.info(f\'Token {token} has no object.\')\n             continue\n \n         if rel.isBroken():\n@@ -84,7 +85,7 @@ def get_all_relations():\n         try:\n             rel = relation_catalog.resolveRelationToken(token)\n         except ObjectMissingError:\n-            logger.info(\'Token {} has no object.\'.format(token))\n+            logger.info(f\'Token {token} has no object.\')\n             continue\n \n         if rel.from_object and rel.to_object:\ndiff --git a/Products/CMFPlone/resources/browser/resource.py b/Products/CMFPlone/resources/browser/resource.py\nindex 194ca8ce55..c07f71f20a 100644\n--- a/Products/CMFPlone/resources/browser/resource.py\n+++ b/Products/CMFPlone/resources/browser/resource.py\n@@ -6,6 +6,7 @@\n from plone.app.theming.utils import theming_policy\n from plone.base.interfaces import IBundleRegistry\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.component.hooks import getSite\n@@ -45,6 +46,11 @@ def _request_bundles(self):\n             request_disabled_bundles.update(getattr(request, "disabled_bundles", []))\n         return request_enabled_bundles, request_disabled_bundles\n \n+    def _user_local_roles(self, site):\n+        portal_membership = getToolByName(site, "portal_membership")\n+        user = portal_membership.getAuthenticatedMember()\n+        return "|".join(user.getRolesInContext(self.context))\n+\n     def _cache_attr_name(self, site):\n         hashtool = hashlib.sha256()\n         hashtool.update(self.__class__.__name__.encode(\'utf8\'))\n@@ -52,6 +58,7 @@ def _cache_attr_name(self, site):\n         e_bundles, d_bundles = self._request_bundles()\n         for bundle in e_bundles | d_bundles:\n             hashtool.update(bundle.encode(\'utf8\'))\n+        hashtool.update(self._user_local_roles(site).encode("utf8"))\n         return f"_v_renderend_cache_{hashtool.hexdigest()}"\n \n     @property\n@@ -180,6 +187,7 @@ def check_dependencies(bundle_name, depends, bundles):\n                     async_=record.load_async or None,\n                     defer=record.load_defer or None,\n                     integrity=not external,\n+                    **{\'data-bundle\': name},\n                 )\n             if record.csscompilation:\n                 depends = check_dependencies(name, record.depends, css_names)\n@@ -199,6 +207,7 @@ def check_dependencies(bundle_name, depends, bundles):\n                     url=record.csscompilation if external else None,\n                     media="all",\n                     rel="stylesheet",\n+                    **{\'data-bundle\': name},\n                 )\n \n         # Collect theme data\ndiff --git a/Products/CMFPlone/resources/utils.py b/Products/CMFPlone/resources/utils.py\nindex 3409e53549..e72f9553fe 100644\n--- a/Products/CMFPlone/resources/utils.py\n+++ b/Products/CMFPlone/resources/utils.py\n@@ -30,7 +30,7 @@ def get_production_resource_directory():\n     timestamp = production_folder.readFile("timestamp.txt")\n     if isinstance(timestamp, bytes):\n         timestamp = timestamp.decode()\n-    return "{}/++unique++{}".format(PRODUCTION_RESOURCE_DIRECTORY, timestamp)\n+    return f"{PRODUCTION_RESOURCE_DIRECTORY}/++unique++{timestamp}"\n \n \n def get_resource(context, path):\ndiff --git a/Products/CMFPlone/setuphandlers.py b/Products/CMFPlone/setuphandlers.py\nindex 9bc454e82a..0f97284c92 100644\n--- a/Products/CMFPlone/setuphandlers.py\n+++ b/Products/CMFPlone/setuphandlers.py\n@@ -1,14 +1,15 @@\n from Acquisition import aq_base\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone.factory import _DEFAULT_PROFILE\n+from borg.localrole.utils import replace_local_role_manager\n from plone.base.interfaces import IMigrationTool\n from plone.base.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME\n-from Products.StandardCacheManagers.AcceleratedHTTPCacheManager \\\n-    import AcceleratedHTTPCacheManager\n-from Products.StandardCacheManagers.RAMCacheManager import RAMCacheManager\n-from borg.localrole.utils import replace_local_role_manager\n from plone.registry.interfaces import IRegistry\n from plone.resource.interfaces import IResourceDirectory\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.factory import _DEFAULT_PROFILE\n+from Products.StandardCacheManagers.AcceleratedHTTPCacheManager import (\n+    AcceleratedHTTPCacheManager,\n+)\n+from Products.StandardCacheManagers.RAMCacheManager import RAMCacheManager\n from zope.component import getUtility\n from zope.component import queryUtility\n from zope.component.hooks import getSite\ndiff --git a/Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py b/Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py\nindex ad62e1c912..a2c953f854 100644\n--- a/Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py\n+++ b/Products/CMFPlone/skins/plone_scripts/externalEditorEnabled.py\n@@ -10,6 +10,7 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.utils import webdav_enabled\n \n+\n portal = getToolByName(context, \'portal_url\').getPortalObject()\n mtool = getToolByName(portal, \'portal_membership\')\n \ndiff --git a/Products/CMFPlone/skins/plone_scripts/external_edit.py b/Products/CMFPlone/skins/plone_scripts/external_edit.py\nindex c962afdd14..6e61312ab3 100644\n--- a/Products/CMFPlone/skins/plone_scripts/external_edit.py\n+++ b/Products/CMFPlone/skins/plone_scripts/external_edit.py\n@@ -9,6 +9,7 @@\n \n from Products.PythonScripts.standard import url_quote\n \n+\n request = context.REQUEST\n \n if \'Mac OS X\' in request.get(\'HTTP_USER_AGENT\', \'\'):\ndiff --git a/Products/CMFPlone/skins/plone_scripts/getFolderContents.py b/Products/CMFPlone/skins/plone_scripts/getFolderContents.py\nindex 4bfa9d5d17..f60a08c8b1 100644\n--- a/Products/CMFPlone/skins/plone_scripts/getFolderContents.py\n+++ b/Products/CMFPlone/skins/plone_scripts/getFolderContents.py\n@@ -11,6 +11,8 @@\n #       @@folderListing in plone.app.contentlisting\n \n from zExceptions import Forbidden\n+\n+\n if container.REQUEST.get(\'PUBLISHED\') is script:\n     raise Forbidden(\'Script may not be published.\')\n \ndiff --git a/Products/CMFPlone/skins/plone_scripts/queryCatalog.py b/Products/CMFPlone/skins/plone_scripts/queryCatalog.py\nindex 12d3b5678e..dce2c90911 100644\n--- a/Products/CMFPlone/skins/plone_scripts/queryCatalog.py\n+++ b/Products/CMFPlone/skins/plone_scripts/queryCatalog.py\n@@ -7,10 +7,11 @@\n ##parameters=REQUEST=None,show_all=0,quote_logic=0,quote_logic_indexes=[\'SearchableText\',\'Description\',\'Title\'],use_types_blacklist=False,show_inactive=False,use_navigation_root=False\n ##title=wraps the portal_catalog with a rules qualified query\n \n-from ZODB.POSException import ConflictError\n-from Products.ZCTextIndex.ParseTree import ParseError\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.browser.navtree import getNavigationRoot\n+from Products.ZCTextIndex.ParseTree import ParseError\n+from ZODB.POSException import ConflictError\n+\n \n results = []\n catalog = context.portal_catalog\ndiff --git a/Products/CMFPlone/skins/plone_scripts/translate.py b/Products/CMFPlone/skins/plone_scripts/translate.py\nindex 7443e29203..e1d19bc95b 100644\n--- a/Products/CMFPlone/skins/plone_scripts/translate.py\n+++ b/Products/CMFPlone/skins/plone_scripts/translate.py\n@@ -7,6 +7,8 @@\n ##parameters=msgid, mapping={}, default=None, domain=\'plone\', target_language=None, escape_for_js=False\n \n from zExceptions import Forbidden\n+\n+\n if container.REQUEST.get(\'PUBLISHED\') is script:\n     raise Forbidden(\'Script may not be published.\')\n \n@@ -17,6 +19,7 @@\n \n from Products.CMFCore.utils import getToolByName\n \n+\n # get tool\n tool = getToolByName(context, \'translation_service\')\n \ndiff --git a/Products/CMFPlone/skins/plone_scripts/utranslate.py b/Products/CMFPlone/skins/plone_scripts/utranslate.py\nindex bb2f782940..e7cb75e147 100644\n--- a/Products/CMFPlone/skins/plone_scripts/utranslate.py\n+++ b/Products/CMFPlone/skins/plone_scripts/utranslate.py\n@@ -7,6 +7,8 @@\n ##parameters=msgid, mapping={}, default=None, domain=\'plone\', target_language=None, escape_for_js=False\n \n from zExceptions import Forbidden\n+\n+\n if container.REQUEST.get(\'PUBLISHED\') is script:\n     raise Forbidden(\'Script may not be published.\')\n \n@@ -17,6 +19,7 @@\n \n from Products.CMFCore.utils import getToolByName\n \n+\n # get tool\n tool = getToolByName(context, \'translation_service\')\n \ndiff --git a/Products/CMFPlone/testing.py b/Products/CMFPlone/testing.py\nindex 49548c9595..b65165f6fe 100644\n--- a/Products/CMFPlone/testing.py\n+++ b/Products/CMFPlone/testing.py\n@@ -8,6 +8,7 @@\n from plone.app.testing import PloneSandboxLayer\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n+from plone.app.testing import TEST_USER_PASSWORD\n from plone.app.testing.layers import FunctionalTesting\n from plone.app.testing.layers import IntegrationTesting\n from plone.testing import zope\n@@ -40,7 +41,7 @@ def setUpZope(self, app, configurationContext):\n     def setUpPloneSite(self, portal):\n         portal.acl_users.userFolderAddUser(\n             \'admin\',\n-            \'secret\',\n+            TEST_USER_PASSWORD,\n             [\'Manager\'],\n             []\n         )\ndiff --git a/Products/CMFPlone/tests/LoginAndLogout.rst b/Products/CMFPlone/tests/LoginAndLogout.rst\nindex 0245fc5a15..ecae01adf1 100644\n--- a/Products/CMFPlone/tests/LoginAndLogout.rst\n+++ b/Products/CMFPlone/tests/LoginAndLogout.rst\n@@ -115,11 +115,11 @@ A user defined in the root user folder should be able to log in into\n the site:\n \n     >>> browser.getLink(\'Home\').click()\n-    >>> app.acl_users.userFolderAddUser(\'rootuser\', \'secret\', [], [])\n+    >>> app.acl_users.userFolderAddUser(\'rootuser\', TEST_USER_PASSWORD, [], [])\n     >>> transaction.commit()\n     >>> browser.open(\'http://nohost/plone/login_form\')\n     >>> browser.getControl(\'Login Name\').value = \'rootuser\'\n-    >>> browser.getControl(\'Password\').value = \'secret\'\n+    >>> browser.getControl(\'Password\').value = TEST_USER_PASSWORD\n     >>> browser.getControl(\'Log in\').click()\n     >>> \'You are now logged in\' in browser.contents\n     True\ndiff --git a/Products/CMFPlone/tests/PloneTestCase.py b/Products/CMFPlone/tests/PloneTestCase.py\nindex 3e78448490..adaab0fc59 100644\n--- a/Products/CMFPlone/tests/PloneTestCase.py\n+++ b/Products/CMFPlone/tests/PloneTestCase.py\n@@ -1,14 +1,15 @@\n-from plone.testing.zope import Browser\n-from plone.app.testing.bbb import PloneTestCase\n from plone.app.testing import PLONE_SITE_ID as portal_name\n from plone.app.testing import TEST_USER_ID as default_user\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD as default_password\n-\n+from plone.app.testing.bbb import PloneTestCase\n from plone.protect.authenticator import AuthenticatorView\n+from plone.testing.zope import Browser\n from re import match\n+\n import transaction\n \n+\n # We do not use these, but someone might import them.\n portal_name, default_user  # pyflakes\n \ndiff --git a/Products/CMFPlone/tests/csrf.txt b/Products/CMFPlone/tests/csrf.txt\nindex b5f8e22098..f03dbbb376 100644\n--- a/Products/CMFPlone/tests/csrf.txt\n+++ b/Products/CMFPlone/tests/csrf.txt\n@@ -98,8 +98,8 @@ be able to add new users himself if he wishes so:\n   >>> browser.getControl(\'Full Name\').value = \'John Doe\'\n   >>> browser.getControl(\'User Name\').value = \'john\'\n   >>> browser.getControl(\'Email\').value = \'john@foo-security.com\'\n-  >>> browser.getControl(\'Password\').value = \'y0d4Wg\'\n-  >>> browser.getControl(\'Confirm password\').value = \'y0d4Wg\'\n+  >>> browser.getControl(\'Password\').value = \'correct horse battery staple\'\n+  >>> browser.getControl(\'Confirm password\').value = \'correct horse battery staple\'\n   >>> browser.getControl(\'Register\').click()\n   >>> \'User added.\' in browser.contents\n   True\n@@ -145,17 +145,17 @@ know the current passwort to exploit this, but we\'ll check nevertheless:\n \n   >>> browser.open(\'http://nohost/plone/@@change-password\')\n   >>> browser.getControl(\'Current password\').value = TEST_USER_PASSWORD\n-  >>> browser.getControl(\'New password\').value = \'y0d4Wg\'\n-  >>> browser.getControl(\'Confirm password\').value = \'y0d4Wg\'\n+  >>> browser.getControl(\'New password\').value = \'new password\'\n+  >>> browser.getControl(\'Confirm password\').value = \'new password\'\n   >>> browser.getControl(\'Change Password\').click()\n   >>> browser.contents\n   \'...Info...Password changed...\'\n \n   >>> browser.goBack()\n   >>> browser.getControl(name=\'_authenticator\', index=0).value = \'invalid!\'\n-  >>> browser.getControl(\'Current password\').value = \'y0d4Wg\'\n-  >>> browser.getControl(\'New password\').value = \'y0d4Wg!\'\n-  >>> browser.getControl(\'Confirm password\').value = \'y0d4Wg!\'\n+  >>> browser.getControl(\'Current password\').value = \'new password\'\n+  >>> browser.getControl(\'New password\').value = \'newer password\'\n+  >>> browser.getControl(\'Confirm password\').value = \'newer password\'\n   >>> browser.getControl(\'Change Password\').click()\n   Traceback (most recent call last):\n   ...\n@@ -201,8 +201,8 @@ anymore (which at the same time tests the security control panel):\n   >>> browser.getLink(\'Add New User\').click()\n   >>> browser.getControl(\'User Name\').value = \'johnny\'\n   >>> browser.getControl(\'Email\').value = \'john@foo-security.com\'\n-  >>> browser.getControl(\'Password\').value = \'y0d4Wg!\'\n-  >>> browser.getControl(\'Confirm password\').value = \'y0d4Wg!\'\n+  >>> browser.getControl(\'Password\').value = TEST_USER_PASSWORD\n+  >>> browser.getControl(\'Confirm password\').value = TEST_USER_PASSWORD\n   >>> browser.getControl(\'Register\').click()\n   >>> browser.contents\n   \'...Info...User added...\'\n@@ -423,12 +423,12 @@ limitations, which is why we need to log in as the portal owner first:\n \n   >>> app_browser = Browser(app)\n   >>> app_browser.handleErrors = False\n-  >>> app.acl_users.userFolderAddUser(\'app\', \'secret\', [\'Manager\'], [])\n+  >>> app.acl_users.userFolderAddUser(\'app\', TEST_USER_PASSWORD, [\'Manager\'], [])\n   >>> from plone.testing import zope\n   >>> zope.logout()\n   >>> zope.login(app[\'acl_users\'], \'app\')\n   >>> import transaction; transaction.commit()\n-  >>> app_browser.addHeader(\'Authorization\', \'Basic app:secret\')\n+  >>> app_browser.addHeader(\'Authorization\', f\'Basic app:{TEST_USER_PASSWORD}\')\n   >>> app_browser.open(\'http://nohost/plone/@@overview-controlpanel\')\n   >>> app_browser.getLink(\'Maintenance\').click()\n   >>> app_browser.getControl(name=\'_authenticator\', index=0).value = \'invalid!\'\ndiff --git a/Products/CMFPlone/tests/dummy.py b/Products/CMFPlone/tests/dummy.py\nindex e80bf009b4..15a48a1279 100644\n--- a/Products/CMFPlone/tests/dummy.py\n+++ b/Products/CMFPlone/tests/dummy.py\n@@ -2,11 +2,11 @@\n # Helper objects for the Plone test suite\n #\n from ComputedAttribute import ComputedAttribute\n+from io import BytesIO\n from OFS.Folder import Folder as SimpleFolder\n from OFS.SimpleItem import SimpleItem\n from plone.base.interfaces import INonStructuralFolder\n from plone.base.interfaces import IWorkflowChain\n-from io import BytesIO\n from zope.interface import implementer\n from zope.interface import Interface\n from ZPublisher.HTTPRequest import FileUpload\ndiff --git a/Products/CMFPlone/tests/emaillogin.rst b/Products/CMFPlone/tests/emaillogin.rst\nindex 343bec0525..3596e605b8 100644\n--- a/Products/CMFPlone/tests/emaillogin.rst\n+++ b/Products/CMFPlone/tests/emaillogin.rst\n@@ -17,6 +17,7 @@ First we login as admin::\n \n     >>> from plone.app.testing import SITE_OWNER_NAME\n     >>> from plone.app.testing import SITE_OWNER_PASSWORD\n+    >>> from plone.app.testing import TEST_USER_PASSWORD\n     >>> browser.open(\'http://nohost/plone/login\')\n     >>> browser.getControl(name=\'__ac_name\').value = SITE_OWNER_NAME\n     >>> browser.getControl(name=\'__ac_password\').value = SITE_OWNER_PASSWORD\n@@ -46,8 +47,8 @@ there::\n     >>> browser.open(\'http://nohost/plone/@@register\')\n     >>> browser.getControl(\'User Name\').value=\'username\'\n     >>> browser.getControl(\'Email\').value=\'username@example.org\'\n-    >>> browser.getControl(\'Password\').value = SITE_OWNER_PASSWORD\n-    >>> browser.getControl(\'Confirm password\').value = SITE_OWNER_PASSWORD\n+    >>> browser.getControl(\'Password\').value = TEST_USER_PASSWORD\n+    >>> browser.getControl(\'Confirm password\').value = TEST_USER_PASSWORD\n     >>> browser.getControl(\'Register\').click()\n     >>> \'You have been registered.\' in browser.contents\n     True\n@@ -80,8 +81,8 @@ there::\n We fill in the rest of the form::\n \n     >>> browser.getControl(\'Email\').value=\'email@example.org\'\n-    >>> browser.getControl(\'Password\').value = SITE_OWNER_PASSWORD\n-    >>> browser.getControl(\'Confirm password\').value = SITE_OWNER_PASSWORD\n+    >>> browser.getControl(\'Password\').value = TEST_USER_PASSWORD\n+    >>> browser.getControl(\'Confirm password\').value = TEST_USER_PASSWORD\n     >>> browser.getControl(\'Register\').click()\n     >>> \'You have been registered.\' in browser.contents\n     True\n@@ -94,7 +95,7 @@ We can now login with this email address::\n \n     >>> browser.open(\'http://nohost/plone/login\')\n     >>> browser.getControl(name=\'__ac_name\').value = \'email@example.org\'\n-    >>> browser.getControl(name=\'__ac_password\').value = SITE_OWNER_PASSWORD\n+    >>> browser.getControl(name=\'__ac_password\').value = TEST_USER_PASSWORD\n     >>> browser.getControl(\'Log in\').click()\n     >>> \'You are now logged in\' in browser.contents\n     True\n@@ -127,7 +128,7 @@ Now we try logging out and in again with the given email address::\n     >>> browser.open(\'http://nohost/plone/logout\')\n     >>> browser.open(\'http://nohost/plone/login\')\n     >>> browser.getControl(name=\'__ac_name\').value = \'username@example.org\'\n-    >>> browser.getControl(name=\'__ac_password\').value = SITE_OWNER_PASSWORD\n+    >>> browser.getControl(name=\'__ac_password\').value = TEST_USER_PASSWORD\n     >>> browser.getControl(\'Log in\').click()\n     >>> browser.open(\'http://nohost/plone\')\n     >>> \'Log in\' in browser.contents\n@@ -146,7 +147,7 @@ switched on::\n \n     >>> browser.open(\'http://nohost/plone/login\')\n     >>> browser.getControl(name=\'__ac_name\').value = \'email@example.org\'\n-    >>> browser.getControl(name=\'__ac_password\').value = SITE_OWNER_PASSWORD\n+    >>> browser.getControl(name=\'__ac_password\').value = TEST_USER_PASSWORD\n     >>> browser.getControl(\'Log in\').click()\n     >>> browser.open(\'http://nohost/plone\')\n     >>> \'Log in\' in browser.contents\n@@ -169,7 +170,7 @@ want. (See PLIP9214 notes.)::\n     >>> browser.open(\'http://nohost/plone/logout\')\n     >>> browser.open(\'http://nohost/plone/login\')\n     >>> browser.getControl(name=\'__ac_name\').value = \'email1@example.org\'\n-    >>> browser.getControl(name=\'__ac_password\').value = SITE_OWNER_PASSWORD\n+    >>> browser.getControl(name=\'__ac_password\').value = TEST_USER_PASSWORD\n     >>> browser.getControl(\'Log in\').click()\n     >>> \'Login failed\' in browser.contents\n     True\n@@ -179,7 +180,7 @@ The current email address of course works fine for logging in::\n     >>> browser.open(\'http://nohost/plone/logout\')\n     >>> browser.open(\'http://nohost/plone/login\')\n     >>> browser.getControl(name=\'__ac_name\').value = \'email2@example.org\'\n-    >>> browser.getControl(name=\'__ac_password\').value = SITE_OWNER_PASSWORD\n+    >>> browser.getControl(name=\'__ac_password\').value = TEST_USER_PASSWORD\n     >>> browser.getControl(\'Log in\').click()\n     >>> browser.open(\'http://nohost/plone\')\n     >>> \'Log in\' in browser.contents\ndiff --git a/Products/CMFPlone/tests/pwreset_browser.rst b/Products/CMFPlone/tests/pwreset_browser.rst\nindex da70832d02..3ff5557329 100644\n--- a/Products/CMFPlone/tests/pwreset_browser.rst\n+++ b/Products/CMFPlone/tests/pwreset_browser.rst\n@@ -8,6 +8,7 @@ Note that our usage of testbrowser is unusual and inconsistent, mostly\n because Plone forms have inconsistencies and because testbrowser makes\n assumptions that are not true for Plone forms.\n \n+  >>> from DateTime import DateTime\n   >>> from plone.testing.zope import Browser\n   >>> from plone.app.testing import TEST_USER_NAME, TEST_USER_PASSWORD\n   >>> browser = Browser(layer[\'app\'])\n@@ -127,8 +128,8 @@ Now register a new user:\n \n   >>> browser.getControl(\'User Name\').value = \'jsmith\'\n   >>> browser.getControl(\'Email\').value = \'jsmith@example.com\'\n-  >>> browser.getControl(\'Password\').value = \'secret\'\n-  >>> browser.getControl(\'Confirm password\').value = \'secret\'\n+  >>> browser.getControl(\'Password\').value = TEST_USER_PASSWORD\n+  >>> browser.getControl(\'Confirm password\').value = TEST_USER_PASSWORD\n   >>> browser.getControl(\'Register\').click()\n \n XXX Make sure we don\'t have a way to receive our credentials via\n@@ -137,17 +138,53 @@ e-mail.\n   >>> "You have been registered" in browser.contents\n   True\n \n+The login times are set to the default in 2000:\n+\n+  >>> portal_membership = layer[\'portal\'].portal_membership\n+  >>> member = portal_membership.getMemberById(\'jsmith\')\n+  >>> login_time = member.getProperty(\'login_time\')\n+  >>> isinstance(login_time, DateTime)\n+  True\n+  >>> login_time.Date()\n+  \'2000/01/01\'\n+  >>> last_login_time = member.getProperty(\'last_login_time\')\n+  >>> isinstance(last_login_time, DateTime)\n+  True\n+  >>> last_login_time <= login_time\n+  True\n+  >>> last_login_time.Date()\n+  \'2000/01/01\'\n+\n We are not logged in yet at this point.  Let\'s try to log in:\n \n   >>> browser.getLink(\'Log in\').click()\n   >>> browser.url.startswith(\'http://nohost/plone/login\')\n   True\n   >>> browser.getControl(name=\'__ac_name\').value = \'jsmith\'\n-  >>> browser.getControl(name=\'__ac_password\').value = \'secret\'\n+  >>> browser.getControl(name=\'__ac_password\').value = TEST_USER_PASSWORD\n   >>> browser.getControl(name=\'buttons.login\').click()\n   >>> "You are now logged in" in browser.contents\n   True\n \n+Two login time properties should have been set on the user:\n+\n+  >>> member = portal_membership.getMemberById(\'jsmith\')\n+  >>> login_time = member.getProperty(\'login_time\')\n+  >>> isinstance(login_time, DateTime)\n+  True\n+  >>> last_login_time = member.getProperty(\'last_login_time\')\n+  >>> isinstance(last_login_time, DateTime)\n+  True\n+  >>> last_login_time <= login_time\n+  True\n+\n+The default login time is January 1 2000.  Check that it is much newer now:\n+\n+  >>> login_time > DateTime(2020, 2, 2)\n+  True\n+  >>> last_login_time > DateTime(2020, 2, 2)\n+  True\n+\n Log out again:\n \n   >>> browser.getLink(\'Log out\').click()\n@@ -168,7 +205,7 @@ We check if the old password still works.\n \n   >>> browser.open(\'http://nohost/plone/login\')\n   >>> browser.getControl(name=\'__ac_name\').value = \'jsmith\'\n-  >>> browser.getControl(name=\'__ac_password\').value = \'secret\'\n+  >>> browser.getControl(name=\'__ac_password\').value = TEST_USER_PASSWORD\n   >>> browser.getControl(name=\'buttons.login\').click()\n \n We should be logged in now:\n@@ -210,6 +247,12 @@ then we extract the address that lets us reset our password:\n   >>> b"If you didn\'t expect to receive this email" in msg\n   True\n \n+Save the current login times again so we can compare them after password reset.\n+\n+  >>> member = portal_membership.getMemberById(\'jsmith\')\n+  >>> login_time = member.getProperty(\'login_time\')\n+  >>> last_login_time = member.getProperty(\'last_login_time\')\n+\n Now that we have the address, we will reset our password:\n \n   >>> browser.open(address)\n@@ -222,11 +265,24 @@ Now that we have the address, we will reset our password:\n   >>> form.getControl(name=\'password2\').value = \'secretion\'\n   >>> form.submit()\n \n-We can now logged in:\n+By default \'autologin_after_password_reset\' is turned on, so we are now logged in:\n \n   >>> "Password reset successful, you are logged in now!" in browser.contents\n   True\n \n+The two login time properties should have been updated on the user:\n+\n+  >>> member = portal_membership.getMemberById(\'jsmith\')\n+  >>> login_time < member.getProperty(\'login_time\')\n+  True\n+  >>> last_login_time < member.getProperty(\'last_login_time\')\n+  True\n+\n+The last login time is now set to the previous value of login time:\n+\n+  >>> login_time == member.getProperty(\'last_login_time\')\n+  True\n+\n Log out again:\n \n   >>> browser.getLink(\'Log out\').click()\n@@ -377,7 +433,7 @@ Log out again and then join:\n \n We shouldn\'t be able to fill in our password:\n \n-  >>> browser.getControl(\'Password\').value = \'secret\' # doctest: +ELLIPSIS\n+  >>> browser.getControl(\'Password\').value = TEST_USER_PASSWORD # doctest: +ELLIPSIS\n   Traceback (most recent call last):\n   ...\n   LookupError: label \'Password\'\n@@ -425,8 +481,8 @@ Now that we have the address, we will reset our password:\n   >>> "Please fill out the form below to set your password" in browser.contents\n   True\n   >>> browser.getControl(name=\'userid\').value = \'bsmith\'\n-  >>> browser.getControl(name=\'password\').value = \'secret\'\n-  >>> browser.getControl(name=\'password2\').value = \'secret\'\n+  >>> browser.getControl(name=\'password\').value = TEST_USER_PASSWORD\n+  >>> browser.getControl(name=\'password2\').value = TEST_USER_PASSWORD\n   >>> browser.getControl("Set my password").click()\n   >>> "Password reset successful, you are logged in now!" in browser.contents\n   True\n@@ -471,8 +527,8 @@ We navigate to the Users Adding page and register a new user:\n   >>> browser.open(\'http://nohost/plone/@@new-user\')\n   >>> browser.getControl(\'User Name\').value = \'wwwsmith\'\n   >>> browser.getControl(\'Email\').value = \'wwwsmith@example.com\'\n-  >>> browser.getControl(\'Password\').value = \'secret\'\n-  >>> browser.getControl(\'Confirm password\').value = \'secret\'\n+  >>> browser.getControl(\'Password\').value = TEST_USER_PASSWORD\n+  >>> browser.getControl(\'Confirm password\').value = TEST_USER_PASSWORD\n   >>> browser.getControl(\'Send a confirmation mail with a link to set the password\').selected = True\n \n Now register and logout:\ndiff --git a/Products/CMFPlone/tests/redirection.txt b/Products/CMFPlone/tests/redirection.txt\ndeleted file mode 100644\nindex 1b181ba3f1..0000000000\n--- a/Products/CMFPlone/tests/redirection.txt\n+++ /dev/null\n@@ -1,47 +0,0 @@\n-Redirecting and resource directories\n-====================================\n-\n-When you try to visit a page that does not exist, Plone helpfully\n-shows a link to the parent directory.  Normally this is fine.  But\n-Plone expects this parent directory to be a normal folder or something\n-similar.  It makes some assumptions there that are not valid when the\n-parent is a resource directory.  This gives problems while rendering\n-the default error page.  In particular it results in a TypeError:\n-getTypeInfo.\n-\n-We test this by starting up a test browser:\n-\n-    >>> from plone.testing.zope import Browser\n-    >>> app = layer[\'app\']\n-    >>> browser = Browser(app)\n-\n-Let\'s check what happens when we get a file from a resourceDirectory.\n-This flag exists:\n-\n-  >>> flag_directory = \'http://nohost/plone/++resource++language-flags/\'\n-  >>> browser.open(flag_directory + \'eu.gif\')\n-\n-And this flag does not, so it should raise a 404:\n-\n-  >>> browser.open(flag_directory + \'nonexisting.gif\')\n-  Traceback (most recent call last):\n-  ...\n-  HTTPError: HTTP Error 404: Not Found\n-\n-But it should not give an error while rendering the default error page:\n-\n-  >>> b"the following error occurred while attempting to render the standard error message" in browser.contents\n-  False\n-\n-As it is an image, it should return a JSON message\n-  >>> b\'{"error_type": "NotFound"}\' in browser.contents\n-  True\n-\n-A non-existing page would return a human readable error page\n-  >>> browser.addHeader(\'Accept\', \'text/html\')\n-  >>> browser.open(\'http://nohost/plone/non-existing-page\')\n-  Traceback (most recent call last):\n-  ...\n-  HTTPError: HTTP Error 404: Not Found\n-  >>> "This page does not seem to exist" in browser.contents\n-  True\ndiff --git a/Products/CMFPlone/tests/robot/robot_setup.py b/Products/CMFPlone/tests/robot/robot_setup.py\nindex ae9760f5da..8f0c6adb44 100644\n--- a/Products/CMFPlone/tests/robot/robot_setup.py\n+++ b/Products/CMFPlone/tests/robot/robot_setup.py\n@@ -1,10 +1,9 @@\n from plone.app.robotframework.remote import RemoteLibrary\n from plone.app.robotframework.utils import disableCSRFProtection\n-\n-from zope.component import queryUtility\n-from plone.registry.interfaces import IRegistry\n from plone.base.interfaces import IMailSchema\n from plone.base.interfaces import ISecuritySchema\n+from plone.registry.interfaces import IRegistry\n+from zope.component import queryUtility\n \n \n class CMFPloneRemoteKeywords(RemoteLibrary):\ndiff --git a/Products/CMFPlone/tests/robot/test_overlays.robot b/Products/CMFPlone/tests/robot/test_overlays.robot\nindex 83070070fc..b8fca6d3d9 100644\n--- a/Products/CMFPlone/tests/robot/test_overlays.robot\n+++ b/Products/CMFPlone/tests/robot/test_overlays.robot\n@@ -272,8 +272,8 @@ I enter valid user data\n     Wait until page contains element  name=form.widgets.password_ctl\n     Input text for sure  form.widgets.username       myuser\n     Input text for sure  form.widgets.email          my@email.eu\n-    Input text for sure  form.widgets.password       123123\n-    Input text for sure  form.widgets.password_ctl   123123\n+    Input text for sure  form.widgets.password       newpassword\n+    Input text for sure  form.widgets.password_ctl   newpassword\n \n I enter valid register user data\n     Wait until page contains element  name=form.widgets.username\ndiff --git a/Products/CMFPlone/tests/robot/variables.py b/Products/CMFPlone/tests/robot/variables.py\nindex a32e833f5f..b45dd82498 100644\n--- a/Products/CMFPlone/tests/robot/variables.py\n+++ b/Products/CMFPlone/tests/robot/variables.py\n@@ -1,3 +1,4 @@\n import os\n \n+\n PATH_TO_TEST_FILES = os.path.join(os.path.dirname(__file__))  # noqa\ndiff --git a/Products/CMFPlone/tests/search_form.rst b/Products/CMFPlone/tests/search_form.rst\nindex 466e1a97c8..4777363743 100644\n--- a/Products/CMFPlone/tests/search_form.rst\n+++ b/Products/CMFPlone/tests/search_form.rst\n@@ -3,6 +3,7 @@ We want to test the search form and the resulting page.\n Let\'s create a user to test upon\n see: testControlPanelScripts.txt:\n     >>> from DateTime import DateTime\n+    >>> from plone.app.testing import TEST_USER_PASSWORD\n     >>> app = layer[\'app\']\n     >>> portal = layer[\'portal\']\n     >>> fullname = \'Test User Full Name\'\n@@ -10,7 +11,7 @@ see: testControlPanelScripts.txt:\n     >>> email = \'test@plone.org\'\n     >>> last_login_time = DateTime()\n     >>> membership = portal.portal_membership\n-    >>> membership.addMember(username, \'secret\', [], [])\n+    >>> membership.addMember(username, TEST_USER_PASSWORD, [], [])\n     >>> member = membership.getMemberById(username)\n     >>> member.setMemberProperties({\'fullname\': fullname, \'email\': email,\n     ...                             \'last_login_time\': last_login_time,})\ndiff --git a/Products/CMFPlone/tests/testActionsTool.py b/Products/CMFPlone/tests/testActionsTool.py\nindex 8bcaed7d3a..1d6870ce6f 100644\n--- a/Products/CMFPlone/tests/testActionsTool.py\n+++ b/Products/CMFPlone/tests/testActionsTool.py\n@@ -1,6 +1,7 @@\n from Acquisition import Explicit\n from OFS.SimpleItem import Item\n from plone.app.testing import login\n+from plone.app.testing import TEST_USER_PASSWORD\n from Products.CMFCore.ActionInformation import Action\n from Products.CMFCore.ActionInformation import ActionInfo\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n@@ -23,7 +24,7 @@ class TestActionsTool(unittest.TestCase):\n     def setUp(self):\n         self.portal = self.layer[\'portal\']\n         self.actions = self.portal.portal_actions\n-        self.portal.acl_users._doAddUser(\'user1\', \'secret\', [\'Member\'], [])\n+        self.portal.acl_users._doAddUser(\'user1\', TEST_USER_PASSWORD, [\'Member\'], [])\n         self.portal.invokeFactory(\'Folder\', \'f1\')\n         self.folder = self.portal[\'f1\']\n \ndiff --git a/Products/CMFPlone/tests/testBatch.py b/Products/CMFPlone/tests/testBatch.py\nindex f892192e5d..1e2c70e734 100644\n--- a/Products/CMFPlone/tests/testBatch.py\n+++ b/Products/CMFPlone/tests/testBatch.py\n@@ -2,6 +2,7 @@\n \n import unittest\n \n+\n class TestBatchIntegration(unittest.TestCase):\n \n     layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\ndiff --git a/Products/CMFPlone/tests/testBrowserLayerPrecedence.py b/Products/CMFPlone/tests/testBrowserLayerPrecedence.py\nindex f8d90b229f..e11c0bd5af 100644\n--- a/Products/CMFPlone/tests/testBrowserLayerPrecedence.py\n+++ b/Products/CMFPlone/tests/testBrowserLayerPrecedence.py\n@@ -3,12 +3,12 @@\n # add-on products (a la plone.browserlayer).\n \n from plone.app.testing.bbb import PloneTestCase\n-\n+from plone.browserlayer.utils import register_layer\n+from plone.browserlayer.utils import unregister_layer\n from zope.event import notify\n from zope.interface import Interface\n from zope.publisher.interfaces.browser import IDefaultBrowserLayer\n from zope.traversing.interfaces import BeforeTraverseEvent\n-from plone.browserlayer.utils import register_layer, unregister_layer\n \n \n class IAdditiveLayer(Interface):\ndiff --git a/Products/CMFPlone/tests/testCSRFProtection.py b/Products/CMFPlone/tests/testCSRFProtection.py\nindex fd0d7afb6b..704300b4e7 100644\n--- a/Products/CMFPlone/tests/testCSRFProtection.py\n+++ b/Products/CMFPlone/tests/testCSRFProtection.py\n@@ -1,10 +1,10 @@\n+from io import BytesIO\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n from plone.app.testing.bbb import PloneTestCase\n from plone.keyring.interfaces import IKeyManager\n from plone.protect.authenticator import AuthenticatorView\n-from io import BytesIO\n from zope.component import queryUtility\n \n \n@@ -50,13 +50,13 @@ def test_PloneTool_renameObjectsByPaths(self):\n     def test_RegistrationTool_editMember(self):\n         self.checkAuthenticator(\n             \'/portal_registration/editMember\',\n-            \'member_id=%s&password=y0d4Wg&properties.foo:record=\' % (\n+            \'member_id=%s&password=correct+horse+battery+staple&properties.foo:record=\' % (\n                 TEST_USER_ID))\n \n     def test_MembershipTool_setPassword(self):\n         self.checkAuthenticator(\n             \'/portal_membership/setPassword\',\n-            \'password=y0d4Wg\',\n+            \'password=correct+horse+battery+staple\',\n             status=204)\n \n     def test_MembershipTool_deleteMemberArea(self):\ndiff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py\nindex 50ab21231a..909e7f9178 100644\n--- a/Products/CMFPlone/tests/testCatalogTool.py\n+++ b/Products/CMFPlone/tests/testCatalogTool.py\n@@ -5,6 +5,7 @@\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n+from plone.app.testing import TEST_USER_PASSWORD\n from plone.app.textfield import RichTextValue\n from plone.dexterity.content import CEILING_DATE\n from plone.indexer.wrapper import IndexableObjectWrapper\n@@ -365,7 +366,7 @@ def afterSetUp(self):\n         self.workflow = self.portal.portal_workflow\n         self.groups = self.portal.portal_groups\n \n-        self.portal.acl_users._doAddUser(user2, \'secret\', [], [])\n+        self.portal.acl_users._doAddUser(user2, TEST_USER_PASSWORD, [], [])\n \n         self.folder.invokeFactory(\'Document\', id=\'doc\', text=\'foo\')\n         self.folder.invokeFactory(\'Folder\', id=\'folder2\')\n@@ -1016,7 +1017,7 @@ def afterSetUp(self):\n         self.folder.invokeFactory(\'Document\', id=\'doc\')\n \n         # Create unprivileged user\n-        self.portal.acl_users._doAddUser(user2, \'secret\', [\'Member\'], [])\n+        self.portal.acl_users._doAddUser(user2, TEST_USER_PASSWORD, [\'Member\'], [])\n \n     def nofx(self):\n         # Removes effective and expires to make sure we only test\n@@ -1324,8 +1325,8 @@ def test_is_folderishWithNonStructuralFolder(self):\n         self.assertFalse(is_folderish(f)())\n \n     def test_provided(self):\n-        from Products.CMFCore.interfaces import IContentish\n         from plone.indexer.interfaces import IIndexableObjectWrapper\n+        from Products.CMFCore.interfaces import IContentish\n         from Products.CMFCore.tests.base.dummy import DummyContent\n \n         obj = DummyContent()\ndiff --git a/Products/CMFPlone/tests/testContentSecurity.py b/Products/CMFPlone/tests/testContentSecurity.py\nindex 5d8945cd30..aea5cc0e2a 100644\n--- a/Products/CMFPlone/tests/testContentSecurity.py\n+++ b/Products/CMFPlone/tests/testContentSecurity.py\n@@ -1,5 +1,6 @@\n from AccessControl import Unauthorized\n from Acquisition import aq_base\n+from plone.app.testing import TEST_USER_PASSWORD\n from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n from zExceptions.unauthorized import Unauthorized as zUnauthorized\n from zope.component import getMultiAdapter\n@@ -9,10 +10,10 @@ class TestContentSecurity(PloneTestCase):\n \n     def afterSetUp(self):\n         self.request = self.layer["request"]\n-        self.portal.acl_users._doAddUser(\'user1\', \'secret\', [\'Member\'], [])\n-        self.portal.acl_users._doAddUser(\'user2\', \'secret\', [\'Member\'], [])\n+        self.portal.acl_users._doAddUser(\'user1\', TEST_USER_PASSWORD, [\'Member\'], [])\n+        self.portal.acl_users._doAddUser(\'user2\', TEST_USER_PASSWORD, [\'Member\'], [])\n         #_ender_\'s member who\'s not a Member usecase\n-        self.portal.acl_users._doAddUser(\'user3\', \'secret\', [], [])\n+        self.portal.acl_users._doAddUser(\'user3\', TEST_USER_PASSWORD, [], [])\n         self.membership = self.portal.portal_membership\n         self.workflow = self.portal.portal_workflow\n         self.createMemberarea(\'user1\')\ndiff --git a/Products/CMFPlone/tests/testContentTypeScripts.py b/Products/CMFPlone/tests/testContentTypeScripts.py\nindex 0a0b5207c6..d29e5e6b36 100644\n--- a/Products/CMFPlone/tests/testContentTypeScripts.py\n+++ b/Products/CMFPlone/tests/testContentTypeScripts.py\n@@ -2,8 +2,9 @@\n from plone.app.textfield import RichTextValue\n from plone.namedfile.file import NamedFile\n from plone.namedfile.file import NamedImage\n-from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.tests import dummy\n+from Products.CMFPlone.tests import PloneTestCase\n+\n \n AddPortalTopics = "Add portal topics"\n \ndiff --git a/Products/CMFPlone/tests/testCookieAuth.py b/Products/CMFPlone/tests/testCookieAuth.py\nindex 98071cc2be..9c57d1fd2d 100644\n--- a/Products/CMFPlone/tests/testCookieAuth.py\n+++ b/Products/CMFPlone/tests/testCookieAuth.py\n@@ -6,6 +6,7 @@\n \n import unittest\n \n+\n try:\n     from base64 import encodebytes\n except ImportError:\ndiff --git a/Products/CMFPlone/tests/testCutPasteSecurity.py b/Products/CMFPlone/tests/testCutPasteSecurity.py\nindex d2eb66e2a5..bf99c6252e 100644\n--- a/Products/CMFPlone/tests/testCutPasteSecurity.py\n+++ b/Products/CMFPlone/tests/testCutPasteSecurity.py\n@@ -1,22 +1,22 @@\n from AccessControl import Unauthorized\n from Acquisition import aq_base\n from OFS.CopySupport import CopyError\n-from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n+from plone.app.testing import TEST_USER_PASSWORD\n from Products.CMFCore.interfaces import IContentish\n-from zope.component import provideHandler, getGlobalSiteManager\n-from zope.lifecycleevent.interfaces import IObjectMovedEvent\n+from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n from urllib.error import HTTPError\n+from zope.component import getGlobalSiteManager\n+from zope.component import provideHandler\n+from zope.lifecycleevent.interfaces import IObjectMovedEvent\n \n import transaction\n \n \n-\n-\n class TestCutPasteSecurity(PloneTestCase):\n \n     def afterSetUp(self):\n-        self.portal.acl_users._doAddUser(\'user1\', \'secret\', [\'Member\'], [])\n-        self.portal.acl_users._doAddUser(\'user2\', \'secret\', [\'Member\'], [])\n+        self.portal.acl_users._doAddUser(\'user1\', TEST_USER_PASSWORD, [\'Member\'], [])\n+        self.portal.acl_users._doAddUser(\'user2\', TEST_USER_PASSWORD, [\'Member\'], [])\n         self.membership = self.portal.portal_membership\n         self.createMemberarea(\'user1\')\n         self.createMemberarea(\'user2\')\ndiff --git a/Products/CMFPlone/tests/testDateIndexRanges.py b/Products/CMFPlone/tests/testDateIndexRanges.py\nindex a1954f49c6..1028b54c00 100644\n--- a/Products/CMFPlone/tests/testDateIndexRanges.py\n+++ b/Products/CMFPlone/tests/testDateIndexRanges.py\n@@ -1,6 +1,5 @@\n-from Products.CMFPlone.tests import PloneTestCase\n-\n from DateTime import DateTime\n+from Products.CMFPlone.tests import PloneTestCase\n \n \n class TestDateIndexRanges(PloneTestCase.PloneTestCase):\ndiff --git a/Products/CMFPlone/tests/testDateTimeIntegration.py b/Products/CMFPlone/tests/testDateTimeIntegration.py\nindex 15d39b5f68..b3bafc9503 100644\n--- a/Products/CMFPlone/tests/testDateTimeIntegration.py\n+++ b/Products/CMFPlone/tests/testDateTimeIntegration.py\n@@ -8,8 +8,8 @@\n # for more information about this.  please also note that these tests\n # may produce false positives when run in the GMT time zone!\n \n-from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n from DateTime import DateTime\n+from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n from zope.event import notify\n from zope.lifecycleevent import ObjectModifiedEvent\n \ndiff --git a/Products/CMFPlone/tests/testEmailLogin.py b/Products/CMFPlone/tests/testEmailLogin.py\nindex 075b3bc6b8..0e12786f3c 100644\n--- a/Products/CMFPlone/tests/testEmailLogin.py\n+++ b/Products/CMFPlone/tests/testEmailLogin.py\n@@ -1,11 +1,12 @@\n from AccessControl import Unauthorized\n from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import TEST_USER_PASSWORD\n+from plone.base.interfaces import ISecuritySchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from plone.base.interfaces import ISecuritySchema\n+from Products.CMFPlone.RegistrationTool import get_member_by_login_name\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.utils import set_own_login_name\n-from Products.CMFPlone.RegistrationTool import get_member_by_login_name\n from zope.component import getUtility\n \n \n@@ -30,7 +31,7 @@ def testSetOwnLoginName(self):\n \n     def testSetLoginNameOfOther(self):\n         memship = self.portal.portal_membership\n-        memship.addMember(\'maurits\', \'secret\', [], [])\n+        memship.addMember(\'maurits\', TEST_USER_PASSWORD, [], [])\n         member = memship.getMemberById(\'maurits\')\n         self.assertRaises(Unauthorized, set_own_login_name, member, \'vanrees\')\n         # The admin *should* be able to change the login name of\ndiff --git a/Products/CMFPlone/tests/testExternalEditorEnabled.py b/Products/CMFPlone/tests/testExternalEditorEnabled.py\nindex 860c6a2612..5333d831e4 100644\n--- a/Products/CMFPlone/tests/testExternalEditorEnabled.py\n+++ b/Products/CMFPlone/tests/testExternalEditorEnabled.py\n@@ -1,6 +1,9 @@\n-import unittest\n+from plone.app.testing import TEST_USER_PASSWORD\n from Products.CMFPlone.tests import PloneTestCase\n \n+import unittest\n+\n+\n try:\n     import Products.ExternalEditor\n except ImportError:\n@@ -19,7 +22,7 @@ def afterSetUp(self):\n         self.doc = self.folder.doc\n         self.folder.invokeFactory(\'Folder\', \'folder2\')\n         self.folder = self.folder.folder2\n-        self.portal.acl_users._doAddUser(\'user1\', \'secret\', [\'Member\'], [])\n+        self.portal.acl_users._doAddUser(\'user1\', TEST_USER_PASSWORD, [\'Member\'], [])\n         self.mtool = self.portal.portal_membership\n         member = self.mtool.getAuthenticatedMember()\n         member.setMemberProperties({\'ext_editor\': 1})\ndiff --git a/Products/CMFPlone/tests/testIImagingSchema.py b/Products/CMFPlone/tests/testIImagingSchema.py\nindex 20b302c059..6f404df211 100644\n--- a/Products/CMFPlone/tests/testIImagingSchema.py\n+++ b/Products/CMFPlone/tests/testIImagingSchema.py\n@@ -1,6 +1,6 @@\n from plone.app.testing import PLONE_INTEGRATION_TESTING\n-from plone.registry.interfaces import IRegistry\n from plone.base.interfaces.controlpanel import IImagingSchema\n+from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\n \n import unittest\ndiff --git a/Products/CMFPlone/tests/testInterfaces.py b/Products/CMFPlone/tests/testInterfaces.py\nindex 833ef3b456..46c1cb6afd 100644\n--- a/Products/CMFPlone/tests/testInterfaces.py\n+++ b/Products/CMFPlone/tests/testInterfaces.py\n@@ -14,9 +14,11 @@\n from Products.CMFPlone.URLTool import URLTool\n from Products.CMFPlone.WorkflowTool import WorkflowTool\n from unittest import TestCase\n-from zope.interface import implementedBy, providedBy\n+from zope.interface import implementedBy\n+from zope.interface import providedBy\n from zope.interface.interface import InterfaceClass\n \n+\n # for Python 2\n try:\n     from types import ClassType\n@@ -64,10 +66,10 @@ class InterfaceTest(TestCase):\n \n     def interfaceImplementedByInstanceOf(self, klass, interface):\n         """ tests if the klass implements the interface in the right way """\n-        from zope.interface.verify import verifyClass\n-        from zope.interface.exceptions \\\n-            import BrokenImplementation, DoesNotImplement\n+        from zope.interface.exceptions import BrokenImplementation\n         from zope.interface.exceptions import BrokenMethodImplementation\n+        from zope.interface.exceptions import DoesNotImplement\n+        from zope.interface.verify import verifyClass\n \n         # is the class really implemented by the given interface?\n         self.assertTrue(interface.implementedBy(klass),\n@@ -83,10 +85,10 @@ def interfaceImplementedByInstanceOf(self, klass, interface):\n \n     def interfaceImplementedBy(self, instance, interface):\n         """ tests if the instance implements the interface in the right way """\n-        from zope.interface.verify import verifyObject\n-        from zope.interface.exceptions \\\n-            import BrokenImplementation, DoesNotImplement\n+        from zope.interface.exceptions import BrokenImplementation\n         from zope.interface.exceptions import BrokenMethodImplementation\n+        from zope.interface.exceptions import DoesNotImplement\n+        from zope.interface.verify import verifyObject\n \n         # is the class really implemented by the given interface?\n         self.assertTrue(interface.providedBy(instance),\n@@ -170,10 +172,10 @@ class zope_interface_test(TestCase):\n     def interfaceImplementedBy(self, klass, interface):\n         """ tests if the klass implements the interface in the right way """\n \n-        from zope.interface.verify import verifyClass\n-        from zope.interface.exceptions \\\n-            import BrokenImplementation, DoesNotImplement\n+        from zope.interface.exceptions import BrokenImplementation\n         from zope.interface.exceptions import BrokenMethodImplementation\n+        from zope.interface.exceptions import DoesNotImplement\n+        from zope.interface.verify import verifyClass\n \n         # is the class really implemented by the given interface?\n         self.assertTrue(interface.implementedBy(klass),\n@@ -189,10 +191,10 @@ def interfaceImplementedBy(self, klass, interface):\n \n     def interfaceProvidedBy(self, instance, interface):\n         """ tests if the instance implements the interface in the right way """\n-        from zope.interface.verify import verifyObject\n-        from zope.interface.exceptions \\\n-            import BrokenImplementation, DoesNotImplement\n+        from zope.interface.exceptions import BrokenImplementation\n         from zope.interface.exceptions import BrokenMethodImplementation\n+        from zope.interface.exceptions import DoesNotImplement\n+        from zope.interface.verify import verifyObject\n \n         # is the class really implemented by the given interface?\n         self.assertTrue(interface.providedBy(instance),\n@@ -297,5 +299,5 @@ class KlassInterfaceTest(zope_interface_test):\n def test_suite():\n     suite = unittest.TestSuite()\n     for test in tests:\n-        suite.addTest(unittest.makeSuite(test))\n+        suite.addTest(unittest.defaultTestLoader.loadTestsFromTestCase(test))\n     return suite\ndiff --git a/Products/CMFPlone/tests/testMigrationTool.py b/Products/CMFPlone/tests/testMigrationTool.py\nindex 5cbc746040..48f1647d16 100644\n--- a/Products/CMFPlone/tests/testMigrationTool.py\n+++ b/Products/CMFPlone/tests/testMigrationTool.py\n@@ -1,7 +1,6 @@\n-from Products.CMFPlone.tests import PloneTestCase\n-\n-from Products.CMFPlone.factory import _DEFAULT_PROFILE\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.factory import _DEFAULT_PROFILE\n+from Products.CMFPlone.tests import PloneTestCase\n \n \n # Python 3 is only supported on 5.2+.\n@@ -170,6 +169,7 @@ def test_addon_repr(self):\n     def test_upgrade_all(self):\n         from Products.CMFPlone.MigrationTool import Addon\n         from Products.CMFPlone.MigrationTool import AddonList\n+\n         # real ones:\n         cmfeditions = Addon(profile_id=\'Products.CMFEditions:CMFEditions\')\n         discussion = Addon(profile_id=\'plone.app.discussion:default\')\n@@ -226,6 +226,7 @@ def test_upgrade_all(self):\n     def test_plone_addonlist_upgrade_all(self):\n         # Test the actual filled addon list.\n         from Products.CMFPlone.MigrationTool import ADDON_LIST\n+\n         # Several addons did not get fully upgraded in the past, which\n         # is why this list was created.\n         cmfeditions_id = \'Products.CMFEditions:CMFEditions\'\ndiff --git a/Products/CMFPlone/tests/testNavTree.py b/Products/CMFPlone/tests/testNavTree.py\nindex efd469252c..1b4997b48a 100644\n--- a/Products/CMFPlone/tests/testNavTree.py\n+++ b/Products/CMFPlone/tests/testNavTree.py\n@@ -531,19 +531,17 @@ def testCurrentParent(self):\n class TestNavigationRoot(PloneTestCase.PloneTestCase):\n \n     def testGetNavigationRootPropertyNotSet(self):\n-        self.portal.portal_registry[\'plone.root\'] = \'/\'\n+        del self.portal.portal_registry.records["plone.root"]\n         root = getNavigationRoot(self.portal)\n         self.assertEqual(root, \'/\'.join(self.portal.getPhysicalPath()))\n \n     def testGetNavigationRootPropertyEmptyNoVirtualHost(self):\n-        self.portal.portal_properties.navtree_properties \\\n-            .manage_changeProperties(root=\'\')\n+        self.portal.portal_registry[\'plone.root\'] = \'\'\n         root = getNavigationRoot(self.portal)\n         self.assertEqual(root, \'/\'.join(self.portal.getPhysicalPath()))\n \n     def testGetNavigationRootPropertyIsRoot(self):\n-        self.portal.portal_properties.navtree_properties \\\n-            .manage_changeProperties(root=\'/\')\n+        self.portal.portal_registry[\'plone.root\'] = \'/\'\n         root = getNavigationRoot(self.portal)\n         self.assertEqual(root, \'/\'.join(self.portal.getPhysicalPath()))\n \n@@ -551,7 +549,7 @@ def testGetNavigationRootPropertyIsFolder(self):\n         folderPath = \'/\'.join(self.folder.getPhysicalPath())\n         portalPath = \'/\'.join(self.portal.getPhysicalPath())\n         relativePath = folderPath[len(portalPath):]\n-        self.portal.portal_registry[\'plone.root\'] = str(relativePath)\n+        self.portal.portal_registry[\'plone.root\'] = relativePath\n         root = getNavigationRoot(self.portal)\n         self.assertEqual(root, folderPath)\n \ndiff --git a/Products/CMFPlone/tests/testNavigationView.py b/Products/CMFPlone/tests/testNavigationView.py\nindex ee8b3b64e8..77500d052a 100644\n--- a/Products/CMFPlone/tests/testNavigationView.py\n+++ b/Products/CMFPlone/tests/testNavigationView.py\n@@ -1,337 +1,21 @@\n+from plone.base.interfaces import IHideFromBreadcrumbs\n+from plone.base.interfaces import INavigationSchema\n+from plone.base.interfaces import ITypesSchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFPlone.browser.navigation import CatalogNavigationBreadcrumbs\n from Products.CMFPlone.browser.navigation import CatalogNavigationTabs\n from Products.CMFPlone.browser.navigation import CatalogSiteMap\n from Products.CMFPlone.browser.navigation import PhysicalNavigationBreadcrumbs\n-from plone.base.interfaces import IHideFromBreadcrumbs\n-from plone.base.interfaces import INavigationSchema\n-from plone.base.interfaces import ITypesSchema\n-from Products.CMFPlone.tests import dummy\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.tests.utils import folder_position\n from Products.CMFPlone.tests.utils import validateCSSIdentifier\n from zope.component import getUtility\n from zope.interface import directlyProvides\n \n-import random\n-import string\n \n portal_name = PloneTestCase.portal_name\n \n \n-class TestBaseNavTree(PloneTestCase.PloneTestCase):\n-    """Tests for the navigation tree . This base test is a little geared toward\n-       a catalog based implementation for now.\n-    """\n-\n-    view_class = None\n-\n-    def afterSetUp(self):\n-        self.request = self.app.REQUEST\n-        self.populateSite()\n-        self.setupAuthenticator()\n-        registry = getUtility(IRegistry)\n-        self.navigation_settings = registry.forInterface(\n-            INavigationSchema,\n-            prefix=\'plone\'\n-        )\n-\n-    def populateSite(self):\n-        self.setRoles([\'Manager\'])\n-        self.portal.invokeFactory(\'Document\', \'doc1\')\n-        self.portal.invokeFactory(\'Document\', \'doc2\')\n-        self.portal.invokeFactory(\'Document\', \'doc3\')\n-        self.portal.invokeFactory(\'Folder\', \'folder1\')\n-        self.portal.invokeFactory(\'Link\', \'link1\')\n-        self.portal.link1.remoteUrl = \'http://plone.org\'\n-        self.portal.link1.reindexObject()\n-        folder1 = getattr(self.portal, \'folder1\')\n-        folder1.invokeFactory(\'Document\', \'doc11\')\n-        folder1.invokeFactory(\'Document\', \'doc12\')\n-        folder1.invokeFactory(\'Document\', \'doc13\')\n-        self.portal.invokeFactory(\'Folder\', \'folder2\')\n-        folder2 = getattr(self.portal, \'folder2\')\n-        folder2.invokeFactory(\'Document\', \'doc21\')\n-        folder2.invokeFactory(\'Document\', \'doc22\')\n-        folder2.invokeFactory(\'Document\', \'doc23\')\n-        folder2.invokeFactory(\'File\', \'file21\')\n-        self.setRoles([\'Member\'])\n-\n-    def testCreateNavTree(self):\n-        # See if we can create one at all\n-        view = self.view_class(self.portal, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertTrue(\'children\' in tree)\n-\n-    def testCreateNavTreeCurrentItem(self):\n-        # With the context set to folder2 it should return a dict with\n-        # currentItem set to True\n-        view = self.view_class(self.portal.folder2, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(tree[\'children\'][-1][\'currentItem\'], True)\n-\n-    def testNavTreeExcludesItemsWithExcludeProperty(self):\n-        # Make sure that items witht he exclude_from_nav property set get\n-        # no_display set to True\n-        self.portal.folder2.exclude_from_nav = True\n-        self.portal.folder2.reindexObject()\n-        view = self.view_class(self.portal.folder1.doc11, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        for c in tree[\'children\']:\n-            if c[\'item\'].getPath() == \'/plone/folder2\':\n-                self.fail()\n-\n-    def testShowAllParentsOverridesNavTreeExcludesItemsWithExcludeProp(self):\n-        # Make sure excluded items are not included in the navtree\n-        self.portal.folder2.exclude_from_nav = True\n-        self.portal.folder2.reindexObject()\n-        self.navigation_settings.show_excluded_items = True\n-\n-        view = self.view_class(self.portal.folder2.doc21, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        found = False\n-        for c in tree[\'children\']:\n-            if c[\'item\'].getPath() == \'/plone/folder2\':\n-                found = True\n-                break\n-        self.assertTrue(found)\n-\n-    def testNavTreeExcludesDefaultPage(self):\n-        # Make sure that items which are the default page are excluded\n-        self.portal.folder2.setDefaultPage(\'doc21\')\n-        view = self.view_class(self.portal.folder1.doc11, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        # Ensure that our \'doc21\' default page is not in the tree.\n-        self.assertEqual(\n-            [c for c in tree[\'children\'][-1][\'children\']\n-             if c[\'item\'].getPath()[-5:] == \'doc21\'],\n-            []\n-        )\n-\n-    def testCreateNavTreeWithLink(self):\n-        # BBB getRemoteURL deprecated, remove in Plone 4\n-        view = self.view_class(self.portal, self.request)\n-        tree = view.navigationTree()\n-        for child in tree[\'children\']:\n-            if child[\'portal_type\'] != \'Link\':\n-                self.assertFalse(child[\'item\'].getRemoteUrl)\n-            if child[\'Title\'] == \'link1\':\n-                self.assertEqual(\n-                    child[\'item\'].getRemoteUrl,\n-                    \'http://plone.org\'\n-                )\n-\n-    def testNonStructuralFolderHidesChildren(self):\n-        # Make sure NonStructuralFolders act as if parent_types_not_to_query\n-        # is set.\n-        f = dummy.NonStructuralFolder(\'ns_folder\')\n-        self.folder._setObject(\'ns_folder\', f)\n-        self.portal.portal_catalog.reindexObject(self.folder.ns_folder)\n-        self.portal.portal_catalog.reindexObject(self.folder)\n-        self.navigation_settings.root = \'/Members/test_user_1_\'\n-        view = self.view_class(self.folder.ns_folder, self.request)\n-        tree = view.navigationTree()\n-        self.assertEqual(\n-            tree[\'children\'][0][\'item\'].getPath(),\n-            \'/plone/Members/test_user_1_/ns_folder\'\n-        )\n-        self.assertEqual(len(tree[\'children\'][0][\'children\']), 0)\n-\n-    def testTopLevel(self):\n-        ntp = self.portal.portal_properties.navtree_properties\n-        ntp.manage_changeProperties(topLevel=1)\n-        view = self.view_class(self.portal.folder2.file21, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(\n-            tree[\'children\'][-1][\'item\'].getPath(),\n-            \'/plone/folder2/file21\'\n-        )\n-\n-    def testTopLevelWithContextAboveLevel(self):\n-        ntp = self.portal.portal_properties.navtree_properties\n-        ntp.manage_changeProperties(topLevel=1)\n-        view = self.view_class(self.portal, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(len(tree[\'children\']), 0)\n-\n-    def testTopLevelTooDeep(self):\n-        ntp = self.portal.portal_properties.navtree_properties\n-        ntp.manage_changeProperties(topLevel=5)\n-        view = self.view_class(self.portal, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(len(tree[\'children\']), 0)\n-\n-    def testTopLevelWithNavigationRoot(self):\n-        self.portal.folder2.invokeFactory(\'Folder\', \'folder21\')\n-        self.portal.folder2.folder21.invokeFactory(\'Document\', \'doc211\')\n-        self.navigation_settings.root = \'/folder2\'\n-        ntp = self.portal.portal_properties.navtree_properties\n-        ntp.manage_changeProperties(topLevel=1)\n-        view = self.view_class(self.portal.folder2.folder21, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(len(tree[\'children\']), 1)\n-        self.assertEqual(tree[\'children\'][0][\'item\'].getPath(),\n-                         \'/plone/folder2/folder21/doc211\')\n-\n-    def testTopLevelWithPortalFactory(self):\n-        cid = \'\'.join(\n-            [random.choice(string.ascii_lowercase) for x in range(10)]\n-        )\n-        typeName = \'Document\'\n-        newObject = self.portal.folder1.restrictedTraverse(\n-            \'portal_factory/\' + typeName + \'/\' + cid)\n-        # Will raise a KeyError unless bug is fixed\n-        view = self.view_class(newObject, self.request)\n-        view.navigationTree()\n-\n-    def testShowAllParentsOverridesBottomLevel(self):\n-        ntp = self.portal.portal_properties.navtree_properties\n-        ntp.manage_changeProperties(bottomLevel=1)\n-        view = self.view_class(self.portal.folder2.file21, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        # Note: showAllParents makes sure we actually return items on the,\n-        # path to the context, but the portlet will not display anything\n-        # below bottomLevel.\n-        self.assertEqual(tree[\'children\'][-1][\'item\'].getPath(),\n-                         \'/plone/folder2\')\n-        self.assertEqual(len(tree[\'children\'][-1][\'children\']), 1)\n-        self.assertEqual(tree[\'children\'][-1][\'children\'][0][\'item\'].getPath(),\n-                         \'/plone/folder2/file21\')\n-\n-    def testBottomLevelStopsAtFolder(self):\n-        ntp = self.portal.portal_properties.navtree_properties\n-        ntp.manage_changeProperties(bottomLevel=1)\n-        view = self.view_class(self.portal.folder2, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(tree[\'children\'][-1][\'item\'].getPath(),\n-                         \'/plone/folder2\')\n-        self.assertEqual(len(tree[\'children\'][-1][\'children\']), 0)\n-\n-    def testNoRootSet(self):\n-        self.navigation_settings.root = \'\'\n-        view = self.view_class(self.portal.folder2.file21, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(tree[\'children\'][-1][\'item\'].getPath(),\n-                         \'/plone/folder2\')\n-\n-    def testRootIsPortal(self):\n-        self.navigation_settings.root = \'/\'\n-        view = self.view_class(self.portal.folder2.file21, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(tree[\'children\'][-1][\'item\'].getPath(),\n-                         \'/plone/folder2\')\n-\n-    def testRootIsNotPortal(self):\n-        self.navigation_settings.root = \'/folder2\'\n-        view = self.view_class(self.portal.folder2.file21, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(tree[\'children\'][0][\'item\'].getPath(),\n-                         \'/plone/folder2/doc21\')\n-\n-    def testRootDoesNotExist(self):\n-        self.navigation_settings.root = \'/dodo\'\n-        view = self.view_class(self.portal.folder2.file21, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(tree.get(\'item\', None), None)\n-        self.assertEqual(len(tree[\'children\']), 0)\n-\n-    def testAboveRoot(self):\n-        self.navigation_settings.root = \'/folder2\'\n-        view = self.view_class(self.portal, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(\n-            tree[\'children\'][0][\'item\'].getPath(),\n-            \'/plone/folder2/doc21\'\n-        )\n-\n-    def testOutsideRoot(self):\n-        self.navigation_settings.root = \'/folder2\'\n-        view = self.view_class(self.portal.folder1, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(\n-            tree[\'children\'][0][\'item\'].getPath(),\n-            \'/plone/folder2/doc21\'\n-        )\n-\n-    def testRootIsCurrent(self):\n-        view = self.view_class(self.portal.folder2,\n-                               self.request,\n-                               currentFolderOnly=True)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertEqual(\n-            tree[\'children\'][0][\'item\'].getPath(),\n-            \'/plone/folder2/doc21\'\n-        )\n-\n-    def testCustomQuery(self):\n-        # Try a custom query script for the navtree that returns only published\n-        # objects\n-        self.portal._delObject(\'Members\')\n-        self.portal._delObject(\'news\')\n-        self.portal._delObject(\'events\')\n-        workflow = self.portal.portal_workflow\n-        factory = self.portal.manage_addProduct[\'PythonScripts\']\n-        factory.manage_addPythonScript(\'getCustomNavQuery\')\n-        script = self.portal.getCustomNavQuery\n-        script.ZPythonScript_edit(\'\', \'return {"review_state":"published"}\')\n-        self.assertEqual(self.portal.getCustomNavQuery(),\n-                         {"review_state": "published"})\n-        view = self.view_class(self.portal.folder2, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertTrue(\'children\' in tree)\n-        # Should only contain current object\n-        self.assertEqual(len(tree[\'children\']), 1)\n-        # change workflow for folder1\n-        workflow.doActionFor(self.portal.folder1, \'publish\')\n-        self.portal.folder1.reindexObject()\n-        view = self.view_class(self.portal.folder2, self.request)\n-        tree = view.navigationTree()\n-        # Should only contain current object and published folder\n-        self.assertEqual(len(tree[\'children\']), 2)\n-\n-    def testStateFiltering(self):\n-        # Test Navtree workflow state filtering\n-        self.portal._delObject(\'Members\')\n-        self.portal._delObject(\'news\')\n-        self.portal._delObject(\'events\')\n-        workflow = self.portal.portal_workflow\n-\n-        self.navigation_settings.workflow_states_to_show = (\'published\',)\n-        self.navigation_settings.filter_on_workflow = True\n-        view = self.view_class(self.portal.folder2, self.request)\n-        tree = view.navigationTree()\n-        self.assertTrue(tree)\n-        self.assertTrue(\'children\' in tree)\n-        # Should only contain current object\n-        self.assertEqual(len(tree[\'children\']), 1)\n-        # change workflow for folder1\n-        workflow.doActionFor(self.portal.folder1, \'publish\')\n-        self.portal.folder1.reindexObject()\n-        view = self.view_class(self.portal.folder2, self.request)\n-        tree = view.navigationTree()\n-        # Should only contain current object and published folder\n-        self.assertEqual(len(tree[\'children\']), 2)\n-\n-\n class TestSiteMap(PloneTestCase.PloneTestCase):\n     """Tests for the sitemap view implementations. This base test is a little\n         geared toward a catalog based implementation for now.\n@@ -788,7 +472,8 @@ def testBreadcrumbsFilterByInterface2(self):\n \n \n def test_suite():\n-    from unittest import TestSuite, makeSuite\n+    from unittest import makeSuite\n+    from unittest import TestSuite\n     suite = TestSuite()\n     suite.addTest(makeSuite(TestCatalogPortalTabs))\n     suite.addTest(makeSuite(TestSiteMap))\ndiff --git a/Products/CMFPlone/tests/testNextPrevious.py b/Products/CMFPlone/tests/testNextPrevious.py\nindex 6f98616085..06139e9f71 100644\n--- a/Products/CMFPlone/tests/testNextPrevious.py\n+++ b/Products/CMFPlone/tests/testNextPrevious.py\n@@ -1,5 +1,5 @@\n-from Products.CMFPlone.tests import PloneTestCase\n from plone.app.layout.nextprevious.interfaces import INextPreviousProvider\n+from Products.CMFPlone.tests import PloneTestCase\n \n \n class TestNextPrevious(PloneTestCase.PloneTestCase):\ndiff --git a/Products/CMFPlone/tests/testPloneTool.py b/Products/CMFPlone/tests/testPloneTool.py\nindex 86a8d2b365..712dbb04aa 100644\n--- a/Products/CMFPlone/tests/testPloneTool.py\n+++ b/Products/CMFPlone/tests/testPloneTool.py\n@@ -1,5 +1,6 @@\n from Acquisition import Implicit\n from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import TEST_USER_PASSWORD\n from plone.base.interfaces import IReorderedEvent\n from plone.base.interfaces import ISearchSchema\n from plone.registry.interfaces import IRegistry\n@@ -171,7 +172,7 @@ class TestOwnershipStuff(PloneTestCase.PloneTestCase):\n     def afterSetUp(self):\n         self.utils = self.portal.plone_utils\n         self.membership = self.portal.portal_membership\n-        self.membership.addMember("new_owner", "secret", ["Member"], [])\n+        self.membership.addMember("new_owner", TEST_USER_PASSWORD, ["Member"], [])\n         self.folder.invokeFactory("Folder", "folder1")\n         self.folder1 = self.folder.folder1\n         self.folder1.invokeFactory("Folder", "folder2")\ndiff --git a/Products/CMFPlone/tests/testPortalCreation.py b/Products/CMFPlone/tests/testPortalCreation.py\nindex 0fc4b4aa12..bca91df49e 100644\n--- a/Products/CMFPlone/tests/testPortalCreation.py\n+++ b/Products/CMFPlone/tests/testPortalCreation.py\n@@ -1,4 +1,7 @@\n from Acquisition import aq_base\n+from plone.base.interfaces import IFilterSchema\n+from plone.base.interfaces import INavigationSchema\n+from plone.base.interfaces import ISearchSchema\n from plone.portlets.constants import CONTEXT_CATEGORY as CONTEXT_PORTLETS\n from plone.portlets.interfaces import ILocalPortletAssignmentManager\n from plone.portlets.interfaces import IPortletAssignmentMapping\n@@ -10,9 +13,6 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import setuphandlers\n from Products.CMFPlone.factory import _DEFAULT_PROFILE\n-from plone.base.interfaces import IFilterSchema\n-from plone.base.interfaces import INavigationSchema\n-from plone.base.interfaces import ISearchSchema\n from Products.CMFPlone.tests import dummy\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.UnicodeSplitter import I18NNormalizer\n@@ -20,7 +20,7 @@\n from Products.GenericSetup.browser.manage import ExportStepsView\n from Products.GenericSetup.browser.manage import ImportStepsView\n from Products.StandardCacheManagers.AcceleratedHTTPCacheManager import (\n-    AcceleratedHTTPCacheManager\n+    AcceleratedHTTPCacheManager,\n )\n from Products.StandardCacheManagers.RAMCacheManager import RAMCacheManager\n from zope.component import getGlobalSiteManager\ndiff --git a/Products/CMFPlone/tests/testQueryCatalog.py b/Products/CMFPlone/tests/testQueryCatalog.py\nindex 2073903c67..5657c6bc71 100644\n--- a/Products/CMFPlone/tests/testQueryCatalog.py\n+++ b/Products/CMFPlone/tests/testQueryCatalog.py\n@@ -1,9 +1,9 @@\n # Test queryCatalog and plone search forms\n from plone.app.textfield.value import RichTextValue\n-from plone.registry.interfaces import IRegistry\n from plone.base.interfaces import INavigationSchema\n from plone.base.interfaces import ISearchSchema\n from plone.base.interfaces.syndication import ISiteSyndicationSettings\n+from plone.registry.interfaces import IRegistry\n from Products.CMFPlone.tests import PloneTestCase\n from Products.ZCTextIndex.ParseTree import ParseError\n from zExceptions import NotFound\n@@ -133,10 +133,14 @@ def testNavigationRoot(self):\n \n     def testNavigationRootDoesNotOverrideExplicitPath(self):\n         request = {\'SearchableText\': \'a*\', \'path\': \'/yyy/zzz\'}\n-        ntp = self.portal.portal_properties.navtree_properties\n         self.setRoles((\'Manager\',))\n         self.portal.invokeFactory(\'Folder\', \'foo\')\n-        ntp.root = \'/foo\'\n+        registry = getUtility(IRegistry)\n+        navigation_settings = registry.forInterface(\n+            INavigationSchema,\n+            prefix=\'plone\'\n+        )\n+        navigation_settings.root = \'/\'\n         qry = self.folder.queryCatalog(request, use_navigation_root=True)\n         self.assertEqual(\'/yyy/zzz\', qry[\'path\'])\n \ndiff --git a/Products/CMFPlone/tests/testRegistrationTool.py b/Products/CMFPlone/tests/testRegistrationTool.py\nindex f9e722d42d..a49561a014 100644\n--- a/Products/CMFPlone/tests/testRegistrationTool.py\n+++ b/Products/CMFPlone/tests/testRegistrationTool.py\n@@ -1,14 +1,19 @@\n-import unittest\n-\n+from re import T\n from AccessControl import Unauthorized\n+from plone.app.testing import TEST_USER_PASSWORD\n+from plone.base.interfaces.controlpanel import IMailSchema\n+from plone.base.interfaces.controlpanel import ISiteSchema\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.permissions import AddPortalMember\n from Products.CMFPlone.RegistrationTool import _checkEmail\n-from plone.base.interfaces.controlpanel import IMailSchema, ISiteSchema\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.tests.utils import MockMailHost\n from Products.MailHost.interfaces import IMailHost\n-from plone.registry.interfaces import IRegistry\n-from zope.component import getSiteManager, getUtility\n+from zope.component import getSiteManager\n+from zope.component import getUtility\n+\n+import unittest\n+\n \n member_id = \'new_member\'\n \n@@ -29,7 +34,7 @@ def afterSetUp(self):\n         self.portal.acl_users._doAddGroup("groupid", ())\n \n     def testJoinCreatesUser(self):\n-        self.registration.addMember(member_id, \'secret\',\n+        self.registration.addMember(member_id, TEST_USER_PASSWORD,\n                                     properties={\'username\': member_id,\n                                                 \'email\': \'foo@bar.com\'})\n         user = self.portal.acl_users.getUserById(member_id)\n@@ -39,12 +44,12 @@ def testCannotRegisterWithRootAdminUsername(self):\n         root_user = self.portal.aq_parent.acl_users.users.listUserIds()[0]\n         self.assertRaises(ValueError,\n                           self.registration.addMember,\n-                          root_user, \'secret\',\n+                          root_user, TEST_USER_PASSWORD,\n                           properties={\'username\': root_user,\n                                       \'email\': \'foo@bar.com\'})\n \n     def testJoinWithUppercaseEmailCreatesUser(self):\n-        self.registration.addMember(member_id, \'secret\',\n+        self.registration.addMember(member_id, TEST_USER_PASSWORD,\n                                     properties={\'username\': member_id,\n                                                 \'email\': \'FOO@BAR.COM\'})\n         user = self.portal.acl_users.getUserById(member_id)\n@@ -53,13 +58,13 @@ def testJoinWithUppercaseEmailCreatesUser(self):\n     def testJoinWithoutEmailRaisesValueError(self):\n         self.assertRaises(ValueError,\n                           self.registration.addMember,\n-                          member_id, \'secret\',\n+                          member_id, TEST_USER_PASSWORD,\n                           properties={\'username\': member_id, \'email\': \'\'})\n \n     def testJoinWithBadEmailRaisesValueError(self):\n         self.assertRaises(ValueError,\n                           self.registration.addMember,\n-                          member_id, \'secret\',\n+                          member_id, TEST_USER_PASSWORD,\n                           properties={\n                               \'username\': member_id,\n                               \'email\': \'foo@bar.com, fred@bedrock.com\'})\n@@ -67,23 +72,23 @@ def testJoinWithBadEmailRaisesValueError(self):\n     def testJoinAsExistingMemberRaisesValueError(self):\n         self.assertRaises(ValueError,\n                           self.registration.addMember,\n-                          PloneTestCase.default_user, \'secret\',\n+                          PloneTestCase.default_user, TEST_USER_PASSWORD,\n                           properties={\'username\': \'Dr FooBar\',\n                                       \'email\': \'foo@bar.com\'})\n \n     def testJoinAsExistingNonMemberUserRaisesValueError(self):\n         # http://dev.plone.org/plone/ticket/3221\n-        self.portal.acl_users._doAddUser(member_id, \'secret\', [], [])\n+        self.portal.acl_users._doAddUser(member_id, TEST_USER_PASSWORD, [], [])\n         self.assertRaises(ValueError,\n                           self.registration.addMember,\n-                          member_id, \'secret\',\n+                          member_id, TEST_USER_PASSWORD,\n                           properties={\'username\': member_id,\n                                       \'email\': \'foo@bar.com\'})\n \n     def testJoinWithPortalIdAsUsernameRaisesValueError(self):\n         self.assertRaises(ValueError,\n                           self.registration.addMember,\n-                          self.portal.getId(), \'secret\',\n+                          self.portal.getId(), TEST_USER_PASSWORD,\n                           properties={\'username\': \'Dr FooBar\',\n                                       \'email\': \'foo@bar.com\'})\n \n@@ -101,23 +106,23 @@ def testTestPasswordValidityConfirm(self):\n             \'validpassword\', confirm=\'anotherpassword\') is None)\n \n     def testTestPasswordValidityPolicy(self):\n-        self.assertIsNone(self.registration.testPasswordValidity("abcde", confirm=None))\n+        self.assertIsNone(self.registration.testPasswordValidity(TEST_USER_PASSWORD, confirm=None))\n         self.assertEqual(\n             self.registration.testPasswordValidity("abcd", confirm=None),\n-            "Your password must contain at least 5 characters.",\n+            "Your password must contain at least ${min_chars} characters.",\n         )\n         # Password validity is checked with an empty password\n         # to get a nice help message to show for the input field.\n         self.assertEqual(\n             self.registration.testPasswordValidity("", confirm=None),\n-            "Minimum 5 characters.",\n+            "Minimum ${min_chars} characters.",\n         )\n \n     def testPasValidation(self):\n-        self.assertIsNone(self.registration.pasValidation("password", "abcde"))\n+        self.assertIsNone(self.registration.pasValidation("password", TEST_USER_PASSWORD))\n         self.assertEqual(\n             self.registration.pasValidation("password", "abcd"),\n-            "Your password must contain at least 5 characters.",\n+            "Your password must contain at least ${min_chars} characters.",\n         )\n \n     def testNewIdAllowed(self):\n@@ -141,7 +146,7 @@ def testRegisteredNotify(self):\n         sm.unregisterUtility(provided=IMailHost)\n         sm.registerUtility(mails, IMailHost)\n         # Register a user\n-        self.registration.addMember(member_id, \'secret\',\n+        self.registration.addMember(member_id, TEST_USER_PASSWORD,\n                                     properties={\'username\': member_id,\n                                                 \'email\': \'foo@bar.com\'})\n \n@@ -171,7 +176,7 @@ def testRegisteredNotifyEncoding(self):\n         sm.unregisterUtility(provided=IMailHost)\n         sm.registerUtility(mails, IMailHost)\n         # Register a user\n-        self.registration.addMember(member_id, \'secret\',\n+        self.registration.addMember(member_id, TEST_USER_PASSWORD,\n                                     properties={\'username\': member_id,\n                                                 \'email\': \'foo@bar.com\'})\n         registry = getUtility(IRegistry)\n@@ -200,7 +205,7 @@ def testMailPassword(self):\n         sm.unregisterUtility(provided=IMailHost)\n         sm.registerUtility(mails, IMailHost)\n         # Register a user\n-        self.registration.addMember(member_id, \'secret\',\n+        self.registration.addMember(member_id, TEST_USER_PASSWORD,\n                                     properties={\'username\': member_id,\n                                                 \'email\': \'foo@bar.com\'})\n \n@@ -231,7 +236,7 @@ def testMailPasswordEncoding(self):\n         sm.unregisterUtility(provided=IMailHost)\n         sm.registerUtility(mails, IMailHost)\n         # Register a user\n-        self.registration.addMember(member_id, \'secret\',\n+        self.registration.addMember(member_id, TEST_USER_PASSWORD,\n                                     properties={\'username\': member_id,\n                                                 \'email\': \'foo@bar.com\'})\n         registry = getUtility(IRegistry)\ndiff --git a/Products/CMFPlone/tests/testResourceRegistries.py b/Products/CMFPlone/tests/testResourceRegistries.py\nindex a619d4679e..211bce6912 100644\n--- a/Products/CMFPlone/tests/testResourceRegistries.py\n+++ b/Products/CMFPlone/tests/testResourceRegistries.py\n@@ -82,6 +82,13 @@ def test_scripts_viewlet(self):\n         self.assertIn("++plone++static/bundle-plone/bundle.min.js", results)\n         self.assertIn("http://nohost/plone/++webresource++", results)\n \n+    def test_scripts_data_bundle_attr(self):\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        self._make_test_bundle()\n+        scripts.update()\n+        result = scripts.render()\n+        self.assertIn(\'data-bundle="foobar"\', result)\n+\n     def test_scripts_viewlet_anonymous(self):\n         logout()\n         scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n@@ -188,6 +195,25 @@ def test_styles_viewlet(self):\n         self.assertIn("++theme++barceloneta/css/barceloneta.min.css", results)\n         self.assertIn("http://nohost/plone/++webresource++", results)\n \n+    def test_styles_data_bundle_attr(self):\n+        styles = StylesView(self.layer["portal"], self.layer["request"], None)\n+\n+        # add some bundle to test with\n+        registry = getUtility(IRegistry)\n+\n+        bundles = registry.collectionOfInterface(\n+            IBundleRegistry, prefix="plone.bundles"\n+        )\n+        bundle = bundles.add("foobar")\n+        bundle.name = "foobar"\n+        bundle.jscompilation = "http://foo.bar/foobar.js"\n+        bundle.csscompilation = "http://foo.bar/foobar.css"\n+        bundle.resources = ["foobar"]\n+\n+        styles.update()\n+        results = styles.render()\n+        self.assertIn(\'data-bundle="foobar"\', results)\n+\n     def test_styles_viewlet_anonymous(self):\n         logout()\n         styles = StylesView(self.layer["portal"], self.layer["request"], None)\n@@ -368,6 +394,19 @@ def test_scripts_anonymous(self):\n         self.assertNotIn("http://test2.foo/member.min.js", results)\n         self.assertIn("http://test3.foo/test.min.js", results)\n \n+    def test_scripts_switching_roles(self):\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        scripts.update()\n+        results = scripts.render()\n+        self.assertIn("http://test2.foo/member.min.js", results)\n+\n+        logout()\n+\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        scripts.update()\n+        results = scripts.render()\n+        self.assertNotIn("http://test2.foo/member.min.js", results)\n+\n \n class TestRRControlPanel(PloneTestCase.PloneTestCase):\n \ndiff --git a/Products/CMFPlone/tests/testRestrictedAcquisition.py b/Products/CMFPlone/tests/testRestrictedAcquisition.py\nindex dda5d66426..ba285c00ee 100644\n--- a/Products/CMFPlone/tests/testRestrictedAcquisition.py\n+++ b/Products/CMFPlone/tests/testRestrictedAcquisition.py\n@@ -8,11 +8,10 @@\n # root. Rolling back the abovementioned checkin restores functionality.\n #\n \n-from Products.CMFPlone.tests import PloneTestCase\n-\n-from AccessControl.class_init import InitializeClass\n from AccessControl import ClassSecurityInfo\n+from AccessControl.class_init import InitializeClass\n from OFS.SimpleItem import SimpleItem\n+from Products.CMFPlone.tests import PloneTestCase\n \n \n class AllowedItem(SimpleItem):\ndiff --git a/Products/CMFPlone/tests/testSearch.py b/Products/CMFPlone/tests/testSearch.py\nindex 0e6f786e55..367bd7ed63 100644\n--- a/Products/CMFPlone/tests/testSearch.py\n+++ b/Products/CMFPlone/tests/testSearch.py\n@@ -1,32 +1,28 @@\n-import sys\n-import time\n-import unittest\n-\n from DateTime import DateTime\n-\n-from plone.app.testing import TEST_USER_NAME, TEST_USER_ID\n+from plone.app.contentlisting.interfaces import IContentListing\n+from plone.app.testing import applyProfile\n+from plone.app.testing import IntegrationTesting\n from plone.app.testing import login\n+from plone.app.testing import PLONE_FIXTURE\n+from plone.app.testing import PloneSandboxLayer\n from plone.app.testing import setRoles\n+from plone.app.testing import TEST_USER_ID\n+from plone.app.testing import TEST_USER_NAME\n+from plone.app.textfield import RichTextValue\n+from plone.base.interfaces import ISearchSchema\n+from plone.registry.interfaces import IRegistry\n+from z3c.form.interfaces import IFormLayer\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n-from plone.registry.interfaces import IRegistry\n-\n-from plone.base.interfaces import ISearchSchema\n-\n-from plone.app.contentlisting.interfaces import IContentListing\n-from plone.app.textfield import RichTextValue\n-\n from zope.configuration import xmlconfig\n from zope.interface import alsoProvides\n from zope.publisher.browser import setDefaultSkin\n-from z3c.form.interfaces import IFormLayer\n-from ZPublisher.HTTPResponse import HTTPResponse\n from ZPublisher.HTTPRequest import HTTPRequest\n+from ZPublisher.HTTPResponse import HTTPResponse\n \n-from plone.app.testing import PloneSandboxLayer\n-from plone.app.testing import applyProfile\n-from plone.app.testing import PLONE_FIXTURE\n-from plone.app.testing import IntegrationTesting\n+import sys\n+import time\n+import unittest\n \n \n def test_request():\n@@ -366,5 +362,5 @@ def test_suite():\n     above\n     """\n     suite = unittest.TestSuite()\n-    suite.addTest(unittest.makeSuite(TestSection))\n+    suite.addTest(unittest.defaultTestLoader.loadTestsFromTestCase(TestSection))\n     return suite\ndiff --git a/Products/CMFPlone/tests/testSecurity.py b/Products/CMFPlone/tests/testSecurity.py\nindex 5286d8ee2a..84a6ee12fb 100644\n--- a/Products/CMFPlone/tests/testSecurity.py\n+++ b/Products/CMFPlone/tests/testSecurity.py\n@@ -1,5 +1,3 @@\n-from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n-from Testing.makerequest import makerequest\n from plone.app.testing import login\n from plone.app.testing import logout\n from plone.app.testing import SITE_OWNER_NAME\n@@ -87,7 +85,9 @@ def test_widget_traversal_2(self):\n     def test_registerConfiglet_1(self):\n         VECTOR = "/plone/portal_controlpanel/registerConfiglet?id=cake&name=Cakey&action=woo&permission=View&icon_expr="\n         res = self.publish(VECTOR)\n-        self.assertEqual(404, res.status)\n+        self.assertEqual(302, res.status)\n+        self.assertTrue(res.headers[\'location\'].startswith(\n+            \'http://nohost/plone/acl_users/credentials_cookie_auth/require_login\'))\n \n     def test_registerConfiglet_2(self):\n         VECTOR = "/plone/portal_controlpanel/registerConfiglet?id=cake&name=Cakey&action=woo&permission=View&icon_expr="\n@@ -154,7 +154,7 @@ def get_admin_browser(self):\n         browser.handleErrors = False\n         browser.addHeader(\n             "Authorization",\n-            "Basic {0}:{1}".format(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),\n+            f"Basic {SITE_OWNER_NAME}:{SITE_OWNER_PASSWORD}",\n         )\n         return browser\n \ndiff --git a/Products/CMFPlone/tests/testSecurityDeclarations.py b/Products/CMFPlone/tests/testSecurityDeclarations.py\nindex fd6a447558..af3d333a52 100644\n--- a/Products/CMFPlone/tests/testSecurityDeclarations.py\n+++ b/Products/CMFPlone/tests/testSecurityDeclarations.py\n@@ -1,15 +1,14 @@\n # Tests the security declarations Plone makes on resources\n # for access by restricted code (aka PythonScripts)\n \n-from Products.CMFPlone.tests import PloneTestCase\n-from Products.CMFPlone.tests import dummy\n-\n-from zExceptions import Unauthorized\n-from ZODB.POSException import ConflictError\n-from Products.ZCTextIndex.ParseTree import ParseError\n from OFS.CopySupport import CopyError\n from plone.testing import zope\n+from Products.CMFPlone.tests import dummy\n+from Products.CMFPlone.tests import PloneTestCase\n+from Products.ZCTextIndex.ParseTree import ParseError\n from unittest import TestCase\n+from zExceptions import Unauthorized\n+from ZODB.POSException import ConflictError\n \n \n class RestrictedPythonTest(TestCase):\ndiff --git a/Products/CMFPlone/tests/testSyndication.py b/Products/CMFPlone/tests/testSyndication.py\nindex 4dd52fe92a..a3b4c0e55a 100644\n--- a/Products/CMFPlone/tests/testSyndication.py\n+++ b/Products/CMFPlone/tests/testSyndication.py\n@@ -1,15 +1,16 @@\n-import re\n-from Products.CMFCore.utils import getToolByName\n from AccessControl import Unauthorized\n from plone.app.textfield import RichTextValue\n-from Products.CMFPlone.tests import PloneTestCase\n+from plone.base.interfaces.syndication import IFeed\n from plone.base.interfaces.syndication import IFeedSettings\n from plone.base.interfaces.syndication import ISiteSyndicationSettings\n from plone.registry.interfaces import IRegistry\n-from zope.component import getUtility\n-from zExceptions import NotFound\n-from plone.base.interfaces.syndication import IFeed\n+from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.browser.syndication.adapters import DexterityItem\n+from Products.CMFPlone.tests import PloneTestCase\n+from zExceptions import NotFound\n+from zope.component import getUtility\n+\n+import re\n \n \n class BaseSyndicationTest(PloneTestCase.PloneTestCase):\ndiff --git a/Products/CMFPlone/tests/testTranslationServiceTool.py b/Products/CMFPlone/tests/testTranslationServiceTool.py\nindex 801a6098a0..456ea03de6 100644\n--- a/Products/CMFPlone/tests/testTranslationServiceTool.py\n+++ b/Products/CMFPlone/tests/testTranslationServiceTool.py\n@@ -1,7 +1,7 @@\n # Test toLocalizedTime script and TranslationServiceTool.\n \n-from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.tests import PloneTestCase\n \n \n class TestUTranslate(PloneTestCase.PloneTestCase):\ndiff --git a/Products/CMFPlone/tests/testURLTool.py b/Products/CMFPlone/tests/testURLTool.py\nindex a84271b953..2488fb74a6 100644\n--- a/Products/CMFPlone/tests/testURLTool.py\n+++ b/Products/CMFPlone/tests/testURLTool.py\n@@ -1,14 +1,13 @@\n-import unittest\n-\n-from Products.CMFCore.tests.base.dummy import DummySite\n-from Products.CMFCore.tests.base.dummy import DummyFolder\n-from Products.CMFCore.tests.base.dummy import DummyContent\n-\n from Acquisition import aq_parent\n-from plone.registry.interfaces import IRegistry\n from plone.base.interfaces import ILoginSchema\n+from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.tests.base.dummy import DummyContent\n+from Products.CMFCore.tests.base.dummy import DummyFolder\n+from Products.CMFCore.tests.base.dummy import DummySite\n from zope.component import getSiteManager\n \n+import unittest\n+\n \n class DummyFolder(DummyFolder):\n \ndiff --git a/Products/CMFPlone/tests/testUnicodeSplitter.py b/Products/CMFPlone/tests/testUnicodeSplitter.py\nindex 6e1fa69b53..06aa2be046 100644\n--- a/Products/CMFPlone/tests/testUnicodeSplitter.py\n+++ b/Products/CMFPlone/tests/testUnicodeSplitter.py\n@@ -5,6 +5,7 @@\n from Products.CMFCore.tests.base.dummy import DummyContent\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+\n # adding UnicodeSplitterPatcth\n from Products.CMFPlone.UnicodeSplitter import CaseNormalizer\n from Products.CMFPlone.UnicodeSplitter import process_str\ndiff --git a/Products/CMFPlone/tests/testUserFolderBasics.py b/Products/CMFPlone/tests/testUserFolderBasics.py\nindex d8d5919b22..1cf5338cb0 100644\n--- a/Products/CMFPlone/tests/testUserFolderBasics.py\n+++ b/Products/CMFPlone/tests/testUserFolderBasics.py\n@@ -4,16 +4,17 @@\n from AccessControl import Unauthorized\n from plone.app.testing import login\n from plone.app.testing import logout\n+from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n-from plone.app.testing import setRoles\n from plone.app.testing.bbb import _createMemberarea\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from ZPublisher.utils import basic_auth_encode\n \n import unittest\n \n+\n user_role = \'Member\'\n \n \ndiff --git a/Products/CMFPlone/tests/testWebDAV.py b/Products/CMFPlone/tests/testWebDAV.py\nindex 7ab89b0644..2adf356901 100644\n--- a/Products/CMFPlone/tests/testWebDAV.py\n+++ b/Products/CMFPlone/tests/testWebDAV.py\n@@ -448,7 +448,8 @@ def test_propfind_folder_index_html_not_exists(self):\n \n \n def test_suite():\n-    from unittest import TestSuite, makeSuite\n+    from unittest import makeSuite\n+    from unittest import TestSuite\n     suite = TestSuite()\n     if bbb.HAS_ZSERVER:\n         suite.addTest(makeSuite(TestDAVProperties))\ndiff --git a/Products/CMFPlone/tests/testWorkflowTool.py b/Products/CMFPlone/tests/testWorkflowTool.py\nindex d9a64e7d5c..298c20fcef 100644\n--- a/Products/CMFPlone/tests/testWorkflowTool.py\n+++ b/Products/CMFPlone/tests/testWorkflowTool.py\n@@ -1,8 +1,13 @@\n-from zope.interface import directlyProvides, Interface\n-from zope.component import provideAdapter, getGlobalSiteManager\n-from Products.CMFPlone.tests import PloneTestCase\n-from Products.CMFPlone.tests.dummy import Dummy, DummyWorkflowChainAdapter\n+from plone.app.testing import TEST_USER_PASSWORD\n from Products.CMFCore.interfaces import IWorkflowTool\n+from Products.CMFPlone.tests import PloneTestCase\n+from Products.CMFPlone.tests.dummy import Dummy\n+from Products.CMFPlone.tests.dummy import DummyWorkflowChainAdapter\n+from zope.component import getGlobalSiteManager\n+from zope.component import provideAdapter\n+from zope.interface import directlyProvides\n+from zope.interface import Interface\n+\n \n default_user = PloneTestCase.default_user\n \n@@ -17,10 +22,10 @@ class TestWorkflowTool(PloneTestCase.PloneTestCase):\n     def afterSetUp(self):\n         self.workflow = self.portal.portal_workflow\n \n-        self.portal.acl_users._doAddUser(\'member\', \'secret\', [\'Member\'], [])\n-        self.portal.acl_users._doAddUser(\'reviewer\', \'secret\',\n+        self.portal.acl_users._doAddUser(\'member\', TEST_USER_PASSWORD, [\'Member\'], [])\n+        self.portal.acl_users._doAddUser(\'reviewer\', TEST_USER_PASSWORD,\n                                          [\'Reviewer\'], [])\n-        self.portal.acl_users._doAddUser(\'manager\', \'secret\', [\'Manager\'], [])\n+        self.portal.acl_users._doAddUser(\'manager\', TEST_USER_PASSWORD, [\'Manager\'], [])\n \n         self.folder.invokeFactory(\'Document\', id=\'doc\')\n         self.doc = self.folder.doc\ndiff --git a/Products/CMFPlone/tests/test_defaultpage.py b/Products/CMFPlone/tests/test_defaultpage.py\nindex 9b4e86fe11..95de30452c 100644\n--- a/Products/CMFPlone/tests/test_defaultpage.py\n+++ b/Products/CMFPlone/tests/test_defaultpage.py\n@@ -1,8 +1,8 @@\n-from zope.component import getUtility\n-from plone.registry.interfaces import IRegistry\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n+from plone.registry.interfaces import IRegistry\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from zope.component import getUtility\n \n import unittest\n \n@@ -41,7 +41,9 @@ def test_get_default_page_step_2(self):\n \n         # 2) a folder also provides an fti that implements\n         #    IDynamicViewTypeInformation\n-        from Products.CMFDynamicViewFTI.interfaces import IDynamicViewTypeInformation  # noqa\n+        from Products.CMFDynamicViewFTI.interfaces import (  # noqa\n+            IDynamicViewTypeInformation,\n+        )\n         fti = self.folder.getTypeInfo()\n         self.assertTrue(IDynamicViewTypeInformation.providedBy(fti))\n \ndiff --git a/Products/CMFPlone/tests/test_doctests.py b/Products/CMFPlone/tests/test_doctests.py\nindex 3c2a3596b8..44034408a8 100644\n--- a/Products/CMFPlone/tests/test_doctests.py\n+++ b/Products/CMFPlone/tests/test_doctests.py\n@@ -2,6 +2,7 @@\n \n import doctest\n \n+\n def test_suite():\n     suites = (\n         doctest.DocTestSuite(\'Products.CMFPlone.TranslationServiceTool\'),\ndiff --git a/Products/CMFPlone/tests/test_expressions.py b/Products/CMFPlone/tests/test_expressions.py\nindex 9d950fae46..b825392ff9 100644\n--- a/Products/CMFPlone/tests/test_expressions.py\n+++ b/Products/CMFPlone/tests/test_expressions.py\n@@ -1,17 +1,23 @@\n-# -*- coding: utf-8 -*-\n from AccessControl.class_init import InitializeClass\n from AccessControl.Permissions import view_management_screens\n from AccessControl.SecurityInfo import ClassSecurityInfo\n from OFS.SimpleItem import SimpleItem\n from plone.testing.zope import Browser\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n # Expressions.boboAwareZopeTraverse is a function\n # expression(s).BoboAwareZopeTraverse is a class\n # Import them with names that are easier to tell apart.\n from Products.PageTemplates.expression import BoboAwareZopeTraverse as TraverseClass\n-from Products.PageTemplates.expression import TrustedBoboAwareZopeTraverse as TrustedTraverseClass\n-from Products.PageTemplates.Expressions import boboAwareZopeTraverse as traverse_function\n-from Products.PageTemplates.Expressions import trustedBoboAwareZopeTraverse as trusted_traverse_function\n+from Products.PageTemplates.expression import (\n+    TrustedBoboAwareZopeTraverse as TrustedTraverseClass,\n+)\n+from Products.PageTemplates.Expressions import (\n+    boboAwareZopeTraverse as traverse_function,\n+)\n+from Products.PageTemplates.Expressions import (\n+    trustedBoboAwareZopeTraverse as trusted_traverse_function,\n+)\n from Products.PageTemplates.PageTemplateFile import PageTemplateFile\n from zExceptions import NotFound\n from zExceptions import Unauthorized\n@@ -29,7 +35,7 @@\n path = os.path.dirname(__file__)\n \n \n-class DummyView(object):\n+class DummyView:\n \n     __name__ = "dummy-view"\n     _authenticator = "secret"\ndiff --git a/Products/CMFPlone/tests/test_factory.py b/Products/CMFPlone/tests/test_factory.py\nindex a797e54ad0..723aaa7bc3 100644\n--- a/Products/CMFPlone/tests/test_factory.py\n+++ b/Products/CMFPlone/tests/test_factory.py\n@@ -1,10 +1,10 @@\n from plone.dexterity.interfaces import IDexterityFTI\n+from plone.registry.interfaces import IRegistry\n from Products.CMFPlone.factory import addPloneSite\n-from Products.CMFPlone.utils import get_installer\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n-from zope.component import queryUtility\n+from Products.CMFPlone.utils import get_installer\n from zope.component import getUtility\n-from plone.registry.interfaces import IRegistry\n+from zope.component import queryUtility\n \n import unittest\n \ndiff --git a/Products/CMFPlone/tests/test_functional.py b/Products/CMFPlone/tests/test_functional.py\nindex 8a5d695d3e..aba2297201 100644\n--- a/Products/CMFPlone/tests/test_functional.py\n+++ b/Products/CMFPlone/tests/test_functional.py\n@@ -1,4 +1,6 @@\n-from plone.app.contenttypes.testing import PLONE_APP_CONTENTTYPES_FUNCTIONAL_TESTING  # noqa\n+from plone.app.contenttypes.testing import (  # noqa\n+    PLONE_APP_CONTENTTYPES_FUNCTIONAL_TESTING,\n+)\n from plone.app.testing import PLONE_FUNCTIONAL_TESTING\n from plone.testing import layered\n \ndiff --git a/Products/CMFPlone/tests/test_login_form.py b/Products/CMFPlone/tests/test_login_form.py\nindex 78fc2cbc44..94dfc4683a 100644\n--- a/Products/CMFPlone/tests/test_login_form.py\n+++ b/Products/CMFPlone/tests/test_login_form.py\n@@ -1,5 +1,6 @@\n from DateTime import DateTime\n from plone.app.z3cform.interfaces import IPloneFormLayer\n+from plone.app.testing import TEST_USER_PASSWORD\n from Products.CMFCore.permissions import SetOwnProperties\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n@@ -7,8 +8,8 @@\n from zope.interface import alsoProvides\n \n import re\n-import unittest\n import time\n+import unittest\n \n \n FORM_ID = \'login\'\n@@ -43,7 +44,7 @@ def _setup_authenticator_request(self):\n     def test_form_update(self):\n         self._setup_authenticator_request()\n         self.request[\'__ac_name\'] = \'test\'\n-        self.request[\'__ac_password\'] = \'secret\'\n+        self.request[\'__ac_password\'] = TEST_USER_PASSWORD\n         self.request[\'form.widgets.came_from\'] = [\'\']\n         form = self.portal.restrictedTraverse(FORM_ID)\n         form.update()\n@@ -61,7 +62,7 @@ def test_failsafe_login_form(self):\n     def test_failsafe_login_form_update(self):\n         self._setup_authenticator_request()\n         self.request[\'__ac_name\'] = \'test\'\n-        self.request[\'__ac_password\'] = \'secret\'\n+        self.request[\'__ac_password\'] = TEST_USER_PASSWORD\n         self.request[\'form.widgets.came_from\'] = [\'\']\n         form = self.portal.restrictedTraverse(\'failsafe_login\')\n         form.update()\ndiff --git a/Products/CMFPlone/tests/test_login_logout.py b/Products/CMFPlone/tests/test_login_logout.py\nindex 8998d07549..2dea7c43e7 100644\n--- a/Products/CMFPlone/tests/test_login_logout.py\n+++ b/Products/CMFPlone/tests/test_login_logout.py\n@@ -63,14 +63,14 @@ def test_login_with_user_defined_in_root_user_folder(self):\n         """\n         self.layer[\'app\'].acl_users.userFolderAddUser(\n             \'rootuser\',\n-            \'secret\',\n+            TEST_USER_PASSWORD,\n             [],\n             []\n         )\n         transaction.commit()\n         self.browser.open(\'http://nohost/plone/login\')\n         self.browser.getControl(\'Login Name\').value = \'rootuser\'\n-        self.browser.getControl(\'Password\').value = \'secret\'\n+        self.browser.getControl(\'Password\').value = TEST_USER_PASSWORD\n         self.browser.getControl(\'Log in\').click()\n         self.assertIn(\'You are now logged in\', self.browser.contents)\n \ndiff --git a/Products/CMFPlone/tests/test_mails.py b/Products/CMFPlone/tests/test_mails.py\nindex 751718a6c1..d33861fc54 100644\n--- a/Products/CMFPlone/tests/test_mails.py\n+++ b/Products/CMFPlone/tests/test_mails.py\n@@ -2,9 +2,9 @@\n from plone.app.testing import MOCK_MAILHOST_FIXTURE\n from plone.app.testing import PLONE_FIXTURE\n from plone.app.testing import PloneSandboxLayer\n+from plone.base.interfaces.controlpanel import IMailSchema\n from plone.registry.interfaces import IRegistry\n from plone.testing import layered\n-from plone.base.interfaces.controlpanel import IMailSchema\n from zope.component import getUtility\n \n import doctest\ndiff --git a/Products/CMFPlone/tests/test_patternsettings.py b/Products/CMFPlone/tests/test_patternsettings.py\nindex 9a70e75faa..fd4c38fe0f 100644\n--- a/Products/CMFPlone/tests/test_patternsettings.py\n+++ b/Products/CMFPlone/tests/test_patternsettings.py\n@@ -1,7 +1,7 @@\n from plone.app.testing import login\n from plone.app.testing import TEST_USER_NAME\n-from plone.registry.interfaces import IRegistry\n from plone.base.interfaces import ITinyMCESchema\n+from plone.registry.interfaces import IRegistry\n from Products.CMFPlone.patterns.view import PatternsSettingsView\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\ndiff --git a/Products/CMFPlone/tests/test_redirect_after_login.py b/Products/CMFPlone/tests/test_redirect_after_login.py\nindex 821e762be8..4eb69b4a35 100644\n--- a/Products/CMFPlone/tests/test_redirect_after_login.py\n+++ b/Products/CMFPlone/tests/test_redirect_after_login.py\n@@ -1,15 +1,18 @@\n+from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n-from plone.testing.zope import Browser\n-from Products.CMFPlone.browser.login.login import LoginForm\n from plone.base.interfaces import IInitialLogin\n from plone.base.interfaces import IRedirectAfterLogin\n+from plone.testing.zope import Browser\n+from Products.CMFPlone.browser.login.login import LoginForm\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.interface import implementer\n from zope.interface import Interface\n from zope.publisher.interfaces import IRequest\n \n+import quopri\n+import transaction\n import unittest\n \n \n@@ -190,3 +193,79 @@ def test_initiallogin_adapter(self):\n         self.assertIn(\'You are now logged out.\',\n                       self.browser.contents,\n                       \'Logout status message not displayed.\')\n+\n+    def test_password_reset_uses_all_adapters(self):\n+        # By default, when you reset your password, you are directly logged in.\n+        # An initial login adapter should be active.\n+        # And the redirect after login adapter too.\n+        from plone.registry.interfaces import IRegistry\n+        from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+        from zope.component import getGlobalSiteManager\n+        from zope.component import getUtility\n+\n+        # We need to configure the mailhost first.\n+        registry = getUtility(IRegistry, context=self.portal)\n+        mail_settings = registry.forInterface(IMailSchema, prefix="plone")\n+        mail_settings.smtp_host = u\'localhost\'\n+        mail_settings.email_from_address = \'smith@example.com\'\n+        # and an email address for the test user:\n+        member = self.portal.portal_membership.getMemberById(TEST_USER_ID)\n+        member.setProperties(email="dummy@example.org")\n+        transaction.commit()\n+\n+        # Fill in the password reset form.\n+        self.browser.open(\'http://nohost/plone/@@login-help\')\n+        form = self.browser.getForm(index=1)\n+        form.getControl(name=\'form.widgets.reset_password\').value = TEST_USER_NAME\n+        form.submit(name=\'form.buttons.reset\')\n+\n+        # Get the password reset mail from the dummy mailhost.\n+        mailhost = self.portal.MailHost\n+        self.assertEqual(len(mailhost.messages), 1)\n+        msg = mailhost.messages[0]\n+\n+        # Extract the address that lets us reset our password.\n+        msg = quopri.decodestring(msg)\n+        please_visit_text = b"reset your password for Plone site site:"\n+        self.assertIn(please_visit_text, msg)\n+        url_index = msg.index(please_visit_text) + len(please_visit_text)\n+        address = msg[url_index:].strip().split()[0].decode()\n+        self.assertTrue(address.startswith(u\'http://nohost/plone/passwordreset/\'))\n+\n+        # Now that we have the address, we will reset our password:\n+\n+        self.browser.open(address)\n+        self.assertIn("Set your password", self.browser.contents)\n+        form = self.browser.getForm(name=\'pwreset_action\')\n+        form.getControl(name=\'userid\').value = TEST_USER_NAME\n+        form.getControl(name=\'password\').value = \'secretion\'\n+        form.getControl(name=\'password2\').value = \'secretion\'\n+\n+        # Register our adapters, submit the form, and unregister them.\n+        gsm = getGlobalSiteManager()\n+        gsm.registerAdapter(AfterLoginAdapter, (Interface, IRequest))\n+        gsm.registerAdapter(InitialLoginAdapter, (Interface, IRequest))\n+        try:\n+            form.submit()\n+        finally:\n+            gsm.unregisterAdapter(InitialLoginAdapter, (Interface, IRequest))\n+            gsm.unregisterAdapter(AfterLoginAdapter, (Interface, IRequest))\n+\n+        # By default \'autologin_after_password_reset\' is turned on,\n+        # so we are now logged in:\n+        self.assertIn(\n+            "Password reset successful, you are logged in now!",\n+            self.browser.contents,\n+        )\n+        self.assertEqual(self.browser.url,\n+                         \'http://nohost/plone/sitemap\',\n+                         \'Successful login did not use the adapter for \'\n+                         \'redirect.\')\n+        self.assertEqual(self.portal.foo, \'foo\')\n+\n+        # Now log out.\n+        self.browser.getLink(\'Log out\').click()\n+\n+        self.assertIn(\'You are now logged out.\',\n+                      self.browser.contents,\n+                      \'Logout status message not displayed.\')\ndiff --git a/Products/CMFPlone/tests/test_redirection.py b/Products/CMFPlone/tests/test_redirection.py\nnew file mode 100644\nindex 0000000000..550ad97bd9\n--- /dev/null\n+++ b/Products/CMFPlone/tests/test_redirection.py\n@@ -0,0 +1,75 @@\n+from plone.testing.zope import Browser\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+from zExceptions import NotFound\n+\n+import unittest\n+\n+\n+class TestRedirection(unittest.TestCase):\n+    """Test redirecting and resource directories\n+\n+    These tests were formerly found in redirection.txt.\n+\n+    When you try to visit a page that does not exist, Plone helpfully\n+    shows a link to the parent directory.  Normally this is fine.  But\n+    Plone expects this parent directory to be a normal folder or something\n+    similar.  It makes some assumptions there that are not valid when the\n+    parent is a resource directory.  This gives problems while rendering\n+    the default error page.  In particular it results in a TypeError:\n+    getTypeInfo.\n+    """\n+\n+    layer = PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\n+\n+    def setUp(self):\n+        self.browser = Browser(self.layer["app"])\n+        # In most cases it is more informative to get the Python traceback, so we tell\n+        # the browser not to handle errors, but in some tests we will override this.\n+        self.browser.handleErrors = False\n+        self.browser.raiseHttpErrors = True\n+        self.portal = self.layer["portal"]\n+        self.flag_directory = (\n+            f"{self.portal.absolute_url()}/++resource++language-flags/"\n+        )\n+        # Open the portal site root first.  This may be needed to avoid strange error\n+        # messages in case something is wrong:\n+        # ZODB.POSException.ConnectionStateError:\n+        # Shouldn\'t load state for persistent.list.PersistentList\n+        # 0x218f5264c344128e when the connection is closed.\n+        self.browser.open(self.portal.absolute_url())\n+\n+    def test_get_existing_resource_file(self):\n+        # Let\'s check what happens when we get a file from a resourceDirectory.\n+        # This flag exists:\n+        self.browser.open(self.flag_directory + "eu.gif")\n+\n+    def test_get_non_existing_resource_file(self):\n+        # This flag does not exist, so it should raise a 404:\n+        with self.assertRaises(NotFound):\n+            self.browser.open(self.flag_directory + "nonexisting.gif")\n+\n+    def test_error_for_non_existing_resource_file(self):\n+        # The 404 page should not itself give errors.\n+        self.browser.handleErrors = True\n+        # On Python 3.11 we must disable raiseHttpErrors, otherwise you trigger a core\n+        # Python bug.  This seems a test-only problem.  See this issue:\n+        # https://github.com/plone/Products.CMFPlone/issues/3663\n+        self.browser.raiseHttpErrors = False\n+        self.browser.open(self.flag_directory + "nonexisting.gif")\n+        self.assertEqual(self.browser.headers["Status"], "404 Not Found")\n+        # It should not give an error while rendering the default error page:\n+        self.assertNotIn(\n+            b"the following error occurred while attempting to render the standard "\n+            b"error message",\n+            self.browser.contents.lower(),\n+        )\n+        # As it is an image, it should return a JSON message\n+        self.assertIn(b\'{"error_type": "NotFound"}\', self.browser.contents)\n+\n+    def test_non_existing_page(self):\n+        # A non-existing page would return a human readable error page\n+        self.browser.addHeader("Accept", "text/html")\n+        self.browser.handleErrors = True\n+        self.browser.raiseHttpErrors = False\n+        self.browser.open("http://nohost/plone/non-existing-page")\n+        self.assertIn("This page does not seem to exist", self.browser.contents)\ndiff --git a/Products/CMFPlone/tests/test_robot.py b/Products/CMFPlone/tests/test_robot.py\nindex d282eab3d2..6536d3a84c 100644\n--- a/Products/CMFPlone/tests/test_robot.py\n+++ b/Products/CMFPlone/tests/test_robot.py\n@@ -1,9 +1,10 @@\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_ROBOT_TESTING\n from plone.app.testing import ROBOT_TEST_LEVEL\n from plone.testing import layered\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_ROBOT_TESTING\n+\n import os\n-import unittest\n import robotsuite\n+import unittest\n \n \n def test_suite():\ndiff --git a/Products/CMFPlone/tests/test_robots_txt.py b/Products/CMFPlone/tests/test_robots_txt.py\nindex e7f73966b5..bf916945bc 100644\n--- a/Products/CMFPlone/tests/test_robots_txt.py\n+++ b/Products/CMFPlone/tests/test_robots_txt.py\n@@ -1,7 +1,8 @@\n from plone.base.interfaces import ISiteSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getUtility\n+\n import unittest\n \n \ndiff --git a/Products/CMFPlone/tests/test_safe_formatter.py b/Products/CMFPlone/tests/test_safe_formatter.py\nindex 65076d1c8a..c80841e870 100644\n--- a/Products/CMFPlone/tests/test_safe_formatter.py\n+++ b/Products/CMFPlone/tests/test_safe_formatter.py\n@@ -254,6 +254,7 @@ def test_access_to_private_content_not_allowed_in_any_way(self):\n \n     def test_cook_zope3_page_templates_normal(self):\n         from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n+\n         # Note: on Plone 3.3 this is actually a ZopeTwoPageTemplateFile.\n         pt = ViewPageTemplateFile(\'normal_zope3_page_template.pt\')\n         hack_pt(pt)\n@@ -266,6 +267,7 @@ def test_cook_zope3_page_templates_normal(self):\n \n     def test_cook_zope3_page_templates_using_format(self):\n         from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n+\n         # Note: on Plone 3.3 this is actually a ZopeTwoPageTemplateFile.\n         pt = ViewPageTemplateFile(\'using_format_zope3_page_template.pt\')\n         hack_pt(pt)\n@@ -292,6 +294,7 @@ class TestFunctionalSafeFormatter(PloneTestCase):\n \n     def test_safe_format_properly_applied(self):\n         from AccessControl.SimpleObjectPolicies import ContainerAssertions\n+\n         import types\n         ca = ContainerAssertions\n         self.assertTrue(str in ca)\n@@ -375,9 +378,9 @@ def test_cook_zope2_page_templates_bad_item_unicode(self):\n         self.assertRaises(Unauthorized, pt.pt_render)\n \n     def assert_is_checked_via_security_manager(self, pt_content):\n-        from Products.PageTemplates.ZopePageTemplate import ZopePageTemplate\n-        from AccessControl.SecurityManager import setSecurityPolicy\n         from AccessControl.SecurityManagement import noSecurityManager\n+        from AccessControl.SecurityManager import setSecurityPolicy\n+        from Products.PageTemplates.ZopePageTemplate import ZopePageTemplate\n \n         pt = ZopePageTemplate(\'mytemplate\', pt_content)\n         noSecurityManager()\ndiff --git a/Products/CMFPlone/tests/test_sitelogo.py b/Products/CMFPlone/tests/test_sitelogo.py\nindex 0f07e67ac0..c47e14130c 100644\n--- a/Products/CMFPlone/tests/test_sitelogo.py\n+++ b/Products/CMFPlone/tests/test_sitelogo.py\n@@ -1,9 +1,11 @@\n from plone.base.interfaces import ISiteSchema\n-from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getUtility\n+\n import unittest\n \n+\n # Red pixel with filename pixel.png\n SITE_LOGO_BASE64 = b\'filenameb64:cGl4ZWwucG5n;datab64:iVBORw0KGgoAAAANSUhEUgA\'\\\n                    b\'AAAEAAAABCAIAAACQd1PeAAAADElEQVQI12P4z8AAAAMBAQAY3Y2wAAA\'\\\ndiff --git a/Products/CMFPlone/tests/test_sitemap.py b/Products/CMFPlone/tests/test_sitemap.py\nindex a1c9f2fca8..8e9bc76a48 100644\n--- a/Products/CMFPlone/tests/test_sitemap.py\n+++ b/Products/CMFPlone/tests/test_sitemap.py\n@@ -1,17 +1,14 @@\n-import unittest\n-import transaction\n-import lxml\n-\n-from plone.app.contenttypes.testing import (\n-    PLONE_APP_CONTENTTYPES_FUNCTIONAL_TESTING\n-)\n-\n+from plone.app.contenttypes.testing import PLONE_APP_CONTENTTYPES_FUNCTIONAL_TESTING\n+from plone.app.testing import setRoles\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n-from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from plone.testing.zope import Browser\n \n+import lxml\n+import transaction\n+import unittest\n+\n \n class ProductsCMFPloneSetupTest(unittest.TestCase):\n \ndiff --git a/Products/CMFPlone/tests/test_utils.py b/Products/CMFPlone/tests/test_utils.py\nindex eb30c720bf..21031a5886 100644\n--- a/Products/CMFPlone/tests/test_utils.py\n+++ b/Products/CMFPlone/tests/test_utils.py\n@@ -1,12 +1,12 @@\n """ Unit tests for utils module. """\n \n+from plone.base.interfaces import ISiteSchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.tests.base.content import FAUX_HTML_LEADING_TEXT\n from Products.CMFCore.tests.base.content import SIMPLE_HTML\n from Products.CMFCore.tests.base.content import SIMPLE_STRUCTUREDTEXT\n from Products.CMFCore.tests.base.content import SIMPLE_XHTML\n from Products.CMFCore.tests.base.content import STX_WITH_HTML\n-from plone.base.interfaces import ISiteSchema\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n from zope.component import getUtility\n \ndiff --git a/Products/CMFPlone/tests/test_zmi.py b/Products/CMFPlone/tests/test_zmi.py\nindex 33ac444e52..01d7f90787 100644\n--- a/Products/CMFPlone/tests/test_zmi.py\n+++ b/Products/CMFPlone/tests/test_zmi.py\n@@ -1,4 +1,6 @@\n-from plone.app.contenttypes.testing import PLONE_APP_CONTENTTYPES_INTEGRATION_TESTING  # noqa: E501\n+from plone.app.contenttypes.testing import (  # noqa: E501\n+    PLONE_APP_CONTENTTYPES_INTEGRATION_TESTING,\n+)\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n \ndiff --git a/Products/CMFPlone/tests/utils.py b/Products/CMFPlone/tests/utils.py\nindex 61b740cb3a..ef857ca3fe 100644\n--- a/Products/CMFPlone/tests/utils.py\n+++ b/Products/CMFPlone/tests/utils.py\n@@ -1,9 +1,10 @@\n from persistent.list import PersistentList\n-import re\n-\n from Products.MailHost.MailHost import _mungeHeaders\n from Products.MailHost.MailHost import MailBase\n \n+import re\n+\n+\n # regexp for a valid CSS identifier without the leading #\n VALID_CSS_ID = re.compile("[A-Za-z_@][A-Za-z0-9_@-]*")\n \ndiff --git a/Products/CMFPlone/unicodeconflictresolver.py b/Products/CMFPlone/unicodeconflictresolver.py\nindex cdea9bc71c..11cd35f4d5 100644\n--- a/Products/CMFPlone/unicodeconflictresolver.py\n+++ b/Products/CMFPlone/unicodeconflictresolver.py\n@@ -1,7 +1,6 @@\n-from zope.interface import implementer\n-from Products.PageTemplates.interfaces import IUnicodeEncodingConflictResolver\n-\n from Products.CMFPlone.patches.unicodehacks import _unicode_replace\n+from Products.PageTemplates.interfaces import IUnicodeEncodingConflictResolver\n+from zope.interface import implementer\n \n \n @implementer(IUnicodeEncodingConflictResolver)\ndiff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py\nindex 6a2da74b8e..e731e62532 100644\n--- a/Products/CMFPlone/utils.py\n+++ b/Products/CMFPlone/utils.py\n@@ -79,9 +79,9 @@\n \n deprecated_import(\n     "Import from plone.namedfile.utils instead (will be removed in Plone 7)",\n-    getHighPixelDensityScales="plone.namedfile.utils.getHighPixelDensityScales",\n-    getAllowedSizes="plone.namedfile.utils.getAllowedSizes",\n-    getQuality="plone.namedfile.utils.getQuality",\n+    getHighPixelDensityScales="plone.namedfile.utils:getHighPixelDensityScales",\n+    getAllowedSizes="plone.namedfile.utils:getAllowedSizes",\n+    getQuality="plone.namedfile.utils:getQuality",\n )\n \n @deprecate("Use plone.base.utils.safe_bytes instead (will be removed in Plone 7)")\n@@ -400,7 +400,7 @@ def _unrestricted_rename(container, id, new_id):\n             action=\'manage_main\'))\n     ob = container._getOb(id)\n     if not ob.cb_isMoveable():\n-        raise CopyError(\'Not Supported {}\'.format(escape(id)))\n+        raise CopyError(f\'Not Supported {escape(id)}\')\n     try:\n         ob._notifyOfCopyTo(container, op=1)\n     except:\ndiff --git a/Products/CMFPlone/workflow.py b/Products/CMFPlone/workflow.py\nindex 199fdfbc40..71b0599c7a 100644\n--- a/Products/CMFPlone/workflow.py\n+++ b/Products/CMFPlone/workflow.py\n@@ -1,8 +1,9 @@\n-from zope.interface import Interface, implementer\n-from zope.component import adapter\n from Acquisition import aq_base\n-from Products.CMFCore.interfaces import IWorkflowTool\n from plone.base.interfaces import IWorkflowChain\n+from Products.CMFCore.interfaces import IWorkflowTool\n+from zope.component import adapter\n+from zope.interface import implementer\n+from zope.interface import Interface\n \n \n @adapter(Interface, IWorkflowTool)\ndiff --git a/README.md b/README.md\nnew file mode 100644\nindex 0000000000..f71ba32de0\n--- /dev/null\n+++ b/README.md\n@@ -0,0 +1,141 @@\n+<p align="center">\n+    <img alt="Plone Logo" width="200px" src="https://raw.githubusercontent.com/plone/.github/main/plone-logo.png">\n+</p>\n+\n+<h1 align="center">\n+  Plone\n+</h1>\n+\n+<div align="center">\n+\n+[![PyPI - Wheel](https://img.shields.io/pypi/wheel/plone)](https://pypi.org/project/plone/)\n+[![PyPI - License](https://img.shields.io/pypi/l/plone)](https://pypi.org/project/plone/)\n+[![PyPI - Status](https://img.shields.io/pypi/status/plone)](https://pypi.org/project/plone/)\n+\n+[![GitHub contributors](https://img.shields.io/github/contributors/plone/Products.CMFPlone)](https://github.com/plone/Products.CMFPlone)\n+![GitHub Repo stars](https://img.shields.io/github/stars/plone/Plone?style=flat-square)\n+\n+</div>\n+\n+Plone is a mature, secure, and user-friendly content management system (CMS).\n+\n+Plone was first released to the public on October 4, 2001.\n+\n+Plone has the maturity, stability, and reliability of an application maintained by open source developers with decades of experience, while continually evolving and adapting to modern technology.\n+\n+Lots of customizations can be made trough-the-web, such as creating content types, themes, workflows, and much more.\n+Plone may be extended and used as a framework on which to build custom CMS-like solutions.\n+\n+Plone works as a\n+\n+- Full-featured server-side rendered HTML CMS.\n+- React-based frontend for editing and viewing content, backed by a server with a REST API.\n+- Headless CMS server with a REST API, allowing a developer to build a custom frontend with their chosen technology.\n+\n+\n+<h2 align="center">\n+  Installing Plone\n+</h2>\n+\n+Plone is available on Linux, Microsoft Windows, macOS, and BSD platforms.\n+\n+Plone may be run as a container in the cloud with Docker and other Open Containers Initiative compliant platforms.\n+[Example Dockerfiles](https://6.docs.plone.org/install/containers/images/index.html) and base images are available.\n+\n+[Install Plone by choosing an option from plone.org](https://plone.org/download)\n+\n+\n+<h2 align="center">\n+  Documentation\n+</h2>\n+\n+Consult [the official Plone documentation](https://6.docs.plone.org) with information for different audiences.\n+\n+For trainings [comprehensive Plone training material](https://training.plone.org) is available.\n+\n+\n+<h2 align="center">\n+  What is Plone?\n+</h2>\n+\n+Plone is a ready-to-run content management system, offering a complete set of features needed by a wide variety of organizations.\n+\n+Security is built into Plone\'s architecture from the ground up.\n+Plone offers fine-grained permission control over content and actions.\n+\n+Plone is easy to set up, extremely flexible,\n+and provides you with a system for managing web content that is ideal for project groups, communities, websites, extranets, and intranets.\n+\n+- **Plone is easy to install.**\n+  Several installation options are available for either your local machine or on servers in the cloud.\n+\n+- **Plone empowers content editors and web application developers.**\n+  The Plone Team includes usability experts who have made Plone easy and attractive for content managers to add, update, and maintain content.\n+\n+- **Plone is international.**\n+  The Plone interface has more than 35 translations, and tools exist for managing multilingual content.\n+\n+- **Plone follows standards and is inclusive.**\n+  Plone carefully follows standards for usability and accessibility.\n+  Plone is compliant with WCAG 2.1 level AA and aims for ATAG 2.0 level AA.\n+\n+- **Plone is open source.**\n+  Plone is licensed under the GNU General Public License, the same license used by Linux.\n+  This gives you the right to use Plone without a license fee, and to improve upon the product.\n+\n+- **Plone is supported.**\n+  There are over two hundred active developers in the Plone Development Team around the world, and a multitude of companies that specialize in Plone development and support.\n+\n+- **Plone is extensible.**\n+  There is a multitude of add-on products for Plone to add new features and content types.\n+  In addition, Plone can be scripted using web standard solutions and open source languages.\n+\n+- **Plone is technology neutral.**\n+  Plone can interoperate with most relational database systems\xe2\x80\x94both open source and commercial\xe2\x80\x94and runs on a vast array of\n+  platforms, including Linux, Windows, macOS, and BSD.\n+\n+\n+<h2 align="center">\n+Technical overview\n+</h2>\n+\n+Plone is a content management platform with its backend written in Python.\n+Plone has a choice of frontend, either Classic UI using server-side templates or Volto written in modern React-based JavaScript.\n+It builds upon Zope, an open source web application server and development system, and thus on the pluggable Zope Component Architecture (ZCA).\n+\n+Python is the easy to learn, widely used, and supported open source programming language.\n+Python can be used to add new features to Plone and used to understand or make changes to the way that Plone works.\n+\n+Plone stores its contents in Zope\'s built-in transactional hierarchical object database, the ZODB.\n+The ZODB can be connected to simple file-storages, scalable ZEO-Servers or Postgres, MySQL, and Oracle.\n+There are add-ons and techniques, however, to share information with other sources, such as relational databases, LDAP, filesystem\n+files, and so on.\n+\n+\n+<h2 align="center">\n+Official Resources\n+</h2>\n+\n+* [plone.org](https://plone.org/) - Official website for developers, community, decision makers, and evaluators.\n+* [Plone support](https://plone.org/support) - Where to find help.\n+* [community.plone.org](https://community.plone.org/) - Official community forum, the best place to get help.\n+* [Plone 6 Documentation](https://6.docs.plone.org/) - Official documentation for developers, integrators, and content editors.\n+* [training.plone.org](https://training.plone.org/) - Trainings for developers, integrators, content editors, and designers.\n+* [`plone.api`](https://6.docs.plone.org/develop/plone.api/docs/index.html) - Documentation for `plone.api`.\n+* [`plone.restapi`](https://plonerestapi.readthedocs.io/en/latest/) - Documentation for `plone.restapi`.\n+* [Discord](https://discord.gg/zFY3EBbjaj) - Official Plone chat, voice, and video service.\n+\n+<h2 align="center">\n+This project is supported by\n+</h2>\n+\n+<p align="center">\n+    <a href="https://plone.org/foundation/">\n+      <img alt="Plone Logo" width="200px" src="https://raw.githubusercontent.com/plone/.github/main/plone-foundation.png">\n+    </a>\n+</p>\n+\n+<h2 align="center">\n+License\n+</h2>\n+The project is licensed under the GPLv2.\ndiff --git a/README.rst b/README.rst\ndeleted file mode 100644\nindex 8c1fdee108..0000000000\n--- a/README.rst\n+++ /dev/null\n@@ -1,101 +0,0 @@\n-About Plone\n-===========\n-\n-Plone is a mature, secure and user-friendly Content Management System (CMS).\n-\n-Plone - and the Open Source community behind it - aggregates more than 20 years of experience in content management.\n-It offers all major features expected by a modern CMS out-of-the-box.\n-\n-Lots of customizations can be made trough-the-web, such as creating content types, themes, workflows and much more.\n-Pushed one step further Plone can be used as a framework on which to build custom CMS-like solutions.\n-\n-Plone works as a\n-\n-- full-featured classical server-side rendered CMS,\n-- headless CMS offering all features as a REST API.\n-\n-\n-Installing Plone\n------------------\n-\n-Plone is available on Microsoft Windows, Linux, OSX and BSD platforms.\n-\n-Plone runs as container in the cloud with Docker.\n-\n-`Install Plone by choosing an option from plone.org <https://plone.org/download>`_\n-\n-\n-Documentation\n--------------\n-\n-Consult `the official Plone documentation <https://docs.plone.org>`_ with information for different audiences.\n-\n-For trainings `comprehensive Plone training material <https://training.plone.org>`_ is available.\n-\n-\n-What is Plone?\n---------------\n-\n-Plone is a ready-to-run content management system, offering a complete set of features needed by a wide variety of organizations.\n-\n-Security is built into Plone\'s architecture from the ground up.\n-Plone offers fine-grained permission control over content and actions.\n-\n-Plone is easy to set up, extremely flexible,\n-and provides you with a system for managing web content that is ideal for project groups, communities, websites, extranets and intranets.\n-\n-- *Plone is easy to install.*\n-  Several installation options are available for either your local machine or on servers in the cloud.\n-\n-- *Plone is easy to use.*\n-  The Plone Team includes usability experts who have made Plone easy and attractive for content managers to add, update, and maintain content.\n-\n-- *Plone is international.*\n-  The Plone interface has more than 35 translations, and tools exist for managing multilingual content.\n-\n-- *Plone is standard.*\n-  Plone carefully follows standards for usability and accessibility.\n-  Plone pages are compliant with US Section 508, and the W3C\'s AAA rating for accessibility.\n-\n-- *Plone is Open Source.*\n-  Plone is licensed under the GNU General Public License, the same license used by Linux.\n-  This gives you the right to use Plone without a license fee, and to improve upon the product.\n-\n-- *Plone is supported.*\n-  There are over three hundred developers in the Plone Development Team around the world, and a multitude of companies that specialize in Plone development and support.\n-\n-- *Plone is extensible.*\n-  There is a multitude of add-on products for Plone to add new features and content types.\n-  In addition, Plone can be scripted using web standard solutions and Open Source languages.\n-\n-- *Plone is technology neutral.*\n-  Plone can interoperate with most relational database systems, open source and commercial, and runs on a vast array of\n-  platforms, including Linux, Windows, Mac OS X, Solaris and BSD.\n-\n-\n-Technical overview\n-------------------\n-\n-Plone is a content management platform written in Python.\n-It builds upon Zope, an Open Source web application server and development system and thus on the pluggable Zope Component Architecture (ZCA).\n-\n-Python is the easy-to-learn, widely-used and supported Open Source programming language.\n-Python can be used to add new features to Plone, and used to understand or make changes to the way that Plone works.\n-\n-Plone stores its contents in Zope\'s built-in transactional hierarchical object database, the ZODB.\n-The ZODB can be connected to simple file-storages, scalable ZEO-Servers or Postgres, MySQL and Oracle.\n-There are addons and techniques, however, to share information with other sources, such as relational databases, LDAP, filesystem\n-files, etc.\n-\n-\n-Official Resources\n-------------------\n-* `plone.org <https://plone.org/>`_ - Official website for developers and community.\n-* `Plone support <https://plone.org/support>`_ - Where to find help.\n-* `community.plone.org <https://community.plone.org/>`_ - Official community forum, the best place to get help.\n-* `docs.plone.org <https://docs.plone.org/>`_ - Official documentation for developers/integrators.\n-* `training.plone.org <https://training.plone.org/>`_ - Training classes for developers/integrators/users/designers.\n-* `plone.api <https://docs.plone.org/develop/plone.api/docs/index.html>`_ - Documentation for plone.api.\n-* `plone.restapi <https://plonerestapi.readthedocs.io/en/latest/>`_ - Documentation for plone.restapi.\n-* `official Discord chat <https://discord.gg/w8e5WCAKGs>`_ - Join link.\n-\ndiff --git a/docs/changelog_template.jinja b/docs/changelog_template.jinja\nnew file mode 100644\nindex 0000000000..b35bff39d4\n--- /dev/null\n+++ b/docs/changelog_template.jinja\n@@ -0,0 +1,15 @@\n+{% if sections[""] %}\n+{% for category, val in definitions.items() if category in sections[""] %}\n+\n+### {{ definitions[category][\'name\'] }}\n+\n+{% for text, values in sections[""][category].items() %}\n+- {{ text }} {{ values|join(\', \') }}\n+{% endfor %}\n+\n+{% endfor %}\n+{% else %}\n+No significant changes.\n+\n+\n+{% endif %}\n\\ No newline at end of file\ndiff --git a/news/3382.bugfix b/news/3382.bugfix\ndeleted file mode 100644\nindex 6060ed990a..0000000000\n--- a/news/3382.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Changed \'Powered by\' text\n-[rohnsha0]\ndiff --git a/news/3475.bugfix b/news/3475.bugfix\ndeleted file mode 100644\nindex cb38b56977..0000000000\n--- a/news/3475.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fix active tab in ``@@test-rendering-icons``.\n-[petschki]\ndiff --git a/news/3536.bugfix b/news/3536.bugfix\ndeleted file mode 100644\nindex b5bbe81cbc..0000000000\n--- a/news/3536.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Do not create title tag for svg icons when tag_alt is not given.\n-[agitator]\n\\ No newline at end of file\ndiff --git a/news/3568.bugfix b/news/3568.bugfix\ndeleted file mode 100644\nindex 450997a173..0000000000\n--- a/news/3568.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fixed all known instances of plone.com in plone/Products.CMFPlone\n-[rohnsha0]\ndiff --git a/news/3581.bugfix b/news/3581.bugfix\ndeleted file mode 100644\nindex 32eba96b1f..0000000000\n--- a/news/3581.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Allow access to the macros of the main_template, also from skin templates.\n-[maurits]\ndiff --git a/news/3582.bugfix b/news/3582.bugfix\ndeleted file mode 100644\nindex 805f4bdb48..0000000000\n--- a/news/3582.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Robot tests: be more specific when clicking some elements.\n-[maurits]\ndiff --git a/news/3584.bugfix b/news/3584.bugfix\ndeleted file mode 100644\nindex b83dbc1f59..0000000000\n--- a/news/3584.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Set portal title in registry when creating a new Plone site\n-[erral]\ndiff --git a/news/3587.bugfix b/news/3587.bugfix\ndeleted file mode 100644\nindex dd9e106c25..0000000000\n--- a/news/3587.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Change test to make sure e-mail is sent in utf-8\n-[erral]\ndiff --git a/news/3601.bugfix b/news/3601.bugfix\ndeleted file mode 100644\nindex 32921649a6..0000000000\n--- a/news/3601.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fix visual issue with long action name in @@actions-controlpanel.\n-[petschki]\ndiff --git a/news/3605.bugfix b/news/3605.bugfix\ndeleted file mode 100644\nindex eb2d6e2a4a..0000000000\n--- a/news/3605.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fixed an error where Main Template (line: 42) referenced plone.com istead of plone.org\n-[rohnsha0]\ndiff --git a/news/3609.bugfix b/news/3609.bugfix\ndeleted file mode 100644\nindex 47ffdc293f..0000000000\n--- a/news/3609.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-In traversal.py remoe a Zope 4 BBB code, add a comment about bundle traverser and apply black.isort on the file.\n-[jensens]\ndiff --git a/news/3610.bugfix b/news/3610.bugfix\ndeleted file mode 100644\nindex 009d99d62a..0000000000\n--- a/news/3610.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Supress warning of intentional deprecated import for BBB.\n-[jensens]\ndiff --git a/news/3614-2.bugfix b/news/3614-2.bugfix\ndeleted file mode 100644\nindex 6e01b0f8c7..0000000000\n--- a/news/3614-2.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Moved CSFR patches addressing CMFPlone itself to decorators.\n-[jensens]\ndiff --git a/news/3614.bugfix b/news/3614.bugfix\ndeleted file mode 100644\nindex c1691ac58c..0000000000\n--- a/news/3614.bugfix\n+++ /dev/null\n@@ -1,7 +0,0 @@\n-Use plone.base and reduce deprecation warnings.\n-In utils remove functions already moved to plone.base and add deferred import with message.\n-Deprecate correct, where prior only comments or old logging.\n-Some black/isort where touched.\n-[jensens]\n-\n-\ndiff --git a/news/3615.bugfix b/news/3615.bugfix\ndeleted file mode 100644\nindex 45df6ff908..0000000000\n--- a/news/3615.bugfix\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-Move utils.getQuality and utils.getAllowedSizes to plone.namedfile.utils.\n-This helps untangling circular dependencies.\n-[jensens]\ndiff --git a/news/3616.bugfix b/news/3616.bugfix\ndeleted file mode 100644\nindex 178ec178c5..0000000000\n--- a/news/3616.bugfix\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-Do not use deprecated calls in actions expressions.\n-ActionsTool and PloneBasetool got an code style overhaul.\n-[jensens]\ndiff --git a/news/3733.bugfix b/news/3733.bugfix\nnew file mode 100644\nindex 0000000000..5eb495258d\n--- /dev/null\n+++ b/news/3733.bugfix\n@@ -0,0 +1 @@\n+Fix deprecated imports. [jensens]\ndiff --git a/news/6007.bugfix b/news/6007.bugfix\ndeleted file mode 100644\nindex c0a2a0215b..0000000000\n--- a/news/6007.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Updated metadata version to 6007.\n-[maurits]\ndiff --git a/news/6014.bugfix b/news/6014.bugfix\nnew file mode 100644\nindex 0000000000..135729df44\n--- /dev/null\n+++ b/news/6014.bugfix\n@@ -0,0 +1 @@\n+Updated metadata version to 6014.  [maurits]\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 05b615de2f..10d43bb1bd 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -1,8 +1,10 @@\n [tool.towncrier]\n-filename = "CHANGES.rst"\n+filename = "CHANGES.md"\n directory = "news/"\n-title_format = "{version} ({project_date})"\n-underlines = ["-", ""]\n+start_string = "<!-- towncrier release notes start -->\\n"\n+title_format = "## {version} ({project_date})"\n+template = "docs/changelog_template.jinja"\n+underlines = ["", "", ""]\n \n [[tool.towncrier.type]]\n directory = "breaking"\ndiff --git a/setup.py b/setup.py\nindex 2f0a3c5e0f..66f9ea7657 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -1,15 +1,17 @@\n-from setuptools import setup\n from setuptools import find_packages\n+from setuptools import setup\n \n-version = \'6.0.0b2.dev0\'\n+\n+version = \'6.0.3.dev0\'\n \n \n setup(\n     name=\'Products.CMFPlone\',\n     version=version,\n     description="The Plone Content Management System (core)",\n-    long_description=open("README.rst").read() + "\\n" +\n-    open("CHANGES.rst").read(),\n+    long_description=open("README.md").read() + "\\n" +\n+    open("CHANGES.md").read(),\n+    long_description_content_type="text/markdown",\n     classifiers=[\n         "Development Status :: 5 - Production/Stable",\n         "Environment :: Web Environment",\n@@ -20,15 +22,29 @@\n         "License :: OSI Approved :: GNU General Public License v2 (GPLv2)",\n         "Operating System :: OS Independent",\n         "Programming Language :: Python",\n-        "Programming Language :: Python :: 3.7",\n         "Programming Language :: Python :: 3.8",\n         "Programming Language :: Python :: 3.9",\n+        "Programming Language :: Python :: 3.10",\n+        "Programming Language :: Python :: 3.11",\n     ],\n+    python_requires=\'>=3.8\',\n     keywords=\'Plone CMF Python Zope CMS Webapplication\',\n     author=\'Plone Foundation\',\n     author_email=\'releasemanager@plone.org\',\n     url=\'https://plone.org\',\n     license=\'GPL version 2\',\n+    project_urls={\n+        "Homepage": "https://plone.org",\n+        "Documentation": "https://6.docs.plone.org",\n+        "Source": "https://github.com/plone/Products.CMFPlone",\n+        "Issues": "https://github.com/plone/plone.org/Products.CMFPlone",\n+        "Forum": "https://community.plone.org/",\n+        "Chat": "https://discord.gg/zFY3EBbjaj",\n+        "Mastodon": "https://plone.social/@plone",\n+        "Twitter": "https://twitter.com/plone",\n+        "Videos": "https://youtube.com/@plonecms",\n+        "Sponsor": "https://github.com/sponsors/plone",\n+    },\n     packages=find_packages(),\n     namespace_packages=[\'Products\'],\n     include_package_data=True,\n@@ -91,7 +107,7 @@\n         \'Products.statusmessages\',\n         \'setuptools>=36.2\',\n         \'plone.autoinclude\',\n-        \'webresource>=1.1\',\n+        \'webresource>=1.2\',\n         \'Zope[wsgi] >= 5.0\',\n         \'zope.app.locales >= 3.6.0\',\n         \'zope.cachedescriptors\',\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-03-12T17:01:11+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/089f2df664cfc9b1b4e3404b4b784cb26bf5dce5

add acquire to rolemap permissions

Files changed:
M Products/CMFPlone/profiles/default/rolemap.xml

b'diff --git a/Products/CMFPlone/profiles/default/rolemap.xml b/Products/CMFPlone/profiles/default/rolemap.xml\nindex 58722b1fd5..54c9b97a0c 100644\n--- a/Products/CMFPlone/profiles/default/rolemap.xml\n+++ b/Products/CMFPlone/profiles/default/rolemap.xml\n@@ -86,55 +86,55 @@\n       <role name="Owner"/>\n       <role name="Editor"/>\n     </permission>\n-    <permission name="Plone Site Setup: Overview" acquire="True">\n+    <permission name="Plone Site Setup: Overview" acquire="True" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Editing">\n+    <permission name="Plone Site Setup: Editing" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Filtering">\n+    <permission name="Plone Site Setup: Filtering" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Language">\n+    <permission name="Plone Site Setup: Language" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Mail">\n+    <permission name="Plone Site Setup: Mail" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Markup">\n+    <permission name="Plone Site Setup: Markup" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Navigation">\n+    <permission name="Plone Site Setup: Navigation" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Search">\n+    <permission name="Plone Site Setup: Search" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Security">\n+    <permission name="Plone Site Setup: Security" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Site">\n+    <permission name="Plone Site Setup: Site" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Themes">\n+    <permission name="Plone Site Setup: Themes" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Types">\n+    <permission name="Plone Site Setup: Types" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n-    <permission name="Plone Site Setup: Users and Groups">\n+    <permission name="Plone Site Setup: Users and Groups" acquire="True">\n       <role name="Manager"/>\n       <role name="Site Administrator"/>\n     </permission>\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-03-12T17:02:19+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/b5e301c3400f5f9a9653202117eb42b7111eb249

zpretty

Files changed:
M Products/CMFPlone/controlpanel/permissions.zcml
M Products/CMFPlone/profiles/default/rolemap.xml

b'diff --git a/Products/CMFPlone/controlpanel/permissions.zcml b/Products/CMFPlone/controlpanel/permissions.zcml\nindex 7acb137927..20149e9cbf 100644\n--- a/Products/CMFPlone/controlpanel/permissions.zcml\n+++ b/Products/CMFPlone/controlpanel/permissions.zcml\n@@ -1,49 +1,76 @@\n-<configure\n-    xmlns="http://namespaces.zope.org/zope">\n+<configure xmlns="http://namespaces.zope.org/zope">\n \n-  <permission id="plone.app.controlpanel.Overview"\n-              title="Plone Site Setup: Overview"/>\n+  <permission\n+      id="plone.app.controlpanel.Overview"\n+      title="Plone Site Setup: Overview"\n+      />\n \n-  <permission id="plone.app.controlpanel.Editing"\n-              title="Plone Site Setup: Editing"/>\n+  <permission\n+      id="plone.app.controlpanel.Editing"\n+      title="Plone Site Setup: Editing"\n+      />\n \n-  <permission id="plone.app.controlpanel.Filtering"\n-              title="Plone Site Setup: Filtering"/>\n+  <permission\n+      id="plone.app.controlpanel.Filtering"\n+      title="Plone Site Setup: Filtering"\n+      />\n \n-  <permission id="plone.app.controlpanel.Language"\n-              title="Plone Site Setup: Language"/>\n+  <permission\n+      id="plone.app.controlpanel.Language"\n+      title="Plone Site Setup: Language"\n+      />\n \n-  <permission id="plone.app.controlpanel.Mail"\n-              title="Plone Site Setup: Mail"/>\n+  <permission\n+      id="plone.app.controlpanel.Mail"\n+      title="Plone Site Setup: Mail"\n+      />\n \n-  <permission id="plone.app.controlpanel.Markup"\n-              title="Plone Site Setup: Markup"/>\n+  <permission\n+      id="plone.app.controlpanel.Markup"\n+      title="Plone Site Setup: Markup"\n+      />\n \n-  <permission id="plone.app.controlpanel.Navigation"\n-              title="Plone Site Setup: Navigation"/>\n+  <permission\n+      id="plone.app.controlpanel.Navigation"\n+      title="Plone Site Setup: Navigation"\n+      />\n \n-  <permission id="plone.app.controlpanel.Search"\n-              title="Plone Site Setup: Search"/>\n+  <permission\n+      id="plone.app.controlpanel.Search"\n+      title="Plone Site Setup: Search"\n+      />\n \n-  <permission id="plone.app.controlpanel.Security"\n-              title="Plone Site Setup: Security"/>\n+  <permission\n+      id="plone.app.controlpanel.Security"\n+      title="Plone Site Setup: Security"\n+      />\n \n-  <permission id="plone.app.controlpanel.Site"\n-              title="Plone Site Setup: Site"/>\n+  <permission\n+      id="plone.app.controlpanel.Site"\n+      title="Plone Site Setup: Site"\n+      />\n \n-  <permission id="plone.app.controlpanel.Themes"\n-              title="Plone Site Setup: Themes"/>\n+  <permission\n+      id="plone.app.controlpanel.Themes"\n+      title="Plone Site Setup: Themes"\n+      />\n \n-  <permission id="plone.app.controlpanel.Types"\n-              title="Plone Site Setup: Types"/>\n+  <permission\n+      id="plone.app.controlpanel.Types"\n+      title="Plone Site Setup: Types"\n+      />\n \n-  <permission id="plone.app.controlpanel.UsersAndGroups"\n-              title="Plone Site Setup: Users and Groups"/>\n+  <permission\n+      id="plone.app.controlpanel.UsersAndGroups"\n+      title="Plone Site Setup: Users and Groups"\n+      />\n \n-  <permission id="Products.CMFPlone.InspectRelations"\n-              title="Inspect Relations">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n+  <permission\n+      id="Products.CMFPlone.InspectRelations"\n+      title="Inspect Relations"\n+      >\n+    <role name="Manager" />\n+    <role name="Site Administrator" />\n   </permission>\n \n </configure>\ndiff --git a/Products/CMFPlone/profiles/default/rolemap.xml b/Products/CMFPlone/profiles/default/rolemap.xml\nindex 54c9b97a0c..7fd7be1c58 100644\n--- a/Products/CMFPlone/profiles/default/rolemap.xml\n+++ b/Products/CMFPlone/profiles/default/rolemap.xml\n@@ -1,269 +1,363 @@\n-<?xml version="1.0"?>\n+<?xml version="1.0" encoding="utf-8"?>\n <rolemap>\n   <roles>\n-    <role name="Anonymous"/>\n-    <role name="Authenticated"/>\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-    <role name="Member"/>\n-    <role name="Owner"/>\n-    <role name="Reviewer"/>\n-    <role name="Reader"/>\n-    <role name="Editor"/>\n-    <role name="Contributor"/>\n+    <role name="Anonymous" />\n+    <role name="Authenticated" />\n+    <role name="Manager" />\n+    <role name="Site Administrator" />\n+    <role name="Member" />\n+    <role name="Owner" />\n+    <role name="Reviewer" />\n+    <role name="Reader" />\n+    <role name="Editor" />\n+    <role name="Contributor" />\n   </roles>\n   <permissions>\n-    <permission name="Access inactive portal content"\n-                acquire="True">\n-      <role name="Owner"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Add portal content" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="Add portal folders" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="Allow sendto" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Change local roles" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Copy or Move" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Delete objects" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="FTP access" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="List folder contents" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Reviewer"/>\n-      <role name="Editor"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="List portal members" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="List undoable changes" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Mail forgotten password" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Manage properties" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Modify view template" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Overview" acquire="True" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Editing" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Filtering" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Language" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Mail" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Markup" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Navigation" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Search" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Security" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Site" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Themes" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Types" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Plone Site Setup: Users and Groups" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Request review" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Reply to item" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Review portal content" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Reviewer"/>\n-    </permission>\n-    <permission name="Search ZCatalog" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Set own password" acquire="False">\n-      <role name="Authenticated"/>\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Set own properties" acquire="False">\n-      <role name="Authenticated"/>\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Undo changes" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="Use mailhost services" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Use version control" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="View Groups" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="View management screens"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="WebDAV access" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="WebDAV Lock items" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="WebDAV Unlock items" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Portlets: Manage portlets"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Portlets: Manage own portlets"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Portlets: View dashboard"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Content rules: Manage rules"\n-                acquire="False">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="View"\n-                acquire="True">\n-      <role name="Site Administrator"/>\n-      <role name="Reader"/>\n-      <role name="Editor"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="Access contents information"\n-                acquire="True">\n-      <role name="Site Administrator"/>\n-      <role name="Reader"/>\n-      <role name="Editor"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="Modify portal content"\n-                acquire="True">\n-      <role name="Site Administrator"/>\n-      <role name="Editor"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="Add portal member"\n-                acquire="False">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="plone.resourceeditor: Manage Sources"\n-                acquire="False">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Show Toolbar"\n-                acquire="False">\n-      <role name="Authenticated"/>\n-    </permission>\n-    <permission name="Manage Context Aliases" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Manage Portal Aliases" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n+    <permission acquire="True"\n+                name="Access inactive portal content"\n+    >\n+      <role name="Owner" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Add portal content"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Add portal folders"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Allow sendto"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Change local roles"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Copy or Move"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Delete objects"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="FTP access"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="List folder contents"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Reviewer" />\n+      <role name="Editor" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="List portal members"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="List undoable changes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Mail forgotten password"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage properties"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Modify view template"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Overview"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Editing"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Filtering"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Language"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Mail"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Markup"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Navigation"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Search"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Security"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Site"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Themes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Types"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Users and Groups"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Request review"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Reply to item"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Review portal content"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Reviewer" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Search ZCatalog"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Set own password"\n+    >\n+      <role name="Authenticated" />\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Set own properties"\n+    >\n+      <role name="Authenticated" />\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Undo changes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Use mailhost services"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Use version control"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View Groups"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View management screens"\n+    >\n+      <role name="Manager" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV access"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV Lock items"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV Unlock items"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: Manage portlets"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: Manage own portlets"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: View dashboard"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Content rules: Manage rules"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Reader" />\n+      <role name="Editor" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Access contents information"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Reader" />\n+      <role name="Editor" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Modify portal content"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Editor" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Add portal member"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="False"\n+                name="plone.resourceeditor: Manage Sources"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Show Toolbar"\n+    >\n+      <role name="Authenticated" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage Context Aliases"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage Portal Aliases"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n     </permission>\n   </permissions>\n </rolemap>\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-03-13T10:14:30+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/1c1a0445a4a042af20a3602dda629999a8bf1186

Move Site Administrator to rolemap.xml for two more permissions.

Files changed:
M Products/CMFPlone/controlpanel/browser/configure.zcml
M Products/CMFPlone/controlpanel/permissions.zcml
M Products/CMFPlone/profiles/default/rolemap.xml

b'diff --git a/Products/CMFPlone/controlpanel/browser/configure.zcml b/Products/CMFPlone/controlpanel/browser/configure.zcml\nindex 671c66f1ed..be2811ec27 100644\n--- a/Products/CMFPlone/controlpanel/browser/configure.zcml\n+++ b/Products/CMFPlone/controlpanel/browser/configure.zcml\n@@ -11,7 +11,6 @@\n       id="plone.app.controlpanel.TinyMCE"\n       title="Plone Site Setup: TinyMCE">\n     <role name="Manager"/>\n-    <role name="Site Administrator"/>\n   </permission>\n \n   <!-- Control Panel Main Template -->\ndiff --git a/Products/CMFPlone/controlpanel/permissions.zcml b/Products/CMFPlone/controlpanel/permissions.zcml\nindex 20149e9cbf..31ead7bc5a 100644\n--- a/Products/CMFPlone/controlpanel/permissions.zcml\n+++ b/Products/CMFPlone/controlpanel/permissions.zcml\n@@ -70,7 +70,6 @@\n       title="Inspect Relations"\n       >\n     <role name="Manager" />\n-    <role name="Site Administrator" />\n   </permission>\n \n </configure>\ndiff --git a/Products/CMFPlone/profiles/default/rolemap.xml b/Products/CMFPlone/profiles/default/rolemap.xml\nindex 7fd7be1c58..774005a03e 100644\n--- a/Products/CMFPlone/profiles/default/rolemap.xml\n+++ b/Products/CMFPlone/profiles/default/rolemap.xml\n@@ -179,6 +179,12 @@\n       <role name="Manager" />\n       <role name="Site Administrator" />\n     </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: TinyMCE"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n     <permission acquire="True"\n                 name="Plone Site Setup: Types"\n     >\n@@ -359,5 +365,11 @@\n       <role name="Manager" />\n       <role name="Site Administrator" />\n     </permission>\n+    <permission acquire="True"\n+                name="Inspect Relations"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n   </permissions>\n </rolemap>\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-03-13T14:16:45+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/53a23e88d1c14105a036955119ea2098bea9d35a

Merge pull request #3225 from plone/issue_3223

fixes 3223. Site Administrator role

Files changed:
A news/3223.bugfix
M Products/CMFPlone/controlpanel/browser/configure.zcml
M Products/CMFPlone/controlpanel/permissions.zcml
M Products/CMFPlone/profiles/default/rolemap.xml

b'diff --git a/Products/CMFPlone/controlpanel/browser/configure.zcml b/Products/CMFPlone/controlpanel/browser/configure.zcml\nindex 671c66f1ed..be2811ec27 100644\n--- a/Products/CMFPlone/controlpanel/browser/configure.zcml\n+++ b/Products/CMFPlone/controlpanel/browser/configure.zcml\n@@ -11,7 +11,6 @@\n       id="plone.app.controlpanel.TinyMCE"\n       title="Plone Site Setup: TinyMCE">\n     <role name="Manager"/>\n-    <role name="Site Administrator"/>\n   </permission>\n \n   <!-- Control Panel Main Template -->\ndiff --git a/Products/CMFPlone/controlpanel/permissions.zcml b/Products/CMFPlone/controlpanel/permissions.zcml\nindex 249aeb6c71..31ead7bc5a 100644\n--- a/Products/CMFPlone/controlpanel/permissions.zcml\n+++ b/Products/CMFPlone/controlpanel/permissions.zcml\n@@ -1,88 +1,75 @@\n-<configure\n-    xmlns="http://namespaces.zope.org/zope">\n+<configure xmlns="http://namespaces.zope.org/zope">\n \n-  <permission id="plone.app.controlpanel.Overview"\n-              title="Plone Site Setup: Overview">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Overview"\n+      title="Plone Site Setup: Overview"\n+      />\n \n-  <permission id="plone.app.controlpanel.Editing"\n-              title="Plone Site Setup: Editing">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Editing"\n+      title="Plone Site Setup: Editing"\n+      />\n \n-  <permission id="plone.app.controlpanel.Filtering"\n-              title="Plone Site Setup: Filtering">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Filtering"\n+      title="Plone Site Setup: Filtering"\n+      />\n \n-  <permission id="plone.app.controlpanel.Language"\n-              title="Plone Site Setup: Language">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Language"\n+      title="Plone Site Setup: Language"\n+      />\n \n-  <permission id="plone.app.controlpanel.Mail"\n-              title="Plone Site Setup: Mail">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Mail"\n+      title="Plone Site Setup: Mail"\n+      />\n \n-  <permission id="plone.app.controlpanel.Markup"\n-              title="Plone Site Setup: Markup">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Markup"\n+      title="Plone Site Setup: Markup"\n+      />\n \n-  <permission id="plone.app.controlpanel.Navigation"\n-              title="Plone Site Setup: Navigation">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Navigation"\n+      title="Plone Site Setup: Navigation"\n+      />\n \n-  <permission id="plone.app.controlpanel.Search"\n-              title="Plone Site Setup: Search">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Search"\n+      title="Plone Site Setup: Search"\n+      />\n \n-  <permission id="plone.app.controlpanel.Security"\n-              title="Plone Site Setup: Security">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Security"\n+      title="Plone Site Setup: Security"\n+      />\n \n-  <permission id="plone.app.controlpanel.Site"\n-              title="Plone Site Setup: Site">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Site"\n+      title="Plone Site Setup: Site"\n+      />\n \n-  <permission id="plone.app.controlpanel.Themes"\n-              title="Plone Site Setup: Themes">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Themes"\n+      title="Plone Site Setup: Themes"\n+      />\n \n-  <permission id="plone.app.controlpanel.Types"\n-              title="Plone Site Setup: Types">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Types"\n+      title="Plone Site Setup: Types"\n+      />\n \n-  <permission id="plone.app.controlpanel.UsersAndGroups"\n-              title="Plone Site Setup: Users and Groups">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.UsersAndGroups"\n+      title="Plone Site Setup: Users and Groups"\n+      />\n \n-  <permission id="Products.CMFPlone.InspectRelations"\n-              title="Inspect Relations">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n+  <permission\n+      id="Products.CMFPlone.InspectRelations"\n+      title="Inspect Relations"\n+      >\n+    <role name="Manager" />\n   </permission>\n \n </configure>\ndiff --git a/Products/CMFPlone/profiles/default/rolemap.xml b/Products/CMFPlone/profiles/default/rolemap.xml\nindex 04c4a47979..774005a03e 100644\n--- a/Products/CMFPlone/profiles/default/rolemap.xml\n+++ b/Products/CMFPlone/profiles/default/rolemap.xml\n@@ -1,217 +1,375 @@\n-<?xml version="1.0"?>\n+<?xml version="1.0" encoding="utf-8"?>\n <rolemap>\n   <roles>\n-    <role name="Anonymous"/>\n-    <role name="Authenticated"/>\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-    <role name="Member"/>\n-    <role name="Owner"/>\n-    <role name="Reviewer"/>\n+    <role name="Anonymous" />\n+    <role name="Authenticated" />\n+    <role name="Manager" />\n+    <role name="Site Administrator" />\n+    <role name="Member" />\n+    <role name="Owner" />\n+    <role name="Reviewer" />\n     <role name="Reader" />\n     <role name="Editor" />\n     <role name="Contributor" />\n   </roles>\n   <permissions>\n-    <permission name="Access inactive portal content"\n-                acquire="True">\n-      <role name="Owner"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Add portal content" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="Add portal folders" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="Allow sendto" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Change local roles" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Copy or Move" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Delete objects" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="FTP access" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="List folder contents" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n+    <permission acquire="True"\n+                name="Access inactive portal content"\n+    >\n+      <role name="Owner" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Add portal content"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Add portal folders"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Allow sendto"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Change local roles"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Copy or Move"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Delete objects"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="FTP access"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="List folder contents"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n       <role name="Reviewer" />\n       <role name="Editor" />\n       <role name="Contributor" />\n     </permission>\n-    <permission name="List portal members" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="List undoable changes" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Mail forgotten password" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Manage properties" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Modify view template" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Request review" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Reply to item" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Review portal content" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Reviewer"/>\n-    </permission>\n-    <permission name="Search ZCatalog" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Set own password" acquire="False">\n-      <role name="Authenticated"/>\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Set own properties" acquire="False">\n-      <role name="Authenticated"/>\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Undo changes" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="Use mailhost services" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Use version control" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="View Groups" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="View management screens"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="WebDAV access" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="WebDAV Lock items" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="WebDAV Unlock items" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Portlets: Manage portlets"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Portlets: Manage own portlets"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Portlets: View dashboard"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Content rules: Manage rules"\n-                acquire="False">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="View"\n-                acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Reader" />\n-        <role name="Editor" />\n-        <role name="Contributor" />\n-    </permission>\n-    <permission name="Access contents information"\n-                acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Reader" />\n-        <role name="Editor" />\n-        <role name="Contributor" />\n-    </permission>\n-    <permission name="Modify portal content"\n-                acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Editor" />\n-        <role name="Owner" />\n-    </permission>\n-    <permission name="Add portal member"\n-                acquire="False">\n-        <role name="Manager" />\n-        <role name="Site Administrator"/>\n-        <role name="Owner" />\n-    </permission>\n-    <permission name="plone.resourceeditor: Manage Sources"\n-                acquire="False">\n-      <role name="Manager" />\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Show Toolbar"\n-                acquire="False">\n-      <role name="Authenticated"/>\n-    </permission>\n-    <permission name="Manage Context Aliases" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Manage Portal Aliases" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n+    <permission acquire="True"\n+                name="List portal members"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="List undoable changes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Mail forgotten password"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage properties"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Modify view template"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Overview"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Editing"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Filtering"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Language"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Mail"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Markup"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Navigation"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Search"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Security"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Site"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Themes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: TinyMCE"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Types"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Users and Groups"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Request review"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Reply to item"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Review portal content"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Reviewer" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Search ZCatalog"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Set own password"\n+    >\n+      <role name="Authenticated" />\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Set own properties"\n+    >\n+      <role name="Authenticated" />\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Undo changes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Use mailhost services"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Use version control"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View Groups"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View management screens"\n+    >\n+      <role name="Manager" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV access"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV Lock items"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV Unlock items"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: Manage portlets"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: Manage own portlets"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: View dashboard"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Content rules: Manage rules"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Reader" />\n+      <role name="Editor" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Access contents information"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Reader" />\n+      <role name="Editor" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Modify portal content"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Editor" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Add portal member"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="False"\n+                name="plone.resourceeditor: Manage Sources"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Show Toolbar"\n+    >\n+      <role name="Authenticated" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage Context Aliases"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage Portal Aliases"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Inspect Relations"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n     </permission>\n   </permissions>\n </rolemap>\ndiff --git a/news/3223.bugfix b/news/3223.bugfix\nnew file mode 100644\nindex 0000000000..a9c5cbcb5c\n--- /dev/null\n+++ b/news/3223.bugfix\n@@ -0,0 +1,4 @@\n+Moved the assignment of Plone Site Setup permissions from zcml to GenericSetup\n+rolemap.xml. This assigns the permissions on site creation instead of Zope root\n+where the `Site Administrator` role does not actually exist\n+[ewohnlich]\n\\ No newline at end of file\n'

