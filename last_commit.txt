Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2018-05-14T08:52:26+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/4be00d0a130cdcdc049de13fc4c322c38f9c56aa

When adding a Plone Site, do a transaction commit before applying extra profiles.

This avoids errors in some cases when selecting add-ons in the advanced Plone Site add form,
where installing them right after site creation in the add-ons control panel goes fine.

Fixes https://github.com/plone/Products.CMFPlone/issues/2316

Files changed:
M CHANGES.rst
M Products/CMFPlone/factory.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1735203a0..2b7087f30 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -58,6 +58,12 @@ New Features:
 
 Bug Fixes:
 
+- When adding a Plone Site, do a transaction commit before applying extra profiles.
+  This avoids errors in some cases when selecting add-ons in the advanced Plone Site add form,
+  where installing them right after site creation in the add-ons control panel goes fine.
+  Fixes `issue 2316 <https://github.com/plone/Products.CMFPlone/issues/2316>`_.
+  [maurits]
+
 - Unflakied a unit test.
   [Rotonen]
 
diff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py
index af016699a..404c79a6f 100644
--- a/Products/CMFPlone/factory.py
+++ b/Products/CMFPlone/factory.py
@@ -9,6 +9,9 @@
 from zope.interface import implementer
 from zope.site.hooks import setSite
 
+import transaction
+
+
 _TOOL_ID = 'portal_setup'
 _DEFAULT_PROFILE = 'Products.CMFPlone:plone'
 _CONTENT_PROFILE = 'plone.app.contenttypes:plone-content'
@@ -163,6 +166,14 @@ def addPloneSite(context, site_id, title='Plone site', description='',
     # properties.xml file are applied and not overwritten by this
     site.manage_changeProperties(**props)
 
+    # In some cases we can get errors when add-ons are installed immediately.
+    # Installing the add-ons separately within the Add-ons control panel
+    # goes fine.
+    # One example is https://github.com/plone/Products.CMFPlone/issues/2316
+    # So it seems helpful to do a transaction commit here.
+    if extension_ids:
+        transaction.commit()
+
     for extension_id in extension_ids:
         setup_tool.runAllImportStepsFromProfile(
             'profile-%s' % extension_id)


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2018-05-14T11:17:21+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/491e0ebe8d188fc4f883777a60d7e88c1740c184

Merge pull request #2410 from plone/add-plonesite-commit-before-applying-profiles-master

Add Plone Site: do a transaction commit before profiles

Files changed:
M CHANGES.rst
M Products/CMFPlone/factory.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1735203a0..2b7087f30 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -58,6 +58,12 @@ New Features:
 
 Bug Fixes:
 
+- When adding a Plone Site, do a transaction commit before applying extra profiles.
+  This avoids errors in some cases when selecting add-ons in the advanced Plone Site add form,
+  where installing them right after site creation in the add-ons control panel goes fine.
+  Fixes `issue 2316 <https://github.com/plone/Products.CMFPlone/issues/2316>`_.
+  [maurits]
+
 - Unflakied a unit test.
   [Rotonen]
 
diff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py
index af016699a..404c79a6f 100644
--- a/Products/CMFPlone/factory.py
+++ b/Products/CMFPlone/factory.py
@@ -9,6 +9,9 @@
 from zope.interface import implementer
 from zope.site.hooks import setSite
 
+import transaction
+
+
 _TOOL_ID = 'portal_setup'
 _DEFAULT_PROFILE = 'Products.CMFPlone:plone'
 _CONTENT_PROFILE = 'plone.app.contenttypes:plone-content'
@@ -163,6 +166,14 @@ def addPloneSite(context, site_id, title='Plone site', description='',
     # properties.xml file are applied and not overwritten by this
     site.manage_changeProperties(**props)
 
+    # In some cases we can get errors when add-ons are installed immediately.
+    # Installing the add-ons separately within the Add-ons control panel
+    # goes fine.
+    # One example is https://github.com/plone/Products.CMFPlone/issues/2316
+    # So it seems helpful to do a transaction commit here.
+    if extension_ids:
+        transaction.commit()
+
     for extension_id in extension_ids:
         setup_tool.runAllImportStepsFromProfile(
             'profile-%s' % extension_id)


