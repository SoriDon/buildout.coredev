Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-08-20T11:54:43+02:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/c6b47f786c24c97631f89f356fc630a76dab8f42

Fix @vocabularies endpoint to search in translated term titles (#1205)

* Fix @vocabularies endpoint to search in translated term titles

* Added just one more test

Files changed:
A news/1204.bugfix
M src/plone/restapi/serializer/vocabularies.py
M src/plone/restapi/tests/test_services_vocabularies.py

b'diff --git a/news/1204.bugfix b/news/1204.bugfix\nnew file mode 100644\nindex 000000000..81cc6059e\n--- /dev/null\n+++ b/news/1204.bugfix\n@@ -0,0 +1,2 @@\n+Fix @vocabularies endpoint to search in translated term titles\n+[sneridagh]\ndiff --git a/src/plone/restapi/serializer/vocabularies.py b/src/plone/restapi/serializer/vocabularies.py\nindex 1e78cdcd1..26acb2407 100644\n--- a/src/plone/restapi/serializer/vocabularies.py\n+++ b/src/plone/restapi/serializer/vocabularies.py\n@@ -45,7 +45,10 @@ def __call__(self, vocabulary_id):\n                 terms.append(term)\n             else:\n                 term_title = safe_unicode(getattr(term, "title", None) or "")\n-                if title.lower() not in term_title.lower():\n+                if (\n+                    title.lower()\n+                    not in translate(term_title, context=self.request).lower()\n+                ):\n                     continue\n                 terms.append(term)\n \ndiff --git a/src/plone/restapi/tests/test_services_vocabularies.py b/src/plone/restapi/tests/test_services_vocabularies.py\nindex 0cab7b7b3..2b4e4324e 100644\n--- a/src/plone/restapi/tests/test_services_vocabularies.py\n+++ b/src/plone/restapi/tests/test_services_vocabularies.py\n@@ -22,9 +22,20 @@\n TEST_TERM_4 = UtilityTerm(45, "token4")\n TEST_TERM_5 = SimpleTerm(46, token="token5", title="T\xc3\xb6tle 5")\n TEST_TERM_6 = SimpleTerm(47, token="token6", title="T\xc3\xb6tle 6")\n+TEST_TERM_7 = SimpleTerm(\n+    48, token="token7", title="This is a title for the seventh term"\n+)\n \n TEST_VOCABULARY = SimpleVocabulary(\n-    [TEST_TERM_1, TEST_TERM_2, TEST_TERM_3, TEST_TERM_4, TEST_TERM_5, TEST_TERM_6]\n+    [\n+        TEST_TERM_1,\n+        TEST_TERM_2,\n+        TEST_TERM_3,\n+        TEST_TERM_4,\n+        TEST_TERM_5,\n+        TEST_TERM_6,\n+        TEST_TERM_7,\n+    ]\n )\n \n \n@@ -81,8 +92,12 @@ def test_get_vocabulary(self):\n                     {"title": "token4", "token": "token4"},\n                     {"title": "T\\xf6tle 5", "token": "token5"},\n                     {"title": "T\\xf6tle 6", "token": "token6"},\n+                    {\n+                        "title": "This is a title for the seventh term",\n+                        "token": "token7",\n+                    },\n                 ],\n-                "items_total": 6,\n+                "items_total": 7,\n             },\n         )\n \n@@ -104,30 +119,40 @@ def test_get_vocabulary_batched(self):\n                     "first": self.portal_url\n                     + "/@vocabularies/plone.restapi.tests.test_vocabulary?b_start=0&b_size=1",  # noqa\n                     "last": self.portal_url\n-                    + "/@vocabularies/plone.restapi.tests.test_vocabulary?b_start=5&b_size=1",  # noqa\n+                    + "/@vocabularies/plone.restapi.tests.test_vocabulary?b_start=6&b_size=1",  # noqa\n                     "next": self.portal_url\n                     + "/@vocabularies/plone.restapi.tests.test_vocabulary?b_start=1&b_size=1",  # noqa\n                 },\n                 "items": [{"title": "Title 1", "token": "token1"}],\n-                "items_total": 6,\n+                "items_total": 7,\n             },\n         )\n \n     def test_get_vocabulary_filtered_by_title(self):\n         response = self.api_session.get(\n-            "/@vocabularies/plone.restapi.tests.test_vocabulary?title=2"\n+            "/@vocabularies/plone.restapi.tests.test_vocabulary?title=This"\n         )\n \n         self.assertEqual(200, response.status_code)\n         response = response.json()\n         self.assertEqual(\n-            response,\n-            {\n-                "@id": self.portal_url\n-                + "/@vocabularies/plone.restapi.tests.test_vocabulary?title=2",  # noqa\n-                "items": [{"title": "Title 2", "token": "token2"}],\n-                "items_total": 1,\n-            },\n+            response["items"][0],\n+            {"title": "This is a title for the seventh term", "token": "token7"},\n+        )\n+        self.assertEqual(\n+            response["items_total"],\n+            1,\n+        )\n+\n+        response = self.api_session.get(\n+            "/@vocabularies/plone.restapi.tests.test_vocabulary?title=is+a+title"\n+        )\n+\n+        self.assertEqual(200, response.status_code)\n+        response = response.json()\n+        self.assertEqual(\n+            response["items"][0],\n+            {"title": "This is a title for the seventh term", "token": "token7"},\n         )\n \n     def test_get_vocabulary_filtered_by_non_ascii_title(self):\n@@ -150,6 +175,26 @@ def test_get_vocabulary_filtered_by_non_ascii_title(self):\n             },\n         )\n \n+    def test_get_vocabulary_filtered_by_non_ascii_title_as_plain_utf(self):\n+        response = self.api_session.get(\n+            "/@vocabularies/plone.restapi.tests.test_vocabulary?title=t\xc3\xb6tle"\n+        )\n+\n+        self.assertEqual(200, response.status_code)\n+        response = response.json()\n+        self.assertEqual(\n+            response,\n+            {\n+                "@id": self.portal_url\n+                + "/@vocabularies/plone.restapi.tests.test_vocabulary?title=t%C3%B6tle",  # noqa\n+                "items": [\n+                    {"title": "T\xc3\xb6tle 5", "token": "token5"},\n+                    {"title": "T\xc3\xb6tle 6", "token": "token6"},\n+                ],\n+                "items_total": 2,\n+            },\n+        )\n+\n     def test_get_vocabulary_filtered_by_token(self):\n         response = self.api_session.get(\n             "/@vocabularies/plone.restapi.tests.test_vocabulary?token=token1"\n'

