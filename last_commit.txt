Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-08-11T17:03:14+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/9b3a1cc7b35baa135abedd872169bf58167b990d

Allow access to the macros of the main_template, also from skin templates.

Fixes https://github.com/plone/Products.CMFPlone/issues/3581

Files changed:
A news/3581.bugfix
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/browser/interfaces.py
M Products/CMFPlone/browser/main_template.py

b'diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml\nindex 419bbca7bc..4c3152dd4f 100644\n--- a/Products/CMFPlone/browser/configure.zcml\n+++ b/Products/CMFPlone/browser/configure.zcml\n@@ -99,6 +99,7 @@\n       for="*"\n       name="main_template"\n       class=".main_template.MainTemplate"\n+      allowed_interface=".interfaces.IMainTemplate"\n       permission="zope.Public"\n       />\n \ndiff --git a/Products/CMFPlone/browser/interfaces.py b/Products/CMFPlone/browser/interfaces.py\nindex 404b172258..9a09561e91 100644\n--- a/Products/CMFPlone/browser/interfaces.py\n+++ b/Products/CMFPlone/browser/interfaces.py\n@@ -1,4 +1,5 @@\n from zope import schema\n+from zope.interface import Attribute\n from zope.interface import Interface\n \n from plone.schema import Email\n@@ -189,6 +190,9 @@ def createSiteMap():\n class IMainTemplate(Interface):\n     """Interface to the view that generated the main_template"""\n \n+    macros = Attribute("Macros")\n+    template_name = Attribute("Template name")\n+\n \n class IGlobalStatusMessage(Interface):\n     """Interface to the view that generated the main_template"""\ndiff --git a/Products/CMFPlone/browser/main_template.py b/Products/CMFPlone/browser/main_template.py\nindex 707ca21284..b68867268e 100644\n--- a/Products/CMFPlone/browser/main_template.py\n+++ b/Products/CMFPlone/browser/main_template.py\n@@ -22,9 +22,9 @@ def template_name(self):\n \n     @property\n     def macros(self):\n-        # Reinstanciating the templatefile is a workaround for\n+        # Reinstantiating the templatefile is a workaround for\n         # https://github.com/plone/Products.CMFPlone/issues/2666\n-        # Without this a inifite recusion in a template\n+        # Without this an infinite recursion in a template\n         # (i.e. a template that calls its own view)\n         # kills the instance instead of raising a RecursionError.\n         return ViewPageTemplateFile(self.template_name).macros\ndiff --git a/news/3581.bugfix b/news/3581.bugfix\nnew file mode 100644\nindex 0000000000..32eba96b1f\n--- /dev/null\n+++ b/news/3581.bugfix\n@@ -0,0 +1,2 @@\n+Allow access to the macros of the main_template, also from skin templates.\n+[maurits]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-08-13T16:55:22+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/881a0c37d16c91d71e2548f9f80af25128140c02

Merge pull request #3583 from plone/maurits-main-template-allow-macros-issue-3581

Allow access to macros of main_template, also from skin templates

Files changed:
A news/3581.bugfix
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/browser/interfaces.py
M Products/CMFPlone/browser/main_template.py

b'diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml\nindex 419bbca7bc..4c3152dd4f 100644\n--- a/Products/CMFPlone/browser/configure.zcml\n+++ b/Products/CMFPlone/browser/configure.zcml\n@@ -99,6 +99,7 @@\n       for="*"\n       name="main_template"\n       class=".main_template.MainTemplate"\n+      allowed_interface=".interfaces.IMainTemplate"\n       permission="zope.Public"\n       />\n \ndiff --git a/Products/CMFPlone/browser/interfaces.py b/Products/CMFPlone/browser/interfaces.py\nindex 404b172258..9a09561e91 100644\n--- a/Products/CMFPlone/browser/interfaces.py\n+++ b/Products/CMFPlone/browser/interfaces.py\n@@ -1,4 +1,5 @@\n from zope import schema\n+from zope.interface import Attribute\n from zope.interface import Interface\n \n from plone.schema import Email\n@@ -189,6 +190,9 @@ def createSiteMap():\n class IMainTemplate(Interface):\n     """Interface to the view that generated the main_template"""\n \n+    macros = Attribute("Macros")\n+    template_name = Attribute("Template name")\n+\n \n class IGlobalStatusMessage(Interface):\n     """Interface to the view that generated the main_template"""\ndiff --git a/Products/CMFPlone/browser/main_template.py b/Products/CMFPlone/browser/main_template.py\nindex 707ca21284..b68867268e 100644\n--- a/Products/CMFPlone/browser/main_template.py\n+++ b/Products/CMFPlone/browser/main_template.py\n@@ -22,9 +22,9 @@ def template_name(self):\n \n     @property\n     def macros(self):\n-        # Reinstanciating the templatefile is a workaround for\n+        # Reinstantiating the templatefile is a workaround for\n         # https://github.com/plone/Products.CMFPlone/issues/2666\n-        # Without this a inifite recusion in a template\n+        # Without this an infinite recursion in a template\n         # (i.e. a template that calls its own view)\n         # kills the instance instead of raising a RecursionError.\n         return ViewPageTemplateFile(self.template_name).macros\ndiff --git a/news/3581.bugfix b/news/3581.bugfix\nnew file mode 100644\nindex 0000000000..32eba96b1f\n--- /dev/null\n+++ b/news/3581.bugfix\n@@ -0,0 +1,2 @@\n+Allow access to the macros of the main_template, also from skin templates.\n+[maurits]\n'

