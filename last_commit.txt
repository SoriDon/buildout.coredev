Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2016-05-23T12:32:52+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/4193630f8f40f69f3dbddeba72f2e16139c3b57e

Replaced placeful_marker import step with a post_handler.

Files changed:
M CHANGES.rst
M Products/CMFPlacefulWorkflow/exportimport.zcml
M Products/CMFPlacefulWorkflow/profiles.zcml
M Products/CMFPlacefulWorkflow/setuphandlers.py
M setup.py
D Products/CMFPlacefulWorkflow/profiles/base/placeful_marker.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index 380fd39..e2b533c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,7 +6,7 @@ Changelog
 
 New:
 
-- *add item here*
+- Replaced ``placeful_marker`` import step with a ``post_handler``.  [maurits]
 
 Fixes:
 
diff --git a/Products/CMFPlacefulWorkflow/exportimport.zcml b/Products/CMFPlacefulWorkflow/exportimport.zcml
index b99b40b..14faf39 100644
--- a/Products/CMFPlacefulWorkflow/exportimport.zcml
+++ b/Products/CMFPlacefulWorkflow/exportimport.zcml
@@ -41,12 +41,4 @@
      handler="Products.CMFPlacefulWorkflow.exportimport.exportWorkflowPolicies"
      />
 
-  <genericsetup:importStep
-     name="placeful_marker"
-     title="Placeful Workflow Tool Marker Interface"
-     description="Add placeful marker to default workflow tool"
-     handler="Products.CMFPlacefulWorkflow.setuphandlers.installMarker">
-    <depends name="workflow"/>
-  </genericsetup:importStep>
-
 </configure>
diff --git a/Products/CMFPlacefulWorkflow/profiles.zcml b/Products/CMFPlacefulWorkflow/profiles.zcml
index eaacc52..68a1a6f 100644
--- a/Products/CMFPlacefulWorkflow/profiles.zcml
+++ b/Products/CMFPlacefulWorkflow/profiles.zcml
@@ -17,6 +17,7 @@
      directory="profiles/base"
      description="Add in Plone the capability to change workflow chains for types in every object. With no dependency on core Plone types."
      provides="Products.GenericSetup.interfaces.EXTENSION"
+     post_handler="Products.CMFPlacefulWorkflow.setuphandlers.installMarker"
      />
 
   <genericsetup:upgradeStep
diff --git a/Products/CMFPlacefulWorkflow/profiles/base/placeful_marker.txt b/Products/CMFPlacefulWorkflow/profiles/base/placeful_marker.txt
deleted file mode 100644
index 792d600..0000000
--- a/Products/CMFPlacefulWorkflow/profiles/base/placeful_marker.txt
+++ /dev/null
@@ -1 +0,0 @@
-#
diff --git a/Products/CMFPlacefulWorkflow/setuphandlers.py b/Products/CMFPlacefulWorkflow/setuphandlers.py
index 47eadf5..655d0dc 100644
--- a/Products/CMFPlacefulWorkflow/setuphandlers.py
+++ b/Products/CMFPlacefulWorkflow/setuphandlers.py
@@ -25,10 +25,6 @@ def installMarker(context):
     Apply a marker interface to the workflow tool to indicate that the
     product is installed.
     """
-    # Only run step if a flag file is present (e.g. not an extension profile)
-    if context.readDataFile('placeful_marker.txt') is None:
-        return
-    site = context.getSite()
-    wf = getToolByName(site, 'portal_workflow', None)
+    wf = getToolByName(context, 'portal_workflow', None)
     if wf is not None:
         alsoProvides(wf, IPlacefulMarker)
diff --git a/setup.py b/setup.py
index a207a1e..f56e3ef 100644
--- a/setup.py
+++ b/setup.py
@@ -34,6 +34,6 @@
           'zope.i18nmessageid',
           'Products.CMFCore',
           'Products.CMFPlone',
-          'Products.GenericSetup',
+          'Products.GenericSetup>=1.8.2',
       ],
       )


Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2016-05-23T12:33:01+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/fdf93e10304b4c2b4fee4e10f662c2d0dd5f8a75

Removed actionicons.xml because this is handled in controlpanel.xml.

Files changed:
M CHANGES.rst
D Products/CMFPlacefulWorkflow/profiles/base/actionicons.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index e2b533c..e3e3441 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,6 +6,8 @@ Changelog
 
 New:
 
+- Removed ``actionicons.xml`` because this is handled in ``controlpanel.xml``.  [maurits]
+
 - Replaced ``placeful_marker`` import step with a ``post_handler``.  [maurits]
 
 Fixes:
diff --git a/Products/CMFPlacefulWorkflow/profiles/base/actionicons.xml b/Products/CMFPlacefulWorkflow/profiles/base/actionicons.xml
deleted file mode 100644
index 7b43e7e..0000000
--- a/Products/CMFPlacefulWorkflow/profiles/base/actionicons.xml
+++ /dev/null
@@ -1,13 +0,0 @@
-<?xml version="1.0"?>
-<action-icons
-	xmlns:i18n="http://xml.zope.org/namespaces/i18n"
-    i18n:domain="plone">
-<action-icon
-	category="controlpanel"
-    action_id="placefulworkflow"
-    title="Placeful Workflow"
-    priority="0"
-    icon_expr="placefulworkflow_icon.png"
-    i18n:attributes="title"
-/>
-</action-icons>


Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2016-05-23T12:33:01+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/24012ce88a493a1961cdc2abb509dcfca222256a

Added uninstall profile instead of old external method.

Files changed:
A Products/CMFPlacefulWorkflow/profiles/uninstall/componentregistry.xml
A Products/CMFPlacefulWorkflow/profiles/uninstall/controlpanel.xml
A Products/CMFPlacefulWorkflow/profiles/uninstall/metadata.xml
A Products/CMFPlacefulWorkflow/profiles/uninstall/skins.xml
A Products/CMFPlacefulWorkflow/profiles/uninstall/toolset.xml
M CHANGES.rst
M Products/CMFPlacefulWorkflow/profiles.zcml
M Products/CMFPlacefulWorkflow/setuphandlers.py
M setup.py
D Products/CMFPlacefulWorkflow/Extensions/Install.py

diff --git a/CHANGES.rst b/CHANGES.rst
index e3e3441..a5ab5a4 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,6 +6,8 @@ Changelog
 
 New:
 
+- Added ``uninstall`` profile instead of old external method.  [maurits]
+
 - Removed ``actionicons.xml`` because this is handled in ``controlpanel.xml``.  [maurits]
 
 - Replaced ``placeful_marker`` import step with a ``post_handler``.  [maurits]
diff --git a/Products/CMFPlacefulWorkflow/Extensions/Install.py b/Products/CMFPlacefulWorkflow/Extensions/Install.py
deleted file mode 100644
index d7ef285..0000000
--- a/Products/CMFPlacefulWorkflow/Extensions/Install.py
+++ /dev/null
@@ -1,49 +0,0 @@
-# -*- coding: utf-8 -*-
-# CMFPlacefulWorkflow
-# Copyright (C)2005 Ingeniweb
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or
-# (at your option) any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; see the file COPYING. If not, write to the
-# Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-"""
-Product installation
-"""
-
-from Products.CMFCore.utils import getToolByName
-from Products.CMFPlacefulWorkflow.global_symbols import placeful_prefs_configlet
-from Products.CMFPlacefulWorkflow.interfaces import IPlacefulMarker
-from Products.CMFPlacefulWorkflow.interfaces import IPlacefulWorkflowTool
-from cStringIO import StringIO
-from zope.component import getSiteManager
-from zope.interface import noLongerProvides
-
-
-def uninstall(self, reinstall=False, out=None):
-    if out is None:
-        out = StringIO()
-
-    getSiteManager(self).unregisterUtility(self['portal_placeful_workflow'],
-                                           IPlacefulWorkflowTool)
-    # uninstall configlets
-    try:
-        cptool = getToolByName(self, 'portal_controlpanel')
-        cptool.unregisterConfiglet(placeful_prefs_configlet['id'])
-        out.write('Removing CMFPlacefulWorkflow Configlet')
-    except:
-        out.write('Failed to remove CMFPlacefulWorkflow Configlet')
-
-    wf_tool = getToolByName(self, 'portal_workflow')
-    if IPlacefulMarker.providedBy(wf_tool):
-        noLongerProvides(wf_tool, IPlacefulMarker)
-
-    return out.getvalue()
diff --git a/Products/CMFPlacefulWorkflow/profiles.zcml b/Products/CMFPlacefulWorkflow/profiles.zcml
index 68a1a6f..034b622 100644
--- a/Products/CMFPlacefulWorkflow/profiles.zcml
+++ b/Products/CMFPlacefulWorkflow/profiles.zcml
@@ -20,6 +20,14 @@
      post_handler="Products.CMFPlacefulWorkflow.setuphandlers.installMarker"
      />
 
+  <genericsetup:registerProfile
+     name="uninstall"
+     title="Workflow Policy Support (CMFPlacefulWorkflow) [uninstall]"
+     directory="profiles/uninstall"
+     provides="Products.GenericSetup.interfaces.EXTENSION"
+     pre_handler="Products.CMFPlacefulWorkflow.setuphandlers.uninstall"
+     />
+
   <genericsetup:upgradeStep
     title="Apply full profile"
     description="Meant mostly for upgrades from ancient versions that had no profile yet."
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/componentregistry.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/componentregistry.xml
new file mode 100644
index 0000000..b1ab8bd
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/componentregistry.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0"?>
+<componentregistry>
+  <adapters/>
+  <utilities>
+    <utility
+        remove="true"
+        interface="Products.CMFPlacefulWorkflow.interfaces.IPlacefulWorkflowTool"
+        object="portal_placeful_workflow"/>
+  </utilities>
+</componentregistry>
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/controlpanel.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/controlpanel.xml
new file mode 100644
index 0000000..5265b5c
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/controlpanel.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<object name="portal_controlpanel">
+  <configlet action_id="placefulworkflow" remove="true" />
+</object>
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/metadata.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/metadata.xml
new file mode 100644
index 0000000..8590785
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/metadata.xml
@@ -0,0 +1,3 @@
+<metadata>
+  <version>1000</version>
+</metadata>
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/skins.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/skins.xml
new file mode 100644
index 0000000..25e2d3b
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/skins.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0"?>
+<object name="portal_skins">
+
+  <object name="CMFPlacefulWorkflow" remove="true" />
+
+  <skin-path name="*">
+    <layer name="CMFPlacefulWorkflow" remove="true" />
+  </skin-path>
+
+</object>
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/toolset.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/toolset.xml
new file mode 100644
index 0000000..33b3b89
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/toolset.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<tool-setup>
+  <forbidden tool_id="portal_placeful_workflow" />
+</tool-setup>
diff --git a/Products/CMFPlacefulWorkflow/setuphandlers.py b/Products/CMFPlacefulWorkflow/setuphandlers.py
index 655d0dc..ace0261 100644
--- a/Products/CMFPlacefulWorkflow/setuphandlers.py
+++ b/Products/CMFPlacefulWorkflow/setuphandlers.py
@@ -16,8 +16,18 @@
 # Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
 from Products.CMFCore.utils import getToolByName
+from Products.CMFPlacefulWorkflow.global_symbols import \
+    placeful_prefs_configlet
 from Products.CMFPlacefulWorkflow.interfaces import IPlacefulMarker
+from Products.CMFPlacefulWorkflow.interfaces import IPlacefulWorkflowTool
+from zope.component import getSiteManager
 from zope.interface import alsoProvides
+from zope.interface import noLongerProvides
+
+import logging
+
+
+logger = logging.getLogger('Products.CMFPlacefulWorkflow')
 
 
 def installMarker(context):
@@ -28,3 +38,36 @@ def installMarker(context):
     wf = getToolByName(context, 'portal_workflow', None)
     if wf is not None:
         alsoProvides(wf, IPlacefulMarker)
+        logger.info('Added placeful marker to portal_workflow.')
+
+
+def uninstall(context):
+    # Note: this function is registered as a pre_handler instead of a
+    # post_handler, because otherwise toolset.xml has already been applied,
+    # which removes the portal_placeful_workflow tool.
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    tool = getattr(portal, 'portal_placeful_workflow', None)
+    if tool is not None:
+        getSiteManager(portal).unregisterUtility(
+            tool,
+            IPlacefulWorkflowTool)
+        logger.info('Unregistered portal_placeful_workflow')
+    # uninstall configlets
+    try:
+        cptool = getToolByName(portal, 'portal_controlpanel')
+        cptool.unregisterConfiglet(placeful_prefs_configlet['id'])
+        logger.info('Removing CMFPlacefulWorkflow Configlet')
+    except:
+        logger.info('Failed to remove CMFPlacefulWorkflow Configlet')
+
+    wf_tool = getToolByName(portal, 'portal_workflow')
+    if IPlacefulMarker.providedBy(wf_tool):
+        noLongerProvides(wf_tool, IPlacefulMarker)
+        logger.info('Removed placeful marker from portal_workflow.')
+    # Mark our base profile as uninstalled, because:
+    # 1. It is good practice.
+    # 2. Otherwise when the user installs CMFPlacefulWorkflow again,
+    #    portal_setup will not apply our base profile.
+    portal_setup = getToolByName(portal, 'portal_setup')
+    portal_setup.unsetLastVersionForProfile(
+        'Products.CMFPlacefulWorkflow:base')
diff --git a/setup.py b/setup.py
index f56e3ef..4e05796 100644
--- a/setup.py
+++ b/setup.py
@@ -34,6 +34,6 @@
           'zope.i18nmessageid',
           'Products.CMFCore',
           'Products.CMFPlone',
-          'Products.GenericSetup>=1.8.2',
+          'Products.GenericSetup>=1.8.3',
       ],
       )


Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2016-05-23T12:33:02+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/fb54a2b4cee49cf7f93bd176c12ea7e95b35a3bd

Fixed installation tests.

They are now ready for using get_installer from CMFPlone (plip 1340).
And they still work with the current quick installer.

Removed special handling for older GenericSetup, because current Plone
5 has a recent enough version, and we require 1.8.3 anyway for the new
pre_handler in our install profile and removing the
portal_placeful_workflow tool in toolset.xml.  Also, reapplying the
dependencies is no longer needed, possibly because of we started using
an uninstall profile.

Files changed:
M Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py

diff --git a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
index f08688b..d70201d 100644
--- a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
+++ b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
@@ -41,9 +41,28 @@ def createMember(self, id, pw, email, roles=('Member', )):
                 'username': id, 'email': email})
         return member
 
-    def installation(self, productName):
-        self.qi = self.portal.portal_quickinstaller
-        self.qi.installProduct(productName)
+    def installation(self, productName, uninstall=False, reinstall=False):
+        assert not (uninstall and reinstall)
+        try:
+            from Products.CMFPlone.utils import get_installer
+        except ImportError:
+            # Plone 5.0
+            self.qi = self.portal.portal_quickinstaller
+            if uninstall:
+                self.qi.uninstallProducts([productName])
+            elif reinstall:
+                self.qi.installProduct(productName, reinstall=True)
+            else:
+                self.qi.installProduct(productName)
+        else:
+            self.qi = get_installer(self.portal)
+            if uninstall:
+                self.qi.uninstall_product(productName)
+            elif reinstall:
+                self.qi.uninstall_product(productName)
+                self.qi.install_product(productName)
+            else:
+                self.qi.install_product(productName)
 
     def setupSecurityContext(self, ):
         self.logout()
@@ -89,40 +108,20 @@ def test_marker_applied_and_unapplied(self):
         Check that the IPlacefulMarker is applied to the workflow tool by
         the install, and removed by the uninstall.
         """
-        try:
-            # GenericSetup 1.7.8 and higher
-            from Products.GenericSetup.tool import DEPENDENCY_STRATEGY_REAPPLY
-            DEPENDENCY_STRATEGY_REAPPLY  # pyflakes
-        except ImportError:
-            DEPENDENCY_STRATEGY_REAPPLY = None
-
         self.failUnless(IPlacefulMarker.providedBy(self.workflow))
         self.loginAsPortalOwner()
-        self.qi.uninstallProducts(['CMFPlacefulWorkflow'])
+        self.installation('CMFPlacefulWorkflow', uninstall=True)
         self.failIf(IPlacefulMarker.providedBy(self.workflow))
 
-        profile_id = 'Products.CMFPlacefulWorkflow:CMFPlacefulWorkflow'
-        if DEPENDENCY_STRATEGY_REAPPLY is None:
-            # Older GenericSetup.  Reapply is the default.  No alternative
-            # strategy can be given.
-            self.qi.installProduct('CMFPlacefulWorkflow')
-            # setup_tool.runAllImportStepsFromProfile('profile-%s' % profile_id)
-        else:
-            # Newer GenericSetup.  Upgrade is the default.  We want to
-            # reapply.
-            setup_tool = self.portal.portal_setup
-            setup_tool.runAllImportStepsFromProfile(
-                'profile-%s' % profile_id,
-                dependency_strategy=DEPENDENCY_STRATEGY_REAPPLY)
-
+        self.installation('CMFPlacefulWorkflow')
         self.failUnless(IPlacefulMarker.providedBy(self.workflow))
 
     def test_reinstall(self):
         """
         Test if upgrade is going the good way
         """
-        self.qi = self.portal.portal_quickinstaller
-        self.qi.installProduct('CMFPlacefulWorkflow', reinstall=True)
+        self.installation('CMFPlacefulWorkflow', reinstall=True)
+        self.assertTrue('portal_placeful_workflow' in self.portal.objectIds())
 
     def test_prefs_workflow_policy_mapping_set_PostOnly(self):
         """


Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/master
Date: 2016-05-23T14:42:12+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/34fe86c1ae0102c772b1033d7a7c6f42f08e0662

Merge pull request #9 from plone/uninstall-profile

Uninstall profile

Files changed:
A Products/CMFPlacefulWorkflow/profiles/uninstall/componentregistry.xml
A Products/CMFPlacefulWorkflow/profiles/uninstall/controlpanel.xml
A Products/CMFPlacefulWorkflow/profiles/uninstall/metadata.xml
A Products/CMFPlacefulWorkflow/profiles/uninstall/skins.xml
A Products/CMFPlacefulWorkflow/profiles/uninstall/toolset.xml
M CHANGES.rst
M Products/CMFPlacefulWorkflow/exportimport.zcml
M Products/CMFPlacefulWorkflow/profiles.zcml
M Products/CMFPlacefulWorkflow/setuphandlers.py
M Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
M setup.py
D Products/CMFPlacefulWorkflow/Extensions/Install.py
D Products/CMFPlacefulWorkflow/profiles/base/actionicons.xml
D Products/CMFPlacefulWorkflow/profiles/base/placeful_marker.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index 380fd39..a5ab5a4 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,7 +6,11 @@ Changelog
 
 New:
 
-- *add item here*
+- Added ``uninstall`` profile instead of old external method.  [maurits]
+
+- Removed ``actionicons.xml`` because this is handled in ``controlpanel.xml``.  [maurits]
+
+- Replaced ``placeful_marker`` import step with a ``post_handler``.  [maurits]
 
 Fixes:
 
diff --git a/Products/CMFPlacefulWorkflow/Extensions/Install.py b/Products/CMFPlacefulWorkflow/Extensions/Install.py
deleted file mode 100644
index d7ef285..0000000
--- a/Products/CMFPlacefulWorkflow/Extensions/Install.py
+++ /dev/null
@@ -1,49 +0,0 @@
-# -*- coding: utf-8 -*-
-# CMFPlacefulWorkflow
-# Copyright (C)2005 Ingeniweb
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or
-# (at your option) any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; see the file COPYING. If not, write to the
-# Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-"""
-Product installation
-"""
-
-from Products.CMFCore.utils import getToolByName
-from Products.CMFPlacefulWorkflow.global_symbols import placeful_prefs_configlet
-from Products.CMFPlacefulWorkflow.interfaces import IPlacefulMarker
-from Products.CMFPlacefulWorkflow.interfaces import IPlacefulWorkflowTool
-from cStringIO import StringIO
-from zope.component import getSiteManager
-from zope.interface import noLongerProvides
-
-
-def uninstall(self, reinstall=False, out=None):
-    if out is None:
-        out = StringIO()
-
-    getSiteManager(self).unregisterUtility(self['portal_placeful_workflow'],
-                                           IPlacefulWorkflowTool)
-    # uninstall configlets
-    try:
-        cptool = getToolByName(self, 'portal_controlpanel')
-        cptool.unregisterConfiglet(placeful_prefs_configlet['id'])
-        out.write('Removing CMFPlacefulWorkflow Configlet')
-    except:
-        out.write('Failed to remove CMFPlacefulWorkflow Configlet')
-
-    wf_tool = getToolByName(self, 'portal_workflow')
-    if IPlacefulMarker.providedBy(wf_tool):
-        noLongerProvides(wf_tool, IPlacefulMarker)
-
-    return out.getvalue()
diff --git a/Products/CMFPlacefulWorkflow/exportimport.zcml b/Products/CMFPlacefulWorkflow/exportimport.zcml
index b99b40b..14faf39 100644
--- a/Products/CMFPlacefulWorkflow/exportimport.zcml
+++ b/Products/CMFPlacefulWorkflow/exportimport.zcml
@@ -41,12 +41,4 @@
      handler="Products.CMFPlacefulWorkflow.exportimport.exportWorkflowPolicies"
      />
 
-  <genericsetup:importStep
-     name="placeful_marker"
-     title="Placeful Workflow Tool Marker Interface"
-     description="Add placeful marker to default workflow tool"
-     handler="Products.CMFPlacefulWorkflow.setuphandlers.installMarker">
-    <depends name="workflow"/>
-  </genericsetup:importStep>
-
 </configure>
diff --git a/Products/CMFPlacefulWorkflow/profiles.zcml b/Products/CMFPlacefulWorkflow/profiles.zcml
index eaacc52..034b622 100644
--- a/Products/CMFPlacefulWorkflow/profiles.zcml
+++ b/Products/CMFPlacefulWorkflow/profiles.zcml
@@ -17,6 +17,15 @@
      directory="profiles/base"
      description="Add in Plone the capability to change workflow chains for types in every object. With no dependency on core Plone types."
      provides="Products.GenericSetup.interfaces.EXTENSION"
+     post_handler="Products.CMFPlacefulWorkflow.setuphandlers.installMarker"
+     />
+
+  <genericsetup:registerProfile
+     name="uninstall"
+     title="Workflow Policy Support (CMFPlacefulWorkflow) [uninstall]"
+     directory="profiles/uninstall"
+     provides="Products.GenericSetup.interfaces.EXTENSION"
+     pre_handler="Products.CMFPlacefulWorkflow.setuphandlers.uninstall"
      />
 
   <genericsetup:upgradeStep
diff --git a/Products/CMFPlacefulWorkflow/profiles/base/actionicons.xml b/Products/CMFPlacefulWorkflow/profiles/base/actionicons.xml
deleted file mode 100644
index 7b43e7e..0000000
--- a/Products/CMFPlacefulWorkflow/profiles/base/actionicons.xml
+++ /dev/null
@@ -1,13 +0,0 @@
-<?xml version="1.0"?>
-<action-icons
-	xmlns:i18n="http://xml.zope.org/namespaces/i18n"
-    i18n:domain="plone">
-<action-icon
-	category="controlpanel"
-    action_id="placefulworkflow"
-    title="Placeful Workflow"
-    priority="0"
-    icon_expr="placefulworkflow_icon.png"
-    i18n:attributes="title"
-/>
-</action-icons>
diff --git a/Products/CMFPlacefulWorkflow/profiles/base/placeful_marker.txt b/Products/CMFPlacefulWorkflow/profiles/base/placeful_marker.txt
deleted file mode 100644
index 792d600..0000000
--- a/Products/CMFPlacefulWorkflow/profiles/base/placeful_marker.txt
+++ /dev/null
@@ -1 +0,0 @@
-#
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/componentregistry.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/componentregistry.xml
new file mode 100644
index 0000000..b1ab8bd
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/componentregistry.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0"?>
+<componentregistry>
+  <adapters/>
+  <utilities>
+    <utility
+        remove="true"
+        interface="Products.CMFPlacefulWorkflow.interfaces.IPlacefulWorkflowTool"
+        object="portal_placeful_workflow"/>
+  </utilities>
+</componentregistry>
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/controlpanel.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/controlpanel.xml
new file mode 100644
index 0000000..5265b5c
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/controlpanel.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<object name="portal_controlpanel">
+  <configlet action_id="placefulworkflow" remove="true" />
+</object>
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/metadata.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/metadata.xml
new file mode 100644
index 0000000..8590785
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/metadata.xml
@@ -0,0 +1,3 @@
+<metadata>
+  <version>1000</version>
+</metadata>
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/skins.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/skins.xml
new file mode 100644
index 0000000..25e2d3b
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/skins.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0"?>
+<object name="portal_skins">
+
+  <object name="CMFPlacefulWorkflow" remove="true" />
+
+  <skin-path name="*">
+    <layer name="CMFPlacefulWorkflow" remove="true" />
+  </skin-path>
+
+</object>
diff --git a/Products/CMFPlacefulWorkflow/profiles/uninstall/toolset.xml b/Products/CMFPlacefulWorkflow/profiles/uninstall/toolset.xml
new file mode 100644
index 0000000..33b3b89
--- /dev/null
+++ b/Products/CMFPlacefulWorkflow/profiles/uninstall/toolset.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<tool-setup>
+  <forbidden tool_id="portal_placeful_workflow" />
+</tool-setup>
diff --git a/Products/CMFPlacefulWorkflow/setuphandlers.py b/Products/CMFPlacefulWorkflow/setuphandlers.py
index 47eadf5..ace0261 100644
--- a/Products/CMFPlacefulWorkflow/setuphandlers.py
+++ b/Products/CMFPlacefulWorkflow/setuphandlers.py
@@ -16,8 +16,18 @@
 # Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
 from Products.CMFCore.utils import getToolByName
+from Products.CMFPlacefulWorkflow.global_symbols import \
+    placeful_prefs_configlet
 from Products.CMFPlacefulWorkflow.interfaces import IPlacefulMarker
+from Products.CMFPlacefulWorkflow.interfaces import IPlacefulWorkflowTool
+from zope.component import getSiteManager
 from zope.interface import alsoProvides
+from zope.interface import noLongerProvides
+
+import logging
+
+
+logger = logging.getLogger('Products.CMFPlacefulWorkflow')
 
 
 def installMarker(context):
@@ -25,10 +35,39 @@ def installMarker(context):
     Apply a marker interface to the workflow tool to indicate that the
     product is installed.
     """
-    # Only run step if a flag file is present (e.g. not an extension profile)
-    if context.readDataFile('placeful_marker.txt') is None:
-        return
-    site = context.getSite()
-    wf = getToolByName(site, 'portal_workflow', None)
+    wf = getToolByName(context, 'portal_workflow', None)
     if wf is not None:
         alsoProvides(wf, IPlacefulMarker)
+        logger.info('Added placeful marker to portal_workflow.')
+
+
+def uninstall(context):
+    # Note: this function is registered as a pre_handler instead of a
+    # post_handler, because otherwise toolset.xml has already been applied,
+    # which removes the portal_placeful_workflow tool.
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    tool = getattr(portal, 'portal_placeful_workflow', None)
+    if tool is not None:
+        getSiteManager(portal).unregisterUtility(
+            tool,
+            IPlacefulWorkflowTool)
+        logger.info('Unregistered portal_placeful_workflow')
+    # uninstall configlets
+    try:
+        cptool = getToolByName(portal, 'portal_controlpanel')
+        cptool.unregisterConfiglet(placeful_prefs_configlet['id'])
+        logger.info('Removing CMFPlacefulWorkflow Configlet')
+    except:
+        logger.info('Failed to remove CMFPlacefulWorkflow Configlet')
+
+    wf_tool = getToolByName(portal, 'portal_workflow')
+    if IPlacefulMarker.providedBy(wf_tool):
+        noLongerProvides(wf_tool, IPlacefulMarker)
+        logger.info('Removed placeful marker from portal_workflow.')
+    # Mark our base profile as uninstalled, because:
+    # 1. It is good practice.
+    # 2. Otherwise when the user installs CMFPlacefulWorkflow again,
+    #    portal_setup will not apply our base profile.
+    portal_setup = getToolByName(portal, 'portal_setup')
+    portal_setup.unsetLastVersionForProfile(
+        'Products.CMFPlacefulWorkflow:base')
diff --git a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
index f08688b..d70201d 100644
--- a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
+++ b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
@@ -41,9 +41,28 @@ def createMember(self, id, pw, email, roles=('Member', )):
                 'username': id, 'email': email})
         return member
 
-    def installation(self, productName):
-        self.qi = self.portal.portal_quickinstaller
-        self.qi.installProduct(productName)
+    def installation(self, productName, uninstall=False, reinstall=False):
+        assert not (uninstall and reinstall)
+        try:
+            from Products.CMFPlone.utils import get_installer
+        except ImportError:
+            # Plone 5.0
+            self.qi = self.portal.portal_quickinstaller
+            if uninstall:
+                self.qi.uninstallProducts([productName])
+            elif reinstall:
+                self.qi.installProduct(productName, reinstall=True)
+            else:
+                self.qi.installProduct(productName)
+        else:
+            self.qi = get_installer(self.portal)
+            if uninstall:
+                self.qi.uninstall_product(productName)
+            elif reinstall:
+                self.qi.uninstall_product(productName)
+                self.qi.install_product(productName)
+            else:
+                self.qi.install_product(productName)
 
     def setupSecurityContext(self, ):
         self.logout()
@@ -89,40 +108,20 @@ def test_marker_applied_and_unapplied(self):
         Check that the IPlacefulMarker is applied to the workflow tool by
         the install, and removed by the uninstall.
         """
-        try:
-            # GenericSetup 1.7.8 and higher
-            from Products.GenericSetup.tool import DEPENDENCY_STRATEGY_REAPPLY
-            DEPENDENCY_STRATEGY_REAPPLY  # pyflakes
-        except ImportError:
-            DEPENDENCY_STRATEGY_REAPPLY = None
-
         self.failUnless(IPlacefulMarker.providedBy(self.workflow))
         self.loginAsPortalOwner()
-        self.qi.uninstallProducts(['CMFPlacefulWorkflow'])
+        self.installation('CMFPlacefulWorkflow', uninstall=True)
         self.failIf(IPlacefulMarker.providedBy(self.workflow))
 
-        profile_id = 'Products.CMFPlacefulWorkflow:CMFPlacefulWorkflow'
-        if DEPENDENCY_STRATEGY_REAPPLY is None:
-            # Older GenericSetup.  Reapply is the default.  No alternative
-            # strategy can be given.
-            self.qi.installProduct('CMFPlacefulWorkflow')
-            # setup_tool.runAllImportStepsFromProfile('profile-%s' % profile_id)
-        else:
-            # Newer GenericSetup.  Upgrade is the default.  We want to
-            # reapply.
-            setup_tool = self.portal.portal_setup
-            setup_tool.runAllImportStepsFromProfile(
-                'profile-%s' % profile_id,
-                dependency_strategy=DEPENDENCY_STRATEGY_REAPPLY)
-
+        self.installation('CMFPlacefulWorkflow')
         self.failUnless(IPlacefulMarker.providedBy(self.workflow))
 
     def test_reinstall(self):
         """
         Test if upgrade is going the good way
         """
-        self.qi = self.portal.portal_quickinstaller
-        self.qi.installProduct('CMFPlacefulWorkflow', reinstall=True)
+        self.installation('CMFPlacefulWorkflow', reinstall=True)
+        self.assertTrue('portal_placeful_workflow' in self.portal.objectIds())
 
     def test_prefs_workflow_policy_mapping_set_PostOnly(self):
         """
diff --git a/setup.py b/setup.py
index a207a1e..4e05796 100644
--- a/setup.py
+++ b/setup.py
@@ -34,6 +34,6 @@
           'zope.i18nmessageid',
           'Products.CMFCore',
           'Products.CMFPlone',
-          'Products.GenericSetup',
+          'Products.GenericSetup>=1.8.3',
       ],
       )


