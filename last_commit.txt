Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-10T09:37:49-07:00
Author: Rob Gietema (robgietema) <rob.gietema@gmail.com>
Commit: https://github.com/plone/plone.volto/commit/cd33cfc96dad66522fc13daf42b9fbd512afc670

Added preview image link.

Files changed:
A news/49.feature
A src/plone/volto/behaviors/preview_link.py
M CHANGES.rst
M src/plone/volto/behaviors/configure.zcml
M src/plone/volto/indexers.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex dd1d10f..04ac0b6 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -80,6 +80,7 @@ Bug fixes:\n - Fix deprecated import of isDefaultPage\n   [pbauer]\n \n+\n 4.0.0a3 (2022-02-04)\n --------------------\n \ndiff --git a/news/49.feature b/news/49.feature\nnew file mode 100644\nindex 0000000..85dcced\n--- /dev/null\n+++ b/news/49.feature\n@@ -0,0 +1,2 @@\n+- Added preview image link behavior\n+  [robgietema]\ndiff --git a/src/plone/volto/behaviors/configure.zcml b/src/plone/volto/behaviors/configure.zcml\nindex ab5df7b..a988095 100644\n--- a/src/plone/volto/behaviors/configure.zcml\n+++ b/src/plone/volto/behaviors/configure.zcml\n@@ -16,6 +16,13 @@\n       provides=".preview.IPreview"\n       />\n \n+  <plone:behavior\n+      name="volto.preview_image_link"\n+      title="Preview Image Link"\n+      description="Preview image for listings based on links"\n+      provides=".preview_link.IPreviewLink"\n+      />\n+\n   <plone:behavior\n       name="volto.navtitle"\n       title="Navigation title"\ndiff --git a/src/plone/volto/behaviors/preview_link.py b/src/plone/volto/behaviors/preview_link.py\nnew file mode 100644\nindex 0000000..237e6e5\n--- /dev/null\n+++ b/src/plone/volto/behaviors/preview_link.py\n@@ -0,0 +1,38 @@\n+# -*- coding: utf-8 -*-\n+from plone.volto import _\n+from plone.autoform.interfaces import IFormFieldProvider\n+from plone.autoform import directives\n+from plone.supermodel import model\n+from zope.interface import provider\n+from zope.schema import TextLine\n+from z3c.relationfield.schema import RelationChoice\n+from plone.app.z3cform.widget import RelatedItemsFieldWidget\n+\n+\n+@provider(IFormFieldProvider)\n+class IPreviewLink(model.Schema):\n+\n+    preview_image_link = RelationChoice(\n+        title=_("label_previewimage", default="Preview image"),\n+        description=_(\n+            "help_previewimage",\n+            default="Insert an image that will be used in listing and teaser blocks.",\n+        ),\n+        vocabulary=\'plone.app.vocabularies.Catalog\',\n+        required=False,\n+    )\n+\n+    directives.widget(\n+        \'preview_image_link\',\n+        RelatedItemsFieldWidget,\n+        pattern_options={\n+            \'selectableTypes\': [\'Image\'],\n+        },\n+        frontendOptions={\n+          "widgetProps": {"return": "single"},\n+        },\n+    )\n+\n+    preview_caption_link = TextLine(\n+        title=_("Preview image caption"), description="", required=False\n+    )\ndiff --git a/src/plone/volto/indexers.py b/src/plone/volto/indexers.py\nindex f7f2455..9ecd181 100644\n--- a/src/plone/volto/indexers.py\n+++ b/src/plone/volto/indexers.py\n@@ -10,7 +10,7 @@ def hasPreviewImage(obj):\n     Indexer for knowing in a catalog search if a content with the IPreview behavior has\n     a preview_image\n     """\n-    if obj.aq_base.preview_image:\n+    if obj.aq_base.preview_image or obj.aq_base.preview_image_link:\n         return True\n     return False\n \n@@ -23,6 +23,8 @@ def image_field_indexer(obj):\n     image_field = ""\n     if getattr(base_obj, "preview_image", False):\n         image_field = "preview_image"\n+    elif getattr(base_obj, "preview_image_link", False):\n+        image_field = "preview_image_link"\n     elif getattr(base_obj, "image", False):\n         image_field = "image"\n     return image_field\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-10T09:37:54-07:00
Author: Rob Gietema (robgietema) <rob.gietema@gmail.com>
Commit: https://github.com/plone/plone.volto/commit/dc9a0eefd79f3418fc67548ad66defff64fc7286

Fix black errors.

Files changed:
M src/plone/volto/behaviors/preview_link.py

b'diff --git a/src/plone/volto/behaviors/preview_link.py b/src/plone/volto/behaviors/preview_link.py\nindex 237e6e5..ca143ba 100644\n--- a/src/plone/volto/behaviors/preview_link.py\n+++ b/src/plone/volto/behaviors/preview_link.py\n@@ -18,18 +18,18 @@ class IPreviewLink(model.Schema):\n             "help_previewimage",\n             default="Insert an image that will be used in listing and teaser blocks.",\n         ),\n-        vocabulary=\'plone.app.vocabularies.Catalog\',\n+        vocabulary="plone.app.vocabularies.Catalog",\n         required=False,\n     )\n \n     directives.widget(\n-        \'preview_image_link\',\n+        "preview_image_link",\n         RelatedItemsFieldWidget,\n         pattern_options={\n-            \'selectableTypes\': [\'Image\'],\n+            "selectableTypes": ["Image"],\n         },\n         frontendOptions={\n-          "widgetProps": {"return": "single"},\n+            "widgetProps": {"return": "single"},\n         },\n     )\n \n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-10T09:37:54-07:00
Author: Rob Gietema (robgietema) <rob.gietema@gmail.com>
Commit: https://github.com/plone/plone.volto/commit/18a6d29aff9b307d1522f5609c2185a4e5541911

Fix frontendOptions.

Files changed:
M src/plone/volto/behaviors/preview_link.py

b'diff --git a/src/plone/volto/behaviors/preview_link.py b/src/plone/volto/behaviors/preview_link.py\nindex ca143ba..a944e97 100644\n--- a/src/plone/volto/behaviors/preview_link.py\n+++ b/src/plone/volto/behaviors/preview_link.py\n@@ -25,11 +25,9 @@ class IPreviewLink(model.Schema):\n     directives.widget(\n         "preview_image_link",\n         RelatedItemsFieldWidget,\n-        pattern_options={\n-            "selectableTypes": ["Image"],\n-        },\n         frontendOptions={\n-            "widgetProps": {"return": "single"},\n+            "widget": "object_browser",\n+            "widgetProps": {"mode": "image", "return": "single"},\n         },\n     )\n \n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-10T15:17:52-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/c32f054e935051aaf7302fb43e43b201aa985525

Include preview_image_link scales in image_scales catalog metadata

Files changed:
M src/plone/volto/behaviors/configure.zcml
M src/plone/volto/behaviors/preview_link.py

b'diff --git a/src/plone/volto/behaviors/configure.zcml b/src/plone/volto/behaviors/configure.zcml\nindex a988095..ee1eb47 100644\n--- a/src/plone/volto/behaviors/configure.zcml\n+++ b/src/plone/volto/behaviors/configure.zcml\n@@ -37,4 +37,6 @@\n       provides=".headtitle.IHeadTitle"\n       />\n \n+  <adapter factory=".preview_link.PreviewImageScalesFieldAdapter" />\n+\n </configure>\ndiff --git a/src/plone/volto/behaviors/preview_link.py b/src/plone/volto/behaviors/preview_link.py\nindex a944e97..0979bc8 100644\n--- a/src/plone/volto/behaviors/preview_link.py\n+++ b/src/plone/volto/behaviors/preview_link.py\n@@ -1,12 +1,20 @@\n # -*- coding: utf-8 -*-\n-from plone.volto import _\n-from plone.autoform.interfaces import IFormFieldProvider\n+from plone import api\n+from plone.app.z3cform.widget import RelatedItemsFieldWidget\n from plone.autoform import directives\n+from plone.autoform.interfaces import IFormFieldProvider\n+from plone.base.interfaces import IImageScalesFieldAdapter\n+from plone.rfc822.interfaces import IPrimaryFieldInfo\n from plone.supermodel import model\n+from plone.volto import _\n+from z3c.form.util import getSpecification\n+from z3c.relationfield.schema import RelationChoice\n+from zope.component import adapter\n+from zope.component import queryMultiAdapter\n+from zope.interface import Interface\n+from zope.interface import implementer\n from zope.interface import provider\n from zope.schema import TextLine\n-from z3c.relationfield.schema import RelationChoice\n-from plone.app.z3cform.widget import RelatedItemsFieldWidget\n \n \n @provider(IFormFieldProvider)\n@@ -34,3 +42,30 @@ class IPreviewLink(model.Schema):\n     preview_caption_link = TextLine(\n         title=_("Preview image caption"), description="", required=False\n     )\n+\n+\n+@adapter(getSpecification(IPreviewLink["preview_image_link"]), Interface, Interface)\n+@implementer(IImageScalesFieldAdapter)\n+class PreviewImageScalesFieldAdapter:\n+    """Get the image_scales for the preview_image_link field"""\n+\n+    def __init__(self, field, context, request):\n+        self.field = field\n+        self.context = context\n+        self.request = request\n+\n+    def __call__(self):\n+        value = self.field.get(self.context)\n+        linked_image = value.to_object\n+        primary_field = IPrimaryFieldInfo(linked_image).field\n+        serializer = queryMultiAdapter(\n+            (primary_field, linked_image, self.request), IImageScalesFieldAdapter\n+        )\n+        if serializer is not None:\n+            values = serializer()\n+            if values:\n+                portal_url = api.portal.get().absolute_url()\n+                base_path = linked_image.absolute_url().replace(portal_url, "")\n+                for value in values:\n+                    value["base_path"] = base_path\n+            return values\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-10T15:19:16-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/732334edc78b70b78a5e52090b669249ffae1f18

Index preview_image_link scales in the same format as image field scales

Files changed:
M src/plone/volto/behaviors/preview_link.py

b'diff --git a/src/plone/volto/behaviors/preview_link.py b/src/plone/volto/behaviors/preview_link.py\nindex 0979bc8..b7cdb41 100644\n--- a/src/plone/volto/behaviors/preview_link.py\n+++ b/src/plone/volto/behaviors/preview_link.py\n@@ -11,8 +11,8 @@\n from z3c.relationfield.schema import RelationChoice\n from zope.component import adapter\n from zope.component import queryMultiAdapter\n-from zope.interface import Interface\n from zope.interface import implementer\n+from zope.interface import Interface\n from zope.interface import provider\n from zope.schema import TextLine\n \n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-11T16:53:55-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/87993ca2b98ba94cddcf83b535e4679414e5a2a8

Only register preview_image_link behavior for Plone 6

Files changed:
M Makefile
M news/49.feature
M src/plone/volto/behaviors/configure.zcml
M src/plone/volto/behaviors/preview_link.py

b'diff --git a/Makefile b/Makefile\nindex c63afec..08f7130 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -75,6 +75,7 @@ black: bin/black ## Format codebase\n isort: bin/isort ## Format imports in the codebase\n \tbin/isort $(CHECK_PATH)\n \n+.PHONY: zpretty\n zpretty: bin/zpretty ## Format xml and zcml with zpretty\n \tfind "${PACKAGE_PATH}" -name \'*.xml\' | xargs bin/zpretty -x -i\n \tfind "${PACKAGE_PATH}" -name \'*.zcml\' | xargs bin/zpretty -z -i\ndiff --git a/news/49.feature b/news/49.feature\nindex 85dcced..7b64966 100644\n--- a/news/49.feature\n+++ b/news/49.feature\n@@ -1,2 +1,2 @@\n-- Added preview image link behavior\n+- Added preview image link behavior (Plone 6+ only)\n   [robgietema]\ndiff --git a/src/plone/volto/behaviors/configure.zcml b/src/plone/volto/behaviors/configure.zcml\nindex ee1eb47..52bc146 100644\n--- a/src/plone/volto/behaviors/configure.zcml\n+++ b/src/plone/volto/behaviors/configure.zcml\n@@ -1,6 +1,7 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:plone="http://namespaces.plone.org/plone"\n+    xmlns:zcml="http://namespaces.zope.org/zcml"\n     i18n_domain="plone.volto"\n     >\n \n@@ -16,12 +17,15 @@\n       provides=".preview.IPreview"\n       />\n \n-  <plone:behavior\n-      name="volto.preview_image_link"\n-      title="Preview Image Link"\n-      description="Preview image for listings based on links"\n-      provides=".preview_link.IPreviewLink"\n-      />\n+  <configure zcml:condition="have plone-6">\n+    <plone:behavior\n+        name="volto.preview_image_link"\n+        title="Preview Image Link"\n+        description="Preview image for listings based on links"\n+        provides=".preview_link.IPreviewLink"\n+        />\n+    <adapter factory=".preview_link.PreviewImageScalesFieldAdapter" />\n+  </configure>\n \n   <plone:behavior\n       name="volto.navtitle"\n@@ -37,6 +41,4 @@\n       provides=".headtitle.IHeadTitle"\n       />\n \n-  <adapter factory=".preview_link.PreviewImageScalesFieldAdapter" />\n-\n </configure>\ndiff --git a/src/plone/volto/behaviors/preview_link.py b/src/plone/volto/behaviors/preview_link.py\nindex b7cdb41..838088f 100644\n--- a/src/plone/volto/behaviors/preview_link.py\n+++ b/src/plone/volto/behaviors/preview_link.py\n@@ -24,7 +24,7 @@ class IPreviewLink(model.Schema):\n         title=_("label_previewimage", default="Preview image"),\n         description=_(\n             "help_previewimage",\n-            default="Insert an image that will be used in listing and teaser blocks.",\n+            default="Select an image that will be used in listing and teaser blocks.",\n         ),\n         vocabulary="plone.app.vocabularies.Catalog",\n         required=False,\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-11T18:06:18-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/8f7d5e77eba5048ebbb5cb17120acaaf22156535

add test for preview_image_link in image_scales

Files changed:
A src/plone/volto/tests/test_preview_link_behavior.py
M src/plone/volto/behaviors/configure.zcml
M src/plone/volto/testing.py
M src/plone/volto/tests/test_migrate_to_volto.py

b'diff --git a/src/plone/volto/behaviors/configure.zcml b/src/plone/volto/behaviors/configure.zcml\nindex 52bc146..47f096e 100644\n--- a/src/plone/volto/behaviors/configure.zcml\n+++ b/src/plone/volto/behaviors/configure.zcml\n@@ -17,7 +17,7 @@\n       provides=".preview.IPreview"\n       />\n \n-  <configure zcml:condition="have plone-6">\n+  <configure zcml:condition="have plone-60">\n     <plone:behavior\n         name="volto.preview_image_link"\n         title="Preview Image Link"\ndiff --git a/src/plone/volto/testing.py b/src/plone/volto/testing.py\nindex 1e39aa6..adb5cc3 100644\n--- a/src/plone/volto/testing.py\n+++ b/src/plone/volto/testing.py\n@@ -17,6 +17,16 @@\n import plone.volto.coresandbox\n \n \n+try:\n+    from Products.CMFPlone.factory import PLONE60MARKER\n+\n+    PLONE60MARKER  # pyflakes\n+except ImportError:\n+    PLONE_6 = False\n+else:\n+    PLONE_6 = True\n+\n+\n class PloneVoltoCoreLayer(PloneSandboxLayer):\n \n     defaultBases = (PLONE_APP_CONTENTTYPES_FIXTURE,)\ndiff --git a/src/plone/volto/tests/test_migrate_to_volto.py b/src/plone/volto/tests/test_migrate_to_volto.py\nindex 259d860..56d3361 100644\n--- a/src/plone/volto/tests/test_migrate_to_volto.py\n+++ b/src/plone/volto/tests/test_migrate_to_volto.py\n@@ -6,6 +6,7 @@\n from plone.volto.content import FolderishDocument\n from plone.volto.content import FolderishEvent\n from plone.volto.content import FolderishNewsItem\n+from plone.volto.testing import PLONE_6\n from plone.volto.testing import PLONE_VOLTO_MIGRATION_FUNCTIONAL_TESTING\n from Products.CMFPlone.utils import get_installer\n \n@@ -14,16 +15,6 @@\n import unittest\n \n \n-try:\n-    from Products.CMFPlone.factory import PLONE60MARKER\n-\n-    PLONE60MARKER  # pyflakes\n-except ImportError:\n-    PLONE_6 = False\n-else:\n-    PLONE_6 = True\n-\n-\n @unittest.skipIf(\n     not PLONE_6,\n     "This test is only intended to run for Plone 6",\ndiff --git a/src/plone/volto/tests/test_preview_link_behavior.py b/src/plone/volto/tests/test_preview_link_behavior.py\nnew file mode 100644\nindex 0000000..0f6313f\n--- /dev/null\n+++ b/src/plone/volto/tests/test_preview_link_behavior.py\n@@ -0,0 +1,50 @@\n+# -*- coding: utf-8 -*-\n+\n+from plone.namedfile.file import NamedBlobImage\n+from plone.restapi.interfaces import ISerializeToJsonSummary\n+from plone.volto.testing import PLONE_6\n+from plone.volto.testing import PLONE_VOLTO_CORE_INTEGRATION_TESTING\n+from z3c.form.interfaces import IDataManager\n+from zope.component import getMultiAdapter\n+\n+import unittest\n+\n+\n+TEST_GIF = (\n+    b"GIF89a\\x01\\x00\\x01\\x00\\x00\\xff\\x00,\\x00\\x00\\x00\\x00\\x01\\x00\\x01\\x00\\x00\\x02\\x00;"\n+)\n+\n+\n+@unittest.skipIf(\n+    not PLONE_6,\n+    "This test is only intended to run for Plone 6",\n+)\n+class TestPreviewLinkBehavior(unittest.TestCase):\n+    layer = PLONE_VOLTO_CORE_INTEGRATION_TESTING\n+\n+    def setUp(self):\n+        from plone.volto.behaviors.preview_link import IPreviewLink\n+\n+        self.app = self.layer["app"]\n+        self.portal = self.layer["portal"]\n+        self.request = self.layer["request"]\n+        self.catalog = self.portal.portal_catalog\n+\n+        fti = self.portal.portal_types.Document\n+        fti.behaviors += ("volto.preview_image_link",)\n+\n+        self.doc = self.portal[self.portal.invokeFactory("Document", id="doc1")]\n+        self.image = self.portal[\n+            self.portal.invokeFactory("Image", id="image-1", title="Target image")\n+        ]\n+        self.image.image = NamedBlobImage(data=TEST_GIF, filename="test.gif")\n+        dm = getMultiAdapter(\n+            (self.doc, IPreviewLink["preview_image_link"]), IDataManager\n+        )\n+        dm.set(self.image)\n+        self.doc.reindexObject()\n+\n+    def test_image_scales_includes_preview_image_link(self):\n+        brain = self.catalog(UID=self.doc.UID())[0]\n+        summary = getMultiAdapter((brain, self.request), ISerializeToJsonSummary)()\n+        self.assertIn("preview_image_link", summary["image_scales"])\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-12T11:57:01-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/6af88e830c26e5cb3587a77098d0988d0390307c

docs

Files changed:
M README.rst

b'diff --git a/README.rst b/README.rst\nindex d043082..5930344 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -173,13 +173,13 @@ Plone). This will be fixed in core in upcoming sprints.\n Preview Image Behavior\n ----------------------\n \n-The preview image behavior makes content types provide a preview_image field that can store a preview image that Volto views can pick up.\n+The preview image behavior makes content types provide a ``preview_image`` field that can store a preview image that Volto views can pick up.\n This is especially userful for listings (e.g. listing block customizations) and teaser elements (e.g. teaser blocks such as [volto-blocks-grid](https://github.com/kitconcept/volto-blocks-grid)).\n \n-The "volto.preview_image behavior can be enabled in the generic setup XML definition of a content type (e.g. "/profiles/default/types/MyContentType.xml")::\n+The ``volto.preview_image`` behavior can be enabled in the generic setup XML definition of a content type (e.g. ``/profiles/default/types/MyContentType.xml``)::\n \n    <?xml version="1.0" encoding="UTF-8" ?>\n-   <object i18n:domain="fzj.internet" meta_type="Dexterity FTI" name="MyContentType"\n+   <object i18n:domain="my.project" meta_type="Dexterity FTI" name="MyContentType"\n      xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n \n      ...\n@@ -192,6 +192,8 @@ The "volto.preview_image behavior can be enabled in the generic setup XML defini\n      ...\n    </object>\n \n+There is also another variation of the preview image behavior called ``volto.preview_image_link``.\n+This one stores preview images using a relation to an Image content type, rather than in an image field. This might be preferable if many content items use the same preview image.\n \n Navigation Title Behavior\n -------------------------\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-08-12T11:59:28-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/431d036f92720f2018bf5374e95eb6339afa4a76

Merge pull request #49 from plone/preview-image-link

Added preview image link.

Files changed:
A news/49.feature
A src/plone/volto/behaviors/preview_link.py
A src/plone/volto/tests/test_preview_link_behavior.py
M CHANGES.rst
M Makefile
M README.rst
M src/plone/volto/behaviors/configure.zcml
M src/plone/volto/indexers.py
M src/plone/volto/testing.py
M src/plone/volto/tests/test_migrate_to_volto.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex dd0d3d4..d1f7092 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -80,6 +80,7 @@ Bug fixes:\n - Fix deprecated import of isDefaultPage\n   [pbauer]\n \n+\n 4.0.0a3 (2022-02-04)\n --------------------\n \ndiff --git a/Makefile b/Makefile\nindex c63afec..08f7130 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -75,6 +75,7 @@ black: bin/black ## Format codebase\n isort: bin/isort ## Format imports in the codebase\n \tbin/isort $(CHECK_PATH)\n \n+.PHONY: zpretty\n zpretty: bin/zpretty ## Format xml and zcml with zpretty\n \tfind "${PACKAGE_PATH}" -name \'*.xml\' | xargs bin/zpretty -x -i\n \tfind "${PACKAGE_PATH}" -name \'*.zcml\' | xargs bin/zpretty -z -i\ndiff --git a/README.rst b/README.rst\nindex d043082..5930344 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -173,13 +173,13 @@ Plone). This will be fixed in core in upcoming sprints.\n Preview Image Behavior\n ----------------------\n \n-The preview image behavior makes content types provide a preview_image field that can store a preview image that Volto views can pick up.\n+The preview image behavior makes content types provide a ``preview_image`` field that can store a preview image that Volto views can pick up.\n This is especially userful for listings (e.g. listing block customizations) and teaser elements (e.g. teaser blocks such as [volto-blocks-grid](https://github.com/kitconcept/volto-blocks-grid)).\n \n-The "volto.preview_image behavior can be enabled in the generic setup XML definition of a content type (e.g. "/profiles/default/types/MyContentType.xml")::\n+The ``volto.preview_image`` behavior can be enabled in the generic setup XML definition of a content type (e.g. ``/profiles/default/types/MyContentType.xml``)::\n \n    <?xml version="1.0" encoding="UTF-8" ?>\n-   <object i18n:domain="fzj.internet" meta_type="Dexterity FTI" name="MyContentType"\n+   <object i18n:domain="my.project" meta_type="Dexterity FTI" name="MyContentType"\n      xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n \n      ...\n@@ -192,6 +192,8 @@ The "volto.preview_image behavior can be enabled in the generic setup XML defini\n      ...\n    </object>\n \n+There is also another variation of the preview image behavior called ``volto.preview_image_link``.\n+This one stores preview images using a relation to an Image content type, rather than in an image field. This might be preferable if many content items use the same preview image.\n \n Navigation Title Behavior\n -------------------------\ndiff --git a/news/49.feature b/news/49.feature\nnew file mode 100644\nindex 0000000..7b64966\n--- /dev/null\n+++ b/news/49.feature\n@@ -0,0 +1,2 @@\n+- Added preview image link behavior (Plone 6+ only)\n+  [robgietema]\ndiff --git a/src/plone/volto/behaviors/configure.zcml b/src/plone/volto/behaviors/configure.zcml\nindex ab5df7b..47f096e 100644\n--- a/src/plone/volto/behaviors/configure.zcml\n+++ b/src/plone/volto/behaviors/configure.zcml\n@@ -1,6 +1,7 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:plone="http://namespaces.plone.org/plone"\n+    xmlns:zcml="http://namespaces.zope.org/zcml"\n     i18n_domain="plone.volto"\n     >\n \n@@ -16,6 +17,16 @@\n       provides=".preview.IPreview"\n       />\n \n+  <configure zcml:condition="have plone-60">\n+    <plone:behavior\n+        name="volto.preview_image_link"\n+        title="Preview Image Link"\n+        description="Preview image for listings based on links"\n+        provides=".preview_link.IPreviewLink"\n+        />\n+    <adapter factory=".preview_link.PreviewImageScalesFieldAdapter" />\n+  </configure>\n+\n   <plone:behavior\n       name="volto.navtitle"\n       title="Navigation title"\ndiff --git a/src/plone/volto/behaviors/preview_link.py b/src/plone/volto/behaviors/preview_link.py\nnew file mode 100644\nindex 0000000..838088f\n--- /dev/null\n+++ b/src/plone/volto/behaviors/preview_link.py\n@@ -0,0 +1,71 @@\n+# -*- coding: utf-8 -*-\n+from plone import api\n+from plone.app.z3cform.widget import RelatedItemsFieldWidget\n+from plone.autoform import directives\n+from plone.autoform.interfaces import IFormFieldProvider\n+from plone.base.interfaces import IImageScalesFieldAdapter\n+from plone.rfc822.interfaces import IPrimaryFieldInfo\n+from plone.supermodel import model\n+from plone.volto import _\n+from z3c.form.util import getSpecification\n+from z3c.relationfield.schema import RelationChoice\n+from zope.component import adapter\n+from zope.component import queryMultiAdapter\n+from zope.interface import implementer\n+from zope.interface import Interface\n+from zope.interface import provider\n+from zope.schema import TextLine\n+\n+\n+@provider(IFormFieldProvider)\n+class IPreviewLink(model.Schema):\n+\n+    preview_image_link = RelationChoice(\n+        title=_("label_previewimage", default="Preview image"),\n+        description=_(\n+            "help_previewimage",\n+            default="Select an image that will be used in listing and teaser blocks.",\n+        ),\n+        vocabulary="plone.app.vocabularies.Catalog",\n+        required=False,\n+    )\n+\n+    directives.widget(\n+        "preview_image_link",\n+        RelatedItemsFieldWidget,\n+        frontendOptions={\n+            "widget": "object_browser",\n+            "widgetProps": {"mode": "image", "return": "single"},\n+        },\n+    )\n+\n+    preview_caption_link = TextLine(\n+        title=_("Preview image caption"), description="", required=False\n+    )\n+\n+\n+@adapter(getSpecification(IPreviewLink["preview_image_link"]), Interface, Interface)\n+@implementer(IImageScalesFieldAdapter)\n+class PreviewImageScalesFieldAdapter:\n+    """Get the image_scales for the preview_image_link field"""\n+\n+    def __init__(self, field, context, request):\n+        self.field = field\n+        self.context = context\n+        self.request = request\n+\n+    def __call__(self):\n+        value = self.field.get(self.context)\n+        linked_image = value.to_object\n+        primary_field = IPrimaryFieldInfo(linked_image).field\n+        serializer = queryMultiAdapter(\n+            (primary_field, linked_image, self.request), IImageScalesFieldAdapter\n+        )\n+        if serializer is not None:\n+            values = serializer()\n+            if values:\n+                portal_url = api.portal.get().absolute_url()\n+                base_path = linked_image.absolute_url().replace(portal_url, "")\n+                for value in values:\n+                    value["base_path"] = base_path\n+            return values\ndiff --git a/src/plone/volto/indexers.py b/src/plone/volto/indexers.py\nindex f7f2455..9ecd181 100644\n--- a/src/plone/volto/indexers.py\n+++ b/src/plone/volto/indexers.py\n@@ -10,7 +10,7 @@ def hasPreviewImage(obj):\n     Indexer for knowing in a catalog search if a content with the IPreview behavior has\n     a preview_image\n     """\n-    if obj.aq_base.preview_image:\n+    if obj.aq_base.preview_image or obj.aq_base.preview_image_link:\n         return True\n     return False\n \n@@ -23,6 +23,8 @@ def image_field_indexer(obj):\n     image_field = ""\n     if getattr(base_obj, "preview_image", False):\n         image_field = "preview_image"\n+    elif getattr(base_obj, "preview_image_link", False):\n+        image_field = "preview_image_link"\n     elif getattr(base_obj, "image", False):\n         image_field = "image"\n     return image_field\ndiff --git a/src/plone/volto/testing.py b/src/plone/volto/testing.py\nindex 1e39aa6..adb5cc3 100644\n--- a/src/plone/volto/testing.py\n+++ b/src/plone/volto/testing.py\n@@ -17,6 +17,16 @@\n import plone.volto.coresandbox\n \n \n+try:\n+    from Products.CMFPlone.factory import PLONE60MARKER\n+\n+    PLONE60MARKER  # pyflakes\n+except ImportError:\n+    PLONE_6 = False\n+else:\n+    PLONE_6 = True\n+\n+\n class PloneVoltoCoreLayer(PloneSandboxLayer):\n \n     defaultBases = (PLONE_APP_CONTENTTYPES_FIXTURE,)\ndiff --git a/src/plone/volto/tests/test_migrate_to_volto.py b/src/plone/volto/tests/test_migrate_to_volto.py\nindex 259d860..56d3361 100644\n--- a/src/plone/volto/tests/test_migrate_to_volto.py\n+++ b/src/plone/volto/tests/test_migrate_to_volto.py\n@@ -6,6 +6,7 @@\n from plone.volto.content import FolderishDocument\n from plone.volto.content import FolderishEvent\n from plone.volto.content import FolderishNewsItem\n+from plone.volto.testing import PLONE_6\n from plone.volto.testing import PLONE_VOLTO_MIGRATION_FUNCTIONAL_TESTING\n from Products.CMFPlone.utils import get_installer\n \n@@ -14,16 +15,6 @@\n import unittest\n \n \n-try:\n-    from Products.CMFPlone.factory import PLONE60MARKER\n-\n-    PLONE60MARKER  # pyflakes\n-except ImportError:\n-    PLONE_6 = False\n-else:\n-    PLONE_6 = True\n-\n-\n @unittest.skipIf(\n     not PLONE_6,\n     "This test is only intended to run for Plone 6",\ndiff --git a/src/plone/volto/tests/test_preview_link_behavior.py b/src/plone/volto/tests/test_preview_link_behavior.py\nnew file mode 100644\nindex 0000000..0f6313f\n--- /dev/null\n+++ b/src/plone/volto/tests/test_preview_link_behavior.py\n@@ -0,0 +1,50 @@\n+# -*- coding: utf-8 -*-\n+\n+from plone.namedfile.file import NamedBlobImage\n+from plone.restapi.interfaces import ISerializeToJsonSummary\n+from plone.volto.testing import PLONE_6\n+from plone.volto.testing import PLONE_VOLTO_CORE_INTEGRATION_TESTING\n+from z3c.form.interfaces import IDataManager\n+from zope.component import getMultiAdapter\n+\n+import unittest\n+\n+\n+TEST_GIF = (\n+    b"GIF89a\\x01\\x00\\x01\\x00\\x00\\xff\\x00,\\x00\\x00\\x00\\x00\\x01\\x00\\x01\\x00\\x00\\x02\\x00;"\n+)\n+\n+\n+@unittest.skipIf(\n+    not PLONE_6,\n+    "This test is only intended to run for Plone 6",\n+)\n+class TestPreviewLinkBehavior(unittest.TestCase):\n+    layer = PLONE_VOLTO_CORE_INTEGRATION_TESTING\n+\n+    def setUp(self):\n+        from plone.volto.behaviors.preview_link import IPreviewLink\n+\n+        self.app = self.layer["app"]\n+        self.portal = self.layer["portal"]\n+        self.request = self.layer["request"]\n+        self.catalog = self.portal.portal_catalog\n+\n+        fti = self.portal.portal_types.Document\n+        fti.behaviors += ("volto.preview_image_link",)\n+\n+        self.doc = self.portal[self.portal.invokeFactory("Document", id="doc1")]\n+        self.image = self.portal[\n+            self.portal.invokeFactory("Image", id="image-1", title="Target image")\n+        ]\n+        self.image.image = NamedBlobImage(data=TEST_GIF, filename="test.gif")\n+        dm = getMultiAdapter(\n+            (self.doc, IPreviewLink["preview_image_link"]), IDataManager\n+        )\n+        dm.set(self.image)\n+        self.doc.reindexObject()\n+\n+    def test_image_scales_includes_preview_image_link(self):\n+        brain = self.catalog(UID=self.doc.UID())[0]\n+        summary = getMultiAdapter((brain, self.request), ISerializeToJsonSummary)()\n+        self.assertIn("preview_image_link", summary["image_scales"])\n'

