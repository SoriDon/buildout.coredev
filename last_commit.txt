Repository: mockup


Branch: refs/heads/master
Date: 2019-02-16T12:18:50+01:00
Author: Davi Lima (davilima6) <davilima6@gmail.com>
Commit: https://github.com/plone/mockup/commit/9da8b4187c3829877689f4c06451e5b2700a5858

Fix bugs in Moment.js lazy loaded locales:

- Avoid leaking lazyLoadMomentLocale to global namespace
- Fix not incorrect formatting of mockup-i18n's currentLanguage
- Fix widget breakage on IE11 due to lack of support for 'includes'

Files changed:
M mockup/patterns/moment/pattern.js

b"diff --git a/mockup/patterns/moment/pattern.js b/mockup/patterns/moment/pattern.js\nindex d56a00a3c..52c392c88 100644\n--- a/mockup/patterns/moment/pattern.js\n+++ b/mockup/patterns/moment/pattern.js\n@@ -86,7 +86,42 @@ define([\n   'mockup-i18n',\n   'moment'\n ], function($, Base, i18n, moment) {\n-  lazyLoadMomentLocale();\n+  var currentLanguage = (new i18n()).currentLanguage;\n+\n+  // From https://github.com/moment/moment/blob/3147fbc/src/test/moment/format.js#L463-L468\n+  var MOMENT_LOCALES =\n+    'ar-sa ar-tn ar az be bg bn bo br bs ca cs cv cy da de-at de dv el ' +\n+    'en-au en-ca en-gb en-ie en-nz eo es et eu fa fi fo fr-ca fr-ch fr fy ' +\n+    'gd gl he hi hr hu hy-am id is it ja jv ka kk km ko lb lo lt lv me mk ml ' +\n+    'mr ms-my ms my nb ne nl nn pl pt-br pt ro ru se si sk sl sq sr-cyrl ' +\n+    'sr sv sw ta te th tl-ph tlh tr tzl tzm-latn tzm uk uz vi zh-cn zh-tw';\n+\n+  lazyLoadMomentLocale(currentLanguage);\n+\n+  function isLangSupported(lang) {\n+    return MOMENT_LOCALES.split(' ').indexOf(lang) !== -1;\n+  }\n+\n+  function lazyLoadMomentLocale(lang) {\n+    var LANG_FALLBACK = 'en';\n+\n+    if (lang === LANG_FALLBACK) {\n+      // English locale is built-in, no need to load\n+      return;\n+    }\n+\n+    // Format language as expect by Moment.js, neither POSIX (like TinyMCE) nor IETF\n+    lang = lang.replace('_', '-').toLowerCase();\n+\n+    // Use language code as fallback, otherwise built-in English locale\n+    lang = isLangSupported(lang) ? lang : lang.split('-')[0];\n+    lang = isLangSupported(lang) ? lang : LANG_FALLBACK;\n+    if (lang === LANG_FALLBACK) {\n+      return;\n+    }\n+\n+    require(['moment-url/' + lang]);\n+  }\n \n   var Moment = Base.extend({\n     name: 'moment',\n@@ -109,7 +144,6 @@ define([\n       if (!date || date === 'None') {\n         return;\n       }\n-      var currentLanguage = (new i18n()).currentLanguage;\n       if (currentLanguage in self.moment_i18n_map) {\n         currentLanguage = self.moment_i18n_map[currentLanguage];\n       }\n@@ -147,31 +181,3 @@ define([\n \n   return Moment;\n });\n-\n-function lazyLoadMomentLocale() {\n-  var BUILTIN_FALLBACK = 'en';\n-  var lang = document.querySelector('html').lang || BUILTIN_FALLBACK;\n-\n-  if (lang === 'en') {\n-    // English locale is built-in, no need to load\n-    return;\n-  }\n-\n-  // Taken from https://github.com/moment/moment/blob/3147fbc486209f0b479dc0b29672d4c2ef39cf43/src/test/moment/format.js#L463-L468\n-  var MOMENT_LOCALES =\n-    'ar-sa ar-tn ar az be bg bn bo br bs ca cs cv cy da de-at de dv el ' +\n-    'en-au en-ca en-gb en-ie en-nz eo es et eu fa fi fo fr-ca fr-ch fr fy ' +\n-    'gd gl he hi hr hu hy-am id is it ja jv ka kk km ko lb lo lt lv me mk ml ' +\n-    'mr ms-my ms my nb ne nl nn pl pt-br pt ro ru se si sk sl sq sr-cyrl ' +\n-    'sr sv sw ta te th tl-ph tlh tr tzl tzm-latn tzm uk uz vi zh-cn zh-tw';\n-\n-  lang = MOMENT_LOCALES.split(' ').includes(lang) ? lang : lang.split('-')[0];\n-  lang = MOMENT_LOCALES.split(' ').includes(lang) ? lang : BUILTIN_FALLBACK;\n-\n-  if (lang === BUILTIN_FALLBACK) {\n-    // English locale is built-in, no need to load\n-    return;\n-  }\n-\n-  require(['moment-url/' + lang]);\n-}\n"

Repository: mockup


Branch: refs/heads/master
Date: 2019-02-16T12:18:50+01:00
Author: Davi Lima (davilima6) <davilima6@gmail.com>
Commit: https://github.com/plone/mockup/commit/4211674f2e93a1323fcd1c7c245cc1864ab5358b

Add towncrier entry (changelog)

Files changed:
A news/894.fix

b'diff --git a/news/894.fix b/news/894.fix\nnew file mode 100644\nindex 000000000..f0541c555\n--- /dev/null\n+++ b/news/894.fix\n@@ -0,0 +1,2 @@\n+* Fix bugs in Moment.js lazy locales, affecting: language variant fallbacks, variable leak to global namespace, IE11 widget support\n+  [davilima6]\n'

Repository: mockup


Branch: refs/heads/master
Date: 2019-02-18T19:09:52+01:00
Author: Davi Lima (davilima6) <davilima6@gmail.com>
Commit: https://github.com/plone/mockup/commit/2152a367599e41ca9171c9309060c23c64ff1b69

Move function invocation and change signature as variable is available in shared scope

Files changed:
M mockup/patterns/moment/pattern.js

b"diff --git a/mockup/patterns/moment/pattern.js b/mockup/patterns/moment/pattern.js\nindex 52c392c88..5c998420d 100644\n--- a/mockup/patterns/moment/pattern.js\n+++ b/mockup/patterns/moment/pattern.js\n@@ -96,22 +96,20 @@ define([\n     'mr ms-my ms my nb ne nl nn pl pt-br pt ro ru se si sk sl sq sr-cyrl ' +\n     'sr sv sw ta te th tl-ph tlh tr tzl tzm-latn tzm uk uz vi zh-cn zh-tw';\n \n-  lazyLoadMomentLocale(currentLanguage);\n-\n   function isLangSupported(lang) {\n     return MOMENT_LOCALES.split(' ').indexOf(lang) !== -1;\n   }\n \n-  function lazyLoadMomentLocale(lang) {\n+  function lazyLoadMomentLocale() {\n     var LANG_FALLBACK = 'en';\n \n-    if (lang === LANG_FALLBACK) {\n+    if (currentLanguage === LANG_FALLBACK) {\n       // English locale is built-in, no need to load\n       return;\n     }\n \n     // Format language as expect by Moment.js, neither POSIX (like TinyMCE) nor IETF\n-    lang = lang.replace('_', '-').toLowerCase();\n+    var lang = currentLanguage.replace('_', '-').toLowerCase();\n \n     // Use language code as fallback, otherwise built-in English locale\n     lang = isLangSupported(lang) ? lang : lang.split('-')[0];\n@@ -123,6 +121,8 @@ define([\n     require(['moment-url/' + lang]);\n   }\n \n+  lazyLoadMomentLocale();\n+\n   var Moment = Base.extend({\n     name: 'moment',\n     trigger: '.pat-moment',\n"

Repository: mockup


Branch: refs/heads/master
Date: 2019-02-18T19:16:09+01:00
Author: Davi Lima (davilima6) <davilima6@gmail.com>
Commit: https://github.com/plone/mockup/commit/a49ea55668fbc4a6fbb9398f1c628ce1e689777b

Clarify why we have 2 identical exit blocks

Files changed:
M mockup/patterns/moment/pattern.js

b"diff --git a/mockup/patterns/moment/pattern.js b/mockup/patterns/moment/pattern.js\nindex 5c998420d..3ca09beea 100644\n--- a/mockup/patterns/moment/pattern.js\n+++ b/mockup/patterns/moment/pattern.js\n@@ -104,7 +104,8 @@ define([\n     var LANG_FALLBACK = 'en';\n \n     if (currentLanguage === LANG_FALLBACK) {\n-      // English locale is built-in, no need to load\n+      // English locale is built-in, no need to load, so let's exit early\n+      // to avoid computing fallback, which happens at every loaded page\n       return;\n     }\n \n"

Repository: mockup


Branch: refs/heads/master
Date: 2019-02-18T23:58:55+01:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/mockup/commit/273452383863e6aab3047c2bda12659b9d2f566e

Merge pull request #894 from plone/momentjsLazyLoadLocales

Fix bugs on Moment.js lazy loading

Files changed:
A news/894.fix
M mockup/patterns/moment/pattern.js

b"diff --git a/mockup/patterns/moment/pattern.js b/mockup/patterns/moment/pattern.js\nindex d56a00a3c..3ca09beea 100644\n--- a/mockup/patterns/moment/pattern.js\n+++ b/mockup/patterns/moment/pattern.js\n@@ -86,6 +86,42 @@ define([\n   'mockup-i18n',\n   'moment'\n ], function($, Base, i18n, moment) {\n+  var currentLanguage = (new i18n()).currentLanguage;\n+\n+  // From https://github.com/moment/moment/blob/3147fbc/src/test/moment/format.js#L463-L468\n+  var MOMENT_LOCALES =\n+    'ar-sa ar-tn ar az be bg bn bo br bs ca cs cv cy da de-at de dv el ' +\n+    'en-au en-ca en-gb en-ie en-nz eo es et eu fa fi fo fr-ca fr-ch fr fy ' +\n+    'gd gl he hi hr hu hy-am id is it ja jv ka kk km ko lb lo lt lv me mk ml ' +\n+    'mr ms-my ms my nb ne nl nn pl pt-br pt ro ru se si sk sl sq sr-cyrl ' +\n+    'sr sv sw ta te th tl-ph tlh tr tzl tzm-latn tzm uk uz vi zh-cn zh-tw';\n+\n+  function isLangSupported(lang) {\n+    return MOMENT_LOCALES.split(' ').indexOf(lang) !== -1;\n+  }\n+\n+  function lazyLoadMomentLocale() {\n+    var LANG_FALLBACK = 'en';\n+\n+    if (currentLanguage === LANG_FALLBACK) {\n+      // English locale is built-in, no need to load, so let's exit early\n+      // to avoid computing fallback, which happens at every loaded page\n+      return;\n+    }\n+\n+    // Format language as expect by Moment.js, neither POSIX (like TinyMCE) nor IETF\n+    var lang = currentLanguage.replace('_', '-').toLowerCase();\n+\n+    // Use language code as fallback, otherwise built-in English locale\n+    lang = isLangSupported(lang) ? lang : lang.split('-')[0];\n+    lang = isLangSupported(lang) ? lang : LANG_FALLBACK;\n+    if (lang === LANG_FALLBACK) {\n+      return;\n+    }\n+\n+    require(['moment-url/' + lang]);\n+  }\n+\n   lazyLoadMomentLocale();\n \n   var Moment = Base.extend({\n@@ -109,7 +145,6 @@ define([\n       if (!date || date === 'None') {\n         return;\n       }\n-      var currentLanguage = (new i18n()).currentLanguage;\n       if (currentLanguage in self.moment_i18n_map) {\n         currentLanguage = self.moment_i18n_map[currentLanguage];\n       }\n@@ -147,31 +182,3 @@ define([\n \n   return Moment;\n });\n-\n-function lazyLoadMomentLocale() {\n-  var BUILTIN_FALLBACK = 'en';\n-  var lang = document.querySelector('html').lang || BUILTIN_FALLBACK;\n-\n-  if (lang === 'en') {\n-    // English locale is built-in, no need to load\n-    return;\n-  }\n-\n-  // Taken from https://github.com/moment/moment/blob/3147fbc486209f0b479dc0b29672d4c2ef39cf43/src/test/moment/format.js#L463-L468\n-  var MOMENT_LOCALES =\n-    'ar-sa ar-tn ar az be bg bn bo br bs ca cs cv cy da de-at de dv el ' +\n-    'en-au en-ca en-gb en-ie en-nz eo es et eu fa fi fo fr-ca fr-ch fr fy ' +\n-    'gd gl he hi hr hu hy-am id is it ja jv ka kk km ko lb lo lt lv me mk ml ' +\n-    'mr ms-my ms my nb ne nl nn pl pt-br pt ro ru se si sk sl sq sr-cyrl ' +\n-    'sr sv sw ta te th tl-ph tlh tr tzl tzm-latn tzm uk uz vi zh-cn zh-tw';\n-\n-  lang = MOMENT_LOCALES.split(' ').includes(lang) ? lang : lang.split('-')[0];\n-  lang = MOMENT_LOCALES.split(' ').includes(lang) ? lang : BUILTIN_FALLBACK;\n-\n-  if (lang === BUILTIN_FALLBACK) {\n-    // English locale is built-in, no need to load\n-    return;\n-  }\n-\n-  require(['moment-url/' + lang]);\n-}\ndiff --git a/news/894.fix b/news/894.fix\nnew file mode 100644\nindex 000000000..f0541c555\n--- /dev/null\n+++ b/news/894.fix\n@@ -0,0 +1,2 @@\n+* Fix bugs in Moment.js lazy locales, affecting: language variant fallbacks, variable leak to global namespace, IE11 widget support\n+  [davilima6]\n"

