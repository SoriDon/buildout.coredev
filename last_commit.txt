Repository: plone.app.openid


Branch: refs/heads/master
Date: 2016-05-24T19:09:08+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.openid/commit/cd68278c5a11186a02651ece155e6abd9669b129

Added correct addview to our portlets.xml, so you can add it.

Added upgrade step to replace current portlet type definition.
The automatically added portlet works, but you cannot add another one.

Files changed:
M CHANGES.rst
M plone/app/openid/configure.zcml
M plone/app/openid/profiles/default/metadata.xml
M plone/app/openid/profiles/default/portlets.xml
M plone/app/openid/setuphandlers.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ded1dab..ef43a5c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Added correct addview to our portlets.xml, so you can add it.
+  Added upgrade step to replace current portlet type definition.
+  The automatically added portlet works, but you cannot add another one.
+  [maurits]
 
 
 2.1.1 (2016-05-24)
diff --git a/plone/app/openid/configure.zcml b/plone/app/openid/configure.zcml
index b6c96cf..5efea04 100644
--- a/plone/app/openid/configure.zcml
+++ b/plone/app/openid/configure.zcml
@@ -24,6 +24,16 @@
       provides="Products.GenericSetup.interfaces.EXTENSION"
       />
 
+  <genericsetup:upgradeStep
+      zcml:condition="installed openid.yadis"
+      title="Register portlet with correct addview"
+      description="Our portlet may have been registered with an empty string as addview, which means you cannot add it anywhere."
+      source="2.0b2"
+      destination="1000"
+      handler=".setuphandlers.registerPortletAddview"
+      profile="plone.app.openid:default"
+      />
+
    <cmf:registerDirectory name="ploneopenid"/>
 
    <include package=".portlets" />
diff --git a/plone/app/openid/profiles/default/metadata.xml b/plone/app/openid/profiles/default/metadata.xml
index b5c958a..b22370d 100644
--- a/plone/app/openid/profiles/default/metadata.xml
+++ b/plone/app/openid/profiles/default/metadata.xml
@@ -1,4 +1,4 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>2.0b2</version>
+  <version>1000</version>
 </metadata>
diff --git a/plone/app/openid/profiles/default/portlets.xml b/plone/app/openid/profiles/default/portlets.xml
index 1abf2f2..b3ae46c 100644
--- a/plone/app/openid/profiles/default/portlets.xml
+++ b/plone/app/openid/profiles/default/portlets.xml
@@ -4,6 +4,7 @@
     i18n:domain="plone">
 
  <portlet
+   addview="portlets.OpenIDLogin"
    title="OpenID Login"
    description="A portlet which can render an OpenID log-in box"
    i18n:attributes="title;
diff --git a/plone/app/openid/setuphandlers.py b/plone/app/openid/setuphandlers.py
index 04be090..e84f30e 100644
--- a/plone/app/openid/setuphandlers.py
+++ b/plone/app/openid/setuphandlers.py
@@ -3,11 +3,20 @@
 from plone.openid.plugins.oid import addOpenIdPlugin
 from plone.portlets.interfaces import IPortletAssignmentMapping
 from plone.portlets.interfaces import IPortletManager
+from plone.portlets.interfaces import IPortletType
 from Products.CMFCore.utils import getToolByName
 from Products.PlonePAS.browser.info import PASInfoView
 from StringIO import StringIO
 from zope.component import getMultiAdapter
+from zope.component import getSiteManager
 from zope.component import queryUtility
+from zope.component.interfaces import IComponentRegistry
+
+import logging
+
+
+logger = logging.getLogger('plone.app.openid')
+PROFILE_ID = 'plone.app.openid:default'
 
 
 def hasOpenIdPlugin(portal):
@@ -61,3 +70,23 @@ def importVarious(context):
         activatePlugin(site, out, 'openid')
 
     addLoginPortlet(site, out)
+
+
+def registerPortletAddview(context):
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    sm = getSiteManager(portal)
+    if sm is None or not IComponentRegistry.providedBy(sm):
+        # plone.app.portlets.exportimport.portlets has this same check.
+        logger.info('Cannot register portlet addview - no site manager found.')
+        return
+    if queryUtility(IPortletType, name=''):
+        # For a few years we have registered our portlet with an empty string
+        # as add view.  This is wrong.
+        sm.unregisterUtility(provided=IPortletType, name='')
+        logger.info('Unregistered portlet type with empty addview.')
+    addview = 'portlets.OpenIDLogin'
+    if queryUtility(IPortletType, name=addview) is None:
+        # Apply our default portlets.xml.
+        context.runImportStepFromProfile(PROFILE_ID, 'portlets')
+        logger.info('Applied our portlets.xml to register portlet '
+                    'with correct addview.')


Repository: plone.app.openid


Branch: refs/heads/master
Date: 2016-05-24T19:11:51+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.openid/commit/8a89d8ee712c99bece2b584ad308d34698ac3a7b

Replaced import step with post_handler.

Files changed:
M CHANGES.rst
M plone/app/openid/configure.zcml
M plone/app/openid/setuphandlers.py
M setup.py
D plone/app/openid/profiles/default/openid-pas.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index ef43a5c..1a8b29b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,7 +11,7 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Replaced import step with post_handler.  [maurits]
 
 Bug fixes:
 
diff --git a/plone/app/openid/configure.zcml b/plone/app/openid/configure.zcml
index 5efea04..d852b69 100644
--- a/plone/app/openid/configure.zcml
+++ b/plone/app/openid/configure.zcml
@@ -9,12 +9,6 @@
 
   <five:registerPackage package="." />
 
-  <genericsetup:importStep
-      name="ploneopenid-various"
-      title="Set up OpenID authentication in Plone"
-      handler="plone.app.openid.setuphandlers.importVarious"
-      description="Add OpenID authentication support to Plone. This adds a new OpenID login portlet and modifies the login form to add OpenID support." />
-
   <genericsetup:registerProfile
       zcml:condition="installed openid.yadis"
       name="default"
@@ -22,6 +16,7 @@
       description="Adds support for authenticating with OpenID credentials in a Plone site"
       directory="profiles/default"
       provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler=".setuphandlers.importVarious"
       />
 
   <genericsetup:upgradeStep
diff --git a/plone/app/openid/profiles/default/openid-pas.txt b/plone/app/openid/profiles/default/openid-pas.txt
deleted file mode 100644
index f41a477..0000000
--- a/plone/app/openid/profiles/default/openid-pas.txt
+++ /dev/null
@@ -1 +0,0 @@
-add magic file
diff --git a/plone/app/openid/setuphandlers.py b/plone/app/openid/setuphandlers.py
index e84f30e..2564f8d 100644
--- a/plone/app/openid/setuphandlers.py
+++ b/plone/app/openid/setuphandlers.py
@@ -59,11 +59,7 @@ def addLoginPortlet(portal, out):
 
 
 def importVarious(context):
-    # Only run step if a flag file is present (e.g. not an extension profile)
-    if context.readDataFile('openid-pas.txt') is None:
-        return
-
-    site = context.getSite()
+    site = getToolByName(context, 'portal_url').getPortalObject()
     out = StringIO()
     if not hasOpenIdPlugin(site):
         createOpenIdPlugin(site, out)
diff --git a/setup.py b/setup.py
index 42cf40f..d72d940 100644
--- a/setup.py
+++ b/setup.py
@@ -41,6 +41,7 @@
         'Products.CMFPlone',
         'Products.PlonePAS>=2.0.10dev',
         'Products.PluggableAuthService',
+        'Products.GenericSetup>=1.8.2',
         'Zope2',
     ],
     entry_points="""


Repository: plone.app.openid


Branch: refs/heads/master
Date: 2016-05-24T19:11:53+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.openid/commit/6fd8d198f1d1502fd22a83c6806bc547ceb30b74

Added uninstall profile.

Files changed:
A plone/app/openid/profiles/uninstall/metadata.xml
A plone/app/openid/profiles/uninstall/portlets.xml
A plone/app/openid/profiles/uninstall/skins.xml
M CHANGES.rst
M plone/app/openid/configure.zcml
M plone/app/openid/setuphandlers.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1a8b29b..a77c664 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,6 +11,8 @@ Breaking changes:
 
 New features:
 
+- Added uninstall profile.  [maurits]
+
 - Replaced import step with post_handler.  [maurits]
 
 Bug fixes:
diff --git a/plone/app/openid/configure.zcml b/plone/app/openid/configure.zcml
index d852b69..6e2d965 100644
--- a/plone/app/openid/configure.zcml
+++ b/plone/app/openid/configure.zcml
@@ -19,6 +19,15 @@
       post_handler=".setuphandlers.importVarious"
       />
 
+  <genericsetup:registerProfile
+      zcml:condition="installed openid.yadis"
+      name="uninstall"
+      title="OpenID Authentication Support [uninstall]"
+      directory="profiles/uninstall"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler=".setuphandlers.uninstall"
+      />
+
   <genericsetup:upgradeStep
       zcml:condition="installed openid.yadis"
       title="Register portlet with correct addview"
diff --git a/plone/app/openid/profiles/uninstall/metadata.xml b/plone/app/openid/profiles/uninstall/metadata.xml
new file mode 100644
index 0000000..b22370d
--- /dev/null
+++ b/plone/app/openid/profiles/uninstall/metadata.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<metadata>
+  <version>1000</version>
+</metadata>
diff --git a/plone/app/openid/profiles/uninstall/portlets.xml b/plone/app/openid/profiles/uninstall/portlets.xml
new file mode 100644
index 0000000..ed0db35
--- /dev/null
+++ b/plone/app/openid/profiles/uninstall/portlets.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<portlets>
+  <portlet addview="portlets.OpenIDLogin" remove="true" />
+</portlets>
diff --git a/plone/app/openid/profiles/uninstall/skins.xml b/plone/app/openid/profiles/uninstall/skins.xml
new file mode 100644
index 0000000..ce9a5f2
--- /dev/null
+++ b/plone/app/openid/profiles/uninstall/skins.xml
@@ -0,0 +1,7 @@
+<?xml version="1.0"?>
+<object name="portal_skins" meta_type="Plone Skins Tool">
+ <object name="ploneopenid" remove="true" />
+  <skin-path name="*">
+    <layer name="ploneopenid" remove="true" />
+  </skin-path>
+</object>
diff --git a/plone/app/openid/setuphandlers.py b/plone/app/openid/setuphandlers.py
index 2564f8d..a726bef 100644
--- a/plone/app/openid/setuphandlers.py
+++ b/plone/app/openid/setuphandlers.py
@@ -47,6 +47,13 @@ def activatePlugin(portal, out, plugin):
     plugin.manage_activateInterfaces(activate)
 
 
+def removeOpenIdPlugin(portal):
+    if hasOpenIdPlugin(portal):
+        acl = getToolByName(portal, 'acl_users')
+        acl._delObject('openid')
+        logger.info('Removed openid plugin from acl_users.')
+
+
 def addLoginPortlet(portal, out):
     leftColumn = queryUtility(
         IPortletManager, name=u'plone.leftcolumn', context=portal)
@@ -58,6 +65,17 @@ def addLoginPortlet(portal, out):
             left[u'openid-login'] = LoginAssignment()
 
 
+def removeLoginPortlet(portal):
+    leftColumn = queryUtility(
+        IPortletManager, name=u'plone.leftcolumn', context=portal)
+    if leftColumn is not None:
+        left = getMultiAdapter((portal, leftColumn,),
+                               IPortletAssignmentMapping, context=portal)
+        if u'openid-login' in left:
+            del left[u'openid-login']
+            logger.info('Removed OpenID login portlet from the left column')
+
+
 def importVarious(context):
     site = getToolByName(context, 'portal_url').getPortalObject()
     out = StringIO()
@@ -86,3 +104,9 @@ def registerPortletAddview(context):
         context.runImportStepFromProfile(PROFILE_ID, 'portlets')
         logger.info('Applied our portlets.xml to register portlet '
                     'with correct addview.')
+
+
+def uninstall(context):
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    removeOpenIdPlugin(portal)
+    removeLoginPortlet(portal)


Repository: plone.app.openid


Branch: refs/heads/master
Date: 2016-05-24T21:43:28+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.openid/commit/64ab1ecfa5e7db78163af726751aa6b5d1f90fcb

Merge pull request #7 from plone/uninstall-profile

Uninstall profile and import/upgrade steps improved

Files changed:
A plone/app/openid/profiles/uninstall/metadata.xml
A plone/app/openid/profiles/uninstall/portlets.xml
A plone/app/openid/profiles/uninstall/skins.xml
M CHANGES.rst
M plone/app/openid/configure.zcml
M plone/app/openid/profiles/default/metadata.xml
M plone/app/openid/profiles/default/portlets.xml
M plone/app/openid/setuphandlers.py
M setup.py
D plone/app/openid/profiles/default/openid-pas.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index ded1dab..a77c664 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,11 +11,16 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Added uninstall profile.  [maurits]
+
+- Replaced import step with post_handler.  [maurits]
 
 Bug fixes:
 
-- *add item here*
+- Added correct addview to our portlets.xml, so you can add it.
+  Added upgrade step to replace current portlet type definition.
+  The automatically added portlet works, but you cannot add another one.
+  [maurits]
 
 
 2.1.1 (2016-05-24)
diff --git a/plone/app/openid/configure.zcml b/plone/app/openid/configure.zcml
index b6c96cf..6e2d965 100644
--- a/plone/app/openid/configure.zcml
+++ b/plone/app/openid/configure.zcml
@@ -9,12 +9,6 @@
 
   <five:registerPackage package="." />
 
-  <genericsetup:importStep
-      name="ploneopenid-various"
-      title="Set up OpenID authentication in Plone"
-      handler="plone.app.openid.setuphandlers.importVarious"
-      description="Add OpenID authentication support to Plone. This adds a new OpenID login portlet and modifies the login form to add OpenID support." />
-
   <genericsetup:registerProfile
       zcml:condition="installed openid.yadis"
       name="default"
@@ -22,6 +16,26 @@
       description="Adds support for authenticating with OpenID credentials in a Plone site"
       directory="profiles/default"
       provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler=".setuphandlers.importVarious"
+      />
+
+  <genericsetup:registerProfile
+      zcml:condition="installed openid.yadis"
+      name="uninstall"
+      title="OpenID Authentication Support [uninstall]"
+      directory="profiles/uninstall"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler=".setuphandlers.uninstall"
+      />
+
+  <genericsetup:upgradeStep
+      zcml:condition="installed openid.yadis"
+      title="Register portlet with correct addview"
+      description="Our portlet may have been registered with an empty string as addview, which means you cannot add it anywhere."
+      source="2.0b2"
+      destination="1000"
+      handler=".setuphandlers.registerPortletAddview"
+      profile="plone.app.openid:default"
       />
 
    <cmf:registerDirectory name="ploneopenid"/>
diff --git a/plone/app/openid/profiles/default/metadata.xml b/plone/app/openid/profiles/default/metadata.xml
index b5c958a..b22370d 100644
--- a/plone/app/openid/profiles/default/metadata.xml
+++ b/plone/app/openid/profiles/default/metadata.xml
@@ -1,4 +1,4 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>2.0b2</version>
+  <version>1000</version>
 </metadata>
diff --git a/plone/app/openid/profiles/default/openid-pas.txt b/plone/app/openid/profiles/default/openid-pas.txt
deleted file mode 100644
index f41a477..0000000
--- a/plone/app/openid/profiles/default/openid-pas.txt
+++ /dev/null
@@ -1 +0,0 @@
-add magic file
diff --git a/plone/app/openid/profiles/default/portlets.xml b/plone/app/openid/profiles/default/portlets.xml
index 1abf2f2..b3ae46c 100644
--- a/plone/app/openid/profiles/default/portlets.xml
+++ b/plone/app/openid/profiles/default/portlets.xml
@@ -4,6 +4,7 @@
     i18n:domain="plone">
 
  <portlet
+   addview="portlets.OpenIDLogin"
    title="OpenID Login"
    description="A portlet which can render an OpenID log-in box"
    i18n:attributes="title;
diff --git a/plone/app/openid/profiles/uninstall/metadata.xml b/plone/app/openid/profiles/uninstall/metadata.xml
new file mode 100644
index 0000000..b22370d
--- /dev/null
+++ b/plone/app/openid/profiles/uninstall/metadata.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<metadata>
+  <version>1000</version>
+</metadata>
diff --git a/plone/app/openid/profiles/uninstall/portlets.xml b/plone/app/openid/profiles/uninstall/portlets.xml
new file mode 100644
index 0000000..ed0db35
--- /dev/null
+++ b/plone/app/openid/profiles/uninstall/portlets.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<portlets>
+  <portlet addview="portlets.OpenIDLogin" remove="true" />
+</portlets>
diff --git a/plone/app/openid/profiles/uninstall/skins.xml b/plone/app/openid/profiles/uninstall/skins.xml
new file mode 100644
index 0000000..ce9a5f2
--- /dev/null
+++ b/plone/app/openid/profiles/uninstall/skins.xml
@@ -0,0 +1,7 @@
+<?xml version="1.0"?>
+<object name="portal_skins" meta_type="Plone Skins Tool">
+ <object name="ploneopenid" remove="true" />
+  <skin-path name="*">
+    <layer name="ploneopenid" remove="true" />
+  </skin-path>
+</object>
diff --git a/plone/app/openid/setuphandlers.py b/plone/app/openid/setuphandlers.py
index 04be090..a726bef 100644
--- a/plone/app/openid/setuphandlers.py
+++ b/plone/app/openid/setuphandlers.py
@@ -3,11 +3,20 @@
 from plone.openid.plugins.oid import addOpenIdPlugin
 from plone.portlets.interfaces import IPortletAssignmentMapping
 from plone.portlets.interfaces import IPortletManager
+from plone.portlets.interfaces import IPortletType
 from Products.CMFCore.utils import getToolByName
 from Products.PlonePAS.browser.info import PASInfoView
 from StringIO import StringIO
 from zope.component import getMultiAdapter
+from zope.component import getSiteManager
 from zope.component import queryUtility
+from zope.component.interfaces import IComponentRegistry
+
+import logging
+
+
+logger = logging.getLogger('plone.app.openid')
+PROFILE_ID = 'plone.app.openid:default'
 
 
 def hasOpenIdPlugin(portal):
@@ -38,6 +47,13 @@ def activatePlugin(portal, out, plugin):
     plugin.manage_activateInterfaces(activate)
 
 
+def removeOpenIdPlugin(portal):
+    if hasOpenIdPlugin(portal):
+        acl = getToolByName(portal, 'acl_users')
+        acl._delObject('openid')
+        logger.info('Removed openid plugin from acl_users.')
+
+
 def addLoginPortlet(portal, out):
     leftColumn = queryUtility(
         IPortletManager, name=u'plone.leftcolumn', context=portal)
@@ -49,15 +65,48 @@ def addLoginPortlet(portal, out):
             left[u'openid-login'] = LoginAssignment()
 
 
-def importVarious(context):
-    # Only run step if a flag file is present (e.g. not an extension profile)
-    if context.readDataFile('openid-pas.txt') is None:
-        return
+def removeLoginPortlet(portal):
+    leftColumn = queryUtility(
+        IPortletManager, name=u'plone.leftcolumn', context=portal)
+    if leftColumn is not None:
+        left = getMultiAdapter((portal, leftColumn,),
+                               IPortletAssignmentMapping, context=portal)
+        if u'openid-login' in left:
+            del left[u'openid-login']
+            logger.info('Removed OpenID login portlet from the left column')
+
 
-    site = context.getSite()
+def importVarious(context):
+    site = getToolByName(context, 'portal_url').getPortalObject()
     out = StringIO()
     if not hasOpenIdPlugin(site):
         createOpenIdPlugin(site, out)
         activatePlugin(site, out, 'openid')
 
     addLoginPortlet(site, out)
+
+
+def registerPortletAddview(context):
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    sm = getSiteManager(portal)
+    if sm is None or not IComponentRegistry.providedBy(sm):
+        # plone.app.portlets.exportimport.portlets has this same check.
+        logger.info('Cannot register portlet addview - no site manager found.')
+        return
+    if queryUtility(IPortletType, name=''):
+        # For a few years we have registered our portlet with an empty string
+        # as add view.  This is wrong.
+        sm.unregisterUtility(provided=IPortletType, name='')
+        logger.info('Unregistered portlet type with empty addview.')
+    addview = 'portlets.OpenIDLogin'
+    if queryUtility(IPortletType, name=addview) is None:
+        # Apply our default portlets.xml.
+        context.runImportStepFromProfile(PROFILE_ID, 'portlets')
+        logger.info('Applied our portlets.xml to register portlet '
+                    'with correct addview.')
+
+
+def uninstall(context):
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    removeOpenIdPlugin(portal)
+    removeLoginPortlet(portal)
diff --git a/setup.py b/setup.py
index 42cf40f..d72d940 100644
--- a/setup.py
+++ b/setup.py
@@ -41,6 +41,7 @@
         'Products.CMFPlone',
         'Products.PlonePAS>=2.0.10dev',
         'Products.PluggableAuthService',
+        'Products.GenericSetup>=1.8.2',
         'Zope2',
     ],
     entry_points="""


