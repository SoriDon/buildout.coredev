Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-03-02T15:42:31+01:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/b7c79d5ee4a469efdb5d852bea6473f1ceaebb88

fix redirection to came_from after login

Files changed:
A news/2771.bugfix
M Products/CMFPlone/browser/login/login.py
M Products/CMFPlone/tests/test_redirect_after_login.py

b"diff --git a/Products/CMFPlone/browser/login/login.py b/Products/CMFPlone/browser/login/login.py\nindex 811f47705..4114e1711 100644\n--- a/Products/CMFPlone/browser/login/login.py\n+++ b/Products/CMFPlone/browser/login/login.py\n@@ -117,7 +117,7 @@ def get_came_from(self):\n         url_tool = getToolByName(self.context, 'portal_url')\n         if not url_tool.isURLInPortal(came_from):\n             return\n-        came_from_path = parse.urlparse(came_from)[2]\n+        came_from_path = parse.urlparse(came_from)[2].split('/')\n         for login_template_id in LOGIN_TEMPLATE_IDS:\n             if login_template_id in came_from_path:\n                 return\ndiff --git a/Products/CMFPlone/tests/test_redirect_after_login.py b/Products/CMFPlone/tests/test_redirect_after_login.py\nindex 56ef20b29..6dd1a5422 100644\n--- a/Products/CMFPlone/tests/test_redirect_after_login.py\n+++ b/Products/CMFPlone/tests/test_redirect_after_login.py\n@@ -59,6 +59,10 @@ def test_login_templates_are_filtered(self):\n         url = 'https://nohost/plone/logout'\n         self.request['came_from'] = url\n         self.assertEqual(self.form.get_came_from(), None)\n+        # do not filter came_from if url matches parts of login templates\n+        url = 'https://nohost/plone/my_custom_logged_in'\n+        self.request['came_from'] = url\n+        self.assertEqual(self.form.get_came_from(), url)\n \n     def test_referer_is_fallback(self):\n         url = 'https://nohost/plone/test'\ndiff --git a/news/2771.bugfix b/news/2771.bugfix\nnew file mode 100644\nindex 000000000..418d00647\n--- /dev/null\n+++ b/news/2771.bugfix\n@@ -0,0 +1,2 @@\n+Fix redirection to `came_from` when url matches LOGIN_TEMPLATE_ID partly\n+[petschki]\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-03-02T16:51:33+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/b6da221ad2d3ebc5c1ae3e8187723e806fa39eae

Merge pull request #2783 from plone/issue_2771

fix redirection to came_from after login

Files changed:
A news/2771.bugfix
M Products/CMFPlone/browser/login/login.py
M Products/CMFPlone/tests/test_redirect_after_login.py

b"diff --git a/Products/CMFPlone/browser/login/login.py b/Products/CMFPlone/browser/login/login.py\nindex 811f47705..4114e1711 100644\n--- a/Products/CMFPlone/browser/login/login.py\n+++ b/Products/CMFPlone/browser/login/login.py\n@@ -117,7 +117,7 @@ def get_came_from(self):\n         url_tool = getToolByName(self.context, 'portal_url')\n         if not url_tool.isURLInPortal(came_from):\n             return\n-        came_from_path = parse.urlparse(came_from)[2]\n+        came_from_path = parse.urlparse(came_from)[2].split('/')\n         for login_template_id in LOGIN_TEMPLATE_IDS:\n             if login_template_id in came_from_path:\n                 return\ndiff --git a/Products/CMFPlone/tests/test_redirect_after_login.py b/Products/CMFPlone/tests/test_redirect_after_login.py\nindex 56ef20b29..6dd1a5422 100644\n--- a/Products/CMFPlone/tests/test_redirect_after_login.py\n+++ b/Products/CMFPlone/tests/test_redirect_after_login.py\n@@ -59,6 +59,10 @@ def test_login_templates_are_filtered(self):\n         url = 'https://nohost/plone/logout'\n         self.request['came_from'] = url\n         self.assertEqual(self.form.get_came_from(), None)\n+        # do not filter came_from if url matches parts of login templates\n+        url = 'https://nohost/plone/my_custom_logged_in'\n+        self.request['came_from'] = url\n+        self.assertEqual(self.form.get_came_from(), url)\n \n     def test_referer_is_fallback(self):\n         url = 'https://nohost/plone/test'\ndiff --git a/news/2771.bugfix b/news/2771.bugfix\nnew file mode 100644\nindex 000000000..418d00647\n--- /dev/null\n+++ b/news/2771.bugfix\n@@ -0,0 +1,2 @@\n+Fix redirection to `came_from` when url matches LOGIN_TEMPLATE_ID partly\n+[petschki]\n"

