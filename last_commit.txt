Repository: plone.app.layout


Branch: refs/heads/master
Date: 2021-11-14T22:31:32+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/e6abb1b229eaff6aa5d8cddcedf48bfe4f5f6d7a

move traces of portlets to plone.app.portlets

get rid of dependency indirection

Files changed:
M plone/app/layout/configure.zcml
M plone/app/layout/viewlets/common.py
M plone/app/layout/viewlets/configure.zcml
M setup.py
D plone/app/layout/dashboard/__init__.py
D plone/app/layout/dashboard/configure.zcml
D plone/app/layout/dashboard/dashboard.pt
D plone/app/layout/dashboard/dashboard.py
D plone/app/layout/dashboard/user_actions.pt
D plone/app/layout/dashboard/user_actions.py
D plone/app/layout/viewlets/footer.pt
D plone/app/layout/viewlets/manage_portlets_fallback.pt

b'diff --git a/plone/app/layout/configure.zcml b/plone/app/layout/configure.zcml\nindex c960b763..7ef16a7e 100644\n--- a/plone/app/layout/configure.zcml\n+++ b/plone/app/layout/configure.zcml\n@@ -10,7 +10,6 @@\n     <include package=".icons" />\n     <include package=".links" />\n     <include package=".sitemap" />\n-    <include package=".dashboard" />\n     <include package=".analytics" />\n \n     <include file="permissions.zcml" />\ndiff --git a/plone/app/layout/dashboard/__init__.py b/plone/app/layout/dashboard/__init__.py\ndeleted file mode 100644\nindex 40a96afc..00000000\n--- a/plone/app/layout/dashboard/__init__.py\n+++ /dev/null\n@@ -1 +0,0 @@\n-# -*- coding: utf-8 -*-\ndiff --git a/plone/app/layout/dashboard/configure.zcml b/plone/app/layout/dashboard/configure.zcml\ndeleted file mode 100644\nindex 430d6d75..00000000\n--- a/plone/app/layout/dashboard/configure.zcml\n+++ /dev/null\n@@ -1,24 +0,0 @@\n-<configure\n-    xmlns="http://namespaces.zope.org/zope"\n-    xmlns:browser="http://namespaces.zope.org/browser">\n-\n-    <include package="plone.app.portlets" />\n-\n-    <browser:page\n-        for="plone.app.layout.navigation.interfaces.INavigationRoot"\n-        name="dashboard"\n-        permission="plone.app.portlets.ViewDashboard"\n-        class=".dashboard.DashboardView"\n-        template="dashboard.pt"\n-        />\n-\n-    <!-- this view provides a not-js fallback for the user dropdown menu.\n-    It has been placed here to be near the personal bar code -->\n-    <browser:page\n-        for="plone.app.layout.navigation.interfaces.INavigationRoot"\n-        name="useractions"\n-        permission="zope2.View"\n-        class=".user_actions.UserActionsView"\n-        template="user_actions.pt"\n-        />\n-</configure>\ndiff --git a/plone/app/layout/dashboard/dashboard.pt b/plone/app/layout/dashboard/dashboard.pt\ndeleted file mode 100644\nindex 71de849a..00000000\n--- a/plone/app/layout/dashboard/dashboard.pt\n+++ /dev/null\n@@ -1,70 +0,0 @@\n-<html\n-    xmlns="http://www.w3.org/1999/xhtml"\n-    xml:lang="en"\n-    xmlns:tal="http://xml.zope.org/namespaces/tal"\n-    xmlns:metal="http://xml.zope.org/namespaces/metal"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-    lang="en"\n-    metal:use-macro="context/main_template/macros/master"\n-    i18n:domain="plone">\n-\n-  <body>\n-\n-    <metal:b fill-slot="content-title">\n-      <h1\n-          class="documentFirstHeading"\n-          i18n:translate="heading_dashboard"\n-          tal:define="memberinfo context/portal_membership/getMemberInfo;\n-                  member context/@@plone_portal_state/member;\n-                  name python:memberinfo[\'fullname\'] or member.getId() or member.getId()">\n-        <span\n-            tal:replace="name"\n-            i18n:name="user_name" />\n-        &#8217;s dashboard\n-      </h1>\n-    </metal:b>\n-\n-    <metal:b fill-slot="content-core">\n-      <tal:b metal:define-macro="content-core">\n-\n-        <div class="autotabs">\n-          <nav class="autotoc-nav nav nav-tabs mb-3">\n-            <span class="nav-item">\n-              <a\n-                  class="active nav-link"\n-                  href="${context/@@plone_portal_state/navigation_root_url}/dashboard"\n-                  i18n:translate="label_dashboard">Dashboard</a>\n-            </span>\n-            <span class="nav-item">\n-              <a\n-                  href="${context/@@plone_portal_state/navigation_root_url}/@@manage-dashboard?_authenticator=${view/auth_token}"\n-                  class="nav-link"\n-                  i18n:translate="label_edit">Edit</a>\n-            </span>\n-          </nav>\n-\n-\n-          <div\n-              id="dashboard"\n-              class="row row-cols-1 row-cols-md-2 gy-2">\n-            <div\n-                id="dashboard-portlets1"\n-                tal:content="structure provider:plone.dashboard1" />\n-            <div\n-                id="dashboard-portlets2"\n-                tal:content="structure provider:plone.dashboard2" />\n-            <div\n-                id="dashboard-portlets3"\n-                tal:content="structure provider:plone.dashboard3" />\n-            <div\n-                id="dashboard-portlets4"\n-                tal:content="structure provider:plone.dashboard4" />\n-          </div>\n-\n-        </div>\n-\n-      </tal:b>\n-    </metal:b>\n-\n-  </body>\n-</html>\ndiff --git a/plone/app/layout/dashboard/dashboard.py b/plone/app/layout/dashboard/dashboard.py\ndeleted file mode 100644\nindex abc42837..00000000\n--- a/plone/app/layout/dashboard/dashboard.py\n+++ /dev/null\n@@ -1,72 +0,0 @@\n-# -*- coding: utf-8 -*-\n-from AccessControl import getSecurityManager\n-from plone.memoize.instance import memoize\n-from plone.portlets.constants import GROUP_CATEGORY\n-from plone.portlets.constants import USER_CATEGORY\n-from plone.portlets.interfaces import IPortletManager\n-from plone.protect.authenticator import createToken\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n-from Products.Five.browser import BrowserView\n-from Products.statusmessages.interfaces import IStatusMessage\n-from zope.component import getUtility\n-from zope.interface import implementer\n-from zope.interface import Interface\n-\n-\n-class IDashboard(Interface):\n-    """the dashboard display columns of portlet to the loggedin user"""\n-\n-\n-@implementer(IDashboard)\n-class DashboardView(BrowserView):\n-    """Power the dashboard"""\n-\n-    def __call__(self):\n-        self.request.set("disable_border", 1)\n-        self.request.set("disable_plone.leftcolumn", 1)\n-        self.request.set("disable_plone.rightcolumn", 1)\n-        if self.can_edit() and self.empty():\n-            message = _(\n-                u"info_empty_dashboard",\n-                default=u"Your dashboard is currently empty. Click the"\n-                " <em>edit</em> tab to assign some personal"\n-                " portlets.",\n-            )\n-            IStatusMessage(self.request).add(message)\n-        return self.index()\n-\n-    @property\n-    def auth_token(self):\n-        return createToken()\n-\n-    @memoize\n-    def can_edit(self):\n-        return bool(\n-            getSecurityManager().checkPermission(\n-                "Portlets: Manage own portlets", self.context\n-            )\n-        )\n-\n-    @memoize\n-    def empty(self):\n-        dashboards = [\n-            getUtility(IPortletManager, name=name)\n-            for name in [\n-                "plone.dashboard1",\n-                "plone.dashboard2",\n-                "plone.dashboard3",\n-                "plone.dashboard4",\n-            ]\n-        ]\n-\n-        portal_membership = getToolByName(self.context, "portal_membership")\n-        member = portal_membership.getAuthenticatedMember()\n-        userid = member.getId()\n-\n-        num_portlets = 0\n-        for dashboard in dashboards:\n-            num_portlets += len(dashboard.get(USER_CATEGORY, {}).get(userid, {}))\n-            for groupid in member.getGroups():\n-                num_portlets += len(dashboard.get(GROUP_CATEGORY, {}).get(groupid, {}))\n-        return num_portlets == 0\ndiff --git a/plone/app/layout/dashboard/user_actions.pt b/plone/app/layout/dashboard/user_actions.pt\ndeleted file mode 100644\nindex ce532f1f..00000000\n--- a/plone/app/layout/dashboard/user_actions.pt\n+++ /dev/null\n@@ -1,35 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<head>\n-    <metal:block fill-slot="top_slot"\n-                 tal:define="dummy python:request.set(\'disable_border\',1);\n-                             disable_column_one python:request.set(\'disable_plone.leftcolumn\',1);\n-                             disable_column_two python:request.set(\'disable_plone.rightcolumn\',1);" />\n-</head>\n-\n-<body>\n-\n-<metal:main fill-slot="main">\n-<h1 i18n:translate="" class="documentFirstHeading">User Actions</h1>\n-<ul id="user-actions">\n-    <li tal:repeat="action view/user_actions">\n-        <a href=""\n-           tal:attributes="href action/url;\n-                           target action/link_target|nothing;\n-                           id string:personaltoolspage-${action/id};"\n-           tal:content="action/title"\n-           i18n:translate="">\n-            action title\n-        </a>\n-    </li>\n-</ul>\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/plone/app/layout/dashboard/user_actions.py b/plone/app/layout/dashboard/user_actions.py\ndeleted file mode 100644\nindex 64e10f96..00000000\n--- a/plone/app/layout/dashboard/user_actions.py\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-# -*- coding: utf-8 -*-\n-from Products.Five.browser import BrowserView\n-from zope.component import getMultiAdapter\n-\n-\n-class UserActionsView(BrowserView):\n-    """Power the useraction fallback page"""\n-\n-    def user_actions(self):\n-        context_state = getMultiAdapter(\n-            (self.context, self.request), name=u"plone_context_state"\n-        )\n-\n-        actions = context_state.actions("user")\n-        return actions\ndiff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex 9d74eb98..645b7dfd 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -3,7 +3,6 @@\n from Acquisition import aq_base\n from Acquisition import aq_inner\n from collections import defaultdict\n-from datetime import date\n from functools import total_ordering\n from plone.app.layout.globals.interfaces import IViewView\n from plone.app.layout.navigation.root import getNavigationRoot\n@@ -23,7 +22,7 @@\n from Products.CMFPlone.utils import safe_unicode\n from Products.Five.browser import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-from six.moves.urllib.parse import unquote\n+from urllib.parse import unquote\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.component import queryMultiAdapter\n@@ -32,15 +31,11 @@\n from zope.interface import alsoProvides\n from zope.interface import implementer\n from zope.viewlet.interfaces import IViewlet\n+from html import escape\n \n import json\n \n \n-try:\n-    from html import escape\n-except ImportError:\n-    from cgi import escape\n-\n \n @implementer(IViewlet)\n @total_ordering\n@@ -634,35 +629,6 @@ def locked_icon(self):\n         return icon.tag(title="Locked")\n \n \n-class ManagePortletsFallbackViewlet(ViewletBase):\n-    """Manage portlets fallback link that sits below content"""\n-\n-    index = ViewPageTemplateFile("manage_portlets_fallback.pt")\n-\n-    def update(self):\n-        plonelayout = getMultiAdapter(\n-            (self.context, self.request), name=u"plone_layout"\n-        )\n-        context_state = getMultiAdapter(\n-            (self.context, self.request), name=u"plone_context_state"\n-        )\n-\n-        self.portlet_assignable = context_state.portlet_assignable()\n-        self.sl = plonelayout.have_portlets("plone.leftcolumn", self.context)\n-        self.sr = plonelayout.have_portlets("plone.rightcolumn", self.context)\n-        self.object_url = context_state.object_url()\n-\n-    def available(self):\n-        secman = getSecurityManager()\n-        has_manage_portlets_permission = secman.checkPermission(\n-            "Portlets: Manage portlets", self.context\n-        )\n-        if not has_manage_portlets_permission:\n-            return False\n-        elif not self.sl and not self.sr and self.portlet_assignable:\n-            return True\n-\n-\n class PathBarViewlet(ViewletBase):\n     index = ViewPageTemplateFile("path_bar.pt")\n \n@@ -681,37 +647,3 @@ class TinyLogoViewlet(ViewletBase):\n     index = ViewPageTemplateFile("tiny_logo.pt")\n \n \n-class FooterViewlet(ViewletBase):\n-    index = ViewPageTemplateFile("footer.pt")\n-\n-    def update(self):\n-        super(FooterViewlet, self).update()\n-        self.year = date.today().year\n-\n-    def render_footer_portlets(self):\n-        """\n-        You might ask, why is this necessary. Well, let me tell you a story...\n-\n-        plone.app.portlets, in order to provide @@manage-portlets on a context,\n-        overrides the IPortletRenderer for the IManageContextualPortletsView\n-        view.\n-        See plone.portlets and plone.app.portlets\n-\n-        Seems fine right? Well, most of the time it is. Except, here.\n-        Previously, we were just using the syntax like\n-        `provider:plone.footerportlets` to render the footer portlets.\n-        Since this tal expression was inside a viewlet,\n-        the view is no longer IManageContextualPortletsView when\n-        visiting @@manage-portlets. Instead, it was IViewlet.\n-        See zope.contentprovider\n-\n-        In to fix this short coming, we render the portlet column by\n-        manually doing the multi adapter lookup and then manually\n-        doing the rendering for the content provider.\n-        See zope.contentprovider\n-        """\n-        portlet_manager = getMultiAdapter(\n-            (self.context, self.request, self.__parent__), name="plone.footerportlets"\n-        )\n-        portlet_manager.update()\n-        return portlet_manager.render()\ndiff --git a/plone/app/layout/viewlets/configure.zcml b/plone/app/layout/viewlets/configure.zcml\nindex 441948a9..5b541d7e 100644\n--- a/plone/app/layout/viewlets/configure.zcml\n+++ b/plone/app/layout/viewlets/configure.zcml\n@@ -286,16 +286,6 @@\n         permission="cmf.ModifyPortalContent"\n         />\n \n-    <!-- Manage portlets Fallback link -->\n-    <browser:viewlet\n-        name="plone.manage_portlets_fallback"\n-        for="plone.portlets.interfaces.ILocalPortletAssignable"\n-        view="plone.app.layout.globals.interfaces.IViewView"\n-        manager=".interfaces.IBelowContent"\n-        class=".common.ManagePortletsFallbackViewlet"\n-        permission="zope2.View"\n-        />\n-\n     <!-- The breadcrumbs -->\n     <browser:viewlet\n         name="plone.path_bar"\n@@ -362,15 +352,6 @@\n         permission="zope2.View"\n         />\n \n-    <!-- Footer -->\n-    <browser:viewlet\n-        name="plone.footer"\n-        for="*"\n-        manager=".interfaces.IPortalFooter"\n-        class=".common.FooterViewlet"\n-        permission="zope.Public"\n-        />\n-\n     <!-- Colophon -->\n     <browser:viewlet\n         name="plone.colophon"\ndiff --git a/plone/app/layout/viewlets/footer.pt b/plone/app/layout/viewlets/footer.pt\ndeleted file mode 100644\nindex df16ba9d..00000000\n--- a/plone/app/layout/viewlets/footer.pt\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-<div class="row">\n-\t<div class="col-xs-12">\n-\t\t<div tal:on-error="nothing" tal:replace="structure view/render_footer_portlets" />\n-\t</div>\n-</div>\ndiff --git a/plone/app/layout/viewlets/manage_portlets_fallback.pt b/plone/app/layout/viewlets/manage_portlets_fallback.pt\ndeleted file mode 100644\nindex ec5592d9..00000000\n--- a/plone/app/layout/viewlets/manage_portlets_fallback.pt\n+++ /dev/null\n@@ -1,14 +0,0 @@\n-<div tal:condition="view/available" class="row managePortlets-row">\n-\t<tal:comment tal:condition="nothing">\n-\t\t**********\n-\t\tNEEDED COL\n-\t\t**********\n-\t</tal:comment>\n-    <a class="managePortletsFallback"\n-        tal:attributes="href string:${view/object_url}/@@manage-portlets"\n-        i18n:domain="plone"\n-        i18n:translate="manage_portlets_link">\n-        Manage portlets\n-    </a>\n-\n-</div>\n\\ No newline at end of file\ndiff --git a/setup.py b/setup.py\nindex 6e55ca82..23de52a6 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -38,7 +38,6 @@\n         "Acquisition",\n         "DateTime",\n         "plone.app.content",\n-        "plone.app.portlets",\n         "plone.app.viewletmanager >=1.2",\n         "plone.batching >1.0.999",\n         "plone.i18n",\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2021-11-14T22:54:21+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/f04cc8f01efc06c52b307afacb34ad9efa87c4f9

add deprecated imports

Files changed:
A plone/app/layout/dashboard/__init__.py
A plone/app/layout/dashboard/dashboard.py
A plone/app/layout/dashboard/user_actions.py
M plone/app/layout/viewlets/common.py

b'diff --git a/plone/app/layout/dashboard/__init__.py b/plone/app/layout/dashboard/__init__.py\nnew file mode 100644\nindex 00000000..e69de29b\ndiff --git a/plone/app/layout/dashboard/dashboard.py b/plone/app/layout/dashboard/dashboard.py\nnew file mode 100644\nindex 00000000..d305b5a6\n--- /dev/null\n+++ b/plone/app/layout/dashboard/dashboard.py\n@@ -0,0 +1,3 @@\n+from zope.deprecation import moved\n+\n+moved("plone.app.portlets.dashboard.dashboard", "Version 5.0")\ndiff --git a/plone/app/layout/dashboard/user_actions.py b/plone/app/layout/dashboard/user_actions.py\nnew file mode 100644\nindex 00000000..8e0ce46e\n--- /dev/null\n+++ b/plone/app/layout/dashboard/user_actions.py\n@@ -0,0 +1,3 @@\n+from zope.deprecation import moved\n+\n+moved("plone.app.portlets.dashboard.user_actions", "Version 5.0")\ndiff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex 645b7dfd..8f3bfbfd 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -34,7 +34,14 @@\n from html import escape\n \n import json\n-\n+import zope.deferredimport\n+\n+zope.deferredimport.initialize()\n+zope.deferredimport.deprecated(\n+    "Import from plone.app.portlets.browser.viewlets instead",\n+    ManagePortletsFallbackViewlet=\'plone.app.portlets.browser.viewlets:baaz.ManagePortletsFallbackViewlet\',\n+    FooterViewlet=\'plone.app.portlets.browser.viewlets:baaz.FooterViewlet\',\n+)\n \n \n @implementer(IViewlet)\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2021-11-14T23:08:45+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/1ea9c993fa79a14d0e0ff37b3a21803c98d47b36

document changes

Files changed:
A news/268.breaking

b'diff --git a/news/268.breaking b/news/268.breaking\nnew file mode 100644\nindex 00000000..99ca0fb6\n--- /dev/null\n+++ b/news/268.breaking\n@@ -0,0 +1,4 @@\n+Move most (hard dependency) portlet related to `plone.app.portlets`:\n+Dashboard, Portlet related viewlets.\n+A first step towards a Portlet-as-an-Addon story.\n+[jensens]\n\\ No newline at end of file\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2021-11-15T15:05:06+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/555197bd3ff8ce0829e5b79b302593771c07adc8

Merge branch 'master' into refactor-portlet

Files changed:
A news/267.fix
M plone/app/layout/viewlets/path_bar.pt

b'diff --git a/news/267.fix b/news/267.fix\nnew file mode 100644\nindex 00000000..349a2af8\n--- /dev/null\n+++ b/news/267.fix\n@@ -0,0 +1,2 @@\n+Fix breadcrumb id.\n+[agitator]\n\\ No newline at end of file\ndiff --git a/plone/app/layout/viewlets/path_bar.pt b/plone/app/layout/viewlets/path_bar.pt\nindex bb4d3798..d6e60883 100644\n--- a/plone/app/layout/viewlets/path_bar.pt\n+++ b/plone/app/layout/viewlets/path_bar.pt\n@@ -1,5 +1,5 @@\n \n-<nav id="plone-breadcrumb" i18n:attributes="label_breadcrumb" aria-label="breadcrumb" i18n:domain="plone" tal:define="breadcrumbs python:view.breadcrumbs">\n+<nav id="portal-breadcrumbs" i18n:attributes="label_breadcrumb" aria-label="breadcrumb" i18n:domain="plone" tal:define="breadcrumbs python:view.breadcrumbs">\n   <div class="container">\n     <ol class="breadcrumb">\n       <li class="breadcrumb-item"><a i18n:translate="tabs_home" href="${python:view.navigation_root_url}">Home</a></li>\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2021-11-16T17:10:00+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/33d96d84c34e8da7569f41fb5c35fb357c93a669

fix typo

Files changed:
M plone/app/layout/viewlets/common.py

b'diff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex 8f3bfbfd..a17cff4c 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -39,8 +39,8 @@\n zope.deferredimport.initialize()\n zope.deferredimport.deprecated(\n     "Import from plone.app.portlets.browser.viewlets instead",\n-    ManagePortletsFallbackViewlet=\'plone.app.portlets.browser.viewlets:baaz.ManagePortletsFallbackViewlet\',\n-    FooterViewlet=\'plone.app.portlets.browser.viewlets:baaz.FooterViewlet\',\n+    ManagePortletsFallbackViewlet=\'plone.app.portlets.browser.viewlets:ManagePortletsFallbackViewlet\',\n+    FooterViewlet=\'plone.app.portlets.browser.viewlets:FooterViewlet\',\n )\n \n \n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2021-11-18T22:30:17+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/bd1e01c3c63d903808946bb4aed0587056161176

Merge branch 'master' into refactor-portlet

Files changed:
A news/270.breaking
A news/271.bugfix
M plone/app/layout/globals/interfaces.py
M plone/app/layout/globals/layout.py

b'diff --git a/news/270.breaking b/news/270.breaking\nnew file mode 100644\nindex 00000000..93cc8a42\n--- /dev/null\n+++ b/news/270.breaking\n@@ -0,0 +1 @@\n+Remove long deprecated ``getIcon``` from layout-policy. [jensens]\ndiff --git a/news/271.bugfix b/news/271.bugfix\nnew file mode 100644\nindex 00000000..d5bc1726\n--- /dev/null\n+++ b/news/271.bugfix\n@@ -0,0 +1,2 @@\n+Micro optimizations at visibility in layoutpolicy [jensens]\n+\ndiff --git a/plone/app/layout/globals/interfaces.py b/plone/app/layout/globals/interfaces.py\nindex 5cbe5b52..61413a7f 100644\n--- a/plone/app/layout/globals/interfaces.py\n+++ b/plone/app/layout/globals/interfaces.py\n@@ -61,17 +61,6 @@ def have_portlets(manager_name, view=None):\n     def icons_visible():\n         """Returns True if icons should be shown or False otherwise."""\n \n-    def getIcon(item):\n-        """\n-        deprecated for Plone > 5.0 see\n-        https://github.com/plone/Products.CMFPlone/issues/1151\n-        Returns an object which implements the IContentIcon interface and\n-        provides the informations necessary to render an icon. The item\n-        parameter needs to be adaptable to IContentIcon. Icons can be disabled\n-        globally or just for anonymous users with the icon_visibility property\n-        in site_properties.\n-        """\n-\n     def bodyClass(template, view):\n         """Returns the CSS class to be used on the body tag."""\n \ndiff --git a/plone/app/layout/globals/layout.py b/plone/app/layout/globals/layout.py\nindex f523a5cd..c85f66ca 100644\n--- a/plone/app/layout/globals/layout.py\n+++ b/plone/app/layout/globals/layout.py\n@@ -1,8 +1,7 @@\n-# -*- coding: utf-8 -*-\n+from AccessControl import getSecurityManager\n from plone.app.layout.globals.interfaces import IBodyClassAdapter\n from plone.app.layout.globals.interfaces import ILayoutPolicy\n from plone.app.layout.globals.interfaces import IViewView\n-from plone.app.layout.icons.interfaces import IContentIcon\n from plone.i18n.normalizer.interfaces import IIDNormalizer\n from plone.memoize.view import memoize\n from plone.portlets.interfaces import IPortletManager\n@@ -22,7 +21,6 @@\n from zope.component import getUtility\n from zope.component import queryMultiAdapter\n from zope.component import queryUtility\n-from zope.deprecation import deprecate\n from zope.interface import alsoProvides\n from zope.interface import implementer\n from zope.interface import Interface\n@@ -38,7 +36,6 @@\n     ViewMixinForTemplates,\n )\n \n-\n @implementer(ILayoutPolicy)\n class LayoutPolicy(BrowserView):\n     """A view that gives access to various layout related functions."""\n@@ -93,59 +90,27 @@ def have_portlets(self, manager_name, view=None):\n \n         return renderer.visible\n \n-    @memoize\n-    def icons_visible(self):\n-        """Returns True if icons should be shown or False otherwise."""\n-        context = self.context\n-        membership = getToolByName(context, "portal_membership")\n-        anon = membership.isAnonymousUser()\n-\n+    def _image_visibility(self, name):\n+        """check if image {name} is visible with current settings and user"""\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n-        icon_visibility = settings.icon_visibility\n-\n-        if icon_visibility == "enabled":\n+        visibility = getattr(settings, f"{name}_visibility")\n+        if visibility == "enabled":\n             return True\n-        elif icon_visibility == "authenticated" and not anon:\n-            return True\n-        else:\n+        if visibility != "authenticated":\n             return False\n+        user = getSecurityManager().getUser()\n+        return user is not None and user.getUserName() != \'Anonymous User\'\n+\n+    @memoize\n+    def icons_visible(self):\n+        """Returns True if icons should be shown or False otherwise."""\n+        return self._image_visibility("icon")\n \n     @memoize\n     def thumb_visible(self):\n         """Returns True if thumbs should be shown or False otherwise."""\n-        context = self.context\n-        membership = getToolByName(context, "portal_membership")\n-        anon = membership.isAnonymousUser()\n-        registry = getUtility(IRegistry)\n-        settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n-        thumb_visibility = settings.thumb_visibility\n-\n-        if thumb_visibility == "enabled":\n-            return True\n-        elif thumb_visibility == "authenticated" and not anon:\n-            return True\n-        else:\n-            return False\n-\n-    @deprecate(\n-        "deprecated since Plone 4, ContentIcons are rendered as Fonts now see"\n-        "https://docs.plone.org/develop/addons/index.html"\n-        "#upgrading-to-plone-5-1."\n-    )\n-    def getIcon(self, item):\n-        """Returns an object which implements the IContentIcon interface and\n-        provides the informations necessary to render an icon. The item\n-        parameter needs to be adaptable to IContentIcon. Icons can be disabled\n-        globally or just for anonymous users with the icon_visibility property\n-        in site_properties.\n-        """\n-        context = self.context\n-        if not self.icons_visible():\n-            icon = getMultiAdapter((context, self.request, None), IContentIcon)\n-        else:\n-            icon = getMultiAdapter((context, self.request, item), IContentIcon)\n-        return icon\n+        return self._image_visibility("thumb")\n \n     def _toolbar_classes(self):\n         """current toolbar controlling classes"""\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2021-11-19T09:39:51+01:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/8b613fee36b7754eab01425b52a382390beae9e2

Merge pull request #268 from plone/refactor-portlet

Move all portlet related to p.a.portlets

Files changed:
A news/268.breaking
M plone/app/layout/configure.zcml
M plone/app/layout/dashboard/__init__.py
M plone/app/layout/dashboard/dashboard.py
M plone/app/layout/dashboard/user_actions.py
M plone/app/layout/viewlets/common.py
M plone/app/layout/viewlets/configure.zcml
M setup.py
D plone/app/layout/dashboard/configure.zcml
D plone/app/layout/dashboard/dashboard.pt
D plone/app/layout/dashboard/user_actions.pt
D plone/app/layout/viewlets/footer.pt
D plone/app/layout/viewlets/manage_portlets_fallback.pt

b'diff --git a/news/268.breaking b/news/268.breaking\nnew file mode 100644\nindex 00000000..99ca0fb6\n--- /dev/null\n+++ b/news/268.breaking\n@@ -0,0 +1,4 @@\n+Move most (hard dependency) portlet related to `plone.app.portlets`:\n+Dashboard, Portlet related viewlets.\n+A first step towards a Portlet-as-an-Addon story.\n+[jensens]\n\\ No newline at end of file\ndiff --git a/plone/app/layout/configure.zcml b/plone/app/layout/configure.zcml\nindex c960b763..7ef16a7e 100644\n--- a/plone/app/layout/configure.zcml\n+++ b/plone/app/layout/configure.zcml\n@@ -10,7 +10,6 @@\n     <include package=".icons" />\n     <include package=".links" />\n     <include package=".sitemap" />\n-    <include package=".dashboard" />\n     <include package=".analytics" />\n \n     <include file="permissions.zcml" />\ndiff --git a/plone/app/layout/dashboard/__init__.py b/plone/app/layout/dashboard/__init__.py\nindex 40a96afc..e69de29b 100644\n--- a/plone/app/layout/dashboard/__init__.py\n+++ b/plone/app/layout/dashboard/__init__.py\n@@ -1 +0,0 @@\n-# -*- coding: utf-8 -*-\ndiff --git a/plone/app/layout/dashboard/configure.zcml b/plone/app/layout/dashboard/configure.zcml\ndeleted file mode 100644\nindex 430d6d75..00000000\n--- a/plone/app/layout/dashboard/configure.zcml\n+++ /dev/null\n@@ -1,24 +0,0 @@\n-<configure\n-    xmlns="http://namespaces.zope.org/zope"\n-    xmlns:browser="http://namespaces.zope.org/browser">\n-\n-    <include package="plone.app.portlets" />\n-\n-    <browser:page\n-        for="plone.app.layout.navigation.interfaces.INavigationRoot"\n-        name="dashboard"\n-        permission="plone.app.portlets.ViewDashboard"\n-        class=".dashboard.DashboardView"\n-        template="dashboard.pt"\n-        />\n-\n-    <!-- this view provides a not-js fallback for the user dropdown menu.\n-    It has been placed here to be near the personal bar code -->\n-    <browser:page\n-        for="plone.app.layout.navigation.interfaces.INavigationRoot"\n-        name="useractions"\n-        permission="zope2.View"\n-        class=".user_actions.UserActionsView"\n-        template="user_actions.pt"\n-        />\n-</configure>\ndiff --git a/plone/app/layout/dashboard/dashboard.pt b/plone/app/layout/dashboard/dashboard.pt\ndeleted file mode 100644\nindex 71de849a..00000000\n--- a/plone/app/layout/dashboard/dashboard.pt\n+++ /dev/null\n@@ -1,70 +0,0 @@\n-<html\n-    xmlns="http://www.w3.org/1999/xhtml"\n-    xml:lang="en"\n-    xmlns:tal="http://xml.zope.org/namespaces/tal"\n-    xmlns:metal="http://xml.zope.org/namespaces/metal"\n-    xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-    lang="en"\n-    metal:use-macro="context/main_template/macros/master"\n-    i18n:domain="plone">\n-\n-  <body>\n-\n-    <metal:b fill-slot="content-title">\n-      <h1\n-          class="documentFirstHeading"\n-          i18n:translate="heading_dashboard"\n-          tal:define="memberinfo context/portal_membership/getMemberInfo;\n-                  member context/@@plone_portal_state/member;\n-                  name python:memberinfo[\'fullname\'] or member.getId() or member.getId()">\n-        <span\n-            tal:replace="name"\n-            i18n:name="user_name" />\n-        &#8217;s dashboard\n-      </h1>\n-    </metal:b>\n-\n-    <metal:b fill-slot="content-core">\n-      <tal:b metal:define-macro="content-core">\n-\n-        <div class="autotabs">\n-          <nav class="autotoc-nav nav nav-tabs mb-3">\n-            <span class="nav-item">\n-              <a\n-                  class="active nav-link"\n-                  href="${context/@@plone_portal_state/navigation_root_url}/dashboard"\n-                  i18n:translate="label_dashboard">Dashboard</a>\n-            </span>\n-            <span class="nav-item">\n-              <a\n-                  href="${context/@@plone_portal_state/navigation_root_url}/@@manage-dashboard?_authenticator=${view/auth_token}"\n-                  class="nav-link"\n-                  i18n:translate="label_edit">Edit</a>\n-            </span>\n-          </nav>\n-\n-\n-          <div\n-              id="dashboard"\n-              class="row row-cols-1 row-cols-md-2 gy-2">\n-            <div\n-                id="dashboard-portlets1"\n-                tal:content="structure provider:plone.dashboard1" />\n-            <div\n-                id="dashboard-portlets2"\n-                tal:content="structure provider:plone.dashboard2" />\n-            <div\n-                id="dashboard-portlets3"\n-                tal:content="structure provider:plone.dashboard3" />\n-            <div\n-                id="dashboard-portlets4"\n-                tal:content="structure provider:plone.dashboard4" />\n-          </div>\n-\n-        </div>\n-\n-      </tal:b>\n-    </metal:b>\n-\n-  </body>\n-</html>\ndiff --git a/plone/app/layout/dashboard/dashboard.py b/plone/app/layout/dashboard/dashboard.py\nindex abc42837..d305b5a6 100644\n--- a/plone/app/layout/dashboard/dashboard.py\n+++ b/plone/app/layout/dashboard/dashboard.py\n@@ -1,72 +1,3 @@\n-# -*- coding: utf-8 -*-\n-from AccessControl import getSecurityManager\n-from plone.memoize.instance import memoize\n-from plone.portlets.constants import GROUP_CATEGORY\n-from plone.portlets.constants import USER_CATEGORY\n-from plone.portlets.interfaces import IPortletManager\n-from plone.protect.authenticator import createToken\n-from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n-from Products.Five.browser import BrowserView\n-from Products.statusmessages.interfaces import IStatusMessage\n-from zope.component import getUtility\n-from zope.interface import implementer\n-from zope.interface import Interface\n+from zope.deprecation import moved\n \n-\n-class IDashboard(Interface):\n-    """the dashboard display columns of portlet to the loggedin user"""\n-\n-\n-@implementer(IDashboard)\n-class DashboardView(BrowserView):\n-    """Power the dashboard"""\n-\n-    def __call__(self):\n-        self.request.set("disable_border", 1)\n-        self.request.set("disable_plone.leftcolumn", 1)\n-        self.request.set("disable_plone.rightcolumn", 1)\n-        if self.can_edit() and self.empty():\n-            message = _(\n-                u"info_empty_dashboard",\n-                default=u"Your dashboard is currently empty. Click the"\n-                " <em>edit</em> tab to assign some personal"\n-                " portlets.",\n-            )\n-            IStatusMessage(self.request).add(message)\n-        return self.index()\n-\n-    @property\n-    def auth_token(self):\n-        return createToken()\n-\n-    @memoize\n-    def can_edit(self):\n-        return bool(\n-            getSecurityManager().checkPermission(\n-                "Portlets: Manage own portlets", self.context\n-            )\n-        )\n-\n-    @memoize\n-    def empty(self):\n-        dashboards = [\n-            getUtility(IPortletManager, name=name)\n-            for name in [\n-                "plone.dashboard1",\n-                "plone.dashboard2",\n-                "plone.dashboard3",\n-                "plone.dashboard4",\n-            ]\n-        ]\n-\n-        portal_membership = getToolByName(self.context, "portal_membership")\n-        member = portal_membership.getAuthenticatedMember()\n-        userid = member.getId()\n-\n-        num_portlets = 0\n-        for dashboard in dashboards:\n-            num_portlets += len(dashboard.get(USER_CATEGORY, {}).get(userid, {}))\n-            for groupid in member.getGroups():\n-                num_portlets += len(dashboard.get(GROUP_CATEGORY, {}).get(groupid, {}))\n-        return num_portlets == 0\n+moved("plone.app.portlets.dashboard.dashboard", "Version 5.0")\ndiff --git a/plone/app/layout/dashboard/user_actions.pt b/plone/app/layout/dashboard/user_actions.pt\ndeleted file mode 100644\nindex ce532f1f..00000000\n--- a/plone/app/layout/dashboard/user_actions.pt\n+++ /dev/null\n@@ -1,35 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<head>\n-    <metal:block fill-slot="top_slot"\n-                 tal:define="dummy python:request.set(\'disable_border\',1);\n-                             disable_column_one python:request.set(\'disable_plone.leftcolumn\',1);\n-                             disable_column_two python:request.set(\'disable_plone.rightcolumn\',1);" />\n-</head>\n-\n-<body>\n-\n-<metal:main fill-slot="main">\n-<h1 i18n:translate="" class="documentFirstHeading">User Actions</h1>\n-<ul id="user-actions">\n-    <li tal:repeat="action view/user_actions">\n-        <a href=""\n-           tal:attributes="href action/url;\n-                           target action/link_target|nothing;\n-                           id string:personaltoolspage-${action/id};"\n-           tal:content="action/title"\n-           i18n:translate="">\n-            action title\n-        </a>\n-    </li>\n-</ul>\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/plone/app/layout/dashboard/user_actions.py b/plone/app/layout/dashboard/user_actions.py\nindex 64e10f96..8e0ce46e 100644\n--- a/plone/app/layout/dashboard/user_actions.py\n+++ b/plone/app/layout/dashboard/user_actions.py\n@@ -1,15 +1,3 @@\n-# -*- coding: utf-8 -*-\n-from Products.Five.browser import BrowserView\n-from zope.component import getMultiAdapter\n+from zope.deprecation import moved\n \n-\n-class UserActionsView(BrowserView):\n-    """Power the useraction fallback page"""\n-\n-    def user_actions(self):\n-        context_state = getMultiAdapter(\n-            (self.context, self.request), name=u"plone_context_state"\n-        )\n-\n-        actions = context_state.actions("user")\n-        return actions\n+moved("plone.app.portlets.dashboard.user_actions", "Version 5.0")\ndiff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex 9d74eb98..a17cff4c 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -3,7 +3,6 @@\n from Acquisition import aq_base\n from Acquisition import aq_inner\n from collections import defaultdict\n-from datetime import date\n from functools import total_ordering\n from plone.app.layout.globals.interfaces import IViewView\n from plone.app.layout.navigation.root import getNavigationRoot\n@@ -23,7 +22,7 @@\n from Products.CMFPlone.utils import safe_unicode\n from Products.Five.browser import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-from six.moves.urllib.parse import unquote\n+from urllib.parse import unquote\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.component import queryMultiAdapter\n@@ -32,14 +31,17 @@\n from zope.interface import alsoProvides\n from zope.interface import implementer\n from zope.viewlet.interfaces import IViewlet\n+from html import escape\n \n import json\n+import zope.deferredimport\n \n-\n-try:\n-    from html import escape\n-except ImportError:\n-    from cgi import escape\n+zope.deferredimport.initialize()\n+zope.deferredimport.deprecated(\n+    "Import from plone.app.portlets.browser.viewlets instead",\n+    ManagePortletsFallbackViewlet=\'plone.app.portlets.browser.viewlets:ManagePortletsFallbackViewlet\',\n+    FooterViewlet=\'plone.app.portlets.browser.viewlets:FooterViewlet\',\n+)\n \n \n @implementer(IViewlet)\n@@ -634,35 +636,6 @@ def locked_icon(self):\n         return icon.tag(title="Locked")\n \n \n-class ManagePortletsFallbackViewlet(ViewletBase):\n-    """Manage portlets fallback link that sits below content"""\n-\n-    index = ViewPageTemplateFile("manage_portlets_fallback.pt")\n-\n-    def update(self):\n-        plonelayout = getMultiAdapter(\n-            (self.context, self.request), name=u"plone_layout"\n-        )\n-        context_state = getMultiAdapter(\n-            (self.context, self.request), name=u"plone_context_state"\n-        )\n-\n-        self.portlet_assignable = context_state.portlet_assignable()\n-        self.sl = plonelayout.have_portlets("plone.leftcolumn", self.context)\n-        self.sr = plonelayout.have_portlets("plone.rightcolumn", self.context)\n-        self.object_url = context_state.object_url()\n-\n-    def available(self):\n-        secman = getSecurityManager()\n-        has_manage_portlets_permission = secman.checkPermission(\n-            "Portlets: Manage portlets", self.context\n-        )\n-        if not has_manage_portlets_permission:\n-            return False\n-        elif not self.sl and not self.sr and self.portlet_assignable:\n-            return True\n-\n-\n class PathBarViewlet(ViewletBase):\n     index = ViewPageTemplateFile("path_bar.pt")\n \n@@ -681,37 +654,3 @@ class TinyLogoViewlet(ViewletBase):\n     index = ViewPageTemplateFile("tiny_logo.pt")\n \n \n-class FooterViewlet(ViewletBase):\n-    index = ViewPageTemplateFile("footer.pt")\n-\n-    def update(self):\n-        super(FooterViewlet, self).update()\n-        self.year = date.today().year\n-\n-    def render_footer_portlets(self):\n-        """\n-        You might ask, why is this necessary. Well, let me tell you a story...\n-\n-        plone.app.portlets, in order to provide @@manage-portlets on a context,\n-        overrides the IPortletRenderer for the IManageContextualPortletsView\n-        view.\n-        See plone.portlets and plone.app.portlets\n-\n-        Seems fine right? Well, most of the time it is. Except, here.\n-        Previously, we were just using the syntax like\n-        `provider:plone.footerportlets` to render the footer portlets.\n-        Since this tal expression was inside a viewlet,\n-        the view is no longer IManageContextualPortletsView when\n-        visiting @@manage-portlets. Instead, it was IViewlet.\n-        See zope.contentprovider\n-\n-        In to fix this short coming, we render the portlet column by\n-        manually doing the multi adapter lookup and then manually\n-        doing the rendering for the content provider.\n-        See zope.contentprovider\n-        """\n-        portlet_manager = getMultiAdapter(\n-            (self.context, self.request, self.__parent__), name="plone.footerportlets"\n-        )\n-        portlet_manager.update()\n-        return portlet_manager.render()\ndiff --git a/plone/app/layout/viewlets/configure.zcml b/plone/app/layout/viewlets/configure.zcml\nindex 441948a9..5b541d7e 100644\n--- a/plone/app/layout/viewlets/configure.zcml\n+++ b/plone/app/layout/viewlets/configure.zcml\n@@ -286,16 +286,6 @@\n         permission="cmf.ModifyPortalContent"\n         />\n \n-    <!-- Manage portlets Fallback link -->\n-    <browser:viewlet\n-        name="plone.manage_portlets_fallback"\n-        for="plone.portlets.interfaces.ILocalPortletAssignable"\n-        view="plone.app.layout.globals.interfaces.IViewView"\n-        manager=".interfaces.IBelowContent"\n-        class=".common.ManagePortletsFallbackViewlet"\n-        permission="zope2.View"\n-        />\n-\n     <!-- The breadcrumbs -->\n     <browser:viewlet\n         name="plone.path_bar"\n@@ -362,15 +352,6 @@\n         permission="zope2.View"\n         />\n \n-    <!-- Footer -->\n-    <browser:viewlet\n-        name="plone.footer"\n-        for="*"\n-        manager=".interfaces.IPortalFooter"\n-        class=".common.FooterViewlet"\n-        permission="zope.Public"\n-        />\n-\n     <!-- Colophon -->\n     <browser:viewlet\n         name="plone.colophon"\ndiff --git a/plone/app/layout/viewlets/footer.pt b/plone/app/layout/viewlets/footer.pt\ndeleted file mode 100644\nindex df16ba9d..00000000\n--- a/plone/app/layout/viewlets/footer.pt\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-<div class="row">\n-\t<div class="col-xs-12">\n-\t\t<div tal:on-error="nothing" tal:replace="structure view/render_footer_portlets" />\n-\t</div>\n-</div>\ndiff --git a/plone/app/layout/viewlets/manage_portlets_fallback.pt b/plone/app/layout/viewlets/manage_portlets_fallback.pt\ndeleted file mode 100644\nindex ec5592d9..00000000\n--- a/plone/app/layout/viewlets/manage_portlets_fallback.pt\n+++ /dev/null\n@@ -1,14 +0,0 @@\n-<div tal:condition="view/available" class="row managePortlets-row">\n-\t<tal:comment tal:condition="nothing">\n-\t\t**********\n-\t\tNEEDED COL\n-\t\t**********\n-\t</tal:comment>\n-    <a class="managePortletsFallback"\n-        tal:attributes="href string:${view/object_url}/@@manage-portlets"\n-        i18n:domain="plone"\n-        i18n:translate="manage_portlets_link">\n-        Manage portlets\n-    </a>\n-\n-</div>\n\\ No newline at end of file\ndiff --git a/setup.py b/setup.py\nindex 6e55ca82..23de52a6 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -38,7 +38,6 @@\n         "Acquisition",\n         "DateTime",\n         "plone.app.content",\n-        "plone.app.portlets",\n         "plone.app.viewletmanager >=1.2",\n         "plone.batching >1.0.999",\n         "plone.i18n",\n'

