Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-04-14T11:43:48+02:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/45bd7db88ce578a76e1510ef7fe720ce1fb17c37

Fix #1462 use full path for url() when aggregating CSS

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 30f7efe..312ae09 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -52,6 +52,9 @@ Fixes:
 - Fix bundle aggregation when bundle has no CSS (or no JS)
   [ebrehault]
 
+- Fix relative url in CSS in bundle aggregation
+  [ebrehault]
+
 
 5.1a1 (2016-03-31)
 ------------------
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 10fa079..1a799f6 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -89,12 +89,13 @@ def write_css(context, folder, meta_bundle):
     for bundle in bundles.values():
         if bundle.merge_with == meta_bundle and bundle.csscompilation:
             css = get_resource(context, bundle.csscompilation)
-            # Preserve relative urls:
-            # we prefix with '../'' any url not starting with '/'
-            # or http: or data:
+            (path, sep, filename) = bundle.csscompilation.rpartition('/')
+            # Process relative urls:
+            # we prefix with current resource path any url not starting with
+            # '/' or http: or data:
             css = re.sub(
                 r"""(url\(['"]?(?!['"]?([a-z]+:|\/)))""",
-                r'\1../',
+                r'\1%s/' % path,
                 css)
             resources.append(css)
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-04-14T14:30:37+02:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/78f894e5315f20d5353ebdfe1a89120775245fd5

Merge pull request #1528 from plone/fix-bundle-relative-urls

Fix #1462 use full path for url() when aggregating CSS

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 30f7efe..312ae09 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -52,6 +52,9 @@ Fixes:
 - Fix bundle aggregation when bundle has no CSS (or no JS)
   [ebrehault]
 
+- Fix relative url in CSS in bundle aggregation
+  [ebrehault]
+
 
 5.1a1 (2016-03-31)
 ------------------
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 10fa079..1a799f6 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -89,12 +89,13 @@ def write_css(context, folder, meta_bundle):
     for bundle in bundles.values():
         if bundle.merge_with == meta_bundle and bundle.csscompilation:
             css = get_resource(context, bundle.csscompilation)
-            # Preserve relative urls:
-            # we prefix with '../'' any url not starting with '/'
-            # or http: or data:
+            (path, sep, filename) = bundle.csscompilation.rpartition('/')
+            # Process relative urls:
+            # we prefix with current resource path any url not starting with
+            # '/' or http: or data:
             css = re.sub(
                 r"""(url\(['"]?(?!['"]?([a-z]+:|\/)))""",
-                r'\1../',
+                r'\1%s/' % path,
                 css)
             resources.append(css)
 


