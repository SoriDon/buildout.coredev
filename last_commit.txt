Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2015-12-08T17:16:56-06:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/1c6dff08669f83030f53911dcc1f0e4e1bbc132b

Handle links that do not have an intid yet. Should help with
  upgrade issues.

Files changed:
M CHANGES.rst
M plone/app/linkintegrity/handlers.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 07a083b..8648edb 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,9 @@ New:
 
 Fixes:
 
-- *add item here*
+- Handle links that do not have an intid yet. Should help with
+  upgrade issues.
+  [vangheem]
 
 
 3.0.3 (2015-11-26)
diff --git a/plone/app/linkintegrity/handlers.py b/plone/app/linkintegrity/handlers.py
index 3987284..999d1e0 100644
--- a/plone/app/linkintegrity/handlers.py
+++ b/plone/app/linkintegrity/handlers.py
@@ -84,7 +84,17 @@ def getObjectsFromLinks(base, links):
 
             obj, extra = findObject(base, path)
             if obj and not IPloneSiteRoot.providedBy(obj):
-                objid = intids.getId(obj)
+                try:
+                    objid = intids.getId(obj)
+                except KeyError:
+                    try:
+                        intids.register(obj)
+                        objid = intids.getId(obj)
+                    except NotYet:
+                        # if we get a NotYet error, the object is not
+                        # attached yet and we will need to get links
+                        # at a later time when the object has an intid
+                        continue
                 relation = RelationValue(objid)
                 objects.add(relation)
     return objects


Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2015-12-09T08:27:35+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/4c926efb0ef7530151e38309735cd3200a8ef63e

Merge pull request #33 from plone/links-no-intid

Handle links that do not have an intid yet

Files changed:
M CHANGES.rst
M plone/app/linkintegrity/handlers.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 07a083b..8648edb 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,9 @@ New:
 
 Fixes:
 
-- *add item here*
+- Handle links that do not have an intid yet. Should help with
+  upgrade issues.
+  [vangheem]
 
 
 3.0.3 (2015-11-26)
diff --git a/plone/app/linkintegrity/handlers.py b/plone/app/linkintegrity/handlers.py
index 3987284..999d1e0 100644
--- a/plone/app/linkintegrity/handlers.py
+++ b/plone/app/linkintegrity/handlers.py
@@ -84,7 +84,17 @@ def getObjectsFromLinks(base, links):
 
             obj, extra = findObject(base, path)
             if obj and not IPloneSiteRoot.providedBy(obj):
-                objid = intids.getId(obj)
+                try:
+                    objid = intids.getId(obj)
+                except KeyError:
+                    try:
+                        intids.register(obj)
+                        objid = intids.getId(obj)
+                    except NotYet:
+                        # if we get a NotYet error, the object is not
+                        # attached yet and we will need to get links
+                        # at a later time when the object has an intid
+                        continue
                 relation = RelationValue(objid)
                 objects.add(relation)
     return objects


