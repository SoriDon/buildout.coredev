Repository: mockup


Branch: refs/heads/master
Date: 2017-06-18T00:26:08+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/mockup/commit/77a0e1767e5f6661233f57386693beb1a866e1c8

Upload pattern: authenticator token
Upload pattern: Fix missing plone.protect authenticator token which led to broken uploads.

Files changed:
M CHANGES.rst
M mockup/patterns/upload/pattern.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 26ed1ab3..afc134b8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -50,6 +50,9 @@ New features:
 
 Bug fixes:
 
+- Upload pattern: Fix missing plone.protect authenticator token which led to broken uploads.
+  [thet]
+
 - In the insert link/image modal, pass use the correct related items widget options from the ``linkModal`` attribute.
   [thet]
 
diff --git a/mockup/patterns/upload/pattern.js b/mockup/patterns/upload/pattern.js
index 554efb5b..87e05c25 100644
--- a/mockup/patterns/upload/pattern.js
+++ b/mockup/patterns/upload/pattern.js
@@ -48,9 +48,9 @@ define([
   'dropzone',
   'text!mockup-patterns-upload-url/templates/upload.xml',
   'text!mockup-patterns-upload-url/templates/preview.xml',
+  'mockup-utils',
   'translate'
-], function($, _, Base, RelatedItems, Dropzone,
-            UploadTemplate, PreviewTemplate, _t) {
+], function($, _, Base, RelatedItems, Dropzone, UploadTemplate, PreviewTemplate, utils, _t) {
   'use strict';
 
   /* we do not want this plugin to auto discover */
@@ -341,6 +341,10 @@ define([
       var options = $.extend({}, self.options);
       options.url = self.getUrl();
 
+      options.headers = {
+        'X-CSRF-TOKEN': utils.getAuthenticator()
+      };
+
       // XXX force to only upload one to the server at a time,
       // right now we don't support multiple for backends
       options.uploadMultiple = false;
@@ -442,7 +446,8 @@ define([
       window.tus.upload(file, {
         endpoint: self.dropzone.options.url,
         headers: {
-          'FILENAME': file.name
+          'FILENAME': file.name,
+          'X-CSRF-TOKEN': utils.getAuthenticator()
         },
         chunkSize: chunkSize
       }).fail(function() {


Repository: mockup


Branch: refs/heads/master
Date: 2017-06-19T09:23:15+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/mockup/commit/49bec927203ae0f7ca803337d639a64ab6df79e6

Merge branch 'master' into thet-fix-upload-authenticator

Files changed:
M CHANGES.rst
M mockup/patterns/formunloadalert/pattern.js
M mockup/patterns/modal/pattern.js
M mockup/patterns/structure/templates/tablerow.xml
M mockup/tests/pattern-structure-test.js

diff --git a/CHANGES.rst b/CHANGES.rst
index afc134b8..e57d16a7 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -53,6 +53,19 @@ Bug fixes:
 - Upload pattern: Fix missing plone.protect authenticator token which led to broken uploads.
   [thet]
 
+- fixed css-classes for thumb scales ...
+  https://github.com/plone/Products.CMFPlone/issues/2077
+  [fgrcon]
+
+- modal: Fixed duplicate window.confirm on form unload.
+  Fixes `issue 777 <https://github.com/plone/mockup/issues/777>`_.
+  [seanupton]
+
+- formunloadalert: Fixed incorrect use of Function.prototype.apply,
+  when call() was seemingly intended; fixes case where modal close leads to
+  exception.  Fixes `issue 776 <https://github.com/plone/mockup/issues/776>`_.
+  [seanupton]
+
 - In the insert link/image modal, pass use the correct related items widget options from the ``linkModal`` attribute.
   [thet]
 
diff --git a/mockup/patterns/formunloadalert/pattern.js b/mockup/patterns/formunloadalert/pattern.js
index 1988efaa..f79d3992 100644
--- a/mockup/patterns/formunloadalert/pattern.js
+++ b/mockup/patterns/formunloadalert/pattern.js
@@ -65,7 +65,7 @@ define([
         $modal.data('patternPloneModal').on('hide', function(e) {
           var modal = $modal.data('patternPloneModal');
           if (modal) {
-            modal._suppressHide = self._handleUnload.apply(self, e);
+            modal._suppressHide = self._handleUnload.call(self, e);
           }
         });
       } else {
diff --git a/mockup/patterns/modal/pattern.js b/mockup/patterns/modal/pattern.js
index 21673a4f..c3dbadea 100644
--- a/mockup/patterns/modal/pattern.js
+++ b/mockup/patterns/modal/pattern.js
@@ -872,6 +872,7 @@ define([
       }
       self.$wrapper.remove();
       if ($('.plone-modal', $('body')).size() < 1) {
+        self._suppressHide = undefined;
         self.backdrop.hide();
         $('body').removeClass('plone-modal-open');
         $(window.parent).off('resize.plone-modal.patterns');
diff --git a/mockup/patterns/structure/templates/tablerow.xml b/mockup/patterns/structure/templates/tablerow.xml
index 82215a26..cffb48d5 100644
--- a/mockup/patterns/structure/templates/tablerow.xml
+++ b/mockup/patterns/structure/templates/tablerow.xml
@@ -28,7 +28,7 @@
     <% } %>
   </div>
   <% if(attributes["getIcon"] && thumb_scale) { %>
-    <img class="image-<%- thumb_scale %> pull-right" src="<%- getURL %>/@@images/image/<%- thumb_scale %>">
+    <img class="thumb-<%- thumb_scale %> pull-right" src="<%- getURL %>/@@images/image/<%- thumb_scale %>">
   <% } %>
 </td>
 
diff --git a/mockup/tests/pattern-structure-test.js b/mockup/tests/pattern-structure-test.js
index e018c652..dcf2b148 100644
--- a/mockup/tests/pattern-structure-test.js
+++ b/mockup/tests/pattern-structure-test.js
@@ -628,7 +628,7 @@ define([
       var el = row.render().el;
 
       expect($('.title img', el).length).to.equal(1);
-      expect($('.title img', el).attr('class')).to.have.string('image-tile');
+      expect($('.title img', el).attr('class')).to.have.string('thumb-tile');
     });
 
     it('should display no icon for contents without images', function() {


Repository: mockup


Branch: refs/heads/master
Date: 2017-06-19T09:27:07+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/mockup/commit/664f01d0b09a3c20737f1aa7bf646be8b9857e23

Merge pull request #780 from plone/thet-fix-upload-authenticator

Upload pattern: authenticator token

Files changed:
M CHANGES.rst
M mockup/patterns/upload/pattern.js

diff --git a/CHANGES.rst b/CHANGES.rst
index da9837d7..e57d16a7 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -50,11 +50,13 @@ New features:
 
 Bug fixes:
 
+- Upload pattern: Fix missing plone.protect authenticator token which led to broken uploads.
+  [thet]
+
 - fixed css-classes for thumb scales ...
   https://github.com/plone/Products.CMFPlone/issues/2077
   [fgrcon]
 
-
 - modal: Fixed duplicate window.confirm on form unload.
   Fixes `issue 777 <https://github.com/plone/mockup/issues/777>`_.
   [seanupton]
diff --git a/mockup/patterns/upload/pattern.js b/mockup/patterns/upload/pattern.js
index 554efb5b..87e05c25 100644
--- a/mockup/patterns/upload/pattern.js
+++ b/mockup/patterns/upload/pattern.js
@@ -48,9 +48,9 @@ define([
   'dropzone',
   'text!mockup-patterns-upload-url/templates/upload.xml',
   'text!mockup-patterns-upload-url/templates/preview.xml',
+  'mockup-utils',
   'translate'
-], function($, _, Base, RelatedItems, Dropzone,
-            UploadTemplate, PreviewTemplate, _t) {
+], function($, _, Base, RelatedItems, Dropzone, UploadTemplate, PreviewTemplate, utils, _t) {
   'use strict';
 
   /* we do not want this plugin to auto discover */
@@ -341,6 +341,10 @@ define([
       var options = $.extend({}, self.options);
       options.url = self.getUrl();
 
+      options.headers = {
+        'X-CSRF-TOKEN': utils.getAuthenticator()
+      };
+
       // XXX force to only upload one to the server at a time,
       // right now we don't support multiple for backends
       options.uploadMultiple = false;
@@ -442,7 +446,8 @@ define([
       window.tus.upload(file, {
         endpoint: self.dropzone.options.url,
         headers: {
-          'FILENAME': file.name
+          'FILENAME': file.name,
+          'X-CSRF-TOKEN': utils.getAuthenticator()
         },
         chunkSize: chunkSize
       }).fail(function() {


