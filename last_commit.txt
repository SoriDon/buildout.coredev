Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2019-05-17T17:41:11+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.ATContentTypes/commit/ec6e9979c021b8db06abc5e46dbc4c3f111749e4

Fix traversing in portal_factory with url-quoted type-name
that contains %20 instead of spaces

Files changed:
M Products/ATContentTypes/tests/atctftestcase.py
M Products/ATContentTypes/tool/factory.py

b'diff --git a/Products/ATContentTypes/tests/atctftestcase.py b/Products/ATContentTypes/tests/atctftestcase.py\nindex 526c4c30..7a0e7f33 100644\n--- a/Products/ATContentTypes/tests/atctftestcase.py\n+++ b/Products/ATContentTypes/tests/atctftestcase.py\n@@ -69,7 +69,7 @@ def test_createObject(self):\n         response = self.publish(\n             \'%s/createObject?type_name=%s&_authenticator=%s\' % (\n                 self.folder_path, self.portal_type, auth),\n-            self.basic_auth)\n+            self.basic_auth, handle_errors=False)\n \n         self.assertEqual(response.getStatus(), 302)  # Redirect to edit\n \n@@ -81,7 +81,8 @@ def test_createObject(self):\n \n         # Perform the redirect\n         edit_form_path = body[len(self.layer[\'request\'].SERVER_URL):]\n-        response = self.publish(edit_form_path, self.basic_auth)\n+        response = self.publish(\n+            edit_form_path, self.basic_auth, handle_errors=False)\n         self.assertEqual(response.getStatus(), 200)  # OK\n         temp_id = body.split(\'/\')[-2]\n \ndiff --git a/Products/ATContentTypes/tool/factory.py b/Products/ATContentTypes/tool/factory.py\nindex aa0e5e25..c4688ff2 100644\n--- a/Products/ATContentTypes/tool/factory.py\n+++ b/Products/ATContentTypes/tool/factory.py\n@@ -1,4 +1,6 @@\n # -*- coding: utf-8 -*-\n+from six.moves.urllib.parse import unquote\n+\n from AccessControl import ClassSecurityInfo\n from AccessControl import getSecurityManager\n from AccessControl import Owned\n@@ -445,6 +447,11 @@ def __bobo_traverse__(self, REQUEST, name):\n         # method call in which case the traversal stack will not have been\n         # cleared by __before_publishing_traverse__\n         name = str(name)  # fix unicode weirdness\n+        # In Zope4 the url is url-quoted during redirects so " " becomes "%20"\n+        # Since we have "News Item" this fails when looking for "News%20Item".\n+        if \'%\' in name:\n+            name = unquote(name)\n+\n         types_tool = getToolByName(self, \'portal_types\')\n         if name not in types_tool.listContentTypes():\n             # not a type name -- do the standard thing\n'

Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2019-05-17T17:57:44+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.ATContentTypes/commit/b60e301c113610bcc42f14042c8892552b88387d

add changenote

Files changed:
A news/63.bugfix

b'diff --git a/news/63.bugfix b/news/63.bugfix\nnew file mode 100644\nindex 00000000..b74d281f\n--- /dev/null\n+++ b/news/63.bugfix\n@@ -0,0 +1,2 @@\n+Fix traversing in portal_factory with url-quoted type-name. During redirecting in Zope4 spaces in the URL (e.g. in "News Item") get quoted to `%20`. This prevented finding the portal_type in `__bobo_traverse__`. See https://github.com/plone/buildout.coredev/pull/586\n+[pbauer]\n\\ No newline at end of file\n'

Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2019-05-17T20:14:06+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.ATContentTypes/commit/da239c68f477cfe93b6b1e3e8d05f88fb3cd85bf

Merge pull request #63 from plone/fix_at_factory_with_zope4

Fix traversing in portal_factory with url-quoted type-name

Files changed:
A news/63.bugfix
M Products/ATContentTypes/tests/atctftestcase.py
M Products/ATContentTypes/tool/factory.py

b'diff --git a/Products/ATContentTypes/tests/atctftestcase.py b/Products/ATContentTypes/tests/atctftestcase.py\nindex 526c4c30..7a0e7f33 100644\n--- a/Products/ATContentTypes/tests/atctftestcase.py\n+++ b/Products/ATContentTypes/tests/atctftestcase.py\n@@ -69,7 +69,7 @@ def test_createObject(self):\n         response = self.publish(\n             \'%s/createObject?type_name=%s&_authenticator=%s\' % (\n                 self.folder_path, self.portal_type, auth),\n-            self.basic_auth)\n+            self.basic_auth, handle_errors=False)\n \n         self.assertEqual(response.getStatus(), 302)  # Redirect to edit\n \n@@ -81,7 +81,8 @@ def test_createObject(self):\n \n         # Perform the redirect\n         edit_form_path = body[len(self.layer[\'request\'].SERVER_URL):]\n-        response = self.publish(edit_form_path, self.basic_auth)\n+        response = self.publish(\n+            edit_form_path, self.basic_auth, handle_errors=False)\n         self.assertEqual(response.getStatus(), 200)  # OK\n         temp_id = body.split(\'/\')[-2]\n \ndiff --git a/Products/ATContentTypes/tool/factory.py b/Products/ATContentTypes/tool/factory.py\nindex aa0e5e25..c4688ff2 100644\n--- a/Products/ATContentTypes/tool/factory.py\n+++ b/Products/ATContentTypes/tool/factory.py\n@@ -1,4 +1,6 @@\n # -*- coding: utf-8 -*-\n+from six.moves.urllib.parse import unquote\n+\n from AccessControl import ClassSecurityInfo\n from AccessControl import getSecurityManager\n from AccessControl import Owned\n@@ -445,6 +447,11 @@ def __bobo_traverse__(self, REQUEST, name):\n         # method call in which case the traversal stack will not have been\n         # cleared by __before_publishing_traverse__\n         name = str(name)  # fix unicode weirdness\n+        # In Zope4 the url is url-quoted during redirects so " " becomes "%20"\n+        # Since we have "News Item" this fails when looking for "News%20Item".\n+        if \'%\' in name:\n+            name = unquote(name)\n+\n         types_tool = getToolByName(self, \'portal_types\')\n         if name not in types_tool.listContentTypes():\n             # not a type name -- do the standard thing\ndiff --git a/news/63.bugfix b/news/63.bugfix\nnew file mode 100644\nindex 00000000..b74d281f\n--- /dev/null\n+++ b/news/63.bugfix\n@@ -0,0 +1,2 @@\n+Fix traversing in portal_factory with url-quoted type-name. During redirecting in Zope4 spaces in the URL (e.g. in "News Item") get quoted to `%20`. This prevented finding the portal_type in `__bobo_traverse__`. See https://github.com/plone/buildout.coredev/pull/586\n+[pbauer]\n\\ No newline at end of file\n'

