Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-04T13:15:05-06:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/f4d55c5e2d3d684ebb28bbf5b2b2a21554510259

Fix url generation for tinymce when using virtual hosting. This fixing
  images not rendering properly in tinymce

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1819259..eb5fa85 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,10 @@ New:
 
 Fixes:
 
+- Fix url generation for tinymce when using virtual hosting. This fixing
+  images not rendering properly in tinymce.
+  [vangheem]
+
 - build resources with latest mockup that provides better path criteria
   widget for the querystring pattern
   [vangheem]
diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index dd87eae..52f7a06 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -26,7 +26,6 @@ def __init__(self, context, request):
         self.settings = registry.forInterface(
             ITinyMCESchema, prefix="plone", check=False)
         self.portal_url = get_portal_url(self.portal)
-        self.portal_url_path = self.portal.absolute_url_path()
 
     def get_theme(self):
         return theming_policy().get_theme()
@@ -242,6 +241,8 @@ def tinymce(self):
 
         image_types = settings.image_objects or []
         folder_types = settings.contains_objects or []
+
+        site_path = generator.portal_url.replace(self.request['SERVER_URL'], '')
         configuration = {
             'relatedItems': {
                 'vocabularyUrl':
@@ -262,7 +263,7 @@ def tinymce(self):
             'tiny': generator.get_tiny_config(),
             # This is for loading the languages on tinymce
             'loadingBaseUrl': '%s/++plone++static/components/tinymce-builded/js/tinymce' % generator.portal_url,  # noqa
-            'prependToUrl': '{0}/resolveuid/'.format(generator.portal_url_path),
+            'prependToUrl': '{0}/resolveuid/'.format(site_path),
             'linkAttribute': 'UID',
             'prependToScalePart': '/@@images/image/',
             'imageTypes': image_types


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-06T11:12:53-06:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/ffc51cdac9f8494486f32e70a5da7fc70253f548

a bit more safe getting url

Files changed:
M Products/CMFPlone/patterns/__init__.py

diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index 52f7a06..f513702 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -242,7 +242,8 @@ def tinymce(self):
         image_types = settings.image_objects or []
         folder_types = settings.contains_objects or []
 
-        site_path = generator.portal_url.replace(self.request['SERVER_URL'], '')
+        server_url = self.request.get('SERVER_URL', '')
+        site_path = generator.portal_url[len(server_url):]
         configuration = {
             'relatedItems': {
                 'vocabularyUrl':
@@ -263,7 +264,7 @@ def tinymce(self):
             'tiny': generator.get_tiny_config(),
             # This is for loading the languages on tinymce
             'loadingBaseUrl': '%s/++plone++static/components/tinymce-builded/js/tinymce' % generator.portal_url,  # noqa
-            'prependToUrl': '{0}/resolveuid/'.format(site_path),
+            'prependToUrl': '{0}/resolveuid/'.format(site_path.rstrip('/')),
             'linkAttribute': 'UID',
             'prependToScalePart': '/@@images/image/',
             'imageTypes': image_types


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-06T11:15:27-06:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/b45bdde2d3c6a0e3250a66932abb1240bc3fa4d3

Merge pull request #1307 from plone/fix-prependToUrl-path-with-vh

Fix url generation for tinymce when using virtual hosting

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1819259..eb5fa85 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,10 @@ New:
 
 Fixes:
 
+- Fix url generation for tinymce when using virtual hosting. This fixing
+  images not rendering properly in tinymce.
+  [vangheem]
+
 - build resources with latest mockup that provides better path criteria
   widget for the querystring pattern
   [vangheem]
diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index dd87eae..f513702 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -26,7 +26,6 @@ def __init__(self, context, request):
         self.settings = registry.forInterface(
             ITinyMCESchema, prefix="plone", check=False)
         self.portal_url = get_portal_url(self.portal)
-        self.portal_url_path = self.portal.absolute_url_path()
 
     def get_theme(self):
         return theming_policy().get_theme()
@@ -242,6 +241,9 @@ def tinymce(self):
 
         image_types = settings.image_objects or []
         folder_types = settings.contains_objects or []
+
+        server_url = self.request.get('SERVER_URL', '')
+        site_path = generator.portal_url[len(server_url):]
         configuration = {
             'relatedItems': {
                 'vocabularyUrl':
@@ -262,7 +264,7 @@ def tinymce(self):
             'tiny': generator.get_tiny_config(),
             # This is for loading the languages on tinymce
             'loadingBaseUrl': '%s/++plone++static/components/tinymce-builded/js/tinymce' % generator.portal_url,  # noqa
-            'prependToUrl': '{0}/resolveuid/'.format(generator.portal_url_path),
+            'prependToUrl': '{0}/resolveuid/'.format(site_path.rstrip('/')),
             'linkAttribute': 'UID',
             'prependToScalePart': '/@@images/image/',
             'imageTypes': image_types


