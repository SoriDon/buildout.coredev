Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-12-02T09:06:09+01:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/2c8e9c631a7f352cf46af10a53b0a6e3582f3699

fix docstring

Files changed:
M Products/CMFPlone/tests/testCatalogTool.py

b"diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py\nindex 909e7f9178..8082aa3570 100644\n--- a/Products/CMFPlone/tests/testCatalogTool.py\n+++ b/Products/CMFPlone/tests/testCatalogTool.py\n@@ -147,7 +147,7 @@ def testExpiresDateNotInSchema(self):\n         self.assertFalse('ExpiresDate' in self.catalog.schema())\n \n     def testIs_Default_PageIsBooleanIndex(self):\n-        # sortable_title should be a BooleanIndex\n+        # is_default_page should be a BooleanIndex\n         self.assertEqual(\n             self.catalog.Indexes['is_default_page'].__class__.__name__,\n             'BooleanIndex')\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-12-02T09:29:50+01:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/0190d94a53a0d7f50b70f729f28250c7af4413eb

test that the sortable_index should contain the full title and that it is sorted correctly

Files changed:
M Products/CMFPlone/tests/testCatalogTool.py

b'diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py\nindex 8082aa3570..a660c4a9ac 100644\n--- a/Products/CMFPlone/tests/testCatalogTool.py\n+++ b/Products/CMFPlone/tests/testCatalogTool.py\n@@ -547,12 +547,21 @@ def afterSetUp(self):\n         self.folder.doc5.setTitle(\'Document 2\')\n         self.folder.invokeFactory(\'Document\', id=\'doc6\', text=RichTextValue(\'bar\', \'text/html\', \'text/x-html-safe\'))\n         self.folder.doc6.setTitle(\'DOCUMENT 4\')\n+\n+        self.folder.invokeFactory(\'Document\', id="doc7")\n+        self.folder.doc7.setTitle(\'This is a long title that will ignore this text BBBB 2nd position cut zzzzz\')\n+\n+        self.folder.invokeFactory(\'Document\', id="doc8")\n+        self.folder.doc8.setTitle(\'This is a long title that will ignore this text AAAA 1st position cut zzzzz\')\n+\n         self.folder.doc.reindexObject()\n         self.folder.doc2.reindexObject()\n         self.folder.doc3.reindexObject()\n         self.folder.doc4.reindexObject()\n         self.folder.doc5.reindexObject()\n         self.folder.doc6.reindexObject()\n+        self.folder.doc7.reindexObject()\n+        self.folder.doc8.reindexObject()\n \n     def testSortMultipleColumns(self):\n         path = \'/\'.join(self.folder.getPhysicalPath())\n@@ -567,6 +576,8 @@ def testSortMultipleColumns(self):\n                 \'/plone/Members/test_user_1_/doc5\',\n                 \'/plone/Members/test_user_1_/doc6\',\n                 \'/plone/Members/test_user_1_/doc4\',\n+                \'/plone/Members/test_user_1_/doc8\',\n+                \'/plone/Members/test_user_1_/doc7\',\n                 \'/plone/Members/test_user_1_\'\n             ],\n         )\n@@ -580,6 +591,8 @@ def testSortMultipleColumns(self):\n                 \'/plone/Members/test_user_1_/doc4\',\n                 \'/plone/Members/test_user_1_/doc5\',\n                 \'/plone/Members/test_user_1_/doc6\',\n+                \'/plone/Members/test_user_1_/doc7\',\n+                \'/plone/Members/test_user_1_/doc8\',\n                 \'/plone/Members/test_user_1_\',\n             ]\n         )\n@@ -614,6 +627,13 @@ def testSortableTitleOutput(self):\n \n         self.assertEqual(wrapped.sortable_title, \'0012 document 0025\')\n \n+    def testSortableTitleInLongTitles(self):\n+        doc = self.folder.doc7\n+        wrapped = IndexableObjectWrapper(doc, self.portal.portal_catalog)\n+\n+        self.assertEqual(wrapped.sortable_title, \'this is a long title that will ignore this text bbbb 0002nd position cut zzzzz\')\n+\n+\n     def testSortableNonASCIITitles(self):\n         # test a utf-8 encoded string gets properly unicode converted\n         # sort must ignore accents\n@@ -651,7 +671,7 @@ def testSortableLongCommonPrefix(self):\n         doc.setTitle(title)\n         wrapped = IndexableObjectWrapper(doc, self.portal.portal_catalog)\n         self.assertEqual(wrapped.sortable_title,\n-                         \'some documents have too lon... 0001.jpeg\')\n+                         \'some documents have too long a name and only differ at the very end - like 0001.jpeg\')\n \n \n class TestFolderCataloging(PloneTestCase):\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-12-02T09:30:01+01:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/470fea41e8de344d4b6ab4474609867f5a2fa0b0

do not truncate sortable_title

Files changed:
M Products/CMFPlone/CatalogTool.py

b"diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 64e11a1a10..c83320dc07 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -49,7 +49,6 @@\n \n _marker = object()\n \n-MAX_SORTABLE_TITLE = 40\n DENIED_INTERFACES = frozenset((\n     'AccessControl.interfaces.IOwned',\n     'AccessControl.interfaces.IPermissionMappingSupport',\n@@ -175,11 +174,6 @@ def sortable_title(obj):\n             sortabletitle = mapUnicode(safe_text(title)).lower().strip()\n             # Replace numbers with zero filled numbers\n             sortabletitle = num_sort_regex.sub(zero_fill, sortabletitle)\n-            # Truncate to prevent bloat, take bits from start and end\n-            if len(sortabletitle) > MAX_SORTABLE_TITLE:\n-                start = sortabletitle[:(MAX_SORTABLE_TITLE - 13)]\n-                end = sortabletitle[-10:]\n-                sortabletitle = start + '...' + end\n             return sortabletitle\n     return ''\n \n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-12-02T09:31:04+01:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/f9ae9280f28e4acc44990a1145cae9d926c5ee1b

changelog

Files changed:
A news/3690.bugfix

b'diff --git a/news/3690.bugfix b/news/3690.bugfix\nnew file mode 100644\nindex 0000000000..cb7c7c25c3\n--- /dev/null\n+++ b/news/3690.bugfix\n@@ -0,0 +1,2 @@\n+Do not truncate the sortable_title index\n+[erral]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-03-22T00:46:14+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/0dc18bd8481e68fcd08fdab20aaa8df2bb908d9c

Merge branch 'master' into erral-issue-3690

Files changed:
A CHANGES.md
A CONTRIBUTING.md
A Products/CMFPlone/browser/login/utils.py
A README.md
A docs/changelog_template.jinja
A news/3122.bugfix
A news/3223.bugfix
A news/3733.bugfix
A news/3738.bugfix
A news/3740.bugfix
A news/3742.bugfix
A news/3747.bugfix
A news/6014.bugfix
M Products/CMFPlone/MigrationTool.py
M Products/CMFPlone/PloneControlPanel.py
M Products/CMFPlone/browser/contact_info.py
M Products/CMFPlone/browser/interfaces.py
M Products/CMFPlone/browser/login/login.py
M Products/CMFPlone/browser/login/login_help.py
M Products/CMFPlone/browser/login/logout.py
M Products/CMFPlone/browser/login/mail_password.py
M Products/CMFPlone/browser/login/password_reset.py
M Products/CMFPlone/browser/syndication/views.py
M Products/CMFPlone/browser/templates/plone-frontpage.pt
M Products/CMFPlone/browser/templates/plone-overview.pt
M Products/CMFPlone/controlpanel/bbb/mail.py
M Products/CMFPlone/controlpanel/browser/actions.py
M Products/CMFPlone/controlpanel/browser/configure.zcml
M Products/CMFPlone/controlpanel/browser/dateandtime.py
M Products/CMFPlone/controlpanel/browser/editing.py
M Products/CMFPlone/controlpanel/browser/error_log_form.py
M Products/CMFPlone/controlpanel/browser/filter.py
M Products/CMFPlone/controlpanel/browser/imaging.py
M Products/CMFPlone/controlpanel/browser/language.py
M Products/CMFPlone/controlpanel/browser/mail.py
M Products/CMFPlone/controlpanel/browser/maintenance.py
M Products/CMFPlone/controlpanel/browser/markup.py
M Products/CMFPlone/controlpanel/browser/navigation.py
M Products/CMFPlone/controlpanel/browser/quickinstaller.py
M Products/CMFPlone/controlpanel/browser/resourceregistry.py
M Products/CMFPlone/controlpanel/browser/search.py
M Products/CMFPlone/controlpanel/browser/security.py
M Products/CMFPlone/controlpanel/browser/site.py
M Products/CMFPlone/controlpanel/browser/socialmedia.py
M Products/CMFPlone/controlpanel/browser/tinymce.py
M Products/CMFPlone/controlpanel/browser/types.py
M Products/CMFPlone/controlpanel/browser/usergroups.py
M Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py
M Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt
M Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py
M Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py
M Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt
M Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py
M Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py
M Products/CMFPlone/controlpanel/permissions.zcml
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py
M Products/CMFPlone/factory.py
M Products/CMFPlone/profiles/default/metadata.xml
M Products/CMFPlone/profiles/default/rolemap.xml
M Products/CMFPlone/relationhelper.py
M Products/CMFPlone/resources/browser/resource.py
M Products/CMFPlone/tests/pwreset_browser.rst
M Products/CMFPlone/tests/testRegistrationTool.py
M Products/CMFPlone/tests/testResourceRegistries.py
M Products/CMFPlone/tests/test_login_form.py
M Products/CMFPlone/tests/test_redirect_after_login.py
M pyproject.toml
M setup.py
D CHANGES.rst
D CONTRIBUTING.rst
D Products/CMFPlone/browser/templates/send_feedback_confirm.pt
D README.rst
D news/3680.bugfix
D news/3683.bugfix
D news/3687.internal
D news/6010.bugfix

b'diff --git a/CHANGES.rst b/CHANGES.md\nsimilarity index 88%\nrename from CHANGES.rst\nrename to CHANGES.md\nindex d9c12fc632..a956f98c6a 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.md\n@@ -1,21 +1,97 @@\n-.. This file should contain the changes for the last release only, which\n+<!--\n+   This file should contain the changes for the last release only, which\n    will be included on the package\'s page on pypi. All older entries are\n    kept in docs/HISTORY.rst\n+-->\n \n-Changelog\n-=========\n+# Changelog\n \n-.. You should *NOT* be adding new change log entries to this file.\n+<!--\n+   You should *NOT* be adding new change log entries to this file.\n    You should create a file in the news directory instead.\n    For helpful instructions, please see:\n    https://github.com/plone/plone.releaser/blob/master/ADD-A-NEWS-ITEM.rst\n+-->\n \n-.. towncrier release notes start\n+<!-- towncrier release notes start -->\n \n-6.0.0rc1 (2022-11-18)\n----------------------\n+## 6.0.2 (2023-02-27)\n \n-Bug fixes:\n+\n+### Bug fixes:\n+\n+- Apply Barceloneta upgrades when upgrading Plone.\n+  [maurits] #3726\n+\n+\n+## 6.0.2rc1 (2023-02-23)\n+\n+\n+### Bug fixes:\n+\n+- Fix editing `modal` property of an action in `@@actions-controlpanel`.\n+  [petschki] #3709\n+- Updated metadata version to 6013.  [maurits] #6013\n+\n+\n+## 6.0.1 (2023-01-31)\n+\n+\n+### Bug fixes:\n+\n+- Prepare 6.0.1 final. No changes compared to the release candidate.\n+  [maurits] #601\n+\n+\n+## 6.0.1rc1 (2023-01-30)\n+\n+\n+### New features:\n+\n+- Add data-bundle attributes on javascript and styles resources.  [aormazabal] #3707\n+\n+\n+### Bug fixes:\n+\n+- During login, when login_time is invalid, warn and reset it to 2000/01/01.\n+  Fixes [issue 3656](https://github.com/plone/Products.CMFPlone/issues/3656>).\n+  [maurits] #3656\n+- When autologin after password reset is enabled, use the same adapters as during normal login.\n+  Specifically: the ``IInitialLogin`` and ``IRedirectAfterLogin`` adapters.\n+  Autologin is enabled by default.\n+  Fixes [issue 3713](https://github.com/plone/Products.CMFPlone/issues/3713).\n+  [maurits] #3713\n+- Updated metadata version to 6012.  [maurits] #6012\n+\n+\n+## 6.0.0 (2022-12-12)\n+\n+\n+### Bug fixes:\n+\n+- Add help label to create Plone site page for difference between Volto and ClassicUI with link to docs. [fredvd] #3072\n+- Change the search control panel to select types not searched instead of searchable types. This fixes an inconsistency with Volto. [danalvrz] #3694\n+- Update default home page for installers for Plone 6 final release. [stevepiercy] #3700\n+- Updated metadata version to 6011.  [maurits] #6011\n+\n+\n+## 6.0.0rc2 (2022-12-05)\n+\n+### Bug fixes:\n+\n+\n+- Fix duplicated ``<article id="content">`` in login form.\n+  [petschki] (#3680)\n+- Fix caching of rendered resources.\n+  [petschki] (#3683)\n+- Update package metadata in pypi.\n+  [ericof] (#3687)\n+- Updated metadata version to 6010.  [maurits] (#6010)\n+\n+\n+## 6.0.0rc1 (2022-11-18)\n+\n+### Bug fixes:\n \n \n - Don\'t create news, events, and users folders for Volto sites. [davisagli] (#3628)\n@@ -28,10 +104,9 @@ Bug fixes:\n - Updated metadata version to 6009.  [maurits] (#6009)\n \n \n-6.0.0b3 (2022-10-04)\n---------------------\n+## 6.0.0b3 (2022-10-04)\n \n-Bug fixes:\n+### Bug fixes:\n \n \n - Deprecate the portal_properties tool, remove obsolete code (#125)\n@@ -46,10 +121,9 @@ Bug fixes:\n - Updated metadata version to 6008.  [maurits] (#6008)\n \n \n-6.0.0b2 (2022-09-10)\n---------------------\n+## 6.0.0b2 (2022-09-10)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - Officially drop Python 3.7 support and add 3.10 support.\n@@ -58,7 +132,7 @@ Breaking changes:\n   [maurits] (#3635)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Moved CSFR patches addressing CMFPlone itself to decorators.\n@@ -109,10 +183,9 @@ Bug fixes:\n   [maurits] (#6007)\n \n \n-6.0.0b1 (2022-07-23)\n---------------------\n+## 6.0.0b1 (2022-07-23)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - Removed our expressions patch.\n@@ -122,7 +195,7 @@ Breaking changes:\n   [maurits] (#3567)\n \n \n-New features:\n+### New features:\n \n \n - Initially open accordions in resource registry. Hide via JS when no errors occur.\n@@ -131,7 +204,7 @@ New features:\n   [petschki] (#3570)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Reduce dependencies in setup.py here, when already fulfilled in the packages where in use.\n@@ -146,10 +219,9 @@ Bug fixes:\n   [maurits] (#6006)\n \n \n-6.0.0a6 (2022-06-27)\n---------------------\n+## 6.0.0a6 (2022-06-27)\n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Remove the use of f-strings for translations\n@@ -160,10 +232,9 @@ Bug fixes:\n   [petschki] (#3566)\n \n \n-6.0.0a5 (2022-06-24)\n---------------------\n+## 6.0.0a5 (2022-06-24)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - Remove Archtypes specific ``isIDAutoGenerated`` helper.\n@@ -179,7 +250,7 @@ Breaking changes:\n   [jensens] (#3520)\n \n \n-New features:\n+### New features:\n \n \n - Added customisable batch_size for redirects controlpanel\n@@ -203,7 +274,7 @@ New features:\n   [petschki] (#3558)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Make compatible with robotframework 3-5.\n@@ -236,10 +307,9 @@ Bug fixes:\n   [maurits] (#6005)\n \n \n-6.0.0a4 (2022-04-08)\n---------------------\n+## 6.0.0a4 (2022-04-08)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - PLIP 3211:\n@@ -272,7 +342,7 @@ Breaking changes:\n   [jensens, pbauer] (#3485)\n \n \n-New features:\n+### New features:\n \n \n - PLIP #3279: Implement modern images scales. Add huge (1600px), great (1200px), larger (1000px), teaser (600px). Amend preview and mini (remove height constraint).\n@@ -290,7 +360,7 @@ New features:\n   [agitator] (#3489)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Fixed evaluating expressions on resources, and especially loading ``plone.session`` resources.\n@@ -345,10 +415,9 @@ Bug fixes:\n   [maurits] (#6004)\n \n \n-6.0.0a3 (2022-01-28)\n---------------------\n+## 6.0.0a3 (2022-01-28)\n \n-New features:\n+### New features:\n \n \n - add a new entry in site-controlpanel to change the favicon and its MIME-type\n@@ -362,7 +431,7 @@ New features:\n   [jensens] (#3377)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Cleanup Error Log Form after Review\n@@ -378,10 +447,9 @@ Bug fixes:\n - Updated metadata version to 6003.  [maurits] (#6003)\n \n \n-6.0.0a2 (2021-12-03)\n---------------------\n+## 6.0.0a2 (2021-12-03)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - PLIP 3339: Replace ``z3c.autoinclude`` with ``plone.autoinclude``.\n@@ -389,14 +457,14 @@ Breaking changes:\n   [maurits, tschorr] (#3339)\n \n \n-New features:\n+### New features:\n \n \n - On Zope root, create Volto site by default.\n   [maurits] (#3344)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Move prefs_error_log* from skins to browser views\n@@ -419,10 +487,9 @@ Bug fixes:\n - Updated metadata version to 6002.  [maurits] (#6002)\n \n \n-6.0.0a1 (2021-10-22)\n---------------------\n+## 6.0.0a1 (2021-10-22)\n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Release Plone 6.0.0a1.\n@@ -430,10 +497,9 @@ Bug fixes:\n   [maurits] (#3341)\n \n \n-6.0.0a1.dev1 (2021-10-16)\n--------------------------\n+## 6.0.0a1.dev1 (2021-10-16)\n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Use HTML5 meta charset.\n@@ -464,10 +530,9 @@ Bug fixes:\n   [maurits] (#6001)\n \n \n-6.0.0a1.dev0 (2021-09-15)\n--------------------------\n+## 6.0.0a1.dev0 (2021-09-15)\n \n-Breaking changes:\n+### Breaking changes:\n \n \n - Removed our CMFQuickInstallerTool code completely.\n@@ -508,7 +573,7 @@ Breaking changes:\n   tschorr] (#3249)\n \n \n-New features:\n+### New features:\n \n \n - Custom date format strings from registry can be in the ``${}`` format as in the locales files.\n@@ -525,7 +590,7 @@ New features:\n   [pbauer] (#3297)\n \n \n-Bug fixes:\n+### Bug Fixes:\n \n \n - Add ``plone.app.caching`` to the list of add-ons that is upgraded when upgrading Plone.\ndiff --git a/CONTRIBUTING.md b/CONTRIBUTING.md\nnew file mode 100644\nindex 0000000000..5826e4eca3\n--- /dev/null\n+++ b/CONTRIBUTING.md\n@@ -0,0 +1 @@\n+Please see [Developer Guidelines](https://docs.plone.org/develop/coredev/docs/guidelines.html)\ndiff --git a/CONTRIBUTING.rst b/CONTRIBUTING.rst\ndeleted file mode 100644\nindex fc637ac8aa..0000000000\n--- a/CONTRIBUTING.rst\n+++ /dev/null\n@@ -1 +0,0 @@\n-Please see http://docs.plone.org/develop/coredev/docs/guidelines.html\ndiff --git a/Products/CMFPlone/MigrationTool.py b/Products/CMFPlone/MigrationTool.py\nindex 37abca6e4a..98285bd0c8 100644\n--- a/Products/CMFPlone/MigrationTool.py\n+++ b/Products/CMFPlone/MigrationTool.py\n@@ -121,6 +121,7 @@ def upgrade_all(self, context):\n         profile_id=\'plone.volto:default\',\n         check_module=\'plone.volto\'\n     ),\n+    Addon(profile_id=\'plonetheme.barceloneta:default\'),\n ])\n \n \ndiff --git a/Products/CMFPlone/PloneControlPanel.py b/Products/CMFPlone/PloneControlPanel.py\nindex fa04987c11..d3bdd10096 100644\n--- a/Products/CMFPlone/PloneControlPanel.py\n+++ b/Products/CMFPlone/PloneControlPanel.py\n@@ -3,6 +3,7 @@\n from App.special_dtml import DTMLFile\n from OFS.Folder import Folder\n from OFS.PropertyManager import PropertyManager\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IControlPanel\n from Products.CMFCore.ActionInformation import ActionInformation\n from Products.CMFCore.ActionProviderBase import ActionProviderBase\n@@ -14,7 +15,6 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFCore.utils import registerToolInterface\n from Products.CMFCore.utils import UniqueObject\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from zope.component.hooks import getSite\n from zope.i18n import translate\ndiff --git a/Products/CMFPlone/browser/contact_info.py b/Products/CMFPlone/browser/contact_info.py\nindex 5b113269a3..1b70a775a6 100644\n--- a/Products/CMFPlone/browser/contact_info.py\n+++ b/Products/CMFPlone/browser/contact_info.py\n@@ -1,9 +1,9 @@\n from email.mime.text import MIMEText\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces.controlpanel import IMailSchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.browser.interfaces import IContactForm\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\ndiff --git a/Products/CMFPlone/browser/interfaces.py b/Products/CMFPlone/browser/interfaces.py\nindex 732f11e05a..2e08f93b5e 100644\n--- a/Products/CMFPlone/browser/interfaces.py\n+++ b/Products/CMFPlone/browser/interfaces.py\n@@ -1,5 +1,5 @@\n+from plone.base import PloneMessageFactory as _\n from plone.schema import Email\n-from Products.CMFPlone import PloneMessageFactory as _\n from zope import schema\n from zope.interface import Attribute\n from zope.interface import Interface\ndiff --git a/Products/CMFPlone/browser/login/login.py b/Products/CMFPlone/browser/login/login.py\nindex 5fdc4cef68..12f920cd65 100644\n--- a/Products/CMFPlone/browser/login/login.py\n+++ b/Products/CMFPlone/browser/login/login.py\n@@ -1,5 +1,6 @@\n-from DateTime import DateTime\n+from .utils import has_logged_in\n from plone.app.users.browser.passwordpanel import PasswordPanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IForcePasswordChange\n from plone.base.interfaces import IInitialLogin\n from plone.base.interfaces import ILoginForm\n@@ -8,7 +9,6 @@\n from plone.base.interfaces import ISecuritySchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five.browser import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\n from urllib import parse\n@@ -21,7 +21,10 @@\n from zope.component import queryUtility\n from zope.interface import implementer\n \n+import logging\n \n+\n+logger = logging.getLogger(__name__)\n # TODO: Scale down this list now that we\'ve removed a lot of\n # templates.\n LOGIN_TEMPLATE_IDS = [\n@@ -135,10 +138,8 @@ def _post_login(self):\n         membership_tool = getToolByName(self.context, \'portal_membership\')\n         member = membership_tool.getAuthenticatedMember()\n         must_change_password = member.getProperty(\'must_change_password\', 0)\n-        login_time = member.getProperty(\'login_time\', \'2000/01/01\')\n-        if not isinstance(login_time, DateTime):\n-            login_time = DateTime(login_time)\n-        is_initial_login = login_time == DateTime(\'2000/01/01\')\n+        login_time = member.getProperty(\'login_time\', None)\n+        is_initial_login = not has_logged_in(login_time)\n \n         membership_tool.loginUser(self.request)\n         if is_initial_login:\ndiff --git a/Products/CMFPlone/browser/login/login_help.py b/Products/CMFPlone/browser/login/login_help.py\nindex 5ad934823c..3ad0c50189 100644\n--- a/Products/CMFPlone/browser/login/login_help.py\n+++ b/Products/CMFPlone/browser/login/login_help.py\n@@ -1,5 +1,6 @@\n from email import message_from_string\n from email.header import Header\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ILoginHelpForm\n from plone.base.interfaces import ILoginHelpFormSchema\n from plone.base.interfaces import ISecuritySchema\n@@ -7,7 +8,6 @@\n from plone.base.utils import safe_text\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n from smtplib import SMTPException\ndiff --git a/Products/CMFPlone/browser/login/logout.py b/Products/CMFPlone/browser/login/logout.py\nindex 8a986e6136..874dbfb161 100644\n--- a/Products/CMFPlone/browser/login/logout.py\n+++ b/Products/CMFPlone/browser/login/logout.py\n@@ -1,6 +1,6 @@\n+from plone.base import PloneMessageFactory as _\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.utils import transaction_note\n from Products.Five.browser import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\ndiff --git a/Products/CMFPlone/browser/login/mail_password.py b/Products/CMFPlone/browser/login/mail_password.py\nindex 7281d222ec..ada0ac13e6 100644\n--- a/Products/CMFPlone/browser/login/mail_password.py\n+++ b/Products/CMFPlone/browser/login/mail_password.py\n@@ -1,5 +1,5 @@\n from AccessControl import Unauthorized\n-from Products.CMFPlone import PloneMessageFactory as _\n+from plone.base import PloneMessageFactory as _\n from Products.Five import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\n \ndiff --git a/Products/CMFPlone/browser/login/password_reset.py b/Products/CMFPlone/browser/login/password_reset.py\nindex e65eadaf24..6039d58ba7 100644\n--- a/Products/CMFPlone/browser/login/password_reset.py\n+++ b/Products/CMFPlone/browser/login/password_reset.py\n@@ -1,27 +1,28 @@\n+from .utils import has_logged_in\n from AccessControl.SecurityManagement import getSecurityManager\n-from DateTime import DateTime\n+from AccessControl.SecurityManagement import newSecurityManager\n+from AccessControl.SecurityManagement import setSecurityManager\n from email.header import Header\n-from plone.app.layout.navigation.interfaces import INavigationRoot\n+from plone.base import PloneMessageFactory as _\n+from plone.base.interfaces import IInitialLogin\n from plone.base.interfaces import IPasswordResetToolView\n+from plone.base.interfaces import IRedirectAfterLogin\n from plone.base.interfaces.controlpanel import IMailSchema\n from plone.base.utils import safe_text\n from plone.base.utils import safeToInt\n from plone.memoize import view\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.PasswordResetTool import ExpiredRequestError\n from Products.CMFPlone.PasswordResetTool import InvalidRequestError\n from Products.CMFPlone.RegistrationTool import get_member_by_login_name\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-from Products.PlonePAS.events import UserInitialLoginInEvent\n-from Products.PlonePAS.events import UserLoggedInEvent\n from Products.PluggableAuthService.interfaces.plugins import ICredentialsUpdatePlugin\n from Products.statusmessages.interfaces import IStatusMessage\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n-from zope.event import notify\n+from zope.component import queryMultiAdapter\n from zope.i18n import translate\n from zope.interface import implementer\n from zope.publisher.interfaces import IPublishTraverse\n@@ -100,34 +101,71 @@ def _auto_login(self, userid, password):\n                 password\n             )\n \n+        is_initial_login = False\n+\n+        # Find member by login name or user id.\n+        # If this fails, then this is strange.\n         member = get_member_by_login_name(context, userid, False)\n+        if not member:\n+            self.request.response.redirect(self.context.absolute_url())\n+            IStatusMessage(self.request).addStatusMessage(\n+                _(\n+                    \'password_reset_failed\',\n+                    default=\'Password reset failed.\',\n+                ),\n+                \'info\',\n+            )\n+            return\n \n-        if member:\n-            user = member.getUser()\n-        else:\n-            # Fallback in case we cannot find a user\n-            # with the given userid\n-            user = getSecurityManager().getUser()\n-\n-        default = DateTime(\'2000/01/01\')\n-        login_time = user.getProperty(\'login_time\', default)\n-        if login_time == default:\n-            notify(UserInitialLoginInEvent(user))\n-        else:\n-            notify(UserLoggedInEvent(user))\n+        user = member.getUser()\n+        orig_sm = getSecurityManager()\n+        try:\n+            newSecurityManager(self.request, user)\n+            is_initial_login = self._post_login()\n+            IStatusMessage(self.request).addStatusMessage(\n+                _(\n+                    \'password_reset_successful\',\n+                    default=\'Password reset successful, \'\n+                            \'you are logged in now!\',\n+                ),\n+                \'info\',\n+            )\n+            self.redirect_after_login(is_initial_login=is_initial_login)\n+        finally:\n+            setSecurityManager(orig_sm)\n \n-        IStatusMessage(self.request).addStatusMessage(\n-            _(\n-                \'password_reset_successful\',\n-                default=\'Password reset successful, \'\n-                        \'you are logged in now!\',\n-            ),\n-            \'info\',\n-        )\n-        url = INavigationRoot(self.context).absolute_url()\n-        self.request.response.redirect(url)\n         return\n \n+    def _post_login(self):\n+        membership_tool = getToolByName(self.context, \'portal_membership\')\n+        member = membership_tool.getAuthenticatedMember()\n+        login_time = member.getProperty(\'login_time\', None)\n+        is_initial_login = not has_logged_in(login_time)\n+        membership_tool.loginUser(self.request)\n+        if is_initial_login:\n+            self.handle_initial_login()\n+        return is_initial_login\n+\n+    def handle_initial_login(self):\n+        handler = queryMultiAdapter((self.context, self.request), IInitialLogin)\n+        if handler:\n+            handler()\n+\n+    def redirect_after_login(self, came_from=None, is_initial_login=False):\n+        # Note: for password reset a came_from parameter seems illogical.\n+        # But let\'s allow it, to be the same as in login.py.\n+        # The default implementation does not pass it in though.\n+        adapter = queryMultiAdapter(\n+            (self.context, self.request),\n+            IRedirectAfterLogin\n+        )\n+        if adapter:\n+            came_from = adapter(came_from, is_initial_login)\n+        if not came_from:\n+            came_from = self.context.absolute_url()\n+\n+        self.request.response.redirect(came_from)\n+\n     def _reset_password(self, pw_tool, randomstring):\n         state = self.getErrors()\n         if state:\ndiff --git a/Products/CMFPlone/browser/login/utils.py b/Products/CMFPlone/browser/login/utils.py\nnew file mode 100644\nindex 0000000000..3d347c8c9c\n--- /dev/null\n+++ b/Products/CMFPlone/browser/login/utils.py\n@@ -0,0 +1,28 @@\n+from DateTime import DateTime\n+from DateTime.interfaces import SyntaxError as DateTimeSyntaxError\n+\n+import logging\n+\n+\n+logger = logging.getLogger(__name__)\n+\n+\n+def has_logged_in(login_time):\n+    """Is this a valid login time?\n+\n+    The login time for new users is set to January 1, 2000.\n+    If that is the login time, the user has not logged in yet.\n+    """\n+    if not login_time:\n+        return False\n+    if not isinstance(login_time, DateTime):\n+        try:\n+            login_time = DateTime(login_time)\n+        except DateTimeSyntaxError:\n+            # https://github.com/plone/Products.CMFPlone/issues/3656\n+            logger.warning(\'%r is not a valid login_time.\', login_time)\n+            return False\n+    # We used to compare login_time with DateTime(\'2000/01/01\'),\n+    # but it may have a timezone: I have seen both UTC and GTM+1.\n+    # So compare only the date part.\n+    return login_time.Date() != \'2000/01/01\'\ndiff --git a/Products/CMFPlone/browser/syndication/views.py b/Products/CMFPlone/browser/syndication/views.py\nindex 8e41e7233e..e1e0969cc5 100644\n--- a/Products/CMFPlone/browser/syndication/views.py\n+++ b/Products/CMFPlone/browser/syndication/views.py\n@@ -1,9 +1,9 @@\n from DateTime import DateTime\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces.syndication import IFeed\n from plone.base.interfaces.syndication import IFeedSettings\n from plone.base.interfaces.syndication import ISearchFeed\n from plone.z3cform.layout import wrap_form\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five import BrowserView\n from uuid import NAMESPACE_OID\n from uuid import uuid3\ndiff --git a/Products/CMFPlone/browser/templates/plone-frontpage.pt b/Products/CMFPlone/browser/templates/plone-frontpage.pt\nindex 99f000f8bf..5e4e00e568 100644\n--- a/Products/CMFPlone/browser/templates/plone-frontpage.pt\n+++ b/Products/CMFPlone/browser/templates/plone-frontpage.pt\n@@ -16,7 +16,7 @@\n   </div>\n \n   <p class="discreet">\n-If you\'re seeing this instead of the web site you were expecting, the owner of\n+If you\'re seeing this text instead of the web site you were expecting, the owner of\n this web site has just installed Plone. Do not contact the Plone Team or the\n Plone support channels about this.\n </p>\n@@ -29,9 +29,9 @@ Before you start exploring your newly created Plone site, please do the followin\n \n <ol>\n     <li>Make sure you are logged in as an admin/manager user.\n-        <span class="discreet">(You should have a Site Setup entry in the user menu)</span></li>\n-    <li><a href="@@mail-controlpanel" target="_blank">Set up your mail server</a>. <span class="discreet">(Plone needs a valid SMTP server to verify users and send out password reminders)</span></li>\n-    <li><a href="@@security-controlpanel" target="_blank">Decide what security level you want on your site</a>. <span class="discreet">(Allow self registration, password policies, etc)</span></li>\n+        <span class="discreet">You should have a Site Setup entry in the user menu.</span></li>\n+    <li><a href="@@mail-controlpanel" target="_blank">Set up your mail server</a>. <span class="discreet">Plone needs a valid SMTP server to verify users and send out password reminders.</span></li>\n+    <li><a href="@@security-controlpanel" target="_blank">Decide what security level you want on your site</a>. <span class="discreet">Allow self registration, password policies, and more.</span></li>\n </ol>\n \n <h2>Get comfortable</h2>\n@@ -39,17 +39,16 @@ Before you start exploring your newly created Plone site, please do the followin\n <p>After that, we suggest you do one or more of the following:</p>\n \n <ul>\n-    <li>Get the latest <a class="link-plain" href="https://plone.org/what-is-plone/plone" target="_blank">news</a> about Plone.</li>\n-    <li>Read the <a class="link-plain" href="https://docs.plone.org" target="_blank">documentation</a>.</li>\n+    <li>Get the latest <a class="link-plain" href="https://plone.org/news" target="_blank">news</a> about Plone.</li>\n+    <li>Read the <a class="link-plain" href="https://6.docs.plone.org" target="_blank">documentation</a>.</li>\n     <li>Follow a <a class="link-plain" href="https://training.plone.org" target="_blank">training</a>.</li>\n     <li>Explore the <a class="link-plain" href="https://plone.org/download/add-ons" target="_blank">available add-ons</a> for Plone.</li>\n-    <li>Read and/or subscribe to the <a class="link-plain" href="https://plone.org/support" target="_blank">support channels</a>.</li>\n-    <li>Find out <a class="link-plain" href="https://plone.com/success-stories/" target="_blank">how others are using Plone</a>.</li>\n+    <li>Read or subscribe to the <a class="link-plain" href="https://plone.org/support" target="_blank">support channels</a>.</li>\n </ul>\n \n <h2>Make it your own</h2>\n \n-<p>Plone has a lot of different settings that can be used to make it do what you want it to. Some examples:</p>\n+<p>Plone has many settings to make it do what you want. Some examples include:</p>\n \n <ul>\n     <li>\n@@ -57,23 +56,23 @@ Before you start exploring your newly created Plone site, please do the followin\n     <a href="@@theming-controlpanel" target="_blank">the included ones</a>, or one of the\n     <a class="link-plain"\n        href="https://plone.org/download/add-ons" target="_blank">available themes\n-       from plone.org</a>. <span class="discreet">(Make sure the theme is\n-       compatible with the version of Plone you are currently using)</span>\n+       from plone.org</a>. <span class="discreet">Make sure the theme is\n+       compatible with the version of Plone you are currently using.</span>\n     </li>\n \n     <li>\n     <a href="@@content-controlpanel" target="_blank">\n     Decide what kind of workflow you want in your site.</a>\n-    <span class="discreet">(The default is typical for a\n+    <span class="discreet">The default is typical for a\n     public web site; if you want to use Plone as a closed intranet or extranet,\n-    you can choose a different workflow.)</span>\n+    you can choose a different workflow.</span>\n     </li>\n \n     <li>\n     By default, Plone uses a visual editor for content.\n-    <span class="discreet">(If you prefer text-based syntax and/or wiki\n+    <span class="discreet">If you prefer text-based syntax and/or wiki\n         syntax, you can change this in the\n-    <a href="@@markup-controlpanel" target="_blank">markup control panel</a>)</span>\n+    <a href="@@markup-controlpanel" target="_blank">markup control panel</a></span>\n     </li>\n \n     <li>\xe2\x80\xa6and many more settings are available in the\n@@ -92,28 +91,19 @@ solutions?\n \n <ul>\n     <li>Add your company as a <a class="link-plain"\n-        href="https://plone.com/providers/" target="_blank">Plone provider</a>.</li>\n+        href="https://plone.org/providers/" target="_blank">Plone provider</a>.</li>\n     <li>Add a <a class="link-plain"\n-        href="https://plone.com/success-stories/" target="_blank">success story</a> describing your\n+        href="https://plone.org/news/plone-news-by-category/success-story" target="_blank">success story</a> describing your\n         deployed project and customer.</li>\n </ul>\n \n <h2>Find out more about Plone</h2>\n \n <p>\n-Plone is a powerful content management system built on a rock-solid application stack written using the Python programming\n-language. More about these technologies:\n+Plone is a powerful content management system built on a rock-solid application stack.\n+Read about its technology on the <a class="link-plain" href="https://plone.org/what-is-plone" target="_blank">Plone web site</a>.\n </p>\n \n-<ul>\n-<li>The <a class="link-plain" href="https://plone.com" target="_blank">Plone open source\n-    Content Management System</a> web site for evaluators and decision makers.</li>\n-<li>The <a class="link-plain" href="https://plone.org" target="_blank">Plone community\n-    </a> web site for developers.</li>\n-<li>The <a class="link-plain" href="https://www.python.org" target="_blank">Python\n-    programming language</a> web site.</li>\n-</ul>\n-\n <h2>Support the Plone Foundation</h2>\n \n <p>\n@@ -122,12 +112,12 @@ individuals and hundreds of companies. The Plone Foundation:\n </p>\n <ul>\n     <li>\xe2\x80\xa6protects and promotes Plone.</li>\n-    <li>\xe2\x80\xa6is a registered 501(c)(3) charitable organization.</li>\n-    <li>\xe2\x80\xa6donations are tax-deductible.</li>\n+    <li>\xe2\x80\xa6is a recognized 501(c)(3) charitable organization with the United States Internal Revenue Service.</li>\n+    <li>\xe2\x80\xa6receives donations that may be tax-deductible.</li>\n     <li><a href="https://plone.org/sponsors/be-a-hero" target="_blank">Support the Foundation and help make Plone better!</a></li>\n </ul>\n \n-<p>Thanks for using our product; we hope you like it!</p>\n+<p>Thanks for using our product. We hope you like it!</p>\n \n <p>\xe2\x80\x94The Plone Team</p>\n </body>\ndiff --git a/Products/CMFPlone/browser/templates/plone-overview.pt b/Products/CMFPlone/browser/templates/plone-overview.pt\nindex 1a6eb25f2b..dbf2b3c608 100644\n--- a/Products/CMFPlone/browser/templates/plone-overview.pt\n+++ b/Products/CMFPlone/browser/templates/plone-overview.pt\n@@ -88,10 +88,6 @@\n                 <button type="submit"\n                         class="btn btn-${python:\'success\' if sites else \'primary\'}"\n                         i18n:translate="">Create a new Plone site</button>\n-                <tal:comment condition="nothing">\n-                  When we have Volto, the button above will create a Volto site,\n-                  and we need an extra button below to create a Classic Plone site.\n-                </tal:comment>\n                 <a class="btn btn-info"\n                     i18n:translate=""\n                     tal:condition="view/has_volto"\n@@ -102,6 +98,25 @@\n                     href="${action}?site_id=Plone${site_number}&amp;advanced=1"\n                     >Advanced</a>\n             </form>\n+            <br/>\n+            <p i18n:translate="help_create_plone_site_buttons_1">\n+                Starting with Plone 6, \'Create a new Plone site\' applies a\n+                profile and creates default content for the new React based\n+                default frontend Volto. You are however required to set up and run\n+                an additional frontend service to use this setup.\n+            </p>\n+            <p i18n:translate="help_create_plone_site_buttons_2">\n+                The \'Create Classic Plone site\' button creates a Plone site configured\n+                for HTML based output, as was already supported by previous Plone versions.\n+                Please consult our\n+                <a href="https://6.docs.plone.org/" title="Plone 6 developer documentation"\n+                   i18n:translate=""\n+                   i18n:name="docs_link"\n+                   i18n:attributes="title">developer documentation overview </a>\n+                for more information about differences and requirements for\n+                these frontends and possible upgrade paths from older Plone versions\n+                to Plone 6.\n+            </p>\n         </div>\n     </article>\n \ndiff --git a/Products/CMFPlone/browser/templates/send_feedback_confirm.pt b/Products/CMFPlone/browser/templates/send_feedback_confirm.pt\ndeleted file mode 100644\nindex 99c5de6ec2..0000000000\n--- a/Products/CMFPlone/browser/templates/send_feedback_confirm.pt\n+++ /dev/null\n@@ -1,30 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/@@main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<head>\n-    <metal:noborder fill-slot="top_slot"\n-                 tal:define="dummy python:request.set(\'disable_border\',1)" />\n-</head>\n-\n-<body>\n-\n-<metal:main fill-slot="main">\n-\n-    <h1 class="documentFirstHeading"\n-        i18n:translate="heading_send_feedback_confirm">\n-        Site Administrator has been contacted.\n-    </h1>\n-\n-    <div class="documentDescription" i18n:translate="message_send_feedback_confirm">\n-        A mail has now been sent to the site administrator regarding your\n-        questions and/or comments.\n-    </div>\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/Products/CMFPlone/controlpanel/bbb/mail.py b/Products/CMFPlone/controlpanel/bbb/mail.py\nindex cdddaa2e8d..15ab993922 100644\n--- a/Products/CMFPlone/controlpanel/bbb/mail.py\n+++ b/Products/CMFPlone/controlpanel/bbb/mail.py\n@@ -1,7 +1,7 @@\n from plone.base.interfaces import IPloneSiteRoot\n from plone.base.interfaces.controlpanel import IMailSchema\n+from plone.base.utils import safe_hasattr\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone.utils import safe_hasattr\n from zope.component import adapts\n from zope.component import getUtility\n from zope.component.hooks import getSite\ndiff --git a/Products/CMFPlone/controlpanel/browser/actions.py b/Products/CMFPlone/controlpanel/browser/actions.py\nindex 4f66ab1e0a..ced92e851c 100644\n--- a/Products/CMFPlone/controlpanel/browser/actions.py\n+++ b/Products/CMFPlone/controlpanel/browser/actions.py\n@@ -1,11 +1,12 @@\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IActionSchema\n from plone.base.interfaces import INewActionSchema\n+from plone.base.utils import base_hasattr\n from Products.CMFCore.ActionInformation import Action\n from Products.CMFCore.interfaces import IAction\n from Products.CMFCore.interfaces import IActionCategory\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import form\n@@ -14,6 +15,8 @@\n from zope.interface import implementer\n from zope.lifecycleevent import ObjectCreatedEvent\n \n+import json\n+\n \n class ActionListControlPanel(BrowserView):\n     """Control panel for the portal actions."""\n@@ -163,6 +166,22 @@ def set_position(self, value):\n \n     position = property(get_position, set_position)\n \n+    def get_modal(self):\n+        return self.context.modal\n+\n+    def set_modal(self, value):\n+        # This property may not exist yet on the context.\n+        if not self.context.hasProperty("modal"):\n+            if base_hasattr(self.context, "modal"):\n+                # We cannot define a property when an attribute with the same\n+                # name already exists.\n+                delattr(self.context, "modal")\n+            self.context._setProperty(\'modal\', value, \'string\')\n+        else:\n+            self.context._setPropValue(\'modal\', value)\n+\n+    modal = property(get_modal, set_modal)\n+\n \n class ActionControlPanel(AutoExtensibleForm, form.EditForm):\n     """A form to edit a portal action."""\ndiff --git a/Products/CMFPlone/controlpanel/browser/configure.zcml b/Products/CMFPlone/controlpanel/browser/configure.zcml\nindex 671c66f1ed..be2811ec27 100644\n--- a/Products/CMFPlone/controlpanel/browser/configure.zcml\n+++ b/Products/CMFPlone/controlpanel/browser/configure.zcml\n@@ -11,7 +11,6 @@\n       id="plone.app.controlpanel.TinyMCE"\n       title="Plone Site Setup: TinyMCE">\n     <role name="Manager"/>\n-    <role name="Site Administrator"/>\n   </permission>\n \n   <!-- Control Panel Main Template -->\ndiff --git a/Products/CMFPlone/controlpanel/browser/dateandtime.py b/Products/CMFPlone/controlpanel/browser/dateandtime.py\nindex a5d1ab3a2f..d9d606e825 100644\n--- a/Products/CMFPlone/controlpanel/browser/dateandtime.py\n+++ b/Products/CMFPlone/controlpanel/browser/dateandtime.py\n@@ -1,7 +1,7 @@\n from plone.app.registry.browser.controlpanel import ControlPanelFormWrapper\n from plone.app.registry.browser.controlpanel import RegistryEditForm\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IDateAndTimeSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n \n \n class DateAndTimeControlPanelForm(RegistryEditForm):\ndiff --git a/Products/CMFPlone/controlpanel/browser/editing.py b/Products/CMFPlone/controlpanel/browser/editing.py\nindex fe565eb88f..3c48883959 100644\n--- a/Products/CMFPlone/controlpanel/browser/editing.py\n+++ b/Products/CMFPlone/controlpanel/browser/editing.py\n@@ -1,6 +1,6 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IEditingSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form import interfaces\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/error_log_form.py b/Products/CMFPlone/controlpanel/browser/error_log_form.py\nindex 2500840461..7bd67ac821 100644\n--- a/Products/CMFPlone/controlpanel/browser/error_log_form.py\n+++ b/Products/CMFPlone/controlpanel/browser/error_log_form.py\n@@ -1,5 +1,5 @@\n from DateTime import DateTime\n-from Products.CMFPlone import PloneMessageFactory as _\n+from plone.base import PloneMessageFactory as _\n from Products.CMFPlone.utils import safe_nativestring\n from Products.Five import BrowserView\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/filter.py b/Products/CMFPlone/controlpanel/browser/filter.py\nindex 9e9955eb5b..09a3e8209f 100644\n--- a/Products/CMFPlone/controlpanel/browser/filter.py\n+++ b/Products/CMFPlone/controlpanel/browser/filter.py\n@@ -1,7 +1,7 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IFilterSchema\n from plone.z3cform import layout\n-from Products.CMFPlone import PloneMessageFactory as _  # NOQA\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n from z3c.form import button\ndiff --git a/Products/CMFPlone/controlpanel/browser/imaging.py b/Products/CMFPlone/controlpanel/browser/imaging.py\nindex f1ac6b1461..a5cb3e943c 100644\n--- a/Products/CMFPlone/controlpanel/browser/imaging.py\n+++ b/Products/CMFPlone/controlpanel/browser/imaging.py\n@@ -1,7 +1,7 @@\n from logging import getLogger\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces.controlpanel import IImagingSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n \n \n log = getLogger(\'Plone\')\ndiff --git a/Products/CMFPlone/controlpanel/browser/language.py b/Products/CMFPlone/controlpanel/browser/language.py\nindex 9b4085c63d..327eee58ec 100644\n--- a/Products/CMFPlone/controlpanel/browser/language.py\n+++ b/Products/CMFPlone/controlpanel/browser/language.py\n@@ -1,6 +1,6 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.i18n.interfaces import ILanguageSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.statusmessages.interfaces import IStatusMessage\n from z3c.form import button\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/mail.py b/Products/CMFPlone/controlpanel/browser/mail.py\nindex 44714bd389..4bb7c97ff2 100644\n--- a/Products/CMFPlone/controlpanel/browser/mail.py\n+++ b/Products/CMFPlone/controlpanel/browser/mail.py\n@@ -1,9 +1,9 @@\n from logging import getLogger\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces.controlpanel import IMailSchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.MailHost.MailHost import MailHostError\n from Products.statusmessages.interfaces import IStatusMessage\n from z3c.form import button\ndiff --git a/Products/CMFPlone/controlpanel/browser/maintenance.py b/Products/CMFPlone/controlpanel/browser/maintenance.py\nindex 6e0d91c356..c9baf3b9d3 100644\n--- a/Products/CMFPlone/controlpanel/browser/maintenance.py\n+++ b/Products/CMFPlone/controlpanel/browser/maintenance.py\n@@ -3,11 +3,11 @@\n from Acquisition import aq_inner\n from App.config import getConfiguration\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IMaintenanceSchema\n from plone.memoize.view import memoize\n from plone.protect import CheckAuthenticator\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from z3c.form import button\n from z3c.form import form\ndiff --git a/Products/CMFPlone/controlpanel/browser/markup.py b/Products/CMFPlone/controlpanel/browser/markup.py\nindex 6c3db1588c..e6e7949401 100644\n--- a/Products/CMFPlone/controlpanel/browser/markup.py\n+++ b/Products/CMFPlone/controlpanel/browser/markup.py\n@@ -1,6 +1,6 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IMarkupSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form.browser.checkbox import CheckBoxFieldWidget\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/navigation.py b/Products/CMFPlone/controlpanel/browser/navigation.py\nindex e6a3d8b117..e005fc6771 100644\n--- a/Products/CMFPlone/controlpanel/browser/navigation.py\n+++ b/Products/CMFPlone/controlpanel/browser/navigation.py\n@@ -1,6 +1,6 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import INavigationSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form.browser.checkbox import CheckBoxFieldWidget\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/quickinstaller.py b/Products/CMFPlone/controlpanel/browser/quickinstaller.py\nindex 9d4533a3d8..6e59ecbe9a 100644\n--- a/Products/CMFPlone/controlpanel/browser/quickinstaller.py\n+++ b/Products/CMFPlone/controlpanel/browser/quickinstaller.py\n@@ -1,7 +1,7 @@\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import INonInstallable\n from plone.memoize import view\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five.browser import BrowserView\n from Products.GenericSetup import EXTENSION\n from Products.GenericSetup.tool import UNKNOWN\ndiff --git a/Products/CMFPlone/controlpanel/browser/resourceregistry.py b/Products/CMFPlone/controlpanel/browser/resourceregistry.py\nindex 7f754b993c..e097435ad7 100644\n--- a/Products/CMFPlone/controlpanel/browser/resourceregistry.py\n+++ b/Products/CMFPlone/controlpanel/browser/resourceregistry.py\n@@ -1,7 +1,7 @@\n from App.config import getConfiguration\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IBundleRegistry\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.Five.browser import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\n from zope.component import getUtility\ndiff --git a/Products/CMFPlone/controlpanel/browser/search.py b/Products/CMFPlone/controlpanel/browser/search.py\nindex e447d466dd..063e893c18 100644\n--- a/Products/CMFPlone/controlpanel/browser/search.py\n+++ b/Products/CMFPlone/controlpanel/browser/search.py\n@@ -1,7 +1,7 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISearchSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n-from Products.CMFPlone.controlpanel.widgets import ReverseCheckBoxFieldWidget\n+from z3c.form.browser.checkbox import CheckBoxFieldWidget\n from zope.component import queryUtility\n from zope.schema.interfaces import IVocabularyFactory\n \n@@ -16,7 +16,7 @@ class SearchControlPanelForm(controlpanel.RegistryEditForm):\n     def updateFields(self):\n         super().updateFields()\n         self.fields[\'types_not_searched\'].widgetFactory = \\\n-            ReverseCheckBoxFieldWidget\n+            CheckBoxFieldWidget\n \n     def updateWidgets(self):\n         super().updateWidgets()\ndiff --git a/Products/CMFPlone/controlpanel/browser/security.py b/Products/CMFPlone/controlpanel/browser/security.py\nindex 3b45e30195..170457ef2c 100644\n--- a/Products/CMFPlone/controlpanel/browser/security.py\n+++ b/Products/CMFPlone/controlpanel/browser/security.py\n@@ -1,9 +1,9 @@\n from Acquisition import aq_inner\n from collections import defaultdict\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISecuritySchema\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.utils import migrate_from_email_login\n from Products.CMFPlone.controlpanel.utils import migrate_to_email_login\n from Products.Five.browser import BrowserView\ndiff --git a/Products/CMFPlone/controlpanel/browser/site.py b/Products/CMFPlone/controlpanel/browser/site.py\nindex f9412964f0..0d17b21558 100644\n--- a/Products/CMFPlone/controlpanel/browser/site.py\n+++ b/Products/CMFPlone/controlpanel/browser/site.py\n@@ -1,7 +1,7 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISiteSchema\n from plone.formwidget.namedfile.widget import NamedImageFieldWidget\n-from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form import interfaces\n \n \ndiff --git a/Products/CMFPlone/controlpanel/browser/socialmedia.py b/Products/CMFPlone/controlpanel/browser/socialmedia.py\nindex 9704671325..6cdb1ef2ed 100644\n--- a/Products/CMFPlone/controlpanel/browser/socialmedia.py\n+++ b/Products/CMFPlone/controlpanel/browser/socialmedia.py\n@@ -1,6 +1,6 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISocialMediaSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n \n \n class SocialControlPanelForm(controlpanel.RegistryEditForm):\ndiff --git a/Products/CMFPlone/controlpanel/browser/tinymce.py b/Products/CMFPlone/controlpanel/browser/tinymce.py\nindex c2d30b50c0..b286e71464 100644\n--- a/Products/CMFPlone/controlpanel/browser/tinymce.py\n+++ b/Products/CMFPlone/controlpanel/browser/tinymce.py\n@@ -1,11 +1,11 @@\n from plone.app.registry.browser import controlpanel\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ITinyMCEAdvancedSchema\n from plone.base.interfaces import ITinyMCELayoutSchema\n from plone.base.interfaces import ITinyMCEPluginSchema\n from plone.base.interfaces import ITinyMCEResourceTypesSchema\n from plone.base.interfaces import ITinyMCESchema\n from plone.base.interfaces import ITinyMCESpellCheckerSchema\n-from Products.CMFPlone import PloneMessageFactory as _\n from z3c.form import field\n from z3c.form import group\n from z3c.form.browser.checkbox import CheckBoxFieldWidget\ndiff --git a/Products/CMFPlone/controlpanel/browser/types.py b/Products/CMFPlone/controlpanel/browser/types.py\nindex 41a2f62bb0..b98fe6c347 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.py\n+++ b/Products/CMFPlone/controlpanel/browser/types.py\n@@ -2,6 +2,7 @@\n from operator import itemgetter\n from plone.app.workflow.remap import remap_workflow\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISearchSchema\n from plone.base.interfaces import ITypesSchema\n from plone.base.utils import safe_text\n@@ -9,7 +10,6 @@\n from plone.memoize.instance import memoize\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.events import ConfigurationChangedEvent\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups.py b/Products/CMFPlone/controlpanel/browser/usergroups.py\nindex fbe30201c8..330194ac64 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups.py\n@@ -2,12 +2,12 @@\n from Acquisition import aq_inner\n from itertools import chain\n from plone.autoform.form import AutoExtensibleForm\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISecuritySchema\n from plone.base.interfaces import IUserGroupsSettingsSchema\n from plone.z3cform import layout\n from Products.CMFCore.permissions import ManagePortal\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.utils import normalizeString\n from Products.Five.browser import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py b/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py\nindex a5cd6c9110..53d6591743 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupdetails.py\n@@ -1,7 +1,7 @@\n from Acquisition import aq_inner\n+from plone.base import PloneMessageFactory as _\n from plone.protect import CheckAuthenticator\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.browser.usergroups import (\n     UsersGroupsControlPanelView,\n )\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt\nindex ffbd86c817..6ff5ab4d2b 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.pt\n@@ -44,9 +44,8 @@\n                     Batch python:modules[\'Products.CMFPlone\'].Batch;\n                     resultcount python:len(view.searchResults);\n                     b_size python:resultcount if showAll else 20;\n-                    b_start python:0 if showAll or view.newSearch else view.atoi(request.get(\'b_start\',0));\n-                    b_start python:b_start if b_start &lt;= resultcount else resultcount - resultcount % b_size;\n-                    b_start python:b_start if b_start &lt; resultcount else max(b_start - b_size, 0);\n+                    b_start request/b_start|python:0;\n+                    b_start python:0 if showAll or view.newSearch else b_start;\n                     portal_url context/portal_url;\n                     groupquery python:view.makeQuery(groupname=view.groupname);\n                     groupkeyquery python:view.makeQuery(key=view.groupname);">\n@@ -88,21 +87,17 @@\n                               batchformkeys python:[\'searchstring\',\'_authenticator\',\'groupname\',\'form.submitted\'];\n                               many_users view/many_users">\n               <h2 i18n:translate="heading_groupmembers_current">Current group members</h2>\n-              <table class="table table-responsive table-bordered table-striped" summary="Group Members Listing"\n+              <table class="table table-responsive table-bordered table-striped pat-checklist" summary="Group Members Listing"\n                   tal:condition="view/groupMembers">\n                 <thead>\n                   <tr>\n-                      <th>\n-                          <input class="noborder"\n+                      <th style="width:1rem;">\n+                          <span class="form-check"><input class="form-check-input toggle-all"\n                                   type="checkbox"\n-                                  src="select_all_icon.png"\n                                   name="selectButton"\n                                   title="Select all items"\n-                                  onClick="toggleSelect(this, \'delete:list\');"\n-                                  tal:attributes="src string:$portal_url/select_all_icon.png"\n                                   alt="Select all items"\n-                                  i18n:attributes="title label_select_all_items; alt label_select_all_items;"/>\n-                                  <!--Remove user from this group-->\n+                                  i18n:attributes="title label_select_all_items; alt label_select_all_items;"/></span>\n                       </th>\n                       <th i18n:translate="listingheader_user_name">User name</th>\n                       <th i18n:translate="listingheader_email_address">E-mail Address</th>\n@@ -113,18 +108,18 @@\n                     <tr tal:condition="python:this_user is not None"\n                         tal:define="oddrow repeat/this_user/odd"\n                         tal:attributes="class python:oddrow and \'odd\' or \'even\'">\n-                        <td class="listingCheckbox">\n-                            <input\n+                        <td>\n+                            <span class="form-check"><input\n                                     type="checkbox"\n-                                    class="noborder notify"\n+                                    class="noborder notify form-check-input"\n                                     name="delete:list"\n                                     tal:attributes="value this_user/getId;\n-                                                    disabled python:this_user.canRemoveFromGroup(view.groupname) and default or \'disabled\'" />\n+                                                    disabled python:this_user.canRemoveFromGroup(view.groupname) and default or \'disabled\'" /></span>\n                         </td>\n \n                         <tal:block tal:condition="python: view.isGroup(this_user)">\n                           <td>\n-                            <img src="group.png" alt="" />\n+                            <img tal:replace="structure python:icons.tag(\'people\')">\n                             <a href="" tal:attributes="href python:\'@@usergroup-groupdetails?\' + view.makeQuery(groupname=this_user.getGroupName())" >\n                               <span tal:replace="this_user/getGroupTitleOrName | default" />\n                               (<span tal:replace="this_user/id" />)\n@@ -134,7 +129,7 @@\n \n                         <tal:block tal:condition="python: not view.isGroup(this_user)">\n                           <td>\n-                            <img src="user.png" alt="" />\n+                            <img tal:replace="structure python:icons.tag(\'person\')">\n                             <a href="" tal:attributes="href python:\'@@user-information?\' + view.makeQuery(userid=this_user.getId());\n                                                         title this_user/getId">\n                                 <span tal:replace="python:this_user.getProperty(\'fullname\')">Full Name</span>\n@@ -209,18 +204,14 @@\n                         </th>\n                       </tr>\n                     </thead>\n-                    <tbody>\n+                    <tbody class="pat-checklist">\n                       <tr tal:condition="batch">\n-                        <th>\n-                            <input class="noborder"\n+                        <th style="width:1rem;"><span class="form-check"><input class="noborder form-check-input toggle-all"\n                                     type="checkbox"\n-                                    src="select_all_icon.png"\n                                     name="selectButton"\n                                     title="Select all items"\n-                                    onClick="toggleSelect(this, \'add:list\');"\n-                                    tal:attributes="src string:$portal_url/select_all_icon.png"\n                                     alt="Select all items"\n-                                    i18n:attributes="title label_select_all_items; alt label_select_all_items;"/>\n+                                    i18n:attributes="title label_select_all_items; alt label_select_all_items;"/></span>\n                         </th>\n \n                         <th i18n:translate="listingheader_group_user_name">Group/User name</th>\n@@ -232,18 +223,18 @@\n                             tal:condition="python:this_user is not None"\n                             tal:attributes="class python:oddrow and \'odd\' or \'even\'">\n \n-                          <td class="listingCheckbox">\n-                            <input type="checkbox"\n-                                    class="noborder"\n+                          <td>\n+                            <span class="form-check"><input type="checkbox"\n+                                    class="noborder form-check-input"\n                                     name="add:list"\n                                     value="value"\n                                     tal:attributes="value this_user/getId;\n-                                                    disabled python:this_user.canAddToGroup(view.groupname) and default or \'disabled\'" />\n+                                                    disabled python:this_user.canAddToGroup(view.groupname) and default or \'disabled\'" /></span>\n                           </td>\n \n                           <td>\n                               <tal:block tal:condition="python:not view.isGroup(this_user)">\n-                                  <img src="user.png" alt="" />\n+                                  <img tal:replace="structure python:icons.tag(\'person\')">\n                                   <a href="" tal:attributes="href python:\'@@user-information?\' + view.makeQuery(userid=this_user.getId());\n                                                               title this_user/getId">\n                                     <span tal:replace="python:this_user.getProperty(\'fullname\')">Full Name</span>\n@@ -253,7 +244,7 @@\n                                   </a>\n                               </tal:block>\n                               <tal:block tal:condition="python: view.isGroup(this_user)">\n-                                  <img src="group.png" alt="" />\n+                                  <img tal:replace="structure python:icons.tag(\'people\')">\n                                   <a href="" tal:attributes="href python:\'@@usergroup-groupdetails?\' + view.makeQuery(groupname=this_user.getGroupName())">\n                                       <span tal:replace="this_user/getGroupTitleOrName | default" />\n                                       (<span tal:replace="this_user/id | default" />)\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\nindex 9dad09d7d0..2cd097703d 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\n@@ -1,5 +1,5 @@\n+from plone.base import PloneMessageFactory as _\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.browser.usergroups import (\n     UsersGroupsControlPanelView,\n )\n@@ -57,14 +57,21 @@ def update(self):\n             search = form.get(\'form.button.Search\', None) is not None\n             edit = form.get(\'form.button.Edit\', None) is not None and toDelete\n             add = form.get(\'form.button.Add\', None) is not None and toAdd\n-            findAll = form.get(\'form.button.FindAll\', None) is not None and \\\n-                not self.many_users\n+            isBatched = form.get("b_start", None) is not None\n+            findAll = (\n+                form.get(\'form.button.FindAll\', None) is not None\n+                and not self.many_users\n+            )\n+            unbatchedAll = (\n+                form.get("showAll", "") == "y"\n+                and not self.many_users\n+            )\n             # The search string should be cleared when one of the\n             # non-search buttons has been clicked.\n-            if findAll or edit or add:\n+            if findAll or unbatchedAll or edit or add:\n                 form[\'searchstring\'] = \'\'\n             self.searchString = form.get(\'searchstring\', \'\')\n-            if findAll or bool(self.searchString):\n+            if findAll or isBatched or unbatchedAll or bool(self.searchString):\n                 self.searchResults = self.getPotentialMembers(\n                     self.searchString)\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py b/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py\nindex 2ea0089388..532050ffdd 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupsoverview.py\n@@ -1,8 +1,8 @@\n from Acquisition import aq_inner\n from itertools import chain\n+from plone.base import PloneMessageFactory as _\n from plone.protect import CheckAuthenticator\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.browser.usergroups import (\n     UsersGroupsControlPanelView,\n )\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt b/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt\nindex f0651e77b6..22fc535621 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.pt\n@@ -52,18 +52,26 @@\n \n     <div id="content-core">\n \n+      <p class="lead mt-4" i18n:translate="">Group membership</p>\n+\n       <div class="autotabs">\n-        <nav class="autotoc-nav">\n-          <a href="${portal_url}/@@user-information?${userquery}"\n-             i18n:translate="title_personal_information_form">Personal Information</a>\n-          <a href="${portal_url}/@@user-preferences?${userquery}"\n-             i18n:translate="">Personal Preferences</a>\n-          <a class="active"\n-             href="${portal_url}/@@usergroup-usermembership?${userquery}"\n-             i18n:translate="label_group_memberships">Group Memberships</a>\n-        </nav>\n-\n-        <form method="post"\n+        <ul class="autotoc-nav nav nav-tabs">\n+          <li class="nav-item">\n+            <a class="nav-link" href="${portal_url}/@@user-information?${userquery}"\n+            i18n:translate="title_personal_information_form">Personal Information</a>\n+          </li>\n+          <li class="nav-item">\n+            <a class="nav-link" href="${portal_url}/@@user-preferences?${userquery}"\n+            i18n:translate="">Personal Preferences</a>\n+          </li>\n+          <li class="nav-item">\n+            <a class="nav-link active" class="active"\n+               href="${portal_url}/@@usergroup-usermembership?${userquery}"\n+               i18n:translate="label_group_memberships">Group Memberships</a>\n+          </li>\n+        </ul>\n+\n+        <form method="post" class="mt-3"\n               tal:attributes="action string:$portal_url/$template_id?userid=${userid}">\n \n           <h2 i18n:translate="heading_memberships_current">Current group memberships</h2>\n@@ -77,40 +85,39 @@\n                                 groupId group/getId;"\n                     tal:attributes="class python:\'odd\' if oddrow else \'even\'">\n                     <td>\n+                        <img tal:replace="structure python:icons.tag(\'people\')">\n                         <a href="@@usergroup-groupdetails"\n                            tal:attributes="href string:@@usergroup-groupdetails?groupname=${groupId}">\n-                        <tal:block replace="structure portal/group.png"/>&nbsp;<span\n-                                     tal:replace="group/getGroupTitleOrName">group name</span>\n+                           <span tal:replace="group/getGroupTitleOrName">group name</span>\n                         </a>\n                     </td>\n \n \n                     <td class="listingCheckbox">\n-                        <input type="checkbox"\n-                               class="noborder notify"\n+                        <span class="form-check"><input type="checkbox"\n+                               class="noborder notify form-check-input"\n                                name="delete:list"\n                                tal:attributes="value groupId;\n-                                               disabled python:member.canRemoveFromGroup(groupId) and default or \'disabled\'" />\n+                                               disabled python:member.canRemoveFromGroup(groupId) and default or \'disabled\'" /></span>\n                     </td>\n                 </tr>\n             </tal:block>\n           </table>\n           <p tal:condition="not:groups" i18n:translate="text_user_not_in_any_group">This user does not belong to any group.</p>\n-          <button class="btn btn-alert"\n+          <button class="btn btn-danger mb-4"\n                  type="submit"\n                  name="form.button.Delete"\n-                 value="Remove from selected groups"\n-                 i18n:attributes="value label_remove_selected_groups;"\n-                 tal:condition="groups" />\n+                 i18n:translate="label_remove_selected_groups"\n+                 tal:condition="groups">Remove from selected groups</button>\n \n           <h2 tal:condition="many_groups" i18n:translate="heading_search_groups">Search for groups</h2>\n           <h2 tal:condition="not:many_groups" i18n:translate="heading_assign_to_groups">Assign to groups</h2>\n \n-          <table class="table overflow-auto table-bordered table-striped text-center" summary="Groups">\n+          <table class="table overflow-auto table-bordered table-striped pat-checklist" summary="Groups">\n             <tr>\n               <th colspan="2" tal:condition="many_groups">\n                 <span tal:omit-tag="" i18n:translate="label_quick_search">Quick search</span>:\n-                      <input class="quickSearch"\n+                      <input class="quickSearch form-control"\n                              type="text"\n                              name="searchstring"\n                              value=""\n@@ -127,16 +134,13 @@\n             </tr>\n             <tal:block condition="python:results">\n                 <tr>\n-                  <th>\n-                      <input class="noborder"\n+                  <th style="width:1.5rem;">\n+                      <span class="form-check"><input class="form-check-input toggle-all"\n                              type="checkbox"\n-                             src="select_all_icon.png"\n                              name="selectButton"\n                              title="Select all items"\n-                             onClick="toggleSelect(this, \'add:list\');"\n-                             tal:attributes="src string:${context/portal_url}/select_all_icon.png"\n                              alt="Select all items"\n-                             i18n:attributes="title label_select_all_items; alt label_select_all_items;"/>\n+                             i18n:attributes="title label_select_all_items; alt label_select_all_items;"/></span>\n                   </th>\n                   <th i18n:translate="listingheader_group_name">Group Name</th>\n                 </tr>\n@@ -145,18 +149,18 @@\n                       tal:attributes="class python:\'odd\' if oddrow else \'even\'">\n \n                     <td class="listingCheckbox">\n-                      <input type="checkbox"\n-                             class="noborder"\n+                      <span class="form-check"><input type="checkbox"\n+                             class="form-check-input"\n                              name="add:list"\n                              value="value"\n-                                 tal:define="calcId obj/getGroupId | obj/getId;\n-                                             canAddToGroup python:member.canAddToGroup(calcId) and (\'Manager\' not in obj.getRoles() or view.is_zope_manager)"\n-                                 tal:attributes="value calcId;\n-                                                 disabled python:canAddToGroup and default or \'disabled\'" />\n+                             tal:define="calcId obj/getGroupId | obj/getId;\n+                                         canAddToGroup python:member.canAddToGroup(calcId) and (\'Manager\' not in obj.getRoles() or view.is_zope_manager)"\n+                             tal:attributes="value calcId;\n+                                             disabled python:canAddToGroup and default or \'disabled\'" /></span>\n                     </td>\n \n                     <td>\n-                        <img src="group.png" alt="" />\n+                        <img tal:replace="structure python:icons.tag(\'people\')">\n                         <a href="" tal:attributes="href python:\'@@usergroup-groupdetails?\'+mq(groupname=obj.getGroupName())"\n                                   tal:content="obj/getGroupTitleOrName | default">\n                               <span i18n:translate="link_groupname_not_available">\n@@ -194,10 +198,8 @@\n           <button class="btn btn-primary"\n                  type="submit"\n                  name="form.button.Add"\n-                 value="Add user to selected groups"\n                  tal:condition="batch"\n-                 i18n:translate=""\n-                 i18n:attributes="value label_add_user_to_group;">Add user to selected groups</button>\n+                 i18n:translate="label_add_user_to_group">Add user to selected groups</button>\n           <input tal:replace="structure context/@@authenticator/authenticator" />\n \n         </form>\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py b/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py\nindex 0089076bdc..71a4e123b1 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_usermembership.py\n@@ -1,5 +1,5 @@\n+from plone.base import PloneMessageFactory as _\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.browser.usergroups import (\n     UsersGroupsControlPanelView,\n )\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py b/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py\nindex c4e08cdbb6..8c14b9ad82 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.py\n@@ -1,9 +1,9 @@\n from Acquisition import aq_inner\n from itertools import chain\n+from plone.base import PloneMessageFactory as _\n from plone.protect import CheckAuthenticator\n from Products.CMFCore.interfaces import ISiteRoot\n from Products.CMFCore.utils import getToolByName\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.controlpanel.browser.usergroups import (\n     UsersGroupsControlPanelView,\n )\ndiff --git a/Products/CMFPlone/controlpanel/permissions.zcml b/Products/CMFPlone/controlpanel/permissions.zcml\nindex 249aeb6c71..be7eda7479 100644\n--- a/Products/CMFPlone/controlpanel/permissions.zcml\n+++ b/Products/CMFPlone/controlpanel/permissions.zcml\n@@ -1,88 +1,70 @@\n-<configure\n-    xmlns="http://namespaces.zope.org/zope">\n+<configure xmlns="http://namespaces.zope.org/zope">\n \n-  <permission id="plone.app.controlpanel.Overview"\n-              title="Plone Site Setup: Overview">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Overview"\n+      title="Plone Site Setup: Overview"\n+      />\n \n-  <permission id="plone.app.controlpanel.Editing"\n-              title="Plone Site Setup: Editing">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Editing"\n+      title="Plone Site Setup: Editing"\n+      />\n \n-  <permission id="plone.app.controlpanel.Filtering"\n-              title="Plone Site Setup: Filtering">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Filtering"\n+      title="Plone Site Setup: Filtering"\n+      />\n \n-  <permission id="plone.app.controlpanel.Language"\n-              title="Plone Site Setup: Language">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Language"\n+      title="Plone Site Setup: Language"\n+      />\n \n-  <permission id="plone.app.controlpanel.Mail"\n-              title="Plone Site Setup: Mail">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n-\n-  <permission id="plone.app.controlpanel.Markup"\n-              title="Plone Site Setup: Markup">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Mail"\n+      title="Plone Site Setup: Mail"\n+      />\n \n-  <permission id="plone.app.controlpanel.Navigation"\n-              title="Plone Site Setup: Navigation">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Markup"\n+      title="Plone Site Setup: Markup"\n+      />\n \n-  <permission id="plone.app.controlpanel.Search"\n-              title="Plone Site Setup: Search">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Navigation"\n+      title="Plone Site Setup: Navigation"\n+      />\n \n-  <permission id="plone.app.controlpanel.Security"\n-              title="Plone Site Setup: Security">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Search"\n+      title="Plone Site Setup: Search"\n+      />\n \n-  <permission id="plone.app.controlpanel.Site"\n-              title="Plone Site Setup: Site">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Security"\n+      title="Plone Site Setup: Security"\n+      />\n \n-  <permission id="plone.app.controlpanel.Themes"\n-              title="Plone Site Setup: Themes">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Site"\n+      title="Plone Site Setup: Site"\n+      />\n \n-  <permission id="plone.app.controlpanel.Types"\n-              title="Plone Site Setup: Types">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.Types"\n+      title="Plone Site Setup: Types"\n+      />\n \n-  <permission id="plone.app.controlpanel.UsersAndGroups"\n-              title="Plone Site Setup: Users and Groups">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-  </permission>\n+  <permission\n+      id="plone.app.controlpanel.UsersAndGroups"\n+      title="Plone Site Setup: Users and Groups"\n+      />\n \n-  <permission id="Products.CMFPlone.InspectRelations"\n-              title="Inspect Relations">\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n+  <permission\n+      id="Products.CMFPlone.InspectRelations"\n+      title="Inspect Relations"\n+      >\n+    <role name="Manager" />\n   </permission>\n \n </configure>\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\nindex 4772dbe5c4..ebcf1f3b02 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_search.py\n@@ -71,5 +71,5 @@ def test_types_not_searched(self):\n \n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(ISearchSchema, prefix="plone")\n-        self.assertFalse(\'Discussion Item\' in settings.types_not_searched)\n-        self.assertFalse(\'News Item Item\' in settings.types_not_searched)\n+        self.assertTrue(\'Discussion Item\' in settings.types_not_searched)\n+        self.assertTrue(\'News Item\' in settings.types_not_searched)\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\nindex d2803c0cde..3000ecc0d3 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups_siteadmin_role.py\n@@ -218,7 +218,7 @@ def test_usergroup_usermembership_blocks_escalation(self):\n             self.portal_url + \'/@@usergroup-usermembership?userid=%s\' % self.normal_user)\n         contents = self._simplify_white_space(self.browser.contents)\n         self.assertTrue(\n-            \'<input type="checkbox" class="noborder" name="add:list" \'\n+            \'<input type="checkbox" class="form-check-input" name="add:list" \'\n             \'value="Administrators" disabled="disabled" />\' in contents\n         )\n \ndiff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py\nindex afa1dbb5b6..e8f9ae365c 100644\n--- a/Products/CMFPlone/factory.py\n+++ b/Products/CMFPlone/factory.py\n@@ -1,7 +1,7 @@\n from logging import getLogger\n+from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import INonInstallable\n from plone.registry.interfaces import IRegistry\n-from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.events import SiteManagerCreatedEvent\n from Products.CMFPlone.Portal import PloneSite\n from Products.GenericSetup.tool import SetupTool\ndiff --git a/Products/CMFPlone/profiles/default/metadata.xml b/Products/CMFPlone/profiles/default/metadata.xml\nindex f8c7ba2107..09e062981a 100644\n--- a/Products/CMFPlone/profiles/default/metadata.xml\n+++ b/Products/CMFPlone/profiles/default/metadata.xml\n@@ -1,4 +1,4 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>6010</version>\n+  <version>6014</version>\n </metadata>\ndiff --git a/Products/CMFPlone/profiles/default/rolemap.xml b/Products/CMFPlone/profiles/default/rolemap.xml\nindex 04c4a47979..774005a03e 100644\n--- a/Products/CMFPlone/profiles/default/rolemap.xml\n+++ b/Products/CMFPlone/profiles/default/rolemap.xml\n@@ -1,217 +1,375 @@\n-<?xml version="1.0"?>\n+<?xml version="1.0" encoding="utf-8"?>\n <rolemap>\n   <roles>\n-    <role name="Anonymous"/>\n-    <role name="Authenticated"/>\n-    <role name="Manager"/>\n-    <role name="Site Administrator"/>\n-    <role name="Member"/>\n-    <role name="Owner"/>\n-    <role name="Reviewer"/>\n+    <role name="Anonymous" />\n+    <role name="Authenticated" />\n+    <role name="Manager" />\n+    <role name="Site Administrator" />\n+    <role name="Member" />\n+    <role name="Owner" />\n+    <role name="Reviewer" />\n     <role name="Reader" />\n     <role name="Editor" />\n     <role name="Contributor" />\n   </roles>\n   <permissions>\n-    <permission name="Access inactive portal content"\n-                acquire="True">\n-      <role name="Owner"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Add portal content" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="Add portal folders" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Contributor"/>\n-    </permission>\n-    <permission name="Allow sendto" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Change local roles" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Copy or Move" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Delete objects" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="FTP access" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="List folder contents" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n+    <permission acquire="True"\n+                name="Access inactive portal content"\n+    >\n+      <role name="Owner" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Add portal content"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Add portal folders"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Allow sendto"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Change local roles"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Copy or Move"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Delete objects"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="FTP access"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="List folder contents"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n       <role name="Reviewer" />\n       <role name="Editor" />\n       <role name="Contributor" />\n     </permission>\n-    <permission name="List portal members" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="List undoable changes" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Mail forgotten password" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Manage properties" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Modify view template" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Request review" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Reply to item" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Review portal content" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Reviewer"/>\n-    </permission>\n-    <permission name="Search ZCatalog" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Set own password" acquire="False">\n-      <role name="Authenticated"/>\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Set own properties" acquire="False">\n-      <role name="Authenticated"/>\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Undo changes" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="Use mailhost services" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Use version control" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="View Groups" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="View management screens"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Owner"/>\n-    </permission>\n-    <permission name="WebDAV access" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="WebDAV Lock items" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="WebDAV Unlock items" acquire="True">\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Portlets: Manage portlets"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Portlets: Manage own portlets"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Portlets: View dashboard"\n-                acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Member"/>\n-    </permission>\n-    <permission name="Content rules: Manage rules"\n-                acquire="False">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="View"\n-                acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Reader" />\n-        <role name="Editor" />\n-        <role name="Contributor" />\n-    </permission>\n-    <permission name="Access contents information"\n-                acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Reader" />\n-        <role name="Editor" />\n-        <role name="Contributor" />\n-    </permission>\n-    <permission name="Modify portal content"\n-                acquire="True">\n-        <role name="Site Administrator"/>\n-        <role name="Editor" />\n-        <role name="Owner" />\n-    </permission>\n-    <permission name="Add portal member"\n-                acquire="False">\n-        <role name="Manager" />\n-        <role name="Site Administrator"/>\n-        <role name="Owner" />\n-    </permission>\n-    <permission name="plone.resourceeditor: Manage Sources"\n-                acquire="False">\n-      <role name="Manager" />\n-      <role name="Site Administrator"/>\n-    </permission>\n-    <permission name="Show Toolbar"\n-                acquire="False">\n-      <role name="Authenticated"/>\n-    </permission>\n-    <permission name="Manage Context Aliases" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n-      <role name="Owner"/>\n-      <role name="Editor"/>\n-    </permission>\n-    <permission name="Manage Portal Aliases" acquire="True">\n-      <role name="Manager"/>\n-      <role name="Site Administrator"/>\n+    <permission acquire="True"\n+                name="List portal members"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="List undoable changes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Mail forgotten password"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage properties"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Modify view template"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Overview"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Editing"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Filtering"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Language"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Mail"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Markup"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Navigation"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Search"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Security"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Site"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Themes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: TinyMCE"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Types"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Plone Site Setup: Users and Groups"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Request review"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Reply to item"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Review portal content"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Reviewer" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Search ZCatalog"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Set own password"\n+    >\n+      <role name="Authenticated" />\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Set own properties"\n+    >\n+      <role name="Authenticated" />\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Undo changes"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Use mailhost services"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Use version control"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View Groups"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View management screens"\n+    >\n+      <role name="Manager" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV access"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV Lock items"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="WebDAV Unlock items"\n+    >\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: Manage portlets"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: Manage own portlets"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Portlets: View dashboard"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Member" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Content rules: Manage rules"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="View"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Reader" />\n+      <role name="Editor" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Access contents information"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Reader" />\n+      <role name="Editor" />\n+      <role name="Contributor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Modify portal content"\n+    >\n+      <role name="Site Administrator" />\n+      <role name="Editor" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Add portal member"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+    </permission>\n+    <permission acquire="False"\n+                name="plone.resourceeditor: Manage Sources"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="False"\n+                name="Show Toolbar"\n+    >\n+      <role name="Authenticated" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage Context Aliases"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+      <role name="Owner" />\n+      <role name="Editor" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Manage Portal Aliases"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n+    </permission>\n+    <permission acquire="True"\n+                name="Inspect Relations"\n+    >\n+      <role name="Manager" />\n+      <role name="Site Administrator" />\n     </permission>\n   </permissions>\n </rolemap>\ndiff --git a/Products/CMFPlone/relationhelper.py b/Products/CMFPlone/relationhelper.py\nindex 14b4c37c9e..b9cbd3e568 100644\n--- a/Products/CMFPlone/relationhelper.py\n+++ b/Products/CMFPlone/relationhelper.py\n@@ -5,10 +5,10 @@\n from plone.app.linkintegrity.utils import referencedRelationship\n from plone.app.relationfield.event import update_behavior_relations\n from plone.app.uuid.utils import uuidToObject\n+from plone.base import PloneMessageFactory as _\n from plone.dexterity.interfaces import IDexterityContent\n from plone.dexterity.utils import iterSchemataForType\n from Products.CMFCore.interfaces import IContentish\n-from Products.CMFPlone import PloneMessageFactory as _\n from z3c.relationfield import event\n from z3c.relationfield import RelationValue\n from z3c.relationfield.event import updateRelations\ndiff --git a/Products/CMFPlone/resources/browser/resource.py b/Products/CMFPlone/resources/browser/resource.py\nindex 9c4735cab1..c07f71f20a 100644\n--- a/Products/CMFPlone/resources/browser/resource.py\n+++ b/Products/CMFPlone/resources/browser/resource.py\n@@ -187,6 +187,7 @@ def check_dependencies(bundle_name, depends, bundles):\n                     async_=record.load_async or None,\n                     defer=record.load_defer or None,\n                     integrity=not external,\n+                    **{\'data-bundle\': name},\n                 )\n             if record.csscompilation:\n                 depends = check_dependencies(name, record.depends, css_names)\n@@ -206,6 +207,7 @@ def check_dependencies(bundle_name, depends, bundles):\n                     url=record.csscompilation if external else None,\n                     media="all",\n                     rel="stylesheet",\n+                    **{\'data-bundle\': name},\n                 )\n \n         # Collect theme data\ndiff --git a/Products/CMFPlone/tests/pwreset_browser.rst b/Products/CMFPlone/tests/pwreset_browser.rst\nindex 795e781d95..3ff5557329 100644\n--- a/Products/CMFPlone/tests/pwreset_browser.rst\n+++ b/Products/CMFPlone/tests/pwreset_browser.rst\n@@ -8,6 +8,7 @@ Note that our usage of testbrowser is unusual and inconsistent, mostly\n because Plone forms have inconsistencies and because testbrowser makes\n assumptions that are not true for Plone forms.\n \n+  >>> from DateTime import DateTime\n   >>> from plone.testing.zope import Browser\n   >>> from plone.app.testing import TEST_USER_NAME, TEST_USER_PASSWORD\n   >>> browser = Browser(layer[\'app\'])\n@@ -137,6 +138,23 @@ e-mail.\n   >>> "You have been registered" in browser.contents\n   True\n \n+The login times are set to the default in 2000:\n+\n+  >>> portal_membership = layer[\'portal\'].portal_membership\n+  >>> member = portal_membership.getMemberById(\'jsmith\')\n+  >>> login_time = member.getProperty(\'login_time\')\n+  >>> isinstance(login_time, DateTime)\n+  True\n+  >>> login_time.Date()\n+  \'2000/01/01\'\n+  >>> last_login_time = member.getProperty(\'last_login_time\')\n+  >>> isinstance(last_login_time, DateTime)\n+  True\n+  >>> last_login_time <= login_time\n+  True\n+  >>> last_login_time.Date()\n+  \'2000/01/01\'\n+\n We are not logged in yet at this point.  Let\'s try to log in:\n \n   >>> browser.getLink(\'Log in\').click()\n@@ -148,6 +166,25 @@ We are not logged in yet at this point.  Let\'s try to log in:\n   >>> "You are now logged in" in browser.contents\n   True\n \n+Two login time properties should have been set on the user:\n+\n+  >>> member = portal_membership.getMemberById(\'jsmith\')\n+  >>> login_time = member.getProperty(\'login_time\')\n+  >>> isinstance(login_time, DateTime)\n+  True\n+  >>> last_login_time = member.getProperty(\'last_login_time\')\n+  >>> isinstance(last_login_time, DateTime)\n+  True\n+  >>> last_login_time <= login_time\n+  True\n+\n+The default login time is January 1 2000.  Check that it is much newer now:\n+\n+  >>> login_time > DateTime(2020, 2, 2)\n+  True\n+  >>> last_login_time > DateTime(2020, 2, 2)\n+  True\n+\n Log out again:\n \n   >>> browser.getLink(\'Log out\').click()\n@@ -210,6 +247,12 @@ then we extract the address that lets us reset our password:\n   >>> b"If you didn\'t expect to receive this email" in msg\n   True\n \n+Save the current login times again so we can compare them after password reset.\n+\n+  >>> member = portal_membership.getMemberById(\'jsmith\')\n+  >>> login_time = member.getProperty(\'login_time\')\n+  >>> last_login_time = member.getProperty(\'last_login_time\')\n+\n Now that we have the address, we will reset our password:\n \n   >>> browser.open(address)\n@@ -222,11 +265,24 @@ Now that we have the address, we will reset our password:\n   >>> form.getControl(name=\'password2\').value = \'secretion\'\n   >>> form.submit()\n \n-We can now logged in:\n+By default \'autologin_after_password_reset\' is turned on, so we are now logged in:\n \n   >>> "Password reset successful, you are logged in now!" in browser.contents\n   True\n \n+The two login time properties should have been updated on the user:\n+\n+  >>> member = portal_membership.getMemberById(\'jsmith\')\n+  >>> login_time < member.getProperty(\'login_time\')\n+  True\n+  >>> last_login_time < member.getProperty(\'last_login_time\')\n+  True\n+\n+The last login time is now set to the previous value of login time:\n+\n+  >>> login_time == member.getProperty(\'last_login_time\')\n+  True\n+\n Log out again:\n \n   >>> browser.getLink(\'Log out\').click()\ndiff --git a/Products/CMFPlone/tests/testRegistrationTool.py b/Products/CMFPlone/tests/testRegistrationTool.py\nindex a49561a014..f811068627 100644\n--- a/Products/CMFPlone/tests/testRegistrationTool.py\n+++ b/Products/CMFPlone/tests/testRegistrationTool.py\n@@ -1,4 +1,3 @@\n-from re import T\n from AccessControl import Unauthorized\n from plone.app.testing import TEST_USER_PASSWORD\n from plone.base.interfaces.controlpanel import IMailSchema\n@@ -9,6 +8,7 @@\n from Products.CMFPlone.tests import PloneTestCase\n from Products.CMFPlone.tests.utils import MockMailHost\n from Products.MailHost.interfaces import IMailHost\n+from re import T\n from zope.component import getSiteManager\n from zope.component import getUtility\n \ndiff --git a/Products/CMFPlone/tests/testResourceRegistries.py b/Products/CMFPlone/tests/testResourceRegistries.py\nindex ca3a8dd0ee..211bce6912 100644\n--- a/Products/CMFPlone/tests/testResourceRegistries.py\n+++ b/Products/CMFPlone/tests/testResourceRegistries.py\n@@ -82,6 +82,13 @@ def test_scripts_viewlet(self):\n         self.assertIn("++plone++static/bundle-plone/bundle.min.js", results)\n         self.assertIn("http://nohost/plone/++webresource++", results)\n \n+    def test_scripts_data_bundle_attr(self):\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        self._make_test_bundle()\n+        scripts.update()\n+        result = scripts.render()\n+        self.assertIn(\'data-bundle="foobar"\', result)\n+\n     def test_scripts_viewlet_anonymous(self):\n         logout()\n         scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n@@ -188,6 +195,25 @@ def test_styles_viewlet(self):\n         self.assertIn("++theme++barceloneta/css/barceloneta.min.css", results)\n         self.assertIn("http://nohost/plone/++webresource++", results)\n \n+    def test_styles_data_bundle_attr(self):\n+        styles = StylesView(self.layer["portal"], self.layer["request"], None)\n+\n+        # add some bundle to test with\n+        registry = getUtility(IRegistry)\n+\n+        bundles = registry.collectionOfInterface(\n+            IBundleRegistry, prefix="plone.bundles"\n+        )\n+        bundle = bundles.add("foobar")\n+        bundle.name = "foobar"\n+        bundle.jscompilation = "http://foo.bar/foobar.js"\n+        bundle.csscompilation = "http://foo.bar/foobar.css"\n+        bundle.resources = ["foobar"]\n+\n+        styles.update()\n+        results = styles.render()\n+        self.assertIn(\'data-bundle="foobar"\', results)\n+\n     def test_styles_viewlet_anonymous(self):\n         logout()\n         styles = StylesView(self.layer["portal"], self.layer["request"], None)\ndiff --git a/Products/CMFPlone/tests/test_login_form.py b/Products/CMFPlone/tests/test_login_form.py\nindex 94dfc4683a..3cf0ecde6a 100644\n--- a/Products/CMFPlone/tests/test_login_form.py\n+++ b/Products/CMFPlone/tests/test_login_form.py\n@@ -1,6 +1,6 @@\n from DateTime import DateTime\n-from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.app.testing import TEST_USER_PASSWORD\n+from plone.app.z3cform.interfaces import IPloneFormLayer\n from Products.CMFCore.permissions import SetOwnProperties\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_FUNCTIONAL_TESTING\ndiff --git a/Products/CMFPlone/tests/test_redirect_after_login.py b/Products/CMFPlone/tests/test_redirect_after_login.py\nindex cce982f158..4eb69b4a35 100644\n--- a/Products/CMFPlone/tests/test_redirect_after_login.py\n+++ b/Products/CMFPlone/tests/test_redirect_after_login.py\n@@ -1,3 +1,4 @@\n+from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n from plone.base.interfaces import IInitialLogin\n@@ -10,6 +11,8 @@\n from zope.interface import Interface\n from zope.publisher.interfaces import IRequest\n \n+import quopri\n+import transaction\n import unittest\n \n \n@@ -190,3 +193,79 @@ def test_initiallogin_adapter(self):\n         self.assertIn(\'You are now logged out.\',\n                       self.browser.contents,\n                       \'Logout status message not displayed.\')\n+\n+    def test_password_reset_uses_all_adapters(self):\n+        # By default, when you reset your password, you are directly logged in.\n+        # An initial login adapter should be active.\n+        # And the redirect after login adapter too.\n+        from plone.registry.interfaces import IRegistry\n+        from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n+        from zope.component import getGlobalSiteManager\n+        from zope.component import getUtility\n+\n+        # We need to configure the mailhost first.\n+        registry = getUtility(IRegistry, context=self.portal)\n+        mail_settings = registry.forInterface(IMailSchema, prefix="plone")\n+        mail_settings.smtp_host = u\'localhost\'\n+        mail_settings.email_from_address = \'smith@example.com\'\n+        # and an email address for the test user:\n+        member = self.portal.portal_membership.getMemberById(TEST_USER_ID)\n+        member.setProperties(email="dummy@example.org")\n+        transaction.commit()\n+\n+        # Fill in the password reset form.\n+        self.browser.open(\'http://nohost/plone/@@login-help\')\n+        form = self.browser.getForm(index=1)\n+        form.getControl(name=\'form.widgets.reset_password\').value = TEST_USER_NAME\n+        form.submit(name=\'form.buttons.reset\')\n+\n+        # Get the password reset mail from the dummy mailhost.\n+        mailhost = self.portal.MailHost\n+        self.assertEqual(len(mailhost.messages), 1)\n+        msg = mailhost.messages[0]\n+\n+        # Extract the address that lets us reset our password.\n+        msg = quopri.decodestring(msg)\n+        please_visit_text = b"reset your password for Plone site site:"\n+        self.assertIn(please_visit_text, msg)\n+        url_index = msg.index(please_visit_text) + len(please_visit_text)\n+        address = msg[url_index:].strip().split()[0].decode()\n+        self.assertTrue(address.startswith(u\'http://nohost/plone/passwordreset/\'))\n+\n+        # Now that we have the address, we will reset our password:\n+\n+        self.browser.open(address)\n+        self.assertIn("Set your password", self.browser.contents)\n+        form = self.browser.getForm(name=\'pwreset_action\')\n+        form.getControl(name=\'userid\').value = TEST_USER_NAME\n+        form.getControl(name=\'password\').value = \'secretion\'\n+        form.getControl(name=\'password2\').value = \'secretion\'\n+\n+        # Register our adapters, submit the form, and unregister them.\n+        gsm = getGlobalSiteManager()\n+        gsm.registerAdapter(AfterLoginAdapter, (Interface, IRequest))\n+        gsm.registerAdapter(InitialLoginAdapter, (Interface, IRequest))\n+        try:\n+            form.submit()\n+        finally:\n+            gsm.unregisterAdapter(InitialLoginAdapter, (Interface, IRequest))\n+            gsm.unregisterAdapter(AfterLoginAdapter, (Interface, IRequest))\n+\n+        # By default \'autologin_after_password_reset\' is turned on,\n+        # so we are now logged in:\n+        self.assertIn(\n+            "Password reset successful, you are logged in now!",\n+            self.browser.contents,\n+        )\n+        self.assertEqual(self.browser.url,\n+                         \'http://nohost/plone/sitemap\',\n+                         \'Successful login did not use the adapter for \'\n+                         \'redirect.\')\n+        self.assertEqual(self.portal.foo, \'foo\')\n+\n+        # Now log out.\n+        self.browser.getLink(\'Log out\').click()\n+\n+        self.assertIn(\'You are now logged out.\',\n+                      self.browser.contents,\n+                      \'Logout status message not displayed.\')\ndiff --git a/README.md b/README.md\nnew file mode 100644\nindex 0000000000..f71ba32de0\n--- /dev/null\n+++ b/README.md\n@@ -0,0 +1,141 @@\n+<p align="center">\n+    <img alt="Plone Logo" width="200px" src="https://raw.githubusercontent.com/plone/.github/main/plone-logo.png">\n+</p>\n+\n+<h1 align="center">\n+  Plone\n+</h1>\n+\n+<div align="center">\n+\n+[![PyPI - Wheel](https://img.shields.io/pypi/wheel/plone)](https://pypi.org/project/plone/)\n+[![PyPI - License](https://img.shields.io/pypi/l/plone)](https://pypi.org/project/plone/)\n+[![PyPI - Status](https://img.shields.io/pypi/status/plone)](https://pypi.org/project/plone/)\n+\n+[![GitHub contributors](https://img.shields.io/github/contributors/plone/Products.CMFPlone)](https://github.com/plone/Products.CMFPlone)\n+![GitHub Repo stars](https://img.shields.io/github/stars/plone/Plone?style=flat-square)\n+\n+</div>\n+\n+Plone is a mature, secure, and user-friendly content management system (CMS).\n+\n+Plone was first released to the public on October 4, 2001.\n+\n+Plone has the maturity, stability, and reliability of an application maintained by open source developers with decades of experience, while continually evolving and adapting to modern technology.\n+\n+Lots of customizations can be made trough-the-web, such as creating content types, themes, workflows, and much more.\n+Plone may be extended and used as a framework on which to build custom CMS-like solutions.\n+\n+Plone works as a\n+\n+- Full-featured server-side rendered HTML CMS.\n+- React-based frontend for editing and viewing content, backed by a server with a REST API.\n+- Headless CMS server with a REST API, allowing a developer to build a custom frontend with their chosen technology.\n+\n+\n+<h2 align="center">\n+  Installing Plone\n+</h2>\n+\n+Plone is available on Linux, Microsoft Windows, macOS, and BSD platforms.\n+\n+Plone may be run as a container in the cloud with Docker and other Open Containers Initiative compliant platforms.\n+[Example Dockerfiles](https://6.docs.plone.org/install/containers/images/index.html) and base images are available.\n+\n+[Install Plone by choosing an option from plone.org](https://plone.org/download)\n+\n+\n+<h2 align="center">\n+  Documentation\n+</h2>\n+\n+Consult [the official Plone documentation](https://6.docs.plone.org) with information for different audiences.\n+\n+For trainings [comprehensive Plone training material](https://training.plone.org) is available.\n+\n+\n+<h2 align="center">\n+  What is Plone?\n+</h2>\n+\n+Plone is a ready-to-run content management system, offering a complete set of features needed by a wide variety of organizations.\n+\n+Security is built into Plone\'s architecture from the ground up.\n+Plone offers fine-grained permission control over content and actions.\n+\n+Plone is easy to set up, extremely flexible,\n+and provides you with a system for managing web content that is ideal for project groups, communities, websites, extranets, and intranets.\n+\n+- **Plone is easy to install.**\n+  Several installation options are available for either your local machine or on servers in the cloud.\n+\n+- **Plone empowers content editors and web application developers.**\n+  The Plone Team includes usability experts who have made Plone easy and attractive for content managers to add, update, and maintain content.\n+\n+- **Plone is international.**\n+  The Plone interface has more than 35 translations, and tools exist for managing multilingual content.\n+\n+- **Plone follows standards and is inclusive.**\n+  Plone carefully follows standards for usability and accessibility.\n+  Plone is compliant with WCAG 2.1 level AA and aims for ATAG 2.0 level AA.\n+\n+- **Plone is open source.**\n+  Plone is licensed under the GNU General Public License, the same license used by Linux.\n+  This gives you the right to use Plone without a license fee, and to improve upon the product.\n+\n+- **Plone is supported.**\n+  There are over two hundred active developers in the Plone Development Team around the world, and a multitude of companies that specialize in Plone development and support.\n+\n+- **Plone is extensible.**\n+  There is a multitude of add-on products for Plone to add new features and content types.\n+  In addition, Plone can be scripted using web standard solutions and open source languages.\n+\n+- **Plone is technology neutral.**\n+  Plone can interoperate with most relational database systems\xe2\x80\x94both open source and commercial\xe2\x80\x94and runs on a vast array of\n+  platforms, including Linux, Windows, macOS, and BSD.\n+\n+\n+<h2 align="center">\n+Technical overview\n+</h2>\n+\n+Plone is a content management platform with its backend written in Python.\n+Plone has a choice of frontend, either Classic UI using server-side templates or Volto written in modern React-based JavaScript.\n+It builds upon Zope, an open source web application server and development system, and thus on the pluggable Zope Component Architecture (ZCA).\n+\n+Python is the easy to learn, widely used, and supported open source programming language.\n+Python can be used to add new features to Plone and used to understand or make changes to the way that Plone works.\n+\n+Plone stores its contents in Zope\'s built-in transactional hierarchical object database, the ZODB.\n+The ZODB can be connected to simple file-storages, scalable ZEO-Servers or Postgres, MySQL, and Oracle.\n+There are add-ons and techniques, however, to share information with other sources, such as relational databases, LDAP, filesystem\n+files, and so on.\n+\n+\n+<h2 align="center">\n+Official Resources\n+</h2>\n+\n+* [plone.org](https://plone.org/) - Official website for developers, community, decision makers, and evaluators.\n+* [Plone support](https://plone.org/support) - Where to find help.\n+* [community.plone.org](https://community.plone.org/) - Official community forum, the best place to get help.\n+* [Plone 6 Documentation](https://6.docs.plone.org/) - Official documentation for developers, integrators, and content editors.\n+* [training.plone.org](https://training.plone.org/) - Trainings for developers, integrators, content editors, and designers.\n+* [`plone.api`](https://6.docs.plone.org/develop/plone.api/docs/index.html) - Documentation for `plone.api`.\n+* [`plone.restapi`](https://plonerestapi.readthedocs.io/en/latest/) - Documentation for `plone.restapi`.\n+* [Discord](https://discord.gg/zFY3EBbjaj) - Official Plone chat, voice, and video service.\n+\n+<h2 align="center">\n+This project is supported by\n+</h2>\n+\n+<p align="center">\n+    <a href="https://plone.org/foundation/">\n+      <img alt="Plone Logo" width="200px" src="https://raw.githubusercontent.com/plone/.github/main/plone-foundation.png">\n+    </a>\n+</p>\n+\n+<h2 align="center">\n+License\n+</h2>\n+The project is licensed under the GPLv2.\ndiff --git a/README.rst b/README.rst\ndeleted file mode 100644\nindex 243d3c582c..0000000000\n--- a/README.rst\n+++ /dev/null\n@@ -1,100 +0,0 @@\n-About Plone\n-===========\n-\n-Plone is a mature, secure and user-friendly Content Management System (CMS).\n-\n-Plone - and the Open Source community behind it - aggregates more than 20 years of experience in content management.\n-It offers all major features expected by a modern CMS out-of-the-box.\n-\n-Lots of customizations can be made trough-the-web, such as creating content types, themes, workflows and much more.\n-Pushed one step further Plone can be used as a framework on which to build custom CMS-like solutions.\n-\n-Plone works as a\n-\n-- full-featured classical server-side rendered CMS,\n-- headless CMS offering all features as a REST API.\n-\n-\n-Installing Plone\n------------------\n-\n-Plone is available on Microsoft Windows, Linux, OSX and BSD platforms.\n-\n-Plone runs as container in the cloud with Docker.\n-\n-`Install Plone by choosing an option from plone.org <https://plone.org/download>`_\n-\n-\n-Documentation\n--------------\n-\n-Consult `the official Plone documentation <https://docs.plone.org>`_ with information for different audiences.\n-\n-For trainings `comprehensive Plone training material <https://training.plone.org>`_ is available.\n-\n-\n-What is Plone?\n---------------\n-\n-Plone is a ready-to-run content management system, offering a complete set of features needed by a wide variety of organizations.\n-\n-Security is built into Plone\'s architecture from the ground up.\n-Plone offers fine-grained permission control over content and actions.\n-\n-Plone is easy to set up, extremely flexible,\n-and provides you with a system for managing web content that is ideal for project groups, communities, websites, extranets and intranets.\n-\n-- *Plone is easy to install.*\n-  Several installation options are available for either your local machine or on servers in the cloud.\n-\n-- *Plone is easy to use.*\n-  The Plone Team includes usability experts who have made Plone easy and attractive for content managers to add, update, and maintain content.\n-\n-- *Plone is international.*\n-  The Plone interface has more than 35 translations, and tools exist for managing multilingual content.\n-\n-- *Plone is standard.*\n-  Plone carefully follows standards for usability and accessibility.\n-  Plone pages are compliant with US Section 508, and the W3C\'s AAA rating for accessibility.\n-\n-- *Plone is Open Source.*\n-  Plone is licensed under the GNU General Public License, the same license used by Linux.\n-  This gives you the right to use Plone without a license fee, and to improve upon the product.\n-\n-- *Plone is supported.*\n-  There are over three hundred developers in the Plone Development Team around the world, and a multitude of companies that specialize in Plone development and support.\n-\n-- *Plone is extensible.*\n-  There is a multitude of add-on products for Plone to add new features and content types.\n-  In addition, Plone can be scripted using web standard solutions and Open Source languages.\n-\n-- *Plone is technology neutral.*\n-  Plone can interoperate with most relational database systems, open source and commercial, and runs on a vast array of\n-  platforms, including Linux, Windows, Mac OS X, Solaris and BSD.\n-\n-\n-Technical overview\n-------------------\n-\n-Plone is a content management platform written in Python.\n-It builds upon Zope, an Open Source web application server and development system and thus on the pluggable Zope Component Architecture (ZCA).\n-\n-Python is the easy-to-learn, widely-used and supported Open Source programming language.\n-Python can be used to add new features to Plone, and used to understand or make changes to the way that Plone works.\n-\n-Plone stores its contents in Zope\'s built-in transactional hierarchical object database, the ZODB.\n-The ZODB can be connected to simple file-storages, scalable ZEO-Servers or Postgres, MySQL and Oracle.\n-There are addons and techniques, however, to share information with other sources, such as relational databases, LDAP, filesystem\n-files, etc.\n-\n-\n-Official Resources\n-------------------\n-* `plone.org <https://plone.org/>`_ - Official website for developers and community.\n-* `Plone support <https://plone.org/support>`_ - Where to find help.\n-* `community.plone.org <https://community.plone.org/>`_ - Official community forum, the best place to get help.\n-* `docs.plone.org <https://docs.plone.org/>`_ - Official documentation for developers/integrators.\n-* `training.plone.org <https://training.plone.org/>`_ - Training classes for developers/integrators/users/designers.\n-* `plone.api <https://docs.plone.org/develop/plone.api/docs/index.html>`_ - Documentation for plone.api.\n-* `plone.restapi <https://plonerestapi.readthedocs.io/en/latest/>`_ - Documentation for plone.restapi.\n-* `official Discord chat <https://discord.gg/zFY3EBbjaj>`_ - Join link.\ndiff --git a/docs/changelog_template.jinja b/docs/changelog_template.jinja\nnew file mode 100644\nindex 0000000000..b35bff39d4\n--- /dev/null\n+++ b/docs/changelog_template.jinja\n@@ -0,0 +1,15 @@\n+{% if sections[""] %}\n+{% for category, val in definitions.items() if category in sections[""] %}\n+\n+### {{ definitions[category][\'name\'] }}\n+\n+{% for text, values in sections[""][category].items() %}\n+- {{ text }} {{ values|join(\', \') }}\n+{% endfor %}\n+\n+{% endfor %}\n+{% else %}\n+No significant changes.\n+\n+\n+{% endif %}\n\\ No newline at end of file\ndiff --git a/news/3122.bugfix b/news/3122.bugfix\nnew file mode 100644\nindex 0000000000..bfbc748e8e\n--- /dev/null\n+++ b/news/3122.bugfix\n@@ -0,0 +1,2 @@\n+Remove unused template send_feedback_confirm.pt. \n+[jensens]\ndiff --git a/news/3223.bugfix b/news/3223.bugfix\nnew file mode 100644\nindex 0000000000..a9c5cbcb5c\n--- /dev/null\n+++ b/news/3223.bugfix\n@@ -0,0 +1,4 @@\n+Moved the assignment of Plone Site Setup permissions from zcml to GenericSetup\n+rolemap.xml. This assigns the permissions on site creation instead of Zope root\n+where the `Site Administrator` role does not actually exist\n+[ewohnlich]\n\\ No newline at end of file\ndiff --git a/news/3680.bugfix b/news/3680.bugfix\ndeleted file mode 100644\nindex 868ebcdcf8..0000000000\n--- a/news/3680.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fix duplicated ``<article id="content">`` in login form.\n-[petschki]\ndiff --git a/news/3683.bugfix b/news/3683.bugfix\ndeleted file mode 100644\nindex fc062caec7..0000000000\n--- a/news/3683.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fix caching of rendered resources.\n-[petschki]\ndiff --git a/news/3687.internal b/news/3687.internal\ndeleted file mode 100644\nindex c4be2cc4a5..0000000000\n--- a/news/3687.internal\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Update package metadata in pypi.\n-[ericof]\ndiff --git a/news/3733.bugfix b/news/3733.bugfix\nnew file mode 100644\nindex 0000000000..5eb495258d\n--- /dev/null\n+++ b/news/3733.bugfix\n@@ -0,0 +1 @@\n+Fix deprecated imports. [jensens]\ndiff --git a/news/3738.bugfix b/news/3738.bugfix\nnew file mode 100644\nindex 0000000000..d0e5395ad9\n--- /dev/null\n+++ b/news/3738.bugfix\n@@ -0,0 +1,2 @@\n+Fix userlisting batch/showAll in group membership template.\n+[petschki]\ndiff --git a/news/3740.bugfix b/news/3740.bugfix\nnew file mode 100644\nindex 0000000000..d016eea54b\n--- /dev/null\n+++ b/news/3740.bugfix\n@@ -0,0 +1,2 @@\n+Implement `pat-checklist` for groupuser management.\n+[petschki]\ndiff --git a/news/3742.bugfix b/news/3742.bugfix\nnew file mode 100644\nindex 0000000000..e44271fd2d\n--- /dev/null\n+++ b/news/3742.bugfix\n@@ -0,0 +1,2 @@\n+Import PloneMessageFactory from plone.base. Removes deprecation warnings.\n+[jensens]\ndiff --git a/news/3747.bugfix b/news/3747.bugfix\nnew file mode 100644\nindex 0000000000..43e2547925\n--- /dev/null\n+++ b/news/3747.bugfix\n@@ -0,0 +1,4 @@\n+fix circular depndency in `plone.app.theming` on ZCML level.\n+Move permission over there.\n+[jensens]\n+\ndiff --git a/news/6010.bugfix b/news/6010.bugfix\ndeleted file mode 100644\nindex b4830280fb..0000000000\n--- a/news/6010.bugfix\n+++ /dev/null\n@@ -1 +0,0 @@\n-Updated metadata version to 6010.  [maurits]\ndiff --git a/news/6014.bugfix b/news/6014.bugfix\nnew file mode 100644\nindex 0000000000..135729df44\n--- /dev/null\n+++ b/news/6014.bugfix\n@@ -0,0 +1 @@\n+Updated metadata version to 6014.  [maurits]\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 05b615de2f..10d43bb1bd 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -1,8 +1,10 @@\n [tool.towncrier]\n-filename = "CHANGES.rst"\n+filename = "CHANGES.md"\n directory = "news/"\n-title_format = "{version} ({project_date})"\n-underlines = ["-", ""]\n+start_string = "<!-- towncrier release notes start -->\\n"\n+title_format = "## {version} ({project_date})"\n+template = "docs/changelog_template.jinja"\n+underlines = ["", "", ""]\n \n [[tool.towncrier.type]]\n directory = "breaking"\ndiff --git a/setup.py b/setup.py\nindex 6bd5c51935..66f9ea7657 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -2,15 +2,16 @@\n from setuptools import setup\n \n \n-version = \'6.0.0rc2.dev0\'\n+version = \'6.0.3.dev0\'\n \n \n setup(\n     name=\'Products.CMFPlone\',\n     version=version,\n     description="The Plone Content Management System (core)",\n-    long_description=open("README.rst").read() + "\\n" +\n-    open("CHANGES.rst").read(),\n+    long_description=open("README.md").read() + "\\n" +\n+    open("CHANGES.md").read(),\n+    long_description_content_type="text/markdown",\n     classifiers=[\n         "Development Status :: 5 - Production/Stable",\n         "Environment :: Web Environment",\n@@ -34,8 +35,7 @@\n     license=\'GPL version 2\',\n     project_urls={\n         "Homepage": "https://plone.org",\n-        "Documentation": "https://docs.plone.org",\n-        "PyPI": "https://pypi.python.org/pypi/Products.CMFPlone",\n+        "Documentation": "https://6.docs.plone.org",\n         "Source": "https://github.com/plone/Products.CMFPlone",\n         "Issues": "https://github.com/plone/plone.org/Products.CMFPlone",\n         "Forum": "https://community.plone.org/",\n@@ -107,7 +107,7 @@\n         \'Products.statusmessages\',\n         \'setuptools>=36.2\',\n         \'plone.autoinclude\',\n-        \'webresource>=1.1\',\n+        \'webresource>=1.2\',\n         \'Zope[wsgi] >= 5.0\',\n         \'zope.app.locales >= 3.6.0\',\n         \'zope.cachedescriptors\',\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-04-24T23:33:42+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/448818e7ab07bc98f7f613d9529be1c767679e86

Merge branch 'master' into erral-issue-3690

Files changed:
A Products/CMFPlone/resources/eventhandlers.py
A news/6016.bugfix
M CHANGES.md
M Products/CMFPlone/RegistrationTool.py
M Products/CMFPlone/browser/contact_info.py
M Products/CMFPlone/browser/login/login_help.py
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/controlpanel/browser/language.py
M Products/CMFPlone/controlpanel/browser/resourceregistry.pt
M Products/CMFPlone/controlpanel/browser/resourceregistry.py
M Products/CMFPlone/patterns/tinymce.py
M Products/CMFPlone/profiles/default/metadata.xml
M Products/CMFPlone/resources/browser/resource.py
M Products/CMFPlone/resources/configure.zcml
M Products/CMFPlone/tests/mails.txt
M Products/CMFPlone/tests/test_patternsettings.py
M setup.py
D news/3122.bugfix
D news/3223.bugfix
D news/3733.bugfix
D news/3738.bugfix
D news/3740.bugfix
D news/3742.bugfix
D news/3747.bugfix
D news/6014.bugfix

b'diff --git a/CHANGES.md b/CHANGES.md\nindex a956f98c6a..8485966dd6 100644\n--- a/CHANGES.md\n+++ b/CHANGES.md\n@@ -15,6 +15,77 @@\n \n <!-- towncrier release notes start -->\n \n+## 6.0.4 (2023-04-24)\n+\n+\n+### Bug fixes:\n+\n+- Prepare 6.0.4 final. No changes compared to the release candidate.\n+  [maurits] #604\n+\n+\n+## 6.0.4rc1 (2023-04-21)\n+\n+\n+### Bug fixes:\n+\n+- Prepare 6.0.3 final. No changes compared to the release candidate.\n+  [maurits] #603\n+- Add a last modification time of the resource registry.\n+  We update this when changing anything related: when changing the resource registry in its control panel or activating an add-on.\n+  This avoids needing a restart before seeing changes when you run in production mode.\n+  Fixes [issue 3505](https://github.com/plone/Products.CMFPlone/issues/3505).\n+  [maurits] #3505\n+- Removed path query from search view when context is site root.\n+  [malthe] #3753\n+- Fixed encoding issue on Python 3 for some mail servers.\n+  This could result in missing characters in an email body.\n+  [maurits] #3754\n+- Mockup TinyMCE settings: Fix URLs in TinyMCE external_plugins settings.\n+\n+  Add the portal URL to external_plugins values for relative and absolute\n+  URLs.\n+\n+  Before this fix external plugins could not be found if they were not added with\n+  the full path or a full URL. The path is different for virtual hosted sites and\n+  sites directly served from Zope. #3767\n+- Updated metadata version to 6015.\n+  [maurits] #6015\n+\n+\n+## 6.0.3 (2023-03-27)\n+\n+\n+### Bug fixes:\n+\n+- Prepare 6.0.3 final. No changes compared to the release candidate.\n+  [maurits] #603\n+\n+\n+## 6.0.3rc1 (2023-03-23)\n+\n+\n+### Bug fixes:\n+\n+- Remove unused template send_feedback_confirm.pt. \n+  [jensens] #3122\n+- Moved the assignment of Plone Site Setup permissions from zcml to GenericSetup\n+  rolemap.xml. This assigns the permissions on site creation instead of Zope root\n+  where the `Site Administrator` role does not actually exist\n+  [ewohnlich] #3223\n+- Fix deprecated imports. [jensens] #3733\n+- Fix userlisting batch/showAll in group membership template.\n+  [petschki] #3738\n+- Implement `pat-checklist` for groupuser management.\n+  [petschki] #3740\n+- Import PloneMessageFactory from plone.base. Removes deprecation warnings.\n+  [jensens] #3742\n+- Fix circular dependency in `plone.app.theming` on ZCML level.\n+  Move permission over there.\n+  [jensens] #3747\n+- Updated metadata version to 6014.  [maurits] #6014\n+\n+\n ## 6.0.2 (2023-02-27)\n \n \ndiff --git a/Products/CMFPlone/RegistrationTool.py b/Products/CMFPlone/RegistrationTool.py\nindex 976f7d3f04..b79cfc1ea4 100644\n--- a/Products/CMFPlone/RegistrationTool.py\n+++ b/Products/CMFPlone/RegistrationTool.py\n@@ -7,7 +7,6 @@\n from AccessControl.SecurityManagement import setSecurityManager\n from Acquisition import aq_base\n from Acquisition import aq_chain\n-from email import message_from_string\n from hashlib import md5\n from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ISecuritySchema\n@@ -34,6 +33,13 @@\n import random\n import re\n \n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n \n # - remove \'1\', \'l\', and \'I\' to avoid confusion\n # - remove \'0\', \'O\', and \'Q\' to avoid confusion\ndiff --git a/Products/CMFPlone/browser/contact_info.py b/Products/CMFPlone/browser/contact_info.py\nindex 1b70a775a6..c1cec8398c 100644\n--- a/Products/CMFPlone/browser/contact_info.py\n+++ b/Products/CMFPlone/browser/contact_info.py\n@@ -1,4 +1,3 @@\n-from email.mime.text import MIMEText\n from plone.autoform.form import AutoExtensibleForm\n from plone.base import PloneMessageFactory as _\n from plone.base.interfaces.controlpanel import IMailSchema\n@@ -14,6 +13,15 @@\n from zope.component.hooks import getSite\n \n import logging\n+import warnings\n+\n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n \n \n log = logging.getLogger(__name__)\n@@ -50,9 +58,19 @@ def handle_send(self, action):\n         self.send_feedback()\n         self.success = True\n \n-    def generate_mail(self, variables, encoding=\'utf-8\'):\n+    def generate_mail(self, variables, encoding=None):\n         template = self.context.restrictedTraverse(self.template_mailview)\n-        return template(self.context, **variables).encode(encoding)\n+        result = template(self.context, **variables)\n+        if encoding is not None:\n+            # Maybe someone has customized \'send_message\'\n+            # and still expects to get an encoded answer back.\n+            warnings.warn(\n+                "Calling generate_mail with an encoding argument is deprecated. "\n+                "You can leave it out, and get text (string) as result.",\n+                DeprecationWarning,\n+            )\n+            result = result.encode(encoding)\n+        return result\n \n     def send_message(self, data):\n         subject = data.get(\'subject\')\n@@ -67,8 +85,12 @@ def send_message(self, data):\n         host = getToolByName(self.context, \'MailHost\')\n \n         data[\'url\'] = portal.absolute_url()\n-        message = self.generate_mail(data, encoding)\n-        message = MIMEText(message, \'plain\', encoding)\n+        message = self.generate_mail(data)\n+        if isinstance(message, bytes):\n+            # Maybe someone has customized \'generate_mail\'\n+            # and still handles the encoding keyword argument.\n+            message = message.decode(encoding)\n+        message = message_from_string(message)\n         message[\'Reply-To\'] = data[\'sender_from_address\']\n \n         try:\ndiff --git a/Products/CMFPlone/browser/login/login_help.py b/Products/CMFPlone/browser/login/login_help.py\nindex 3ad0c50189..c151141547 100644\n--- a/Products/CMFPlone/browser/login/login_help.py\n+++ b/Products/CMFPlone/browser/login/login_help.py\n@@ -1,4 +1,3 @@\n-from email import message_from_string\n from email.header import Header\n from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import ILoginHelpForm\n@@ -22,6 +21,14 @@\n \n import logging\n \n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n+\n \n SEND_USERNAME_TEMPLATE = _("mailtemplate_username_info", default="""From: {encoded_mail_sender}\n To: {email}\ndiff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py\nindex 4d3e25cd2d..902d052720 100644\n--- a/Products/CMFPlone/browser/search.py\n+++ b/Products/CMFPlone/browser/search.py\n@@ -2,6 +2,7 @@\n from plone.app.contentlisting.interfaces import IContentListing\n from plone.app.layout.navigation.interfaces import INavigationRoot\n from plone.base.batch import Batch\n+from plone.base.interfaces.siteroot import IPloneSiteRoot\n from plone.base.interfaces import ISearchSchema\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n@@ -142,8 +143,8 @@ def _filter_query(self, query):\n         query[\'portal_type\'] = self.filter_types(types)\n         # respect effective/expiration date\n         query[\'show_inactive\'] = False\n-        # respect navigation root\n-        if \'path\' not in query:\n+        # respect navigation root if we\'re not at the site root.\n+        if \'path\' not in query and not IPloneSiteRoot.providedBy(self.context):\n             query[\'path\'] = getNavigationRoot(self.context)\n \n         if \'sort_order\' in query and not query[\'sort_order\']:\ndiff --git a/Products/CMFPlone/controlpanel/browser/language.py b/Products/CMFPlone/controlpanel/browser/language.py\nindex 327eee58ec..289715aa02 100644\n--- a/Products/CMFPlone/controlpanel/browser/language.py\n+++ b/Products/CMFPlone/controlpanel/browser/language.py\n@@ -51,11 +51,3 @@ def handleCancel(self, action):\n \n class LanguageControlPanel(controlpanel.ControlPanelFormWrapper):\n     form = LanguageControlPanelForm\n-\n-\n-# class LanguageControlPanel(ControlPanelForm):\n-#    form_fields = FormFields(ILanguageSchema)\n-#    form_fields[\'default_language\'].custom_widget = \\\n-#       LanguageDropdownChoiceWidget\n-#\n-#    form_name = _(u"heading_language_settings", default="Language Settings")\ndiff --git a/Products/CMFPlone/controlpanel/browser/resourceregistry.pt b/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\nindex 071d03817f..4279bdb02b 100644\n--- a/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\n+++ b/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\n@@ -68,7 +68,6 @@\n         <span class="content"\n               i18n:translate="">\n             Resources are fast and hashes are cached in Plone.\n-            Changes in resource settings are not applied directly.\n         </span>\n       </div>\n     </form>\ndiff --git a/Products/CMFPlone/controlpanel/browser/resourceregistry.py b/Products/CMFPlone/controlpanel/browser/resourceregistry.py\nindex e097435ad7..4277e9d221 100644\n--- a/Products/CMFPlone/controlpanel/browser/resourceregistry.py\n+++ b/Products/CMFPlone/controlpanel/browser/resourceregistry.py\n@@ -2,6 +2,7 @@\n from plone.base import PloneMessageFactory as _\n from plone.base.interfaces import IBundleRegistry\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.resources.browser.resource import update_resource_registry_mtime\n from Products.Five.browser import BrowserView\n from Products.statusmessages.interfaces import IStatusMessage\n from zope.component import getUtility\n@@ -149,4 +150,5 @@ def process_form(self):\n             self._switch_cache(False)\n         else:\n             raise ValueError("Invalid form data")\n+        update_resource_registry_mtime()\n         self.request.response.redirect(self.request["ACTUAL_URL"])\ndiff --git a/Products/CMFPlone/patterns/tinymce.py b/Products/CMFPlone/patterns/tinymce.py\nindex 43206c8384..c3dbe18abb 100644\n--- a/Products/CMFPlone/patterns/tinymce.py\n+++ b/Products/CMFPlone/patterns/tinymce.py\n@@ -171,7 +171,13 @@ def get_tiny_config(self):\n             parts = plugin.split("|")\n             if len(parts) != 2:\n                 continue\n-            tiny_config["external_plugins"][parts[0]] = parts[1]\n+            url = parts[1].strip()\n+            if not url:\n+                continue\n+            if url.find("//", 0, 8) == -1:\n+                # assuming relative/absolute w/out url scheme\n+                url = f"{self.nav_root_url}/{url}"\n+            tiny_config["external_plugins"][parts[0]] = url\n \n         tiny_config["style_formats"] = self.get_all_style_formats()\n         if settings.formats:\ndiff --git a/Products/CMFPlone/profiles/default/metadata.xml b/Products/CMFPlone/profiles/default/metadata.xml\nindex 09e062981a..946f93fdec 100644\n--- a/Products/CMFPlone/profiles/default/metadata.xml\n+++ b/Products/CMFPlone/profiles/default/metadata.xml\n@@ -1,4 +1,4 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>6014</version>\n+  <version>6016</version>\n </metadata>\ndiff --git a/Products/CMFPlone/resources/browser/resource.py b/Products/CMFPlone/resources/browser/resource.py\nindex c07f71f20a..07369c6176 100644\n--- a/Products/CMFPlone/resources/browser/resource.py\n+++ b/Products/CMFPlone/resources/browser/resource.py\n@@ -7,8 +7,10 @@\n from plone.base.interfaces import IBundleRegistry\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n+from time import time\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n+from zope.component import queryUtility\n from zope.component.hooks import getSite\n \n import hashlib\n@@ -19,7 +21,7 @@\n logger = logging.getLogger(__name__)\n \n REQUEST_CACHE_KEY = "_WEBRESOURCE_CACHE_"\n-\n+_RESOURCE_REGISTRY_MTIME = "__RESOURCE_REGISTRY_MTIME"\n GRACEFUL_DEPENDENCY_REWRITE = {\n     "plone-base": "plone",\n     "plone-legacy": "plone",\n@@ -59,7 +61,12 @@ def _cache_attr_name(self, site):\n         for bundle in e_bundles | d_bundles:\n             hashtool.update(bundle.encode(\'utf8\'))\n         hashtool.update(self._user_local_roles(site).encode("utf8"))\n-        return f"_v_renderend_cache_{hashtool.hexdigest()}"\n+        if not getattr(self, "registry", None):\n+            self.registry = getUtility(IRegistry)\n+            mtime = getattr(self.registry, _RESOURCE_REGISTRY_MTIME, None)\n+            if mtime is not None:\n+                hashtool.update(str(mtime).encode(\'utf8\'))\n+        return f"_v_rendered_cache_{hashtool.hexdigest()}"\n \n     @property\n     def _rendered_cache(self):\n@@ -313,3 +320,19 @@ def index(self):\n             rendered = self.renderer["css"].render()\n             self._rendered_cache = rendered\n         return rendered\n+\n+\n+def update_resource_registry_mtime():\n+    """Update the last modification time of the resource registry.\n+\n+    Call this when you change anything that may influence the resource registry\n+    and any of its rendered cache.\n+    See discussion in https://github.com/plone/Products.CMFPlone/issues/3505\n+    and https://github.com/plone/Products.CMFPlone/pull/3771\n+    """\n+    registry = queryUtility(IRegistry)\n+    if registry is None:\n+        # This can happen for example during site creation.\n+        return\n+    setattr(registry, _RESOURCE_REGISTRY_MTIME, time())\n+    logger.info("Updated resource registry mtime.")\ndiff --git a/Products/CMFPlone/resources/configure.zcml b/Products/CMFPlone/resources/configure.zcml\nindex 0bec1224e4..faf47d627e 100644\n--- a/Products/CMFPlone/resources/configure.zcml\n+++ b/Products/CMFPlone/resources/configure.zcml\n@@ -3,5 +3,6 @@\n     i18n_domain="plone.registry">\n \n     <include package=".browser" />\n+    <subscriber handler=".eventhandlers.check_registry_update" />\n \n </configure>\ndiff --git a/Products/CMFPlone/resources/eventhandlers.py b/Products/CMFPlone/resources/eventhandlers.py\nnew file mode 100644\nindex 0000000000..dae5a5ba7f\n--- /dev/null\n+++ b/Products/CMFPlone/resources/eventhandlers.py\n@@ -0,0 +1,16 @@\n+from Products.CMFPlone.resources.browser.resource import update_resource_registry_mtime\n+from Products.GenericSetup.interfaces import IProfileImportedEvent\n+from zope.component import adapter\n+\n+\n+@adapter(IProfileImportedEvent)\n+def check_registry_update(event):\n+    """Check if a profile import may have updated the configuration registry.\n+\n+    Main concern for now is: the resource registries may have changed.\n+    This means the resource viewlet caches should be cleared.\n+    See discussion in https://github.com/plone/Products.CMFPlone/issues/3505\n+    """\n+    if not (event.full_import or "plone.app.registry" in event.steps):\n+        return\n+    update_resource_registry_mtime()\ndiff --git a/Products/CMFPlone/tests/mails.txt b/Products/CMFPlone/tests/mails.txt\nindex 756208fa87..fa292aef7b 100644\n--- a/Products/CMFPlone/tests/mails.txt\n+++ b/Products/CMFPlone/tests/mails.txt\n@@ -6,6 +6,7 @@ Some initial setup:\n   >>> from plone.testing.zope import Browser\n   >>> app = layer[\'app\']\n   >>> browser = Browser(app)\n+  >>> browser.handleErrors = False\n \n \n Contact form\n@@ -58,12 +59,18 @@ We expect the headers to be properly header encoded (7-bit):\n   >>> b\'Subject: =?utf-8?q?Some_t=C3=A4st_subject=2E?=\' in msg\n   True\n \n-The output should be encoded in a reasonable manner (in this case\n-quoted-printable).  There may be some small differences in where\n-exactly the lines are cut off, depending on whether you use five.pt\n-(in Zope 2.13) or not, so we turn the message into one line first:\n+The output should be encoded in a reasonable manner, in this case quoted-printable.\n+On Python 3 there may be problems with quoted printable messages on some mail servers.\n+See https://github.com/zopefoundation/Products.MailHost/issues/35\n+When \'\\r\\n\' is used as line ending, all is well.\n \n-  >>> msg.replace(b\'=\\n\', b\'\').replace(b\'\\n\', b\' \')\n+  >>> msg.count(b\'\\r\\n\') > 0\n+  True\n+\n+There may be some small differences in where exactly the lines are cut off,\n+so we turn the message into one line first:\n+\n+  >>> msg.replace(b\'=\\r\\n\', b\'\').replace(b\'\\r\\n\', b\' \')\n   b\'...Another t=C3=A4st message...You are receiving this mail because T=C3=A4st user test@plone.test...is sending feedback about the site you administer at...\'\n \n We can also decode the string, though we should still be careful about\ndiff --git a/Products/CMFPlone/tests/test_patternsettings.py b/Products/CMFPlone/tests/test_patternsettings.py\nindex fd4c38fe0f..7309f9f813 100644\n--- a/Products/CMFPlone/tests/test_patternsettings.py\n+++ b/Products/CMFPlone/tests/test_patternsettings.py\n@@ -44,6 +44,47 @@ def test_other_settings(self):\n         conf = self.get_conf()\n         self.assertEqual(conf[\'tiny\'][\'foo\'], \'bar\')\n \n+    def test_external_plugins(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(ITinyMCESchema, prefix="plone")\n+        settings.custom_plugins = [\n+            "plugin1|https://example.com/plugin1.js",\n+            "plugin2|//example.com/plugin2.js",\n+            "plugin3|/plugin3.js",\n+            "plugin4|plugin4.js",\n+            "plugin5|  plugin5.js  ",\n+            "plugin6|../plugin6.js",\n+            "plugin7|",\n+            "plugin8",\n+        ]\n+        conf = self.get_conf()\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin1"],\n+            "https://example.com/plugin1.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin2"],\n+            "//example.com/plugin2.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin3"],\n+            "http://nohost/plone//plugin3.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin4"],\n+            "http://nohost/plone/plugin4.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin5"],\n+            "http://nohost/plone/plugin5.js",\n+        )\n+        self.assertEqual(\n+            conf["tiny"]["external_plugins"]["plugin6"],\n+            "http://nohost/plone/../plugin6.js",\n+        )\n+        self.assertNotIn("plugin7", conf["tiny"]["external_plugins"])\n+        self.assertNotIn("plugin8", conf["tiny"]["external_plugins"])\n+\n \n class TestPatternSettingsView(unittest.TestCase):\n     """Ensure that the basic redirector setup is successful.\ndiff --git a/news/3122.bugfix b/news/3122.bugfix\ndeleted file mode 100644\nindex bfbc748e8e..0000000000\n--- a/news/3122.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Remove unused template send_feedback_confirm.pt. \n-[jensens]\ndiff --git a/news/3223.bugfix b/news/3223.bugfix\ndeleted file mode 100644\nindex a9c5cbcb5c..0000000000\n--- a/news/3223.bugfix\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-Moved the assignment of Plone Site Setup permissions from zcml to GenericSetup\n-rolemap.xml. This assigns the permissions on site creation instead of Zope root\n-where the `Site Administrator` role does not actually exist\n-[ewohnlich]\n\\ No newline at end of file\ndiff --git a/news/3733.bugfix b/news/3733.bugfix\ndeleted file mode 100644\nindex 5eb495258d..0000000000\n--- a/news/3733.bugfix\n+++ /dev/null\n@@ -1 +0,0 @@\n-Fix deprecated imports. [jensens]\ndiff --git a/news/3738.bugfix b/news/3738.bugfix\ndeleted file mode 100644\nindex d0e5395ad9..0000000000\n--- a/news/3738.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Fix userlisting batch/showAll in group membership template.\n-[petschki]\ndiff --git a/news/3740.bugfix b/news/3740.bugfix\ndeleted file mode 100644\nindex d016eea54b..0000000000\n--- a/news/3740.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Implement `pat-checklist` for groupuser management.\n-[petschki]\ndiff --git a/news/3742.bugfix b/news/3742.bugfix\ndeleted file mode 100644\nindex e44271fd2d..0000000000\n--- a/news/3742.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Import PloneMessageFactory from plone.base. Removes deprecation warnings.\n-[jensens]\ndiff --git a/news/3747.bugfix b/news/3747.bugfix\ndeleted file mode 100644\nindex 43e2547925..0000000000\n--- a/news/3747.bugfix\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-fix circular depndency in `plone.app.theming` on ZCML level.\n-Move permission over there.\n-[jensens]\n-\ndiff --git a/news/6014.bugfix b/news/6014.bugfix\ndeleted file mode 100644\nindex 135729df44..0000000000\n--- a/news/6014.bugfix\n+++ /dev/null\n@@ -1 +0,0 @@\n-Updated metadata version to 6014.  [maurits]\ndiff --git a/news/6016.bugfix b/news/6016.bugfix\nnew file mode 100644\nindex 0000000000..e005883582\n--- /dev/null\n+++ b/news/6016.bugfix\n@@ -0,0 +1,2 @@\n+Updated metadata version to 6016.\n+[maurits]\ndiff --git a/setup.py b/setup.py\nindex 66f9ea7657..93537da4eb 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -2,7 +2,7 @@\n from setuptools import setup\n \n \n-version = \'6.0.3.dev0\'\n+version = \'6.0.5.dev0\'\n \n \n setup(\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-04-25T09:34:42+02:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/16bb663c50fc19df5d792440cb07d03d0ff1f04d

change title names after the fix

Files changed:
M Products/CMFPlone/tests/testCatalogTool.py

b'diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py\nindex a660c4a9ac..0027d3996e 100644\n--- a/Products/CMFPlone/tests/testCatalogTool.py\n+++ b/Products/CMFPlone/tests/testCatalogTool.py\n@@ -549,10 +549,10 @@ def afterSetUp(self):\n         self.folder.doc6.setTitle(\'DOCUMENT 4\')\n \n         self.folder.invokeFactory(\'Document\', id="doc7")\n-        self.folder.doc7.setTitle(\'This is a long title that will ignore this text BBBB 2nd position cut zzzzz\')\n+        self.folder.doc7.setTitle(\'Long titles used to be truncated, but we changed this, see issue 3690. 0002\')\n \n         self.folder.invokeFactory(\'Document\', id="doc8")\n-        self.folder.doc8.setTitle(\'This is a long title that will ignore this text AAAA 1st position cut zzzzz\')\n+        self.folder.doc8.setTitle(\'Long titles used to be truncated, but we changed this, see issue 3690. 0001\')\n \n         self.folder.doc.reindexObject()\n         self.folder.doc2.reindexObject()\n@@ -631,7 +631,7 @@ def testSortableTitleInLongTitles(self):\n         doc = self.folder.doc7\n         wrapped = IndexableObjectWrapper(doc, self.portal.portal_catalog)\n \n-        self.assertEqual(wrapped.sortable_title, \'this is a long title that will ignore this text bbbb 0002nd position cut zzzzz\')\n+        self.assertEqual(wrapped.sortable_title, \'long titles used to be truncated, but we changed this, see issue 3690. 0002\')\n \n \n     def testSortableNonASCIITitles(self):\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2023-04-25T11:21:52+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/4eba7476bfdecb15e7e0d95082f52d609d15987d

Merge pull request #3691 from plone/erral-issue-3690

Do not truncate the sortable_title index.

Files changed:
A news/3690.bugfix
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

b'diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 64e11a1a10..c83320dc07 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -49,7 +49,6 @@\n \n _marker = object()\n \n-MAX_SORTABLE_TITLE = 40\n DENIED_INTERFACES = frozenset((\n     \'AccessControl.interfaces.IOwned\',\n     \'AccessControl.interfaces.IPermissionMappingSupport\',\n@@ -175,11 +174,6 @@ def sortable_title(obj):\n             sortabletitle = mapUnicode(safe_text(title)).lower().strip()\n             # Replace numbers with zero filled numbers\n             sortabletitle = num_sort_regex.sub(zero_fill, sortabletitle)\n-            # Truncate to prevent bloat, take bits from start and end\n-            if len(sortabletitle) > MAX_SORTABLE_TITLE:\n-                start = sortabletitle[:(MAX_SORTABLE_TITLE - 13)]\n-                end = sortabletitle[-10:]\n-                sortabletitle = start + \'...\' + end\n             return sortabletitle\n     return \'\'\n \ndiff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py\nindex 909e7f9178..0027d3996e 100644\n--- a/Products/CMFPlone/tests/testCatalogTool.py\n+++ b/Products/CMFPlone/tests/testCatalogTool.py\n@@ -147,7 +147,7 @@ def testExpiresDateNotInSchema(self):\n         self.assertFalse(\'ExpiresDate\' in self.catalog.schema())\n \n     def testIs_Default_PageIsBooleanIndex(self):\n-        # sortable_title should be a BooleanIndex\n+        # is_default_page should be a BooleanIndex\n         self.assertEqual(\n             self.catalog.Indexes[\'is_default_page\'].__class__.__name__,\n             \'BooleanIndex\')\n@@ -547,12 +547,21 @@ def afterSetUp(self):\n         self.folder.doc5.setTitle(\'Document 2\')\n         self.folder.invokeFactory(\'Document\', id=\'doc6\', text=RichTextValue(\'bar\', \'text/html\', \'text/x-html-safe\'))\n         self.folder.doc6.setTitle(\'DOCUMENT 4\')\n+\n+        self.folder.invokeFactory(\'Document\', id="doc7")\n+        self.folder.doc7.setTitle(\'Long titles used to be truncated, but we changed this, see issue 3690. 0002\')\n+\n+        self.folder.invokeFactory(\'Document\', id="doc8")\n+        self.folder.doc8.setTitle(\'Long titles used to be truncated, but we changed this, see issue 3690. 0001\')\n+\n         self.folder.doc.reindexObject()\n         self.folder.doc2.reindexObject()\n         self.folder.doc3.reindexObject()\n         self.folder.doc4.reindexObject()\n         self.folder.doc5.reindexObject()\n         self.folder.doc6.reindexObject()\n+        self.folder.doc7.reindexObject()\n+        self.folder.doc8.reindexObject()\n \n     def testSortMultipleColumns(self):\n         path = \'/\'.join(self.folder.getPhysicalPath())\n@@ -567,6 +576,8 @@ def testSortMultipleColumns(self):\n                 \'/plone/Members/test_user_1_/doc5\',\n                 \'/plone/Members/test_user_1_/doc6\',\n                 \'/plone/Members/test_user_1_/doc4\',\n+                \'/plone/Members/test_user_1_/doc8\',\n+                \'/plone/Members/test_user_1_/doc7\',\n                 \'/plone/Members/test_user_1_\'\n             ],\n         )\n@@ -580,6 +591,8 @@ def testSortMultipleColumns(self):\n                 \'/plone/Members/test_user_1_/doc4\',\n                 \'/plone/Members/test_user_1_/doc5\',\n                 \'/plone/Members/test_user_1_/doc6\',\n+                \'/plone/Members/test_user_1_/doc7\',\n+                \'/plone/Members/test_user_1_/doc8\',\n                 \'/plone/Members/test_user_1_\',\n             ]\n         )\n@@ -614,6 +627,13 @@ def testSortableTitleOutput(self):\n \n         self.assertEqual(wrapped.sortable_title, \'0012 document 0025\')\n \n+    def testSortableTitleInLongTitles(self):\n+        doc = self.folder.doc7\n+        wrapped = IndexableObjectWrapper(doc, self.portal.portal_catalog)\n+\n+        self.assertEqual(wrapped.sortable_title, \'long titles used to be truncated, but we changed this, see issue 3690. 0002\')\n+\n+\n     def testSortableNonASCIITitles(self):\n         # test a utf-8 encoded string gets properly unicode converted\n         # sort must ignore accents\n@@ -651,7 +671,7 @@ def testSortableLongCommonPrefix(self):\n         doc.setTitle(title)\n         wrapped = IndexableObjectWrapper(doc, self.portal.portal_catalog)\n         self.assertEqual(wrapped.sortable_title,\n-                         \'some documents have too lon... 0001.jpeg\')\n+                         \'some documents have too long a name and only differ at the very end - like 0001.jpeg\')\n \n \n class TestFolderCataloging(PloneTestCase):\ndiff --git a/news/3690.bugfix b/news/3690.bugfix\nnew file mode 100644\nindex 0000000000..cb7c7c25c3\n--- /dev/null\n+++ b/news/3690.bugfix\n@@ -0,0 +1,2 @@\n+Do not truncate the sortable_title index\n+[erral]\n'

