Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-04-19T12:15:18+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/6de2544b2432b9b0739719eae81b3e1776b217ed

Add workaround for a inifite recusion in a page-template crashing the instance instead of raising a RecursionError. (Fix #2666)

Files changed:
A news/2666.bugfix
M Products/CMFPlone/browser/main_template.py

b"diff --git a/Products/CMFPlone/browser/main_template.py b/Products/CMFPlone/browser/main_template.py\nindex 86184294a..dc1b07de6 100644\n--- a/Products/CMFPlone/browser/main_template.py\n+++ b/Products/CMFPlone/browser/main_template.py\n@@ -1,28 +1,31 @@\n # -*- coding: utf-8 -*-\n-from zope.interface import implementer\n-\n+from Products.CMFPlone.browser.interfaces import IMainTemplate\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-\n-from Products.CMFPlone.browser.interfaces import IMainTemplate\n+from zope.interface import implementer\n \n \n @implementer(IMainTemplate)\n class MainTemplate(BrowserView):\n \n-    ajax_template = ViewPageTemplateFile('templates/ajax_main_template.pt')\n-    main_template = ViewPageTemplateFile('templates/main_template.pt')\n+    ajax_template_name = 'templates/ajax_main_template.pt'\n+    main_template_name = 'templates/main_template.pt'\n \n     def __call__(self):\n-        return self.template()\n+        return ViewPageTemplateFile(self.template_name)\n \n     @property\n-    def template(self):\n+    def template_name(self):\n         if self.request.form.get('ajax_load'):\n-            return self.ajax_template\n+            return self.ajax_template_name\n         else:\n-            return self.main_template\n+            return self.main_template_name\n \n     @property\n     def macros(self):\n-        return self.template.macros\n+        # Reinstanciating the templatefile is a workaround for\n+        # https://github.com/plone/Products.CMFPlone/issues/2666\n+        # Without this a inifite recusion in a template\n+        # (i.e. a template that calls its own view)\n+        # kills the instance instead of raising a RecursionError.\n+        return ViewPageTemplateFile(self.template_name).macros\ndiff --git a/news/2666.bugfix b/news/2666.bugfix\nnew file mode 100644\nindex 000000000..8363a640c\n--- /dev/null\n+++ b/news/2666.bugfix\n@@ -0,0 +1,2 @@\n+Add workaround for the case when a inifite recusion in a page-template that uses the main-template crashes the instance instead of raising a RecursionError.\n+[pbauer, esteele]\n\\ No newline at end of file\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-04-19T15:36:19+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/0e480786c3541567e60d3467a41341087663ca1f

Merge pull request #2846 from plone/prevent_crash_on_recursionerror

Add workaround for a inifite recursion crashing the instance

Files changed:
A news/2666.bugfix
M Products/CMFPlone/browser/main_template.py

b"diff --git a/Products/CMFPlone/browser/main_template.py b/Products/CMFPlone/browser/main_template.py\nindex 86184294a..dc1b07de6 100644\n--- a/Products/CMFPlone/browser/main_template.py\n+++ b/Products/CMFPlone/browser/main_template.py\n@@ -1,28 +1,31 @@\n # -*- coding: utf-8 -*-\n-from zope.interface import implementer\n-\n+from Products.CMFPlone.browser.interfaces import IMainTemplate\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n-\n-from Products.CMFPlone.browser.interfaces import IMainTemplate\n+from zope.interface import implementer\n \n \n @implementer(IMainTemplate)\n class MainTemplate(BrowserView):\n \n-    ajax_template = ViewPageTemplateFile('templates/ajax_main_template.pt')\n-    main_template = ViewPageTemplateFile('templates/main_template.pt')\n+    ajax_template_name = 'templates/ajax_main_template.pt'\n+    main_template_name = 'templates/main_template.pt'\n \n     def __call__(self):\n-        return self.template()\n+        return ViewPageTemplateFile(self.template_name)\n \n     @property\n-    def template(self):\n+    def template_name(self):\n         if self.request.form.get('ajax_load'):\n-            return self.ajax_template\n+            return self.ajax_template_name\n         else:\n-            return self.main_template\n+            return self.main_template_name\n \n     @property\n     def macros(self):\n-        return self.template.macros\n+        # Reinstanciating the templatefile is a workaround for\n+        # https://github.com/plone/Products.CMFPlone/issues/2666\n+        # Without this a inifite recusion in a template\n+        # (i.e. a template that calls its own view)\n+        # kills the instance instead of raising a RecursionError.\n+        return ViewPageTemplateFile(self.template_name).macros\ndiff --git a/news/2666.bugfix b/news/2666.bugfix\nnew file mode 100644\nindex 000000000..8363a640c\n--- /dev/null\n+++ b/news/2666.bugfix\n@@ -0,0 +1,2 @@\n+Add workaround for the case when a inifite recusion in a page-template that uses the main-template crashes the instance instead of raising a RecursionError.\n+[pbauer, esteele]\n\\ No newline at end of file\n"

