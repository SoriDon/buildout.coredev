Repository: plone.formwidget.recurrence


Branch: refs/heads/master
Date: 2023-03-09T22:00:47+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.formwidget.recurrence/commit/25d552c189798bb452cf6b1bc82dc6ffee6074ae

Do not add charset to application/x-www-form-urlencoded header.

Adding a charset to this Content-Type is illegal according to the definition, and fails with Zope master.
See https://github.com/plone/buildout.coredev/pull/844#issuecomment-1461620409

In our case, when you click to add a recurrence, you get a dialog box saying 'error' because the call to `@@json_recurrence` failed.

Files changed:
A news/844.bugfix
M plone/formwidget/recurrence/tests/test_z3cwidget.py
M plone/formwidget/recurrence/z3cform/widget.py

b'diff --git a/news/844.bugfix b/news/844.bugfix\nnew file mode 100644\nindex 0000000..b68b922\n--- /dev/null\n+++ b/news/844.bugfix\n@@ -0,0 +1,3 @@\n+Do not add charset to application/x-www-form-urlencoded header.\n+Adding a charset to this Content-Type is illegal according to the definition, and fails with Zope master.\n+[maurits]\ndiff --git a/plone/formwidget/recurrence/tests/test_z3cwidget.py b/plone/formwidget/recurrence/tests/test_z3cwidget.py\nindex 74d63c0..8ca24d5 100644\n--- a/plone/formwidget/recurrence/tests/test_z3cwidget.py\n+++ b/plone/formwidget/recurrence/tests/test_z3cwidget.py\n@@ -52,7 +52,7 @@ def test_widget_options(self):\n         pat_options = json.loads(self.widget.get_pattern_options())\n         self.assertEqual(\n             {\n-                "ajaxContentType": "application/x-www-form-urlencoded; charset=UTF-8",\n+                "ajaxContentType": "application/x-www-form-urlencoded",\n                 "ajaxURL": "http://nohost/plone/@@json_recurrence",\n                 "firstDay": 7,\n                 "hasRepeatForeverButton": True,\ndiff --git a/plone/formwidget/recurrence/z3cform/widget.py b/plone/formwidget/recurrence/z3cform/widget.py\nindex 95fb736..dd33f5a 100644\n--- a/plone/formwidget/recurrence/z3cform/widget.py\n+++ b/plone/formwidget/recurrence/z3cform/widget.py\n@@ -57,7 +57,7 @@ def get_pattern_options(self):\n         portal = getToolByName(getSite(), "portal_url").getPortalObject()\n         ajax_url = portal.absolute_url() + "/@@json_recurrence"\n         conf = dict(\n-            ajaxContentType="application/x-www-form-urlencoded; charset=UTF-8",\n+            ajaxContentType="application/x-www-form-urlencoded",\n             ajaxURL=ajax_url,\n             firstDay=self.first_day(),\n             hasRepeatForeverButton=self.show_repeat_forever,\n'

Repository: plone.formwidget.recurrence


Branch: refs/heads/master
Date: 2023-03-10T21:31:21+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.formwidget.recurrence/commit/25e16950a8a49e974055db1ef77521763e1d7981

Merge pull request #31 from plone/maurits-no-charset-with-x-www-form-urlencoded

Do not add charset to application/x-www-form-urlencoded header.

Files changed:
A news/844.bugfix
M plone/formwidget/recurrence/tests/test_z3cwidget.py
M plone/formwidget/recurrence/z3cform/widget.py

b'diff --git a/news/844.bugfix b/news/844.bugfix\nnew file mode 100644\nindex 0000000..b68b922\n--- /dev/null\n+++ b/news/844.bugfix\n@@ -0,0 +1,3 @@\n+Do not add charset to application/x-www-form-urlencoded header.\n+Adding a charset to this Content-Type is illegal according to the definition, and fails with Zope master.\n+[maurits]\ndiff --git a/plone/formwidget/recurrence/tests/test_z3cwidget.py b/plone/formwidget/recurrence/tests/test_z3cwidget.py\nindex 74d63c0..8ca24d5 100644\n--- a/plone/formwidget/recurrence/tests/test_z3cwidget.py\n+++ b/plone/formwidget/recurrence/tests/test_z3cwidget.py\n@@ -52,7 +52,7 @@ def test_widget_options(self):\n         pat_options = json.loads(self.widget.get_pattern_options())\n         self.assertEqual(\n             {\n-                "ajaxContentType": "application/x-www-form-urlencoded; charset=UTF-8",\n+                "ajaxContentType": "application/x-www-form-urlencoded",\n                 "ajaxURL": "http://nohost/plone/@@json_recurrence",\n                 "firstDay": 7,\n                 "hasRepeatForeverButton": True,\ndiff --git a/plone/formwidget/recurrence/z3cform/widget.py b/plone/formwidget/recurrence/z3cform/widget.py\nindex 95fb736..dd33f5a 100644\n--- a/plone/formwidget/recurrence/z3cform/widget.py\n+++ b/plone/formwidget/recurrence/z3cform/widget.py\n@@ -57,7 +57,7 @@ def get_pattern_options(self):\n         portal = getToolByName(getSite(), "portal_url").getPortalObject()\n         ajax_url = portal.absolute_url() + "/@@json_recurrence"\n         conf = dict(\n-            ajaxContentType="application/x-www-form-urlencoded; charset=UTF-8",\n+            ajaxContentType="application/x-www-form-urlencoded",\n             ajaxURL=ajax_url,\n             firstDay=self.first_day(),\n             hasRepeatForeverButton=self.show_repeat_forever,\n'

