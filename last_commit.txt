Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-03-12T21:40:59+01:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/affc5fdb17cc2e3be39b38ae8f1ba0e25f9f2b7f

Fix #1462 Do not break background images relative urls in CSS when concatening bundles

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1e98d03..6678f96 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,7 +18,8 @@ New:
 
 Fixes:
 
-- *add item here*
+- Do not break background images relative urls in CSS when concatening bundles
+  [ebrehault]
 
 
 5.0.3c1 (2016-03-02)
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 289a98d..25e564e 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -1,3 +1,4 @@
+import re
 from zExceptions import NotFound
 from Acquisition import aq_base
 from datetime import datetime
@@ -79,7 +80,15 @@ def write_css(context, folder, meta_bundle):
         IBundleRegistry, prefix="plone.bundles", check=False)
     for bundle in bundles.values():
         if bundle.merge_with == meta_bundle:
-            resources.append(get_resource(context, bundle.csscompilation))
+            css = get_resource(context, bundle.csscompilation)
+            # Preserve relative urls:
+            # we prefix with '../'' any url not starting with '/'
+            # or http: or data:
+            css = re.sub(
+                r"""(url\(['"]?(?!['"]?([a-z]+:|\/)))""",
+                r'\1../',
+                css)
+            resources.append(css)
 
     fi = StringIO()
     for script in resources:


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-03-12T23:19:29+01:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/926177c95edfb32400e084092f1c850924ffae96

Merge pull request #1465 from plone/ebr-do-not-break-css-relative-urls

Fix #1462 Do not break background images relative urls in CSS when coâ€¦

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py

diff --git a/CHANGES.rst b/CHANGES.rst
index e1668fb..b4c4eb6 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -38,7 +38,8 @@ New:
 
 Fixes:
 
-- *add item here*
+- Do not break background images relative urls in CSS when concatening bundles
+  [ebrehault]
 
 
 5.0.3 (2016-03-??)
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 289a98d..25e564e 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -1,3 +1,4 @@
+import re
 from zExceptions import NotFound
 from Acquisition import aq_base
 from datetime import datetime
@@ -79,7 +80,15 @@ def write_css(context, folder, meta_bundle):
         IBundleRegistry, prefix="plone.bundles", check=False)
     for bundle in bundles.values():
         if bundle.merge_with == meta_bundle:
-            resources.append(get_resource(context, bundle.csscompilation))
+            css = get_resource(context, bundle.csscompilation)
+            # Preserve relative urls:
+            # we prefix with '../'' any url not starting with '/'
+            # or http: or data:
+            css = re.sub(
+                r"""(url\(['"]?(?!['"]?([a-z]+:|\/)))""",
+                r'\1../',
+                css)
+            resources.append(css)
 
     fi = StringIO()
     for script in resources:


