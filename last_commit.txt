Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2022-08-19T16:59:33+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/c1ad80a5a18e7bca987ece5f895ef47937965df5

add migration of actions.xml and infrastructure to beta2

Files changed:
A news/294.bugfix
A plone/app/upgrade/v60/betas.py
A plone/app/upgrade/v60/profiles/to6007/actions.xml
M plone/app/upgrade/v60/configure.zcml
M plone/app/upgrade/v60/profiles.zcml

b'diff --git a/news/294.bugfix b/news/294.bugfix\nnew file mode 100644\nindex 00000000..2ae0cce2\n--- /dev/null\n+++ b/news/294.bugfix\n@@ -0,0 +1,3 @@\n+Add migration of actions.xml for https://github.com/plone/Products.CMFPlone/pull/3616 \n+Add infrastructure for to beta2 migrations.\n+[jensens]\ndiff --git a/plone/app/upgrade/v60/betas.py b/plone/app/upgrade/v60/betas.py\nnew file mode 100644\nindex 00000000..404ea300\n--- /dev/null\n+++ b/plone/app/upgrade/v60/betas.py\n@@ -0,0 +1,3 @@\n+import logging\n+\n+logger = logging.getLogger("plone.app.upgrade")\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 8e649aaf..99e528ee 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -131,19 +131,18 @@\n \n     </gs:upgradeSteps>\n \n-  <gs:upgradeSteps\n-      profile="Products.CMFPlone:plone"\n-      source="6006"\n-      destination="6007"\n-      >\n-    <!-- Plone 6.0.0b2 -->\n-\n-    <gs:upgradeStep\n-        title="Miscellaneous"\n-        description=""\n-        handler="..utils.null_upgrade_step"\n-        />\n-\n-  </gs:upgradeSteps>\n+    <gs:upgradeSteps\n+        profile="Products.CMFPlone:plone"\n+        source="6006"\n+        destination="6007"\n+        >\n+        <!-- Plone 6.0.0b2 -->\n+\n+      <gs:upgradeDepends\n+          title="Run to6007 upgrade profile."\n+          import_profile="plone.app.upgrade.v60:to6007"\n+          />\n+\n+    </gs:upgradeSteps>\n \n </configure>\ndiff --git a/plone/app/upgrade/v60/profiles.zcml b/plone/app/upgrade/v60/profiles.zcml\nindex 64e2c7ed..e02a31e0 100644\n--- a/plone/app/upgrade/v60/profiles.zcml\n+++ b/plone/app/upgrade/v60/profiles.zcml\n@@ -7,7 +7,7 @@\n       name="to6000"\n       title="Upgrade profile for Plone 5.2.x to Plone 6.0.0a1.dev0 (6000)"\n       directory="profiles/to6000"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -15,7 +15,7 @@\n       name="to6003"\n       title="Upgrade profile to Plone 6.0.0a3 (6003)"\n       directory="profiles/to6003"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -23,7 +23,7 @@\n       name="to6004"\n       title="Upgrade profile to Plone 6.0.0a4 (6004)"\n       directory="profiles/to6004"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -31,7 +31,14 @@\n       name="to6005"\n       title="Upgrade profile to Plone 6.0.0a5 (6005)"\n       directory="profiles/to6005"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+  <genericsetup:registerProfile\n+      name="to6007"\n+      title="Upgrade profile to Plone 6.0.0b2 (6007)"\n+      directory="profiles/to6007"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -43,7 +50,7 @@\n       name="to_dx_site_root"\n       title="Upgrade profile to change the FTI for the Plone Site object a dexterity one"\n       directory="profiles/to_dx_site_root"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \ndiff --git a/plone/app/upgrade/v60/profiles/to6007/actions.xml b/plone/app/upgrade/v60/profiles/to6007/actions.xml\nnew file mode 100644\nindex 00000000..acaf249f\n--- /dev/null\n+++ b/plone/app/upgrade/v60/profiles/to6007/actions.xml\n@@ -0,0 +1,66 @@\n+<?xml version="1.0"?>\n+<object name="portal_actions" meta_type="Plone Actions Tool"\n+    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n+    <object name="site_actions" meta_type="CMF Action Category">\n+        <object name="sitemap" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/sitemap"</property>\n+        </object>\n+        <object name="accessibility" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/accessibility-info"</property>\n+        </object>\n+        <object name="contact" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/contact-info"</property>\n+        </object>\n+    </object>\n+    <object name="object" meta_type="CMF Action Category">\n+        <object name="folderContents" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_context_state.folder().absolute_url()}/folder_contents"</property>\n+        </object>\n+        <object name="contentrules" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">string:${plone_context_state/canonical_object_url}/@@manage-content-rules</property>\n+            <property name="available_expr">python:plone_context_state.canonical_object().restrictedTraverse(\'@@plone_contentrules_info\').show_rules_tab()</property>\n+        </object>\n+    </object>\n+    <object name="object_buttons" meta_type="CMF Action Category">\n+        <object name="cut" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and checkPermission("Copy or Move", object) and not plone_context_state.is_portal_root()</property>\n+        </object>\n+        <object name="copy" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:checkPermission("Copy or Move", object) and not plone_context_state.is_portal_root()</property>\n+        </object>\n+        <object name="paste" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_context_state.folder().absolute_url()}/object_paste"</property>\n+        </object>\n+        <object name="delete" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and not plone_context_state.is_portal_root()</property>\n+        </object>\n+        <object name="rename" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and checkPermission("Copy or Move", object) and checkPermission("Add portal content", object) and not plone_context_state.is_portal_root()</property>\n+        </object>\n+        <object name="redirection" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:not plone_context_state.is_portal_root()</property>\n+        </object>\n+    </object>\n+    <object name="portal_tabs" meta_type="CMF Action Category">\n+        <object name="index_html" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:plone_portal_state.navigation_root_url()</property>\n+        </object>\n+    </object>\n+    <object name="user" meta_type="CMF Action Category">\n+        <object name="preferences" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/@@personal-preferences"</property>\n+        </object>\n+        <object name="login" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/login"</property>\n+        </object>\n+        <object name="join" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/@@register"</property>\n+        </object>\n+        <object name="undo" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/undo_form"</property>\n+        </object>\n+        <object name="logout" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/logout"</property>\n+        </object>\n+    </object>\n+</object>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2022-08-19T22:49:22+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/d033378043bca8b176b631f8dfcd15af30524e59

Merge pull request #294 from plone/fix-actions

add migration of actions.xml and infrastructure to beta2

Files changed:
A news/294.bugfix
A plone/app/upgrade/v60/betas.py
A plone/app/upgrade/v60/profiles/to6007/actions.xml
M plone/app/upgrade/v60/configure.zcml
M plone/app/upgrade/v60/profiles.zcml

b'diff --git a/news/294.bugfix b/news/294.bugfix\nnew file mode 100644\nindex 00000000..2ae0cce2\n--- /dev/null\n+++ b/news/294.bugfix\n@@ -0,0 +1,3 @@\n+Add migration of actions.xml for https://github.com/plone/Products.CMFPlone/pull/3616 \n+Add infrastructure for to beta2 migrations.\n+[jensens]\ndiff --git a/plone/app/upgrade/v60/betas.py b/plone/app/upgrade/v60/betas.py\nnew file mode 100644\nindex 00000000..404ea300\n--- /dev/null\n+++ b/plone/app/upgrade/v60/betas.py\n@@ -0,0 +1,3 @@\n+import logging\n+\n+logger = logging.getLogger("plone.app.upgrade")\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 8e649aaf..99e528ee 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -131,19 +131,18 @@\n \n     </gs:upgradeSteps>\n \n-  <gs:upgradeSteps\n-      profile="Products.CMFPlone:plone"\n-      source="6006"\n-      destination="6007"\n-      >\n-    <!-- Plone 6.0.0b2 -->\n-\n-    <gs:upgradeStep\n-        title="Miscellaneous"\n-        description=""\n-        handler="..utils.null_upgrade_step"\n-        />\n-\n-  </gs:upgradeSteps>\n+    <gs:upgradeSteps\n+        profile="Products.CMFPlone:plone"\n+        source="6006"\n+        destination="6007"\n+        >\n+        <!-- Plone 6.0.0b2 -->\n+\n+      <gs:upgradeDepends\n+          title="Run to6007 upgrade profile."\n+          import_profile="plone.app.upgrade.v60:to6007"\n+          />\n+\n+    </gs:upgradeSteps>\n \n </configure>\ndiff --git a/plone/app/upgrade/v60/profiles.zcml b/plone/app/upgrade/v60/profiles.zcml\nindex 64e2c7ed..e02a31e0 100644\n--- a/plone/app/upgrade/v60/profiles.zcml\n+++ b/plone/app/upgrade/v60/profiles.zcml\n@@ -7,7 +7,7 @@\n       name="to6000"\n       title="Upgrade profile for Plone 5.2.x to Plone 6.0.0a1.dev0 (6000)"\n       directory="profiles/to6000"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -15,7 +15,7 @@\n       name="to6003"\n       title="Upgrade profile to Plone 6.0.0a3 (6003)"\n       directory="profiles/to6003"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -23,7 +23,7 @@\n       name="to6004"\n       title="Upgrade profile to Plone 6.0.0a4 (6004)"\n       directory="profiles/to6004"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -31,7 +31,14 @@\n       name="to6005"\n       title="Upgrade profile to Plone 6.0.0a5 (6005)"\n       directory="profiles/to6005"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+  <genericsetup:registerProfile\n+      name="to6007"\n+      title="Upgrade profile to Plone 6.0.0b2 (6007)"\n+      directory="profiles/to6007"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n@@ -43,7 +50,7 @@\n       name="to_dx_site_root"\n       title="Upgrade profile to change the FTI for the Plone Site object a dexterity one"\n       directory="profiles/to_dx_site_root"\n-      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \ndiff --git a/plone/app/upgrade/v60/profiles/to6007/actions.xml b/plone/app/upgrade/v60/profiles/to6007/actions.xml\nnew file mode 100644\nindex 00000000..acaf249f\n--- /dev/null\n+++ b/plone/app/upgrade/v60/profiles/to6007/actions.xml\n@@ -0,0 +1,66 @@\n+<?xml version="1.0"?>\n+<object name="portal_actions" meta_type="Plone Actions Tool"\n+    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n+    <object name="site_actions" meta_type="CMF Action Category">\n+        <object name="sitemap" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/sitemap"</property>\n+        </object>\n+        <object name="accessibility" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/accessibility-info"</property>\n+        </object>\n+        <object name="contact" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/contact-info"</property>\n+        </object>\n+    </object>\n+    <object name="object" meta_type="CMF Action Category">\n+        <object name="folderContents" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_context_state.folder().absolute_url()}/folder_contents"</property>\n+        </object>\n+        <object name="contentrules" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">string:${plone_context_state/canonical_object_url}/@@manage-content-rules</property>\n+            <property name="available_expr">python:plone_context_state.canonical_object().restrictedTraverse(\'@@plone_contentrules_info\').show_rules_tab()</property>\n+        </object>\n+    </object>\n+    <object name="object_buttons" meta_type="CMF Action Category">\n+        <object name="cut" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and checkPermission("Copy or Move", object) and not plone_context_state.is_portal_root()</property>\n+        </object>\n+        <object name="copy" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:checkPermission("Copy or Move", object) and not plone_context_state.is_portal_root()</property>\n+        </object>\n+        <object name="paste" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_context_state.folder().absolute_url()}/object_paste"</property>\n+        </object>\n+        <object name="delete" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and not plone_context_state.is_portal_root()</property>\n+        </object>\n+        <object name="rename" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:checkPermission("Delete objects", plone_context_state.parent()) and checkPermission("Copy or Move", object) and checkPermission("Add portal content", object) and not plone_context_state.is_portal_root()</property>\n+        </object>\n+        <object name="redirection" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="available_expr">python:not plone_context_state.is_portal_root()</property>\n+        </object>\n+    </object>\n+    <object name="portal_tabs" meta_type="CMF Action Category">\n+        <object name="index_html" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:plone_portal_state.navigation_root_url()</property>\n+        </object>\n+    </object>\n+    <object name="user" meta_type="CMF Action Category">\n+        <object name="preferences" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/@@personal-preferences"</property>\n+        </object>\n+        <object name="login" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/login"</property>\n+        </object>\n+        <object name="join" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/@@register"</property>\n+        </object>\n+        <object name="undo" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/undo_form"</property>\n+        </object>\n+        <object name="logout" meta_type="CMF Action" i18n:domain="plone">\n+            <property name="url_expr">python:f"{plone_portal_state.navigation_root_url()}/logout"</property>\n+        </object>\n+    </object>\n+</object>\n'

