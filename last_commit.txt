Repository: plone.volto


Branch: refs/heads/main
Date: 2022-09-29T16:17:17+02:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/0a5406be36bbc6ee6ed751dd1915722bc9efc286

fix indexers when there is a broken preview_image_link (#91)

* fix indexers when there is a broken preview_image_link

* changelog

Files changed:
A news/91.bugfix
M src/plone/volto/indexers.py

b'diff --git a/news/91.bugfix b/news/91.bugfix\nnew file mode 100644\nindex 0000000..7e86e24\n--- /dev/null\n+++ b/news/91.bugfix\n@@ -0,0 +1,2 @@\n+- Fix hasPreviewImage and image_field indexers when the preview_image_link\n+  relation is broken. [davisagli]\ndiff --git a/src/plone/volto/indexers.py b/src/plone/volto/indexers.py\nindex 9ecd181..b8e92ff 100644\n--- a/src/plone/volto/indexers.py\n+++ b/src/plone/volto/indexers.py\n@@ -10,7 +10,9 @@ def hasPreviewImage(obj):\n     Indexer for knowing in a catalog search if a content with the IPreview behavior has\n     a preview_image\n     """\n-    if obj.aq_base.preview_image or obj.aq_base.preview_image_link:\n+    if obj.aq_base.preview_image or (\n+        obj.aq_base.preview_image_link and not obj.preview_image_link.isBroken()\n+    ):\n         return True\n     return False\n \n@@ -23,7 +25,10 @@ def image_field_indexer(obj):\n     image_field = ""\n     if getattr(base_obj, "preview_image", False):\n         image_field = "preview_image"\n-    elif getattr(base_obj, "preview_image_link", False):\n+    elif (\n+        getattr(base_obj, "preview_image_link", False)\n+        and not base_obj.preview_image_link.isBroken()\n+    ):\n         image_field = "preview_image_link"\n     elif getattr(base_obj, "image", False):\n         image_field = "image"\n'

