Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2020-07-24T19:07:50+02:00
Author: mamico (mamico) <mauro.amico@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/0e0169f27690b4193be9021b7d6858b2177c739c

safewrite tg attribute

Files changed:
M src/plone/app/multilingual/manager.py

b"diff --git a/src/plone/app/multilingual/manager.py b/src/plone/app/multilingual/manager.py\nindex aa541e94..0e60047d 100644\n--- a/src/plone/app/multilingual/manager.py\n+++ b/src/plone/app/multilingual/manager.py\n@@ -12,6 +12,7 @@\n from plone.app.multilingual.interfaces import NOTG\n from plone.app.multilingual.itg import addAttributeTG\n from plone.app.uuid.utils import uuidToObject\n+from plone.protect.auto import safeWrite\n from plone.uuid.handlers import addAttributeUUID\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n@@ -43,7 +44,7 @@ def get_id(self, context):\n         # We must ensure that this case can't happen, any object translatable\n         # will have an UUID (in any case we can be at the portal factory!)\n         except KeyError:\n-            context._v_safe_write = True\n+            safeWrite(context)\n             addAttributeUUID(context, None)\n             context.reindexObject(idxs=['UID'])\n             context_id = IUUID(context)\n@@ -59,6 +60,7 @@ def get_tg(self, context):\n         # We must ensure that this case can't happen, any object translatable\n         # will have an UUID (in any case we can be at the portal factory!)\n         except TypeError:\n+            safeWrite(context)\n             addAttributeTG(context, None)\n             context.reindexObject(idxs=['TranslationGroup'])\n             context_id = ITG(context)\n"

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2020-07-24T20:12:41+02:00
Author: mamico (mamico) <mauro.amico@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/b2575394b807426d1b07dbcada28aa9b13f83880

changelog

Files changed:
A news/375.bugfix

b'diff --git a/news/375.bugfix b/news/375.bugfix\nnew file mode 100644\nindex 00000000..49906703\n--- /dev/null\n+++ b/news/375.bugfix\n@@ -0,0 +1 @@\n+Fix missing "safewrite" during the setting of TG attribute. [mamico]\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2020-07-25T11:30:21+02:00
Author: mamico (mamico) <mauro.amico@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/e7c1e1d7e1ab8fae17a8befcadce33ce58e643be

mark context `safewrite` was not enough because there are changes also in catalog

Files changed:
M src/plone/app/multilingual/manager.py

b"diff --git a/src/plone/app/multilingual/manager.py b/src/plone/app/multilingual/manager.py\nindex 0e60047d..54d2144b 100644\n--- a/src/plone/app/multilingual/manager.py\n+++ b/src/plone/app/multilingual/manager.py\n@@ -12,12 +12,14 @@\n from plone.app.multilingual.interfaces import NOTG\n from plone.app.multilingual.itg import addAttributeTG\n from plone.app.uuid.utils import uuidToObject\n-from plone.protect.auto import safeWrite\n+from plone.protect.interfaces import IDisableCSRFProtection\n from plone.uuid.handlers import addAttributeUUID\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import ILanguage\n+from zope.globalrequest import getRequest\n from zope.event import notify\n+from zope.interface import alsoProvides\n from zope.interface import implementer\n from zope.site.hooks import getSite\n \n@@ -44,7 +46,7 @@ def get_id(self, context):\n         # We must ensure that this case can't happen, any object translatable\n         # will have an UUID (in any case we can be at the portal factory!)\n         except KeyError:\n-            safeWrite(context)\n+            alsoProvides(getRequest(), IDisableCSRFProtection)\n             addAttributeUUID(context, None)\n             context.reindexObject(idxs=['UID'])\n             context_id = IUUID(context)\n@@ -58,9 +60,9 @@ def get_tg(self, context):\n         try:\n             context_id = ITG(context)\n         # We must ensure that this case can't happen, any object translatable\n-        # will have an UUID (in any case we can be at the portal factory!)\n+        # will have an TG (in any case we can be at the portal factory!)\n         except TypeError:\n-            safeWrite(context)\n+            alsoProvides(getRequest(), IDisableCSRFProtection)\n             addAttributeTG(context, None)\n             context.reindexObject(idxs=['TranslationGroup'])\n             context_id = ITG(context)\n"

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2020-09-09T11:13:37+02:00
Author: mamico (mamico) <mauro.amico@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/1b6fd77b29eb0d7eb2533f142658d967e4056e26

sync with master

Files changed:
A news/3130.bugfix
M setup.py
M src/plone/app/multilingual/browser/controlpanel.py
M src/plone/app/multilingual/browser/migrator.py
M src/plone/app/multilingual/events.py
M src/plone/app/multilingual/interfaces.py
M src/plone/app/multilingual/manager.py
M src/plone/app/multilingual/subscriber.py
M src/plone/app/multilingual/tests/test_helper_views.py

b"diff --git a/news/3130.bugfix b/news/3130.bugfix\nnew file mode 100644\nindex 00000000..3bd256f1\n--- /dev/null\n+++ b/news/3130.bugfix\n@@ -0,0 +1,5 @@\n+Fixed deprecation warning for ComponentLookupError.\n+Fixed deprecation warning for ILanguageSchema, depend on ``plone.i18n`` 4.0.4.\n+Fixed deprecation warning for IObjectEvent from zope.component.\n+Fixed deprecation warning for zope.site.hooks.\n+[maurits]\ndiff --git a/setup.py b/setup.py\nindex 3848b984..0dd19a15 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -11,6 +11,7 @@\n     include_package_data=True,\n     zip_safe=False,\n     install_requires=[\n+        'plone.i18n>=4.0.4',\n         'Products.CMFPlone>=5.2rc4',\n         'setuptools',\n         'six',\ndiff --git a/src/plone/app/multilingual/browser/controlpanel.py b/src/plone/app/multilingual/browser/controlpanel.py\nindex 612e8fd1..7f3289e9 100644\n--- a/src/plone/app/multilingual/browser/controlpanel.py\n+++ b/src/plone/app/multilingual/browser/controlpanel.py\n@@ -14,7 +14,7 @@\n from z3c.form import button\n from zc.relation.interfaces import ICatalog as IRelationCatalog\n from zope.component import getUtility\n-from zope.component.interfaces import ComponentLookupError\n+from zope.interface.interfaces import ComponentLookupError\n from zope.i18nmessageid import MessageFactory\n from zope.schema.interfaces import IVocabularyFactory\n \ndiff --git a/src/plone/app/multilingual/browser/migrator.py b/src/plone/app/multilingual/browser/migrator.py\nindex 5b702957..9b21dfac 100644\n--- a/src/plone/app/multilingual/browser/migrator.py\n+++ b/src/plone/app/multilingual/browser/migrator.py\n@@ -14,7 +14,7 @@\n from zc.relation.interfaces import ICatalog\n from zope.component import getUtility\n from zope.component.hooks import getSite\n-from zope.component.interfaces import ComponentLookupError\n+from zope.interface.interfaces import ComponentLookupError\n from zope.interface import Interface\n \n import logging\ndiff --git a/src/plone/app/multilingual/events.py b/src/plone/app/multilingual/events.py\nindex b51ce8c0..f7ec2b70 100644\n--- a/src/plone/app/multilingual/events.py\n+++ b/src/plone/app/multilingual/events.py\n@@ -1,7 +1,7 @@\n # -*- coding: utf-8 -*-\n-from zope.component.interfaces import IObjectEvent\n from zope.interface import Attribute\n from zope.interface import implementer\n+from zope.interface.interfaces import IObjectEvent\n \n \n class IObjectWillBeTranslatedEvent(IObjectEvent):\ndiff --git a/src/plone/app/multilingual/interfaces.py b/src/plone/app/multilingual/interfaces.py\nindex aa1e83d3..cde3ca5a 100644\n--- a/src/plone/app/multilingual/interfaces.py\n+++ b/src/plone/app/multilingual/interfaces.py\n@@ -1,6 +1,7 @@\n # -*- coding: utf-8 -*-\n from plone.app.multilingual import _\n from plone.app.z3cform.interfaces import IPloneFormLayer\n+from plone.i18n.interfaces import ILanguageSchema\n from plone.supermodel import model\n from zope import schema\n from zope.interface import Attribute\n@@ -8,12 +9,6 @@\n from zope.schema.vocabulary import SimpleTerm\n from zope.schema.vocabulary import SimpleVocabulary\n \n-try:\n-    from plone.i18n.interfaces import ILanguageSchema\n-except ImportError:\n-    # BBB for Plone 5.1, remove with Plone 6\n-    from Products.CMFPlone.interfaces import ILanguageSchema\n-\n \n # CONSTANTS\n SHARED_NAME = 'shared'\ndiff --git a/src/plone/app/multilingual/manager.py b/src/plone/app/multilingual/manager.py\nindex 54d2144b..66a13b41 100644\n--- a/src/plone/app/multilingual/manager.py\n+++ b/src/plone/app/multilingual/manager.py\n@@ -18,10 +18,10 @@\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import ILanguage\n from zope.globalrequest import getRequest\n+from zope.component.hooks import getSite\n from zope.event import notify\n from zope.interface import alsoProvides\n from zope.interface import implementer\n-from zope.site.hooks import getSite\n \n \n @implementer(ITranslationManager)\ndiff --git a/src/plone/app/multilingual/subscriber.py b/src/plone/app/multilingual/subscriber.py\nindex 6069fb7b..42816ad6 100644\n--- a/src/plone/app/multilingual/subscriber.py\n+++ b/src/plone/app/multilingual/subscriber.py\n@@ -5,9 +5,11 @@\n from plone.app.multilingual.interfaces import ILanguageIndependentFolder\n from plone.app.multilingual.interfaces import IMutableTG\n from plone.app.multilingual.interfaces import IPloneAppMultilingualInstalled\n+from plone.app.multilingual.interfaces import ITG\n from plone.app.multilingual.interfaces import ITranslatable\n from plone.app.multilingual.interfaces import ITranslationManager\n from plone.app.multilingual.interfaces import LANGUAGE_INDEPENDENT\n+from plone.app.multilingual.itg import addAttributeTG\n from plone.dexterity.interfaces import IDexterityContent\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.interfaces import IFolderish\n@@ -116,6 +118,9 @@ def set_recursive_language(ob, language):\n \n     elif ILanguage(ob).get_language() != language:\n         ILanguage(ob).set_language(language)\n+        if ITG(ob, None) is None:\n+            addAttributeTG(ob, None)\n+            ob.reindexObject(idxs=['TranslationGroup'])\n         ITranslationManager(ob).update()\n         reindex_object(ob)\n \ndiff --git a/src/plone/app/multilingual/tests/test_helper_views.py b/src/plone/app/multilingual/tests/test_helper_views.py\nindex cad7464b..9f3f07ff 100644\n--- a/src/plone/app/multilingual/tests/test_helper_views.py\n+++ b/src/plone/app/multilingual/tests/test_helper_views.py\n@@ -7,10 +7,10 @@\n from plone.app.testing import TEST_USER_NAME\n from plone.app.testing import TEST_USER_PASSWORD\n from plone.dexterity.utils import createContentInContainer\n+from plone.i18n.interfaces import ILanguageSchema\n from plone.registry.interfaces import IRegistry\n from plone.testing.z2 import Browser\n from Products.CMFPlone.interfaces import ILanguage\n-from Products.CMFPlone.interfaces import ILanguageSchema\n from zope.component import getUtility\n from zope.interface import alsoProvides\n \n"

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2021-10-08T01:50:55+02:00
Author: mamico (mamico) <mauro.amico@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/58e4181889e21b71ac1b38e0a2af41b45df0a86e

update changelog

Files changed:
M news/375.bugfix

b'diff --git a/news/375.bugfix b/news/375.bugfix\nindex 49906703..d770effd 100644\n--- a/news/375.bugfix\n+++ b/news/375.bugfix\n@@ -1 +1 @@\n-Fix missing "safewrite" during the setting of TG attribute. [mamico]\n+Disable CSRF protection during the setting of TG attribute. [mamico]\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2021-10-08T01:51:35+02:00
Author: mamico (mamico) <mauro.amico@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/c8173f76bab8f46b0337ca0907a81fbc0a96f6b6

Merge branch 'master' into mamico/safewrite

Files changed:
M CHANGES.rst
M setup.cfg
M setup.py
M src/plone/app/multilingual/browser/javascript/babel_helper.js
M src/plone/app/multilingual/browser/setup.py
M src/plone/app/multilingual/browser/templates/add-form-is-translation.pt
M src/plone/app/multilingual/browser/templates/controlpanel.pt
M src/plone/app/multilingual/browser/templates/dexterity_edit.pt
M src/plone/app/multilingual/browser/templates/modify_translations.pt
M src/plone/app/multilingual/dx/cloner.py
M src/plone/app/multilingual/setuphandlers.py
M src/plone/app/multilingual/tests/robot/test_add_translation.robot
M src/plone/app/multilingual/tests/robot/test_translate_content.robot
M src/plone/app/multilingual/tests/test_menu.py
M src/plone/app/multilingual/tests/test_selector.py
M src/plone/app/multilingual/tests/test_setup.py
D news/3130.bugfix

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex eaf56401..35114a31 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -8,6 +8,84 @@ Changelog\n \n .. towncrier release notes start\n \n+6.0.0a3 (2021-09-15)\n+--------------------\n+\n+Bug fixes:\n+\n+\n+- Remove cyclic dependency with Products.CMFPlone\n+  [ericof] (#391)\n+\n+\n+6.0.0a2 (2021-09-01)\n+--------------------\n+\n+Bug fixes:\n+\n+\n+- Force view_methods to be a tuple on setup and uninstall (#337)\n+- Fix deleting items with broken relation in languageindependent field\n+  [pbauer] (#390)\n+\n+\n+6.0.0a1 (2021-04-28)\n+--------------------\n+\n+Breaking changes:\n+\n+\n+- Bootstrapify for barceloneta-lts (#380)\n+\n+      * Init add to own branch\n+\n+      * Add back missing html tag\n+\n+      * Fix double msgs & add full width\n+\n+      * Fix headings\n+\n+      * Init add to own branch\n+\n+      * Add back missing html tag\n+\n+      * Fix headings\n+\n+      * fix test, use string from footer\n+\n+      * fix test, check h1 not documentFirstHeading\n+\n+      * fix test, use contains text\n+\n+      * update icons\n+\n+      * Jquery load is removed with jq3.\n+\n+      * major version bump\n+\n+      Co-authored-by: Peter Holzer <peter.holzer@agitator.com>\n+      Co-authored-by: Peter Mathis <peter.mathis@kombinat.at> (#380)\n+\n+\n+Bug fixes:\n+\n+\n+- Force view_methods to be a tuple on setup and uninstall (#337)\n+\n+\n+5.6.2 (2020-09-26)\n+------------------\n+\n+Bug fixes:\n+\n+\n+- Fixed deprecation warning for ComponentLookupError.\n+  Fixed deprecation warning for ILanguageSchema, depend on ``plone.i18n`` 4.0.4.\n+  Fixed deprecation warning for IObjectEvent from zope.component.\n+  Fixed deprecation warning for zope.site.hooks.\n+  [maurits] (#3130)\n+\n+\n 5.6.1 (2020-06-24)\n ------------------\n \n@@ -203,6 +281,10 @@ Bug fixes:\n - Fixed tests now that Catalan has translated \xe2\x80\x98assets\xe2\x80\x99 into \xe2\x80\x98recursos\xe2\x80\x99.\n   [maurits]\n \n+- Run addAttributeTG for the site root when installing. This prevents\n+  triggering plone.protect.\n+  [jaroel]\n+\n \n 5.2.0 (2018-04-04)\n ------------------\ndiff --git a/news/3130.bugfix b/news/3130.bugfix\ndeleted file mode 100644\nindex 3bd256f1..00000000\n--- a/news/3130.bugfix\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-Fixed deprecation warning for ComponentLookupError.\n-Fixed deprecation warning for ILanguageSchema, depend on ``plone.i18n`` 4.0.4.\n-Fixed deprecation warning for IObjectEvent from zope.component.\n-Fixed deprecation warning for zope.site.hooks.\n-[maurits]\ndiff --git a/setup.cfg b/setup.cfg\nindex 333e0508..f6e8d493 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -1,20 +1,21 @@\n [metadata]\n-version = 5.6.2.dev0\n+version = 6.0.0a4.dev0\n name = plone.app.multilingual\n description = Multilingual Plone Content package\n long_description = file: README.rst, CREDITS.rst, CHANGES.rst\n classifiers=\n     Development Status :: 5 - Production/Stable\n+    Environment :: Web Environment\n     Framework :: Plone\n-    Framework :: Plone :: 5.2\n+    Framework :: Plone :: 6.0\n     Framework :: Plone :: Core\n-    License :: OSI Approved :: GNU General Public License (GPL)\n+    Framework :: Zope :: 5\n+    License :: OSI Approved :: GNU General Public License v2 (GPLv2)\n+    Operating System :: OS Independent\n     Programming Language :: Python\n-    Programming Language :: Python :: 2.7\n-    Programming Language :: Python :: 3.6\n     Programming Language :: Python :: 3.7\n     Programming Language :: Python :: 3.8\n-    Topic :: Software Development :: Libraries :: Python Modules\n+    Programming Language :: Python :: 3.9\n url = https://github.com/plone/plone.app.multilingual\n license = GPL\n keywords = language, multilingual, content\ndiff --git a/setup.py b/setup.py\nindex 0dd19a15..9115d66f 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -12,7 +12,6 @@\n     zip_safe=False,\n     install_requires=[\n         \'plone.i18n>=4.0.4\',\n-        \'Products.CMFPlone>=5.2rc4\',\n         \'setuptools\',\n         \'six\',\n     ],\ndiff --git a/src/plone/app/multilingual/browser/javascript/babel_helper.js b/src/plone/app/multilingual/browser/javascript/babel_helper.js\nindex 4296ef56..0792d47c 100644\n--- a/src/plone/app/multilingual/browser/javascript/babel_helper.js\n+++ b/src/plone/app/multilingual/browser/javascript/babel_helper.js\n@@ -169,7 +169,7 @@\n         });\n     }\n \n-    $(window).load(function () {\n+    $(window).on("load", function () {\n \n         /* alert about language independent field */\n         $(\'.languageindependent\').click(function () {\ndiff --git a/src/plone/app/multilingual/browser/setup.py b/src/plone/app/multilingual/browser/setup.py\nindex 76808f13..02475db7 100644\n--- a/src/plone/app/multilingual/browser/setup.py\n+++ b/src/plone/app/multilingual/browser/setup.py\n@@ -264,8 +264,8 @@ def setupLanguageSwitcher(self):\n         tt = getToolByName(self.context, \'portal_types\')\n         site = tt[\'Plone Site\']\n \n-        if \'language-switcher\' not in site.view_methods:\n-            methods = site.view_methods\n+        methods = tuple(site.view_methods)\n+        if \'language-switcher\' not in methods:\n             site.view_methods = methods + (\'language-switcher\', )\n             site.default_view = \'language-switcher\'\n             self.context.reindexObject()\ndiff --git a/src/plone/app/multilingual/browser/templates/add-form-is-translation.pt b/src/plone/app/multilingual/browser/templates/add-form-is-translation.pt\nindex 13a9b3fb..67af4856 100644\n--- a/src/plone/app/multilingual/browser/templates/add-form-is-translation.pt\n+++ b/src/plone/app/multilingual/browser/templates/add-form-is-translation.pt\n@@ -1,18 +1,27 @@\n <div class="container">\n-  <div class="portalMessage info" role="status">\n-    <strong i18n:translate="" i18n:domain="plone">\n-      Info\n-    </strong>\n-    <tal:block i18n:domain="plone"\n-               i18n:translate="add-form-is-translation">\n-      This object is going to be a translation to <span i18n:name="language" tal:replace="python:view.language_name(view.language())"></span> from:\n-    </tal:block>\n-    <ul>\n-      <li tal:repeat="origin view/origin"><span tal:content="python:view.language_name(origin.Language)"></span>: <a href="#" class="link-overlay" tal:attributes="href origin/getURL">  <span tal:content="origin/Title"></span></a></li>\n-    </ul>\n-    <span i18n:domain="plone" i18n:translate="create-object-without-translation">\n+    <div class="row">\n+        <div class="alert alert-info col-12" role="alert">\n+            <strong i18n:translate="" i18n:domain="plone">\n+                Info\n+            </strong>\n+            <tal:block i18n:domain="plone"\n+                     i18n:translate="add-form-is-translation">\n+                This object is going to be a translation to\n+                <span i18n:name="language" tal:replace="python:view.language_name(view.language())"></span>\n+                from:\n+            </tal:block>\n+            <ul>\n+                <li tal:repeat="origin view/origin">\n+                    <span tal:content="python:view.language_name(origin.Language)"></span>:\n+                    <a href="#"\n+                       class="link-overlay" tal:attributes="href origin/getURL">\n+                        <span tal:content="origin/Title"></span></a></li>\n+            </ul>\n+            <span i18n:domain="plone" i18n:translate="create-object-without-translation">\n       If you want to create this object without being a translation press\n-      <a href="#" class="link-overlay" i18n:name="url" tal:attributes="href view/returnURL" i18n:translate="">here</a>\n+      <a href="#"\n+         class="link-overlay" i18n:name="url" tal:attributes="href view/returnURL" i18n:translate="">here</a>\n     </span>\n-  </div>\n+        </div>\n+    </div>\n </div>\ndiff --git a/src/plone/app/multilingual/browser/templates/controlpanel.pt b/src/plone/app/multilingual/browser/templates/controlpanel.pt\nindex fca5b46e..b13b2dd9 100644\n--- a/src/plone/app/multilingual/browser/templates/controlpanel.pt\n+++ b/src/plone/app/multilingual/browser/templates/controlpanel.pt\n@@ -8,8 +8,9 @@\n \n <body>\n \n-<div metal:fill-slot="prefs_configlet_main">\n+<tal:main metal:fill-slot="prefs_configlet_main">\n \n+  <header>\n     <a id="setup-link" class="link-parent"\n        tal:attributes="href string:$portal_url/@@overview-controlpanel"\n        i18n:translate="">\n@@ -21,27 +22,27 @@\n     <div metal:use-macro="context/global_statusmessage/macros/portal_message">\n       Portal status message\n     </div>\n+  </header>\n+  <div id="content-core">\n+      <div id="layout-contents">\n+          <span tal:replace="structure view/contents" />\n+      </div>\n+      <div class="mt-4">\n+        <p i18n:translate="">\n+          The\n+          <a i18n:name="url" i18n:translate="" tal:attributes="href string:${context/absolute_url}/multilingual-map">multilingual map view\n+          </a>\n+          allows you to view in a graphical manner the already translated items and its relations.\n+        </p>\n+        <p i18n:translate=""\n+            tal:condition="view/isLPinstalled">\n+          In case you want to migrate from Products.LinguaPlone access to the\n+          <a i18n:name="url" i18n:translate="" tal:attributes="href string:${context/absolute_url}/lp-migration">migration procedure.\n+          </a>\n+        </p>\n+      </div>\n+  </div>\n \n-    <div id="content-core">\n-        <div id="layout-contents">\n-            <span tal:replace="structure view/contents" />\n-        </div>\n-        <div>\n-          <p i18n:translate="">\n-            The\n-            <a i18n:name="url" i18n:translate="" tal:attributes="href string:${context/absolute_url}/multilingual-map">multilingual map view\n-            </a>\n-            allows you to view in a graphical manner the already translated items and its relations.\n-          </p>\n-          <p i18n:translate=""\n-             tal:condition="view/isLPinstalled">\n-            In case you want to migrate from Products.LinguaPlone access to the\n-            <a i18n:name="url" i18n:translate="" tal:attributes="href string:${context/absolute_url}/lp-migration">migration procedure.\n-            </a>\n-          </p>\n-        </div>\n-    </div>\n-\n-</div>\n+</tal:main>\n </body>\n </html>\ndiff --git a/src/plone/app/multilingual/browser/templates/dexterity_edit.pt b/src/plone/app/multilingual/browser/templates/dexterity_edit.pt\nindex f1fddce5..90954606 100644\n--- a/src/plone/app/multilingual/browser/templates/dexterity_edit.pt\n+++ b/src/plone/app/multilingual/browser/templates/dexterity_edit.pt\n@@ -11,8 +11,9 @@\n     <script src="++resource++plone.app.multilingual.javascript/babel_helper.js"></script>\n     <input type="hidden" id="url_translate" value="" tal:attributes="value context/absolute_url"/>\n     <input type="hidden" id="gtranslate_service_available" value="" tal:attributes="value pamutils/gtenabled"/>\n+\n     <div class=\'col-md-6\'>\n-        <h1 i18n:translate="heading_available_translations">Available translations for this content</h1>\n+        <h2 i18n:translate="heading_available_translations">Available translations for this content</h2>\n         <div id="trans-selector"\n              tal:define="languages pamutils/translated_languages;\n              max_nr_of_buttons view/max_nr_of_buttons">\n@@ -40,7 +41,7 @@\n     </div>\n     <div class=\'col-md-6\'>\n     <div id="header-translation">\n-        <h1 i18n:translate="translation_to">Translation to <span i18n:name="language" tal:content="pamutils/current_language_name" tal:omit-tag="">es</span></h1>\n+        <h2 i18n:translate="translation_to">Translation to <span i18n:name="language" tal:content="pamutils/current_language_name" tal:omit-tag="">es</span></h2>\n     </div>\n     <div id="form-target">\n       <tal:block content="structure view/babel_content">Content edit</tal:block>\ndiff --git a/src/plone/app/multilingual/browser/templates/modify_translations.pt b/src/plone/app/multilingual/browser/templates/modify_translations.pt\nindex dbddabb8..7a500f81 100644\n--- a/src/plone/app/multilingual/browser/templates/modify_translations.pt\n+++ b/src/plone/app/multilingual/browser/templates/modify_translations.pt\n@@ -10,25 +10,25 @@\n \n <metal:main fill-slot="main">\n \n-  <h1 class="documentFirstHeading"\n-      i18n:translate=""\n-      metal:define-slot="heading">\n-    Modify translations\n-  </h1>\n+    <header>\n+      <h1 class="documentFirstHeading"\n+          i18n:translate=""\n+          metal:define-slot="heading">\n+        Modify translations\n+      </h1>\n \n-  <div class="documentDescription" i18n:translate="long_description_modify_translations">\n-    This form allows you to add or remove translations for the current object.\n-  </div>\n+      <div class="documentDescription" i18n:translate="long_description_modify_translations">\n+        This form allows you to add or remove translations for the current object.\n+      </div>\n+    </header>\n \n   <div id="content-core">\n \n-    <table class="listing" id="translations-overview" summary="Translations overview">\n+    <table class="table table-bordered table-striped table-sm" id="translations-overview" summary="Translations overview">\n       <tal:langs repeat="lang view/available_languages">\n-        <tr tal:define="translation python:view.get_translation(lang);\n-                        oddrow repeat/lang/odd;"\n-            tal:attributes="class python:oddrow and \'odd\' or \'even\'">\n-          <td class="langColumn" tal:define="activeLanguage context/Language|nothing">\n-            <span tal:attributes="class python:lang == activeLanguage and \'activeLanguage\' or None"\n+        <tr tal:define="translation python:view.get_translation(lang);">\n+          <td class="align-middle text-center" tal:define="activeLanguage context/Language|nothing">\n+            <span tal:attributes="class python:lang == activeLanguage and \'activeLanguage font-weight-bold\' or None"\n                   tal:content="lang"></span>\n           </td>\n           <td>\n@@ -42,39 +42,43 @@\n               <h3 class="translationTitle discreet" i18n:translate="">Translation missing</h3>\n             </tal:notranslation>\n           </td>\n-          <td class="actionColumn">\n+          <td class="align-middle text-center">\n             <tal:hastranslation condition="python:translation and translation != context">\n               <a href="#" title="Disconnect translation" class="pat-plone-modal disconnectTranslationAction"\n                  tal:attributes="href string:${context/absolute_url}/disconnect_translation?came_from=${context/UID}&language=${lang}"\n                  i18n:attributes="title disconnect_translation">\n-                  <svg aria-hidden="true" width="14" height="14" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M503 1271l-256 256q-10 9-23 9-12 0-23-9-9-10-9-23t9-23l256-256q10-9 23-9t23 9q9 10 9 23t-9 23zm169 41v320q0 14-9 23t-23 9-23-9-9-23v-320q0-14 9-23t23-9 23 9 9 23zm-224-224q0 14-9 23t-23 9h-320q-14 0-23-9t-9-23 9-23 23-9h320q14 0 23 9t9 23zm1264 128q0 120-85 203l-147 146q-83 83-203 83-121 0-204-85l-334-335q-21-21-42-56l239-18 273 274q27 27 68 27.5t68-26.5l147-146q28-28 28-67 0-40-28-68l-274-275 18-239q35 21 56 42l336 336q84 86 84 204zm-617-724l-239 18-273-274q-28-28-68-28-39 0-68 27l-147 146q-28 28-28 67 0 40 28 68l274 274-18 240q-35-21-56-42l-336-336q-84-86-84-204 0-120 85-203l147-146q83-83 203-83 121 0 204 85l334 335q21 21 42 56zm633 84q0 14-9 23t-23 9h-320q-14 0-23-9t-9-23 9-23 23-9h320q14 0 23 9t9 23zm-544-544v320q0 14-9 23t-23 9-23-9-9-23v-320q0-14 9-23t23-9 23 9 9 23zm407 151l-256 256q-11 9-23 9t-23-9q-9-10-9-23t9-23l256-256q10-9 23-9t23 9q9 10 9 23t-9 23z"/></svg>\n-                <span class="actionLabel" i18n:translate="disconnect_translation">Disconnect translation</span>\n+                  <img src="" alt="" width="20" height="20" class="icon me-2"\n+                           tal:attributes="src string:++plone++bootstrap-icons/arrows-angle-expand.svg"/><span \n+                    class="d-none d-md-inline-block text-xs-right" i18n:translate="disconnect_translation">Disconnect translation</span>\n               </a>\n             </tal:hastranslation>\n             <tal:notranslation condition="not:translation">\n               <a href="#" title="Connect existing translation" class="pat-plone-modal connectTranslationAction"\n                  tal:attributes="href string:${context/absolute_url}/connect_translation?language=${lang}"\n                  i18n:attributes="title connect_existing_translation">\n-                  <svg aria-hidden="true" width="14" height="14" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1520 1216q0-40-28-68l-208-208q-28-28-68-28-42 0-72 32 3 3 19 18.5t21.5 21.5 15 19 13 25.5 3.5 27.5q0 40-28 68t-68 28q-15 0-27.5-3.5t-25.5-13-19-15-21.5-21.5-18.5-19q-33 31-33 73 0 40 28 68l206 207q27 27 68 27 40 0 68-26l147-146q28-28 28-67zm-703-705q0-40-28-68l-206-207q-28-28-68-28-39 0-68 27l-147 146q-28 28-28 67 0 40 28 68l208 208q27 27 68 27 42 0 72-31-3-3-19-18.5t-21.5-21.5-15-19-13-25.5-3.5-27.5q0-40 28-68t68-28q15 0 27.5 3.5t25.5 13 19 15 21.5 21.5 18.5 19q33-31 33-73zm895 705q0 120-85 203l-147 146q-83 83-203 83-121 0-204-85l-206-207q-83-83-83-203 0-123 88-209l-88-88q-86 88-208 88-120 0-204-84l-208-208q-84-84-84-204t85-203l147-146q83-83 203-83 121 0 204 85l206 207q83 83 83 203 0 123-88 209l88 88q86-88 208-88 120 0 204 84l208 208q84 84 84 204z"/></svg>\n-                <span class="actionLabel" i18n:translate="connect_existing_translation">Connect existing translation</span>\n+                  <img src="" alt="" width="20" height="20" class="icon me-2"\n+                           tal:attributes="src string:++plone++bootstrap-icons/arrows-angle-contract.svg"/><span \n+                    class="d-none d-md-inline-block" i18n:translate="connect_existing_translation">Connect existing translation</span>\n               </a>\n             </tal:notranslation>\n           </td>\n-          <td class="actionColumn">\n+          <td class="align-middle text-center">\n             <tal:hastranslation condition="python:translation and translation != context">\n               <a href="#" title="Delete translated item" class="pat-plone-modal deleteTranslationAction"\n                  tal:attributes="href string:${translation/absolute_url}/delete_confirmation"\n                  i18n:attributes="title delete_translated_item">\n-                <svg aria-hidden="true" width="14" height="14" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path class="icon" d="M704 1376v-704q0-14-9-23t-23-9h-64q-14 0-23 9t-9 23v704q0 14 9 23t23 9h64q14 0 23-9t9-23zm256 0v-704q0-14-9-23t-23-9h-64q-14 0-23 9t-9 23v704q0 14 9 23t23 9h64q14 0 23-9t9-23zm256 0v-704q0-14-9-23t-23-9h-64q-14 0-23 9t-9 23v704q0 14 9 23t23 9h64q14 0 23-9t9-23zm-544-992h448l-48-117q-7-9-17-11h-317q-10 2-17 11zm928 32v64q0 14-9 23t-23 9h-96v948q0 83-47 143.5t-113 60.5h-832q-66 0-113-58.5t-47-141.5v-952h-96q-14 0-23-9t-9-23v-64q0-14 9-23t23-9h309l70-167q15-37 54-63t79-26h320q40 0 79 26t54 63l70 167h309q14 0 23 9t9 23z"/></svg>\n-                <span class="actionLabel" i18n:translate="delete_translated_item">Delete translated item</span>\n+                  <img src="" alt="" width="20" height="20" class="icon me-2"\n+                           tal:attributes="src string:++plone++bootstrap-icons/trash.svg"/><span \n+                    class="d-none d-md-inline-block" i18n:translate="delete_translated_item">Delete translated item</span>\n               </a>\n             </tal:hastranslation>\n             <tal:notranslation condition="not:translation">\n               <a href="#" title="Add translation" class="pat-plone-modal addTranslationAction"\n                  tal:attributes="href string:${context/absolute_url}/@@create_translation?language=${lang}"\n                  i18n:attributes="title add_translation">\n-                  <svg aria-hidden="true" width="14" height="14" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1600 736v192q0 40-28 68t-68 28h-416v416q0 40-28 68t-68 28h-192q-40 0-68-28t-28-68v-416h-416q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h416v-416q0-40 28-68t68-28h192q40 0 68 28t28 68v416h416q40 0 68 28t28 68z"/></svg>\n-                <span class="actionLabel" i18n:translate="add_translation">Add translation</span>\n+                  <img src="" alt="" width="20" height="20"\n+                           tal:attributes="src string:++plone++bootstrap-icons/plus.svg"/><span \n+                    class="d-none d-md-inline-block" i18n:translate="add_translation">Add translation</span>\n               </a>\n             </tal:notranslation>\n           </td>\ndiff --git a/src/plone/app/multilingual/dx/cloner.py b/src/plone/app/multilingual/dx/cloner.py\nindex f5c489e9..c4221e3f 100644\n--- a/src/plone/app/multilingual/dx/cloner.py\n+++ b/src/plone/app/multilingual/dx/cloner.py\n@@ -49,6 +49,9 @@ def has_independent_fields(self):\n         return False\n \n     def copy_relation(self, relation_value, target_language):\n+        if not relation_value or relation_value.isBroken():\n+            return\n+\n         obj = relation_value.to_object\n         intids = getUtility(IIntIds)\n         translation = ITranslationManager(obj).get_translation(target_language)\n@@ -62,20 +65,24 @@ def copy_fields(self, translation):\n \n         target_language = queryAdapter(translation, ILanguage).get_language()\n \n-        def relation_copier(rel, lang=target_language, fun=self.copy_relation):\n-            return fun(rel, lang)\n-\n         for schema in iterSchemata(self.context):\n             for field_name in schema:\n                 if ILanguageIndependentField.providedBy(schema[field_name]):\n                     value = getattr(schema(self.context), field_name, _marker)\n-\n                     if value == _marker:\n                         continue\n                     elif IRelationValue.providedBy(value):\n                         value = self.copy_relation(value, target_language)\n                     elif IRelationList.providedBy(schema[field_name]):\n-                        value = list(map(relation_copier, value or []))\n+                        if not value:\n+                            value = []\n+                        else:\n+                            new_value = []\n+                            for relation in value:\n+                                copied_relation = self.copy_relation(relation, target_language)\n+                                if copied_relation:\n+                                    new_value.append(copied_relation)\n+                            value = new_value\n \n                     doomed = True\n                     setattr(schema(translation),\ndiff --git a/src/plone/app/multilingual/setuphandlers.py b/src/plone/app/multilingual/setuphandlers.py\nindex 2b559632..91673489 100644\n--- a/src/plone/app/multilingual/setuphandlers.py\n+++ b/src/plone/app/multilingual/setuphandlers.py\n@@ -1,6 +1,8 @@\n # -*- coding: utf-8 -*-\n from logging import getLogger\n from plone.app.multilingual.browser.setup import SetupMultilingualSite\n+from plone.app.multilingual.interfaces import ITranslatable\n+from plone.app.multilingual.itg import addAttributeTG\n from Products.CMFPlone.interfaces import INonInstallable\n from Products.CMFPlone.utils import getToolByName\n from zope.component.hooks import getSite\n@@ -42,15 +44,20 @@ def step_default_various(context):\n     portal = context.getSite()\n     enable_translatable_behavior(portal)\n \n+    # Add the attribute to the site root now so plone.protect won\'t cry.\n+    addAttributeTG(portal, None)\n+\n \n def enable_translatable_behavior(portal):\n     types_tool = portal.portal_types\n \n-    # Iterate through all Dexterity content type\n+    # Iterate through all Dexterity content type, except the site root\n     all_ftis = types_tool.listTypeInfo()\n-    dx_ftis = [x for x in all_ftis if getattr(x, \'behaviors\', False)]\n+    dx_ftis = (\n+        fti for fti in all_ftis\n+        if getattr(fti, \'behaviors\', False) and fti.getId() != \'Plone Site\'\n+    )\n     for fti in dx_ftis:\n-\n         # Enable translatable behavior for all types\n         behaviors = list(fti.behaviors)\n         behaviors.extend([\n@@ -90,8 +97,9 @@ def disable_language_switcher(portal):\n     """Remove the use of language-switcher as default view for Plone Site"""\n     tt = getToolByName(portal, \'portal_types\')\n     site = tt[\'Plone Site\']\n-    methods = site.view_methods\n-    site.view_methods = [m for m in methods if m != \'language-switcher\']\n+    site.view_methods = tuple(\n+        method for method in site.view_methods if method != \'language-switcher\'\n+    )\n     if site.default_view == \'language-switcher\':\n         site.default_view = \'listing_view\'\n \ndiff --git a/src/plone/app/multilingual/tests/robot/test_add_translation.robot b/src/plone/app/multilingual/tests/robot/test_add_translation.robot\nindex 6f943373..01908b40 100644\n--- a/src/plone/app/multilingual/tests/robot/test_add_translation.robot\n+++ b/src/plone/app/multilingual/tests/robot/test_add_translation.robot\n@@ -72,13 +72,13 @@ I link the document in English as a translation\n   Wait until element is visible  xpath=(//span[contains(., \'An English Document\')])\n   Click Element  xpath=(//span[contains(., \'An English Document\')])\n   Wait until page contains  An English Document\n-\n-  Click Element  xpath=(//*[contains(@class, \'plone-modal-footer\')]//input[@id=\'form-buttons-connect_translation\'])\n+  \n+  Click Element  xpath=(//*[contains(@class, \'plone-modal-footer\')]//button[@id=\'form-buttons-connect_translation\'])\n   Wait until page contains element  xpath=(//h3[@class="translationTitle"])\n   Sleep  5\n   Wait until element is visible  xpath=(//h3[@class="translationTitle"])\n-  Focus  xpath=(//*[@class="odd"]//a[contains(@href,"a-catalan-document")])\n-  Click Element  xpath=(//*[@class="odd"]//a[contains(@href,"a-catalan-document")])\n+  Focus  xpath=(//*[@id="translations-overview"]//a[contains(@href,"a-catalan-document")])\n+  Click Element  xpath=(//*[@id="translations-overview"]//a[contains(text(),\'/plone/ca/a-catalan-document\')])\n   Wait until page contains  A Catalan Document\n \n I switch to English\n@@ -89,6 +89,6 @@ I switch to English\n \n I can view the document in English\n   Wait until page contains element\n-  ...  xpath=//*[contains(@class, \'documentFirstHeading\')][./text()=\'An English Document\']\n+  ...  xpath=//h1[1][contains(text(),\'English Document\')]\n   Wait until page contains element\n   ...  xpath=//ul[@id=\'portal-languageselector\']/li[contains(@class, \'currentLanguage\')]/a[@title=\'English\']\ndiff --git a/src/plone/app/multilingual/tests/robot/test_translate_content.robot b/src/plone/app/multilingual/tests/robot/test_translate_content.robot\nindex 5cc97789..6c3a9d20 100644\n--- a/src/plone/app/multilingual/tests/robot/test_translate_content.robot\n+++ b/src/plone/app/multilingual/tests/robot/test_translate_content.robot\n@@ -74,6 +74,6 @@ I switch to Catalan\n \n I can view the document in Catalan\n   Page Should Contain Element\n-  ...  xpath=//*[contains(@class, \'documentFirstHeading\')][./text()=\'A Catalan Document\']\n+  ...  xpath=//h1[1][text()=\'A Catalan Document\']\n   Page Should Contain Element\n   ...  xpath=//ul[@id=\'portal-languageselector\']/li[contains(@class, \'currentLanguage\')]/a[@title=\'Catal\xc3\xa0\']\ndiff --git a/src/plone/app/multilingual/tests/test_menu.py b/src/plone/app/multilingual/tests/test_menu.py\nindex 2a92bf99..f5276ccd 100644\n--- a/src/plone/app/multilingual/tests/test_menu.py\n+++ b/src/plone/app/multilingual/tests/test_menu.py\n@@ -1,5 +1,6 @@\n # -*- coding: utf-8 -*-\n from plone.app.multilingual.interfaces import IPloneAppMultilingualInstalled\n+from plone.app.multilingual.interfaces import ITranslatable\n from plone.app.multilingual.testing import PAM_FUNCTIONAL_TESTING\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n@@ -45,6 +46,7 @@ def test_menu_does_not_contain_translated_entries(self):\n         self.assertNotIn(\'translate_into_ca\', self.browser.contents)\n \n     def test_menu_does_not_appear_without_ITranslatable(self):\n+        self.assertFalse(ITranslatable.providedBy(self.portal))\n         self.browser.open(self.portal.absolute_url() + \'/folder_listing\')\n         self.assertNotIn(\'Translate\', self.browser.contents)\n \ndiff --git a/src/plone/app/multilingual/tests/test_selector.py b/src/plone/app/multilingual/tests/test_selector.py\nindex 12edcb4f..f2b98d54 100644\n--- a/src/plone/app/multilingual/tests/test_selector.py\n+++ b/src/plone/app/multilingual/tests/test_selector.py\n@@ -171,7 +171,7 @@ def assertFullyTranslatedPages(self):\n         self.assertEqual(\n             self.browser.url, a.absolute_url() + \'?set_language=en\'\n         )\n-        self.assertRegexpMatches(self.browser.contents, r"You\\s*are here")\n+        self.assertRegexpMatches(self.browser.contents, r"Distributed under the")\n \n         self.browser.open(selector_viewlet_languages[1][\'url\'])\n         self.assertEqual(\n@@ -311,7 +311,7 @@ def test_languages_partially_translated_by_closest(self):\n         )\n         self.assertIn(\'lang="en"\', self.browser.contents)\n         # But extra check, because English is the default?\n-        self.assertRegexpMatches(self.browser.contents, r"You\\s*are here")\n+        self.assertRegexpMatches(self.browser.contents, r"Distributed under the")\n \n         # Check that CA translation is only partial and a parent folder\n         # is found\n@@ -352,7 +352,7 @@ def test_languages_partially_translated_by_dialog(self):\n         )\n         # But extra check, because English is the default?\n         self.assertIn(\'lang="en"\', self.browser.contents)\n-        self.assertRegexpMatches(self.browser.contents, r"You\\s*are here")\n+        self.assertRegexpMatches(self.browser.contents, r"Distributed under the")\n \n         tgid = selector_languages[1][\'url\'].split(\'/\')[-2]\n \n@@ -399,7 +399,7 @@ def assertSiteRoot(self):\n         )\n         self.browser.open(selector_languages[0][\'url\'])\n         self.assertIn(\'lang="en"\', self.browser.contents)\n-        self.assertRegexpMatches(self.browser.contents, r"You\\s*are here")\n+        self.assertRegexpMatches(self.browser.contents, r"Distributed under the")\n \n         # Check CA root\n         self.assertEqual(\n@@ -508,7 +508,7 @@ def assertRootFolders(self):\n             self.portal[\'en\'].absolute_url() + \'?set_language=en\',\n         )\n         self.assertIn(\'lang="en"\', self.browser.contents)\n-        self.assertRegexpMatches(self.browser.contents, r"You\\s*are here")\n+        self.assertRegexpMatches(self.browser.contents, r"Distributed under the")\n \n         # Check CA\n         self.browser.open(selector_languages[1][\'url\'])\n@@ -572,7 +572,7 @@ def test_languages_preserve_view(self):\n             f_en.absolute_url() + \'/contact-info?set_language=en\',\n         )\n         self.assertIn(\'lang="en"\', self.browser.contents)\n-        self.assertRegexpMatches(self.browser.contents, r"You\\s*are here")\n+        self.assertRegexpMatches(self.browser.contents, r"Distributed under the")\n \n         # Check CA\n         self.browser.open(selector_languages[1][\'url\'])\n@@ -611,7 +611,7 @@ def test_languages_preserve_view(self):\n             f_en.absolute_url() + \'/contact-info?set_language=en\',\n         )\n         self.assertIn(\'lang="en"\', self.browser.contents)\n-        self.assertRegexpMatches(self.browser.contents, r"You\\s*are here")\n+        self.assertRegexpMatches(self.browser.contents, r"Distributed under the")\n \n         # Check CA\n         self.browser.open(selector_languages[1][\'url\'])\n@@ -676,7 +676,7 @@ def assertLanguagesPreserveQuery(self, policy):\n             ),\n         )\n         self.assertIn(\'lang="en"\', self.browser.contents)\n-        self.assertRegexpMatches(self.browser.contents, r"You\\s*are here")\n+        self.assertRegexpMatches(self.browser.contents, r"Distributed under the")\n \n         # Check CA\n         self.browser.open(selector_languages[1][\'url\'])\ndiff --git a/src/plone/app/multilingual/tests/test_setup.py b/src/plone/app/multilingual/tests/test_setup.py\nindex a288059a..c656e44a 100644\n--- a/src/plone/app/multilingual/tests/test_setup.py\n+++ b/src/plone/app/multilingual/tests/test_setup.py\n@@ -1,7 +1,11 @@\n # -*- coding: utf-8 -*-\n+from Acquisition import aq_base\n from plone.app.multilingual.browser.setup import SetupMultilingualSite\n from plone.app.multilingual.browser.vocabularies import AllContentLanguageVocabulary  # noqa: E501\n+from plone.app.multilingual.interfaces import ATTRIBUTE_NAME\n from plone.app.multilingual.interfaces import IPloneAppMultilingualInstalled\n+from plone.app.multilingual.interfaces import ITG\n+from plone.app.multilingual.interfaces import ITranslatable\n from plone.app.multilingual.testing import PAM_INTEGRATION_PRESET_TESTING\n from plone.app.multilingual.testing import PAM_INTEGRATION_TESTING\n from Products.CMFCore.utils import getToolByName\n@@ -27,6 +31,11 @@ def test_single_language(self):\n         """Only one language is set."""\n         self.assertEqual(len(self.languages), 1)\n \n+    def test_portal_has_tg_attribute(self):\n+        """The site root should have the TG attribute set after installing"""\n+        tg_attribute = getattr(aq_base(self.portal), ATTRIBUTE_NAME, None)\n+        self.assertIsNotNone(tg_attribute)\n+\n     def test_no_languagefolder_created(self):\n         """On a single language no folder creation is done."""\n         portal_objects = self.portal.objectIds()\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2021-10-08T08:52:22+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.multilingual/commit/fa51a8c9759cd132f151d5725fccb2b971573b9d

Merge pull request #375 from plone/mamico/safewrite

Disable CSRF protection during the setting of TG attribute.

Files changed:
A news/375.bugfix
M src/plone/app/multilingual/manager.py
M src/plone/app/multilingual/subscriber.py

b"diff --git a/news/375.bugfix b/news/375.bugfix\nnew file mode 100644\nindex 00000000..d770effd\n--- /dev/null\n+++ b/news/375.bugfix\n@@ -0,0 +1 @@\n+Disable CSRF protection during the setting of TG attribute. [mamico]\ndiff --git a/src/plone/app/multilingual/manager.py b/src/plone/app/multilingual/manager.py\nindex 8981e66b..66a13b41 100644\n--- a/src/plone/app/multilingual/manager.py\n+++ b/src/plone/app/multilingual/manager.py\n@@ -12,12 +12,15 @@\n from plone.app.multilingual.interfaces import NOTG\n from plone.app.multilingual.itg import addAttributeTG\n from plone.app.uuid.utils import uuidToObject\n+from plone.protect.interfaces import IDisableCSRFProtection\n from plone.uuid.handlers import addAttributeUUID\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import ILanguage\n+from zope.globalrequest import getRequest\n from zope.component.hooks import getSite\n from zope.event import notify\n+from zope.interface import alsoProvides\n from zope.interface import implementer\n \n \n@@ -43,7 +46,7 @@ def get_id(self, context):\n         # We must ensure that this case can't happen, any object translatable\n         # will have an UUID (in any case we can be at the portal factory!)\n         except KeyError:\n-            context._v_safe_write = True\n+            alsoProvides(getRequest(), IDisableCSRFProtection)\n             addAttributeUUID(context, None)\n             context.reindexObject(idxs=['UID'])\n             context_id = IUUID(context)\n@@ -57,8 +60,9 @@ def get_tg(self, context):\n         try:\n             context_id = ITG(context)\n         # We must ensure that this case can't happen, any object translatable\n-        # will have an UUID (in any case we can be at the portal factory!)\n+        # will have an TG (in any case we can be at the portal factory!)\n         except TypeError:\n+            alsoProvides(getRequest(), IDisableCSRFProtection)\n             addAttributeTG(context, None)\n             context.reindexObject(idxs=['TranslationGroup'])\n             context_id = ITG(context)\ndiff --git a/src/plone/app/multilingual/subscriber.py b/src/plone/app/multilingual/subscriber.py\nindex 6069fb7b..42816ad6 100644\n--- a/src/plone/app/multilingual/subscriber.py\n+++ b/src/plone/app/multilingual/subscriber.py\n@@ -5,9 +5,11 @@\n from plone.app.multilingual.interfaces import ILanguageIndependentFolder\n from plone.app.multilingual.interfaces import IMutableTG\n from plone.app.multilingual.interfaces import IPloneAppMultilingualInstalled\n+from plone.app.multilingual.interfaces import ITG\n from plone.app.multilingual.interfaces import ITranslatable\n from plone.app.multilingual.interfaces import ITranslationManager\n from plone.app.multilingual.interfaces import LANGUAGE_INDEPENDENT\n+from plone.app.multilingual.itg import addAttributeTG\n from plone.dexterity.interfaces import IDexterityContent\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.interfaces import IFolderish\n@@ -116,6 +118,9 @@ def set_recursive_language(ob, language):\n \n     elif ILanguage(ob).get_language() != language:\n         ILanguage(ob).set_language(language)\n+        if ITG(ob, None) is None:\n+            addAttributeTG(ob, None)\n+            ob.reindexObject(idxs=['TranslationGroup'])\n         ITranslationManager(ob).update()\n         reindex_object(ob)\n \n"

