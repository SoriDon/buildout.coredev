Repository: plone.restapi


Branch: refs/heads/master
Date: 2023-04-17T09:05:38-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.restapi/commit/a6934da1aa1e137a790b0dd241b00028b90f174c

Revert "Revert "Add querystring_search get method (#1616)""

This reverts commit 77a53d11348864c239512b8505cea04095d4b429.

Files changed:
A src/plone/restapi/tests/http-examples/querystringsearch_get.req
A src/plone/restapi/tests/http-examples/querystringsearch_get.resp
M docs/source/endpoints/querystringsearch.md
M src/plone/restapi/services/querystringsearch/configure.zcml
M src/plone/restapi/services/querystringsearch/get.py
M src/plone/restapi/tests/test_documentation.py
M src/plone/restapi/tests/test_services_querystringsearch.py

b'diff --git a/docs/source/endpoints/querystringsearch.md b/docs/source/endpoints/querystringsearch.md\nindex 953348f4e..7cc566663 100644\n--- a/docs/source/endpoints/querystringsearch.md\n+++ b/docs/source/endpoints/querystringsearch.md\n@@ -11,7 +11,9 @@ myst:\n \n The `@querystring-search` endpoint returns search results that can be filtered on search criteria.\n \n-Call the `/@querystring-search` endpoint with a `POST` request and a query in the request body:\n+Call the `/@querystring-search` endpoint with either a `POST` or `GET` request.\n+\n+When using the `POST` request, provide a query in the request body:\n \n ```{eval-rst}\n ..  http:example:: curl httpie python-requests\n@@ -24,6 +26,19 @@ The server will respond with the results that are filtered based on the query yo\n :language: http\n ```\n \n+When using the `GET` request, provide the query as a JSON URL-encoded string as a parameter.\n+\n+```{eval-rst}\n+..  http:example:: curl httpie python-requests\n+    :request: ../../../src/plone/restapi/tests/http-examples/querystringsearch_get.req\n+```\n+\n+The server will respond with the results that are filtered based on the query you provided:\n+\n+```{literalinclude} ../../../src/plone/restapi/tests/http-examples/querystringsearch_get.resp\n+:language: http\n+```\n+\n Parameters the endpoint will accept:\n \n - `query` - `plone.app.querystring` query, required\n@@ -34,10 +49,8 @@ Parameters the endpoint will accept:\n - `limit` - integer, limits the number of returned results\n - `fullobjects` - boolean, if `true` then return the full objects instead of just the summary serialization\n \n-\n ## Parameters\n \n-\n ### Batch Start (`b_start`)\n \n The `b_start` parameter defines the first item of the batch:\n@@ -58,7 +71,6 @@ The `b_start` parameter defines the first item of the batch:\n The `b_size` parameter is optional.\n The default value is `0`.\n \n-\n ### Batch Size (b_size)\n \n The `b_size` parameter defines the number of elements a single batch returns:\n@@ -79,7 +91,6 @@ The `b_size` parameter defines the number of elements a single batch returns:\n The parameter is optional.\n The default value is `25`.\n \n-\n ### Sort on\n \n The `sort_on` parameter defines the field that is used to sort the returned search results:\n@@ -100,7 +111,6 @@ The `sort_on` parameter defines the field that is used to sort the returned sear\n The `sort_on` parameter is optional.\n The default value is `None`.\n \n-\n ### Sort Order\n \n The `sort_order` parameter defines the sort order when the `sort_on` field has been set:\n@@ -126,7 +136,6 @@ The sort_order can be either `ascending` or `descending`.\n `ascending` means from A to Z for a text field.\n `reverse` is an alias equivalent to `descending`.\n \n-\n ### Limit\n \n Querystring `query` with a `limit` parameter:\n@@ -147,7 +156,6 @@ Querystring `query` with a `limit` parameter:\n The `limit` parameter is optional.\n The default value is `1000`.\n \n-\n ### Query\n \n The `query` parameter is a list that contains an arbitrary number of `filters`:\n@@ -176,10 +184,8 @@ The following types of filters are available:\n - Date filters\n - Text Filters\n \n-\n #### Metadata Filters\n \n-\n ##### Creator\n \n The `creator` of the content object.\n@@ -212,7 +218,6 @@ You can either set the currently logged in user:\n }\n ```\n \n-\n ##### Shortname\n \n `Shortname` is the ID of the object that is shown as the last part of the URL:\n@@ -229,7 +234,6 @@ You can either set the currently logged in user:\n }\n ```\n \n-\n ##### Location\n \n `Location` is the path of the content object on the site.\n@@ -305,7 +309,6 @@ The path can contain a depth parameter that is separated with `::`:\n }\n ```\n \n-\n ##### Type\n \n Filter by portal type:\n@@ -322,7 +325,6 @@ Filter by portal type:\n }\n ```\n \n-\n ##### Review State\n \n Filter results by review state:\n@@ -339,7 +341,6 @@ Filter results by review state:\n }\n ```\n \n-\n ##### Show Inactive\n \n Show inactive will return content objects that is expired for a given role:\n@@ -356,10 +357,8 @@ Show inactive will return content objects that is expired for a given role:\n }\n ```\n \n-\n #### Text Filters\n \n-\n ##### Description\n \n Filter content that contains a term in the Description field:\n@@ -376,7 +375,6 @@ Filter content that contains a term in the Description field:\n }\n ```\n \n-\n ##### Searchable Text\n \n Filter content that contains a term in the SearchableText (all searchable fields in the catalog):\n@@ -393,7 +391,6 @@ Filter content that contains a term in the SearchableText (all searchable fields\n }\n ```\n \n-\n ##### Tag\n \n Filter by a tag (subjects field):\n@@ -410,7 +407,6 @@ Filter by a tag (subjects field):\n }\n ```\n \n-\n ##### Title\n \n Filter by exact Title match:\n@@ -425,10 +421,8 @@ Filter by exact Title match:\n ]\n ```\n \n-\n #### Date Filters\n \n-\n ##### Creation Date\n \n Filter by creation date:\n@@ -445,7 +439,6 @@ Filter by creation date:\n }\n ```\n \n-\n ##### Effective Date\n \n Filter by effective date:\n@@ -463,7 +456,6 @@ Filter by effective date:\n }\n ```\n \n-\n ##### Event end date\n \n Filter by event end date:\n@@ -480,7 +472,6 @@ Filter by event end date:\n }\n ```\n \n-\n ##### Event start date\n \n Filter by event start date:\n@@ -497,7 +488,6 @@ Filter by event start date:\n }\n ```\n \n-\n ##### Expiration date\n \n Filter by expiration date:\n@@ -515,7 +505,6 @@ Filter by expiration date:\n }\n ```\n \n-\n ##### Modification date\n \n Filter by modification date:\ndiff --git a/src/plone/restapi/services/querystringsearch/configure.zcml b/src/plone/restapi/services/querystringsearch/configure.zcml\nindex 9a7ad2059..899f1f115 100644\n--- a/src/plone/restapi/services/querystringsearch/configure.zcml\n+++ b/src/plone/restapi/services/querystringsearch/configure.zcml\n@@ -18,4 +18,20 @@\n       permission="zope2.View"\n       name="@querystring-search"\n       />\n+\n+  <plone:service\n+      method="GET"\n+      factory=".get.QuerystringSearchGet"\n+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      permission="zope2.View"\n+      name="@querystring-search"\n+      />\n+\n+  <plone:service\n+      method="GET"\n+      factory=".get.QuerystringSearchGet"\n+      for="Products.CMFCore.interfaces.IContentish"\n+      permission="zope2.View"\n+      name="@querystring-search"\n+      />\n </configure>\ndiff --git a/src/plone/restapi/services/querystringsearch/get.py b/src/plone/restapi/services/querystringsearch/get.py\nindex 29ed3f947..79de69acc 100644\n--- a/src/plone/restapi/services/querystringsearch/get.py\n+++ b/src/plone/restapi/services/querystringsearch/get.py\n@@ -4,8 +4,11 @@\n from plone.restapi.deserializer import json_body\n from plone.restapi.interfaces import ISerializeToJson\n from plone.restapi.services import Service\n+from urllib import parse\n from zope.component import getMultiAdapter\n \n+import json\n+\n \n zcatalog_version = get_distribution("Products.ZCatalog").version\n if parse_version(zcatalog_version) >= parse_version("5.1"):\n@@ -14,11 +17,14 @@\n     SUPPORT_NOT_UUID_QUERIES = False\n \n \n-class QuerystringSearchPost(Service):\n+class QuerystringSearch:\n     """Returns the querystring search results given a p.a.querystring data."""\n \n-    def reply(self):\n-        data = json_body(self.request)\n+    def __init__(self, context, request):\n+        self.context = context\n+        self.request = request\n+\n+    def __call__(self, data):\n         query = data.get("query", None)\n         b_start = int(data.get("b_start", 0))\n         b_size = int(data.get("b_size", 25))\n@@ -60,3 +66,21 @@ def reply(self):\n             fullobjects=fullobjects\n         )\n         return results\n+\n+\n+class QuerystringSearchPost(Service):\n+    """Returns the querystring search results given a p.a.querystring data."""\n+\n+    def reply(self):\n+        querystring_search = QuerystringSearch(self.context, self.request)\n+        return querystring_search(data=json_body(self.request))\n+\n+\n+class QuerystringSearchGet(Service):\n+    """Returns the querystring search results given a p.a.querystring data."""\n+\n+    def reply(self):\n+        querystring_search = QuerystringSearch(self.context, self.request)\n+        return querystring_search(\n+            data=json.loads(parse.unquote(self.request.form.get("query", "{}")))\n+        )\ndiff --git a/src/plone/restapi/tests/http-examples/querystringsearch_get.req b/src/plone/restapi/tests/http-examples/querystringsearch_get.req\nnew file mode 100644\nindex 000000000..0f859a5cc\n--- /dev/null\n+++ b/src/plone/restapi/tests/http-examples/querystringsearch_get.req\n@@ -0,0 +1,3 @@\n+GET /plone/@querystring-search?query=%257B%2522query%2522%253A%255B%257B%2522i%2522%253A%2522portal_type%2522%252C%2522o%2522%253A%2520%2522plone.app.querystring.operation.selection.any%2522%252C%2522v%2522%253A%255B%2522Document%2522%255D%257D%255D%257D HTTP/1.1\n+Accept: application/json\n+Authorization: Basic YWRtaW46c2VjcmV0\ndiff --git a/src/plone/restapi/tests/http-examples/querystringsearch_get.resp b/src/plone/restapi/tests/http-examples/querystringsearch_get.resp\nnew file mode 100644\nindex 000000000..780f8f4ee\n--- /dev/null\n+++ b/src/plone/restapi/tests/http-examples/querystringsearch_get.resp\n@@ -0,0 +1,23 @@\n+HTTP/1.1 200 OK\n+Content-Type: application/json\n+\n+{\n+    "@id": "http://localhost:55001/plone/@querystring-search?query=%257B%2522query%2522%253A%255B%257B%2522i%2522%253A%2522portal_type%2522%252C%2522o%2522%253A%2520%2522plone.app.querystring.operation.selection.any%2522%252C%2522v%2522%253A%255B%2522Document%2522%255D%257D%255D%257D",\n+    "items": [\n+        {\n+            "@id": "http://localhost:55001/plone/front-page",\n+            "@type": "Document",\n+            "description": "Congratulations! You have successfully installed Plone.",\n+            "review_state": "private",\n+            "title": "Welcome to Plone"\n+        },\n+        {\n+            "@id": "http://localhost:55001/plone/testdocument",\n+            "@type": "Document",\n+            "description": "",\n+            "review_state": "private",\n+            "title": "Test Document"\n+        }\n+    ],\n+    "items_total": 2\n+}\ndiff --git a/src/plone/restapi/tests/test_documentation.py b/src/plone/restapi/tests/test_documentation.py\nindex 6e8b88ded..2103b1e2e 100644\n--- a/src/plone/restapi/tests/test_documentation.py\n+++ b/src/plone/restapi/tests/test_documentation.py\n@@ -1686,6 +1686,18 @@ def test_querystringsearch_post(self):\n         )\n         save_request_and_response_for_docs("querystringsearch_post", response)\n \n+    def test_querystringsearch_get(self):\n+        query = {\n+            "query": "%7B%22query%22%3A%5B%7B%22i%22%3A%22portal_type%22%2C%22o%22%3A%20%22plone.app.querystring.operation.selection.any%22%2C%22v%22%3A%5B%22Document%22%5D%7D%5D%7D"\n+        }\n+        url = "/@querystring-search"\n+\n+        self.portal.invokeFactory("Document", "testdocument", title="Test Document")\n+        transaction.commit()\n+\n+        response = self.api_session.get(url, params=query)\n+        save_request_and_response_for_docs("querystringsearch_get", response)\n+\n     def test_system_get(self):\n         response = self.api_session.get("/@system")\n         save_request_for_docs("system_get", response)\ndiff --git a/src/plone/restapi/tests/test_services_querystringsearch.py b/src/plone/restapi/tests/test_services_querystringsearch.py\nindex 8dd77f7dc..69f777a3b 100644\n--- a/src/plone/restapi/tests/test_services_querystringsearch.py\n+++ b/src/plone/restapi/tests/test_services_querystringsearch.py\n@@ -52,6 +52,18 @@ def test_querystringsearch_basic(self):\n         self.assertEqual(len(response.json()["items"]), 1)\n         self.assertNotIn("effective", response.json()["items"][0])\n \n+    def test_querystringsearch_basic_get(self):\n+        response = self.api_session.get(\n+            "/@querystring-search?query=%7B%22query%22%3A%5B%7B%22i%22%3A%22portal_type%22%2C%22o%22%3A%20%22plone.app.querystring.operation.selection.any%22%2C%22v%22%3A%5B%22Document%22%5D%7D%5D%7D"\n+        )\n+\n+        self.assertEqual(response.status_code, 200)\n+        self.assertIn("items", response.json())\n+        self.assertIn("items_total", response.json())\n+        self.assertEqual(response.json()["items_total"], 1)\n+        self.assertEqual(len(response.json()["items"]), 1)\n+        self.assertNotIn("effective", response.json()["items"][0])\n+\n     def test_querystringsearch_fullobjects(self):\n         response = self.api_session.post(\n             "/@querystring-search",\n'

