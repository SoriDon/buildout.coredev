Repository: plone.app.layout


Branch: refs/heads/master
Date: 2019-08-09T18:13:08+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/4542082ffff7c43eb509f9c7eafe4a1db6d564b0

Refs #204 - Optimize @@historyview workflowHistory user info

Files changed:
M plone/app/layout/viewlets/content.py

b'diff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 9651ab2d..e5e23f7d 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -320,6 +320,20 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     index = ViewPageTemplateFile("review_history.pt")\n \n+    @memoize\n+    def getUserInfo(self, userid):\n+        mt = getToolByName(self.context, \'portal_membership\')\n+        info = mt.getMemberInfo(userid)\n+        if info is None:\n+            return dict(actor_home="",\n+                        actor=dict(fullname=userid))\n+\n+        if not info.get("fullname", None):\n+            info["fullname"] = userid\n+\n+        return dict(actor=info,\n+                    actor_home="%s/author/%s" % (self.site_url, userid))\n+\n     def workflowHistory(self, complete=True):\n         """Return workflow history of this context.\n \n@@ -332,8 +346,6 @@ def workflowHistory(self, complete=True):\n             return []\n \n         workflow = getToolByName(context, \'portal_workflow\')\n-        membership = getToolByName(context, \'portal_membership\')\n-\n         review_history = []\n \n         try:\n@@ -362,14 +374,7 @@ def workflowHistory(self, complete=True):\n                     r[\'actor\'] = {\'username\': anon, \'fullname\': anon}\n                     r[\'actor_home\'] = \'\'\n                 else:\n-                    r[\'actor\'] = membership.getMemberInfo(actorid)\n-                    if r[\'actor\'] is not None:\n-                        r[\'actor_home\'] = self.navigation_root_url + \\\n-                            \'/author/\' + actorid\n-                    else:\n-                        # member info is not available\n-                        # the user was probably deleted\n-                        r[\'actor_home\'] = \'\'\n+                    r.update(self.getUserInfo(actorid))\n             review_history.reverse()\n \n         except WorkflowException:\n@@ -384,20 +389,6 @@ class ContentHistoryViewlet(WorkflowHistoryViewlet):\n \n     index = ViewPageTemplateFile("content_history.pt")\n \n-    @memoize\n-    def getUserInfo(self, userid):\n-        mt = getToolByName(self.context, \'portal_membership\')\n-        info = mt.getMemberInfo(userid)\n-        if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n-\n-        if not info.get("fullname", None):\n-            info["fullname"] = userid\n-\n-        return dict(actor=info,\n-                    actor_home="%s/author/%s" % (self.site_url, userid))\n-\n     def revisionHistory(self):\n         context = aq_inner(self.context)\n         if not _checkPermission(AccessPreviousVersions, context):\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2019-08-09T18:13:59+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/a8d16699ea3616f0f8f90a13c6fafb691f88b869

Fixes #204 - Fix memory leak on getUserInfo

Files changed:
M plone/app/layout/viewlets/content.py

b'diff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex e5e23f7d..17196a8c 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -322,16 +322,17 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     @memoize\n     def getUserInfo(self, userid):\n+        actor = dict(fullname=userid)\n         mt = getToolByName(self.context, \'portal_membership\')\n         info = mt.getMemberInfo(userid)\n         if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n+            return dict(actor_home="", actor=actor)\n \n-        if not info.get("fullname", None):\n-            info["fullname"] = userid\n+        fullname = info.get("fullname", None)\n+        if fullname:\n+            actor[\'fullname\'] = fullname\n \n-        return dict(actor=info,\n+        return dict(actor=actor,\n                     actor_home="%s/author/%s" % (self.site_url, userid))\n \n     def workflowHistory(self, complete=True):\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2019-08-09T18:32:12+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/05028ac8c1b0d01290078f023c6d5539933ea82b

Refs #204 - Update Changelog

Files changed:
M CHANGES.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 14fcb101..4f193f29 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -8,6 +8,13 @@ Changelog\n \n .. towncrier release notes start\n \n+3.2.2 (unreleased)\n+------------------\n+\n+Bug fixes:\n+\n+- Memory leak on getUserInfo [avoinea] (#204)\n+\n 3.2.1 (2019-07-06)\n ------------------\n \n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2019-08-14T10:53:52+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/a0715ca050de155f88d7e8d321d10f77fcff7517

Merge pull request #211 from avoinea/master

 Fixes #204 - Fix memory leak on getUserInfo

Files changed:
M CHANGES.rst
M plone/app/layout/viewlets/content.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 14fcb101..4f193f29 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -8,6 +8,13 @@ Changelog\n \n .. towncrier release notes start\n \n+3.2.2 (unreleased)\n+------------------\n+\n+Bug fixes:\n+\n+- Memory leak on getUserInfo [avoinea] (#204)\n+\n 3.2.1 (2019-07-06)\n ------------------\n \ndiff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 9651ab2d..17196a8c 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -320,6 +320,21 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     index = ViewPageTemplateFile("review_history.pt")\n \n+    @memoize\n+    def getUserInfo(self, userid):\n+        actor = dict(fullname=userid)\n+        mt = getToolByName(self.context, \'portal_membership\')\n+        info = mt.getMemberInfo(userid)\n+        if info is None:\n+            return dict(actor_home="", actor=actor)\n+\n+        fullname = info.get("fullname", None)\n+        if fullname:\n+            actor[\'fullname\'] = fullname\n+\n+        return dict(actor=actor,\n+                    actor_home="%s/author/%s" % (self.site_url, userid))\n+\n     def workflowHistory(self, complete=True):\n         """Return workflow history of this context.\n \n@@ -332,8 +347,6 @@ def workflowHistory(self, complete=True):\n             return []\n \n         workflow = getToolByName(context, \'portal_workflow\')\n-        membership = getToolByName(context, \'portal_membership\')\n-\n         review_history = []\n \n         try:\n@@ -362,14 +375,7 @@ def workflowHistory(self, complete=True):\n                     r[\'actor\'] = {\'username\': anon, \'fullname\': anon}\n                     r[\'actor_home\'] = \'\'\n                 else:\n-                    r[\'actor\'] = membership.getMemberInfo(actorid)\n-                    if r[\'actor\'] is not None:\n-                        r[\'actor_home\'] = self.navigation_root_url + \\\n-                            \'/author/\' + actorid\n-                    else:\n-                        # member info is not available\n-                        # the user was probably deleted\n-                        r[\'actor_home\'] = \'\'\n+                    r.update(self.getUserInfo(actorid))\n             review_history.reverse()\n \n         except WorkflowException:\n@@ -384,20 +390,6 @@ class ContentHistoryViewlet(WorkflowHistoryViewlet):\n \n     index = ViewPageTemplateFile("content_history.pt")\n \n-    @memoize\n-    def getUserInfo(self, userid):\n-        mt = getToolByName(self.context, \'portal_membership\')\n-        info = mt.getMemberInfo(userid)\n-        if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n-\n-        if not info.get("fullname", None):\n-            info["fullname"] = userid\n-\n-        return dict(actor=info,\n-                    actor_home="%s/author/%s" % (self.site_url, userid))\n-\n     def revisionHistory(self):\n         context = aq_inner(self.context)\n         if not _checkPermission(AccessPreviousVersions, context):\n'

