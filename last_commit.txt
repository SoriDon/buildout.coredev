Repository: mockup


Branch: refs/heads/master
Date: 2016-02-10T18:12:18+13:00
Author: Tommy Yu (metatoaster) <tommy.yu@auckland.ac.nz>
Commit: https://github.com/plone/mockup/commit/37ef70a53f9583f3602c015a9d537883861474d3

Demonstrate XSS vulnerability in selection well.

Files changed:
M mockup/tests/pattern-structure-test.js

diff --git a/mockup/tests/pattern-structure-test.js b/mockup/tests/pattern-structure-test.js
index 125bb96..f5eb5e3 100644
--- a/mockup/tests/pattern-structure-test.js
+++ b/mockup/tests/pattern-structure-test.js
@@ -25,6 +25,8 @@ define([
     return null;
   }
 
+  var extraDataJsonItem = null;
+
 
   /* ==========================
    TEST: Structure
@@ -83,6 +85,10 @@ define([
           });
         }
 
+        if (extraDataJsonItem) {
+          items.push(extraDataJsonItem);
+        }
+
         xhr.respond(200, { 'Content-Type': 'application/json' }, JSON.stringify({
           total: 100,
           results: items
@@ -132,6 +138,7 @@ define([
     });
 
     afterEach(function() {
+      extraDataJsonItem = null;
       this.server.restore();
       this.clock.restore();
     });
@@ -149,6 +156,39 @@ define([
       cb.trigger('change');
       this.clock.tick(500);
       expect(this.$el.find('#btn-selected-items').html()).to.contain('1');
+      var selectedItems = $('.popover-content .selected-item', this.$el);
+      expect($(selectedItems[0]).text()).to.contain('Folder');
+    });
+
+    it('test selection well label', function() {
+      extraDataJsonItem = {
+        UID: 'XSS" data-xss="bobby',
+        getURL: 'http://localhost:8081/xss',
+        path: '/xss',
+        portal_type: 'Folder',
+        Description: 'XSS test item',
+        Title: "<script>alert('XSS');window.foo=1;</script>",
+        'review_state': 'published',
+        'is_folderish': true,
+        Subject: [],
+        id: 'xss'
+      };
+      registry.scan(this.$el);
+      this.clock.tick(500);
+      // it's overloaded, pattern doesn't actually enforce batch limits.
+      var cb = this.$el.find('.itemRow td.selection input').eq(16);
+      cb[0].checked = true;
+      cb.trigger('change');
+      this.clock.tick(500);
+      expect(this.$el.find('#btn-selected-items').html()).to.contain('1');
+
+      // XSS happened.
+      expect(window.foo).not.equal(1);
+      expect($('.popover-content .selected-item a', this.$el).eq(0).data().xss
+        ).not.equal('bobby');
+      var selectedItems = $('.popover-content .selected-item', this.$el);
+      expect($(selectedItems[0]).text()).to.contain(
+        "<script>alert('XSS');window.foo=1;</script>");
     });
 
     it('remove item from selection well', function() {


Repository: mockup


Branch: refs/heads/master
Date: 2016-02-10T18:23:55+13:00
Author: Tommy Yu (metatoaster) <tommy.yu@auckland.ac.nz>
Commit: https://github.com/plone/mockup/commit/285bdf91a73cf55dab45a82a1bfc02aa0f332e98

Use sanitized print for templates.

Files changed:
M mockup/patterns/structure/templates/paging.xml
M mockup/patterns/structure/templates/selection_button.xml
M mockup/patterns/structure/templates/selection_item.xml
M mockup/patterns/structure/templates/table.xml

diff --git a/mockup/patterns/structure/templates/paging.xml b/mockup/patterns/structure/templates/paging.xml
index cc25272..1db4562 100644
--- a/mockup/patterns/structure/templates/paging.xml
+++ b/mockup/patterns/structure/templates/paging.xml
@@ -11,7 +11,7 @@
     </li>
     <% _.each(pages, function(p){ %>
     <li class="<% if (currentPage == p) { %>active<% } %>">
-      <a href="#" class="page"><%= p %></a>
+      <a href="#" class="page"><%- p %></a>
     </li>
     <% }); %>
     <li class="<% if (currentPage === lastPage) { %>disabled<% } %>">
@@ -42,9 +42,9 @@
   <ul class="pagination pagination-sm">
     <li class="disabled">
       <a href="#">
-        <%- _t("Page:") %> <span class="current"><%= currentPage %></span>
+        <%- _t("Page:") %> <span class="current"><%- currentPage %></span>
         <%- _t("of") %>
-        <span class="total"><%= totalPages %></span>
+        <span class="total"><%- totalPages %></span>
               <%- _t("shown") %>
       </a>
     </li>
diff --git a/mockup/patterns/structure/templates/selection_button.xml b/mockup/patterns/structure/templates/selection_button.xml
index 2f92b97..4548a95 100644
--- a/mockup/patterns/structure/templates/selection_button.xml
+++ b/mockup/patterns/structure/templates/selection_button.xml
@@ -1 +1,5 @@
-<span class="glyphicon glyphicon-list"></span><%= title %> <span class="label<% if (length > 0) { %> label-success<% } else { %> label-default<% } %>">  <%= length %></span>
\ No newline at end of file
+<span class="glyphicon glyphicon-list"></span>
+  <%- title %>
+<span class="label<% if (length > 0) { %> label-success<% } else { %> label-default<% } %>">
+  <%- length %>
+</span>
diff --git a/mockup/patterns/structure/templates/selection_item.xml b/mockup/patterns/structure/templates/selection_item.xml
index cb456d5..25c5d89 100644
--- a/mockup/patterns/structure/templates/selection_item.xml
+++ b/mockup/patterns/structure/templates/selection_item.xml
@@ -1 +1,6 @@
-<span class="selected-item">  <a href="#" data-uid="<%= UID %>" title="remove" class="remove">    <span class="glyphicon glyphicon-remove-circle"></span>  </a>  <%= Title %></span>
\ No newline at end of file
+<span class="selected-item">
+  <a href="#" data-uid="<%- UID %>" title="remove" class="remove">
+    <span class="glyphicon glyphicon-remove-circle"></span>
+  </a>
+  <%- Title %>
+</span>
diff --git a/mockup/patterns/structure/templates/table.xml b/mockup/patterns/structure/templates/table.xml
index 04de3a9..5b5f4c3 100644
--- a/mockup/patterns/structure/templates/table.xml
+++ b/mockup/patterns/structure/templates/table.xml
@@ -1,10 +1,10 @@
-<div class="alert alert-<%= statusType %> status">
-    <%= status %>
+<div class="alert alert-<%- statusType %> status">
+    <%- status %>
 </div>
 <table class="table table-striped table-bordered">
   <thead>
     <tr class="fc-breadcrumbs-container">
-      <td colspan="<%= activeColumns.length + 3 %>">
+      <td colspan="<%- activeColumns.length + 3 %>">
         <% if(pathParts.length > 0) { %>
           <div class="input-group context-buttons" style="display:none">
             <span class="input-group-addon">


Repository: mockup


Branch: refs/heads/master
Date: 2016-02-10T20:41:58-06:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/mockup/commit/c3e469de3408924e63db9fc3b0f78f4d3ede80a9

Merge pull request #627 from plone/structure-selectionwell-xss-fix

Structure selection well XSS fix

Files changed:
M mockup/patterns/structure/templates/paging.xml
M mockup/patterns/structure/templates/selection_button.xml
M mockup/patterns/structure/templates/selection_item.xml
M mockup/patterns/structure/templates/table.xml
M mockup/tests/pattern-structure-test.js

diff --git a/mockup/patterns/structure/templates/paging.xml b/mockup/patterns/structure/templates/paging.xml
index cc25272..1db4562 100644
--- a/mockup/patterns/structure/templates/paging.xml
+++ b/mockup/patterns/structure/templates/paging.xml
@@ -11,7 +11,7 @@
     </li>
     <% _.each(pages, function(p){ %>
     <li class="<% if (currentPage == p) { %>active<% } %>">
-      <a href="#" class="page"><%= p %></a>
+      <a href="#" class="page"><%- p %></a>
     </li>
     <% }); %>
     <li class="<% if (currentPage === lastPage) { %>disabled<% } %>">
@@ -42,9 +42,9 @@
   <ul class="pagination pagination-sm">
     <li class="disabled">
       <a href="#">
-        <%- _t("Page:") %> <span class="current"><%= currentPage %></span>
+        <%- _t("Page:") %> <span class="current"><%- currentPage %></span>
         <%- _t("of") %>
-        <span class="total"><%= totalPages %></span>
+        <span class="total"><%- totalPages %></span>
               <%- _t("shown") %>
       </a>
     </li>
diff --git a/mockup/patterns/structure/templates/selection_button.xml b/mockup/patterns/structure/templates/selection_button.xml
index 2f92b97..4548a95 100644
--- a/mockup/patterns/structure/templates/selection_button.xml
+++ b/mockup/patterns/structure/templates/selection_button.xml
@@ -1 +1,5 @@
-<span class="glyphicon glyphicon-list"></span><%= title %> <span class="label<% if (length > 0) { %> label-success<% } else { %> label-default<% } %>">  <%= length %></span>
\ No newline at end of file
+<span class="glyphicon glyphicon-list"></span>
+  <%- title %>
+<span class="label<% if (length > 0) { %> label-success<% } else { %> label-default<% } %>">
+  <%- length %>
+</span>
diff --git a/mockup/patterns/structure/templates/selection_item.xml b/mockup/patterns/structure/templates/selection_item.xml
index cb456d5..25c5d89 100644
--- a/mockup/patterns/structure/templates/selection_item.xml
+++ b/mockup/patterns/structure/templates/selection_item.xml
@@ -1 +1,6 @@
-<span class="selected-item">  <a href="#" data-uid="<%= UID %>" title="remove" class="remove">    <span class="glyphicon glyphicon-remove-circle"></span>  </a>  <%= Title %></span>
\ No newline at end of file
+<span class="selected-item">
+  <a href="#" data-uid="<%- UID %>" title="remove" class="remove">
+    <span class="glyphicon glyphicon-remove-circle"></span>
+  </a>
+  <%- Title %>
+</span>
diff --git a/mockup/patterns/structure/templates/table.xml b/mockup/patterns/structure/templates/table.xml
index 04de3a9..5b5f4c3 100644
--- a/mockup/patterns/structure/templates/table.xml
+++ b/mockup/patterns/structure/templates/table.xml
@@ -1,10 +1,10 @@
-<div class="alert alert-<%= statusType %> status">
-    <%= status %>
+<div class="alert alert-<%- statusType %> status">
+    <%- status %>
 </div>
 <table class="table table-striped table-bordered">
   <thead>
     <tr class="fc-breadcrumbs-container">
-      <td colspan="<%= activeColumns.length + 3 %>">
+      <td colspan="<%- activeColumns.length + 3 %>">
         <% if(pathParts.length > 0) { %>
           <div class="input-group context-buttons" style="display:none">
             <span class="input-group-addon">
diff --git a/mockup/tests/pattern-structure-test.js b/mockup/tests/pattern-structure-test.js
index 125bb96..f5eb5e3 100644
--- a/mockup/tests/pattern-structure-test.js
+++ b/mockup/tests/pattern-structure-test.js
@@ -25,6 +25,8 @@ define([
     return null;
   }
 
+  var extraDataJsonItem = null;
+
 
   /* ==========================
    TEST: Structure
@@ -83,6 +85,10 @@ define([
           });
         }
 
+        if (extraDataJsonItem) {
+          items.push(extraDataJsonItem);
+        }
+
         xhr.respond(200, { 'Content-Type': 'application/json' }, JSON.stringify({
           total: 100,
           results: items
@@ -132,6 +138,7 @@ define([
     });
 
     afterEach(function() {
+      extraDataJsonItem = null;
       this.server.restore();
       this.clock.restore();
     });
@@ -149,6 +156,39 @@ define([
       cb.trigger('change');
       this.clock.tick(500);
       expect(this.$el.find('#btn-selected-items').html()).to.contain('1');
+      var selectedItems = $('.popover-content .selected-item', this.$el);
+      expect($(selectedItems[0]).text()).to.contain('Folder');
+    });
+
+    it('test selection well label', function() {
+      extraDataJsonItem = {
+        UID: 'XSS" data-xss="bobby',
+        getURL: 'http://localhost:8081/xss',
+        path: '/xss',
+        portal_type: 'Folder',
+        Description: 'XSS test item',
+        Title: "<script>alert('XSS');window.foo=1;</script>",
+        'review_state': 'published',
+        'is_folderish': true,
+        Subject: [],
+        id: 'xss'
+      };
+      registry.scan(this.$el);
+      this.clock.tick(500);
+      // it's overloaded, pattern doesn't actually enforce batch limits.
+      var cb = this.$el.find('.itemRow td.selection input').eq(16);
+      cb[0].checked = true;
+      cb.trigger('change');
+      this.clock.tick(500);
+      expect(this.$el.find('#btn-selected-items').html()).to.contain('1');
+
+      // XSS happened.
+      expect(window.foo).not.equal(1);
+      expect($('.popover-content .selected-item a', this.$el).eq(0).data().xss
+        ).not.equal('bobby');
+      var selectedItems = $('.popover-content .selected-item', this.$el);
+      expect($(selectedItems[0]).text()).to.contain(
+        "<script>alert('XSS');window.foo=1;</script>");
     });
 
     it('remove item from selection well', function() {


