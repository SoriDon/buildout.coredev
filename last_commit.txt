Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2016-09-07T01:19:47+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/4f6f926f0a4b63f4b4563e90348e60428c7716ed

No longer register the archetypes skin.

Products.Archetypes does that itself.

Files changed:
M CHANGES.rst
M Products/ATContentTypes/profiles/base/skins.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index 9fe4348..0ca60d1 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -24,6 +24,8 @@ New features:
 
 - Make tests work with old and new safe HTML cleaner (PLIP 1441)
   [tomgross]
+- No longer register the archetypes skin, because Products.Archetypes
+  does that itself.  [maurits]
 
 Bug fixes:
 
diff --git a/Products/ATContentTypes/profiles/base/skins.xml b/Products/ATContentTypes/profiles/base/skins.xml
index 4e2ae22..f7cd890 100644
--- a/Products/ATContentTypes/profiles/base/skins.xml
+++ b/Products/ATContentTypes/profiles/base/skins.xml
@@ -2,10 +2,7 @@
 <object name="portal_skins" meta_type="Plone Skins Tool">
  <object name="ATContentTypes" meta_type="Filesystem Directory View"
     directory="Products.ATContentTypes:skins/ATContentTypes"/>
- <object name="archetypes" meta_type="Filesystem Directory View"
-    directory="Products.Archetypes:skins/archetypes"/>
  <skin-path name="*">
   <layer name="ATContentTypes" insert-after="custom"/>
-  <layer name="archetypes" insert-after="custom"/>
  </skin-path>
 </object>


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2016-09-07T01:19:47+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/f31dee9fe5e37fcb1eb6c98e21eb9d3ac0a50865

Added uninstall profile.

This only removes the stuff from the base profile, not the others.

Note that rolemap.xml does not support the 'remove' keyword for permissions,
so we keep them.

Note that this needs several fixes in GenericSetup and CMFPlone, but
they have been merged.

Files changed:
A Products/ATContentTypes/profiles/uninstall/componentregistry.xml
A Products/ATContentTypes/profiles/uninstall/controlpanel.xml
A Products/ATContentTypes/profiles/uninstall/diff_tool.xml
A Products/ATContentTypes/profiles/uninstall/skins.xml
A Products/ATContentTypes/profiles/uninstall/toolset.xml
A Products/ATContentTypes/profiles/uninstall/types.xml
M CHANGES.rst
M Products/ATContentTypes/configure.zcml
M Products/ATContentTypes/setuphandlers.py
M Products/ATContentTypes/tests/test_base_profile.py
M Products/ATContentTypes/tests/test_installation.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0ca60d1..413451d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -24,6 +24,10 @@ New features:
 
 - Make tests work with old and new safe HTML cleaner (PLIP 1441)
   [tomgross]
+- Added uninstall profile.  This profile belongs to the 'base'
+  profile, which is the one that gets applied when you install
+  ATContentTypes.  [maurits]
+
 - No longer register the archetypes skin, because Products.Archetypes
   does that itself.  [maurits]
 
diff --git a/Products/ATContentTypes/configure.zcml b/Products/ATContentTypes/configure.zcml
index 209eeac..aa83e49 100644
--- a/Products/ATContentTypes/configure.zcml
+++ b/Products/ATContentTypes/configure.zcml
@@ -68,6 +68,15 @@
       provides="Products.GenericSetup.interfaces.EXTENSION"
       />
 
+  <genericsetup:registerProfile
+      name="uninstall"
+      title="Uninstall Archetypes Content Types for Plone"
+      directory="profiles/uninstall"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler="Products.ATContentTypes.setuphandlers.cleanup_after_uninstall"
+      />
+
   <genericsetup:importStep
       name="atct_content"
       title="ATContentTypes default content"
diff --git a/Products/ATContentTypes/profiles/uninstall/componentregistry.xml b/Products/ATContentTypes/profiles/uninstall/componentregistry.xml
new file mode 100644
index 0000000..e43f3ab
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/componentregistry.xml
@@ -0,0 +1,9 @@
+<?xml version="1.0"?>
+<componentregistry>
+  <utilities>
+    <utility
+        remove="true"
+        interface="Products.ATContentTypes.interface.IATCTTool"
+        object="portal_atct"/>
+  </utilities>
+</componentregistry>
diff --git a/Products/ATContentTypes/profiles/uninstall/controlpanel.xml b/Products/ATContentTypes/profiles/uninstall/controlpanel.xml
new file mode 100644
index 0000000..e1dfa7c
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/controlpanel.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<object name="portal_controlpanel">
+ <configlet action_id="portal_atct" remove="true" />
+</object>
diff --git a/Products/ATContentTypes/profiles/uninstall/diff_tool.xml b/Products/ATContentTypes/profiles/uninstall/diff_tool.xml
new file mode 100644
index 0000000..e29dfdc
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/diff_tool.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0"?>
+<object>
+ <difftypes>
+  <type portal_type="Document" remove="true" />
+  <type portal_type="Event" remove="true" />
+  <type portal_type="File" remove="true"/>
+  <type portal_type="Folder" remove="true" />
+  <type portal_type="Image" remove="true" />
+  <type portal_type="Link" remove="true" />
+  <type portal_type="News Item" remove="true" />
+ </difftypes>
+</object>
diff --git a/Products/ATContentTypes/profiles/uninstall/skins.xml b/Products/ATContentTypes/profiles/uninstall/skins.xml
new file mode 100644
index 0000000..75021dc
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/skins.xml
@@ -0,0 +1,7 @@
+<?xml version="1.0"?>
+<object name="portal_skins" meta_type="Plone Skins Tool">
+ <object name="ATContentTypes" remove="true" />
+ <skin-path name="*">
+  <layer name="ATContentTypes" remove="true" />
+ </skin-path>
+</object>
diff --git a/Products/ATContentTypes/profiles/uninstall/toolset.xml b/Products/ATContentTypes/profiles/uninstall/toolset.xml
new file mode 100644
index 0000000..b78a477
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/toolset.xml
@@ -0,0 +1,6 @@
+<?xml version="1.0"?>
+<tool-setup>
+ <forbidden tool_id="portal_atct" />
+ <forbidden tool_id="portal_factory" />
+ <forbidden tool_id="portal_metadata" />
+</tool-setup>
diff --git a/Products/ATContentTypes/profiles/uninstall/types.xml b/Products/ATContentTypes/profiles/uninstall/types.xml
new file mode 100644
index 0000000..b34e9fb
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/types.xml
@@ -0,0 +1,25 @@
+<?xml version="1.0"?>
+<object name="portal_types">
+ <object name="ATBooleanCriterion" remove="true" />
+ <object name="ATCurrentAuthorCriterion" remove="true" />
+ <object name="ATDateCriteria" remove="true" />
+ <object name="ATDateRangeCriterion" remove="true" />
+ <object name="ATListCriterion" remove="true" />
+ <object name="ATPathCriterion" remove="true" />
+ <object name="ATPortalTypeCriterion" remove="true" />
+ <object name="ATReferenceCriterion" remove="true" />
+ <object name="ATRelativePathCriterion" remove="true" />
+ <object name="ATSelectionCriterion" remove="true" />
+ <object name="ATSimpleIntCriterion" remove="true" />
+ <object name="ATSimpleStringCriterion" remove="true" />
+ <object name="ATSortCriterion" remove="true" />
+ <object name="Discussion Item" remove="true" />
+ <object name="Document" remove="true" />
+ <object name="Event" remove="true" />
+ <object name="File" remove="true" />
+ <object name="Folder" remove="true" />
+ <object name="Image" remove="true" />
+ <object name="Link" remove="true" />
+ <object name="News Item" remove="true" />
+ <object name="Topic" remove="true" />
+</object>
diff --git a/Products/ATContentTypes/setuphandlers.py b/Products/ATContentTypes/setuphandlers.py
index 1463879..19ba088 100644
--- a/Products/ATContentTypes/setuphandlers.py
+++ b/Products/ATContentTypes/setuphandlers.py
@@ -16,6 +16,12 @@
 from zope.i18n.locales import locales
 
 
+def cleanup_after_uninstall(context):
+    cat = getToolByName(context, 'portal_catalog')
+    if 'getRawRelatedItems' in cat.indexes():
+        cat.delIndex('getRawRelatedItems')
+
+
 def assignTitles(portal):
     ''' Check for those objects inside portal.
     If they are found we assign title to them.
diff --git a/Products/ATContentTypes/tests/test_base_profile.py b/Products/ATContentTypes/tests/test_base_profile.py
index bc24310..02f5966 100644
--- a/Products/ATContentTypes/tests/test_base_profile.py
+++ b/Products/ATContentTypes/tests/test_base_profile.py
@@ -7,8 +7,14 @@ class TestBaseProfile(PloneTestCase):
 
     def afterSetUp(self):
         self.loginAsPortalOwner()
-        qi = self.portal.portal_quickinstaller
-        qi.uninstallProducts(['ATContentTypes'])
+        try:
+            from Products.CMFPlone.utils import get_installer
+        except ImportError:
+            qi = getattr(self.portal, 'portal_quickinstaller')
+            qi.uninstallProducts(['ATContentTypes'])
+        else:
+            qi = get_installer(self.portal)
+            qi.uninstall_product('Products.ATContentTypes')
         portal_setup = self.portal.portal_setup
         portal_setup.runAllImportStepsFromProfile(
             'profile-Products.ATContentTypes:base')
diff --git a/Products/ATContentTypes/tests/test_installation.py b/Products/ATContentTypes/tests/test_installation.py
index cebc86f..0f2340c 100644
--- a/Products/ATContentTypes/tests/test_installation.py
+++ b/Products/ATContentTypes/tests/test_installation.py
@@ -4,12 +4,8 @@
 from Products.ATContentTypes.tests import atcttestcase
 from Products.ATContentTypes.tool.atct import ATCTTool
 from Products.CMFCore.utils import getToolByName
-from Products.CMFPlone.utils import getFSVersionTuple
-
 import unittest
 
-
-PLONE5 = getFSVersionTuple()[0] >= 5
 tests = []
 
 
@@ -42,12 +38,16 @@ def test_quickinstallable(self):
         # Test, if the Product is available in Quickinstaller.  For Plone < 5
         # it shouldn't (since it's a core dependency), for Plone >= 5 it should
         # (where plone.app.contenttypes is installed by default instead).
-        qi = getattr(self.portal, 'portal_quickinstaller')
-        products = [prod['id'] for prod in qi.listInstalledProducts()]
-        if PLONE5:
+        # Only Plone 5 is supported here.
+        try:
+            from Products.CMFPlone.utils import get_installer
+        except ImportError:
+            qi = getattr(self.portal, 'portal_quickinstaller')
+            products = [prod['id'] for prod in qi.listInstalledProducts()]
             self.assertTrue('ATContentTypes' in products)
         else:
-            self.assertTrue('ATContentTypes' not in products)
+            qi = get_installer(self.portal)
+            self.assertTrue(qi.is_product_installed('Products.ATContentTypes'))
 
     def test_release_settings_SAVE_TO_FAIL_FOR_DEVELOPMENT(self):
         self.assertEqual(SWALLOW_IMAGE_RESIZE_EXCEPTIONS, True)
@@ -74,6 +74,61 @@ def test_api_import(self):
 tests.append(TestInstallation)
 
 
+class TestUninstallation(atcttestcase.ATCTSiteTestCase):
+
+    def afterSetUp(self):
+        self.cat = getattr(self.portal.aq_explicit, 'portal_catalog')
+        try:
+            from Products.CMFPlone.utils import get_installer
+        except ImportError:
+            qi = getattr(self.portal, 'portal_quickinstaller')
+            qi.uninstallProducts(['ATContentTypes'])
+        else:
+            qi = get_installer(self.portal)
+            qi.uninstall_product('Products.ATContentTypes')
+
+    def test_tool_uninstalled(self):
+        t = getToolByName(self.portal, TOOLNAME, None)
+        self.assertFalse(t, t)
+
+    def test_skin_uninstalled(self):
+        stool = getattr(self.portal.aq_explicit, 'portal_skins')
+        self.assertFalse('ATContentTypes' in stool)
+
+    def test_uninstalledAllTypes(self):
+        # test that all types are uninstalled well
+        ids = ('Document', 'File', 'Folder', 'Image', 'Link',
+               'News Item', 'Topic', 'Event')
+        ttool = getattr(self.portal.aq_explicit, 'portal_types')
+        for i in ids:
+            self.assertFalse(i in ttool, i)
+
+    def test_quickinstallable(self):
+        # Test, if the Product is available in Quickinstaller.  For Plone < 5
+        # it shouldn't (since it's a core dependency), for Plone >= 5 it should
+        # (where plone.app.contenttypes is installed by default instead).
+        # Only Plone 5 is supported here.
+        try:
+            from Products.CMFPlone.utils import get_installer
+        except ImportError:
+            qi = getattr(self.portal, 'portal_quickinstaller')
+            products = [prod['id'] for prod in qi.listInstalledProducts()]
+            self.assertFalse('ATContentTypes' in products)
+            products = [prod['id'] for prod in qi.listInstallableProducts()]
+            self.assertTrue('ATContentTypes' in products)
+        else:
+            qi = get_installer(self.portal)
+            self.assertFalse(
+                qi.is_product_installed('Products.ATContentTypes'))
+            self.assertTrue(
+                qi.is_product_installable('Products.ATContentTypes'))
+
+    def test_removes_related_items_catalog_index(self):
+        self.assertNotIn('getRawRelatedItems', self.cat.Indexes)
+
+tests.append(TestUninstallation)
+
+
 def test_suite():
     suite = unittest.TestSuite()
     for test in tests:


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2016-09-07T01:19:47+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/b1882f3487107f2398a365592f0ca7ed12a38aef

Differentiate between uninstall and fulluninstall.

The 'uninstall' profile belongs to the 'base' profile, which is the
one that gets applied when you install ATContentTypes.

The 'fulluninstall' profile belongs to the 'default' profile, which
can only be installed through portal_setup.

Do not try to install p.a.imaging/widgets.  Their default profiles are
dummies in Plone 5.

Files changed:
A Products/ATContentTypes/profiles.zcml
A Products/ATContentTypes/profiles/fulluninstall/diff_tool.xml
A Products/ATContentTypes/profiles/fulluninstall/metadata.xml
A Products/ATContentTypes/profiles/fulluninstall/types.xml
A Products/ATContentTypes/profiles/uninstall/metadata.xml
M CHANGES.rst
M Products/ATContentTypes/configure.zcml
M Products/ATContentTypes/profiles/default/metadata.xml
M Products/ATContentTypes/tests/test_base_profile.py
M Products/ATContentTypes/tests/test_installation.py
D Products/ATContentTypes/profiles/uninstall/diff_tool.xml
D Products/ATContentTypes/profiles/uninstall/types.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index 413451d..9e69160 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -24,6 +24,12 @@ New features:
 
 - Make tests work with old and new safe HTML cleaner (PLIP 1441)
   [tomgross]
+- Do not try to install p.a.imaging/widgets.  Their default profiles
+  are dummies in Plone 5.  [maurits]
+
+- Added fulluninstall profile.  This profile belongs to the 'default'
+  profile, which can only be installed through portal_setup.  [maurits]
+
 - Added uninstall profile.  This profile belongs to the 'base'
   profile, which is the one that gets applied when you install
   ATContentTypes.  [maurits]
diff --git a/Products/ATContentTypes/configure.zcml b/Products/ATContentTypes/configure.zcml
index aa83e49..4a1e8ae 100644
--- a/Products/ATContentTypes/configure.zcml
+++ b/Products/ATContentTypes/configure.zcml
@@ -2,13 +2,13 @@
     xmlns="http://namespaces.zope.org/zope"
     xmlns:zcml="http://namespaces.zope.org/zcml"
     xmlns:five="http://namespaces.zope.org/five"
-    xmlns:genericsetup="http://namespaces.zope.org/genericsetup"
     i18n_domain="atcontenttypes">
 
   <include zcml:condition="installed Products.LinguaPlone"
            package="Products.LinguaPlone" />
 
   <include file="browser.zcml"/>
+  <include file="profiles.zcml"/>
 
   <include package=".exportimport" />
   <include package="plone.i18n.normalizer" />
@@ -44,46 +44,6 @@
     for=".criteria.path.ATPathCriterion"
     />
 
-  <genericsetup:registerProfile
-      name="default"
-      title="Archetypes Content Types for Plone"
-      directory="profiles/default"
-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
-      provides="Products.GenericSetup.interfaces.EXTENSION"
-      />
-
-  <genericsetup:registerProfile
-      name="content"
-      title="Archetypes-based default content for Plone"
-      directory="profiles/content"
-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
-      provides="Products.GenericSetup.interfaces.EXTENSION"
-      />
-
-  <genericsetup:registerProfile
-      name="base"
-      title="Archetypes-tools without content-types"
-      directory="profiles/base"
-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
-      provides="Products.GenericSetup.interfaces.EXTENSION"
-      />
-
-  <genericsetup:registerProfile
-      name="uninstall"
-      title="Uninstall Archetypes Content Types for Plone"
-      directory="profiles/uninstall"
-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
-      provides="Products.GenericSetup.interfaces.EXTENSION"
-      post_handler="Products.ATContentTypes.setuphandlers.cleanup_after_uninstall"
-      />
-
-  <genericsetup:importStep
-      name="atct_content"
-      title="ATContentTypes default content"
-      description=""
-      handler=".setuphandlers.importContent" />
-
-
   <adapter factory=".permission.ATFieldPermissionChecker" />
 
 </configure>
diff --git a/Products/ATContentTypes/profiles.zcml b/Products/ATContentTypes/profiles.zcml
new file mode 100644
index 0000000..fddedd4
--- /dev/null
+++ b/Products/ATContentTypes/profiles.zcml
@@ -0,0 +1,62 @@
+<configure
+    xmlns="http://namespaces.zope.org/zope"
+    xmlns:genericsetup="http://namespaces.zope.org/genericsetup"
+    i18n_domain="atcontenttypes">
+
+  <!-- Note that our 'default' profile is listed as uninstallable in
+       Products.CMFPlone.factory.  This means that when you install
+       ATContentTypes you get our 'base' profile because that one is
+       alphabetically the first. -->
+
+  <genericsetup:registerProfile
+      name="base"
+      title="Archetypes-tools without content-types"
+      directory="profiles/base"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      />
+
+  <genericsetup:registerProfile
+      name="content"
+      title="Archetypes-based default content for Plone"
+      directory="profiles/content"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      />
+
+  <genericsetup:registerProfile
+      name="default"
+      title="Archetypes Content Types for Plone"
+      directory="profiles/default"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      />
+
+  <!-- fulluninstall belongs to the default profile. -->
+  <genericsetup:registerProfile
+      name="fulluninstall"
+      title="Uninstall Archetypes Content Types for Plone fully "
+      directory="profiles/fulluninstall"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler="Products.ATContentTypes.setuphandlers.cleanup_after_uninstall"
+      />
+
+  <!-- uninstall belongs to the base profile.
+       This is what gets applied when you uninstall ATContentTypes. -->
+  <genericsetup:registerProfile
+      name="uninstall"
+      title="Uninstall Archetypes-based default content for Plone"
+      directory="profiles/uninstall"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler="Products.ATContentTypes.setuphandlers.cleanup_after_uninstall"
+      />
+
+  <genericsetup:importStep
+      name="atct_content"
+      title="ATContentTypes default content"
+      description=""
+      handler=".setuphandlers.importContent" />
+
+</configure>
diff --git a/Products/ATContentTypes/profiles/default/metadata.xml b/Products/ATContentTypes/profiles/default/metadata.xml
index 4ff0d5f..03623e0 100644
--- a/Products/ATContentTypes/profiles/default/metadata.xml
+++ b/Products/ATContentTypes/profiles/default/metadata.xml
@@ -4,7 +4,5 @@
   <dependencies>
     <dependency>profile-Products.ATContentTypes:base</dependency>
     <dependency>profile-plone.app.collection:default</dependency>
-    <dependency>profile-plone.app.imaging:default</dependency>
-    <dependency>profile-plone.app.widgets:default</dependency>
   </dependencies>
 </metadata>
diff --git a/Products/ATContentTypes/profiles/fulluninstall/diff_tool.xml b/Products/ATContentTypes/profiles/fulluninstall/diff_tool.xml
new file mode 100644
index 0000000..834b9b6
--- /dev/null
+++ b/Products/ATContentTypes/profiles/fulluninstall/diff_tool.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0"?>
+<object>
+  <difftypes>
+    <type portal_type="Document">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="Event">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="File">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="Folder">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="Image">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="Link">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="News Item">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+  </difftypes>
+</object>
\ No newline at end of file
diff --git a/Products/ATContentTypes/profiles/fulluninstall/metadata.xml b/Products/ATContentTypes/profiles/fulluninstall/metadata.xml
new file mode 100644
index 0000000..4b9d80c
--- /dev/null
+++ b/Products/ATContentTypes/profiles/fulluninstall/metadata.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0"?>
+<metadata>
+  <version>1</version>
+  <dependencies>
+    <dependency>profile-Products.ATContentTypes:uninstall</dependency>
+    <dependency>profile-plone.app.collection:uninstall</dependency>
+  </dependencies>
+</metadata>
diff --git a/Products/ATContentTypes/profiles/fulluninstall/types.xml b/Products/ATContentTypes/profiles/fulluninstall/types.xml
new file mode 100644
index 0000000..1ef67e5
--- /dev/null
+++ b/Products/ATContentTypes/profiles/fulluninstall/types.xml
@@ -0,0 +1,25 @@
+<?xml version="1.0"?>
+<object name="portal_types">
+  <object name="ATBooleanCriterion" remove="true" />
+  <object name="ATCurrentAuthorCriterion" remove="true" />
+  <object name="ATDateCriteria" remove="true" />
+  <object name="ATDateRangeCriterion" remove="true" />
+  <object name="ATListCriterion" remove="true" />
+  <object name="ATPathCriterion" remove="true" />
+  <object name="ATPortalTypeCriterion" remove="true" />
+  <object name="ATReferenceCriterion" remove="true" />
+  <object name="ATRelativePathCriterion" remove="true" />
+  <object name="ATSelectionCriterion" remove="true" />
+  <object name="ATSimpleIntCriterion" remove="true" />
+  <object name="ATSimpleStringCriterion" remove="true" />
+  <object name="ATSortCriterion" remove="true" />
+  <object name="Discussion Item" remove="true" />
+  <object name="Document" remove="true" />
+  <object name="Event" remove="true" />
+  <object name="File" remove="true" />
+  <object name="Folder" remove="true" />
+  <object name="Image" remove="true" />
+  <object name="Link" remove="true" />
+  <object name="News Item" remove="true" />
+  <object name="Topic" remove="true" />
+</object>
diff --git a/Products/ATContentTypes/profiles/uninstall/diff_tool.xml b/Products/ATContentTypes/profiles/uninstall/diff_tool.xml
deleted file mode 100644
index e29dfdc..0000000
--- a/Products/ATContentTypes/profiles/uninstall/diff_tool.xml
+++ /dev/null
@@ -1,12 +0,0 @@
-<?xml version="1.0"?>
-<object>
- <difftypes>
-  <type portal_type="Document" remove="true" />
-  <type portal_type="Event" remove="true" />
-  <type portal_type="File" remove="true"/>
-  <type portal_type="Folder" remove="true" />
-  <type portal_type="Image" remove="true" />
-  <type portal_type="Link" remove="true" />
-  <type portal_type="News Item" remove="true" />
- </difftypes>
-</object>
diff --git a/Products/ATContentTypes/profiles/uninstall/metadata.xml b/Products/ATContentTypes/profiles/uninstall/metadata.xml
new file mode 100644
index 0000000..0a32e36
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/metadata.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0"?>
+<metadata>
+  <dependencies>
+    <dependency>profile-Products.Archetypes:uninstall</dependency>
+    <!-- Products.CMFFormController is also needed and installed by CMFPlone. -->
+    <!-- <dependency>profile-Products.CMFFormController:uninstall</dependency> -->
+  </dependencies>
+</metadata>
diff --git a/Products/ATContentTypes/profiles/uninstall/types.xml b/Products/ATContentTypes/profiles/uninstall/types.xml
deleted file mode 100644
index b34e9fb..0000000
--- a/Products/ATContentTypes/profiles/uninstall/types.xml
+++ /dev/null
@@ -1,25 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_types">
- <object name="ATBooleanCriterion" remove="true" />
- <object name="ATCurrentAuthorCriterion" remove="true" />
- <object name="ATDateCriteria" remove="true" />
- <object name="ATDateRangeCriterion" remove="true" />
- <object name="ATListCriterion" remove="true" />
- <object name="ATPathCriterion" remove="true" />
- <object name="ATPortalTypeCriterion" remove="true" />
- <object name="ATReferenceCriterion" remove="true" />
- <object name="ATRelativePathCriterion" remove="true" />
- <object name="ATSelectionCriterion" remove="true" />
- <object name="ATSimpleIntCriterion" remove="true" />
- <object name="ATSimpleStringCriterion" remove="true" />
- <object name="ATSortCriterion" remove="true" />
- <object name="Discussion Item" remove="true" />
- <object name="Document" remove="true" />
- <object name="Event" remove="true" />
- <object name="File" remove="true" />
- <object name="Folder" remove="true" />
- <object name="Image" remove="true" />
- <object name="Link" remove="true" />
- <object name="News Item" remove="true" />
- <object name="Topic" remove="true" />
-</object>
diff --git a/Products/ATContentTypes/tests/test_base_profile.py b/Products/ATContentTypes/tests/test_base_profile.py
index 02f5966..c64d780 100644
--- a/Products/ATContentTypes/tests/test_base_profile.py
+++ b/Products/ATContentTypes/tests/test_base_profile.py
@@ -16,6 +16,14 @@ def afterSetUp(self):
             qi = get_installer(self.portal)
             qi.uninstall_product('Products.ATContentTypes')
         portal_setup = self.portal.portal_setup
+        # It looks like the hiddenprofile utility from CMFPlone is not loaded
+        # in these tests.  So our default profile is installed, instead of only
+        # our base profile.  This explains why our portal_types are available
+        # at all.  This means we need to manually apply the fullinstall
+        # profile.
+        portal_setup.runAllImportStepsFromProfile(
+            'Products.ATContentTypes:fulluninstall')
+        # Now we apply the base profile.
         portal_setup.runAllImportStepsFromProfile(
             'profile-Products.ATContentTypes:base')
 
diff --git a/Products/ATContentTypes/tests/test_installation.py b/Products/ATContentTypes/tests/test_installation.py
index 0f2340c..71ce6a3 100644
--- a/Products/ATContentTypes/tests/test_installation.py
+++ b/Products/ATContentTypes/tests/test_installation.py
@@ -86,6 +86,19 @@ def afterSetUp(self):
         else:
             qi = get_installer(self.portal)
             qi.uninstall_product('Products.ATContentTypes')
+        # It looks like the hiddenprofile utility from CMFPlone is not loaded
+        # in these tests.  So our default profile is installed, instead of only
+        # our base profile.  This explains why our portal_types are available
+        # at all.  This means we need to manually apply the fullinstall
+        # profile.
+        self.portal.portal_setup.runAllImportStepsFromProfile(
+            'Products.ATContentTypes:fulluninstall')
+
+    def test_double_uninstall(self):
+        # In afterSetUp we apply the fulluninstall profile.  Check that nothing
+        # goes wrong when we apply it again.
+        self.portal.portal_setup.runAllImportStepsFromProfile(
+            'Products.ATContentTypes:fulluninstall')
 
     def test_tool_uninstalled(self):
         t = getToolByName(self.portal, TOOLNAME, None)


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2016-09-07T01:19:47+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/0762473c215d1e209f6cae40290ec30301ceb920

Give up on portal_quickinstaller of Plone 5.0.

We need Plone 5.1 with the get_installer function from
https://github.com/plone/Products.CMFPlone/issues/1340

With 5.0 and the old QI you run into problems like: when the uninstall
profile gets applied, the QI event handlers actually mark the product
as installed...

Files changed:
M Products/ATContentTypes/tests/test_base_profile.py
M Products/ATContentTypes/tests/test_installation.py

diff --git a/Products/ATContentTypes/tests/test_base_profile.py b/Products/ATContentTypes/tests/test_base_profile.py
index c64d780..b2f15be 100644
--- a/Products/ATContentTypes/tests/test_base_profile.py
+++ b/Products/ATContentTypes/tests/test_base_profile.py
@@ -7,14 +7,9 @@ class TestBaseProfile(PloneTestCase):
 
     def afterSetUp(self):
         self.loginAsPortalOwner()
-        try:
-            from Products.CMFPlone.utils import get_installer
-        except ImportError:
-            qi = getattr(self.portal, 'portal_quickinstaller')
-            qi.uninstallProducts(['ATContentTypes'])
-        else:
-            qi = get_installer(self.portal)
-            qi.uninstall_product('Products.ATContentTypes')
+        from Products.CMFPlone.utils import get_installer
+        qi = get_installer(self.portal)
+        qi.uninstall_product('Products.ATContentTypes')
         portal_setup = self.portal.portal_setup
         # It looks like the hiddenprofile utility from CMFPlone is not loaded
         # in these tests.  So our default profile is installed, instead of only
diff --git a/Products/ATContentTypes/tests/test_installation.py b/Products/ATContentTypes/tests/test_installation.py
index 71ce6a3..116522c 100644
--- a/Products/ATContentTypes/tests/test_installation.py
+++ b/Products/ATContentTypes/tests/test_installation.py
@@ -34,20 +34,14 @@ def test_installedAllTypes(self):
         for i in ids:
             self.assertTrue(i in self.ttool)
 
-    def test_quickinstallable(self):
-        # Test, if the Product is available in Quickinstaller.  For Plone < 5
+    def test_is_installed(self):
+        # Test, if the Product is listed as installed.  For Plone < 5
         # it shouldn't (since it's a core dependency), for Plone >= 5 it should
         # (where plone.app.contenttypes is installed by default instead).
-        # Only Plone 5 is supported here.
-        try:
-            from Products.CMFPlone.utils import get_installer
-        except ImportError:
-            qi = getattr(self.portal, 'portal_quickinstaller')
-            products = [prod['id'] for prod in qi.listInstalledProducts()]
-            self.assertTrue('ATContentTypes' in products)
-        else:
-            qi = get_installer(self.portal)
-            self.assertTrue(qi.is_product_installed('Products.ATContentTypes'))
+        # Only Plone 5.1 is supported here.
+        from Products.CMFPlone.utils import get_installer
+        qi = get_installer(self.portal)
+        self.assertTrue(qi.is_product_installed('Products.ATContentTypes'))
 
     def test_release_settings_SAVE_TO_FAIL_FOR_DEVELOPMENT(self):
         self.assertEqual(SWALLOW_IMAGE_RESIZE_EXCEPTIONS, True)
@@ -78,14 +72,9 @@ class TestUninstallation(atcttestcase.ATCTSiteTestCase):
 
     def afterSetUp(self):
         self.cat = getattr(self.portal.aq_explicit, 'portal_catalog')
-        try:
-            from Products.CMFPlone.utils import get_installer
-        except ImportError:
-            qi = getattr(self.portal, 'portal_quickinstaller')
-            qi.uninstallProducts(['ATContentTypes'])
-        else:
-            qi = get_installer(self.portal)
-            qi.uninstall_product('Products.ATContentTypes')
+        from Products.CMFPlone.utils import get_installer
+        qi = get_installer(self.portal)
+        qi.uninstall_product('Products.ATContentTypes')
         # It looks like the hiddenprofile utility from CMFPlone is not loaded
         # in these tests.  So our default profile is installed, instead of only
         # our base profile.  This explains why our portal_types are available
@@ -116,25 +105,17 @@ def test_uninstalledAllTypes(self):
         for i in ids:
             self.assertFalse(i in ttool, i)
 
-    def test_quickinstallable(self):
-        # Test, if the Product is available in Quickinstaller.  For Plone < 5
+    def test_is_installable(self):
+        # Test, if the Product is available for installation.  For Plone < 5
         # it shouldn't (since it's a core dependency), for Plone >= 5 it should
         # (where plone.app.contenttypes is installed by default instead).
-        # Only Plone 5 is supported here.
-        try:
-            from Products.CMFPlone.utils import get_installer
-        except ImportError:
-            qi = getattr(self.portal, 'portal_quickinstaller')
-            products = [prod['id'] for prod in qi.listInstalledProducts()]
-            self.assertFalse('ATContentTypes' in products)
-            products = [prod['id'] for prod in qi.listInstallableProducts()]
-            self.assertTrue('ATContentTypes' in products)
-        else:
-            qi = get_installer(self.portal)
-            self.assertFalse(
-                qi.is_product_installed('Products.ATContentTypes'))
-            self.assertTrue(
-                qi.is_product_installable('Products.ATContentTypes'))
+        # Only Plone 5.1 is supported here.
+        from Products.CMFPlone.utils import get_installer
+        qi = get_installer(self.portal)
+        self.assertFalse(
+            qi.is_product_installed('Products.ATContentTypes'))
+        self.assertTrue(
+            qi.is_product_installable('Products.ATContentTypes'))
 
     def test_removes_related_items_catalog_index(self):
         self.assertNotIn('getRawRelatedItems', self.cat.Indexes)


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2016-09-07T01:20:37+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/e88e5a27d5793f6dda03abc67e9dce3f47a285e2

changelog

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 9e69160..0634f1e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,18 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Do not try to install p.a.imaging/widgets.  Their default profiles
+  are dummies in Plone 5.  [maurits]
+
+- Added fulluninstall profile.  This profile belongs to the 'default'
+  profile, which can only be installed through portal_setup.  [maurits]
+
+- Added uninstall profile.  This profile belongs to the 'base'
+  profile, which is the one that gets applied when you install
+  ATContentTypes.  [maurits]
+
+- No longer register the archetypes skin, because Products.Archetypes
+  does that itself.  [maurits]
 
 Bug fixes:
 
@@ -24,18 +35,6 @@ New features:
 
 - Make tests work with old and new safe HTML cleaner (PLIP 1441)
   [tomgross]
-- Do not try to install p.a.imaging/widgets.  Their default profiles
-  are dummies in Plone 5.  [maurits]
-
-- Added fulluninstall profile.  This profile belongs to the 'default'
-  profile, which can only be installed through portal_setup.  [maurits]
-
-- Added uninstall profile.  This profile belongs to the 'base'
-  profile, which is the one that gets applied when you install
-  ATContentTypes.  [maurits]
-
-- No longer register the archetypes skin, because Products.Archetypes
-  does that itself.  [maurits]
 
 Bug fixes:
 


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2016-09-21T11:54:01+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/be42b2a2e85566e5684d83f18872e460e9ac8c12

Merge pull request #32 from plone/get-rid-of-qi

Added uninstall profile.

Files changed:
A Products/ATContentTypes/profiles.zcml
A Products/ATContentTypes/profiles/fulluninstall/diff_tool.xml
A Products/ATContentTypes/profiles/fulluninstall/metadata.xml
A Products/ATContentTypes/profiles/fulluninstall/types.xml
A Products/ATContentTypes/profiles/uninstall/componentregistry.xml
A Products/ATContentTypes/profiles/uninstall/controlpanel.xml
A Products/ATContentTypes/profiles/uninstall/metadata.xml
A Products/ATContentTypes/profiles/uninstall/skins.xml
A Products/ATContentTypes/profiles/uninstall/toolset.xml
M CHANGES.rst
M Products/ATContentTypes/configure.zcml
M Products/ATContentTypes/profiles/base/skins.xml
M Products/ATContentTypes/profiles/default/metadata.xml
M Products/ATContentTypes/setuphandlers.py
M Products/ATContentTypes/tests/test_base_profile.py
M Products/ATContentTypes/tests/test_installation.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9fe4348..0634f1e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,18 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Do not try to install p.a.imaging/widgets.  Their default profiles
+  are dummies in Plone 5.  [maurits]
+
+- Added fulluninstall profile.  This profile belongs to the 'default'
+  profile, which can only be installed through portal_setup.  [maurits]
+
+- Added uninstall profile.  This profile belongs to the 'base'
+  profile, which is the one that gets applied when you install
+  ATContentTypes.  [maurits]
+
+- No longer register the archetypes skin, because Products.Archetypes
+  does that itself.  [maurits]
 
 Bug fixes:
 
diff --git a/Products/ATContentTypes/configure.zcml b/Products/ATContentTypes/configure.zcml
index 209eeac..4a1e8ae 100644
--- a/Products/ATContentTypes/configure.zcml
+++ b/Products/ATContentTypes/configure.zcml
@@ -2,13 +2,13 @@
     xmlns="http://namespaces.zope.org/zope"
     xmlns:zcml="http://namespaces.zope.org/zcml"
     xmlns:five="http://namespaces.zope.org/five"
-    xmlns:genericsetup="http://namespaces.zope.org/genericsetup"
     i18n_domain="atcontenttypes">
 
   <include zcml:condition="installed Products.LinguaPlone"
            package="Products.LinguaPlone" />
 
   <include file="browser.zcml"/>
+  <include file="profiles.zcml"/>
 
   <include package=".exportimport" />
   <include package="plone.i18n.normalizer" />
@@ -44,37 +44,6 @@
     for=".criteria.path.ATPathCriterion"
     />
 
-  <genericsetup:registerProfile
-      name="default"
-      title="Archetypes Content Types for Plone"
-      directory="profiles/default"
-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
-      provides="Products.GenericSetup.interfaces.EXTENSION"
-      />
-
-  <genericsetup:registerProfile
-      name="content"
-      title="Archetypes-based default content for Plone"
-      directory="profiles/content"
-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
-      provides="Products.GenericSetup.interfaces.EXTENSION"
-      />
-
-  <genericsetup:registerProfile
-      name="base"
-      title="Archetypes-tools without content-types"
-      directory="profiles/base"
-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
-      provides="Products.GenericSetup.interfaces.EXTENSION"
-      />
-
-  <genericsetup:importStep
-      name="atct_content"
-      title="ATContentTypes default content"
-      description=""
-      handler=".setuphandlers.importContent" />
-
-
   <adapter factory=".permission.ATFieldPermissionChecker" />
 
 </configure>
diff --git a/Products/ATContentTypes/profiles.zcml b/Products/ATContentTypes/profiles.zcml
new file mode 100644
index 0000000..fddedd4
--- /dev/null
+++ b/Products/ATContentTypes/profiles.zcml
@@ -0,0 +1,62 @@
+<configure
+    xmlns="http://namespaces.zope.org/zope"
+    xmlns:genericsetup="http://namespaces.zope.org/genericsetup"
+    i18n_domain="atcontenttypes">
+
+  <!-- Note that our 'default' profile is listed as uninstallable in
+       Products.CMFPlone.factory.  This means that when you install
+       ATContentTypes you get our 'base' profile because that one is
+       alphabetically the first. -->
+
+  <genericsetup:registerProfile
+      name="base"
+      title="Archetypes-tools without content-types"
+      directory="profiles/base"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      />
+
+  <genericsetup:registerProfile
+      name="content"
+      title="Archetypes-based default content for Plone"
+      directory="profiles/content"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      />
+
+  <genericsetup:registerProfile
+      name="default"
+      title="Archetypes Content Types for Plone"
+      directory="profiles/default"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      />
+
+  <!-- fulluninstall belongs to the default profile. -->
+  <genericsetup:registerProfile
+      name="fulluninstall"
+      title="Uninstall Archetypes Content Types for Plone fully "
+      directory="profiles/fulluninstall"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler="Products.ATContentTypes.setuphandlers.cleanup_after_uninstall"
+      />
+
+  <!-- uninstall belongs to the base profile.
+       This is what gets applied when you uninstall ATContentTypes. -->
+  <genericsetup:registerProfile
+      name="uninstall"
+      title="Uninstall Archetypes-based default content for Plone"
+      directory="profiles/uninstall"
+      for="Products.CMFPlone.interfaces.IPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler="Products.ATContentTypes.setuphandlers.cleanup_after_uninstall"
+      />
+
+  <genericsetup:importStep
+      name="atct_content"
+      title="ATContentTypes default content"
+      description=""
+      handler=".setuphandlers.importContent" />
+
+</configure>
diff --git a/Products/ATContentTypes/profiles/base/skins.xml b/Products/ATContentTypes/profiles/base/skins.xml
index 4e2ae22..f7cd890 100644
--- a/Products/ATContentTypes/profiles/base/skins.xml
+++ b/Products/ATContentTypes/profiles/base/skins.xml
@@ -2,10 +2,7 @@
 <object name="portal_skins" meta_type="Plone Skins Tool">
  <object name="ATContentTypes" meta_type="Filesystem Directory View"
     directory="Products.ATContentTypes:skins/ATContentTypes"/>
- <object name="archetypes" meta_type="Filesystem Directory View"
-    directory="Products.Archetypes:skins/archetypes"/>
  <skin-path name="*">
   <layer name="ATContentTypes" insert-after="custom"/>
-  <layer name="archetypes" insert-after="custom"/>
  </skin-path>
 </object>
diff --git a/Products/ATContentTypes/profiles/default/metadata.xml b/Products/ATContentTypes/profiles/default/metadata.xml
index 4ff0d5f..03623e0 100644
--- a/Products/ATContentTypes/profiles/default/metadata.xml
+++ b/Products/ATContentTypes/profiles/default/metadata.xml
@@ -4,7 +4,5 @@
   <dependencies>
     <dependency>profile-Products.ATContentTypes:base</dependency>
     <dependency>profile-plone.app.collection:default</dependency>
-    <dependency>profile-plone.app.imaging:default</dependency>
-    <dependency>profile-plone.app.widgets:default</dependency>
   </dependencies>
 </metadata>
diff --git a/Products/ATContentTypes/profiles/fulluninstall/diff_tool.xml b/Products/ATContentTypes/profiles/fulluninstall/diff_tool.xml
new file mode 100644
index 0000000..834b9b6
--- /dev/null
+++ b/Products/ATContentTypes/profiles/fulluninstall/diff_tool.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0"?>
+<object>
+  <difftypes>
+    <type portal_type="Document">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="Event">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="File">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="Folder">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="Image">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="Link">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+    <type portal_type="News Item">
+      <field name="any" difftype="Compound Diff for Dexterity types"/>
+    </type>
+  </difftypes>
+</object>
\ No newline at end of file
diff --git a/Products/ATContentTypes/profiles/fulluninstall/metadata.xml b/Products/ATContentTypes/profiles/fulluninstall/metadata.xml
new file mode 100644
index 0000000..4b9d80c
--- /dev/null
+++ b/Products/ATContentTypes/profiles/fulluninstall/metadata.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0"?>
+<metadata>
+  <version>1</version>
+  <dependencies>
+    <dependency>profile-Products.ATContentTypes:uninstall</dependency>
+    <dependency>profile-plone.app.collection:uninstall</dependency>
+  </dependencies>
+</metadata>
diff --git a/Products/ATContentTypes/profiles/fulluninstall/types.xml b/Products/ATContentTypes/profiles/fulluninstall/types.xml
new file mode 100644
index 0000000..1ef67e5
--- /dev/null
+++ b/Products/ATContentTypes/profiles/fulluninstall/types.xml
@@ -0,0 +1,25 @@
+<?xml version="1.0"?>
+<object name="portal_types">
+  <object name="ATBooleanCriterion" remove="true" />
+  <object name="ATCurrentAuthorCriterion" remove="true" />
+  <object name="ATDateCriteria" remove="true" />
+  <object name="ATDateRangeCriterion" remove="true" />
+  <object name="ATListCriterion" remove="true" />
+  <object name="ATPathCriterion" remove="true" />
+  <object name="ATPortalTypeCriterion" remove="true" />
+  <object name="ATReferenceCriterion" remove="true" />
+  <object name="ATRelativePathCriterion" remove="true" />
+  <object name="ATSelectionCriterion" remove="true" />
+  <object name="ATSimpleIntCriterion" remove="true" />
+  <object name="ATSimpleStringCriterion" remove="true" />
+  <object name="ATSortCriterion" remove="true" />
+  <object name="Discussion Item" remove="true" />
+  <object name="Document" remove="true" />
+  <object name="Event" remove="true" />
+  <object name="File" remove="true" />
+  <object name="Folder" remove="true" />
+  <object name="Image" remove="true" />
+  <object name="Link" remove="true" />
+  <object name="News Item" remove="true" />
+  <object name="Topic" remove="true" />
+</object>
diff --git a/Products/ATContentTypes/profiles/uninstall/componentregistry.xml b/Products/ATContentTypes/profiles/uninstall/componentregistry.xml
new file mode 100644
index 0000000..e43f3ab
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/componentregistry.xml
@@ -0,0 +1,9 @@
+<?xml version="1.0"?>
+<componentregistry>
+  <utilities>
+    <utility
+        remove="true"
+        interface="Products.ATContentTypes.interface.IATCTTool"
+        object="portal_atct"/>
+  </utilities>
+</componentregistry>
diff --git a/Products/ATContentTypes/profiles/uninstall/controlpanel.xml b/Products/ATContentTypes/profiles/uninstall/controlpanel.xml
new file mode 100644
index 0000000..e1dfa7c
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/controlpanel.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<object name="portal_controlpanel">
+ <configlet action_id="portal_atct" remove="true" />
+</object>
diff --git a/Products/ATContentTypes/profiles/uninstall/metadata.xml b/Products/ATContentTypes/profiles/uninstall/metadata.xml
new file mode 100644
index 0000000..0a32e36
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/metadata.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0"?>
+<metadata>
+  <dependencies>
+    <dependency>profile-Products.Archetypes:uninstall</dependency>
+    <!-- Products.CMFFormController is also needed and installed by CMFPlone. -->
+    <!-- <dependency>profile-Products.CMFFormController:uninstall</dependency> -->
+  </dependencies>
+</metadata>
diff --git a/Products/ATContentTypes/profiles/uninstall/skins.xml b/Products/ATContentTypes/profiles/uninstall/skins.xml
new file mode 100644
index 0000000..75021dc
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/skins.xml
@@ -0,0 +1,7 @@
+<?xml version="1.0"?>
+<object name="portal_skins" meta_type="Plone Skins Tool">
+ <object name="ATContentTypes" remove="true" />
+ <skin-path name="*">
+  <layer name="ATContentTypes" remove="true" />
+ </skin-path>
+</object>
diff --git a/Products/ATContentTypes/profiles/uninstall/toolset.xml b/Products/ATContentTypes/profiles/uninstall/toolset.xml
new file mode 100644
index 0000000..b78a477
--- /dev/null
+++ b/Products/ATContentTypes/profiles/uninstall/toolset.xml
@@ -0,0 +1,6 @@
+<?xml version="1.0"?>
+<tool-setup>
+ <forbidden tool_id="portal_atct" />
+ <forbidden tool_id="portal_factory" />
+ <forbidden tool_id="portal_metadata" />
+</tool-setup>
diff --git a/Products/ATContentTypes/setuphandlers.py b/Products/ATContentTypes/setuphandlers.py
index 1463879..19ba088 100644
--- a/Products/ATContentTypes/setuphandlers.py
+++ b/Products/ATContentTypes/setuphandlers.py
@@ -16,6 +16,12 @@
 from zope.i18n.locales import locales
 
 
+def cleanup_after_uninstall(context):
+    cat = getToolByName(context, 'portal_catalog')
+    if 'getRawRelatedItems' in cat.indexes():
+        cat.delIndex('getRawRelatedItems')
+
+
 def assignTitles(portal):
     ''' Check for those objects inside portal.
     If they are found we assign title to them.
diff --git a/Products/ATContentTypes/tests/test_base_profile.py b/Products/ATContentTypes/tests/test_base_profile.py
index bc24310..b2f15be 100644
--- a/Products/ATContentTypes/tests/test_base_profile.py
+++ b/Products/ATContentTypes/tests/test_base_profile.py
@@ -7,9 +7,18 @@ class TestBaseProfile(PloneTestCase):
 
     def afterSetUp(self):
         self.loginAsPortalOwner()
-        qi = self.portal.portal_quickinstaller
-        qi.uninstallProducts(['ATContentTypes'])
+        from Products.CMFPlone.utils import get_installer
+        qi = get_installer(self.portal)
+        qi.uninstall_product('Products.ATContentTypes')
         portal_setup = self.portal.portal_setup
+        # It looks like the hiddenprofile utility from CMFPlone is not loaded
+        # in these tests.  So our default profile is installed, instead of only
+        # our base profile.  This explains why our portal_types are available
+        # at all.  This means we need to manually apply the fullinstall
+        # profile.
+        portal_setup.runAllImportStepsFromProfile(
+            'Products.ATContentTypes:fulluninstall')
+        # Now we apply the base profile.
         portal_setup.runAllImportStepsFromProfile(
             'profile-Products.ATContentTypes:base')
 
diff --git a/Products/ATContentTypes/tests/test_installation.py b/Products/ATContentTypes/tests/test_installation.py
index cebc86f..116522c 100644
--- a/Products/ATContentTypes/tests/test_installation.py
+++ b/Products/ATContentTypes/tests/test_installation.py
@@ -4,12 +4,8 @@
 from Products.ATContentTypes.tests import atcttestcase
 from Products.ATContentTypes.tool.atct import ATCTTool
 from Products.CMFCore.utils import getToolByName
-from Products.CMFPlone.utils import getFSVersionTuple
-
 import unittest
 
-
-PLONE5 = getFSVersionTuple()[0] >= 5
 tests = []
 
 
@@ -38,16 +34,14 @@ def test_installedAllTypes(self):
         for i in ids:
             self.assertTrue(i in self.ttool)
 
-    def test_quickinstallable(self):
-        # Test, if the Product is available in Quickinstaller.  For Plone < 5
+    def test_is_installed(self):
+        # Test, if the Product is listed as installed.  For Plone < 5
         # it shouldn't (since it's a core dependency), for Plone >= 5 it should
         # (where plone.app.contenttypes is installed by default instead).
-        qi = getattr(self.portal, 'portal_quickinstaller')
-        products = [prod['id'] for prod in qi.listInstalledProducts()]
-        if PLONE5:
-            self.assertTrue('ATContentTypes' in products)
-        else:
-            self.assertTrue('ATContentTypes' not in products)
+        # Only Plone 5.1 is supported here.
+        from Products.CMFPlone.utils import get_installer
+        qi = get_installer(self.portal)
+        self.assertTrue(qi.is_product_installed('Products.ATContentTypes'))
 
     def test_release_settings_SAVE_TO_FAIL_FOR_DEVELOPMENT(self):
         self.assertEqual(SWALLOW_IMAGE_RESIZE_EXCEPTIONS, True)
@@ -74,6 +68,61 @@ def test_api_import(self):
 tests.append(TestInstallation)
 
 
+class TestUninstallation(atcttestcase.ATCTSiteTestCase):
+
+    def afterSetUp(self):
+        self.cat = getattr(self.portal.aq_explicit, 'portal_catalog')
+        from Products.CMFPlone.utils import get_installer
+        qi = get_installer(self.portal)
+        qi.uninstall_product('Products.ATContentTypes')
+        # It looks like the hiddenprofile utility from CMFPlone is not loaded
+        # in these tests.  So our default profile is installed, instead of only
+        # our base profile.  This explains why our portal_types are available
+        # at all.  This means we need to manually apply the fullinstall
+        # profile.
+        self.portal.portal_setup.runAllImportStepsFromProfile(
+            'Products.ATContentTypes:fulluninstall')
+
+    def test_double_uninstall(self):
+        # In afterSetUp we apply the fulluninstall profile.  Check that nothing
+        # goes wrong when we apply it again.
+        self.portal.portal_setup.runAllImportStepsFromProfile(
+            'Products.ATContentTypes:fulluninstall')
+
+    def test_tool_uninstalled(self):
+        t = getToolByName(self.portal, TOOLNAME, None)
+        self.assertFalse(t, t)
+
+    def test_skin_uninstalled(self):
+        stool = getattr(self.portal.aq_explicit, 'portal_skins')
+        self.assertFalse('ATContentTypes' in stool)
+
+    def test_uninstalledAllTypes(self):
+        # test that all types are uninstalled well
+        ids = ('Document', 'File', 'Folder', 'Image', 'Link',
+               'News Item', 'Topic', 'Event')
+        ttool = getattr(self.portal.aq_explicit, 'portal_types')
+        for i in ids:
+            self.assertFalse(i in ttool, i)
+
+    def test_is_installable(self):
+        # Test, if the Product is available for installation.  For Plone < 5
+        # it shouldn't (since it's a core dependency), for Plone >= 5 it should
+        # (where plone.app.contenttypes is installed by default instead).
+        # Only Plone 5.1 is supported here.
+        from Products.CMFPlone.utils import get_installer
+        qi = get_installer(self.portal)
+        self.assertFalse(
+            qi.is_product_installed('Products.ATContentTypes'))
+        self.assertTrue(
+            qi.is_product_installable('Products.ATContentTypes'))
+
+    def test_removes_related_items_catalog_index(self):
+        self.assertNotIn('getRawRelatedItems', self.cat.Indexes)
+
+tests.append(TestUninstallation)
+
+
 def test_suite():
     suite = unittest.TestSuite()
     for test in tests:


