Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2022-01-21T00:19:22+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/bd5e12f6109510738c2c07305417c5c244979787

Security fix: prevent cache poisoning with the Referer header.

See [security advisory](https://github.com/plone/plone.app.contenttypes/security/advisories/GHSA-f7qw-5fgj-247x).

Files changed:
A news/1.bugfix
M plone/app/contenttypes/browser/templates/image_view_fullscreen.pt

b'diff --git a/news/1.bugfix b/news/1.bugfix\nnew file mode 100644\nindex 00000000..43c1b22a\n--- /dev/null\n+++ b/news/1.bugfix\n@@ -0,0 +1,3 @@\n+Security fix: prevent cache poisoning with the Referer header.\n+See `security advisory <https://github.com/plone/plone.app.contenttypes/security/advisories/GHSA-f7qw-5fgj-247x>`.\n+[maurits]\ndiff --git a/plone/app/contenttypes/browser/templates/image_view_fullscreen.pt b/plone/app/contenttypes/browser/templates/image_view_fullscreen.pt\nindex 8eb7e590..6f72ad1b 100644\n--- a/plone/app/contenttypes/browser/templates/image_view_fullscreen.pt\n+++ b/plone/app/contenttypes/browser/templates/image_view_fullscreen.pt\n@@ -47,14 +47,18 @@\n \n <body>\n   <div id="content-core" tal:condition="context/@@images">\n-    <a tal:attributes="href request/HTTP_REFERER" tal:condition="request/HTTP_REFERER">\n+    <tal:block define="referer request/HTTP_REFERER;\n+                       url_tool nocall:context/portal_url;\n+                       referer python:referer if referer and url_tool.isURLInPortal(referer) else \'\';">\n+    <a tal:attributes="href referer" tal:condition="referer">\n       <tal:block replace="structure context/@@images/image" />\n       <span i18n:translate="label_back_to_site">Back to site</span>\n     </a>\n-    <a tal:attributes="href context/portal_url" tal:condition="not: request/HTTP_REFERER">\n+    <a tal:attributes="href python:url_tool()" tal:condition="not: referer">\n       <tal:block replace="structure context/@@images/image" />\n       <span i18n:translate="label_home">Home</span>\n     </a>\n+  </tal:block>\n   </div>\n </body>\n \n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2022-01-28T14:51:56+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/1d82f8ee02b03d6f89c3199052d83b0b7e25467f

Merge branch 'referer-fix-master'

Files changed:
A news/1.bugfix
M plone/app/contenttypes/browser/templates/image_view_fullscreen.pt

b'diff --git a/news/1.bugfix b/news/1.bugfix\nnew file mode 100644\nindex 00000000..43c1b22a\n--- /dev/null\n+++ b/news/1.bugfix\n@@ -0,0 +1,3 @@\n+Security fix: prevent cache poisoning with the Referer header.\n+See `security advisory <https://github.com/plone/plone.app.contenttypes/security/advisories/GHSA-f7qw-5fgj-247x>`.\n+[maurits]\ndiff --git a/plone/app/contenttypes/browser/templates/image_view_fullscreen.pt b/plone/app/contenttypes/browser/templates/image_view_fullscreen.pt\nindex 8eb7e590..6f72ad1b 100644\n--- a/plone/app/contenttypes/browser/templates/image_view_fullscreen.pt\n+++ b/plone/app/contenttypes/browser/templates/image_view_fullscreen.pt\n@@ -47,14 +47,18 @@\n \n <body>\n   <div id="content-core" tal:condition="context/@@images">\n-    <a tal:attributes="href request/HTTP_REFERER" tal:condition="request/HTTP_REFERER">\n+    <tal:block define="referer request/HTTP_REFERER;\n+                       url_tool nocall:context/portal_url;\n+                       referer python:referer if referer and url_tool.isURLInPortal(referer) else \'\';">\n+    <a tal:attributes="href referer" tal:condition="referer">\n       <tal:block replace="structure context/@@images/image" />\n       <span i18n:translate="label_back_to_site">Back to site</span>\n     </a>\n-    <a tal:attributes="href context/portal_url" tal:condition="not: request/HTTP_REFERER">\n+    <a tal:attributes="href python:url_tool()" tal:condition="not: referer">\n       <tal:block replace="structure context/@@images/image" />\n       <span i18n:translate="label_home">Home</span>\n     </a>\n+  </tal:block>\n   </div>\n </body>\n \n'

