Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2023-05-15T12:22:45+02:00
Author: 1letter (1letter) <1letter@gmx.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/b8a16cb9813af4665b9805beb6805de0aeea6620

Update .gitignore

Files changed:
M .gitignore

b'diff --git a/.gitignore b/.gitignore\nindex f1dddbb2..59d8710d 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -30,3 +30,4 @@ docs/doctrees\n docs/html\n library-settings.txt\n pip-selfcheck.json\n+venv\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2023-05-15T13:05:05+02:00
Author: 1letter (1letter) <1letter@gmx.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/7e9fbadc615220ffc2e0fe3b50bb2c527942a593

Fix for #626

extends the the calculation of url if resolveuid part of link in LinkRedirectView

add a test

Files changed:
M plone/app/contenttypes/browser/link_redirect_view.py
M plone/app/contenttypes/tests/test_link.py

b'diff --git a/plone/app/contenttypes/browser/link_redirect_view.py b/plone/app/contenttypes/browser/link_redirect_view.py\nindex d780e96a..eee881ca 100644\n--- a/plone/app/contenttypes/browser/link_redirect_view.py\n+++ b/plone/app/contenttypes/browser/link_redirect_view.py\n@@ -108,6 +108,13 @@ def absolute_target_url(self):\n             context_state = self.context.restrictedTraverse("@@plone_context_state")\n             url = "/".join([context_state.canonical_object_url(), url])\n         else:\n+            if "resolveuid" in url:\n+                uid = url.split("/")[-1]\n+                obj = uuidToObject(uid)\n+                if obj:\n+                    url = "/".join(obj.getPhysicalPath()[2:])\n+                    if not url.startswith("/"):\n+                        url = "/" + url\n             if not url.startswith(("http://", "https://")):\n                 url = self.request["SERVER_URL"] + url\n \ndiff --git a/plone/app/contenttypes/tests/test_link.py b/plone/app/contenttypes/tests/test_link.py\nindex a7abb033..dd306c27 100644\n--- a/plone/app/contenttypes/tests/test_link.py\n+++ b/plone/app/contenttypes/tests/test_link.py\n@@ -365,3 +365,14 @@ def test_var_replacement_in_view(self):\n         self.link.remoteUrl = "${navigation_root_url}"\n         self.assertEqual(view.url(), "/plone")\n         self.assertEqual(view.absolute_target_url(), "http://nohost/plone")\n+\n+    def test_resolve_uid_to_absolute_target(self):\n+        view = getMultiAdapter((self.link, self.request), name="link_redirect_view")\n+\n+        self.portal.invokeFactory(\n+            "Document", "doc1", title="A document", description="This is a document."\n+        )\n+        doc1 = self.portal["doc1"]\n+        uid = IUUID(doc1)\n+        self.link.remoteUrl = f"${{portal_url}}/resolveuid/{uid}"\n+        self.assertEqual(view.absolute_target_url(), "http://nohost/doc1")\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2023-05-15T13:06:28+02:00
Author: 1letter (1letter) <1letter@gmx.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/aeecbcd77943838c01df7796e139df7442816807

add News

Files changed:
A news/626.bugfix

b'diff --git a/news/626.bugfix b/news/626.bugfix\nnew file mode 100644\nindex 000000000..c741bbe11\n--- /dev/null\n+++ b/news/626.bugfix\n@@ -0,0 +1 @@\n+extends the the calculation of url if resolveuid part of link in LinkRedirectView @1letter\n\\ No newline at end of file\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2023-05-17T01:55:04+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/229816c9a325b2b0bdd63b96e1f9c52f3278bfd8

Merge pull request #662 from plone/1letter/fix-#626

1letter/fix #626

Files changed:
A news/626.bugfix
M .gitignore
M plone/app/contenttypes/browser/link_redirect_view.py
M plone/app/contenttypes/tests/test_link.py

b'diff --git a/.gitignore b/.gitignore\nindex f1dddbb23..59d8710d5 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -30,3 +30,4 @@ docs/doctrees\n docs/html\n library-settings.txt\n pip-selfcheck.json\n+venv\ndiff --git a/news/626.bugfix b/news/626.bugfix\nnew file mode 100644\nindex 000000000..c741bbe11\n--- /dev/null\n+++ b/news/626.bugfix\n@@ -0,0 +1 @@\n+extends the the calculation of url if resolveuid part of link in LinkRedirectView @1letter\n\\ No newline at end of file\ndiff --git a/plone/app/contenttypes/browser/link_redirect_view.py b/plone/app/contenttypes/browser/link_redirect_view.py\nindex d780e96ad..eee881cae 100644\n--- a/plone/app/contenttypes/browser/link_redirect_view.py\n+++ b/plone/app/contenttypes/browser/link_redirect_view.py\n@@ -108,6 +108,13 @@ def absolute_target_url(self):\n             context_state = self.context.restrictedTraverse("@@plone_context_state")\n             url = "/".join([context_state.canonical_object_url(), url])\n         else:\n+            if "resolveuid" in url:\n+                uid = url.split("/")[-1]\n+                obj = uuidToObject(uid)\n+                if obj:\n+                    url = "/".join(obj.getPhysicalPath()[2:])\n+                    if not url.startswith("/"):\n+                        url = "/" + url\n             if not url.startswith(("http://", "https://")):\n                 url = self.request["SERVER_URL"] + url\n \ndiff --git a/plone/app/contenttypes/tests/test_link.py b/plone/app/contenttypes/tests/test_link.py\nindex a7abb0336..dd306c274 100644\n--- a/plone/app/contenttypes/tests/test_link.py\n+++ b/plone/app/contenttypes/tests/test_link.py\n@@ -365,3 +365,14 @@ def test_var_replacement_in_view(self):\n         self.link.remoteUrl = "${navigation_root_url}"\n         self.assertEqual(view.url(), "/plone")\n         self.assertEqual(view.absolute_target_url(), "http://nohost/plone")\n+\n+    def test_resolve_uid_to_absolute_target(self):\n+        view = getMultiAdapter((self.link, self.request), name="link_redirect_view")\n+\n+        self.portal.invokeFactory(\n+            "Document", "doc1", title="A document", description="This is a document."\n+        )\n+        doc1 = self.portal["doc1"]\n+        uid = IUUID(doc1)\n+        self.link.remoteUrl = f"${{portal_url}}/resolveuid/{uid}"\n+        self.assertEqual(view.absolute_target_url(), "http://nohost/doc1")\n'

