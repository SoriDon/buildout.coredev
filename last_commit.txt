Repository: plone.formwidget.namedfile


Branch: refs/heads/master
Date: 2021-06-28T09:01:42+02:00
Author: Harald Friessnegger (frisi) <friessnegger@lovelysystems.com>
Commit: https://github.com/plone/plone.formwidget.namedfile/commit/264121b7fb2cba0bf8ae4aaf70d9ffdad1640599

bugfix: do not lose file-upload after validation error

this fixes #46

Files changed:
A news/46.bugfix
M plone/formwidget/namedfile/converter.py
M plone/formwidget/namedfile/widget.rst

b'diff --git a/news/46.bugfix b/news/46.bugfix\nnew file mode 100644\nindex 0000000..62cb2f0\n--- /dev/null\n+++ b/news/46.bugfix\n@@ -0,0 +1 @@\n+Uploaded files are set on validation errors, see https://github.com/plone/plone.formwidget.namedfile/issues/46 [fRiSi]\n\\ No newline at end of file\ndiff --git a/plone/formwidget/namedfile/converter.py b/plone/formwidget/namedfile/converter.py\nindex d212c16..367c587 100644\n--- a/plone/formwidget/namedfile/converter.py\n+++ b/plone/formwidget/namedfile/converter.py\n@@ -26,7 +26,8 @@ def toWidgetValue(self, value):\n \n     def toFieldValue(self, value):\n         action = self.widget.request.get("%s.action" % self.widget.name, None)\n-        if action == "nochange":\n+        file_upload_id = self.widget.request.get("%s.file_upload_id" % self.widget.name, None) or 0\n+        if action == \'nochange\' and not file_upload_id:\n             return NOT_CHANGED\n \n         if value is None or value == "":\ndiff --git a/plone/formwidget/namedfile/widget.rst b/plone/formwidget/namedfile/widget.rst\nindex 0eb3060..c8715e0 100644\n--- a/plone/formwidget/namedfile/widget.rst\n+++ b/plone/formwidget/namedfile/widget.rst\n@@ -543,6 +543,20 @@ and the converter will always set the value to z3c.form.interfaces.NOT_CHANGED::\n   >>> image_converter.toFieldValue(u\'\') is NOT_CHANGED\n   True\n \n+On validation errors, file uploads are stored in a temporary storage. The id of the temporarily stored file is given\n+by file_upload_id and action is set to \'nochange\'.\n+The widget returns the temporary file on `extract` as Named[Blob](File|Image) and the dataconverter will simply use it\n+\n+    >>> file_widget.request.form[\'widget.name.file.action\'] = \'nochange\'\n+    >>> file_widget.request.form[\'widget.name.file.file_upload_id\'] = \'5c6cc90ce82941919daaeb62700e079a\'\n+    >>> file_converter.toFieldValue(NamedFile(data=b\'testfile\', filename=u\'test.txt\'))\n+    <plone.namedfile.file.NamedFile object at ...>\n+\n+    >>> image_widget.request.form[\'widget.name.file.action\'] = \'nochange\'\n+    >>> image_widget.request.form[\'widget.name.file.file_upload_id\'] = \'5c6cc90ce82941919daaeb62700e079a\'\n+    >>> file_converter.toFieldValue(NamedImage(data=b\'testimage\', filename=u\'test.jpg\'))\n+    <plone.namedfile.file.NamedImage object at ...>\n+\n \n The Base64Converter for Bytes fields\n ------------------------------------\n'

Repository: plone.formwidget.namedfile


Branch: refs/heads/master
Date: 2021-06-30T12:14:40+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.formwidget.namedfile/commit/d7ba6a06019ffa32eabd60b77a34eb8c06aea654

Better message

[skip ci]

Files changed:
M news/46.bugfix

b'diff --git a/news/46.bugfix b/news/46.bugfix\nindex 62cb2f0..c9102bf 100644\n--- a/news/46.bugfix\n+++ b/news/46.bugfix\n@@ -1 +1 @@\n-Uploaded files are set on validation errors, see https://github.com/plone/plone.formwidget.namedfile/issues/46 [fRiSi]\n\\ No newline at end of file\n+Fix issue where already uploaded images were lost when file validation error occurs (https://github.com/plone/plone.formwidget.namedfile/issues/46)  [fRiSi]\n'

Repository: plone.formwidget.namedfile


Branch: refs/heads/master
Date: 2021-07-02T12:24:30+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.formwidget.namedfile/commit/757a57ad938c6c2b2e4d37de0adc1446f104a38f

Merge pull request #51 from plone/frisi/fix-upload-on-validation-errors-master

bugfix: do not lose file-upload after validation error

Files changed:
A news/46.bugfix
M plone/formwidget/namedfile/converter.py
M plone/formwidget/namedfile/widget.rst

b'diff --git a/news/46.bugfix b/news/46.bugfix\nnew file mode 100644\nindex 0000000..c9102bf\n--- /dev/null\n+++ b/news/46.bugfix\n@@ -0,0 +1 @@\n+Fix issue where already uploaded images were lost when file validation error occurs (https://github.com/plone/plone.formwidget.namedfile/issues/46)  [fRiSi]\ndiff --git a/plone/formwidget/namedfile/converter.py b/plone/formwidget/namedfile/converter.py\nindex d212c16..367c587 100644\n--- a/plone/formwidget/namedfile/converter.py\n+++ b/plone/formwidget/namedfile/converter.py\n@@ -26,7 +26,8 @@ def toWidgetValue(self, value):\n \n     def toFieldValue(self, value):\n         action = self.widget.request.get("%s.action" % self.widget.name, None)\n-        if action == "nochange":\n+        file_upload_id = self.widget.request.get("%s.file_upload_id" % self.widget.name, None) or 0\n+        if action == \'nochange\' and not file_upload_id:\n             return NOT_CHANGED\n \n         if value is None or value == "":\ndiff --git a/plone/formwidget/namedfile/widget.rst b/plone/formwidget/namedfile/widget.rst\nindex 0eb3060..c8715e0 100644\n--- a/plone/formwidget/namedfile/widget.rst\n+++ b/plone/formwidget/namedfile/widget.rst\n@@ -543,6 +543,20 @@ and the converter will always set the value to z3c.form.interfaces.NOT_CHANGED::\n   >>> image_converter.toFieldValue(u\'\') is NOT_CHANGED\n   True\n \n+On validation errors, file uploads are stored in a temporary storage. The id of the temporarily stored file is given\n+by file_upload_id and action is set to \'nochange\'.\n+The widget returns the temporary file on `extract` as Named[Blob](File|Image) and the dataconverter will simply use it\n+\n+    >>> file_widget.request.form[\'widget.name.file.action\'] = \'nochange\'\n+    >>> file_widget.request.form[\'widget.name.file.file_upload_id\'] = \'5c6cc90ce82941919daaeb62700e079a\'\n+    >>> file_converter.toFieldValue(NamedFile(data=b\'testfile\', filename=u\'test.txt\'))\n+    <plone.namedfile.file.NamedFile object at ...>\n+\n+    >>> image_widget.request.form[\'widget.name.file.action\'] = \'nochange\'\n+    >>> image_widget.request.form[\'widget.name.file.file_upload_id\'] = \'5c6cc90ce82941919daaeb62700e079a\'\n+    >>> file_converter.toFieldValue(NamedImage(data=b\'testimage\', filename=u\'test.jpg\'))\n+    <plone.namedfile.file.NamedImage object at ...>\n+\n \n The Base64Converter for Bytes fields\n ------------------------------------\n'

