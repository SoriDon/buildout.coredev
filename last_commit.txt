Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-02-02T17:48:29+01:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/9b04ce2a427f592b2869f4b3c7e8b2e5c4814766

remove viewlet

Files changed:
A news/3416.bugfix
M Products/CMFPlone/browser/templates/main_template.pt
M Products/CMFPlone/profiles/default/viewlets.xml

b'diff --git a/Products/CMFPlone/browser/templates/main_template.pt b/Products/CMFPlone/browser/templates/main_template.pt\nindex dac3b37cd9..cdebe3b295 100644\n--- a/Products/CMFPlone/browser/templates/main_template.pt\n+++ b/Products/CMFPlone/browser/templates/main_template.pt\n@@ -56,6 +56,10 @@\n \n     <header id="portal-top" i18n:domain="plone">\n       <div tal:replace="structure provider:plone.portaltop" />\n+      <div id="portal-header">\n+        <div tal:replace="structure provider:plone.portalheader" />\n+      </div>\n+\n     </header>\n \n     <div id="portal-mainnavigation" tal:content="structure provider:plone.mainnavigation">\ndiff --git a/Products/CMFPlone/profiles/default/viewlets.xml b/Products/CMFPlone/profiles/default/viewlets.xml\nindex 7a9c503cbc..5622b3eb67 100644\n--- a/Products/CMFPlone/profiles/default/viewlets.xml\n+++ b/Products/CMFPlone/profiles/default/viewlets.xml\n@@ -1,7 +1,7 @@\n <?xml version="1.0"?>\n <object>\n   <order manager="plone.portaltop" skinname="Plone Default">\n-    <viewlet name="plone.header" />\n+\n   </order>\n   <order manager="plone.portalheader" skinname="Plone Default">\n     <viewlet name="plone.anontools" />\ndiff --git a/news/3416.bugfix b/news/3416.bugfix\nnew file mode 100644\nindex 0000000000..4cadd00894\n--- /dev/null\n+++ b/news/3416.bugfix\n@@ -0,0 +1,2 @@\n+Reorganize viewlets after removing the plone.header viewlet in plone.app.layout\n+[erral]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-02-04T08:47:19+01:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/99b0807a756bc8ef3bcf5a0d4aa320a635429a98

Merge branch 'master' into erral-remove-viewlet-in-viewlet

Files changed:
A Products/CMFPlone/browser/static/favicon.ico
A news/282.bugfix
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/browser/favicon.py
M Products/CMFPlone/interfaces/controlpanel.py
D Products/CMFPlone/skins/plone_images/favicon.ico

b'diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml\nindex f92dbef537..e9989aa94a 100644\n--- a/Products/CMFPlone/browser/configure.zcml\n+++ b/Products/CMFPlone/browser/configure.zcml\n@@ -33,8 +33,8 @@\n       />\n \n   <browser:page\n-      for="*"\n-      name="favicon"\n+      for="plone.app.layout.navigation.interfaces.INavigationRoot"\n+      name="favicon.ico"\n       class=".favicon.SiteFavicon"\n       permission="zope.Public"\n       />\ndiff --git a/Products/CMFPlone/browser/favicon.py b/Products/CMFPlone/browser/favicon.py\nindex 2753869081..a6812cfb84 100644\n--- a/Products/CMFPlone/browser/favicon.py\n+++ b/Products/CMFPlone/browser/favicon.py\n@@ -1,26 +1,41 @@\n from Products.CMFPlone.interfaces import ISiteSchema\n from plone.formwidget.namedfile.converter import b64decode_file\n-from plone.namedfile.browser import Download\n+from plone.memoize import ram\n+from plone.namedfile.browser import DisplayFile\n from plone.namedfile.file import NamedImage\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\n-from plone.memoize import ram\n+\n+import os.path\n \n \n-class SiteFavicon(Download):\n+class SiteFavicon(DisplayFile):\n+    # The following attribute disables the use of an allowlist that\n+    # would otherwise cause image/vnd.microsoft.icon MIMEtyped files\n+    # to be served as downloads.  This allowlist list is sadly not\n+    # complete, at the top of the plone.namedfile.browser.py, but\n+    # fixing that is beyond the scope of this pull request.\n+    use_denylist = True\n \n     def __init__(self, context, request):\n         super().__init__(context, request)\n-        self.filename = None\n-        self.data = None\n \n-        registry = getUtility(IRegistry)\n-        settings = registry.forInterface(ISiteSchema, prefix="plone")\n-        if getattr(settings, \'site_favicon\', False):\n+        mimetype = "image/vnd.microsoft.icon"\n+        settings = getUtility(IRegistry).forInterface(ISiteSchema, prefix="plone")\n+        if getattr(settings, "site_favicon", False):\n+            # The user has customized the favicon via the Site configlet.\n             filename, data = b64decode_file(settings.site_favicon)\n-            data = NamedImage(data=data, filename=filename)\n-            self.data = data\n-            self.filename = filename\n+            # Retrieve the MIME type auto-set by the configlet, with a\n+            # valid fallback to a well-known MIME type.\n+            mimetype = getattr(settings, "site_favicon_mimetype", mimetype)\n+        else:\n+            # No registry favicon, we use Plone\'s static copy here.\n+            filename = "favicon.ico"\n+            fallback_path = os.path.join(os.path.dirname(__file__), "static", filename)\n+            with open(fallback_path, "rb") as icon:\n+                data = icon.read()\n+        self.data = NamedImage(data=data, contentType=mimetype, filename=filename)\n+        self.filename = filename\n \n     def _getFile(self):\n         return self.data\ndiff --git a/Products/CMFPlone/skins/plone_images/favicon.ico b/Products/CMFPlone/browser/static/favicon.ico\nsimilarity index 100%\nrename from Products/CMFPlone/skins/plone_images/favicon.ico\nrename to Products/CMFPlone/browser/static/favicon.ico\ndiff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py\nindex 13c4139873..d79e8d13f7 100644\n--- a/Products/CMFPlone/interfaces/controlpanel.py\n+++ b/Products/CMFPlone/interfaces/controlpanel.py\n@@ -1009,7 +1009,7 @@ class ISiteSchema(Interface):\n         title=_(\'MIME type of the site favicon\'),\n         description=_(\'MIME type of the favicon (automatically set when a new favicon is uploaded)\'),\n         required=False,\n-        default=\'image/x-icon\'\n+        default=\'image/vnd.microsoft.icon\'\n     )\n \n     site_favicon = schema.Bytes(\ndiff --git a/news/282.bugfix b/news/282.bugfix\nnew file mode 100644\nindex 0000000000..10c579d2dc\n--- /dev/null\n+++ b/news/282.bugfix\n@@ -0,0 +1 @@\n+Handle /favicon.ico accesses on Plone sites.\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-02-09T17:43:57+01:00
Author: agitator (agitator) <agitator@users.noreply.github.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/a87e68527a9fd8a699ceb71aea81ba5c26f9e7ba

Merge branch 'master' into erral-remove-viewlet-in-viewlet

Files changed:
A news/3430.bugfix
M Products/CMFPlone/controlpanel/browser/quickinstaller.pt

b'diff --git a/Products/CMFPlone/controlpanel/browser/quickinstaller.pt b/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\nindex cba8e02fe2..9b694c0a25 100644\n--- a/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\n+++ b/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\n@@ -188,7 +188,7 @@\n               </div>\n               <div class="alert alert-info mt-2 mb-0"\n                   role="status"\n-                  tal:condition="not:product/uninstall_profile">                  >\n+                  tal:condition="not:product/uninstall_profile">\n                 <strong i18n:translate="">Info</strong>\n                 <span i18n:translate="">This product cannot be uninstalled!</span>\n             </div>\ndiff --git a/news/3430.bugfix b/news/3430.bugfix\nnew file mode 100644\nindex 0000000000..d2039c79f2\n--- /dev/null\n+++ b/news/3430.bugfix\n@@ -0,0 +1,2 @@\n+Fix info message (char left over) in quickinstaller template\n+[laulaz]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-02-09T17:57:13+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/f1f221c7e1ade43a3a6d4b820d3d2a2ef52172d5

Merge pull request #3416 from plone/erral-remove-viewlet-in-viewlet

remove viewlet

Files changed:
A news/3416.bugfix
M Products/CMFPlone/browser/templates/main_template.pt
M Products/CMFPlone/profiles/default/viewlets.xml

b'diff --git a/Products/CMFPlone/browser/templates/main_template.pt b/Products/CMFPlone/browser/templates/main_template.pt\nindex dac3b37cd9..cdebe3b295 100644\n--- a/Products/CMFPlone/browser/templates/main_template.pt\n+++ b/Products/CMFPlone/browser/templates/main_template.pt\n@@ -56,6 +56,10 @@\n \n     <header id="portal-top" i18n:domain="plone">\n       <div tal:replace="structure provider:plone.portaltop" />\n+      <div id="portal-header">\n+        <div tal:replace="structure provider:plone.portalheader" />\n+      </div>\n+\n     </header>\n \n     <div id="portal-mainnavigation" tal:content="structure provider:plone.mainnavigation">\ndiff --git a/Products/CMFPlone/profiles/default/viewlets.xml b/Products/CMFPlone/profiles/default/viewlets.xml\nindex 7a9c503cbc..5622b3eb67 100644\n--- a/Products/CMFPlone/profiles/default/viewlets.xml\n+++ b/Products/CMFPlone/profiles/default/viewlets.xml\n@@ -1,7 +1,7 @@\n <?xml version="1.0"?>\n <object>\n   <order manager="plone.portaltop" skinname="Plone Default">\n-    <viewlet name="plone.header" />\n+\n   </order>\n   <order manager="plone.portalheader" skinname="Plone Default">\n     <viewlet name="plone.anontools" />\ndiff --git a/news/3416.bugfix b/news/3416.bugfix\nnew file mode 100644\nindex 0000000000..4cadd00894\n--- /dev/null\n+++ b/news/3416.bugfix\n@@ -0,0 +1,2 @@\n+Reorganize viewlets after removing the plone.header viewlet in plone.app.layout\n+[erral]\n'

