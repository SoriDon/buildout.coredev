Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2018-05-18T11:42:58+02:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/ec876ea815d441a1ade0b39ef1e7fe8ca92c4f63

use recent Zope WSGI changes

Files changed:
M src/plone/recipe/zope2instance/recipe.py
D src/plone/recipe/zope2instance/wsgi.py

diff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py
index 5dd6ad9..672f25f 100644
--- a/src/plone/recipe/zope2instance/recipe.py
+++ b/src/plone/recipe/zope2instance/recipe.py
@@ -611,7 +611,7 @@ def install_scripts(self):
         requirements, ws = self.egg.working_set(['plone.recipe.zope2instance'])
         reqs = [self.options.get('control-script', self.name)]
         if self.wsgi:
-            reqs.extend(['plone.recipe.zope2instance.wsgi', 'waitress_main'])
+            reqs.extend(['Zope2.Startup.serve', 'main'])
         else:
             reqs.extend(['plone.recipe.zope2instance.ctl', 'main'])
         reqs = [tuple(reqs)]
diff --git a/src/plone/recipe/zope2instance/wsgi.py b/src/plone/recipe/zope2instance/wsgi.py
deleted file mode 100644
index 20783f7..0000000
--- a/src/plone/recipe/zope2instance/wsgi.py
+++ /dev/null
@@ -1,21 +0,0 @@
-from paste.deploy.loadwsgi import APP
-from paste.deploy.loadwsgi import ConfigLoader
-from paste.deploy.loadwsgi import SERVER
-from Zope2.Startup.run import make_wsgi_app
-
-
-def waitress_main(args=None):
-    """
-    Configure + start Plone behind waitress from the given PasteDeploy
-    configuration
-    Waitress - unlike uwsgi - expects us to do the
-    PasteDeploy stuff on our own.
-    """
-    ini_filename = args[-1]
-    config_loader = ConfigLoader(ini_filename)
-    server_config = config_loader.get_context(SERVER)
-    serve = server_config.create()
-    app_config = config_loader.get_context(APP)
-    zope_conf = app_config.local_conf['zope_conf']
-    wsgiapp = make_wsgi_app(app_config.global_conf, zope_conf)
-    serve(wsgiapp)


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2018-05-18T11:52:03+02:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/c5b705212b7cade004f3e5114b94bd5f7f3354bb

update changelog

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 1913794..6555c82 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -20,6 +20,9 @@ Bug fixes:
 - Move Recipe from __init__.py to a new module to get rid of the dependency on
   zc.recipe.egg in control scripts
   [tschorr]
+- Make use of changes to Zope WSGI logging (https://github.com/zopefoundation/Zope/pull/280,
+  https://github.com/zopefoundation/Zope/pull/276), use Zope2 WSGI startup code.
+  [tschorr]
 
 
 5.0.0 (2018-01-27)


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2018-05-22T12:36:26+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/100f8ca38fbce0b478feeec75d87d06d7e0527ad

Merge pull request #44 from plone/refactor_wsgi

use recent Zope WSGI changes

Files changed:
M CHANGES.rst
M src/plone/recipe/zope2instance/recipe.py
D src/plone/recipe/zope2instance/wsgi.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1913794..6555c82 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -20,6 +20,9 @@ Bug fixes:
 - Move Recipe from __init__.py to a new module to get rid of the dependency on
   zc.recipe.egg in control scripts
   [tschorr]
+- Make use of changes to Zope WSGI logging (https://github.com/zopefoundation/Zope/pull/280,
+  https://github.com/zopefoundation/Zope/pull/276), use Zope2 WSGI startup code.
+  [tschorr]
 
 
 5.0.0 (2018-01-27)
diff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py
index 5dd6ad9..672f25f 100644
--- a/src/plone/recipe/zope2instance/recipe.py
+++ b/src/plone/recipe/zope2instance/recipe.py
@@ -611,7 +611,7 @@ def install_scripts(self):
         requirements, ws = self.egg.working_set(['plone.recipe.zope2instance'])
         reqs = [self.options.get('control-script', self.name)]
         if self.wsgi:
-            reqs.extend(['plone.recipe.zope2instance.wsgi', 'waitress_main'])
+            reqs.extend(['Zope2.Startup.serve', 'main'])
         else:
             reqs.extend(['plone.recipe.zope2instance.ctl', 'main'])
         reqs = [tuple(reqs)]
diff --git a/src/plone/recipe/zope2instance/wsgi.py b/src/plone/recipe/zope2instance/wsgi.py
deleted file mode 100644
index 20783f7..0000000
--- a/src/plone/recipe/zope2instance/wsgi.py
+++ /dev/null
@@ -1,21 +0,0 @@
-from paste.deploy.loadwsgi import APP
-from paste.deploy.loadwsgi import ConfigLoader
-from paste.deploy.loadwsgi import SERVER
-from Zope2.Startup.run import make_wsgi_app
-
-
-def waitress_main(args=None):
-    """
-    Configure + start Plone behind waitress from the given PasteDeploy
-    configuration
-    Waitress - unlike uwsgi - expects us to do the
-    PasteDeploy stuff on our own.
-    """
-    ini_filename = args[-1]
-    config_loader = ConfigLoader(ini_filename)
-    server_config = config_loader.get_context(SERVER)
-    serve = server_config.create()
-    app_config = config_loader.get_context(APP)
-    zope_conf = app_config.local_conf['zope_conf']
-    wsgiapp = make_wsgi_app(app_config.global_conf, zope_conf)
-    serve(wsgiapp)


