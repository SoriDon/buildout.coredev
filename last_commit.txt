Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2019-06-14T16:46:19+02:00
Author: Rodrigo Ferreira de Souza (rodfersou) <rodfersou@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/da7b2800486a6c4dfcb7e56c78a2b553a38e80c1

Support ILeadImage behavior when display collections

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/collection.py
M plone/app/contenttypes/browser/folder.py
M plone/app/contenttypes/browser/templates/listing_album.pt

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 68e8e713..216d68b0 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -17,6 +17,13 @@ Bug fixes:\n - Move dotted behaviors to named behaviors. [iham] (#519)\n \n \n+New features:\n+\n+\n+- Support ILeadImage behavior when display collection album view.\n+  [rodfersou]\n+\n+\n 2.0.4 (2019-04-29)\n ------------------\n \ndiff --git a/plone/app/contenttypes/browser/collection.py b/plone/app/contenttypes/browser/collection.py\nindex fea264b7..a41b6959 100644\n--- a/plone/app/contenttypes/browser/collection.py\n+++ b/plone/app/contenttypes/browser/collection.py\n@@ -2,6 +2,7 @@\n from Acquisition import aq_inner\n from plone.app.contenttypes import _\n from plone.app.contenttypes.behaviors.collection import ICollection\n+from plone.app.contenttypes.behaviors.leadimage import ILeadImage\n from plone.app.contenttypes.browser.folder import FolderView\n from plone.app.contenttypes.interfaces import IFolder\n from plone.app.contenttypes.interfaces import IImage\n@@ -56,10 +57,11 @@ def _album_results(self):\n         for it in results:\n             # TODO: potentially expensive!\n             ob = it.getObject()\n-            if IImage.providedBy(ob):\n-                images.append(it)\n-            elif IFolder.providedBy(ob):\n+            if IFolder.providedBy(ob):\n                 folders.append(it)\n+            elif IImage.providedBy(ob) or \\\n+                 ILeadImage.providedBy(ob):\n+                images.append(it)\n         return {\'images\': images, \'folders\': folders}\n \n     @property\ndiff --git a/plone/app/contenttypes/browser/folder.py b/plone/app/contenttypes/browser/folder.py\nindex 9b77f6b7..99fdd13a 100644\n--- a/plone/app/contenttypes/browser/folder.py\n+++ b/plone/app/contenttypes/browser/folder.py\n@@ -1,13 +1,14 @@\n # -*- coding: utf-8 -*-\n from Acquisition import aq_base\n from Acquisition import aq_inner\n-from Products.CMFPlone.interfaces import ISiteSchema\n from plone.app.contenttypes import _\n+from plone.app.contenttypes.behaviors.leadimage import ILeadImage\n from plone.app.contenttypes.interfaces import IFolder\n from plone.app.contenttypes.interfaces import IImage\n from plone.event.interfaces import IEvent\n from plone.memoize.view import memoize\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.interfaces import ISiteSchema\n from Products.CMFPlone.PloneBatch import Batch\n from Products.CMFPlone.utils import safe_callable\n from Products.Five import BrowserView\n@@ -207,9 +208,13 @@ def formatted_date(self, item):\n     def album_images(self):\n         """Get all images within this folder.\n         """\n+        provides = [\n+            IImage.__identifier__,\n+            ILeadImage.__identifier__,\n+        ]\n         images = self.results(\n             batch=False,\n-            object_provides=IImage.__identifier__\n+            object_provides=provides\n         )\n         return images\n \ndiff --git a/plone/app/contenttypes/browser/templates/listing_album.pt b/plone/app/contenttypes/browser/templates/listing_album.pt\nindex 1f0d6089..1b517bc7 100644\n--- a/plone/app/contenttypes/browser/templates/listing_album.pt\n+++ b/plone/app/contenttypes/browser/templates/listing_album.pt\n@@ -24,11 +24,13 @@\n       tal:define="portal context/@@plone_portal_state/portal;\n                   image_scale portal/@@image_scale">\n   <tal:images tal:repeat="image images">\n-    <div class="photoAlbumEntry">\n+    <div class="photoAlbumEntry"\n+         tal:define="scale python:image_scale.tag(image, \'image\', scale=\'thumb\')"\n+         tal:condition="scale">\n       <a tal:attributes="href string:${image/getURL}/view;\n                          title image/Description">\n         <span class="photoAlbumEntryWrapper">\n-          <img tal:replace="structure python:image_scale.tag(image, \'image\', scale=\'thumb\')" />\n+          <img tal:replace="structure scale" />\n         </span>\n         <span class="photoAlbumEntryTitle" tal:content="image/Title">\n             Title\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2019-06-14T16:48:47+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/64b0e5f6d2059a12b495c329e886efe81c8754c0

Put changelog entry in news snippet.

Files changed:
A news/524.feature
M CHANGES.rst
M news/522.bugfix

b"diff --git a/CHANGES.rst b/CHANGES.rst\nindex 216d68b0..68e8e713 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -17,13 +17,6 @@ Bug fixes:\n - Move dotted behaviors to named behaviors. [iham] (#519)\n \n \n-New features:\n-\n-\n-- Support ILeadImage behavior when display collection album view.\n-  [rodfersou]\n-\n-\n 2.0.4 (2019-04-29)\n ------------------\n \ndiff --git a/news/522.bugfix b/news/522.bugfix\nindex 2278b62d..d91df98b 100644\n--- a/news/522.bugfix\n+++ b/news/522.bugfix\n@@ -1,3 +1,2 @@\n-- Use the shared 'Plone test setup' and 'Plone test teardown' keywords in Robot\n-  tests.\n-  [Rotonen]\n+Use the shared 'Plone test setup' and 'Plone test teardown' keywords in Robot tests.\n+[Rotonen]\ndiff --git a/news/524.feature b/news/524.feature\nnew file mode 100644\nindex 00000000..9a460fdb\n--- /dev/null\n+++ b/news/524.feature\n@@ -0,0 +1,2 @@\n+Support ILeadImage behavior when display collection album view.\n+[rodfersou]\n"

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2019-06-14T16:49:14+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/a7151ac5670e3bd896213e6eb1ff65bd0926c773

Fixed robot test for collection album view.

'Test Image' used to appear three times:
- in the navigation
- as its own
- as image of the Test Folder
The first two are still there.
The last usually not, because with our leadimage changes, the Test News Item is usually picked as sample image for the Test Folder.
Which image is picked for that, does not seem entirely stable, but that is okay.
We look only for 'Test Image' as image title in a photoAlbumEntry which is not also a photoAlbumFolder.
That is what we already did for the other images, which also had a chance of being picked as sample image of their folder.

Files changed:
M plone/app/contenttypes/tests/robot/test_folderlisting.robot

b'diff --git a/plone/app/contenttypes/tests/robot/test_folderlisting.robot b/plone/app/contenttypes/tests/robot/test_folderlisting.robot\nindex 22b2bb11..4fa9075f 100644\n--- a/plone/app/contenttypes/tests/robot/test_folderlisting.robot\n+++ b/plone/app/contenttypes/tests/robot/test_folderlisting.robot\n@@ -161,7 +161,9 @@ Listing should list all content in detail\n \n Album should list all images and albums\n   Page Should Contain  Test Image\n-  Xpath Should Match X Times  //img[@title="Test Image"]  3\n+  Xpath Should Match X Times  //div[@class="photoAlbumEntry" and not(@class="photoAlbumFolder")]//img[@title="Test Image"]  1\n+  Page Should Contain  Test News Item\n+  Xpath Should Match X Times  //div[@class="photoAlbumEntry" and not(@class="photoAlbumFolder")]//img[@title="Test News Item"]  1\n   Page Should Contain  Test Album Image 1\n   Xpath Should Match X Times  //div[@class="photoAlbumEntry" and not(@class="photoAlbumFolder")]//img[@title="Test Album Image 1"]  1\n   Page Should Contain  Test Album Image 2\n@@ -176,7 +178,7 @@ Album should list all images and albums\n   Xpath Should Match X Times  //div[@class="photoAlbumEntry" and not(@class="photoAlbumFolder")]//img[@title="Test Sub Album Image 3"]  1\n   Page Should Contain  Test Album\n   Page Should Contain  Test Sub Album\n-\n+  Page Should Contain  Test Folder\n \n \n Setup Testcontent\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2019-06-14T18:14:20+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/faed5de9ad46a155a386eb2c71f7b1258d856135

Merge pull request #524 from plone/collection-lead-image-master

Support ILeadImage behavior when display collections

Files changed:
A news/524.feature
M news/522.bugfix
M plone/app/contenttypes/browser/collection.py
M plone/app/contenttypes/browser/folder.py
M plone/app/contenttypes/browser/templates/listing_album.pt
M plone/app/contenttypes/tests/robot/test_folderlisting.robot

b'diff --git a/news/522.bugfix b/news/522.bugfix\nindex 2278b62d..d91df98b 100644\n--- a/news/522.bugfix\n+++ b/news/522.bugfix\n@@ -1,3 +1,2 @@\n-- Use the shared \'Plone test setup\' and \'Plone test teardown\' keywords in Robot\n-  tests.\n-  [Rotonen]\n+Use the shared \'Plone test setup\' and \'Plone test teardown\' keywords in Robot tests.\n+[Rotonen]\ndiff --git a/news/524.feature b/news/524.feature\nnew file mode 100644\nindex 00000000..9a460fdb\n--- /dev/null\n+++ b/news/524.feature\n@@ -0,0 +1,2 @@\n+Support ILeadImage behavior when display collection album view.\n+[rodfersou]\ndiff --git a/plone/app/contenttypes/browser/collection.py b/plone/app/contenttypes/browser/collection.py\nindex fea264b7..a41b6959 100644\n--- a/plone/app/contenttypes/browser/collection.py\n+++ b/plone/app/contenttypes/browser/collection.py\n@@ -2,6 +2,7 @@\n from Acquisition import aq_inner\n from plone.app.contenttypes import _\n from plone.app.contenttypes.behaviors.collection import ICollection\n+from plone.app.contenttypes.behaviors.leadimage import ILeadImage\n from plone.app.contenttypes.browser.folder import FolderView\n from plone.app.contenttypes.interfaces import IFolder\n from plone.app.contenttypes.interfaces import IImage\n@@ -56,10 +57,11 @@ def _album_results(self):\n         for it in results:\n             # TODO: potentially expensive!\n             ob = it.getObject()\n-            if IImage.providedBy(ob):\n-                images.append(it)\n-            elif IFolder.providedBy(ob):\n+            if IFolder.providedBy(ob):\n                 folders.append(it)\n+            elif IImage.providedBy(ob) or \\\n+                 ILeadImage.providedBy(ob):\n+                images.append(it)\n         return {\'images\': images, \'folders\': folders}\n \n     @property\ndiff --git a/plone/app/contenttypes/browser/folder.py b/plone/app/contenttypes/browser/folder.py\nindex 9b77f6b7..99fdd13a 100644\n--- a/plone/app/contenttypes/browser/folder.py\n+++ b/plone/app/contenttypes/browser/folder.py\n@@ -1,13 +1,14 @@\n # -*- coding: utf-8 -*-\n from Acquisition import aq_base\n from Acquisition import aq_inner\n-from Products.CMFPlone.interfaces import ISiteSchema\n from plone.app.contenttypes import _\n+from plone.app.contenttypes.behaviors.leadimage import ILeadImage\n from plone.app.contenttypes.interfaces import IFolder\n from plone.app.contenttypes.interfaces import IImage\n from plone.event.interfaces import IEvent\n from plone.memoize.view import memoize\n from plone.registry.interfaces import IRegistry\n+from Products.CMFPlone.interfaces import ISiteSchema\n from Products.CMFPlone.PloneBatch import Batch\n from Products.CMFPlone.utils import safe_callable\n from Products.Five import BrowserView\n@@ -207,9 +208,13 @@ def formatted_date(self, item):\n     def album_images(self):\n         """Get all images within this folder.\n         """\n+        provides = [\n+            IImage.__identifier__,\n+            ILeadImage.__identifier__,\n+        ]\n         images = self.results(\n             batch=False,\n-            object_provides=IImage.__identifier__\n+            object_provides=provides\n         )\n         return images\n \ndiff --git a/plone/app/contenttypes/browser/templates/listing_album.pt b/plone/app/contenttypes/browser/templates/listing_album.pt\nindex 1f0d6089..1b517bc7 100644\n--- a/plone/app/contenttypes/browser/templates/listing_album.pt\n+++ b/plone/app/contenttypes/browser/templates/listing_album.pt\n@@ -24,11 +24,13 @@\n       tal:define="portal context/@@plone_portal_state/portal;\n                   image_scale portal/@@image_scale">\n   <tal:images tal:repeat="image images">\n-    <div class="photoAlbumEntry">\n+    <div class="photoAlbumEntry"\n+         tal:define="scale python:image_scale.tag(image, \'image\', scale=\'thumb\')"\n+         tal:condition="scale">\n       <a tal:attributes="href string:${image/getURL}/view;\n                          title image/Description">\n         <span class="photoAlbumEntryWrapper">\n-          <img tal:replace="structure python:image_scale.tag(image, \'image\', scale=\'thumb\')" />\n+          <img tal:replace="structure scale" />\n         </span>\n         <span class="photoAlbumEntryTitle" tal:content="image/Title">\n             Title\ndiff --git a/plone/app/contenttypes/tests/robot/test_folderlisting.robot b/plone/app/contenttypes/tests/robot/test_folderlisting.robot\nindex 22b2bb11..4fa9075f 100644\n--- a/plone/app/contenttypes/tests/robot/test_folderlisting.robot\n+++ b/plone/app/contenttypes/tests/robot/test_folderlisting.robot\n@@ -161,7 +161,9 @@ Listing should list all content in detail\n \n Album should list all images and albums\n   Page Should Contain  Test Image\n-  Xpath Should Match X Times  //img[@title="Test Image"]  3\n+  Xpath Should Match X Times  //div[@class="photoAlbumEntry" and not(@class="photoAlbumFolder")]//img[@title="Test Image"]  1\n+  Page Should Contain  Test News Item\n+  Xpath Should Match X Times  //div[@class="photoAlbumEntry" and not(@class="photoAlbumFolder")]//img[@title="Test News Item"]  1\n   Page Should Contain  Test Album Image 1\n   Xpath Should Match X Times  //div[@class="photoAlbumEntry" and not(@class="photoAlbumFolder")]//img[@title="Test Album Image 1"]  1\n   Page Should Contain  Test Album Image 2\n@@ -176,7 +178,7 @@ Album should list all images and albums\n   Xpath Should Match X Times  //div[@class="photoAlbumEntry" and not(@class="photoAlbumFolder")]//img[@title="Test Sub Album Image 3"]  1\n   Page Should Contain  Test Album\n   Page Should Contain  Test Sub Album\n-\n+  Page Should Contain  Test Folder\n \n \n Setup Testcontent\n'

