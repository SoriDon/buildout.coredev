Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-03-05T01:11:51+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/1fefd1d04386a90db26bb4c8f90e983886cdf767

In the combine-bundles import step do not set Content Type header.

It would be set to application/javascript.  This would result
in the plone-upgrade result page being shown in plain text.

Fixes #1436

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/exportimport/bundles.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1e98d03..f199eb4 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,7 +18,11 @@ New:
 
 Fixes:
 
-- *add item here*
+- In the ``combine-bundles`` import step, make sure the Content Type
+  header is not set to ``application/javascript``.  This would result
+  in the ``plone-upgrade`` result page being shown in plain text.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/1436
+  [maurits]
 
 
 5.0.3c1 (2016-03-02)
diff --git a/Products/CMFPlone/resources/exportimport/bundles.py b/Products/CMFPlone/resources/exportimport/bundles.py
index a51042c..756474b 100644
--- a/Products/CMFPlone/resources/exportimport/bundles.py
+++ b/Products/CMFPlone/resources/exportimport/bundles.py
@@ -1,5 +1,6 @@
 from plone.registry.interfaces import IRegistry
 from zope.component import queryUtility
+from zope.globalrequest import getRequest
 
 from ..browser.combine import combine_bundles
 
@@ -16,4 +17,20 @@ def combine(context):
     body = context.readDataFile('registry.xml')
     if body and "IBundleRegistry" in body:
         site = context.getSite()
+        # Calling combine_bundles will have as side effect that the
+        # Content-Type header of the response is set to application/javascript,
+        # which we do not want.  So we reset it to the original at the end.
+        site = context.getSite()
+        request = getattr(site, 'REQUEST', getRequest())
+        if request is not None:
+            # Easily happens in tests.
+            orig_header = request.response.getHeader('Content-Type')
         combine_bundles(site)
+        if request is not None:
+            new_header = request.response.getHeader('Content-Type')
+            if new_header != orig_header:
+                if orig_header is None:
+                    # Setting it to None would result in the string 'None'.
+                    # So pick a saner one.
+                    orig_header = 'text/html'
+                request.response.setHeader('Content-Type', orig_header)


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-03-05T14:03:10+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.forcada@freitag.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/7d7db32a2289ea6f4c128bb146f60263efa6fd22

Merge pull request #1438 from plone/maurits-issue-1436

In the combine-bundles import step do not set Content Type header.

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/exportimport/bundles.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1e98d03..f199eb4 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,7 +18,11 @@ New:
 
 Fixes:
 
-- *add item here*
+- In the ``combine-bundles`` import step, make sure the Content Type
+  header is not set to ``application/javascript``.  This would result
+  in the ``plone-upgrade`` result page being shown in plain text.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/1436
+  [maurits]
 
 
 5.0.3c1 (2016-03-02)
diff --git a/Products/CMFPlone/resources/exportimport/bundles.py b/Products/CMFPlone/resources/exportimport/bundles.py
index a51042c..756474b 100644
--- a/Products/CMFPlone/resources/exportimport/bundles.py
+++ b/Products/CMFPlone/resources/exportimport/bundles.py
@@ -1,5 +1,6 @@
 from plone.registry.interfaces import IRegistry
 from zope.component import queryUtility
+from zope.globalrequest import getRequest
 
 from ..browser.combine import combine_bundles
 
@@ -16,4 +17,20 @@ def combine(context):
     body = context.readDataFile('registry.xml')
     if body and "IBundleRegistry" in body:
         site = context.getSite()
+        # Calling combine_bundles will have as side effect that the
+        # Content-Type header of the response is set to application/javascript,
+        # which we do not want.  So we reset it to the original at the end.
+        site = context.getSite()
+        request = getattr(site, 'REQUEST', getRequest())
+        if request is not None:
+            # Easily happens in tests.
+            orig_header = request.response.getHeader('Content-Type')
         combine_bundles(site)
+        if request is not None:
+            new_header = request.response.getHeader('Content-Type')
+            if new_header != orig_header:
+                if orig_header is None:
+                    # Setting it to None would result in the string 'None'.
+                    # So pick a saner one.
+                    orig_header = 'text/html'
+                request.response.setHeader('Content-Type', orig_header)


