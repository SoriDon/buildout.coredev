Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-11-29T16:49:55+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/aa7c960e1676d6d0445461f68f3e333073b4527c

Improve error status code in new vocabularies endpoint refactor (#1285)

* Improve error status code in new vocabularies endpoint refactor

* Fix test

Files changed:
A news/1284.bugfix
M src/plone/restapi/services/vocabularies/get.py
M src/plone/restapi/tests/test_services_vocabularies.py

b'diff --git a/news/1284.bugfix b/news/1284.bugfix\nnew file mode 100644\nindex 000000000..c477e2477\n--- /dev/null\n+++ b/news/1284.bugfix\n@@ -0,0 +1,2 @@\n+Improve error status code in vocabularies endpoint refactor\n+[sneridagh]\ndiff --git a/src/plone/restapi/services/vocabularies/get.py b/src/plone/restapi/services/vocabularies/get.py\nindex 9b67ca178..10c3cc5d4 100644\n--- a/src/plone/restapi/services/vocabularies/get.py\n+++ b/src/plone/restapi/services/vocabularies/get.py\n@@ -1,11 +1,9 @@\n from AccessControl import getSecurityManager\n-\n-\n from plone.app.content.browser.vocabulary import DEFAULT_PERMISSION\n from plone.app.content.browser.vocabulary import PERMISSIONS\n-\n from plone.restapi.interfaces import ISerializeToJson\n from plone.restapi.services import Service\n+from Products.CMFCore.utils import getToolByName\n from zope.component import ComponentLookupError\n from zope.component import getMultiAdapter\n from zope.component import getUtilitiesFor\n@@ -60,15 +58,26 @@ def reply(self):\n \n         # return single vocabulary by name\n         vocabulary_name = self.params[0]\n+        pm = getToolByName(self.context, "portal_membership")\n         if not self._has_permission_to_access_vocabulary(vocabulary_name):\n-            return self._error(\n-                403,\n-                "Not authorized",\n-                (\n-                    f"You are not authorized to access "\n-                    f"the vocabulary \'{vocabulary_name}\'."\n-                ),\n-            )\n+            if bool(pm.isAnonymousUser()):\n+                return self._error(\n+                    401,\n+                    "Not authenticated",\n+                    (\n+                        f"You need to be authenticated to access "\n+                        f"the vocabulary \'{vocabulary_name}\'."\n+                    ),\n+                )\n+            else:\n+                return self._error(\n+                    403,\n+                    "Not authorized",\n+                    (\n+                        f"You are not authorized to access "\n+                        f"the vocabulary \'{vocabulary_name}\'."\n+                    ),\n+                )\n \n         try:\n             factory = getUtility(IVocabularyFactory, name=vocabulary_name)\ndiff --git a/src/plone/restapi/tests/test_services_vocabularies.py b/src/plone/restapi/tests/test_services_vocabularies.py\nindex 4aa1437ca..004215279 100644\n--- a/src/plone/restapi/tests/test_services_vocabularies.py\n+++ b/src/plone/restapi/tests/test_services_vocabularies.py\n@@ -139,10 +139,12 @@ def test_get_builtin_vocabulary(self):\n         # test Anonymous\n         setRoles(self.portal, TEST_USER_ID, ["Anonymous"])\n         transaction.commit()\n+\n+        self.api_session.auth = ()\n         response = self.api_session.get(\n             "/@vocabularies/plone.app.vocabularies.Keywords"\n         )\n-        self.assertEqual(403, response.status_code)\n+        self.assertEqual(401, response.status_code)\n \n     def test_get_vocabulary_batched(self):\n         response = self.api_session.get(\n'

