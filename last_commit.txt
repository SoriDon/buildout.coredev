Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2019-07-29T18:44:37+02:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.app.multilingual/commit/4275cac61145b9254963ed336920c5adf1bb0da7

add/update translation forms doesn't show error return from z3c form validation

Files changed:
A news/360.bugfix
M src/plone/app/multilingual/browser/modify.py
M src/plone/app/multilingual/browser/update.py

b'diff --git a/news/360.bugfix b/news/360.bugfix\nnew file mode 100644\nindex 00000000..afa3ce9b\n--- /dev/null\n+++ b/news/360.bugfix\n@@ -0,0 +1,2 @@\n+add/update translation forms doesn\'t show error return from z3c form validation\n+[mamico]\ndiff --git a/src/plone/app/multilingual/browser/modify.py b/src/plone/app/multilingual/browser/modify.py\nindex 152545e5..bd2cb694 100644\n--- a/src/plone/app/multilingual/browser/modify.py\n+++ b/src/plone/app/multilingual/browser/modify.py\n@@ -48,16 +48,18 @@ class ConnectTranslation(AutoExtensibleForm, Form):\n                                default=u"Connect translation"))\n     def handle_add(self, action):\n         data, errors = self.extractData()\n-        if not errors:\n-            content = data[\'content\']\n-            language = data[\'language\']\n-            ILanguage(content).set_language(language)\n-            itm = ITranslationManager(self.context)\n-            # the \'register_translation\'-method takes content OR\n-            # UUID as second parameter. We need to use the UUID\n-            # here because otherwise the catalog can\'t be acquired\n-            # and the translation index is not updated\n-            itm.register_translation(language, IUUID(content))\n+        if errors:\n+            self.status = self.formErrorsMessage\n+            return\n+        content = data[\'content\']\n+        language = data[\'language\']\n+        ILanguage(content).set_language(language)\n+        itm = ITranslationManager(self.context)\n+        # the \'register_translation\'-method takes content OR\n+        # UUID as second parameter. We need to use the UUID\n+        # here because otherwise the catalog can\'t be acquired\n+        # and the translation index is not updated\n+        itm.register_translation(language, IUUID(content))\n         return self.request.response.redirect(\n             self.context.absolute_url() + \'/modify_translations\')\n \ndiff --git a/src/plone/app/multilingual/browser/update.py b/src/plone/app/multilingual/browser/update.py\nindex 9b309665..2831e787 100644\n--- a/src/plone/app/multilingual/browser/update.py\n+++ b/src/plone/app/multilingual/browser/update.py\n@@ -20,12 +20,14 @@ class UpdateLanguageForm(form.Form):\n     @button.buttonAndHandler(_(u"update_language", default=u"Update Language"))\n     def handle_update(self, action):\n         data, errors = self.extractData()\n-        new_object = self.context\n+        if errors:\n+            self.status = self.formErrorsMessage\n+            return\n \n-        if not errors:\n-            language = data[\'language\']\n-            # We need to move the object to its place!!\n-            new_object = multilingualMoveObject(self.context, language)\n+        new_object = self.context\n+        language = data[\'language\']\n+        # We need to move the object to its place!!\n+        new_object = multilingualMoveObject(self.context, language)\n \n         return self.request.response.redirect(\n             new_object.absolute_url() + \'?set_language=\' + language)\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2019-07-31T16:38:18+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/edf443c21718c8288c840d96137ad6a9fbb56de3

Merge pull request #360 from mamico/master

add/update translation forms doesn't show z3c form validation errors

Files changed:
A news/360.bugfix
M src/plone/app/multilingual/browser/modify.py
M src/plone/app/multilingual/browser/update.py

b'diff --git a/news/360.bugfix b/news/360.bugfix\nnew file mode 100644\nindex 00000000..afa3ce9b\n--- /dev/null\n+++ b/news/360.bugfix\n@@ -0,0 +1,2 @@\n+add/update translation forms doesn\'t show error return from z3c form validation\n+[mamico]\ndiff --git a/src/plone/app/multilingual/browser/modify.py b/src/plone/app/multilingual/browser/modify.py\nindex 152545e5..bd2cb694 100644\n--- a/src/plone/app/multilingual/browser/modify.py\n+++ b/src/plone/app/multilingual/browser/modify.py\n@@ -48,16 +48,18 @@ class ConnectTranslation(AutoExtensibleForm, Form):\n                                default=u"Connect translation"))\n     def handle_add(self, action):\n         data, errors = self.extractData()\n-        if not errors:\n-            content = data[\'content\']\n-            language = data[\'language\']\n-            ILanguage(content).set_language(language)\n-            itm = ITranslationManager(self.context)\n-            # the \'register_translation\'-method takes content OR\n-            # UUID as second parameter. We need to use the UUID\n-            # here because otherwise the catalog can\'t be acquired\n-            # and the translation index is not updated\n-            itm.register_translation(language, IUUID(content))\n+        if errors:\n+            self.status = self.formErrorsMessage\n+            return\n+        content = data[\'content\']\n+        language = data[\'language\']\n+        ILanguage(content).set_language(language)\n+        itm = ITranslationManager(self.context)\n+        # the \'register_translation\'-method takes content OR\n+        # UUID as second parameter. We need to use the UUID\n+        # here because otherwise the catalog can\'t be acquired\n+        # and the translation index is not updated\n+        itm.register_translation(language, IUUID(content))\n         return self.request.response.redirect(\n             self.context.absolute_url() + \'/modify_translations\')\n \ndiff --git a/src/plone/app/multilingual/browser/update.py b/src/plone/app/multilingual/browser/update.py\nindex 9b309665..2831e787 100644\n--- a/src/plone/app/multilingual/browser/update.py\n+++ b/src/plone/app/multilingual/browser/update.py\n@@ -20,12 +20,14 @@ class UpdateLanguageForm(form.Form):\n     @button.buttonAndHandler(_(u"update_language", default=u"Update Language"))\n     def handle_update(self, action):\n         data, errors = self.extractData()\n-        new_object = self.context\n+        if errors:\n+            self.status = self.formErrorsMessage\n+            return\n \n-        if not errors:\n-            language = data[\'language\']\n-            # We need to move the object to its place!!\n-            new_object = multilingualMoveObject(self.context, language)\n+        new_object = self.context\n+        language = data[\'language\']\n+        # We need to move the object to its place!!\n+        new_object = multilingualMoveObject(self.context, language)\n \n         return self.request.response.redirect(\n             new_object.absolute_url() + \'?set_language=\' + language)\n'

