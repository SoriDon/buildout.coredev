Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-07-23T16:29:49+02:00
Author: Andrea Cecchi (cekk) <andrea.cecchi85@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/2ee88e5178d821c21691233512895ad47c7f02c9

Do not break @workflow endpoint for contents without workflow (#1184)

* handle contents with no workflows

* handle contents with no workflows

* add changelog

Files changed:
A news/1184.bugfix
M src/plone/restapi/services/workflow/info.py
M src/plone/restapi/tests/test_workflow.py

b'diff --git a/news/1184.bugfix b/news/1184.bugfix\nnew file mode 100644\nindex 000000000..bac39d3b9\n--- /dev/null\n+++ b/news/1184.bugfix\n@@ -0,0 +1 @@\n+Do not break @workflow endpoint for contents without workflow. @cekk\ndiff --git a/src/plone/restapi/services/workflow/info.py b/src/plone/restapi/services/workflow/info.py\nindex e0b7ca35c..532a2f0ff 100644\n--- a/src/plone/restapi/services/workflow/info.py\n+++ b/src/plone/restapi/services/workflow/info.py\n@@ -63,7 +63,10 @@ def __call__(self, expand=False):\n                 title = title.decode("utf8")\n             history[item]["title"] = self.context.translate(title)\n \n-        current_state = wftool.getInfoFor(self.context, "review_state")\n+        try:\n+            current_state = wftool.getInfoFor(self.context, "review_state")\n+        except WorkflowException:\n+            current_state = ""\n         current_state_title = wftool.getTitleForStateOnType(\n             current_state,\n             self.context.portal_type,\ndiff --git a/src/plone/restapi/tests/test_workflow.py b/src/plone/restapi/tests/test_workflow.py\nindex 9803b3821..a0b07be0c 100644\n--- a/src/plone/restapi/tests/test_workflow.py\n+++ b/src/plone/restapi/tests/test_workflow.py\n@@ -107,6 +107,20 @@ def test_workflow_info_empty_on_siteroot(self):\n         self.assertEqual(obj["transitions"], [])\n         self.assertEqual(obj["history"], [])\n \n+    def test_workflow_info_empty_on_content_without_workflow(self):\n+        file_content = self.portal[\n+            self.portal.invokeFactory("File", id="file", title="File")\n+        ]\n+\n+        wfinfo = getMultiAdapter(\n+            (file_content, self.request), name="GET_application_json_@workflow"\n+        )\n+        obj = wfinfo.reply()\n+\n+        self.assertEqual(obj["transitions"], [])\n+        self.assertEqual(obj["history"], [])\n+        self.assertEqual(obj["state"], {"id": "", "title": ""})\n+\n \n class TestWorkflowTransition(TestCase):\n \n'

