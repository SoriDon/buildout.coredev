Repository: plone.app.z3cform


Branch: refs/heads/master
Date: 2016-02-17T00:24:41-08:00
Author: Alec Mitchell (alecpm) <alecpm@gmail.com>
Commit: https://github.com/plone/plone.app.z3cform/commit/ca9531b5a0336f82bf5592fe752afd9b3e252ce7

Fix related items widget tests to include root path support. Fix options merging for TinyMCE widget.

Files changed:
M CHANGES.rst
M plone/app/z3cform/tests/test_widgets.py
M plone/app/z3cform/widget.py

diff --git a/CHANGES.rst b/CHANGES.rst
index dd8e08a..600b429 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -17,6 +17,9 @@ Fixes:
 - Use doctest instead of zope.testing.doctest
   [pbauer]
 
+- Fix related items widget tests to include root path support.
+  Fix options merging for TinyMCE widget.
+  [alecm]
 
 1.1.8 (2016-01-08)
 ------------------
diff --git a/plone/app/z3cform/tests/test_widgets.py b/plone/app/z3cform/tests/test_widgets.py
index f44b250..19f2d01 100644
--- a/plone/app/z3cform/tests/test_widgets.py
+++ b/plone/app/z3cform/tests/test_widgets.py
@@ -945,7 +945,8 @@ def setUp(self):
     def test_widget(self):
         from plone.app.z3cform.widget import RelatedItemsWidget
         widget = RelatedItemsWidget(self.request)
-        widget.context = Mock(absolute_url=lambda: 'fake_url')
+        widget.context = Mock(absolute_url=lambda: 'fake_url',
+                              getPhysicalPath=lambda: ['', 'site'])
         widget.update()
         self.assertEqual(
             {
@@ -958,8 +959,9 @@ def test_widget(self):
                     'searchAllText': u'Entire site',
                     'searchText': u'Search',
                     'separator': ';',
-                    'vocabularyUrl': '/@@getVocabulary?name='
+                    'vocabularyUrl': 'fake_url/@@getVocabulary?name='
                                      'plone.app.vocabularies.Catalog',
+                    'rootPath': '/site',
                 },
             },
             widget._base_args()
@@ -969,7 +971,8 @@ def test_single_selection(self):
         """The pattern_options value for maximumSelectionSize should
         be 1 when the field only allows a single selection."""
         from plone.app.z3cform.widget import RelatedItemsFieldWidget
-        context = Mock(absolute_url=lambda: 'fake_url')
+        context = Mock(absolute_url=lambda: 'fake_url',
+                       getPhysicalPath=lambda: ['', 'site'])
         field = Choice(
             __name__='selectfield',
             values=['one', 'two', 'three'],
@@ -988,7 +991,8 @@ def test_multiple_selection(self):
         from zope.schema.interfaces import ISource
         from zope.schema.vocabulary import VocabularyRegistry
 
-        context = Mock(absolute_url=lambda: 'fake_url')
+        context = Mock(absolute_url=lambda: 'fake_url',
+                       getPhysicalPath=lambda: ['', 'site'])
         field = List(
             __name__='selectfield',
             value_type=Choice(vocabulary='foobar')
@@ -1005,7 +1009,7 @@ def test_multiple_selection(self):
         self.assertFalse('maximumSelectionSize' in patterns_options)
         self.assertEqual(
             patterns_options['vocabularyUrl'],
-            '/@@getVocabulary?name=foobar&field=selectfield',
+            'fake_url/@@getVocabulary?name=foobar&field=selectfield',
             )
 
     def test_converter_RelationChoice(self):
diff --git a/plone/app/z3cform/widget.py b/plone/app/z3cform/widget.py
index 268b43b..8e3c331 100644
--- a/plone/app/z3cform/widget.py
+++ b/plone/app/z3cform/widget.py
@@ -519,9 +519,11 @@ def _base_args(self):
             self.field.getName(), value)).decode('utf-8')
 
         args.setdefault('pattern_options', {})
-        merged = dict_merge(get_tinymce_options(self.context, self.field, self.request),  # noqa
-                            args['pattern_options'])
-        args['pattern_options'] = merged['pattern_options']
+        merged_options = dict_merge(get_tinymce_options(self.context,
+                                                        self.field,
+                                                        self.request),  # noqa
+                                    args['pattern_options'])
+        args['pattern_options'] = merged_options
 
         return args
 


