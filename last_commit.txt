Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-10-23T15:34:47-04:00
Author: Alec Mitchell (alecpm) <alecpm@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/3e54e5c38cdc53a91e4dfd35dde9e3374a5c4420

Miscellaneous toolbar layout bugfixes. Position correctly on resize refs #1127, fix user menu position with zoomed browser, mobile/desktop menu event handlers not properly unbound.

Files changed:
M CHANGES.rst
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 8bc22c8..b3c5087 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -60,6 +60,8 @@ New features:
 
 Bug fixes:
 
+- Fix various layout issues in toolbar [alecm]
+
 - Avoid dependency on plone.app.imaging. [davisagli]
 - Fix TinyMCE table styles [vangheem]
 
diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 29c93b0..2ae4990 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -54,6 +54,9 @@ define([
           $( 'html' ).css('margin-right', '120px');
         }
       });
+      // Remove desktop event binding
+      $('nav > ul > li', that.$container).has( 'a .plone-toolbar-caret' ).off('click');
+      // Add sub-menu events
       $('nav li a', that.$container).has('.plone-toolbar-caret').off('click').on('click', function(e) {
         e.preventDefault();
         e.stopPropagation();
@@ -82,6 +85,14 @@ define([
         $('body').removeClass(that.options.classNames.expanded);
       }
 
+      if (!that.state.left) {
+        $('body').addClass(that.options.classNames.top);
+        $('body').addClass(that.state.expanded ? that.options.classNames.topExpanded : that.options.classNames.topDefault);
+        $('body').removeClass(that.options.classNames.left);
+        $('body').removeClass(that.options.classNames.leftDefault);
+        $('body').removeClass(that.options.classNames.leftExpanded);
+      }
+
       $('.' + that.options.classNames.logo, that.$container).off('click').on('click', function() {
         if (that.state.expanded) {
           // currently expanded, need to compress
@@ -121,6 +132,8 @@ define([
         event.stopImmediatePropagation();
       });
 
+      // Remove mobile event binding
+      $('nav li a', that.$container).has('.plone-toolbar-caret').off('click');
       // content menu activated
       $('nav > ul > li', that.$container).has( 'a .plone-toolbar-caret' ).off('click').on('click', function(event) {
         var $this = $(this);
@@ -180,7 +193,9 @@ define([
       var insideHeight = ($last.position().top - $first.position().top) + $last.outerHeight();
       var height = $content.outerHeight();
 
-      var itemLocation = $li.position().top || $li.offset().top;  // depends on positioning
+      // WebKit seems to set top position to very very small float value when zoomed,
+      // so check if the position top is less than 1px rather than 0.
+      var itemLocation = $li.position().top > 1 ? $li.position().top : $li.offset().top;  // depends on positioning
       // margin-top + insideHeight should equal total height
       $content.css({
         'margin-top': Math.min(itemLocation, height - insideHeight)


