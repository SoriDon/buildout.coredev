Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-12-20T10:28:57+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/26daffb4ebcef128c1fe66669a36d58ce29a9228

Test-only fix: in test_controlpanel_relations flush the index queue.

Needed for https://github.com/plone/plone.app.uuid/pull/11
This uuid PR changes code to not do a full catalog query, but it uses some catalog index internals.
Result for two tests in CMFPlone is that the index queue is not flushed, which leads to inconsistent results.
This fixes it.

Internal testing detail only, so I did not add a news snippet.

Files changed:
M Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py

b"diff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\nindex 07c0d232ec..a6bf021866 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\n@@ -82,6 +82,9 @@ def test_rebuild_relations(self):\n         # api.relation.create(doc1, doc2, 'relatedItems')\n         # api.relation.create(doc1, doc3, 'relatedItems')\n \n+        # Make sure the catalog index queue is flushed.\n+        self.portal.portal_catalog.searchResults({})\n+\n         stats, broken = get_relations_stats()\n         self.assertEqual(dict(stats), {'relatedItems': 2})\n         self.assertEqual(dict(broken), {})\n@@ -134,6 +137,9 @@ def test_rebuild_relations_with_intid(self):\n         # api.relation.create(doc1, doc2, 'relatedItems')\n         # api.relation.create(doc1, doc3, 'relatedItems')\n \n+        # Make sure the catalog index queue is flushed.\n+        self.portal.portal_catalog.searchResults({})\n+\n         stats, broken = get_relations_stats()\n         self.assertEqual(dict(stats), {'relatedItems': 2})\n         self.assertEqual(dict(broken), {})\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-12-20T11:45:39+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/429d727151959a5ce699638189f135fe2dd8f952

Merge pull request #3384 from plone/maurits-test-controlpanel-relations-flush-index-queue

Test-only fix: in test_controlpanel_relations flush the index queue.

Files changed:
M Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py

b"diff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\nindex 07c0d232ec..a6bf021866 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_relations.py\n@@ -82,6 +82,9 @@ def test_rebuild_relations(self):\n         # api.relation.create(doc1, doc2, 'relatedItems')\n         # api.relation.create(doc1, doc3, 'relatedItems')\n \n+        # Make sure the catalog index queue is flushed.\n+        self.portal.portal_catalog.searchResults({})\n+\n         stats, broken = get_relations_stats()\n         self.assertEqual(dict(stats), {'relatedItems': 2})\n         self.assertEqual(dict(broken), {})\n@@ -134,6 +137,9 @@ def test_rebuild_relations_with_intid(self):\n         # api.relation.create(doc1, doc2, 'relatedItems')\n         # api.relation.create(doc1, doc3, 'relatedItems')\n \n+        # Make sure the catalog index queue is flushed.\n+        self.portal.portal_catalog.searchResults({})\n+\n         stats, broken = get_relations_stats()\n         self.assertEqual(dict(stats), {'relatedItems': 2})\n         self.assertEqual(dict(broken), {})\n"

