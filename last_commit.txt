Repository: plone.app.layout


Branch: refs/heads/master
Date: 2022-01-07T12:31:23-05:00
Author: Thomas Massmann (thomasmassmann) <thomas.massmann@it-spir.it>
Commit: https://github.com/plone/plone.app.layout/commit/fee18ef115abd3ceba63c3d5b3dd937b5e46650a

test(280): :test_tube: add test for #280, will fail now

Files changed:
M plone/app/layout/viewlets/tests/test_common.py

b'diff --git a/plone/app/layout/viewlets/tests/test_common.py b/plone/app/layout/viewlets/tests/test_common.py\nindex 3915e73a..4630391d 100644\n--- a/plone/app/layout/viewlets/tests/test_common.py\n+++ b/plone/app/layout/viewlets/tests/test_common.py\n@@ -616,6 +616,27 @@ class CustomGlobalSectionsViewlet(GlobalSectionsViewlet):\n             navtree["/plone"][1]["url"], "http://nohost/plone/folder1/view"\n         )\n \n+    def test_escaping_twice_does_not_double_escape_items(self):\n+        """Test for https://github.com/plone/plone.app.layout/issues/280."""\n+\n+        self.portal.invokeFactory(\n+            "Document", "test-doc-1", title=u"Document 1 & 2",\n+        )\n+\n+        request = self.layer["request"]\n+        gsv = GlobalSectionsViewlet(self.portal, request, None)\n+        gsv.update()\n+        html = gsv.render()\n+        self.assertIn("Document 1 &amp; 2", html)\n+\n+        # Render again, as this is what happens when an error view is rendered\n+        # Before the fix this test will fail, as it produces a title with\n+        # \'Document 1 &amp;amp; 2\'.\n+        html = gsv.render()\n+        self.assertNotIn("Document 1 &amp;amp; 2", html)\n+        self.assertIn("Document 1 &amp; 2", html)\n+\n+\n \n class TestTitleEscape(ViewletsFunctionalTestCase):\n     """Test that the title in the global sections viewlet is escaped.\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2022-01-07T13:41:07-05:00
Author: Thomas Massmann (thomasmassmann) <thomas.massmann@it-spir.it>
Commit: https://github.com/plone/plone.app.layout/commit/5f2ecac1339ec462c4eac21fbd419dc90a78051e

fix(280): :bug: ensure navigation titles are escaped only once

Files changed:
M plone/app/layout/viewlets/common.py

b'diff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex e436eeda..d3b56803 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -301,7 +301,9 @@ def navtree(self):\n                     entry["title"], domain="plone", context=self.request\n                 )\n \n-            entry["title"] = safe_unicode(entry["title"])\n+            entry["title"] = escape(safe_unicode(entry["title"]))\n+            if "name" in entry and entry["name"]:\n+                entry["name"] = escape(safe_unicode(entry["name"]))\n             self.customize_tab(entry, tab)\n             ret[navtree_path].append(entry)\n \n@@ -354,7 +356,7 @@ def navtree(self):\n                 "path": brain_path,\n                 "uid": brain.UID,\n                 "url": url,\n-                "title": safe_unicode(brain.Title),\n+                "title": escape(safe_unicode(brain.Title)),\n                 "review_state": brain.review_state,\n             }\n             self.customize_entry(entry, brain)\n@@ -394,10 +396,6 @@ def render_item(self, item, path):\n                     "has_sub_class": "",\n                 }\n             )\n-        if "title" in item and item["title"]:\n-            item["title"] = escape(item["title"])\n-        if "name" in item and item["name"]:\n-            item["name"] = escape(item["name"])\n         return self._item_markup_template.format(**item)\n \n     def build_tree(self, path, first_run=True):\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2022-01-07T13:41:53-05:00
Author: Thomas Massmann (thomasmassmann) <thomas.massmann@it-spir.it>
Commit: https://github.com/plone/plone.app.layout/commit/3b6cec594ef69ab5fd7b63754779c6667cb7bdc6

docs(280): :memo: add changelog entry

Files changed:
A news/280.fix

b'diff --git a/news/280.fix b/news/280.fix\nnew file mode 100644\nindex 00000000..408c622e\n--- /dev/null\n+++ b/news/280.fix\n@@ -0,0 +1,2 @@\n+Escape navigation titles only once.\n+[thomasmassmann]\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2022-01-09T00:09:16+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/c4a88725bfc50be8ab16552cc5a8e24d1a48f7ae

Merge pull request #284 from plone/issues/280-master

Escape navigation titles only once (master, 4.x)

Files changed:
A news/280.fix
M plone/app/layout/viewlets/common.py
M plone/app/layout/viewlets/tests/test_common.py

b'diff --git a/news/280.fix b/news/280.fix\nnew file mode 100644\nindex 00000000..408c622e\n--- /dev/null\n+++ b/news/280.fix\n@@ -0,0 +1,2 @@\n+Escape navigation titles only once.\n+[thomasmassmann]\ndiff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py\nindex e436eeda..d3b56803 100644\n--- a/plone/app/layout/viewlets/common.py\n+++ b/plone/app/layout/viewlets/common.py\n@@ -301,7 +301,9 @@ def navtree(self):\n                     entry["title"], domain="plone", context=self.request\n                 )\n \n-            entry["title"] = safe_unicode(entry["title"])\n+            entry["title"] = escape(safe_unicode(entry["title"]))\n+            if "name" in entry and entry["name"]:\n+                entry["name"] = escape(safe_unicode(entry["name"]))\n             self.customize_tab(entry, tab)\n             ret[navtree_path].append(entry)\n \n@@ -354,7 +356,7 @@ def navtree(self):\n                 "path": brain_path,\n                 "uid": brain.UID,\n                 "url": url,\n-                "title": safe_unicode(brain.Title),\n+                "title": escape(safe_unicode(brain.Title)),\n                 "review_state": brain.review_state,\n             }\n             self.customize_entry(entry, brain)\n@@ -394,10 +396,6 @@ def render_item(self, item, path):\n                     "has_sub_class": "",\n                 }\n             )\n-        if "title" in item and item["title"]:\n-            item["title"] = escape(item["title"])\n-        if "name" in item and item["name"]:\n-            item["name"] = escape(item["name"])\n         return self._item_markup_template.format(**item)\n \n     def build_tree(self, path, first_run=True):\ndiff --git a/plone/app/layout/viewlets/tests/test_common.py b/plone/app/layout/viewlets/tests/test_common.py\nindex 3915e73a..4630391d 100644\n--- a/plone/app/layout/viewlets/tests/test_common.py\n+++ b/plone/app/layout/viewlets/tests/test_common.py\n@@ -616,6 +616,27 @@ class CustomGlobalSectionsViewlet(GlobalSectionsViewlet):\n             navtree["/plone"][1]["url"], "http://nohost/plone/folder1/view"\n         )\n \n+    def test_escaping_twice_does_not_double_escape_items(self):\n+        """Test for https://github.com/plone/plone.app.layout/issues/280."""\n+\n+        self.portal.invokeFactory(\n+            "Document", "test-doc-1", title=u"Document 1 & 2",\n+        )\n+\n+        request = self.layer["request"]\n+        gsv = GlobalSectionsViewlet(self.portal, request, None)\n+        gsv.update()\n+        html = gsv.render()\n+        self.assertIn("Document 1 &amp; 2", html)\n+\n+        # Render again, as this is what happens when an error view is rendered\n+        # Before the fix this test will fail, as it produces a title with\n+        # \'Document 1 &amp;amp; 2\'.\n+        html = gsv.render()\n+        self.assertNotIn("Document 1 &amp;amp; 2", html)\n+        self.assertIn("Document 1 &amp; 2", html)\n+\n+\n \n class TestTitleEscape(ViewletsFunctionalTestCase):\n     """Test that the title in the global sections viewlet is escaped.\n'

