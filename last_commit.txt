Repository: plone.app.event


Branch: refs/heads/master
Date: 2021-05-04T14:10:03+02:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.event/commit/990acbcf65a2df56eeaee5e8028dba26e65eab9f

Fix occurrences

Files changed:
M plone/app/event/browser/event_summary.pt
M plone/app/event/browser/event_summary.py
M plone/app/event/tests/test_event_summary.py

b'diff --git a/plone/app/event/browser/event_summary.pt b/plone/app/event/browser/event_summary.pt\nindex 268b80d4..e6a603ea 100644\n--- a/plone/app/event/browser/event_summary.pt\n+++ b/plone/app/event/browser/event_summary.pt\n@@ -16,11 +16,12 @@\n                      start_utcoffset python:int(start_utcoffset);\n                      excludes view/excludes;\n                      next_occs view/next_occurrences;\n-                     all_occs view/num_more_occurrences;\n+                     has_occs view/has_occurrences;\n+                     num_more_occs view/num_more_occurrences;\n                      icons python:context.restrictedTraverse(\'@@iconresolver\')">\n \n       <div class="row">\n-        <div class="col">\n+        <div class="col event-when">\n           <div class="mb-3 d-flex">\n             <div class="meta-icon">\n               <tal:icon replace="structure python:icons.tag(\'calendar\', tag_class=\'icon-inline\')" />\n@@ -41,17 +42,15 @@\n         </div>\n       </div>\n \n-      <div class="row ${python:len(next_occs) > 1 and \'row-cols-1 row-cols-md-2\' or \'\'}">\n-\n-        <tal:cond condition="python:\'occurrences\' not in excludes and all_occs">\n-        <div class="col">\n-          <div class="mb-3"\n-                tal:condition="python:len(next_occs) > 1 or all_occs > 1">\n+      <div class="row ${python:has_occs and \'row-cols-1 row-cols-md-2\' or \'\'}">\n+        <tal:cond condition="python:\'occurrences\' not in excludes and has_occs">\n+        <div class="col event-occurences">\n+          <div class="mb-3">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'calendar-week\', tag_class=\'icon-inline\')" />\n               </div>\n-              <div>\n+              <div class="event-all-dates">\n                 <strong class="meta-label" i18n:translate="">\n                   All dates\n                 </strong>\n@@ -66,7 +65,7 @@\n                     </tal:def>\n                     <br />\n                   </span>\n-                  <span tal:condition="view/num_more_occurrences">\n+                  <span tal:condition="num_more_occs">\n                     <a tal:attributes="href string:${view/event_context/absolute_url}/@@event_listing"\n                         tal:content="view/more_occurrences_text">\n                       There are 12 more occurrences.\n@@ -81,7 +80,7 @@\n \n         <div class="row col ${python:len(next_occs) > 1 and \'row-cols-1 row-cols-md-1\' or \'row-cols-1 row-cols-md-2\'}">\n \n-          <div class="col mb-3" tal:condition="python: data.location and \'location\' not in excludes">\n+          <div class="col event-location mb-3" tal:condition="python: data.location and \'location\' not in excludes">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'geo-alt\', tag_class=\'icon-inline\')" />\n@@ -95,7 +94,7 @@\n \n           <tal:cond condition="python:\'contact\' not in excludes">\n \n-          <div class="col mb-3" tal:define="mail data/contact_email; name data/contact_name;" tal:condition="python:name or mail">\n+          <div class="col event-contact mb-3" tal:define="mail data/contact_email; name data/contact_name;" tal:condition="python:name or mail">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'person\', tag_class=\'icon-inline\')" />\n@@ -108,7 +107,7 @@\n             </div>\n           </div>\n \n-          <div class="col mb-3" tal:condition="data/contact_phone">\n+          <div class="col event-phone mb-3" tal:condition="data/contact_phone">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'phone\', tag_class=\'icon-inline\')" />\n@@ -120,7 +119,7 @@\n             </div>\n           </div>\n \n-          <div class="col mb-3" tal:condition="data/attendees|nothing">\n+          <div class="col event-attendees mb-3" tal:condition="data/attendees|nothing">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'people\', tag_class=\'icon-inline\')" />\n@@ -136,7 +135,7 @@\n \n           </tal:cond>\n \n-          <div class="col mb-3" tal:condition="python: data.event_url and \'event_url\' not in excludes">\n+          <div class="col event-url mb-3" tal:condition="python: data.event_url and \'event_url\' not in excludes">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'laptop\', tag_class=\'icon-inline\')" />\n@@ -148,7 +147,7 @@\n             </div>\n           </div>\n \n-          <div class="col mb-3" tal:condition="python:\'ical\' not in excludes">\n+          <div class="col event-add-ical mb-3" tal:condition="python:\'ical\' not in excludes">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'calendar-plus\', tag_class=\'icon-inline\')" />\ndiff --git a/plone/app/event/browser/event_summary.py b/plone/app/event/browser/event_summary.py\nindex a4a33b37..94735f7a 100644\n--- a/plone/app/event/browser/event_summary.py\n+++ b/plone/app/event/browser/event_summary.py\n@@ -84,3 +84,10 @@ def more_occurrences_text(self):\n             mapping={u"results": self.num_more_occurrences}\n         )\n         return self.context.translate(msgid)\n+\n+    @property\n+    @view.memoize\n+    def has_occurrences(self):\n+        occs = [o for o in self.next_occurrences if IOccurrence.providedBy(o)]\n+        return len(occs)\n+        \n\\ No newline at end of file\ndiff --git a/plone/app/event/tests/test_event_summary.py b/plone/app/event/tests/test_event_summary.py\nindex 9286e1a7..3fb71ab2 100644\n--- a/plone/app/event/tests/test_event_summary.py\n+++ b/plone/app/event/tests/test_event_summary.py\n@@ -100,7 +100,7 @@ def test_event_summary__recurring_last_occurrence(self):\n \n     @mock.patch(\'plone.app.event.base.localized_now\', new=PN)\n     def test_event_summary__recurring_excludes(self):\n-        """Test if some specific content is included here.\n+        """Test if some specific content is excluded here.\n         """\n         view = self.portal.now.restrictedTraverse(\'@@event_summary\')\n         ex = view.excludes\n'

Repository: plone.app.event


Branch: refs/heads/master
Date: 2021-05-04T15:09:09+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.event/commit/40c538f17153120ee399e4da69e55275452936d1

Merge pull request #329 from plone/fix-occurences

Fix occurrences

Files changed:
M plone/app/event/browser/event_summary.pt
M plone/app/event/browser/event_summary.py
M plone/app/event/tests/test_event_summary.py

b'diff --git a/plone/app/event/browser/event_summary.pt b/plone/app/event/browser/event_summary.pt\nindex 268b80d4..e6a603ea 100644\n--- a/plone/app/event/browser/event_summary.pt\n+++ b/plone/app/event/browser/event_summary.pt\n@@ -16,11 +16,12 @@\n                      start_utcoffset python:int(start_utcoffset);\n                      excludes view/excludes;\n                      next_occs view/next_occurrences;\n-                     all_occs view/num_more_occurrences;\n+                     has_occs view/has_occurrences;\n+                     num_more_occs view/num_more_occurrences;\n                      icons python:context.restrictedTraverse(\'@@iconresolver\')">\n \n       <div class="row">\n-        <div class="col">\n+        <div class="col event-when">\n           <div class="mb-3 d-flex">\n             <div class="meta-icon">\n               <tal:icon replace="structure python:icons.tag(\'calendar\', tag_class=\'icon-inline\')" />\n@@ -41,17 +42,15 @@\n         </div>\n       </div>\n \n-      <div class="row ${python:len(next_occs) > 1 and \'row-cols-1 row-cols-md-2\' or \'\'}">\n-\n-        <tal:cond condition="python:\'occurrences\' not in excludes and all_occs">\n-        <div class="col">\n-          <div class="mb-3"\n-                tal:condition="python:len(next_occs) > 1 or all_occs > 1">\n+      <div class="row ${python:has_occs and \'row-cols-1 row-cols-md-2\' or \'\'}">\n+        <tal:cond condition="python:\'occurrences\' not in excludes and has_occs">\n+        <div class="col event-occurences">\n+          <div class="mb-3">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'calendar-week\', tag_class=\'icon-inline\')" />\n               </div>\n-              <div>\n+              <div class="event-all-dates">\n                 <strong class="meta-label" i18n:translate="">\n                   All dates\n                 </strong>\n@@ -66,7 +65,7 @@\n                     </tal:def>\n                     <br />\n                   </span>\n-                  <span tal:condition="view/num_more_occurrences">\n+                  <span tal:condition="num_more_occs">\n                     <a tal:attributes="href string:${view/event_context/absolute_url}/@@event_listing"\n                         tal:content="view/more_occurrences_text">\n                       There are 12 more occurrences.\n@@ -81,7 +80,7 @@\n \n         <div class="row col ${python:len(next_occs) > 1 and \'row-cols-1 row-cols-md-1\' or \'row-cols-1 row-cols-md-2\'}">\n \n-          <div class="col mb-3" tal:condition="python: data.location and \'location\' not in excludes">\n+          <div class="col event-location mb-3" tal:condition="python: data.location and \'location\' not in excludes">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'geo-alt\', tag_class=\'icon-inline\')" />\n@@ -95,7 +94,7 @@\n \n           <tal:cond condition="python:\'contact\' not in excludes">\n \n-          <div class="col mb-3" tal:define="mail data/contact_email; name data/contact_name;" tal:condition="python:name or mail">\n+          <div class="col event-contact mb-3" tal:define="mail data/contact_email; name data/contact_name;" tal:condition="python:name or mail">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'person\', tag_class=\'icon-inline\')" />\n@@ -108,7 +107,7 @@\n             </div>\n           </div>\n \n-          <div class="col mb-3" tal:condition="data/contact_phone">\n+          <div class="col event-phone mb-3" tal:condition="data/contact_phone">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'phone\', tag_class=\'icon-inline\')" />\n@@ -120,7 +119,7 @@\n             </div>\n           </div>\n \n-          <div class="col mb-3" tal:condition="data/attendees|nothing">\n+          <div class="col event-attendees mb-3" tal:condition="data/attendees|nothing">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'people\', tag_class=\'icon-inline\')" />\n@@ -136,7 +135,7 @@\n \n           </tal:cond>\n \n-          <div class="col mb-3" tal:condition="python: data.event_url and \'event_url\' not in excludes">\n+          <div class="col event-url mb-3" tal:condition="python: data.event_url and \'event_url\' not in excludes">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'laptop\', tag_class=\'icon-inline\')" />\n@@ -148,7 +147,7 @@\n             </div>\n           </div>\n \n-          <div class="col mb-3" tal:condition="python:\'ical\' not in excludes">\n+          <div class="col event-add-ical mb-3" tal:condition="python:\'ical\' not in excludes">\n             <div class="d-flex">\n               <div class="meta-icon">\n                 <tal:icon replace="structure python:icons.tag(\'calendar-plus\', tag_class=\'icon-inline\')" />\ndiff --git a/plone/app/event/browser/event_summary.py b/plone/app/event/browser/event_summary.py\nindex a4a33b37..94735f7a 100644\n--- a/plone/app/event/browser/event_summary.py\n+++ b/plone/app/event/browser/event_summary.py\n@@ -84,3 +84,10 @@ def more_occurrences_text(self):\n             mapping={u"results": self.num_more_occurrences}\n         )\n         return self.context.translate(msgid)\n+\n+    @property\n+    @view.memoize\n+    def has_occurrences(self):\n+        occs = [o for o in self.next_occurrences if IOccurrence.providedBy(o)]\n+        return len(occs)\n+        \n\\ No newline at end of file\ndiff --git a/plone/app/event/tests/test_event_summary.py b/plone/app/event/tests/test_event_summary.py\nindex 9286e1a7..3fb71ab2 100644\n--- a/plone/app/event/tests/test_event_summary.py\n+++ b/plone/app/event/tests/test_event_summary.py\n@@ -100,7 +100,7 @@ def test_event_summary__recurring_last_occurrence(self):\n \n     @mock.patch(\'plone.app.event.base.localized_now\', new=PN)\n     def test_event_summary__recurring_excludes(self):\n-        """Test if some specific content is included here.\n+        """Test if some specific content is excluded here.\n         """\n         view = self.portal.now.restrictedTraverse(\'@@event_summary\')\n         ex = view.excludes\n'

