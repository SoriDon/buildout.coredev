Repository: plone.scale


Branch: refs/heads/master
Date: 2016-09-06T15:05:05+02:00
Author: Diederik Veeze (didrix) <d.veeze@zestsoftware.nl>
Commit: https://github.com/plone/plone.scale/commit/a70566cf33f9b573d03301eb50099697a9292866

Convert palette-based with a gray palette to grayscale+alpha images

Files changed:
M CHANGES.rst
M plone/scale/scale.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bf2b16f..3e57bbe 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -30,6 +30,9 @@ New:
 - Scaled GIFs are converted to RGBA PNG images instead of converting them to JPEG.
   [thet, jensens]
 
+- Convert palette-based with a gray palette to grayscale+alpha images.
+  [didrix]
+
 Fixes:
 
 - Don't scale images up for direction "down".
diff --git a/plone/scale/scale.py b/plone/scale/scale.py
index 653d304..ee79602 100644
--- a/plone/scale/scale.py
+++ b/plone/scale/scale.py
@@ -141,8 +141,13 @@ def scalePILImage(image, width=None, height=None, direction='down'):
         # Convert black&white to grayscale
         image = image.convert("L")
     elif image.mode == "P":
-        # Convert palette based images to 3x8bit+alpha
-        image = image.convert("RGBA")
+        # If palette is grayscale, convert to gray+alpha
+        # Else convert palette based images to 3x8bit+alpha
+        palette = image.getpalette()
+        if palette[0::3] == palette[1::3] == palette[2::3]:
+            image = image.convert("LA")
+        else:
+            image = image.convert("RGBA")
     elif image.mode == "CMYK":
         # Convert CMYK to RGB, allowing for web previews of print images
         image = image.convert("RGB")


Repository: plone.scale


Branch: refs/heads/master
Date: 2016-09-06T15:05:05+02:00
Author: Diederik Veeze (didrix) <d.veeze@zestsoftware.nl>
Commit: https://github.com/plone/plone.scale/commit/f2fdd77fbf2e03479d5cfc14034de24470e51781

Workaround for PIL bug converting palette to grayscale+alpha

Files changed:
M plone/scale/scale.py

diff --git a/plone/scale/scale.py b/plone/scale/scale.py
index ee79602..2ca6d2d 100644
--- a/plone/scale/scale.py
+++ b/plone/scale/scale.py
@@ -141,13 +141,13 @@ def scalePILImage(image, width=None, height=None, direction='down'):
         # Convert black&white to grayscale
         image = image.convert("L")
     elif image.mode == "P":
-        # If palette is grayscale, convert to gray+alpha
-        # Else convert palette based images to 3x8bit+alpha
         palette = image.getpalette()
+        # Convert palette based images to 3x8bit+alpha
+        image = image.convert("RGBA")
+        # If palette is grayscale, convert to gray+alpha
+        # needs to be RGBA first, because of bug in PIL
         if palette[0::3] == palette[1::3] == palette[2::3]:
             image = image.convert("LA")
-        else:
-            image = image.convert("RGBA")
     elif image.mode == "CMYK":
         # Convert CMYK to RGB, allowing for web previews of print images
         image = image.convert("RGB")


Repository: plone.scale


Branch: refs/heads/master
Date: 2016-09-06T15:05:05+02:00
Author: Diederik Veeze (didrix) <d.veeze@zestsoftware.nl>
Commit: https://github.com/plone/plone.scale/commit/1bbc73b899dd062f35bf43507f4620f66f21d8ce

Convert images with 256 colors or less to palette-based images

Files changed:
M CHANGES.rst
M plone/scale/scale.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3e57bbe..e44b6f7 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -30,7 +30,10 @@ New:
 - Scaled GIFs are converted to RGBA PNG images instead of converting them to JPEG.
   [thet, jensens]
 
-- Convert palette-based with a gray palette to grayscale+alpha images.
+- Convert palette-based images with a gray palette to grayscale+alpha images.
+  [didrix]
+
+- Convert images with 256 colors or less to palette-based images.
   [didrix]
 
 Fixes:
diff --git a/plone/scale/scale.py b/plone/scale/scale.py
index 2ca6d2d..67ec32d 100644
--- a/plone/scale/scale.py
+++ b/plone/scale/scale.py
@@ -50,6 +50,10 @@ def scaleImage(image, width=None, height=None, direction='down',
 
     image = scalePILImage(image, width, height, direction)
 
+    # convert to palette if possible
+    if format_ == 'PNG' and image.getcolors(maxcolors=256):
+        image = image.convert('P')
+
     new_result = False
 
     if result is None:


Repository: plone.scale


Branch: refs/heads/master
Date: 2016-09-06T15:05:05+02:00
Author: Diederik Veeze (didrix) <d.veeze@zestsoftware.nl>
Commit: https://github.com/plone/plone.scale/commit/b679839f44ef4f8871fe447c9d2529fcba36e298

Issue converting palette to grayscale+alpha fixed in pillow 3.3.0

This reverts commit eed57b040ecff6dfeeb267ada36da3e3a62a4ace.

Files changed:
M plone/scale/scale.py

diff --git a/plone/scale/scale.py b/plone/scale/scale.py
index 67ec32d..75749ef 100644
--- a/plone/scale/scale.py
+++ b/plone/scale/scale.py
@@ -145,13 +145,13 @@ def scalePILImage(image, width=None, height=None, direction='down'):
         # Convert black&white to grayscale
         image = image.convert("L")
     elif image.mode == "P":
-        palette = image.getpalette()
-        # Convert palette based images to 3x8bit+alpha
-        image = image.convert("RGBA")
         # If palette is grayscale, convert to gray+alpha
-        # needs to be RGBA first, because of bug in PIL
+        # Else convert palette based images to 3x8bit+alpha
+        palette = image.getpalette()
         if palette[0::3] == palette[1::3] == palette[2::3]:
             image = image.convert("LA")
+        else:
+            image = image.convert("RGBA")
     elif image.mode == "CMYK":
         # Convert CMYK to RGB, allowing for web previews of print images
         image = image.convert("RGB")


Repository: plone.scale


Branch: refs/heads/master
Date: 2016-09-06T15:59:52+02:00
Author: Diederik Veeze (didrix) <d.veeze@zestsoftware.nl>
Commit: https://github.com/plone/plone.scale/commit/f4a5086a9ee38389df68f1b92e358293c2ba552e

Convert jpeg to L-mode and png to P-mode when possible

Files changed:
M CHANGES.rst
M plone/scale/scale.py

diff --git a/CHANGES.rst b/CHANGES.rst
index e44b6f7..cac29b8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,7 +11,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Choose an appropriate image mode in order to reduce file size.
+  [didrix]
 
 Bug fixes:
 
@@ -30,12 +31,6 @@ New:
 - Scaled GIFs are converted to RGBA PNG images instead of converting them to JPEG.
   [thet, jensens]
 
-- Convert palette-based images with a gray palette to grayscale+alpha images.
-  [didrix]
-
-- Convert images with 256 colors or less to palette-based images.
-  [didrix]
-
 Fixes:
 
 - Don't scale images up for direction "down".
diff --git a/plone/scale/scale.py b/plone/scale/scale.py
index 75749ef..4f674c6 100644
--- a/plone/scale/scale.py
+++ b/plone/scale/scale.py
@@ -50,9 +50,12 @@ def scaleImage(image, width=None, height=None, direction='down',
 
     image = scalePILImage(image, width, height, direction)
 
-    # convert to palette if possible
-    if format_ == 'PNG' and image.getcolors(maxcolors=256):
-        image = image.convert('P')
+    # convert to simpler mode if possible
+    if image.mode not in ('P', 'L') and image.getcolors(maxcolors=256):
+        if format_ == 'JPEG':
+            image = image.convert('L')
+        elif format_ == 'PNG':
+            image = image.convert('P')
 
     new_result = False
 


Repository: plone.scale


Branch: refs/heads/master
Date: 2016-09-12T19:15:37+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.scale/commit/c0269a5555de19d2fb64d3dfd2b35dbbc71b14d1

Merge pull request #13 from plone/image-mode-optimization

Image mode optimization

Files changed:
M CHANGES.rst
M plone/scale/scale.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bf2b16f..cac29b8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,7 +11,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Choose an appropriate image mode in order to reduce file size.
+  [didrix]
 
 Bug fixes:
 
diff --git a/plone/scale/scale.py b/plone/scale/scale.py
index 653d304..4f674c6 100644
--- a/plone/scale/scale.py
+++ b/plone/scale/scale.py
@@ -50,6 +50,13 @@ def scaleImage(image, width=None, height=None, direction='down',
 
     image = scalePILImage(image, width, height, direction)
 
+    # convert to simpler mode if possible
+    if image.mode not in ('P', 'L') and image.getcolors(maxcolors=256):
+        if format_ == 'JPEG':
+            image = image.convert('L')
+        elif format_ == 'PNG':
+            image = image.convert('P')
+
     new_result = False
 
     if result is None:
@@ -141,8 +148,13 @@ def scalePILImage(image, width=None, height=None, direction='down'):
         # Convert black&white to grayscale
         image = image.convert("L")
     elif image.mode == "P":
-        # Convert palette based images to 3x8bit+alpha
-        image = image.convert("RGBA")
+        # If palette is grayscale, convert to gray+alpha
+        # Else convert palette based images to 3x8bit+alpha
+        palette = image.getpalette()
+        if palette[0::3] == palette[1::3] == palette[2::3]:
+            image = image.convert("LA")
+        else:
+            image = image.convert("RGBA")
     elif image.mode == "CMYK":
         # Convert CMYK to RGB, allowing for web previews of print images
         image = image.convert("RGB")


