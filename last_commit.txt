Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-02-22T10:21:38+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/63118ab8a0a04e07a29d0620baa33dd2eed78fd6

Display wsgi-status

Files changed:
M Products/CMFPlone/controlpanel/browser/overview.pt
M Products/CMFPlone/controlpanel/browser/overview.py

b'diff --git a/Products/CMFPlone/controlpanel/browser/overview.pt b/Products/CMFPlone/controlpanel/browser/overview.pt\nindex b44cacce5..9bd0c774a 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/overview.pt\n@@ -140,6 +140,16 @@\n       </tal:list-versions>\n     </ul>\n \n+    <p tal:define="server_info python:view.server_info()">\n+      <ul>\n+        <li>WSGI: <span tal:content="python: \'On\' if server_info[\'wsgi\'] else \'Off\'" /></li>\n+        <li>Server:\n+          <span tal:content="python: server_info[\'server_name\']">waitress</span>\n+          <span tal:content="python: server_info[\'version\']">1.0.0</span>\n+        </li>\n+      </ul>\n+    </p>\n+\n     <p tal:condition="not:view/is_dev_mode"\n        class="discreet"\n        i18n:translate="description_production_mode">\ndiff --git a/Products/CMFPlone/controlpanel/browser/overview.py b/Products/CMFPlone/controlpanel/browser/overview.py\nindex ddbb918f0..84943d8a3 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.py\n+++ b/Products/CMFPlone/controlpanel/browser/overview.py\n@@ -11,6 +11,8 @@\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\n \n+import pkg_resources\n+\n try:\n     import plone.app.event\n     plone.app.event  # pyflakes\n@@ -45,6 +47,23 @@ def core_versions(self):\n     def pil(self):\n         return \'PIL\' in self.core_versions()\n \n+    def server_info(self):\n+        servers = getattr(getConfiguration(), \'servers\', None)\n+        if servers and \'ZServer\' in servers[0].__module__:\n+            return {\n+                \'wsgi\': False,\n+                \'server_name\': \'ZServer\',\n+                \'version\': pkg_resources.get_distribution(\'ZServer\').version,\n+            }\n+        else:\n+            # TODO: How can we find the name of the wsgi-server?\n+            server_name = \'waitress\'\n+            return {\n+                \'wsgi\': True,\n+                \'server_name\': server_name,\n+                \'version\': pkg_resources.get_distribution(\'waitress\').version,\n+            }\n+\n     def version_overview(self):\n \n         core_versions = self.core_versions()\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-02-22T10:21:38+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/285264dee7ca603c4be36ffb9650b6c35d00483a

add changenote

Files changed:
A news/2770.feature

b'diff --git a/news/2770.feature b/news/2770.feature\nnew file mode 100644\nindex 000000000..63972d8e1\n--- /dev/null\n+++ b/news/2770.feature\n@@ -0,0 +1 @@\n+Display wsgi-state plus name and version of the server in the controlpanel [pbauer]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-02-22T10:21:38+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/e10e4896ba7cae012eeb55ef2c8c9a97952a2964

get more info from request

Files changed:
M Products/CMFPlone/controlpanel/browser/overview.py

b"diff --git a/Products/CMFPlone/controlpanel/browser/overview.py b/Products/CMFPlone/controlpanel/browser/overview.py\nindex 84943d8a3..32ce909b4 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.py\n+++ b/Products/CMFPlone/controlpanel/browser/overview.py\n@@ -10,6 +10,7 @@\n from plone.memoize.instance import memoize\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\n+from ZPublisher.HTTPRequest import WSGIRequest\n \n import pkg_resources\n \n@@ -48,21 +49,29 @@ def pil(self):\n         return 'PIL' in self.core_versions()\n \n     def server_info(self):\n+        wsgi = isinstance(self.request, WSGIRequest)\n+        server_name = 'unknown'\n+        server_version = 'unknown'\n+\n+        # check for ZServer\n         servers = getattr(getConfiguration(), 'servers', None)\n         if servers and 'ZServer' in servers[0].__module__:\n-            return {\n-                'wsgi': False,\n-                'server_name': 'ZServer',\n-                'version': pkg_resources.get_distribution('ZServer').version,\n-            }\n+            server_name = 'ZServer'\n+            server_version = pkg_resources.get_distribution('ZServer').version\n         else:\n-            # TODO: How can we find the name of the wsgi-server?\n-            server_name = 'waitress'\n-            return {\n-                'wsgi': True,\n-                'server_name': server_name,\n-                'version': pkg_resources.get_distribution('waitress').version,\n-            }\n+            # try to find the wsgi-server that is used\n+            server_name = self.request.get('SERVER_SOFTWARE')\n+            if server_name:\n+                try:\n+                    server = pkg_resources.get_distribution(server_name)\n+                    server_version = server.version\n+                except ImportError:\n+                    pass\n+        return {\n+            'wsgi': wsgi,\n+            'server_name': server_name,\n+            'version': server_version,\n+        }\n \n     def version_overview(self):\n \n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-02-23T10:35:02+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/9a34e42b7bd19753889041b8c779fba3ebd0a4ea

Add i18n. Do not display unknown version if server_name is no package since it is sometimes part of server_name

Files changed:
M Products/CMFPlone/controlpanel/browser/overview.pt
M Products/CMFPlone/controlpanel/browser/overview.py

b'diff --git a/Products/CMFPlone/controlpanel/browser/overview.pt b/Products/CMFPlone/controlpanel/browser/overview.pt\nindex 9bd0c774a..f22683fc2 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/overview.pt\n@@ -138,17 +138,21 @@\n       <tal:list-versions repeat="version view/version_overview">\n         <li tal:content="version">Version</li>\n       </tal:list-versions>\n+      <tal:server tal:define="server_info view/server_info;\n+                              has_wsgi server_info/wsgi;">\n+          <li>\n+            <tal:i18n i18n:translate="">WSGI:</tal:i18n>\n+            <span i18n:translate="" tal:condition="has_wsgi">On</span>\n+            <span i18n:translate="" tal:condition="not:has_wsgi">Off</span>\n+          </li>\n+          <li>\n+            <tal:i18n i18n:translate="">Server:</tal:i18n>\n+            <span>${server_info/server_name}</span>\n+            <span>${server_info/version}</span>\n+          </li>\n+      </tal:server>\n     </ul>\n \n-    <p tal:define="server_info python:view.server_info()">\n-      <ul>\n-        <li>WSGI: <span tal:content="python: \'On\' if server_info[\'wsgi\'] else \'Off\'" /></li>\n-        <li>Server:\n-          <span tal:content="python: server_info[\'server_name\']">waitress</span>\n-          <span tal:content="python: server_info[\'version\']">1.0.0</span>\n-        </li>\n-      </ul>\n-    </p>\n \n     <p tal:condition="not:view/is_dev_mode"\n        class="discreet"\ndiff --git a/Products/CMFPlone/controlpanel/browser/overview.py b/Products/CMFPlone/controlpanel/browser/overview.py\nindex 32ce909b4..541b30e66 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.py\n+++ b/Products/CMFPlone/controlpanel/browser/overview.py\n@@ -51,7 +51,7 @@ def pil(self):\n     def server_info(self):\n         wsgi = isinstance(self.request, WSGIRequest)\n         server_name = \'unknown\'\n-        server_version = \'unknown\'\n+        server_version = \'\'\n \n         # check for ZServer\n         servers = getattr(getConfiguration(), \'servers\', None)\n@@ -65,7 +65,7 @@ def server_info(self):\n                 try:\n                     server = pkg_resources.get_distribution(server_name)\n                     server_version = server.version\n-                except ImportError:\n+                except pkg_resources.DistributionNotFound:\n                     pass\n         return {\n             \'wsgi\': wsgi,\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-02-23T11:42:31+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/d2f057a7c0f0e99d751c92b3c998a48b67780c12

simplify (ZServer writes 'Zope/(4.0b8, python 2.7.15, darwin) ZServer/1.1' in SERVER_SOFTWARE)

Files changed:
M Products/CMFPlone/controlpanel/browser/overview.py

b"diff --git a/Products/CMFPlone/controlpanel/browser/overview.py b/Products/CMFPlone/controlpanel/browser/overview.py\nindex 541b30e66..b10a0edcb 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.py\n+++ b/Products/CMFPlone/controlpanel/browser/overview.py\n@@ -53,20 +53,16 @@ def server_info(self):\n         server_name = 'unknown'\n         server_version = ''\n \n-        # check for ZServer\n-        servers = getattr(getConfiguration(), 'servers', None)\n-        if servers and 'ZServer' in servers[0].__module__:\n-            server_name = 'ZServer'\n-            server_version = pkg_resources.get_distribution('ZServer').version\n-        else:\n-            # try to find the wsgi-server that is used\n-            server_name = self.request.get('SERVER_SOFTWARE')\n-            if server_name:\n-                try:\n-                    server = pkg_resources.get_distribution(server_name)\n-                    server_version = server.version\n-                except pkg_resources.DistributionNotFound:\n-                    pass\n+        server_name = self.request.get('SERVER_SOFTWARE')\n+        if server_name:\n+            if 'ZServer' in server_name:\n+                server_name = 'ZServer'\n+            try:\n+                server = pkg_resources.get_distribution(server_name)\n+                server_version = server.version\n+            except (pkg_resources.DistributionNotFound,\n+                    pkg_resources.RequirementParseError):\n+                pass\n         return {\n             'wsgi': wsgi,\n             'server_name': server_name,\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-02-23T14:46:50+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/0faef1bbe788d146cf922b184fd5da9d6d8e8dfd

Merge pull request #2770 from plone/show_wsgi_status_2763

Display wsgi-status and name/version of used server

Files changed:
A news/2770.feature
M Products/CMFPlone/controlpanel/browser/overview.pt
M Products/CMFPlone/controlpanel/browser/overview.py

b'diff --git a/Products/CMFPlone/controlpanel/browser/overview.pt b/Products/CMFPlone/controlpanel/browser/overview.pt\nindex b44cacce5..f22683fc2 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/overview.pt\n@@ -138,8 +138,22 @@\n       <tal:list-versions repeat="version view/version_overview">\n         <li tal:content="version">Version</li>\n       </tal:list-versions>\n+      <tal:server tal:define="server_info view/server_info;\n+                              has_wsgi server_info/wsgi;">\n+          <li>\n+            <tal:i18n i18n:translate="">WSGI:</tal:i18n>\n+            <span i18n:translate="" tal:condition="has_wsgi">On</span>\n+            <span i18n:translate="" tal:condition="not:has_wsgi">Off</span>\n+          </li>\n+          <li>\n+            <tal:i18n i18n:translate="">Server:</tal:i18n>\n+            <span>${server_info/server_name}</span>\n+            <span>${server_info/version}</span>\n+          </li>\n+      </tal:server>\n     </ul>\n \n+\n     <p tal:condition="not:view/is_dev_mode"\n        class="discreet"\n        i18n:translate="description_production_mode">\ndiff --git a/Products/CMFPlone/controlpanel/browser/overview.py b/Products/CMFPlone/controlpanel/browser/overview.py\nindex ddbb918f0..b10a0edcb 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.py\n+++ b/Products/CMFPlone/controlpanel/browser/overview.py\n@@ -10,6 +10,9 @@\n from plone.memoize.instance import memoize\n from plone.registry.interfaces import IRegistry\n from zope.component import getUtility\n+from ZPublisher.HTTPRequest import WSGIRequest\n+\n+import pkg_resources\n \n try:\n     import plone.app.event\n@@ -45,6 +48,27 @@ def core_versions(self):\n     def pil(self):\n         return \'PIL\' in self.core_versions()\n \n+    def server_info(self):\n+        wsgi = isinstance(self.request, WSGIRequest)\n+        server_name = \'unknown\'\n+        server_version = \'\'\n+\n+        server_name = self.request.get(\'SERVER_SOFTWARE\')\n+        if server_name:\n+            if \'ZServer\' in server_name:\n+                server_name = \'ZServer\'\n+            try:\n+                server = pkg_resources.get_distribution(server_name)\n+                server_version = server.version\n+            except (pkg_resources.DistributionNotFound,\n+                    pkg_resources.RequirementParseError):\n+                pass\n+        return {\n+            \'wsgi\': wsgi,\n+            \'server_name\': server_name,\n+            \'version\': server_version,\n+        }\n+\n     def version_overview(self):\n \n         core_versions = self.core_versions()\ndiff --git a/news/2770.feature b/news/2770.feature\nnew file mode 100644\nindex 000000000..63972d8e1\n--- /dev/null\n+++ b/news/2770.feature\n@@ -0,0 +1 @@\n+Display wsgi-state plus name and version of the server in the controlpanel [pbauer]\n\\ No newline at end of file\n'

