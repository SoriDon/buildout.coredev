Repository: plone.formwidget.namedfile


Branch: refs/heads/master
Date: 2017-06-09T09:25:25+03:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/plone.formwidget.namedfile/commit/a666726437cad0b89b2e84b46777ae412b0f844a

Fix issue where display widget failed to render file fields located on fieldsets

Files changed:
M CHANGES.rst
M plone/formwidget/namedfile/widget.py
M plone/formwidget/namedfile/widget.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 59e0a23..923347e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix issue where display widget failed to render file fields located
+  on form fieldsets, because of broken generated download url
+  [datakurre]
 
 
 2.0.2 (2016-08-15)
diff --git a/plone/formwidget/namedfile/widget.py b/plone/formwidget/namedfile/widget.py
index e56954e..66ce3cc 100644
--- a/plone/formwidget/namedfile/widget.py
+++ b/plone/formwidget/namedfile/widget.py
@@ -17,6 +17,7 @@
 from Products.Five.browser import BrowserView
 from Products.MimetypesRegistry.common import MimeTypeException
 from z3c.form.browser import file
+from z3c.form.group import Group
 from z3c.form.interfaces import IDataManager
 from z3c.form.interfaces import IFieldWidget
 from z3c.form.interfaces import IFormLayer
@@ -147,10 +148,18 @@ def download_url(self):
 
         absolute_url_method = getattr(self.context, 'absolute_url', None)
         if absolute_url_method:
-            url_parts.extend([
-                absolute_url_method(),
-                getattr(self.form, '__name__', None),
-            ])
+            if isinstance(self.form, Group):
+                url_parts.extend([
+                    absolute_url_method(),
+                    getattr(
+                        getattr(self.form, '__parent__', None),
+                        '__name__', None),
+                ])
+            else:
+                url_parts.extend([
+                    absolute_url_method(),
+                    getattr(self.form, '__name__', None),
+                ])
         else:
             url_parts.append(self.request.getURL())
 
diff --git a/plone/formwidget/namedfile/widget.rst b/plone/formwidget/namedfile/widget.rst
index 2a8d55a..d8303f2 100644
--- a/plone/formwidget/namedfile/widget.rst
+++ b/plone/formwidget/namedfile/widget.rst
@@ -970,6 +970,17 @@ view would get all ``Content`` instances on the folder and then use our widget
   >>> file_widget.download_url
   'http://127.0.0.1/content1/test-form/++widget++file_field/@@download/data.txt'
 
+The download URL also stays the same also when the field belongs to a group of
+a group form. This behavior assumes that groups are used to map fieldsets on a
+form (and not a group of separate objects)::
+
+  >>> from z3c.form.group import Group
+  >>> group = Group(content, file_widget.request, form)
+  >>> group.__name__ = 'test-fieldset'
+  >>> file_widget.form = group
+  >>> file_widget.download_url
+  'http://127.0.0.1/content1/test-form/++widget++file_field/@@download/data.txt'
+
 Some times the context does not have an URL i.e ``context.absolute_url`` is
 not implemented. In these cases the download URL will be::
 


Repository: plone.formwidget.namedfile


Branch: refs/heads/master
Date: 2017-06-09T11:25:05+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.formwidget.namedfile/commit/b4ceeb358e8816e42ca4759f4bedb00552a9cd9f

Merge pull request #27 from plone/datakurre-fieldsets

Fix issue where display widget failed to render fields on fieldsets

Files changed:
M CHANGES.rst
M plone/formwidget/namedfile/widget.py
M plone/formwidget/namedfile/widget.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 59e0a23..923347e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix issue where display widget failed to render file fields located
+  on form fieldsets, because of broken generated download url
+  [datakurre]
 
 
 2.0.2 (2016-08-15)
diff --git a/plone/formwidget/namedfile/widget.py b/plone/formwidget/namedfile/widget.py
index e56954e..66ce3cc 100644
--- a/plone/formwidget/namedfile/widget.py
+++ b/plone/formwidget/namedfile/widget.py
@@ -17,6 +17,7 @@
 from Products.Five.browser import BrowserView
 from Products.MimetypesRegistry.common import MimeTypeException
 from z3c.form.browser import file
+from z3c.form.group import Group
 from z3c.form.interfaces import IDataManager
 from z3c.form.interfaces import IFieldWidget
 from z3c.form.interfaces import IFormLayer
@@ -147,10 +148,18 @@ def download_url(self):
 
         absolute_url_method = getattr(self.context, 'absolute_url', None)
         if absolute_url_method:
-            url_parts.extend([
-                absolute_url_method(),
-                getattr(self.form, '__name__', None),
-            ])
+            if isinstance(self.form, Group):
+                url_parts.extend([
+                    absolute_url_method(),
+                    getattr(
+                        getattr(self.form, '__parent__', None),
+                        '__name__', None),
+                ])
+            else:
+                url_parts.extend([
+                    absolute_url_method(),
+                    getattr(self.form, '__name__', None),
+                ])
         else:
             url_parts.append(self.request.getURL())
 
diff --git a/plone/formwidget/namedfile/widget.rst b/plone/formwidget/namedfile/widget.rst
index 2a8d55a..d8303f2 100644
--- a/plone/formwidget/namedfile/widget.rst
+++ b/plone/formwidget/namedfile/widget.rst
@@ -970,6 +970,17 @@ view would get all ``Content`` instances on the folder and then use our widget
   >>> file_widget.download_url
   'http://127.0.0.1/content1/test-form/++widget++file_field/@@download/data.txt'
 
+The download URL also stays the same also when the field belongs to a group of
+a group form. This behavior assumes that groups are used to map fieldsets on a
+form (and not a group of separate objects)::
+
+  >>> from z3c.form.group import Group
+  >>> group = Group(content, file_widget.request, form)
+  >>> group.__name__ = 'test-fieldset'
+  >>> file_widget.form = group
+  >>> file_widget.download_url
+  'http://127.0.0.1/content1/test-form/++widget++file_field/@@download/data.txt'
+
 Some times the context does not have an URL i.e ``context.absolute_url`` is
 not implemented. In these cases the download URL will be::
 


