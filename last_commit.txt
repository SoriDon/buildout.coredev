Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-10-23T10:46:14+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/ddcfed528beeffcb7b7ef8e5cb58bf636a7db510

Fix set_own_login_name to use the portals acl_users

Files changed:
M CHANGES.rst
M Products/CMFPlone/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a51a0af10..0808b002b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -37,3 +37,6 @@ Bug Fixes:
 
 - Add zcml-condition plone-52 for conditional configuration.
   [pbauer]
+
+- Use getSite in set_own_login_name to get the portals acl_users.
+  [pbauer]
diff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py
index b92436fd0..357207613 100644
--- a/Products/CMFPlone/utils.py
+++ b/Products/CMFPlone/utils.py
@@ -621,8 +621,9 @@ def set_own_login_name(member, loginname):
     name of another member too, though the name of this function is a
     bit weird then.  Historical accident.
     """
-    pas = getToolByName(member, 'acl_users')
-    mt = getToolByName(member, 'portal_membership')
+    portal = getSite()
+    pas = getToolByName(portal, 'acl_users')
+    mt = getToolByName(portal, 'portal_membership')
     if member.getId() == mt.getAuthenticatedMember().getId():
         pas.updateOwnLoginName(loginname)
         return


