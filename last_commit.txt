Repository: Products.CMFFormController


Branch: refs/heads/master
Date: 2017-01-31T18:30:03+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFFormController/commit/e6fd9b911c776e877aff8edf6f7b7fdb95572b2c

If func_code is None, use __code__.

See also https://github.com/zopefoundation/zope.publisher/pull/10

Files changed:
M Products/CMFFormController/Script.py

diff --git a/Products/CMFFormController/Script.py b/Products/CMFFormController/Script.py
index d1e3417..c24f041 100644
--- a/Products/CMFFormController/Script.py
+++ b/Products/CMFFormController/Script.py
@@ -155,8 +155,12 @@ def _write(self, text, compile):
         if compile:
             ps._makeFunction()
             self._v_ft = ps._v_ft
-            self.func_code = ps.func_code
-            self.func_defaults = ps.func_defaults
+            if ps.func_code is None:
+                self.func_code = ps.__code__
+                self.func_defaults = ps.__defaults__
+            else:
+                self.func_code = ps.func_code
+                self.func_defaults = ps.func_defaults
         self._body = ps._body
         self._params = ps._params
         self.title = ps.title


Repository: Products.CMFFormController


Branch: refs/heads/master
Date: 2017-02-04T11:46:51+01:00
Author: Matthew Wilkes (MatthewWilkes) <git@matthewwilkes.name>
Commit: https://github.com/plone/Products.CMFFormController/commit/2191be378fe85c0ae490aa2ddcea4a8948eb990a

Always use __code__ and __defaults__, to match changes in CMFCore and publisher, like modern Python.

Files changed:
M CHANGES.rst
M Products/CMFFormController/ControllerPythonScript.py
M Products/CMFFormController/FSControllerPythonScript.py
M Products/CMFFormController/Script.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f1c107e..7677d2b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,12 +1,13 @@
 Changelog
 =========
 
-3.1.4 (unreleased)
+4.0.0 (unreleased)
 ------------------
 
 Breaking changes:
 
-- *add item here*
+- Always use __code__ and __defaults__, to match changes in CMFCore and publisher, like modern Python.
+  [MatthewWilkes]
 
 New features:
 
diff --git a/Products/CMFFormController/ControllerPythonScript.py b/Products/CMFFormController/ControllerPythonScript.py
index 49fe682..09cd9db 100644
--- a/Products/CMFFormController/ControllerPythonScript.py
+++ b/Products/CMFFormController/ControllerPythonScript.py
@@ -144,7 +144,7 @@ def __call__(self, *args, **kwargs):
         validators = self.getValidators(controller_state, REQUEST).getValidators()
 
         # put all arguments into a dict
-        c = self.func_code
+        c = self.__code__
         param_names = c.co_varnames[:c.co_argcount]
         argdict = {}
         index = 0
diff --git a/Products/CMFFormController/FSControllerPythonScript.py b/Products/CMFFormController/FSControllerPythonScript.py
index 3dc6bd6..cd322e4 100644
--- a/Products/CMFFormController/FSControllerPythonScript.py
+++ b/Products/CMFFormController/FSControllerPythonScript.py
@@ -88,7 +88,7 @@ def __call__(self, *args, **kwargs):
         validators = self.getValidators(controller_state, REQUEST).getValidators()
 
         # put all arguments into a dict
-        c = self.func_code
+        c = self.__code__
         param_names = c.co_varnames[:c.co_argcount]
         argdict = {}
         index = 0
diff --git a/Products/CMFFormController/Script.py b/Products/CMFFormController/Script.py
index c24f041..0b75acf 100644
--- a/Products/CMFFormController/Script.py
+++ b/Products/CMFFormController/Script.py
@@ -155,12 +155,8 @@ def _write(self, text, compile):
         if compile:
             ps._makeFunction()
             self._v_ft = ps._v_ft
-            if ps.func_code is None:
-                self.func_code = ps.__code__
-                self.func_defaults = ps.__defaults__
-            else:
-                self.func_code = ps.func_code
-                self.func_defaults = ps.func_defaults
+            self.__code__ = ps.__code__
+            self.__defaults__ = ps.__defaults__
         self._body = ps._body
         self._params = ps._params
         self.title = ps.title
diff --git a/setup.py b/setup.py
index 67e8178..1c4b192 100644
--- a/setup.py
+++ b/setup.py
@@ -1,6 +1,6 @@
 from setuptools import setup, find_packages
 
-version = '3.1.4.dev0'
+version = '4.0.0.dev0'
 
 setup(
     name='Products.CMFFormController',
@@ -11,8 +11,7 @@
                       open("CHANGES.rst").read()),
     classifiers=[
         "Framework :: Plone",
-        "Framework :: Plone :: 5.0",
-        "Framework :: Plone :: 5.1",
+        "Framework :: Plone :: 6.0",
         "Framework :: Zope2",
         "License :: OSI Approved :: BSD License",
         "License :: OSI Approved :: Zope Public License",
@@ -42,6 +41,6 @@
         'Products.GenericSetup>=1.8.3',
         'Acquisition',
         'transaction',
-        'Zope2',
+        'Zope2>=4.0.a2',
     ],
-)
\ No newline at end of file
+)


