Repository: plone.api


Branch: refs/heads/master
Date: 2016-01-29T09:07:30+01:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/plone.api/commit/c5ad32bc4d59f57287f0871679e20e14c59c5846

implement portal.get_default_language and portal.get_current_language

Files changed:
M docs/CHANGES.rst
M docs/portal.rst
M src/plone/api/portal.py
M src/plone/api/tests/test_portal.py

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index d6a2cc4..3d7ab97 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -6,7 +6,8 @@ Changelog
 
 New:
 
-- *add item here*
+- Add `portal.get_default_language` and `portal.get_current_language`
+  [ebrehault]
 
 Fixes:
 
diff --git a/docs/portal.rst b/docs/portal.rst
index 499fbae..4378800 100644
--- a/docs/portal.rst
+++ b/docs/portal.rst
@@ -125,6 +125,42 @@ To display the date/time in a user-friendly way, localized to the user's prefere
     self.assertEqual(DateTime(localized).__class__, DateTime)
 
 
+.. _portal_get_default_language_example:
+
+Get default language
+--------------------
+
+To get the default language, use :meth:`api.portal.get_default_language`.
+
+.. code-block:: python
+
+    from plone import api
+    lang = api.portal.get_default_language()
+
+.. invisible-code-block: python
+
+    # assert that the result is 'en'
+    self.assertEqual(lang, 'en')
+
+
+.. _portal_get_current_language_example:
+
+Get current language
+--------------------
+
+To get the currently negociated language, use :meth:`api.portal.get_current_language`.
+
+.. code-block:: python
+
+    from plone import api
+    lang = api.portal.get_current_language()
+
+.. invisible-code-block: python
+
+    # assert that the result is 'en'
+    self.assertEqual(lang, 'en')
+
+
 .. _portal_send_email_example:
 
 Send E-Mail
diff --git a/src/plone/api/portal.py b/src/plone/api/portal.py
index 7a3133e..7b244e3 100644
--- a/src/plone/api/portal.py
+++ b/src/plone/api/portal.py
@@ -360,3 +360,35 @@ def set_registry_record(name=None, value=None, interface=None):
         get_registry_record(name)
 
         registry[name] = value
+
+
+def get_default_language():
+    """Return the default language.
+
+    :returns: language identifier
+    :rtype: string
+    :Example: :ref:`portal_get_default_language_example`
+    """
+    try:
+        from Products.CMFPlone.interfaces import ILanguageSchema
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ILanguageSchema, prefix="plone")
+        return settings.default_language
+    except ImportError:
+        portal = get()
+        return portal.getProperty('default_language', None)
+
+
+def get_current_language(context=None):
+    """Return the current negociated language.
+
+    :param context: context object
+    :type name: object
+    :returns: language identifier
+    :rtype: string
+    :Example: :ref:`portal_get_current_language_example`
+    """
+    request = getRequest()
+    return request.get('LANGUAGE', None) or \
+        (context and aq_inner(context).Language()) \
+        or get_default_language()
diff --git a/src/plone/api/tests/test_portal.py b/src/plone/api/tests/test_portal.py
index 1a6aa93..ba557bd 100644
--- a/src/plone/api/tests/test_portal.py
+++ b/src/plone/api/tests/test_portal.py
@@ -786,3 +786,13 @@ def test_set_invalid_value_on_registry_record_from_interface_msg(self):
         )
         self.assertTrue(exc_str.find(" needs to be ") != -1)
         self.assertTrue(exc_str.find("TextLine") != -1)
+
+    def test_get_default_language(self):
+        """Test that default language is properly returned."""
+        self.assertEqual(portal.get_default_language(), 'en')
+
+    def test_get_current_language(self):
+        """Test that current language is properly returned."""
+        self.assertEqual(portal.get_current_language(portal.get()), 'en')
+        self.layer['request']['LANGUAGE'] = 'fr'
+        self.assertEqual(portal.get_current_language(), 'fr')


Repository: plone.api


Branch: refs/heads/master
Date: 2016-01-29T14:29:08+01:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/plone.api/commit/29174ffdf42b25dc17cacaa668de7aeffc58e90b

fix implementation for Plone 4

Files changed:
M src/plone/api/portal.py

diff --git a/src/plone/api/portal.py b/src/plone/api/portal.py
index 7b244e3..1910c73 100644
--- a/src/plone/api/portal.py
+++ b/src/plone/api/portal.py
@@ -376,7 +376,8 @@ def get_default_language():
         return settings.default_language
     except ImportError:
         portal = get()
-        return portal.getProperty('default_language', None)
+        return portal.portal_properties.site_properties.getProperty(
+            'default_language', None)
 
 
 def get_current_language(context=None):


Repository: plone.api


Branch: refs/heads/master
Date: 2016-01-29T15:08:54+01:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/plone.api/commit/5dd283c538abbc3c5c606e71aaf7410341741ce9

fix a gallicism

Files changed:
M docs/portal.rst

diff --git a/docs/portal.rst b/docs/portal.rst
index 4378800..cae9448 100644
--- a/docs/portal.rst
+++ b/docs/portal.rst
@@ -148,7 +148,7 @@ To get the default language, use :meth:`api.portal.get_default_language`.
 Get current language
 --------------------
 
-To get the currently negociated language, use :meth:`api.portal.get_current_language`.
+To get the currently negotiated language, use :meth:`api.portal.get_current_language`.
 
 .. code-block:: python
 


Repository: plone.api


Branch: refs/heads/master
Date: 2016-01-29T15:20:59+01:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/plone.api/commit/25b4fbe62845eae5544af93e9adaaa5142f14f2d

improve try/except writing

Files changed:
M src/plone/api/portal.py

diff --git a/src/plone/api/portal.py b/src/plone/api/portal.py
index 1910c73..434be5d 100644
--- a/src/plone/api/portal.py
+++ b/src/plone/api/portal.py
@@ -371,13 +371,14 @@ def get_default_language():
     """
     try:
         from Products.CMFPlone.interfaces import ILanguageSchema
-        registry = getUtility(IRegistry)
-        settings = registry.forInterface(ILanguageSchema, prefix="plone")
-        return settings.default_language
     except ImportError:
         portal = get()
         return portal.portal_properties.site_properties.getProperty(
             'default_language', None)
+    else:
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ILanguageSchema, prefix="plone")
+        return settings.default_language
 
 
 def get_current_language(context=None):


Repository: plone.api


Branch: refs/heads/master
Date: 2016-01-29T15:08:46Z
Author: Adam Forsythe-Cheasley (adamcheasley) <adam@netsight.co.uk>
Commit: https://github.com/plone/plone.api/commit/3b3fd8aa8e5bee9b9b9d5232aaedebe934ca26b5

Merge pull request #302 from plone/ebr-get-language

implement portal.get_default_language and portal.get_current_language

Files changed:
M docs/CHANGES.rst
M docs/portal.rst
M src/plone/api/portal.py
M src/plone/api/tests/test_portal.py

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 6d3b903..7526112 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -6,7 +6,8 @@ Changelog
 
 New:
 
-- *add item here*
+- Add `portal.get_default_language` and `portal.get_current_language`
+  [ebrehault]
 
 Fixes:
 
diff --git a/docs/portal.rst b/docs/portal.rst
index 499fbae..cae9448 100644
--- a/docs/portal.rst
+++ b/docs/portal.rst
@@ -125,6 +125,42 @@ To display the date/time in a user-friendly way, localized to the user's prefere
     self.assertEqual(DateTime(localized).__class__, DateTime)
 
 
+.. _portal_get_default_language_example:
+
+Get default language
+--------------------
+
+To get the default language, use :meth:`api.portal.get_default_language`.
+
+.. code-block:: python
+
+    from plone import api
+    lang = api.portal.get_default_language()
+
+.. invisible-code-block: python
+
+    # assert that the result is 'en'
+    self.assertEqual(lang, 'en')
+
+
+.. _portal_get_current_language_example:
+
+Get current language
+--------------------
+
+To get the currently negotiated language, use :meth:`api.portal.get_current_language`.
+
+.. code-block:: python
+
+    from plone import api
+    lang = api.portal.get_current_language()
+
+.. invisible-code-block: python
+
+    # assert that the result is 'en'
+    self.assertEqual(lang, 'en')
+
+
 .. _portal_send_email_example:
 
 Send E-Mail
diff --git a/src/plone/api/portal.py b/src/plone/api/portal.py
index 7a3133e..434be5d 100644
--- a/src/plone/api/portal.py
+++ b/src/plone/api/portal.py
@@ -360,3 +360,37 @@ def set_registry_record(name=None, value=None, interface=None):
         get_registry_record(name)
 
         registry[name] = value
+
+
+def get_default_language():
+    """Return the default language.
+
+    :returns: language identifier
+    :rtype: string
+    :Example: :ref:`portal_get_default_language_example`
+    """
+    try:
+        from Products.CMFPlone.interfaces import ILanguageSchema
+    except ImportError:
+        portal = get()
+        return portal.portal_properties.site_properties.getProperty(
+            'default_language', None)
+    else:
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ILanguageSchema, prefix="plone")
+        return settings.default_language
+
+
+def get_current_language(context=None):
+    """Return the current negociated language.
+
+    :param context: context object
+    :type name: object
+    :returns: language identifier
+    :rtype: string
+    :Example: :ref:`portal_get_current_language_example`
+    """
+    request = getRequest()
+    return request.get('LANGUAGE', None) or \
+        (context and aq_inner(context).Language()) \
+        or get_default_language()
diff --git a/src/plone/api/tests/test_portal.py b/src/plone/api/tests/test_portal.py
index 1a6aa93..ba557bd 100644
--- a/src/plone/api/tests/test_portal.py
+++ b/src/plone/api/tests/test_portal.py
@@ -786,3 +786,13 @@ def test_set_invalid_value_on_registry_record_from_interface_msg(self):
         )
         self.assertTrue(exc_str.find(" needs to be ") != -1)
         self.assertTrue(exc_str.find("TextLine") != -1)
+
+    def test_get_default_language(self):
+        """Test that default language is properly returned."""
+        self.assertEqual(portal.get_default_language(), 'en')
+
+    def test_get_current_language(self):
+        """Test that current language is properly returned."""
+        self.assertEqual(portal.get_current_language(portal.get()), 'en')
+        self.layer['request']['LANGUAGE'] = 'fr'
+        self.assertEqual(portal.get_current_language(), 'fr')


