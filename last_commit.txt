Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-04-17T19:17:21-05:00
Author: Jens Vagelpohl (dataflake) <jens@netz.ooo>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/c69d0315855db1e871adcd475abf12971dc3a4ea

Add the ability to specify a custom WSGI configuration file

Files changed:
A news/90.feature
M src/plone/recipe/zope2instance/ctl.py
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/news/90.feature b/news/90.feature\nnew file mode 100644\nindex 0000000..3cc6399\n--- /dev/null\n+++ b/news/90.feature\n@@ -0,0 +1 @@\n+Add the ability to specify a custom WSGI configuration file\ndiff --git a/src/plone/recipe/zope2instance/ctl.py b/src/plone/recipe/zope2instance/ctl.py\nindex e1fd2d5..caacd77 100644\n--- a/src/plone/recipe/zope2instance/ctl.py\n+++ b/src/plone/recipe/zope2instance/ctl.py\n@@ -922,14 +922,14 @@ def main(args=None):\n     """Customized entry point for launching Zope without forking other processes\n     """\n \n-    if \'--wsgi\' in args:\n+    if \'--wsgi\' in args or \'-w\' in args:\n         options = WSGICtlOptions()\n     else:\n         options = ZServerCtlOptions()\n     options.add(name="no_request", short="R", long="no-request", flag=1)\n     options.add(name="no_login", short="L", long="no-login", flag=1)\n     options.add(name="object_path", short="O:", long="object-path=")\n-    options.add(name="wsgi", short=\'w\', long=\'wsgi\', flag=1)\n+    options.add(name="wsgi", short=\'w:\', long=\'wsgi=\')\n     # Realize arguments and set documentation which is used in the -h option\n     options.realize(args, doc=__doc__)\n \n@@ -937,7 +937,7 @@ def main(args=None):\n     options.interpreter = os.path.join(options.directory, \'bin\', \'interpreter\')\n     if sys.platform == \'win32\':\n         options.interpreter += \'-script.py\'\n-    if six.PY2 and not options.wsgi:\n+    if six.PY2 and (options.wsgi or \'\').lower() in (\'off\', \'false\', \'0\'):\n         # only use zserver in Python 2 and if wsgi is disabled\n         from ZServer.Zope2.Startup import run\n         script = os.path.join(os.path.dirname(run.__file__), \'run.py\')\n@@ -949,9 +949,8 @@ def main(args=None):\n         # wsgi is the default\n         from Zope2.Startup import serve\n         script = os.path.join(os.path.dirname(serve.__file__), \'serve.py\')\n-        wsgi_ini = os.path.join(options.directory, \'etc\', \'wsgi.ini\')\n         options.program = [\n-            options.python, options.interpreter, script, wsgi_ini\n+            options.python, options.interpreter, script, options.wsgi\n         ]\n \n     c = ZopeCmd(options)\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 5e3bd3c..b21dff4 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -110,8 +110,12 @@ def __init__(self, buildout, name, options):\n         ) not in (\'off\', \'disable\', \'false\')\n \n         self.wsgi = True\n-        if six.PY2 and options.get(\'wsgi\') in (\'off\', \'false\'):\n+        self.wsgi_config = os.path.join(options[\'location\'], \'etc\', \'wsgi.ini\')\n+        wsgi_opt = options.get(\'wsgi\', \'on\')\n+        if six.PY2 and wsgi_opt.lower() in (\'off\', \'false\', \'0\'):\n             self.wsgi = False\n+        elif wsgi_opt.lower() not in (\'on\', \'true\', \'1\'):\n+            self.wsgi_config = wsgi_opt\n \n         # Get Scripts\' attributes\n         return Scripts.__init__(self, buildout, name, options)\n@@ -754,8 +758,8 @@ def __repr__(self):\n         arguments = ["-C", zope_conf_path, \'-p\', program_path]\n         if zopectl_umask:\n             arguments.extend(["--umask", int(zopectl_umask, 8)])\n-        if self.wsgi:\n-            arguments.append("--wsgi")\n+        if self.wsgi and self.wsgi_config:\n+            arguments.extend([\'-w\', self.wsgi_config])\n         script_arguments = (\'\\n        \' + repr(arguments) +\n                             \'\\n        + sys.argv[1:]\')\n \ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex c3a71e0..e6d2b83 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -1464,7 +1464,7 @@ We should have a zope instance script with the custom config file::\n     >>> if WINDOWS:\n     ...     instance_path += \'-script.py\'\n     >>> open(instance_path).read()\n-    "...plone.recipe.zope2instance.ctl.main(...[\'-C\', \'/some/path/my.conf\', \'-p\', \'.../bin/interpreter\', \'--wsgi\']..."\n+    "...plone.recipe.zope2instance.ctl.main(...[\'-C\', \'/some/path/my.conf\', \'-p\', \'.../bin/interpreter\', \'-w\', \'...etc/wsgi.ini\']..."\n \n Custom Zope Conf Imports\n ========================\n@@ -1506,6 +1506,41 @@ We should have a zope instance, with custom imports::\n     ...\n     <BLANKLINE>\n \n+Custom WSGI configuration\n+=========================\n+\n+`wsgi` is an option that allows you to use a specific WSGI config file.\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... wsgi = /some/path/service.ini\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+We should have a zope instance script with the custom config file::\n+\n+    >>> instance_path = join(\'bin\', \'instance\')\n+    >>> if WINDOWS:\n+    ...     instance_path += \'-script.py\'\n+    >>> open(instance_path).read()\n+    "...plone.recipe.zope2instance.ctl.main(...[\'-C\', \'/some/path/my.conf\', \'-p\', \'.../bin/interpreter\', \'-w\', \'/some/path/service.ini\']..."\n+\n+\n Resources directory\n ===================\n \n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-04-17T19:27:59-05:00
Author: Jens Vagelpohl (dataflake) <jens@netz.ooo>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/76b90c4455c45c0f4451efb70b4fc19824d4c71d

- fix test

Files changed:
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex e6d2b83..56a5515 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -1538,7 +1538,7 @@ We should have a zope instance script with the custom config file::\n     >>> if WINDOWS:\n     ...     instance_path += \'-script.py\'\n     >>> open(instance_path).read()\n-    "...plone.recipe.zope2instance.ctl.main(...[\'-C\', \'/some/path/my.conf\', \'-p\', \'.../bin/interpreter\', \'-w\', \'/some/path/service.ini\']..."\n+    "...plone.recipe.zope2instance.ctl.main(...[...\'-w\', \'/some/path/service.ini\']..."\n \n \n Resources directory\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-04-18T11:07:20+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/7eeda142fcfed485f43db51412d0be4199d3fd5a

Merge pull request #91 from plone/issue_90

Add the ability to specify a custom WSGI configuration file

Files changed:
A news/90.feature
M src/plone/recipe/zope2instance/ctl.py
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/news/90.feature b/news/90.feature\nnew file mode 100644\nindex 0000000..3cc6399\n--- /dev/null\n+++ b/news/90.feature\n@@ -0,0 +1 @@\n+Add the ability to specify a custom WSGI configuration file\ndiff --git a/src/plone/recipe/zope2instance/ctl.py b/src/plone/recipe/zope2instance/ctl.py\nindex e1fd2d5..caacd77 100644\n--- a/src/plone/recipe/zope2instance/ctl.py\n+++ b/src/plone/recipe/zope2instance/ctl.py\n@@ -922,14 +922,14 @@ def main(args=None):\n     """Customized entry point for launching Zope without forking other processes\n     """\n \n-    if \'--wsgi\' in args:\n+    if \'--wsgi\' in args or \'-w\' in args:\n         options = WSGICtlOptions()\n     else:\n         options = ZServerCtlOptions()\n     options.add(name="no_request", short="R", long="no-request", flag=1)\n     options.add(name="no_login", short="L", long="no-login", flag=1)\n     options.add(name="object_path", short="O:", long="object-path=")\n-    options.add(name="wsgi", short=\'w\', long=\'wsgi\', flag=1)\n+    options.add(name="wsgi", short=\'w:\', long=\'wsgi=\')\n     # Realize arguments and set documentation which is used in the -h option\n     options.realize(args, doc=__doc__)\n \n@@ -937,7 +937,7 @@ def main(args=None):\n     options.interpreter = os.path.join(options.directory, \'bin\', \'interpreter\')\n     if sys.platform == \'win32\':\n         options.interpreter += \'-script.py\'\n-    if six.PY2 and not options.wsgi:\n+    if six.PY2 and (options.wsgi or \'\').lower() in (\'off\', \'false\', \'0\'):\n         # only use zserver in Python 2 and if wsgi is disabled\n         from ZServer.Zope2.Startup import run\n         script = os.path.join(os.path.dirname(run.__file__), \'run.py\')\n@@ -949,9 +949,8 @@ def main(args=None):\n         # wsgi is the default\n         from Zope2.Startup import serve\n         script = os.path.join(os.path.dirname(serve.__file__), \'serve.py\')\n-        wsgi_ini = os.path.join(options.directory, \'etc\', \'wsgi.ini\')\n         options.program = [\n-            options.python, options.interpreter, script, wsgi_ini\n+            options.python, options.interpreter, script, options.wsgi\n         ]\n \n     c = ZopeCmd(options)\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 1d8f8fb..447bbbb 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -110,8 +110,12 @@ def __init__(self, buildout, name, options):\n         ) not in (\'off\', \'disable\', \'false\')\n \n         self.wsgi = True\n-        if six.PY2 and options.get(\'wsgi\') in (\'off\', \'false\'):\n+        self.wsgi_config = os.path.join(options[\'location\'], \'etc\', \'wsgi.ini\')\n+        wsgi_opt = options.get(\'wsgi\', \'on\')\n+        if six.PY2 and wsgi_opt.lower() in (\'off\', \'false\', \'0\'):\n             self.wsgi = False\n+        elif wsgi_opt.lower() not in (\'on\', \'true\', \'1\'):\n+            self.wsgi_config = wsgi_opt\n \n         # Get Scripts\' attributes\n         return Scripts.__init__(self, buildout, name, options)\n@@ -754,8 +758,8 @@ def __repr__(self):\n         arguments = ["-C", zope_conf_path, \'-p\', program_path]\n         if zopectl_umask:\n             arguments.extend(["--umask", int(zopectl_umask, 8)])\n-        if self.wsgi:\n-            arguments.append("--wsgi")\n+        if self.wsgi and self.wsgi_config:\n+            arguments.extend([\'-w\', self.wsgi_config])\n         script_arguments = (\'\\n        \' + repr(arguments) +\n                             \'\\n        + sys.argv[1:]\')\n \ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex c3a71e0..56a5515 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -1464,7 +1464,7 @@ We should have a zope instance script with the custom config file::\n     >>> if WINDOWS:\n     ...     instance_path += \'-script.py\'\n     >>> open(instance_path).read()\n-    "...plone.recipe.zope2instance.ctl.main(...[\'-C\', \'/some/path/my.conf\', \'-p\', \'.../bin/interpreter\', \'--wsgi\']..."\n+    "...plone.recipe.zope2instance.ctl.main(...[\'-C\', \'/some/path/my.conf\', \'-p\', \'.../bin/interpreter\', \'-w\', \'...etc/wsgi.ini\']..."\n \n Custom Zope Conf Imports\n ========================\n@@ -1506,6 +1506,41 @@ We should have a zope instance, with custom imports::\n     ...\n     <BLANKLINE>\n \n+Custom WSGI configuration\n+=========================\n+\n+`wsgi` is an option that allows you to use a specific WSGI config file.\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... wsgi = /some/path/service.ini\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+We should have a zope instance script with the custom config file::\n+\n+    >>> instance_path = join(\'bin\', \'instance\')\n+    >>> if WINDOWS:\n+    ...     instance_path += \'-script.py\'\n+    >>> open(instance_path).read()\n+    "...plone.recipe.zope2instance.ctl.main(...[...\'-w\', \'/some/path/service.ini\']..."\n+\n+\n Resources directory\n ===================\n \n'

