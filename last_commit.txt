Repository: plone.restapi


Branch: refs/heads/master
Date: 2023-04-17T20:29:18+02:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.restapi/commit/53be761641f221b7fcbfb8bdaa5f2db8272cc074

Fix param handling in querystringsearch GET (#1622)

Files changed:
A news/1621.bugfix
M src/plone/restapi/services/querystringsearch/get.py
M src/plone/restapi/tests/test_services_querystringsearch.py

b'diff --git a/news/1621.bugfix b/news/1621.bugfix\nnew file mode 100644\nindex 000000000..7878c27ea\n--- /dev/null\n+++ b/news/1621.bugfix\n@@ -0,0 +1 @@\n+Fix bugs in handling parameters when the `@querystringsearch` endpoint is called with the GET method. @davisagli\ndiff --git a/src/plone/restapi/services/querystringsearch/get.py b/src/plone/restapi/services/querystringsearch/get.py\nindex 79de69acc..3683dbd16 100644\n--- a/src/plone/restapi/services/querystringsearch/get.py\n+++ b/src/plone/restapi/services/querystringsearch/get.py\n@@ -7,8 +7,6 @@\n from urllib import parse\n from zope.component import getMultiAdapter\n \n-import json\n-\n \n zcatalog_version = get_distribution("Products.ZCatalog").version\n if parse_version(zcatalog_version) >= parse_version("5.1"):\n@@ -24,7 +22,8 @@ def __init__(self, context, request):\n         self.context = context\n         self.request = request\n \n-    def __call__(self, data):\n+    def __call__(self):\n+        data = json_body(self.request)\n         query = data.get("query", None)\n         b_start = int(data.get("b_start", 0))\n         b_size = int(data.get("b_size", 25))\n@@ -73,14 +72,16 @@ class QuerystringSearchPost(Service):\n \n     def reply(self):\n         querystring_search = QuerystringSearch(self.context, self.request)\n-        return querystring_search(data=json_body(self.request))\n+        return querystring_search()\n \n \n class QuerystringSearchGet(Service):\n     """Returns the querystring search results given a p.a.querystring data."""\n \n     def reply(self):\n+        # We need to copy the JSON query parameters from the querystring\n+        # into the request body, because that\'s where other code expects to find them\n+        self.request["BODY"] = parse.unquote(self.request.form.get("query", "{}"))\n+\n         querystring_search = QuerystringSearch(self.context, self.request)\n-        return querystring_search(\n-            data=json.loads(parse.unquote(self.request.form.get("query", "{}")))\n-        )\n+        return querystring_search()\ndiff --git a/src/plone/restapi/tests/test_services_querystringsearch.py b/src/plone/restapi/tests/test_services_querystringsearch.py\nindex 69f777a3b..b199fbc46 100644\n--- a/src/plone/restapi/tests/test_services_querystringsearch.py\n+++ b/src/plone/restapi/tests/test_services_querystringsearch.py\n@@ -53,14 +53,17 @@ def test_querystringsearch_basic(self):\n         self.assertNotIn("effective", response.json()["items"][0])\n \n     def test_querystringsearch_basic_get(self):\n+        self.portal.invokeFactory("Document", "doc2", title="Test Document 2")\n+        transaction.commit()\n+\n         response = self.api_session.get(\n-            "/@querystring-search?query=%7B%22query%22%3A%5B%7B%22i%22%3A%22portal_type%22%2C%22o%22%3A%20%22plone.app.querystring.operation.selection.any%22%2C%22v%22%3A%5B%22Document%22%5D%7D%5D%7D"\n+            "/@querystring-search?query=%7B%22query%22%3A%20%5B%7B%22i%22%3A%20%22portal_type%22%2C%20%22o%22%3A%20%22plone.app.querystring.operation.selection.any%22%2C%20%22v%22%3A%20%5B%22Document%22%5D%7D%5D%2C%20%22b_size%22%3A%201%7D"\n         )\n \n         self.assertEqual(response.status_code, 200)\n         self.assertIn("items", response.json())\n         self.assertIn("items_total", response.json())\n-        self.assertEqual(response.json()["items_total"], 1)\n+        self.assertEqual(response.json()["items_total"], 2)\n         self.assertEqual(len(response.json()["items"]), 1)\n         self.assertNotIn("effective", response.json()["items"][0])\n \n'

