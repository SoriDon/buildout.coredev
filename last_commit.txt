Repository: mockup


Branch: refs/heads/master
Date: 2016-02-18T16:50:29+01:00
Author: Gagaro (Gagaro) <gagaro42@gmail.com>
Commit: https://github.com/plone/mockup/commit/f7821dbe237bda7adb341e6e18c37e005d30a6e1

fix: ensure we have all content for tree query in relateditems

Files changed:
M CHANGES.rst
M mockup/patterns/relateditems/pattern.js
M mockup/tests/pattern-relateditems-test.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 53b93ca..41e12ca 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -34,9 +34,13 @@ Fixes:
 
 - Fix `aria-hidden` attribute control problem on folder content panel
   [terapyon]
+
 - Trim links in tinymce before inserting them in the source.
   [Gagaro]
 
+- Ensure we have all content for tree query in relateditems
+  [Gagaro]
+
 2.1.2 (2016-01-08)
 ------------------
 
diff --git a/mockup/patterns/relateditems/pattern.js b/mockup/patterns/relateditems/pattern.js
index 08b87fe..2773cb7 100644
--- a/mockup/patterns/relateditems/pattern.js
+++ b/mockup/patterns/relateditems/pattern.js
@@ -108,6 +108,9 @@ define([
       attributes: ['UID', 'Title', 'portal_type', 'path','getURL', 'getIcon','is_folderish','review_state'],
       dropdownCssClass: 'pattern-relateditems-dropdown',
       maximumSelectionSize: -1,
+      treeOptions: {
+        vocabularyUrl: null, // must be set to work
+      },
       resultTemplate: '' +
         '<div class="   pattern-relateditems-result  <% if (selected) { %>pattern-relateditems-active<% } %>">' +
         '  <a href="#" class=" pattern-relateditems-result-select <% if (selectable) { %>selectable<% } %>">' +
@@ -365,12 +368,13 @@ define([
       self.treeQuery = new utils.QueryHelper(
         $.extend(true, {}, self.options, {
           pattern: self,
+          vocabularyUrl: self.options.treeOptions.vocabularyUrl || self.options.vocabularyUrl,
           baseCriteria: [{
             i: 'is_folderish',
             o: 'plone.app.querystring.operation.selection.any',
             v: 'True'
           }]
-        })
+        }, self.options.treeOptions)
       );
 
       self.options.ajax = self.options.setupAjax.apply(self);
diff --git a/mockup/tests/pattern-relateditems-test.js b/mockup/tests/pattern-relateditems-test.js
index 2daea1d..bd5e511 100644
--- a/mockup/tests/pattern-relateditems-test.js
+++ b/mockup/tests/pattern-relateditems-test.js
@@ -307,7 +307,8 @@ define([
         '<div>' +
         ' <input class="pat-relateditems"' +
         '        data-pat-relateditems="width: 300px;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -329,7 +330,8 @@ define([
         '<div>' +
         ' <input class="pat-relateditems"' +
         '        data-pat-relateditems="width: 300px;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -353,7 +355,8 @@ define([
         '<div>' +
         ' <input class="pat-relateditems"' +
         '        data-pat-relateditems="width: 300px;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -384,7 +387,8 @@ define([
         ' <input class="pat-relateditems"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -405,7 +409,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -421,7 +426,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
 
       var clock = sinon.useFakeTimers();
@@ -443,7 +449,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
 
       var clock = sinon.useFakeTimers();
@@ -469,7 +476,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
 
       var clock = sinon.useFakeTimers();
@@ -498,7 +506,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
 
       var clock = sinon.useFakeTimers();


Repository: mockup


Branch: refs/heads/master
Date: 2016-02-18T09:57:37-06:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/mockup/commit/0e51032bbe06dbbb237a3c6d99040889b6db3a5d

Merge pull request #596 from plone/fix-relateditems-treequery

fix: ensure we have all content for tree query in relateditems

Files changed:
M CHANGES.rst
M mockup/patterns/relateditems/pattern.js
M mockup/tests/pattern-relateditems-test.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 53b93ca..41e12ca 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -34,9 +34,13 @@ Fixes:
 
 - Fix `aria-hidden` attribute control problem on folder content panel
   [terapyon]
+
 - Trim links in tinymce before inserting them in the source.
   [Gagaro]
 
+- Ensure we have all content for tree query in relateditems
+  [Gagaro]
+
 2.1.2 (2016-01-08)
 ------------------
 
diff --git a/mockup/patterns/relateditems/pattern.js b/mockup/patterns/relateditems/pattern.js
index 08b87fe..2773cb7 100644
--- a/mockup/patterns/relateditems/pattern.js
+++ b/mockup/patterns/relateditems/pattern.js
@@ -108,6 +108,9 @@ define([
       attributes: ['UID', 'Title', 'portal_type', 'path','getURL', 'getIcon','is_folderish','review_state'],
       dropdownCssClass: 'pattern-relateditems-dropdown',
       maximumSelectionSize: -1,
+      treeOptions: {
+        vocabularyUrl: null, // must be set to work
+      },
       resultTemplate: '' +
         '<div class="   pattern-relateditems-result  <% if (selected) { %>pattern-relateditems-active<% } %>">' +
         '  <a href="#" class=" pattern-relateditems-result-select <% if (selectable) { %>selectable<% } %>">' +
@@ -365,12 +368,13 @@ define([
       self.treeQuery = new utils.QueryHelper(
         $.extend(true, {}, self.options, {
           pattern: self,
+          vocabularyUrl: self.options.treeOptions.vocabularyUrl || self.options.vocabularyUrl,
           baseCriteria: [{
             i: 'is_folderish',
             o: 'plone.app.querystring.operation.selection.any',
             v: 'True'
           }]
-        })
+        }, self.options.treeOptions)
       );
 
       self.options.ajax = self.options.setupAjax.apply(self);
diff --git a/mockup/tests/pattern-relateditems-test.js b/mockup/tests/pattern-relateditems-test.js
index 2daea1d..bd5e511 100644
--- a/mockup/tests/pattern-relateditems-test.js
+++ b/mockup/tests/pattern-relateditems-test.js
@@ -307,7 +307,8 @@ define([
         '<div>' +
         ' <input class="pat-relateditems"' +
         '        data-pat-relateditems="width: 300px;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -329,7 +330,8 @@ define([
         '<div>' +
         ' <input class="pat-relateditems"' +
         '        data-pat-relateditems="width: 300px;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -353,7 +355,8 @@ define([
         '<div>' +
         ' <input class="pat-relateditems"' +
         '        data-pat-relateditems="width: 300px;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -384,7 +387,8 @@ define([
         ' <input class="pat-relateditems"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -405,7 +409,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
       var pattern = $('.pat-relateditems', $el).patternRelateditems().data('patternRelateditems');
 
@@ -421,7 +426,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
 
       var clock = sinon.useFakeTimers();
@@ -443,7 +449,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
 
       var clock = sinon.useFakeTimers();
@@ -469,7 +476,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
 
       var clock = sinon.useFakeTimers();
@@ -498,7 +506,8 @@ define([
         '        value="asdf1234,sdfbsfdh345,asdlfkjasdlfkjasdf,kokpoius98"' +
         '        data-pat-relateditems="width: 300px;' +
         '                          maximumSelectionSize: 1;' +
-        '                          vocabularyUrl: /relateditems-test.json" />' +
+        '                          vocabularyUrl: /relateditems-test.json;' +
+        '                          treeOptions: {vocabularyUrl: /relateditems-test.json}" />' +
         '</div>').appendTo('body');
 
       var clock = sinon.useFakeTimers();


