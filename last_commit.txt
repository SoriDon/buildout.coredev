Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-05-01T21:53:38-05:00
Author: nathan.vangheem () <nathan.vangheem@wildcardcorp.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/a70a3d1aa0db60746d099aa71a4305539f372f43

Fix issue where incorrectly configured formats would cause TinyMCE to error

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/tinymce.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6117468..bf29bfa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,9 +10,9 @@ Changelog
 
 Incompatibilities:
 
-- Moved code around and deprecated old locations in ``Products/CMFPlone/patterns/__init__``. 
+- Moved code around and deprecated old locations in ``Products/CMFPlone/patterns/__init__``.
   This goes together with same pattern settings changes in ``plone.app.layout.globals.pattern_settings``.
-  Also moved general usable ``./patterns/utils/get_portal`` to ``./utils/.get_portal``. 
+  Also moved general usable ``./patterns/utils/get_portal`` to ``./utils/.get_portal``.
   Depreacted ``./patterns/utils/get_portal`` and ``./patterns/utils/get_portal``.
   [jensens]
 
@@ -20,21 +20,24 @@ New:
 
 - Supported ``remove`` keyword for configlets in controlpanel.xml.  [maurits]
 
-- Deprecated Gruntfile generation script ``plone-generate-gruntfile``. 
-  Modified the ``plone-compile-resources`` script to support more parameters in order to take over that single task too. 
+- Deprecated Gruntfile generation script ``plone-generate-gruntfile``.
+  Modified the ``plone-compile-resources`` script to support more parameters in order to take over that single task too.
   Also clean up of parameters, better help and refactored parts of the code.
   [jensens]
 
 Fixes:
 
+- Fix issue where incorrectly configured formats would cause TinyMCE to error
+  [vangheem]
+
 - Closes #1513 'Wrong portal_url used for TinyMCE in multilingual site',
   also refactors the patterns settings and cleans it up.
   [jensens]
 
-- Removed inconsistency in the display of `Site Setup` links under 'Users and Groups' 
+- Removed inconsistency in the display of `Site Setup` links under 'Users and Groups'
   control panel.
   [kkhan]
- 
+
 - Only encode JS body if unicode in gruntfile generation script to avoid
   unicode error.
   [jensens]
@@ -107,10 +110,10 @@ New:
 
 Fixes:
 
-- Make Gruntfile.js generation script a bit more verbose to show the effective 
-  locations of the generated bundles. This helps in case of non-working setups 
-  also as if bundle compilation was started in browser at a first run a and  
-  next run was run using the script and files were generated at different 
+- Make Gruntfile.js generation script a bit more verbose to show the effective
+  locations of the generated bundles. This helps in case of non-working setups
+  also as if bundle compilation was started in browser at a first run a and
+  next run was run using the script and files were generated at different
   places than expected.
   [jensens]
 
diff --git a/Products/CMFPlone/patterns/tinymce.py b/Products/CMFPlone/patterns/tinymce.py
index 5176e56..64e0d90 100644
--- a/Products/CMFPlone/patterns/tinymce.py
+++ b/Products/CMFPlone/patterns/tinymce.py
@@ -62,6 +62,15 @@ def get_style_format(self, txt, _type='format', base=None):
             val['icon'] = parts[2]
         return val
 
+    def get_styles(self, styles, _type='format', base=None):
+        result = []
+        for style in styles:
+            style = self.get_style_format(style, _type, base)
+            if not style:
+                continue
+            result.append(style)
+        return result
+
     def get_all_style_formats(self):
         header_styles = self.settings.header_styles or []
         block_styles = self.settings.block_styles or []
@@ -70,22 +79,19 @@ def get_all_style_formats(self):
         table_styles = self.settings.table_styles or []
         return [{
             'title': 'Headers',
-            'items': [self.get_style_format(t) for t in header_styles]
+            'items': self.get_styles(header_styles)
         }, {
             'title': 'Block',
-            'items': [self.get_style_format(t) for t in block_styles]
+            'items': self.get_styles(block_styles)
         }, {
             'title': 'Inline',
-            'items': [self.get_style_format(t) for t in inline_styles]
+            'items': self.get_styles(inline_styles)
         }, {
             'title': 'Alignment',
-            'items': [self.get_style_format(t) for t in alignment_styles]
+            'items': self.get_styles(alignment_styles)
         }, {
             'title': 'Tables',
-            'items': [
-                self.get_style_format(t, 'classes', {'selector': 'table'})
-                for t in table_styles
-            ]
+            'items': self.get_styles(table_styles)
         }]
 
     def get_tiny_config(self):


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-05-02T10:53:34+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/efe410ef8ae93c7d8b5cdf742848dc1fda986243

Merge pull request #1566 from plone/tinymce-formats-5-1

Fix issue where incorrectly configured formats(5.1)

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/tinymce.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6117468..bf29bfa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,9 +10,9 @@ Changelog
 
 Incompatibilities:
 
-- Moved code around and deprecated old locations in ``Products/CMFPlone/patterns/__init__``. 
+- Moved code around and deprecated old locations in ``Products/CMFPlone/patterns/__init__``.
   This goes together with same pattern settings changes in ``plone.app.layout.globals.pattern_settings``.
-  Also moved general usable ``./patterns/utils/get_portal`` to ``./utils/.get_portal``. 
+  Also moved general usable ``./patterns/utils/get_portal`` to ``./utils/.get_portal``.
   Depreacted ``./patterns/utils/get_portal`` and ``./patterns/utils/get_portal``.
   [jensens]
 
@@ -20,21 +20,24 @@ New:
 
 - Supported ``remove`` keyword for configlets in controlpanel.xml.  [maurits]
 
-- Deprecated Gruntfile generation script ``plone-generate-gruntfile``. 
-  Modified the ``plone-compile-resources`` script to support more parameters in order to take over that single task too. 
+- Deprecated Gruntfile generation script ``plone-generate-gruntfile``.
+  Modified the ``plone-compile-resources`` script to support more parameters in order to take over that single task too.
   Also clean up of parameters, better help and refactored parts of the code.
   [jensens]
 
 Fixes:
 
+- Fix issue where incorrectly configured formats would cause TinyMCE to error
+  [vangheem]
+
 - Closes #1513 'Wrong portal_url used for TinyMCE in multilingual site',
   also refactors the patterns settings and cleans it up.
   [jensens]
 
-- Removed inconsistency in the display of `Site Setup` links under 'Users and Groups' 
+- Removed inconsistency in the display of `Site Setup` links under 'Users and Groups'
   control panel.
   [kkhan]
- 
+
 - Only encode JS body if unicode in gruntfile generation script to avoid
   unicode error.
   [jensens]
@@ -107,10 +110,10 @@ New:
 
 Fixes:
 
-- Make Gruntfile.js generation script a bit more verbose to show the effective 
-  locations of the generated bundles. This helps in case of non-working setups 
-  also as if bundle compilation was started in browser at a first run a and  
-  next run was run using the script and files were generated at different 
+- Make Gruntfile.js generation script a bit more verbose to show the effective
+  locations of the generated bundles. This helps in case of non-working setups
+  also as if bundle compilation was started in browser at a first run a and
+  next run was run using the script and files were generated at different
   places than expected.
   [jensens]
 
diff --git a/Products/CMFPlone/patterns/tinymce.py b/Products/CMFPlone/patterns/tinymce.py
index 5176e56..64e0d90 100644
--- a/Products/CMFPlone/patterns/tinymce.py
+++ b/Products/CMFPlone/patterns/tinymce.py
@@ -62,6 +62,15 @@ def get_style_format(self, txt, _type='format', base=None):
             val['icon'] = parts[2]
         return val
 
+    def get_styles(self, styles, _type='format', base=None):
+        result = []
+        for style in styles:
+            style = self.get_style_format(style, _type, base)
+            if not style:
+                continue
+            result.append(style)
+        return result
+
     def get_all_style_formats(self):
         header_styles = self.settings.header_styles or []
         block_styles = self.settings.block_styles or []
@@ -70,22 +79,19 @@ def get_all_style_formats(self):
         table_styles = self.settings.table_styles or []
         return [{
             'title': 'Headers',
-            'items': [self.get_style_format(t) for t in header_styles]
+            'items': self.get_styles(header_styles)
         }, {
             'title': 'Block',
-            'items': [self.get_style_format(t) for t in block_styles]
+            'items': self.get_styles(block_styles)
         }, {
             'title': 'Inline',
-            'items': [self.get_style_format(t) for t in inline_styles]
+            'items': self.get_styles(inline_styles)
         }, {
             'title': 'Alignment',
-            'items': [self.get_style_format(t) for t in alignment_styles]
+            'items': self.get_styles(alignment_styles)
         }, {
             'title': 'Tables',
-            'items': [
-                self.get_style_format(t, 'classes', {'selector': 'table'})
-                for t in table_styles
-            ]
+            'items': self.get_styles(table_styles)
         }]
 
     def get_tiny_config(self):


