Repository: plone.versioncheck


Branch: refs/heads/master
Date: 2017-05-05T11:12:31+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.versioncheck/commit/7778dfd27621a027128578d99f6919d5740d8d6f

reduce load on PyPI when fetching release dates

Files changed:
M CHANGES.rst
M src/plone/versioncheck/pypi.py
M src/plone/versioncheck/script.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f3cf11e..f3045bb 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 1.6.3 (unreleased)
 ------------------
 
+- Optimization: Reduce load on PyPI when fetching release dates.
+  [jensens]
+
 - Feature: Change package and version fields in html output to links so that you could open pypi page for each package.
   [loechel]
 
diff --git a/src/plone/versioncheck/pypi.py b/src/plone/versioncheck/pypi.py
index 61d54ed..72806e2 100644
--- a/src/plone/versioncheck/pypi.py
+++ b/src/plone/versioncheck/pypi.py
@@ -209,9 +209,7 @@ def check_all(pkgsinfo, limit=None, nocache=False):
 def update_pkg_info(pkg_name, pkg_data, session):
     for filename, elemdata in pkg_data.items():
         # fetch pkgs json info from pypi
-        url = '{url}/{name}/{version}/json'.format(url=PYPI_URL,
-                                                   name=pkg_name,
-                                                   version=elemdata['v'])
+        url = '{url}/{name}/json'.format(url=PYPI_URL, name=pkg_name)
         resp = session.get(url)
 
         # check status code
@@ -220,7 +218,12 @@ def update_pkg_info(pkg_name, pkg_data, session):
         data = resp.json()
 
         rel_date = datetime.date(1970, 1, 1)
-        for rel_pkg in data['urls']:
+        try:
+            urls = data['releases'][elemdata['v']]
+        except KeyError:
+            # release not on PyPI
+            continue
+        for rel_pkg in urls:
             time_string = rel_pkg.get('upload_time')
             if time_string:
                 crel_date = datetime.datetime.strptime(
diff --git a/src/plone/versioncheck/script.py b/src/plone/versioncheck/script.py
index 88f9903..4dad995 100644
--- a/src/plone/versioncheck/script.py
+++ b/src/plone/versioncheck/script.py
@@ -129,9 +129,10 @@ def run():
         tracking.get(pkgsinfo, args.buildout)
     if args.pypi:
         check_all(pkgsinfo, args.debug_limit, nocache=args.no_cache)
-        update_pkgs_info(pkgsinfo, args.debug_limit, nocache=args.no_cache)
-        if not args.ignore_tracking:
-            update_tracking_info(pkgsinfo, nocache=args.no_cache)
+        if args.show_release_dates:
+            update_pkgs_info(pkgsinfo, args.debug_limit, nocache=args.no_cache)
+            if not args.ignore_tracking:
+                update_tracking_info(pkgsinfo, nocache=args.no_cache)
 
     # Create output
     if args.machine:


