Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-03-13T14:42:25+01:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/0a9e08fde0b44b9d41adde20a49ea124eb994e4b

Use ``getSite()`` instead of portal url for controlpanel portlets
For the controlpanel portlets, use the nearest site url as a base for the overview-controlpanel.
This gives more flexibility for sub site controlpanels.

Files changed:
M CHANGES.rst
M Products/CMFPlone/PloneControlPanel.py
M Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index 357088c..80cd06a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -19,7 +19,11 @@ Incompatibilities:
 
 New:
 
-- Control panel to mange portal actions
+- For the controlpanel portlets, use the nearest site url as a base for the overview-controlpanel.
+  This gives more flexibility for sub site controlpanels.
+  [thet]
+
+- Control panel to mange portal actions.
   [ebrehault]
 
 - new less variable to configure the width of the toolbars submenu called
diff --git a/Products/CMFPlone/PloneControlPanel.py b/Products/CMFPlone/PloneControlPanel.py
index c939db7..9ce7a99 100644
--- a/Products/CMFPlone/PloneControlPanel.py
+++ b/Products/CMFPlone/PloneControlPanel.py
@@ -14,6 +14,7 @@
 from Products.CMFPlone import PloneMessageFactory as _
 from Products.CMFPlone.interfaces import IControlPanel
 from Products.CMFPlone.PloneBaseTool import PloneBaseTool
+from zope.component.hooks import getSite
 from zope.i18n import translate
 from zope.i18nmessageid import Message
 from zope.interface import implements
@@ -297,5 +298,15 @@ def manage_editActionsForm(self, REQUEST, manage_tabs_message=None):
             manage_tabs_message=manage_tabs_message,
         )
 
+    @property
+    def site_url(self):
+        """Return the absolute URL to the current site, which is likely not
+        necessarily the portal root.
+        Used by ``portlet_prefs`` to construct the URL to
+        ``@@overview-controlpanel``.
+        """
+        return getSite().absolute_url()
+
+
 InitializeClass(PloneControlPanel)
 registerToolInterface('portal_controlpanel', IControlPanel)
diff --git a/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt b/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt
index 02d881f..715c7c5 100644
--- a/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt
+++ b/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt
@@ -7,14 +7,14 @@
 <metal:portlet define-macro="portlet"
    tal:define="controlPanel python:modules['Products.CMFCore.utils'].getToolByName(here, 'portal_controlpanel');
                groups python:controlPanel.getGroups('site');
-               portal_url context/portal_url;">
+               site_url controlPanel/site_url">
 
 <section class="portlet portletNavigationTree portletSiteSetup" role="section"
     id="portlet-prefs"
     tal:condition="controlPanel/maySeeSomeConfiglets">
   <header class="portletHeader">
         <a href=""
-           tal:attributes="href string:${portal_url}/@@overview-controlpanel"
+           tal:attributes="href string:${site_url}/@@overview-controlpanel"
            i18n:translate="">Site Setup</a>
   </header>
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-03-14T11:07:01+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/bce5c64659ac0c4dedf18f9844c6a3a63ca4b464

Merge pull request #1459 from plone/thet_controlpanel_site_url

Use ``getSite()`` instead of portal url for controlpanel portlets

Files changed:
M CHANGES.rst
M Products/CMFPlone/PloneControlPanel.py
M Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index 02f37f5..997eca2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -19,7 +19,11 @@ Incompatibilities:
 
 New:
 
-- Control panel to mange portal actions
+- For the controlpanel portlets, use the nearest site url as a base for the overview-controlpanel.
+  This gives more flexibility for sub site controlpanels.
+  [thet]
+
+- Control panel to mange portal actions.
   [ebrehault]
 
 - new less variable to configure the width of the toolbars submenu called
diff --git a/Products/CMFPlone/PloneControlPanel.py b/Products/CMFPlone/PloneControlPanel.py
index c939db7..9ce7a99 100644
--- a/Products/CMFPlone/PloneControlPanel.py
+++ b/Products/CMFPlone/PloneControlPanel.py
@@ -14,6 +14,7 @@
 from Products.CMFPlone import PloneMessageFactory as _
 from Products.CMFPlone.interfaces import IControlPanel
 from Products.CMFPlone.PloneBaseTool import PloneBaseTool
+from zope.component.hooks import getSite
 from zope.i18n import translate
 from zope.i18nmessageid import Message
 from zope.interface import implements
@@ -297,5 +298,15 @@ def manage_editActionsForm(self, REQUEST, manage_tabs_message=None):
             manage_tabs_message=manage_tabs_message,
         )
 
+    @property
+    def site_url(self):
+        """Return the absolute URL to the current site, which is likely not
+        necessarily the portal root.
+        Used by ``portlet_prefs`` to construct the URL to
+        ``@@overview-controlpanel``.
+        """
+        return getSite().absolute_url()
+
+
 InitializeClass(PloneControlPanel)
 registerToolInterface('portal_controlpanel', IControlPanel)
diff --git a/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt b/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt
index 02d881f..715c7c5 100644
--- a/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt
+++ b/Products/CMFPlone/skins/plone_prefs/portlet_prefs.pt
@@ -7,14 +7,14 @@
 <metal:portlet define-macro="portlet"
    tal:define="controlPanel python:modules['Products.CMFCore.utils'].getToolByName(here, 'portal_controlpanel');
                groups python:controlPanel.getGroups('site');
-               portal_url context/portal_url;">
+               site_url controlPanel/site_url">
 
 <section class="portlet portletNavigationTree portletSiteSetup" role="section"
     id="portlet-prefs"
     tal:condition="controlPanel/maySeeSomeConfiglets">
   <header class="portletHeader">
         <a href=""
-           tal:attributes="href string:${portal_url}/@@overview-controlpanel"
+           tal:attributes="href string:${site_url}/@@overview-controlpanel"
            i18n:translate="">Site Setup</a>
   </header>
 


