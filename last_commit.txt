Repository: plone.restapi


Branch: refs/heads/master
Date: 2023-04-07T09:32:52+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.restapi/commit/9241e726850fc9b3ecdb8d0b955a130db3fe114c

Fixed encoding issue on Python 3 for some mail servers. [master] (#1607)

Fixed encoding issue on Python 3 for some mail servers.

This could result in missing characters in an email body.
See https://github.com/plone/Products.CMFPlone/issues/3754

Co-authored-by: Timo Stollenwerk &lt;tisto@users.noreply.github.com&gt;

Files changed:
A news/3754.bugfix
M src/plone/restapi/services/email_send/post.py

b'diff --git a/news/3754.bugfix b/news/3754.bugfix\nnew file mode 100644\nindex 000000000..efbee7ec8\n--- /dev/null\n+++ b/news/3754.bugfix\n@@ -0,0 +1,3 @@\n+Fixed encoding issue on Python 3 for some mail servers.\n+This could result in missing characters in an email body.\n+[maurits]\ndiff --git a/src/plone/restapi/services/email_send/post.py b/src/plone/restapi/services/email_send/post.py\nindex b4315829b..8adf29fe9 100644\n--- a/src/plone/restapi/services/email_send/post.py\n+++ b/src/plone/restapi/services/email_send/post.py\n@@ -1,6 +1,5 @@\n from AccessControl import getSecurityManager\n from AccessControl.Permissions import use_mailhost_services\n-from email.mime.text import MIMEText\n from plone.registry.interfaces import IRegistry\n from plone.restapi import _\n from plone.restapi.bbb import IMailSchema\n@@ -15,6 +14,14 @@\n \n import plone\n \n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n+\n \n class EmailSendPost(Service):\n     def reply(self):\n@@ -99,7 +106,7 @@ def reply(self):\n \n         message = f"{message_intro} \\n {message}"\n \n-        message = MIMEText(message, "plain", encoding)\n+        message = message_from_string(message)\n         message["Reply-To"] = sender_from_address\n         try:\n             host.send(\n'

