Repository: plone.volto


Branch: refs/heads/main
Date: 2022-11-10T16:32:12+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/f093f4029815266906553c1d3ebe5694e1227c21

Handle issues that may appear when running multiple times or when plone.volto was installed first.

Files changed:
M src/plone/volto/browser/migrate_to_volto.py

b'diff --git a/src/plone/volto/browser/migrate_to_volto.py b/src/plone/volto/browser/migrate_to_volto.py\nindex 9e64ee5..5b4e6a3 100644\n--- a/src/plone/volto/browser/migrate_to_volto.py\n+++ b/src/plone/volto/browser/migrate_to_volto.py\n@@ -2,12 +2,15 @@\n from logging import getLogger\n from plone import api\n from plone.app.contenttypes.behaviors.collection import ICollection\n+from plone.app.contenttypes.utils import get_old_class_name_string\n+from plone.app.contenttypes.utils import get_portal_type_name_string\n from plone.app.linkintegrity.utils import referencedRelationship\n from plone.app.redirector.interfaces import IRedirectionStorage\n from plone.app.textfield.value import RichTextValue\n from plone.dexterity.interfaces import IDexterityFTI\n from plone.volto.browser.migrate_richtext import get_blocks_from_richtext\n from plone.volto.browser.migrate_richtext import migrate_richtext_to_blocks\n+from Products.BTreeFolder2.BTreeFolder2 import BTreeFolder2Base\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.relationhelper import restore_relations\n from Products.CMFPlone.utils import get_installer\n@@ -74,7 +77,19 @@ def migrate_to_folderish(self):\n         catalog = getToolByName(self.context, "portal_catalog")\n         for portal_type in folderish_types:\n             for brain in catalog(portal_type=portal_type, sort_on="path"):\n-                obj = brain.getObject()\n+                try:\n+                    obj = brain.getObject()\n+                except Exception:\n+                    logger.info("Catalog inconsistent. Could not find %s", brain.getPath(), exc_info=True)\n+                    continue\n+\n+                old_class_name = get_old_class_name_string(obj)\n+                new_class_name = get_portal_type_name_string(obj)\n+                is_container = isinstance(obj, BTreeFolder2Base)\n+                if old_class_name == new_class_name and is_container:\n+                    # we\'re already ok (maybe migration is running multiple times)\n+                    continue\n+\n                 relations = export_relations(obj)\n                 migrate_base_class_to_new_class(obj, migrate_to_folderish=True)\n                 modified(obj)\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-11-10T16:32:12+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/b41e9aee9b68ebcad134baf479f9245a47bcf0df

fix linter

Files changed:
M src/plone/volto/browser/migrate_to_volto.py

b'diff --git a/src/plone/volto/browser/migrate_to_volto.py b/src/plone/volto/browser/migrate_to_volto.py\nindex 5b4e6a3..8643181 100644\n--- a/src/plone/volto/browser/migrate_to_volto.py\n+++ b/src/plone/volto/browser/migrate_to_volto.py\n@@ -80,7 +80,11 @@ def migrate_to_folderish(self):\n                 try:\n                     obj = brain.getObject()\n                 except Exception:\n-                    logger.info("Catalog inconsistent. Could not find %s", brain.getPath(), exc_info=True)\n+                    logger.info(\n+                        "Catalog inconsistent. Could not find %s",\n+                        brain.getPath(),\n+                        exc_info=True,\n+                    )\n                     continue\n \n                 old_class_name = get_old_class_name_string(obj)\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-11-10T16:34:00+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/76bc031b0d395df3fc8a86b48af8a72149e2d0f7

add changenote

Files changed:
A news/97.bugfix

b'diff --git a/news/97.bugfix b/news/97.bugfix\nnew file mode 100644\nindex 0000000..6c67ded\n--- /dev/null\n+++ b/news/97.bugfix\n@@ -0,0 +1 @@\n+Handle issues that may appear when running multiple times or when plone.volto was installed first. [pbauer]\n\\ No newline at end of file\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-11-10T10:58:38-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/3d96b97e49c103d48f7b33832f6fbb3eecb892fa

Update news/97.bugfix

Files changed:
M news/97.bugfix

b'diff --git a/news/97.bugfix b/news/97.bugfix\nindex 6c67ded..84bb274 100644\n--- a/news/97.bugfix\n+++ b/news/97.bugfix\n@@ -1 +1 @@\n-Handle issues that may appear when running multiple times or when plone.volto was installed first. [pbauer]\n\\ No newline at end of file\n+Make the `migrate_to_volto` process more robust when running multiple times or when plone.volto was installed first. [pbauer]\n\\ No newline at end of file\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-11-11T06:10:25+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/469916afbf4e6e64c6809901f47ac425553ec99b

Merge pull request #97 from plone/handle_mutiple_runs

Files changed:
A news/97.bugfix
M src/plone/volto/browser/migrate_to_volto.py

b'diff --git a/news/97.bugfix b/news/97.bugfix\nnew file mode 100644\nindex 0000000..84bb274\n--- /dev/null\n+++ b/news/97.bugfix\n@@ -0,0 +1 @@\n+Make the `migrate_to_volto` process more robust when running multiple times or when plone.volto was installed first. [pbauer]\n\\ No newline at end of file\ndiff --git a/src/plone/volto/browser/migrate_to_volto.py b/src/plone/volto/browser/migrate_to_volto.py\nindex 9e64ee5..8643181 100644\n--- a/src/plone/volto/browser/migrate_to_volto.py\n+++ b/src/plone/volto/browser/migrate_to_volto.py\n@@ -2,12 +2,15 @@\n from logging import getLogger\n from plone import api\n from plone.app.contenttypes.behaviors.collection import ICollection\n+from plone.app.contenttypes.utils import get_old_class_name_string\n+from plone.app.contenttypes.utils import get_portal_type_name_string\n from plone.app.linkintegrity.utils import referencedRelationship\n from plone.app.redirector.interfaces import IRedirectionStorage\n from plone.app.textfield.value import RichTextValue\n from plone.dexterity.interfaces import IDexterityFTI\n from plone.volto.browser.migrate_richtext import get_blocks_from_richtext\n from plone.volto.browser.migrate_richtext import migrate_richtext_to_blocks\n+from Products.BTreeFolder2.BTreeFolder2 import BTreeFolder2Base\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.relationhelper import restore_relations\n from Products.CMFPlone.utils import get_installer\n@@ -74,7 +77,23 @@ def migrate_to_folderish(self):\n         catalog = getToolByName(self.context, "portal_catalog")\n         for portal_type in folderish_types:\n             for brain in catalog(portal_type=portal_type, sort_on="path"):\n-                obj = brain.getObject()\n+                try:\n+                    obj = brain.getObject()\n+                except Exception:\n+                    logger.info(\n+                        "Catalog inconsistent. Could not find %s",\n+                        brain.getPath(),\n+                        exc_info=True,\n+                    )\n+                    continue\n+\n+                old_class_name = get_old_class_name_string(obj)\n+                new_class_name = get_portal_type_name_string(obj)\n+                is_container = isinstance(obj, BTreeFolder2Base)\n+                if old_class_name == new_class_name and is_container:\n+                    # we\'re already ok (maybe migration is running multiple times)\n+                    continue\n+\n                 relations = export_relations(obj)\n                 migrate_base_class_to_new_class(obj, migrate_to_folderish=True)\n                 modified(obj)\n'

