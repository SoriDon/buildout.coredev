Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-09-12T21:59:44+02:00
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/d024613a9901ba948a771b100776891d8947196d

Don't raise unauthorized on show_inactive check

Files changed:
M CHANGES.rst
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 36d598ad9..0445c1df3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,7 +18,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Don't raise Unauthorized on show_inactive check in catalog search
+  [tomgross]
 
 
 5.1rc1 (2017-09-10)
diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py
index f30618549..f421e9e02 100644
--- a/Products/CMFPlone/CatalogTool.py
+++ b/Products/CMFPlone/CatalogTool.py
@@ -29,6 +29,7 @@
 from Products.CMFPlone.utils import safe_callable
 from Products.CMFPlone.utils import safe_unicode
 from Products.ZCatalog.ZCatalog import ZCatalog
+from zExceptions import Unauthorized
 from zope.annotation.interfaces import IAnnotations
 from zope.component import queryMultiAdapter
 from zope.component.hooks import getSite
@@ -417,7 +418,7 @@ def allow_inactive(self, query_kw):
                 parts = path.split('/')
                 parent = site.unrestrictedTraverse('/'.join(parts[:-1]))
                 objs.append(parent.restrictedTraverse(parts[-1]))
-            except (KeyError, AttributeError):
+            except (KeyError, AttributeError, Unauthorized):
                 # When no object is found don't raise an error
                 pass
 
diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py
index 2d2d0536b..ffe06dae0 100644
--- a/Products/CMFPlone/tests/testCatalogTool.py
+++ b/Products/CMFPlone/tests/testCatalogTool.py
@@ -3,6 +3,7 @@
 from Acquisition import aq_base
 from DateTime import DateTime
 from OFS.ObjectManager import REPLACEABLE
+from plone.app.testing import setRoles
 from plone.app.testing import TEST_USER_ID
 from plone.app.testing import TEST_USER_NAME
 from plone.indexer.wrapper import IndexableObjectWrapper
@@ -1054,6 +1055,36 @@ def testPathWithPrivateMidLevel(self):
         results = [b.getPath() for b in self.catalog(path=path)]
         self.assertIn('/'.join(self.folder.doc.getPhysicalPath()), results)
 
+    def testUnauthorizedIsNotRaisedOnShowInactive(self):
+        setRoles(self.portal, TEST_USER_ID, ['Manager'])
+        wf_tool = self.portal.portal_workflow
+        self.portal.invokeFactory('Folder', id='folder1')
+        folder = self.portal['folder1']
+        wf_tool.doActionFor(folder, 'publish', comment='')
+        folder.reindexObject()
+
+        folder.invokeFactory('Folder', id='folder2')
+        folder2 = folder['folder2']
+        wf_tool.doActionFor(folder2, 'hide', comment='')
+        folder2.reindexObject()
+
+        folder2.invokeFactory('Document', id='doc1')
+        doc = folder2['doc1']
+        wf_tool.doActionFor(doc, 'publish', comment='')
+        doc.reindexObject()
+
+        folder2.invokeFactory('Document', id='doc2')
+        doc2 = folder2['doc2']
+        wf_tool.doActionFor(doc2, 'hide', comment='')
+        doc2.reindexObject()
+
+        self.logout()
+        path = '/' + folder2.absolute_url(1)
+        results = self.catalog.searchResults(path=path)
+        self.assertEqual(
+            results[0].getPath(), '/plone/folder1/folder2/doc1')
+        self.assertEqual(len(results), 1)
+
     def testExpiredWithPermissionOnSubpath(self):
         self.folder.doc.setExpirationDate(DateTime(2000, 12, 31))
         self.folder.doc.reindexObject()


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-09-17T21:26:20+02:00
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/0c5a41a5468298447b0d292cac1fb0d677c8bfe5

Merge branch 'master' into no_unauthorized_on_inactivecheck

Files changed:
M CHANGES.rst
M Products/CMFPlone/profiles/default/metadata.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index 0445c1df3..c5576c879 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -21,6 +21,9 @@ Bug fixes:
 - Don't raise Unauthorized on show_inactive check in catalog search
   [tomgross]
 
+- Bump metadata.xml version.
+  [thet]
+
 
 5.1rc1 (2017-09-10)
 -------------------
@@ -41,7 +44,7 @@ New features:
 
 - Update ``plone-legacy-compiled.js`` and ``plone-legacy-compiled.css``.
   [thet]
-  
+
 - Update mockup to latest version.
   [thet]
 
@@ -62,7 +65,7 @@ Bug fixes:
 - Recover missing dashboard (user actions)
   https://github.com/plone/Products.CMFPlone/issues/1132
   [fgrcon]
- 
+
 - Remove the right padding on toolbar submenu entries.
   That looked a bit weird.
   [thet]
diff --git a/Products/CMFPlone/profiles/default/metadata.xml b/Products/CMFPlone/profiles/default/metadata.xml
index 6019047a9..9fde2f7e2 100644
--- a/Products/CMFPlone/profiles/default/metadata.xml
+++ b/Products/CMFPlone/profiles/default/metadata.xml
@@ -1,4 +1,4 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>5108</version>
+  <version>5109</version>
 </metadata>


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-09-17T22:31:57+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/adc1f2df025aaf0fe121a49d0a0119b7e10be3df

Merge pull request #2142 from plone/no_unauthorized_on_inactivecheck

Don't raise unauthorized on show_inactive check

Files changed:
M CHANGES.rst
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 88c38f620..c5576c879 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,6 +18,9 @@ New features:
 
 Bug fixes:
 
+- Don't raise Unauthorized on show_inactive check in catalog search
+  [tomgross]
+
 - Bump metadata.xml version.
   [thet]
 
diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py
index f30618549..f421e9e02 100644
--- a/Products/CMFPlone/CatalogTool.py
+++ b/Products/CMFPlone/CatalogTool.py
@@ -29,6 +29,7 @@
 from Products.CMFPlone.utils import safe_callable
 from Products.CMFPlone.utils import safe_unicode
 from Products.ZCatalog.ZCatalog import ZCatalog
+from zExceptions import Unauthorized
 from zope.annotation.interfaces import IAnnotations
 from zope.component import queryMultiAdapter
 from zope.component.hooks import getSite
@@ -417,7 +418,7 @@ def allow_inactive(self, query_kw):
                 parts = path.split('/')
                 parent = site.unrestrictedTraverse('/'.join(parts[:-1]))
                 objs.append(parent.restrictedTraverse(parts[-1]))
-            except (KeyError, AttributeError):
+            except (KeyError, AttributeError, Unauthorized):
                 # When no object is found don't raise an error
                 pass
 
diff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py
index 2d2d0536b..ffe06dae0 100644
--- a/Products/CMFPlone/tests/testCatalogTool.py
+++ b/Products/CMFPlone/tests/testCatalogTool.py
@@ -3,6 +3,7 @@
 from Acquisition import aq_base
 from DateTime import DateTime
 from OFS.ObjectManager import REPLACEABLE
+from plone.app.testing import setRoles
 from plone.app.testing import TEST_USER_ID
 from plone.app.testing import TEST_USER_NAME
 from plone.indexer.wrapper import IndexableObjectWrapper
@@ -1054,6 +1055,36 @@ def testPathWithPrivateMidLevel(self):
         results = [b.getPath() for b in self.catalog(path=path)]
         self.assertIn('/'.join(self.folder.doc.getPhysicalPath()), results)
 
+    def testUnauthorizedIsNotRaisedOnShowInactive(self):
+        setRoles(self.portal, TEST_USER_ID, ['Manager'])
+        wf_tool = self.portal.portal_workflow
+        self.portal.invokeFactory('Folder', id='folder1')
+        folder = self.portal['folder1']
+        wf_tool.doActionFor(folder, 'publish', comment='')
+        folder.reindexObject()
+
+        folder.invokeFactory('Folder', id='folder2')
+        folder2 = folder['folder2']
+        wf_tool.doActionFor(folder2, 'hide', comment='')
+        folder2.reindexObject()
+
+        folder2.invokeFactory('Document', id='doc1')
+        doc = folder2['doc1']
+        wf_tool.doActionFor(doc, 'publish', comment='')
+        doc.reindexObject()
+
+        folder2.invokeFactory('Document', id='doc2')
+        doc2 = folder2['doc2']
+        wf_tool.doActionFor(doc2, 'hide', comment='')
+        doc2.reindexObject()
+
+        self.logout()
+        path = '/' + folder2.absolute_url(1)
+        results = self.catalog.searchResults(path=path)
+        self.assertEqual(
+            results[0].getPath(), '/plone/folder1/folder2/doc1')
+        self.assertEqual(len(results), 1)
+
     def testExpiredWithPermissionOnSubpath(self):
         self.folder.doc.setExpirationDate(DateTime(2000, 12, 31))
         self.folder.doc.reindexObject()


