Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-01-09T07:25:43+01:00
Author: Markus Hilbert (iham) <markus.hilbert@iham.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/9859b483e196a0f9fd29e5c98eeb6ae2a27cd163

Review list portlet showed nothing to review with plone.app.multilingual, As WorkflowTool bypassed languages only for p.a.m&lt;2.x or linguaplone. fixed and now compatible to both lang-bypassing methods.

Files changed:
A news/2595.bugfix
M Products/CMFPlone/WorkflowTool.py

b"diff --git a/Products/CMFPlone/WorkflowTool.py b/Products/CMFPlone/WorkflowTool.py\nindex f777b58c6..fda1d261d 100644\n--- a/Products/CMFPlone/WorkflowTool.py\n+++ b/Products/CMFPlone/WorkflowTool.py\n@@ -13,6 +13,16 @@\n from Products.DCWorkflow.Transitions import TRIGGER_USER_ACTION\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n \n+import pkg_resources\n+\n+try:\n+    pkg_resources.get_distribution('plone.app.multilingual')\n+except pkg_resources.DistributionNotFound:\n+    has_new_lang_bypass = False\n+else:\n+    has_new_lang_bypass = int(pkg_resources.get_distribution(\n+        'plone.app.multilingual').version.split('.')[0]) > 1\n+\n \n class WorkflowTool(PloneBaseTool, BaseTool):\n \n@@ -231,8 +241,10 @@ def getWorklistsResults(self):\n                     # Support LinguaPlone review situations, you want to see\n                     # content in *all* languages\n                     if 'Language' not in catalog_vars:\n-                        catalog_vars['Language'] = 'all'\n-                    # Include inactive content in result list. This is\n+                        if has_new_lang_bypass:\n+                            catalog_vars['path'] = '/'\n+                        elif has_new_lang_bypass:\n+                            catalog_vars['Language'] = 'all'                    # Include inactive content in result list. This is\n                     # especially important for content scheduled to go public\n                     # in the future, but needs to be reviewed before this.\n                     catalog_vars['show_inactive'] = True\ndiff --git a/news/2595.bugfix b/news/2595.bugfix\nnew file mode 100644\nindex 000000000..5aa8b69ba\n--- /dev/null\n+++ b/news/2595.bugfix\n@@ -0,0 +1,2 @@\n+Review list portlet showed nothing to review with plone.app.multilingual, As WorkflowTool bypassed languages only for p.a.m<2.x or linguaplone. fixed and now compatible to both lang-bypassing methods.\n+[iham]\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-01-11T09:15:40+01:00
Author: Markus Hilbert (iham) <markus.hilbert@iham.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/772bdabcceda16470b522b52801835f0867c115f

Merge branch 'master' into issue_2595

Files changed:
A news/2464.bugfix
A news/2675.bugfix
A news/2694.bugfix
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/browser/templates/author.pt
M Products/CMFPlone/controlpanel/browser/maintenance.pt
M Products/CMFPlone/controlpanel/browser/overview.pt
M Products/CMFPlone/controlpanel/browser/quickinstaller.pt
M Products/CMFPlone/controlpanel/browser/resourceregistry.pt
M Products/CMFPlone/controlpanel/browser/types.pt
M Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt
M Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt
M Products/CMFPlone/skins/plone_templates/test_rendering.pt
D news/2464.fixed

b'diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py\nindex fa6e582ca..f6e79f841 100644\n--- a/Products/CMFPlone/browser/search.py\n+++ b/Products/CMFPlone/browser/search.py\n@@ -214,7 +214,7 @@ def breadcrumbs(self, item):\n             return None\n         if len(breadcrumbs) > 3:\n             # if we have too long breadcrumbs, emit the middle elements\n-            empty = {\'absolute_url\': \'\', \'Title\': six.text_type(\'\xe2\x80\xa6\', \'utf-8\')}\n+            empty = {\'absolute_url\': \'\', \'Title\': u\'\xe2\x80\xa6\'}\n             breadcrumbs = [breadcrumbs[0], empty] + breadcrumbs[-2:]\n         return breadcrumbs\n \ndiff --git a/Products/CMFPlone/browser/templates/author.pt b/Products/CMFPlone/browser/templates/author.pt\nindex ba7990533..d4b15dc6e 100644\n--- a/Products/CMFPlone/browser/templates/author.pt\n+++ b/Products/CMFPlone/browser/templates/author.pt\n@@ -32,7 +32,7 @@\n                                 username view/username">\n \n         <tal:noAuthor condition="not: author">\n-            <dl class="portalMessage error">\n+            <dl class="portalMessage error" role="alert">\n                 <dt i18n:translate="">\n                     Error\n                 </dt>\ndiff --git a/Products/CMFPlone/controlpanel/browser/maintenance.pt b/Products/CMFPlone/controlpanel/browser/maintenance.pt\nindex 672464403..7db55c1da 100644\n--- a/Products/CMFPlone/controlpanel/browser/maintenance.pt\n+++ b/Products/CMFPlone/controlpanel/browser/maintenance.pt\n@@ -15,8 +15,9 @@\n          <metal:block define-macro="header">\n \n              <dl tal:define="status view/status"\n-                  tal:condition="status"\n-                  class="portalMessage info">\n+                 tal:condition="status"\n+                 role="status"\n+                 class="portalMessage info">\n                  <dt i18n:translate="">\n                      Info\n                  </dt>\ndiff --git a/Products/CMFPlone/controlpanel/browser/overview.pt b/Products/CMFPlone/controlpanel/browser/overview.pt\nindex a8ae21c79..b44cacce5 100644\n--- a/Products/CMFPlone/controlpanel/browser/overview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/overview.pt\n@@ -22,7 +22,8 @@\n     </p>\n \n     <div class="portalMessage warning"\n-        tal:condition="view/upgrade_warning">\n+         role="status"\n+         tal:condition="view/upgrade_warning">\n         <strong i18n:translate="">\n             Warning\n         </strong>\n@@ -41,7 +42,8 @@\n     </div>\n \n     <div class="portalMessage warning"\n-        tal:condition="view/mailhost_warning">\n+         role="status"\n+         tal:condition="view/mailhost_warning">\n         <strong i18n:translate="">\n             Warning\n         </strong>\n@@ -60,7 +62,8 @@\n     </div>\n \n     <div class="portalMessage warning"\n-        tal:condition="view/timezone_warning">\n+         role="status"\n+         tal:condition="view/timezone_warning">\n         <strong i18n:translate="">\n             Warning\n         </strong>\n@@ -80,7 +83,8 @@\n     </div>\n \n     <div class="portalMessage warning"\n-        tal:condition="not:view/pil">\n+         role="status"\n+         tal:condition="not:view/pil">\n         <strong i18n:translate="">\n             Warning\n         </strong>\ndiff --git a/Products/CMFPlone/controlpanel/browser/quickinstaller.pt b/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\nindex d94896bce..1f18ba6bf 100644\n--- a/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\n+++ b/Products/CMFPlone/controlpanel/browser/quickinstaller.pt\n@@ -43,7 +43,7 @@\n              id="upgrade-products" class="portlet">\n           <header class="portletHeader" i18n:translate="">Upgrades</header>\n           <section tal:condition="not:products" class="portletContent">\n-            <div id="up-to-date-message" class="portalMessage info">\n+            <div id="up-to-date-message" class="portalMessage info" role="status">\n                  <strong i18n:translate="">No upgrades in this corner</strong>\n                  <span i18n:translate="">You are up to date. High fives.</span>\n              </div>\n@@ -153,7 +153,8 @@\n                   <em class="discreet"> \xe2\x80\x93 (<span tal:replace="pid">plugin.app.name</span> <span tal:replace="product/version">1.0</span>)</em>\n                 </p>\n                 <dl class="portalMessage warning"\n-                   tal:condition="not:product/uninstall_profile">\n+                    role="status"\n+                    tal:condition="not:product/uninstall_profile">\n                   <dt i18n:translate="">Warning</dt>\n                   <dd i18n:translate="">This product cannot be uninstalled!</dd>\n                 </dl>\n@@ -194,6 +195,7 @@\n                       <em class="discreet"> \xe2\x80\x93 (<span tal:replace="pid">plugin.app.name</span> <span tal:replace="product/version">1.0</span>)</em>\n                     </p>\n                     <dl class="portalMessage info"\n+                        role="status"\n                         tal:condition="not:product/uninstall_profile">\n                       <dt i18n:translate="">Info</dt>\n                       <dd i18n:translate="">This product cannot be uninstalled!</dd>\ndiff --git a/Products/CMFPlone/controlpanel/browser/resourceregistry.pt b/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\nindex 9d59d0f16..0f0800e79 100644\n--- a/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\n+++ b/Products/CMFPlone/controlpanel/browser/resourceregistry.pt\n@@ -30,7 +30,7 @@\n    <div id="content-core">\n       <span tal:replace="structure context/@@authenticator/authenticator"/>\n       <div class="pat-resourceregistry" tal:attributes="data-pat-resourceregistry view/config">\n-        <div class="portalMessage info">\n+        <div class="portalMessage info" role="status">\n           <strong i18n:translate="">Info</strong>\n           <span i18n:translate="">If you see this, it is because there was an error rendering the resource registry\n           configuration. It\'s possible you saved a bundle that gives a JavaScript error\ndiff --git a/Products/CMFPlone/controlpanel/browser/types.pt b/Products/CMFPlone/controlpanel/browser/types.pt\nindex 1bc6d9d47..9b705bde3 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.pt\n+++ b/Products/CMFPlone/controlpanel/browser/types.pt\n@@ -248,7 +248,7 @@\n \n                 </tal:workflows>\n \n-                <div tal:condition="view/have_new_workflow" class="portalMessage info">\n+                <div tal:condition="view/have_new_workflow" class="portalMessage info" role="status">\n                     <strong>Info</strong>\n                     <span i18n:translate="types_controlpanel_warn_remap">\n                         Changing the workflow of a type will take a while, and may slow down\ndiff --git a/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt b/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt\nindex 297b552bc..33ce2f1e4 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_usersoverview.pt\n@@ -52,7 +52,7 @@\n           The symbol <img i18n:name="image_link_icon" tal:replace="structure context/site_icon.png" />\n           indicates a role inherited from membership in a group.\n         </p>\n-        <p tal:condition="view/show_users_listing_warning" class="portalMessage warning">\n+        <p tal:condition="view/show_users_listing_warning" class="portalMessage warning" role="status">\n           <strong i18n:translate="">Note</strong>\n           <span i18n:translate="description_pas_users_listing">Some or all of your PAS user source\n           plugins do not allow listing of users, so you may not see\ndiff --git a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt b/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt\nindex 1d3dcc042..ca10e1ed1 100644\n--- a/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt\n+++ b/Products/CMFPlone/skins/plone_prefs/prefs_error_log_showEntry.pt\n@@ -28,7 +28,8 @@\n         <div tal:define="entry python:context.error_log.getLogEntryById(request.get(\'id\'))">\n \n             <div class="portalMessage error"\n-                tal:condition="not:entry">\n+                 role="alert"\n+                 tal:condition="not:entry">\n                 <strong i18n:translate="">\n                     Error\n                 </strong>\ndiff --git a/Products/CMFPlone/skins/plone_templates/test_rendering.pt b/Products/CMFPlone/skins/plone_templates/test_rendering.pt\nindex b20ad9f9c..37db1de48 100644\n--- a/Products/CMFPlone/skins/plone_templates/test_rendering.pt\n+++ b/Products/CMFPlone/skins/plone_templates/test_rendering.pt\n@@ -40,7 +40,7 @@ Headlines\n \n <pre>Example document rendering</pre>\n \n-<div class="portalMessage info">\n+<div class="portalMessage info" role="status">\n     <strong>\n         Info\n     </strong>\n@@ -50,7 +50,7 @@ Headlines\n     </span>\n </div>\n \n-<dl class="portalMessage error">\n+<dl class="portalMessage error" role="alert">\n     <dt>\n         Error\n     </dt>\n@@ -60,7 +60,7 @@ Headlines\n     </dd>\n </dl>\n \n-<dl class="portalMessage warning">\n+<dl class="portalMessage warning" role="status">\n     <dt>\n         Warning\n     </dt>\n@@ -146,15 +146,15 @@ definition lists. We replace them in the following manners.\n \n <h4>in portal messages</h4>\n \n-<div class="portalMessage info">\n+<div class="portalMessage info" role="status">\n   <strong>Not important</strong>\n   This message is here to tell you something went just as you expected.\n </div>\n-<div class="portalMessage warning">\n+<div class="portalMessage warning" role="status">\n   <strong>You might run into problems</strong>\n   Please check your settings, be sure what you\'re doing is right.\n </div>\n-<div class="portalMessage error">\n+<div class="portalMessage error" role="alert">\n   <strong>Something went wrong</strong>\n   This is bad, you must notice this.\n </div>\ndiff --git a/news/2464.fixed b/news/2464.bugfix\nsimilarity index 100%\nrename from news/2464.fixed\nrename to news/2464.bugfix\ndiff --git a/news/2675.bugfix b/news/2675.bugfix\nnew file mode 100644\nindex 000000000..b2711e323\n--- /dev/null\n+++ b/news/2675.bugfix\n@@ -0,0 +1 @@\n+a11y: Added role attribute for portalMessage [nzambello]\ndiff --git a/news/2694.bugfix b/news/2694.bugfix\nnew file mode 100644\nindex 000000000..830b6ce5e\n--- /dev/null\n+++ b/news/2694.bugfix\n@@ -0,0 +1 @@\n+fixed Python 3 related str decoding issue in breadcrumbs\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2019-01-16T15:09:03+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/1380eaa9c3e26d4094911a7ffe6b7a8b18ca67d7

Merge pull request #2692 from plone/issue_2595

Review list portlet fix

Files changed:
A news/2595.bugfix
M Products/CMFPlone/WorkflowTool.py

b"diff --git a/Products/CMFPlone/WorkflowTool.py b/Products/CMFPlone/WorkflowTool.py\nindex f777b58c6..fda1d261d 100644\n--- a/Products/CMFPlone/WorkflowTool.py\n+++ b/Products/CMFPlone/WorkflowTool.py\n@@ -13,6 +13,16 @@\n from Products.DCWorkflow.Transitions import TRIGGER_USER_ACTION\n from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n \n+import pkg_resources\n+\n+try:\n+    pkg_resources.get_distribution('plone.app.multilingual')\n+except pkg_resources.DistributionNotFound:\n+    has_new_lang_bypass = False\n+else:\n+    has_new_lang_bypass = int(pkg_resources.get_distribution(\n+        'plone.app.multilingual').version.split('.')[0]) > 1\n+\n \n class WorkflowTool(PloneBaseTool, BaseTool):\n \n@@ -231,8 +241,10 @@ def getWorklistsResults(self):\n                     # Support LinguaPlone review situations, you want to see\n                     # content in *all* languages\n                     if 'Language' not in catalog_vars:\n-                        catalog_vars['Language'] = 'all'\n-                    # Include inactive content in result list. This is\n+                        if has_new_lang_bypass:\n+                            catalog_vars['path'] = '/'\n+                        elif has_new_lang_bypass:\n+                            catalog_vars['Language'] = 'all'                    # Include inactive content in result list. This is\n                     # especially important for content scheduled to go public\n                     # in the future, but needs to be reviewed before this.\n                     catalog_vars['show_inactive'] = True\ndiff --git a/news/2595.bugfix b/news/2595.bugfix\nnew file mode 100644\nindex 000000000..5aa8b69ba\n--- /dev/null\n+++ b/news/2595.bugfix\n@@ -0,0 +1,2 @@\n+Review list portlet showed nothing to review with plone.app.multilingual, As WorkflowTool bypassed languages only for p.a.m<2.x or linguaplone. fixed and now compatible to both lang-bypassing methods.\n+[iham]\n"

