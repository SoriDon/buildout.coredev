Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-12-21T00:54:17+01:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/0f5c603ffa00677abf8cbd2ed67b11d1c0981e0a

Change all text getters on plone.app.textfield.value.RichTextValue objects to output_relative_to with the current context. This correctly transforms relative links. See: https://github.com/plone/plone.app.textfield/issues/7

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/folder.py
M plone/app/contenttypes/browser/templates/newsitem.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index bde25c8..a0362fa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,11 @@ New:
 
 Fixes:
 
-- *add item here*
+- Change all text getters on ``plone.app.textfield.value.RichTextValue``
+  objects to ``output_relative_to`` with the current context. This correctly
+  transforms relative links. See:
+  https://github.com/plone/plone.app.textfield/issues/7
+  [thet]
 
 
 1.2.8 (2015-12-15)
diff --git a/plone/app/contenttypes/browser/folder.py b/plone/app/contenttypes/browser/folder.py
index 7a949f2..4f078e0 100644
--- a/plone/app/contenttypes/browser/folder.py
+++ b/plone/app/contenttypes/browser/folder.py
@@ -119,7 +119,9 @@ def show_about(self):
     @property
     def text(self):
         textfield = getattr(aq_base(self.context), 'text', None)
-        text = getattr(textfield, 'output', None)
+        text = textfield.output_relative_to(self.context)\
+            if getattr(textfield, 'output_relative_to', None)\
+            else None
         if text:
             self.text_class = 'stx' if textfield.mimeType in (
                 'text/structured', 'text/x-rst', 'text/restructured'
diff --git a/plone/app/contenttypes/browser/templates/newsitem.pt b/plone/app/contenttypes/browser/templates/newsitem.pt
index b86d964..9f642ab 100644
--- a/plone/app/contenttypes/browser/templates/newsitem.pt
+++ b/plone/app/contenttypes/browser/templates/newsitem.pt
@@ -8,14 +8,13 @@
 <body>
 
 <metal:content-core fill-slot="content-core">
-<metal:block define-macro="content-core"
-    tal:define="templateId template/getId;">
-
+<metal:content-core define-macro="content-core"
+                    tal:define="toc context/table_of_contents|nothing;">
   <div id="parent-fieldname-text"
       tal:condition="context/text"
-      tal:content="structure context/text/output" />
-
-</metal:block>
+      tal:content="structure python:context.text.output_relative_to(view.context)"
+      tal:attributes="class python: toc and 'pat-autotoc' or ''" />
+</metal:content-core>
 </metal:content-core>
 
 </body>


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-12-22T13:34:44+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/7ef1ded8c5bd6ea28aebfc634fe36a6f180320c9

Merge pull request #308 from plone/thet-output_relative_to

Change all text getters on plone.app.textfield.value.RichTextValue obâ€¦

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/folder.py
M plone/app/contenttypes/browser/templates/newsitem.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index bde25c8..a0362fa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,11 @@ New:
 
 Fixes:
 
-- *add item here*
+- Change all text getters on ``plone.app.textfield.value.RichTextValue``
+  objects to ``output_relative_to`` with the current context. This correctly
+  transforms relative links. See:
+  https://github.com/plone/plone.app.textfield/issues/7
+  [thet]
 
 
 1.2.8 (2015-12-15)
diff --git a/plone/app/contenttypes/browser/folder.py b/plone/app/contenttypes/browser/folder.py
index 7a949f2..4f078e0 100644
--- a/plone/app/contenttypes/browser/folder.py
+++ b/plone/app/contenttypes/browser/folder.py
@@ -119,7 +119,9 @@ def show_about(self):
     @property
     def text(self):
         textfield = getattr(aq_base(self.context), 'text', None)
-        text = getattr(textfield, 'output', None)
+        text = textfield.output_relative_to(self.context)\
+            if getattr(textfield, 'output_relative_to', None)\
+            else None
         if text:
             self.text_class = 'stx' if textfield.mimeType in (
                 'text/structured', 'text/x-rst', 'text/restructured'
diff --git a/plone/app/contenttypes/browser/templates/newsitem.pt b/plone/app/contenttypes/browser/templates/newsitem.pt
index b86d964..9f642ab 100644
--- a/plone/app/contenttypes/browser/templates/newsitem.pt
+++ b/plone/app/contenttypes/browser/templates/newsitem.pt
@@ -8,14 +8,13 @@
 <body>
 
 <metal:content-core fill-slot="content-core">
-<metal:block define-macro="content-core"
-    tal:define="templateId template/getId;">
-
+<metal:content-core define-macro="content-core"
+                    tal:define="toc context/table_of_contents|nothing;">
   <div id="parent-fieldname-text"
       tal:condition="context/text"
-      tal:content="structure context/text/output" />
-
-</metal:block>
+      tal:content="structure python:context.text.output_relative_to(view.context)"
+      tal:attributes="class python: toc and 'pat-autotoc' or ''" />
+</metal:content-core>
 </metal:content-core>
 
 </body>


