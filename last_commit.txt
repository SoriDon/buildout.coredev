Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-10-14T08:22:59+02:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/9282ea132a8fb35c962010d80c68d2a17d990f7b

Fix wrong id on the serialization of the Plone site using the new tra… (#1249)

* Fix wrong id on the serialization of the Plone site using the new traversal ++api++

* Better test

* Fix tests

Files changed:
A news/1248.bugfix
M plone-5.2.x.cfg
M src/plone/restapi/serializer/site.py
M src/plone/restapi/tests/http-examples/jwt_logged_in.resp
M src/plone/restapi/tests/test_batching.py
M src/plone/restapi/tests/test_site_serializer.py

b'diff --git a/news/1248.bugfix b/news/1248.bugfix\nnew file mode 100644\nindex 000000000..e986208ac\n--- /dev/null\n+++ b/news/1248.bugfix\n@@ -0,0 +1,2 @@\n+Fix wrong id on the serialization of the Plone site using the new traversal ++api++\n+[sneridagh]\ndiff --git a/plone-5.2.x.cfg b/plone-5.2.x.cfg\nindex 3ca915fa9..a9b4d7782 100644\n--- a/plone-5.2.x.cfg\n+++ b/plone-5.2.x.cfg\n@@ -17,3 +17,6 @@ importlib-metadata = 2.0.0\n # cffi 1.14.3 fails on apple m1\n # cffi 1.14.4 fails with "ModuleNotFoundError: No module named \'_cffi_backend\'"\n cffi = 1.14.6\n+\n+# Use the new plone.rest alpha\n+plone.rest = 2.0.0a1\ndiff --git a/src/plone/restapi/serializer/site.py b/src/plone/restapi/serializer/site.py\nindex 40d1a03e8..6648b0280 100644\n--- a/src/plone/restapi/serializer/site.py\n+++ b/src/plone/restapi/serializer/site.py\n@@ -43,7 +43,7 @@ def __call__(self, version=None):\n \n         result = {\n             # \'@context\': \'http://www.w3.org/ns/hydra/context.jsonld\',\n-            "@id": batch.canonical_url,\n+            "@id": self.context.absolute_url(),\n             "id": self.context.id,\n             "@type": "Plone Site",\n             "title": self.context.Title(),\ndiff --git a/src/plone/restapi/tests/http-examples/jwt_logged_in.resp b/src/plone/restapi/tests/http-examples/jwt_logged_in.resp\nindex 7e8dca4f6..4c0047709 100644\n--- a/src/plone/restapi/tests/http-examples/jwt_logged_in.resp\n+++ b/src/plone/restapi/tests/http-examples/jwt_logged_in.resp\n@@ -16,7 +16,7 @@ Content-Type: application/json\n             "@id": "http://localhost:55001/plone/@navigation"\n         }\n     },\n-    "@id": "http://localhost:55001/plone/",\n+    "@id": "http://localhost:55001/plone",\n     "@type": "Plone Site",\n     "blocks": {},\n     "blocks_layout": {},\ndiff --git a/src/plone/restapi/tests/test_batching.py b/src/plone/restapi/tests/test_batching.py\nindex b6be9c552..27c842238 100644\n--- a/src/plone/restapi/tests/test_batching.py\n+++ b/src/plone/restapi/tests/test_batching.py\n@@ -281,7 +281,7 @@ def test_contains_canonical_url(self):\n         response = self.api_session.get("/?b_start=2&b_size=2")\n \n         # Response should contain canonical URL without batching params\n-        self.assertEqual(response.json()["@id"], self.portal_url + "/")\n+        self.assertEqual(response.json()["@id"], self.portal_url)\n \n     def test_contains_batching_links(self):\n         # Fetch the second page of the batch\ndiff --git a/src/plone/restapi/tests/test_site_serializer.py b/src/plone/restapi/tests/test_site_serializer.py\nindex dbf3e8258..b4ee97845 100644\n--- a/src/plone/restapi/tests/test_site_serializer.py\n+++ b/src/plone/restapi/tests/test_site_serializer.py\n@@ -1,6 +1,12 @@\n from plone.restapi.interfaces import ISerializeToJson\n from plone.restapi.testing import PLONE_RESTAPI_DX_INTEGRATION_TESTING\n+from plone.restapi.testing import PLONE_RESTAPI_DX_FUNCTIONAL_TESTING\n+from plone.restapi.testing import RelativeSession\n from zope.component import getMultiAdapter\n+from plone.app.testing import setRoles\n+from plone.app.testing import SITE_OWNER_NAME\n+from plone.app.testing import SITE_OWNER_PASSWORD\n+from plone.app.testing import TEST_USER_ID\n \n import json\n import unittest\n@@ -51,3 +57,25 @@ def test_resolveuids_get_serialized_in_serializer(self):\n             obj["blocks"]["0358abe2-b4f1-463d-a279-a63ea80daf19"]["url"],\n             self.portal.doc1.absolute_url(),\n         )\n+\n+\n+class TestSiteSerializationFunctional(unittest.TestCase):\n+\n+    layer = PLONE_RESTAPI_DX_FUNCTIONAL_TESTING\n+\n+    def setUp(self):\n+        self.app = self.layer["app"]\n+        self.portal = self.layer["portal"]\n+        self.portal_url = self.portal.absolute_url()\n+        setRoles(self.portal, TEST_USER_ID, ["Manager"])\n+\n+        self.api_session = RelativeSession(f"{self.portal_url}/++api++")\n+        self.api_session.auth = (SITE_OWNER_NAME, SITE_OWNER_PASSWORD)\n+\n+    def tearDown(self):\n+        self.api_session.close()\n+\n+    def test_site_root_get_request(self):\n+        response = self.api_session.get("")\n+\n+        self.assertEqual(response.json()["@id"], self.portal.absolute_url())\n'

