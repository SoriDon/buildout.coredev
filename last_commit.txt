Repository: plone.app.layout


Branch: refs/heads/master
Date: 2022-02-02T17:47:12+01:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/plone.app.layout/commit/c57d1d690e69c865fd8ba74753845e4fbfa5af7e

remove viewlet

Files changed:
A news/286.bugfix
M plone/app/layout/viewlets/configure.zcml
D plone/app/layout/viewlets/portal_header.pt

b'diff --git a/news/286.bugfix b/news/286.bugfix\nnew file mode 100644\nindex 00000000..f2fc5596\n--- /dev/null\n+++ b/news/286.bugfix\n@@ -0,0 +1,2 @@\n+Remove plone.header viewlet\n+[erral]\ndiff --git a/plone/app/layout/viewlets/configure.zcml b/plone/app/layout/viewlets/configure.zcml\nindex 5b541d7e..9544c3bc 100644\n--- a/plone/app/layout/viewlets/configure.zcml\n+++ b/plone/app/layout/viewlets/configure.zcml\n@@ -136,14 +136,6 @@\n         permission="zope.Public"\n         />\n \n-    <!-- The portal header -->\n-    <browser:viewlet\n-        name="plone.header"\n-        manager=".interfaces.IPortalTop"\n-        template="portal_header.pt"\n-        permission="zope2.View"\n-        />\n-\n     <!-- The site actions -->\n     <browser:viewlet\n         name="plone.site_actions"\ndiff --git a/plone/app/layout/viewlets/portal_header.pt b/plone/app/layout/viewlets/portal_header.pt\ndeleted file mode 100644\nindex bf71d215..00000000\n--- a/plone/app/layout/viewlets/portal_header.pt\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-<div id="portal-header">\n-    <div tal:replace="structure provider:plone.portalheader" />\n-</div>\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2022-02-04T08:24:20+01:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/a2f89332ee4861de553e09d287bb13b0c11bbcd6

Merge branch 'master' into erral-remove-viewlet-in-viewlet

Files changed:
A news/290.bugfix
M plone/app/layout/favicon_handler.py
M plone/app/layout/links/favicon.pt
M plone/app/layout/links/tests/test_favicon_viewlet.py
M plone/app/layout/links/viewlets.py

b'diff --git a/news/290.bugfix b/news/290.bugfix\nnew file mode 100644\nindex 00000000..403fcf81\n--- /dev/null\n+++ b/news/290.bugfix\n@@ -0,0 +1 @@\n+Correct favicon handling: fix URL to navroot/favicon.ico and use customized icon file name as part of the proxy cache key.\ndiff --git a/plone/app/layout/favicon_handler.py b/plone/app/layout/favicon_handler.py\nindex 329d29b8..5af3ca0c 100644\n--- a/plone/app/layout/favicon_handler.py\n+++ b/plone/app/layout/favicon_handler.py\n@@ -14,6 +14,10 @@ def updateMimetype(settings: RecordsProxy, event: IRecordModifiedEvent=None):\n     if event.record.fieldName != \'site_favicon\' or not event.record.value:\n         return\n \n-    filename, data = b64decode_file(event.newValue)\n-    mimetype = mimetypes.guess_type(filename)[0] if filename else \'image/x-icon\'\n+    filename = b64decode_file(event.newValue)[0]\n+    mimetype = mimetypes.guess_type(filename)[0] if filename else None\n+    if mimetype in (\'image/x-icon\', None):\n+        # Override incorrect MIME type registered in both PIL and the\n+        # Products.MimetypesRegistry product.\n+        mimetype = \'image/vnd.microsoft.icon\'\n     settings.__registry__[\'plone.site_favicon_mimetype\'] = mimetype\ndiff --git a/plone/app/layout/links/favicon.pt b/plone/app/layout/links/favicon.pt\nindex 0f45640f..73fd1472 100644\n--- a/plone/app/layout/links/favicon.pt\n+++ b/plone/app/layout/links/favicon.pt\n@@ -1,6 +1,5 @@\n-<tal:favicon define="portal_url view/site_url">\n+<tal:favicon>\n     <link rel="preload icon" type="${python: view.mimetype}"\n           tal:attributes="href python: view.favicon_path" />\n-    <link rel="alternate icon" type="image/x-icon">\n     <link rel="mask-icon" tal:attributes="href python: view.favicon_path" />\n </tal:favicon>\n\\ No newline at end of file\ndiff --git a/plone/app/layout/links/tests/test_favicon_viewlet.py b/plone/app/layout/links/tests/test_favicon_viewlet.py\nindex eb5d7494..9cf85a16 100644\n--- a/plone/app/layout/links/tests/test_favicon_viewlet.py\n+++ b/plone/app/layout/links/tests/test_favicon_viewlet.py\n@@ -60,11 +60,11 @@ def test_FaviconViewlet_get_mimetype_ico(self):\n         encoded_data = b64encode_file(filename=filename, data=file_data)\n         settings.site_favicon = encoded_data\n         mimetype = settings.site_favicon_mimetype\n-        self.assertEqual(mimetype, \'image/x-icon\')\n+        self.assertEqual(mimetype, \'image/vnd.microsoft.icon\')\n \n     def test_FaviconViewlet_get_mimetype_none(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(ISiteSchema, prefix="plone")\n         settings.site_favicon = None\n         mimetype = settings.site_favicon_mimetype\n-        self.assertEqual(mimetype, \'image/x-icon\')\n+        self.assertEqual(mimetype, \'image/vnd.microsoft.icon\')\ndiff --git a/plone/app/layout/links/viewlets.py b/plone/app/layout/links/viewlets.py\nindex 3948ca77..8096e3df 100644\n--- a/plone/app/layout/links/viewlets.py\n+++ b/plone/app/layout/links/viewlets.py\n@@ -45,19 +45,36 @@ class FaviconViewlet(ViewletBase):\n     def init_favicon(self) -> NoReturn:\n         registry = getUtility(IRegistry)\n         settings: ISiteSchema = registry.forInterface(ISiteSchema, prefix="plone")\n-\n-        self.mimetype: str = settings.site_favicon_mimetype\n-        filename: str = self.get_filename(settings)\n-        self.favicon_path: str = str(self.site_url) + \'/favicon\'\n-        if not filename:\n-            self.favicon_path += \'.ico\'\n-\n-    @staticmethod\n-    def get_filename(settings: ISiteSchema) -> str:\n-        if getattr(settings, \'site_favicon\', False):\n-            filename, data = b64decode_file(settings.site_favicon)\n-            return filename\n-        return None\n+        self.mimetype: str = getattr(\n+            settings, "site_favicon_mimetype", "image/vnd.microsoft.icon"\n+        )\n+        cachebust = ""\n+        if getattr(settings, "site_favicon", False):\n+            # The user has customized the favicon via the Site configlet.\n+            filename = b64decode_file(settings.site_favicon)[0]\n+            \n+            cachebust = "?name=" + filename\n+        # The filename is *always* /favicon.ico, irrespective of the content type,\n+        # because:\n+        #\n+        # 1. Browsers obey the content type over the extension.\n+        # 2. The actual serving view URL for the favicon is always /favicon.ico,\n+        #    and this name cannot be overridden from here into the view registered\n+        #    on CMFPlone, where the *actual* serving of the data takes place.\n+        # 3. Even if we could somehow override the view, there is no easy way to\n+        #    register in CMFPlone a different browser view for every icon file\n+        #    name the user may decide to upload.\n+        # 4. In many cases client applications just hit /favicon.ico irrespective\n+        #    of what the HTML says (remember that this specific view is only\n+        #    responsible for generating the metadata that lets the browser know\n+        #    where to find the favicon URL).\n+        #\n+        # However, to allow for users to change their favicons *and* bust their\n+        # proxy caches, we do use the favicon filename in the served favicon\n+        # URL.  This does not cover the case of RSS and podcast apps that access\n+        # /favicon.ico by custom instead of consulting the HTML, but at least\n+        # it covers pretty much every browser out there.\n+        self.favicon_path: str = f"{self.navigation_root_url}/favicon.ico{cachebust}"\n \n     def render(self) -> ViewPageTemplateFile:\n         self.init_favicon()\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2022-02-09T17:43:38+01:00
Author: agitator (agitator) <agitator@users.noreply.github.com>
Commit: https://github.com/plone/plone.app.layout/commit/1e20974ffb7d58c5674459e1d3f56e461ca7025f

Merge pull request #287 from plone/erral-remove-viewlet-in-viewlet

remove nesting of portal-header and portal-top viewlets

Files changed:
A news/286.bugfix
M plone/app/layout/viewlets/configure.zcml
D plone/app/layout/viewlets/portal_header.pt

b'diff --git a/news/286.bugfix b/news/286.bugfix\nnew file mode 100644\nindex 00000000..f2fc5596\n--- /dev/null\n+++ b/news/286.bugfix\n@@ -0,0 +1,2 @@\n+Remove plone.header viewlet\n+[erral]\ndiff --git a/plone/app/layout/viewlets/configure.zcml b/plone/app/layout/viewlets/configure.zcml\nindex 5b541d7e..9544c3bc 100644\n--- a/plone/app/layout/viewlets/configure.zcml\n+++ b/plone/app/layout/viewlets/configure.zcml\n@@ -136,14 +136,6 @@\n         permission="zope.Public"\n         />\n \n-    <!-- The portal header -->\n-    <browser:viewlet\n-        name="plone.header"\n-        manager=".interfaces.IPortalTop"\n-        template="portal_header.pt"\n-        permission="zope2.View"\n-        />\n-\n     <!-- The site actions -->\n     <browser:viewlet\n         name="plone.site_actions"\ndiff --git a/plone/app/layout/viewlets/portal_header.pt b/plone/app/layout/viewlets/portal_header.pt\ndeleted file mode 100644\nindex bf71d215..00000000\n--- a/plone/app/layout/viewlets/portal_header.pt\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-<div id="portal-header">\n-    <div tal:replace="structure provider:plone.portalheader" />\n-</div>\n'

