Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2022-03-30T18:06:39+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/031a40870f3a1595de29dc23ba0c3b75e82c3032

Remove old plone.session bundles.

Reapply its new registry settings, if its optional refresh support is installed.
Part of https://github.com/plone/plone.session/issues/24.

Also remove the deprecated `develop_css` field from all bundles.

Files changed:
A news/24.bugfix
M plone/app/upgrade/v60/alphas.py

b'diff --git a/news/24.bugfix b/news/24.bugfix\nnew file mode 100644\nindex 00000000..9633a33e\n--- /dev/null\n+++ b/news/24.bugfix\n@@ -0,0 +1,4 @@\n+Remove old ``plone.session`` bundles.\n+Reapply its new registry settings, if its optional refresh support is installed.\n+Part of `plone.session issue 24 <https://github.com/plone/plone.session/issues/24>`_.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex 3291d554..cadadac5 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -293,6 +293,11 @@ def cleanup_resources_and_bundles_in_registry(context=None):\n     # Otherwise the bundles we delete will come back to haunt us\n     context.upgradeProfile("plone.staticresources:default", dest="208")\n \n+    # Also reregister the newly defined plone.session bundle if it is installed.\n+    installer = get_installer(context)\n+    if installer.is_profile_installed("plone.session:default"):\n+        loadMigrationProfile(context, "profile-plone.session:default", steps=["plone.app.registry"])\n+\n     # Remove obsolete records from the registry\n     removed_keys = [\n         "plone.resources/",\n@@ -342,6 +347,8 @@ def cleanup_resources_and_bundles_in_registry(context=None):\n         "thememapper",\n         "plone-legacy",\n         "plone-logged-in",\n+        "plone-session-pseudo-css",\n+        "plone-session-js",\n     ]\n     bundles = registry.collectionOfInterface(\n         IBundleRegistry, prefix="plone.bundles", check=False\n@@ -354,6 +361,7 @@ def cleanup_resources_and_bundles_in_registry(context=None):\n     # Remove deprecated bundle fields\n     removed_fields = [\n         "compile",\n+        "develop_css",\n         "develop_javascript",\n         "last_compilation",\n         "merge_with",\n@@ -371,7 +379,6 @@ def cleanup_resources_and_bundles_in_registry(context=None):\n     logger.info(u"Removed {} deprecated bundle attributes from registry".format(len(to_delete)))\n \n     # local default controlpanel icons\n-    installer = get_installer(context)\n     loadMigrationProfile(context, "profile-Products.CMFPlone:plone", steps=["controlpanel"])\n     if installer.is_profile_installed("plone.app.theming:default"):\n         loadMigrationProfile(context, "profile-plone.app.theming:default", steps=["controlpanel"])\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2022-04-07T20:45:51+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/e46a547c1ace5b761d9c986ebc2463a374327252

Merge pull request #281 from plone/maurits-plone-session

Remove old plone.session bundles.

Files changed:
A news/24.bugfix
M plone/app/upgrade/v60/alphas.py

b'diff --git a/news/24.bugfix b/news/24.bugfix\nnew file mode 100644\nindex 00000000..9633a33e\n--- /dev/null\n+++ b/news/24.bugfix\n@@ -0,0 +1,4 @@\n+Remove old ``plone.session`` bundles.\n+Reapply its new registry settings, if its optional refresh support is installed.\n+Part of `plone.session issue 24 <https://github.com/plone/plone.session/issues/24>`_.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex afdcb030..9cef5a90 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -293,6 +293,11 @@ def cleanup_resources_and_bundles_in_registry(context=None):\n     # Otherwise the bundles we delete will come back to haunt us\n     context.upgradeProfile("plone.staticresources:default", dest="208")\n \n+    # Also reregister the newly defined plone.session bundle if it is installed.\n+    installer = get_installer(context)\n+    if installer.is_profile_installed("plone.session:default"):\n+        loadMigrationProfile(context, "profile-plone.session:default", steps=["plone.app.registry"])\n+\n     # Remove obsolete records from the registry\n     removed_keys = [\n         "plone.resources/",\n@@ -342,6 +347,8 @@ def cleanup_resources_and_bundles_in_registry(context=None):\n         "thememapper",\n         "plone-legacy",\n         "plone-logged-in",\n+        "plone-session-pseudo-css",\n+        "plone-session-js",\n     ]\n     bundles = registry.collectionOfInterface(\n         IBundleRegistry, prefix="plone.bundles", check=False\n@@ -354,6 +361,7 @@ def cleanup_resources_and_bundles_in_registry(context=None):\n     # Remove deprecated bundle fields\n     removed_fields = [\n         "compile",\n+        "develop_css",\n         "develop_javascript",\n         "last_compilation",\n         "merge_with",\n@@ -372,7 +380,6 @@ def cleanup_resources_and_bundles_in_registry(context=None):\n     logger.info(u"Removed {} deprecated bundle attributes from registry".format(len(to_delete)))\n \n     # local default controlpanel icons\n-    installer = get_installer(context)\n     loadMigrationProfile(context, "profile-Products.CMFPlone:plone", steps=["controlpanel"])\n     if installer.is_profile_installed("plone.app.theming:default"):\n         loadMigrationProfile(context, "profile-plone.app.theming:default", steps=["controlpanel"])\n'

