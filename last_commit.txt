Repository: plone.outputfilters


Branch: refs/heads/master
Date: 2022-09-09T14:34:34+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.outputfilters/commit/223c96204e37ca1fcd4a8ac878f5a6a5b4059e40

Revert uuidToObject change.

It causes test failures in plone.outputfilters, plone.restapi and plone.volto.

Files changed:
M plone/outputfilters/browser/resolveuid.py
M plone/outputfilters/filters/resolveuid_and_caption.py
M setup.py
D news/52.bugfix

b'diff --git a/news/52.bugfix b/news/52.bugfix\ndeleted file mode 100644\nindex fba7aff..0000000\n--- a/news/52.bugfix\n+++ /dev/null\n@@ -1,2 +0,0 @@\n-Use our new version of uuidToObject() from plone.app.uuid.utils\n-[anirudhhkashyap] \n\\ No newline at end of file\ndiff --git a/plone/outputfilters/browser/resolveuid.py b/plone/outputfilters/browser/resolveuid.py\nindex 85179a5..8c1e05b 100644\n--- a/plone/outputfilters/browser/resolveuid.py\n+++ b/plone/outputfilters/browser/resolveuid.py\n@@ -5,7 +5,6 @@\n from zope.interface import implementer\n from zope.publisher.browser import BrowserView\n from zope.publisher.interfaces import IPublishTraverse\n-from plone.app.uuid.utils import uuidToObject\n \n \n try:\n@@ -23,10 +22,16 @@ def uuidToURL(uuid):\n         return res[0].getURL()\n \n \n-@deprecate("Import from plone.app.uuid.utils instead. To be removed in version 6.")\n+@deprecate(\n+    "Please use plone.app.uuid.utils.uuidToObject instead. "\n+    "But be aware that this does an extra security check."\n+)\n def uuidToObject(uuid):\n-    """Resolves a UUID to an object via the Physical Path"""\n-    return uuidToObject(uuid, unrestricted=True)\n+    """Resolves a UUID to an object via the UID index of portal_catalog."""\n+    catalog = getToolByName(getSite(), "portal_catalog")\n+    res = catalog.unrestrictedSearchResults(UID=uuid)\n+    if res:\n+        return res[0]._unrestrictedGetObject()\n \n \n try:\ndiff --git a/plone/outputfilters/filters/resolveuid_and_caption.py b/plone/outputfilters/filters/resolveuid_and_caption.py\nindex 6d3b10b..fc2b411 100644\n--- a/plone/outputfilters/filters/resolveuid_and_caption.py\n+++ b/plone/outputfilters/filters/resolveuid_and_caption.py\n@@ -6,7 +6,7 @@\n from DocumentTemplate.DT_Var import newline_to_br\n from DocumentTemplate.html_quote import html_quote\n from plone.base.utils import safe_text\n-from plone.app.uuid.utils import uuidToObject\n+from plone.outputfilters.browser.resolveuid import uuidToObject\n from plone.outputfilters.interfaces import IFilter\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.interfaces import IContentish\n@@ -274,8 +274,7 @@ def resolve_link(self, href):\n             match = resolveuid_re.match(subpath)\n             if match is not None:\n                 uid, _subpath = match.groups()\n-                # Getting URL of an object from it\'s UUID needs no permission checks\n-                obj = uuidToObject(uid, unrestricted=True)\n+                obj = uuidToObject(uid)\n                 if obj is not None:\n                     subpath = _subpath\n \ndiff --git a/setup.py b/setup.py\nindex 07074c3..ad55727 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -64,7 +64,7 @@ def read(filename):\n         "Products.MimetypesRegistry",\n         "Products.PortalTransforms>=2.0",\n         "plone.namedfile",\n-        "plone.app.uuid>=2.2.0",\n+        "plone.app.uuid",\n         "setuptools",\n         "unidecode",\n         "zope.deprecation",\n'

