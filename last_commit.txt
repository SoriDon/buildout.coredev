Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-11-29T16:31:27+01:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/a49516326cb52a38025ca4b580c0e2f74d12bc29

updating test to confirm wrong rendered resources

Files changed:
M Products/CMFPlone/tests/testResourceRegistries.py

b'diff --git a/Products/CMFPlone/tests/testResourceRegistries.py b/Products/CMFPlone/tests/testResourceRegistries.py\nindex a619d4679e..ca3a8dd0ee 100644\n--- a/Products/CMFPlone/tests/testResourceRegistries.py\n+++ b/Products/CMFPlone/tests/testResourceRegistries.py\n@@ -368,6 +368,19 @@ def test_scripts_anonymous(self):\n         self.assertNotIn("http://test2.foo/member.min.js", results)\n         self.assertIn("http://test3.foo/test.min.js", results)\n \n+    def test_scripts_switching_roles(self):\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        scripts.update()\n+        results = scripts.render()\n+        self.assertIn("http://test2.foo/member.min.js", results)\n+\n+        logout()\n+\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        scripts.update()\n+        results = scripts.render()\n+        self.assertNotIn("http://test2.foo/member.min.js", results)\n+\n \n class TestRRControlPanel(PloneTestCase.PloneTestCase):\n \n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-11-29T16:47:25+01:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/2fb3f21731973aa727caa5d6c966a8bdb3069e50

add user localroles to renderer cachekey

Files changed:
M Products/CMFPlone/resources/browser/resource.py

b'diff --git a/Products/CMFPlone/resources/browser/resource.py b/Products/CMFPlone/resources/browser/resource.py\nindex 194ca8ce55..9c4735cab1 100644\n--- a/Products/CMFPlone/resources/browser/resource.py\n+++ b/Products/CMFPlone/resources/browser/resource.py\n@@ -6,6 +6,7 @@\n from plone.app.theming.utils import theming_policy\n from plone.base.interfaces import IBundleRegistry\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.component.hooks import getSite\n@@ -45,6 +46,11 @@ def _request_bundles(self):\n             request_disabled_bundles.update(getattr(request, "disabled_bundles", []))\n         return request_enabled_bundles, request_disabled_bundles\n \n+    def _user_local_roles(self, site):\n+        portal_membership = getToolByName(site, "portal_membership")\n+        user = portal_membership.getAuthenticatedMember()\n+        return "|".join(user.getRolesInContext(self.context))\n+\n     def _cache_attr_name(self, site):\n         hashtool = hashlib.sha256()\n         hashtool.update(self.__class__.__name__.encode(\'utf8\'))\n@@ -52,6 +58,7 @@ def _cache_attr_name(self, site):\n         e_bundles, d_bundles = self._request_bundles()\n         for bundle in e_bundles | d_bundles:\n             hashtool.update(bundle.encode(\'utf8\'))\n+        hashtool.update(self._user_local_roles(site).encode("utf8"))\n         return f"_v_renderend_cache_{hashtool.hexdigest()}"\n \n     @property\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-11-29T16:48:27+01:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/836611da69637bf54b31ceba1ba94c92c18e3070

changenote

Files changed:
A news/3683.bugfix

b'diff --git a/news/3683.bugfix b/news/3683.bugfix\nnew file mode 100644\nindex 0000000000..fc062caec7\n--- /dev/null\n+++ b/news/3683.bugfix\n@@ -0,0 +1,2 @@\n+Fix caching of rendered resources.\n+[petschki]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-11-30T09:16:06+01:00
Author: Peter Mathis (petschki) <petschki@users.noreply.github.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/49d4cb1fb69a6c050933618a400c486aaf4629c0

Merge pull request #3684 from plone/petschki-resource-expression

Fix rendering of resources with expressions

Files changed:
A news/3683.bugfix
M Products/CMFPlone/resources/browser/resource.py
M Products/CMFPlone/tests/testResourceRegistries.py

b'diff --git a/Products/CMFPlone/resources/browser/resource.py b/Products/CMFPlone/resources/browser/resource.py\nindex 194ca8ce55..9c4735cab1 100644\n--- a/Products/CMFPlone/resources/browser/resource.py\n+++ b/Products/CMFPlone/resources/browser/resource.py\n@@ -6,6 +6,7 @@\n from plone.app.theming.utils import theming_policy\n from plone.base.interfaces import IBundleRegistry\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.component.hooks import getSite\n@@ -45,6 +46,11 @@ def _request_bundles(self):\n             request_disabled_bundles.update(getattr(request, "disabled_bundles", []))\n         return request_enabled_bundles, request_disabled_bundles\n \n+    def _user_local_roles(self, site):\n+        portal_membership = getToolByName(site, "portal_membership")\n+        user = portal_membership.getAuthenticatedMember()\n+        return "|".join(user.getRolesInContext(self.context))\n+\n     def _cache_attr_name(self, site):\n         hashtool = hashlib.sha256()\n         hashtool.update(self.__class__.__name__.encode(\'utf8\'))\n@@ -52,6 +58,7 @@ def _cache_attr_name(self, site):\n         e_bundles, d_bundles = self._request_bundles()\n         for bundle in e_bundles | d_bundles:\n             hashtool.update(bundle.encode(\'utf8\'))\n+        hashtool.update(self._user_local_roles(site).encode("utf8"))\n         return f"_v_renderend_cache_{hashtool.hexdigest()}"\n \n     @property\ndiff --git a/Products/CMFPlone/tests/testResourceRegistries.py b/Products/CMFPlone/tests/testResourceRegistries.py\nindex a619d4679e..ca3a8dd0ee 100644\n--- a/Products/CMFPlone/tests/testResourceRegistries.py\n+++ b/Products/CMFPlone/tests/testResourceRegistries.py\n@@ -368,6 +368,19 @@ def test_scripts_anonymous(self):\n         self.assertNotIn("http://test2.foo/member.min.js", results)\n         self.assertIn("http://test3.foo/test.min.js", results)\n \n+    def test_scripts_switching_roles(self):\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        scripts.update()\n+        results = scripts.render()\n+        self.assertIn("http://test2.foo/member.min.js", results)\n+\n+        logout()\n+\n+        scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n+        scripts.update()\n+        results = scripts.render()\n+        self.assertNotIn("http://test2.foo/member.min.js", results)\n+\n \n class TestRRControlPanel(PloneTestCase.PloneTestCase):\n \ndiff --git a/news/3683.bugfix b/news/3683.bugfix\nnew file mode 100644\nindex 0000000000..fc062caec7\n--- /dev/null\n+++ b/news/3683.bugfix\n@@ -0,0 +1,2 @@\n+Fix caching of rendered resources.\n+[petschki]\n'

