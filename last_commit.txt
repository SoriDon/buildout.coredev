Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-05-17T12:08:36+02:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/5909d9f30e7cfc56cd967480f43573975b5d18bd

tinymce pat settings from image_scales to image_srcsets

Files changed:
A news/3477.feature
M Products/CMFPlone/patterns/settings.py

b'diff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex 2d63b3ef69..8f5afc81ab 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -7,6 +7,7 @@\n from plone.registry.interfaces import IRegistry\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.interfaces._content import IFolderish\n+from plone.base.interfaces import IImagingSchema\n from plone.base.interfaces import ILinkSchema\n from plone.base.interfaces import IPatternsSettings\n from plone.base.interfaces import IPloneSiteRoot\n@@ -71,12 +72,10 @@ def mark_special_links(self):\n         return result\n \n     @property\n-    def image_scales(self):\n-        factory = getUtility(IVocabularyFactory, "plone.app.vocabularies.ImagesScales")\n-        vocabulary = factory(self.context)\n-        ret = [{"title": translate(it.title), "value": it.value} for it in vocabulary]\n-        ret = sorted(ret, key=lambda it: it["title"])\n-        return json.dumps(ret)\n+    def image_srcsets(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n+        return settings.image_srcsets\n \n     def tinymce(self):\n         """\n@@ -129,7 +128,7 @@ def tinymce(self):\n         configuration = {\n             "base_url": self.context.absolute_url(),\n             "imageTypes": image_types,\n-            "imageScales": self.image_scales,\n+            "imageSrcsets": self.image_srcsets,\n             "linkAttribute": "UID",\n             # This is for loading the languages on tinymce\n             "loadingBaseUrl": "{}/++plone++static/components/tinymce-builded/"\ndiff --git a/news/3477.feature b/news/3477.feature\nnew file mode 100644\nindex 0000000000..78e99ea9a1\n--- /dev/null\n+++ b/news/3477.feature\n@@ -0,0 +1 @@\n+Add image srcset\'s configuration to TinyMCE pattern settings [MrTango]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-05-17T12:08:36+02:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/15ba17e25dc9f932071a38c816bbbc83233799b0

filter out srcsets with hideInEditor set to true

Files changed:
M Products/CMFPlone/patterns/settings.py

b'diff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex 8f5afc81ab..96b7210ac3 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -75,7 +75,13 @@ def mark_special_links(self):\n     def image_srcsets(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n-        return settings.image_srcsets\n+        editor_srcsets = {}\n+        for k, srcset in settings.image_srcsets.items():\n+            hide_in_editor = srcset.get("hideInEditor")\n+            if hide_in_editor:\n+                continue\n+            editor_srcsets[k] = srcset\n+        return editor_srcsets\n \n     def tinymce(self):\n         """\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-05-17T12:08:36+02:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/2b28f0ac610bf11427b729ba370443b73270363d

add imageCaptioningEnabled param to TinyMCE settings

Files changed:
M Products/CMFPlone/patterns/settings.py

b'diff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex 96b7210ac3..cb7a236ead 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -83,6 +83,12 @@ def image_srcsets(self):\n             editor_srcsets[k] = srcset\n         return editor_srcsets\n \n+    @property\n+    def image_captioning(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n+        return settings.image_captioning\n+\n     def tinymce(self):\n         """\n         data-pat-tinymce : JSON.stringify({\n@@ -135,6 +141,7 @@ def tinymce(self):\n             "base_url": self.context.absolute_url(),\n             "imageTypes": image_types,\n             "imageSrcsets": self.image_srcsets,\n+            "imageCaptioningEnabled": self.image_captioning,\n             "linkAttribute": "UID",\n             # This is for loading the languages on tinymce\n             "loadingBaseUrl": "{}/++plone++static/components/tinymce-builded/"\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-05-17T12:09:56+02:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/2dd5c11f190184efc3a9380aaa07db72be115626

tinymce pat settings from image_scales to image_srcsets

Files changed:
M Products/CMFPlone/patterns/settings.py

b'diff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex cb7a236ead..3020d4694b 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -75,6 +75,7 @@ def mark_special_links(self):\n     def image_srcsets(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n+<<<<<<< HEAD\n         editor_srcsets = {}\n         for k, srcset in settings.image_srcsets.items():\n             hide_in_editor = srcset.get("hideInEditor")\n@@ -88,6 +89,9 @@ def image_captioning(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n         return settings.image_captioning\n+=======\n+        return settings.image_srcsets\n+>>>>>>> 6751589c8 (tinymce pat settings from image_scales to image_srcsets)\n \n     def tinymce(self):\n         """\n@@ -141,7 +145,10 @@ def tinymce(self):\n             "base_url": self.context.absolute_url(),\n             "imageTypes": image_types,\n             "imageSrcsets": self.image_srcsets,\n+<<<<<<< HEAD\n             "imageCaptioningEnabled": self.image_captioning,\n+=======\n+>>>>>>> 6751589c8 (tinymce pat settings from image_scales to image_srcsets)\n             "linkAttribute": "UID",\n             # This is for loading the languages on tinymce\n             "loadingBaseUrl": "{}/++plone++static/components/tinymce-builded/"\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-05-17T12:13:06+02:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/49949b881eceea1f5fd0944cdf230fc5204c9997

filter out srcsets with hideInEditor set to true

Files changed:
M Products/CMFPlone/patterns/settings.py

b'diff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex 3020d4694b..cb7a236ead 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -75,7 +75,6 @@ def mark_special_links(self):\n     def image_srcsets(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n-<<<<<<< HEAD\n         editor_srcsets = {}\n         for k, srcset in settings.image_srcsets.items():\n             hide_in_editor = srcset.get("hideInEditor")\n@@ -89,9 +88,6 @@ def image_captioning(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n         return settings.image_captioning\n-=======\n-        return settings.image_srcsets\n->>>>>>> 6751589c8 (tinymce pat settings from image_scales to image_srcsets)\n \n     def tinymce(self):\n         """\n@@ -145,10 +141,7 @@ def tinymce(self):\n             "base_url": self.context.absolute_url(),\n             "imageTypes": image_types,\n             "imageSrcsets": self.image_srcsets,\n-<<<<<<< HEAD\n             "imageCaptioningEnabled": self.image_captioning,\n-=======\n->>>>>>> 6751589c8 (tinymce pat settings from image_scales to image_srcsets)\n             "linkAttribute": "UID",\n             # This is for loading the languages on tinymce\n             "loadingBaseUrl": "{}/++plone++static/components/tinymce-builded/"\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-06-01T18:17:21+03:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/6cb13653c2943b152c9241a7a2b1637ad72480d4

Merge remote-tracking branch 'remotes/origin/mrtango-image-handling-sourcesets-settings' into mrtango-image-handling-sourcesets-settings

Files changed:
A news/1178.feature
A news/3533.bugfix
M Products/CMFPlone/controlpanel/browser/redirects.py
M Products/CMFPlone/resources/utils.py

b'diff --git a/Products/CMFPlone/controlpanel/browser/redirects.py b/Products/CMFPlone/controlpanel/browser/redirects.py\nindex c84c710305..4e84068755 100644\n--- a/Products/CMFPlone/controlpanel/browser/redirects.py\n+++ b/Products/CMFPlone/controlpanel/browser/redirects.py\n@@ -271,7 +271,7 @@ def redirects(self):\n                 created=self.request.form.get(\'datetime\', \'\'),\n                 manual=self.request.form.get(\'manual\', \'\'),\n             ),\n-            15,\n+            int(self.request.form.get(\'b_size\', \'15\')),\n             int(self.request.form.get(\'b_start\', \'0\')),\n             orphan=1,\n         )\ndiff --git a/Products/CMFPlone/resources/utils.py b/Products/CMFPlone/resources/utils.py\nindex 8a856ae004..3409e53549 100644\n--- a/Products/CMFPlone/resources/utils.py\n+++ b/Products/CMFPlone/resources/utils.py\n@@ -52,7 +52,7 @@ def get_resource(context, path):\n         return\n     try:\n         resource = context.unrestrictedTraverse(path)\n-    except (NotFound, AttributeError):\n+    except (NotFound, AttributeError, KeyError):\n         logger.warning(\n             f"Could not find resource {path}. You may have to create it first."\n         )  # noqa\ndiff --git a/news/1178.feature b/news/1178.feature\nnew file mode 100644\nindex 0000000000..af995d9515\n--- /dev/null\n+++ b/news/1178.feature\n@@ -0,0 +1,2 @@\n+Added customisable batch_size for redirects controlpanel\n+[iulianpetchesi]\ndiff --git a/news/3533.bugfix b/news/3533.bugfix\nnew file mode 100644\nindex 0000000000..635ea51c56\n--- /dev/null\n+++ b/news/3533.bugfix\n@@ -0,0 +1,2 @@\n+Fix rendering viewlet.resourceregistries.js when there are missing resources.\n+[petschki]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-06-07T17:27:08+03:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/f16f386703ea8467d165fdb570e83d3dc13e2a41

rename image_srcsets to picture_variants

Files changed:
M Products/CMFPlone/patterns/settings.py

b'diff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex cb7a236ead..7f1fb5979e 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -72,16 +72,16 @@ def mark_special_links(self):\n         return result\n \n     @property\n-    def image_srcsets(self):\n+    def picture_variants(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n-        editor_srcsets = {}\n-        for k, srcset in settings.image_srcsets.items():\n-            hide_in_editor = srcset.get("hideInEditor")\n+        editor_picture_variants = {}\n+        for k, picture_variant in settings.picture_variants.items():\n+            hide_in_editor = picture_variant.get("hideInEditor")\n             if hide_in_editor:\n                 continue\n-            editor_srcsets[k] = srcset\n-        return editor_srcsets\n+            editor_picture_variants[k] = picture_variant\n+        return editor_picture_variants\n \n     @property\n     def image_captioning(self):\n@@ -140,7 +140,7 @@ def tinymce(self):\n         configuration = {\n             "base_url": self.context.absolute_url(),\n             "imageTypes": image_types,\n-            "imageSrcsets": self.image_srcsets,\n+            "pictureVariants": self.picture_variants,\n             "imageCaptioningEnabled": self.image_captioning,\n             "linkAttribute": "UID",\n             # This is for loading the languages on tinymce\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-06-08T23:42:00+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/28d1ea602ee0d6299bb5b90c24de7be2fa10347a

Merge branch 'master' into mrtango-image-handling-sourcesets-settings

Files changed:
A news/3528.feature
A news/3539.bugfix
M Products/CMFPlone/browser/admin.py
M Products/CMFPlone/browser/templates/plone-upgrade.pt
M Products/CMFPlone/tests/robot/test_controlpanel_actions.robot
M Products/CMFPlone/tests/robot/test_controlpanel_filter.robot
M Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
M Products/CMFPlone/tests/robot/test_controlpanel_search.robot
M Products/CMFPlone/tests/robot/test_controlpanel_security.robot
M Products/CMFPlone/tests/robot/test_controlpanel_site.robot
M Products/CMFPlone/tests/robot/test_controlpanel_social.robot
M Products/CMFPlone/tests/robot/test_edit_user_schema.robot
M Products/CMFPlone/tests/robot/test_linkintegrity.robot
M Products/CMFPlone/tests/robot/test_livesearch.robot
M Products/CMFPlone/tests/robot/test_querystring.robot
M Products/CMFPlone/tests/robot/test_tinymce.robot
M Products/CMFPlone/tests/testResourceRegistries.py

b'diff --git a/Products/CMFPlone/browser/admin.py b/Products/CMFPlone/browser/admin.py\nindex dfa3df808c..972a6c4789 100644\n--- a/Products/CMFPlone/browser/admin.py\n+++ b/Products/CMFPlone/browser/admin.py\n@@ -343,3 +343,16 @@ def __call__(self):\n             )\n \n         return self.index()\n+\n+    def can_migrate_to_volto(self):\n+        if not HAS_VOLTO:\n+            return False\n+        pm = getattr(self.context, \'portal_migration\')\n+        if pm.getInstanceVersion() < "6005":\n+            return False\n+        try:\n+            from plone.volto.browser import migrate_to_volto\n+        except ImportError:\n+            return False\n+        installer = get_installer(self.context, self.request)\n+        return not installer.is_product_installed("plone.volto")\ndiff --git a/Products/CMFPlone/browser/templates/plone-upgrade.pt b/Products/CMFPlone/browser/templates/plone-upgrade.pt\nindex c4a09be6dd..21b66bbe9e 100644\n--- a/Products/CMFPlone/browser/templates/plone-upgrade.pt\n+++ b/Products/CMFPlone/browser/templates/plone-upgrade.pt\n@@ -70,6 +70,16 @@\n               </dd>\n             </dl>\n \n+            <tal:volto tal:condition="python: versions[\'equal\'] and view.can_migrate_to_volto()">\n+              <p class="alert-success p-2" i18n:translate="">\n+                You can prepare your site for Volto, the default frontend of Plone 6!\n+              </p>\n+              <a class="p-2" i18n:translate=""\n+                 tal:attributes="href string:${context/absolute_url}/@@migrate_to_volto">\n+                Click here if you want to learn more.\n+              </a>\n+            </tal:volto>\n+\n           </div>\n           <form tal:condition="versions/instance_lt"\n                 action="#"\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_actions.robot b/Products/CMFPlone/tests/robot/test_controlpanel_actions.robot\nindex 3d7bfd015f..8bb0a2513c 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_actions.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_actions.robot\n@@ -71,37 +71,26 @@ I modify an action title\n   Click Link    css=section:nth-child(3) li:first-child a\n   Wait until page contains  Action Settings\n   Input Text for sure  form.widgets.title  A new site map\n-  Set Focus To Element  css=.pattern-modal-buttons > button\n-  Wait Until Element Is Visible  css=.pattern-modal-buttons > button\n-  Click Element  css=.pattern-modal-buttons > button\n+  Wait For Then Click Element  css=.pattern-modal-buttons > button\n \n I change the actions order\n   Click Link    css=section:nth-child(3) li:first-child a\n   Wait until page contains  Action Settings\n   Input Text for sure  form.widgets.position  3\n-  Set Focus To Element  css=.pattern-modal-buttons > button\n-  Wait Until Element Is Visible  css=.pattern-modal-buttons > button\n-  Click Element  css=.pattern-modal-buttons > button\n+  Wait For Then Click Element  css=.pattern-modal-buttons > button\n \n I add a new action\n   Click Link  Add new action\n   Wait until page contains  New action\n   Select From List By Label   form.widgets.category:list   User actions\n   Input Text for sure  form.widgets.id  favorites\n-  Set Focus To Element  css=.pattern-modal-buttons > button\n-  Wait Until Element Is Visible  css=.pattern-modal-buttons > button\n-  Click Element  css=.pattern-modal-buttons > button\n+  Wait For Then Click Element  css=.pattern-modal-buttons > button\n   Wait until page contains  favorites\n-  Set Focus To Element  css=section.category:last-child li:last-child a\n-  Wait Until Element Is Visible  css=section.category:last-child li:last-child a\n-  Sleep  1\n-  Click Link  css=section.category:last-child li:last-child a\n+  Wait For Then Click Element  css=section.category:last-child li:last-child a\n   Wait until page contains  Action Settings\n   Input Text for sure  form.widgets.title  My favorites\n   Input Text for sure  form.widgets.url_expr  string:\\${globals_view/navigationRootUrl}/favorites\n-  Set Focus To Element  css=.pattern-modal-buttons > button\n-  Wait Until Element Is Visible  css=.pattern-modal-buttons > button\n-  Click Element  css=.pattern-modal-buttons > button\n+  Wait For Then Click Element  css=.pattern-modal-buttons > button\n \n I delete an action\n   Click Button    css=section:nth-child(3) li:first-child button[name=delete]\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_filter.robot b/Products/CMFPlone/tests/robot/test_controlpanel_filter.robot\nindex d056bf0a8e..0bad48857c 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_filter.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_filter.robot\n@@ -69,6 +69,12 @@ the filter control panel\n \n Input RichText\n   [Arguments]  ${input}\n+  # Sleep to avoid random failures where the text is not actually set.\n+  # This warning from the robotframework docs might be the cause:\n+  # "Starting from Robot Framework 2.5 errors caused by invalid syntax, timeouts,\n+  # or fatal exceptions are not caught by this keyword."\n+  # See https://robotframework.org/robotframework/2.6.1/libraries/BuiltIn.html#Wait%20Until%20Keyword%20Succeeds\n+  Sleep  1\n   Wait until keyword succeeds  5s  1s  Execute Javascript  tinyMCE.activeEditor.setContent(\'${input}\');\n \n \n@@ -77,26 +83,24 @@ Input RichText\n I add \'${tag}\' to the nasty tags list and remove it from the valid tags list\n   Input Text  name=form.widgets.nasty_tags  ${tag}\n   Remove line from textarea  form.widgets.valid_tags  ${tag}\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  I save the form\n \n I remove \'${tag}\' from the valid tags list\n   Remove line from textarea  form.widgets.valid_tags  ${tag}\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  I save the form\n \n I add \'${tag}\' to the valid tags list\n   Input Text  name=form.widgets.valid_tags  ${tag}\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  I save the form\n+  Page Should Contain  ${tag}\n \n I add \'${tag}\' to the custom attributes list\n   Input Text  name=form.widgets.custom_attributes  ${tag}\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  I save the form\n+  Page Should Contain  ${tag}\n \n I save the form\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n \n@@ -106,18 +110,23 @@ the \'h1\' tag is filtered out when a document is saved\n   ${doc1_uid}=  Create content  id=doc1  title=Document 1  type=Document\n   Go To  ${PLONE_URL}/doc1/edit\n   patterns are loaded\n-  Input RichText  <h1>h1 heading</h1><p>lorem ipsum</p>\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  Input RichText  <h1>h1 heading</h1><p>Spanish Inquisition</p>\n+  I save the form\n+  # We check that some standard text is there, before checking the interesting part.\n+  # If the standard text is invisible, then something completely different is wrong.\n+  # I see tests randomly fail where the safe html transform is not even called.\n+  # In fact, no text is saved.  Maybe some timing problem.\n+  # I suspect the Input RichText keyword, which is why I added Sleep in there.\n+  Page should contain  Spanish Inquisition\n   Page should not contain  heading\n \n the \'h1\' tag is stripped when a document is saved\n   ${doc1_uid}=  Create content  id=doc1  title=Document 1  type=Document\n   Go To  ${PLONE_URL}/doc1/edit\n   patterns are loaded\n-  Input RichText  <h1>h1 heading</h1><p>lorem ipsum</p>\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  Input RichText  <h1>h1 heading</h1><p>Spanish Inquisition</p>\n+  I save the form\n+  Page should contain  Spanish Inquisition\n   Page should contain  heading\n   Page Should Contain Element  //div[@id=\'content-core\']//h1  limit=0  message=h1 should have been stripped out\n \n@@ -125,18 +134,18 @@ the \'${tag}\' tag is preserved when a document is saved\n   ${doc1_uid}=  Create content  id=doc1  title=Document 1  type=Document\n   Go To  ${PLONE_URL}/doc1/edit\n   patterns are loaded\n-  Input RichText  <${tag}>lorem ipsum</${tag}>\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  Input RichText  <${tag}>lorem ipsum</${tag}><p>Spanish Inquisition</p>\n+  I save the form\n+  Page should contain  Spanish Inquisition\n   Page Should Contain Element  //div[@id=\'content-core\']//${tag}  limit=1  message=the ${tag} tag should have been preserved\n \n the \'${attribute}\' attribute is preserved when a document is saved\n   ${doc1_uid}=  Create content  id=doc1  title=Document 1  type=Document\n   Go To  ${PLONE_URL}/doc1/edit\n   patterns are loaded\n-  Input RichText  <span ${attribute}="foo">lorem ipsum</span>\n-  Click Button  Save\n-  Wait until page contains  Changes saved\n+  Input RichText  <span ${attribute}="foo">lorem ipsum</span><p>Spanish Inquisition</p>\n+  I save the form\n+  Page should contain  Spanish Inquisition\n   Page Should Contain Element  //span[@${attribute}]  limit=1  message=the ${attribute} tag should have been preserved\n \n success message should contain information regarding caching\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot b/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot\nindex 7518cd3a03..c277aedf52 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot\n@@ -68,37 +68,27 @@ a private document \'${title}\'\n \n I disable generate tabs\n   Unselect Checkbox  form.widgets.generate_tabs:list\n-  Set Focus To Element  form.buttons.save\n-  Wait Until Element Is Visible  form.buttons.save\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I disable non-folderish tabs\n   Unselect Checkbox  xpath=//input[@value=\'Document\']\n-  Set Focus To Element  form.buttons.save\n-  Wait Until Element Is Visible  form.buttons.save\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I remove \'${portal_type}\' from the displayed types list\n   Unselect Checkbox  xpath=//input[@value=\'Document\']\n-  Set Focus To Element  form.buttons.save\n-  Wait Until Element Is Visible  form.buttons.save\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I enable filtering by workflow states\n   Select Checkbox  name=form.widgets.filter_on_workflow:list\n-  Set Focus To Element  form.buttons.save\n-  Wait Until Element Is Visible  form.buttons.save\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I choose to show \'${workflow_state}\' items\n   Select Checkbox  xpath=//input[@value=\'${workflow_state}\']\n-  Set Focus To Element  form.buttons.save\n-  Wait Until Element Is Visible  form.buttons.save\n-  Click Button  Save\n+  Wait For Then Click Element  form.buttons.save\n   Wait until page contains  Changes saved\n \n I choose to not show \'${workflow_state}\' items\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_search.robot b/Products/CMFPlone/tests/robot/test_controlpanel_search.robot\nindex 395c160b30..de9c3b5cfe 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_search.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_search.robot\n@@ -49,18 +49,15 @@ the search control panel\n \n I enable livesearch\n   Select Checkbox  form.widgets.enable_livesearch:list\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I exclude the \'${portal_type}\' type from search\n   # Make sure we see the checkbox, in expanded in jenkins it gets a bit under the toolbar\n-  Set Focus To Element  xpath=//input[@name=\'form.widgets.types_not_searched:list\' and @value=\'${portal_type}\']\n-  Unselect Checkbox  xpath=//input[@name=\'form.widgets.types_not_searched:list\' and @value=\'${portal_type}\']\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  ${element}  Set Variable  xpath=//input[@name=\'form.widgets.types_not_searched:list\' and @value=\'${portal_type}\']\n+  Wait For Element  ${element}\n+  Unselect Checkbox  ${element}\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n \ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_security.robot b/Products/CMFPlone/tests/robot/test_controlpanel_security.robot\nindex 4b7066cb31..535f96945e 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_security.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_security.robot\n@@ -64,9 +64,9 @@ the security control panel\n \n a published test folder\n   Go to  ${PLONE_URL}/test-folder\n-  Wait until element is visible  css=#plone-contentmenu-workflow\n+  Wait For Element  css=#plone-contentmenu-workflow\n   Click link  xpath=//li[@id=\'plone-contentmenu-workflow\']/a\n-  Wait until element is visible  id=workflow-transition-publish\n+  Wait For Element  id=workflow-transition-publish\n   Click link  id=workflow-transition-publish\n   Wait until page contains  Item state changed\n \n@@ -142,9 +142,7 @@ A user folder should be created when a user registers and logs in to the site\n   Input Text for sure  form.widgets.email  joe@test.com\n   Input Text for sure  form.widgets.password  supersecret\n   Input Text for sure  form.widgets.password_ctl  supersecret\n-  Set Focus To Element  css=#form-buttons-register\n-  Wait Until Element Is Visible  css=#form-buttons-register\n-  Click Button  Register\n+  Wait For Then Click Element  css=#form-buttons-register\n \n   # I login to the site\n   Go to  ${PLONE_URL}/login\n@@ -176,9 +174,7 @@ UUID should be used for the user id\n   Input Text for sure  form.widgets.email  joe@test.com\n   Input Text for sure  form.widgets.password  supersecret\n   Input Text for sure  form.widgets.password_ctl  supersecret\n-  Set Focus To Element  css=#form-buttons-register\n-  Wait Until Element Is Visible  css=#form-buttons-register\n-  Click Button  Register\n+  Wait For Then Click Element  css=#form-buttons-register\n \n   # I login to the site\n   Go to  ${PLONE_URL}/login\ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_site.robot b/Products/CMFPlone/tests/robot/test_controlpanel_site.robot\nindex 81fee76ee0..1844ac2d65 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_site.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_site.robot\n@@ -63,44 +63,33 @@ the site control panel\n \n I enable the sitemap\n   Given patterns are loaded\n-  Set Focus To Element  css=#formfield-form-widgets-enable_sitemap\n-  Wait Until Element Is Visible  css=#formfield-form-widgets-enable_sitemap\n+  Wait For Element  css=#formfield-form-widgets-enable_sitemap\n   Select Checkbox  form.widgets.enable_sitemap:list\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I set the site title to \'${site_title}\'\n   Given patterns are loaded\n   Input Text  name=form.widgets.site_title  ${site_title}\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I set a custom logo\n   Given patterns are loaded\n   Choose File  name=form.widgets.site_logo  ${PATH_TO_TEST_FILES}/pixel.png\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I enable dublin core metadata\n   Given patterns are loaded\n   Select Checkbox  form.widgets.exposeDCMetaTags:list\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I add a Javascript snippet to the webstats javascript\n   Given patterns are loaded\n   Input Text  name=form.widgets.webstats_js  <script id="webstats_snippet"></script>\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n \ndiff --git a/Products/CMFPlone/tests/robot/test_controlpanel_social.robot b/Products/CMFPlone/tests/robot/test_controlpanel_social.robot\nindex 70f106d2e0..2fae936771 100644\n--- a/Products/CMFPlone/tests/robot/test_controlpanel_social.robot\n+++ b/Products/CMFPlone/tests/robot/test_controlpanel_social.robot\n@@ -44,20 +44,14 @@ the social control panel\n \n I disable social\n   UnSelect Checkbox  form.widgets.share_social_data:list\n-  Sleep  2\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n I provide social settings\n   Input Text  name=form.widgets.twitter_username  plonecms\n   Input Text  name=form.widgets.facebook_app_id  123456\n   Input Text  name=form.widgets.facebook_username  plonecms\n-  Sleep  2\n-  Set Focus To Element  css=#form-buttons-save\n-  Wait Until Element Is Visible  css=#form-buttons-save\n-  Click Button  Save\n+  Wait For Then Click Element  css=#form-buttons-save\n   Wait until page contains  Changes saved\n \n \ndiff --git a/Products/CMFPlone/tests/robot/test_edit_user_schema.robot b/Products/CMFPlone/tests/robot/test_edit_user_schema.robot\nindex bbb8e87b4f..439bb5b074 100644\n--- a/Products/CMFPlone/tests/robot/test_edit_user_schema.robot\n+++ b/Products/CMFPlone/tests/robot/test_edit_user_schema.robot\n@@ -96,16 +96,15 @@ I add a new text field to the member fields\n   Click Link  Add new field\xe2\x80\xa6\n   Wait Until Element Is visible  css=#add-field-form #form-widgets-title\n   Input Text  css=#add-field-form #form-widgets-title  Test Field\n-  Press Key  css=#add-field-form #form-widgets-title  \\\\09\n+  Press Keys  css=#add-field-form #form-widgets-title  TAB\n   Select From List By Label  css=#form-widgets-factory  Text line (String)\n   Click button  css=.pattern-modal-buttons button#form-buttons-add\n   Wait until page contains  Field added successfully.\n \n I Open the test_field Settings\n   Go to  ${PLONE_URL}/@@member-fields\n-  Wait until page contains element  css=div[data-field_id=\'test_field\']\n-  Set Focus To Element  css=div[data-field_id=\'test_field\'] a.fieldSettings\n-  Wait Until Keyword Succeeds  3  100ms  Click link  css=div[data-field_id=\'test_field\'] a.fieldSettings\n+  Wait For Element  css=div[data-field_id=\'test_field\']\n+  Wait For Then Click Element  css=div[data-field_id=\'test_field\'] a.fieldSettings\n \n I add a new required text field to the member fields\n   Go to  ${PLONE_URL}/@@member-fields\n@@ -113,7 +112,7 @@ I add a new required text field to the member fields\n   Click Link  Add new field\xe2\x80\xa6\n   Wait Until Element Is visible  css=#add-field-form #form-widgets-title\n   Input Text  css=#add-field-form #form-widgets-title  Test Field\n-  Press Key  css=#add-field-form #form-widgets-title  \\\\09\n+  Press Keys  css=#add-field-form #form-widgets-title  TAB\n   Select From List By Label  css=#form-widgets-factory  Text line (String)\n   Select Checkbox  form.widgets.required:list\n   Click button  css=.pattern-modal-buttons button#form-buttons-add\n@@ -142,6 +141,7 @@ add a min/max constraint to the field\n   Wait until page contains element  form.widgets.min_length\n   Input Text  form.widgets.min_length  4\n   Input Text  form.widgets.max_length  6\n+  Wait Until Element Is visible  css=.pattern-modal-buttons button#form-buttons-save\n   Click Button  css=.pattern-modal-buttons button#form-buttons-save\n   Sleep  1\n \n@@ -172,7 +172,8 @@ a logged-in user will see the field on top of the user profile\n a logged-in user will see a field with min/max constraints\n   a logged-in user will see the field in the user profile\n   Input Text  form.widgets.email  test@plone.org\n+  Wait For Element  css=#form-widgets-test_field\n   Input Text  form.widgets.test_field  1\n-  Click Button  Save\n+  Wait For Then Click Element  css=.formControls button#form-buttons-save\n   Wait until page contains  There were some errors.\n   Page should contain  Value is too short\ndiff --git a/Products/CMFPlone/tests/robot/test_linkintegrity.robot b/Products/CMFPlone/tests/robot/test_linkintegrity.robot\nindex bf2b03adcf..db3f9d888f 100644\n--- a/Products/CMFPlone/tests/robot/test_linkintegrity.robot\n+++ b/Products/CMFPlone/tests/robot/test_linkintegrity.robot\n@@ -77,6 +77,8 @@ a link in rich text\n   Click Button  css=button[aria-label="Insert/edit link"]\n \n   Given patterns are loaded\n+  # Somehow this does not work:\n+  # Wait For Then Click Element  css=.pat-relateditems .select2-input.select2-default\n   Wait until element is visible  css=.pat-relateditems .select2-input.select2-default\n   Click Element  css=.pat-relateditems .select2-input.select2-default\n   Wait until element is visible  css=.pat-relateditems-result.one-level-up a.pat-relateditems-result-browse\n@@ -84,68 +86,59 @@ a link in rich text\n   Wait until element is visible  xpath=(//span[contains(., \'Foo\')])\n   Click Element  xpath=(//span[contains(., \'Foo\')])\n   Wait until page contains  Foo\n-\n-  Click Button  css=.modal-footer .btn-primary\n-  Click Button  css=#form-buttons-save\n+  Wait For Then Click Element  css=.modal-footer .btn-primary\n+  Wait For Then Click Element  css=#form-buttons-save\n \n \n should show warning when deleting page\n+\n   Go To  ${PLONE_URL}/foo\n-  Wait until element is visible  css=#plone-contentmenu-actions a\n-  Click Link  css=#plone-contentmenu-actions a\n-  Wait until element is visible  css=#plone-contentmenu-actions-delete\n-  Click Link  css=#plone-contentmenu-actions-delete\n+  Wait For Then Click Element  css=#plone-contentmenu-actions a\n+  Wait For Then Click Element  css=#plone-contentmenu-actions-delete\n   Wait until page contains element  css=.breach-container .breach-item\n \n \n should show warning when deleting page from folder_contents\n   Go To  ${PLONE_URL}/folder_contents\n-  Wait until keyword succeeds  30  1  Page should contain element  css=tr[data-id="foo"] input\n-  # Might still take a bit before it is clickable.\n-  Sleep  1\n-  Click Element  css=tr[data-id="foo"] input\n+  Wait For Then Click Element  css=tr[data-id="foo"] input\n   Checkbox Should Be Selected  css=tr[data-id="foo"] input\n   Wait until keyword succeeds  30  1  Page should not contain element  css=#btn-delete.disabled\n-  Click Element  css=#btngroup-mainbuttons #btn-delete\n+\n+  Wait For Then Click Element  css=#btngroup-mainbuttons #btn-delete\n   Wait until page contains element  css=.popover-content .btn-danger\n   Page should contain element  css=.breach-container .breach-item\n-  Click Element  css=#popover-delete .closeBtn\n+  Wait For Then Click Element  css=#popover-delete .closeBtn\n   Checkbox Should Be Selected  css=tr[data-id="foo"] input\n \n \n should not show warning when deleting page from folder_contents\n   Go To  ${PLONE_URL}/folder_contents\n   Wait until page contains element  css=tr[data-id="foo"] input\n-  # Might still take a bit before it is clickable.\n-  Sleep  1\n-  Click Element  css=tr[data-id="foo"] input\n+  Wait For Then Click Element  css=tr[data-id="foo"] input\n   Checkbox Should Be Selected  css=tr[data-id="foo"] input\n   Wait until keyword succeeds  30  1  Page should not contain element  css=#btn-delete.disabled\n-  Click Element  css=#btngroup-mainbuttons #btn-delete\n+  Wait For Then Click Element  css=#btngroup-mainbuttons #btn-delete\n   Wait until page contains element  css=.popover-content .btn-danger\n   Page should not contain element  css=.breach-container .breach-item\n-  Click Element  css=#popover-delete .applyBtn\n+  Wait For Then Click Element  css=#popover-delete .applyBtn\n   Wait until page contains  Successfully delete items\n   Wait until keyword succeeds  30  1  Page should not contain Element  css=tr[data-id="foo"] input\n \n \n should not show warning when deleting page\n   Go To  ${PLONE_URL}/foo\n-  Wait until element is visible  css=#plone-contentmenu-actions a\n-  Click Link  css=#plone-contentmenu-actions a\n-  Wait until element is visible  css=#plone-contentmenu-actions-delete\n-  Click Link  css=#plone-contentmenu-actions-delete\n+  Wait For Then Click Element  css=#plone-contentmenu-actions a\n+  Wait For Then Click Element  css=#plone-contentmenu-actions-delete\n   Page should not contain element  css=.breach-container .breach-item\n \n \n remove link to page\n   Go To  ${PLONE_URL}/bar\n-  Wait until element is visible  css=#contentview-edit a\n-  Click Link  css=#contentview-edit a\n-  Wait until element is visible  css=.tox-edit-area iframe\n+  Wait For Then Click Element  css=#contentview-edit a\n+  Wait For Element  css=.tox-edit-area iframe\n   Select Frame  css=.tox-edit-area iframe\n   Input text  css=.mce-content-body  foo\n   Execute Javascript    function selectElementContents(el) {var range = document.createRange(); range.selectNodeContents(el); var sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);} var el = document.getElementById("tinymce"); selectElementContents(el);\n   UnSelect Frame\n   Click Button  css=button[aria-label="Remove link"]\n-  Click Button  css=#form-buttons-save\n+  Wait For Then Click Element  css=#form-buttons-save\ndiff --git a/Products/CMFPlone/tests/robot/test_livesearch.robot b/Products/CMFPlone/tests/robot/test_livesearch.robot\nindex 0cbbb8280d..8bed725311 100644\n--- a/Products/CMFPlone/tests/robot/test_livesearch.robot\n+++ b/Products/CMFPlone/tests/robot/test_livesearch.robot\n@@ -55,13 +55,13 @@ a news item\n I search for\n     [Arguments]  ${searchtext}\n     Input text  css=input#searchGadget  ${searchtext}\n-    Set Focus To Element  css=input#searchGadget\n+    Wait For Element  css=input#searchGadget\n \n I search the currentfolder only for\n     [Arguments]  ${searchtext}\n     Select checkbox  id=searchbox_currentfolder_only\n     Input text  css=input#searchGadget  ${searchtext}\n-    Set Focus To Element  css=input#searchGadget\n+    Wait For Element  css=input#searchGadget\n \n the livesearch results should contain\n     [Arguments]  ${text}\ndiff --git a/Products/CMFPlone/tests/robot/test_querystring.robot b/Products/CMFPlone/tests/robot/test_querystring.robot\nindex ef22e81206..2ab1944c6a 100644\n--- a/Products/CMFPlone/tests/robot/test_querystring.robot\n+++ b/Products/CMFPlone/tests/robot/test_querystring.robot\n@@ -72,8 +72,7 @@ Scenario: Searchable text query\n     When I open the criteria Searchable text\n     and I search for a\n     and Sleep  0.2\n-    and Wait Until Element Is Visible  css=div.querystring-preview\n-    and Click Element  css=div.querystring-preview\n+    and Wait For Then Click Element  css=div.querystring-preview\n     Then we expect 2 hits\n     When I open the criteria Searchable text\n     and I search for d\n@@ -86,21 +85,18 @@ Scenario: Tag query one\n     and the querystring pattern\n     When I activate the default operator in the criteria Tag\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-o\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-o\n+    ${base_option_selector}  Set Variable  li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option\n+    and Wait For Then Click Element  css=${base_option_selector}-o\n     Then we expect 4 hits\n     When I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-n\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-n\n+    and Wait For Then Click Element  css=${base_option_selector}-n\n     Then we expect 4 hits\n     When I delete my selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-p\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-p\n+    and Wait For Then Click Element  css=${base_option_selector}-p\n     Then we expect 1 hits\n     When I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-e\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-e\n+    and Wait For Then Click Element  css=${base_option_selector}-e\n     Then we expect 2 hits\n \n Scenario Tag query two\n@@ -110,21 +106,18 @@ Scenario Tag query two\n     and the querystring pattern\n     When I expect an empty result after open the operator Matches all of in the criteria Tag\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-o\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-o\n+    ${base_option_selector}  Set Variable  li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option\n+    and Wait For Then Click Element  css=${base_option_selector}-o\n     Then we expect 4 hits\n     When and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-n\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-n\n+    and Wait For Then Click Element  css=${base_option_selector}-n\n     Then we expect 3 hits\n     When I delete my selection\n     and and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-p\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-p\n+    and Wait For Then Click Element  css=${base_option_selector}-p\n     Then we expect 1 hits\n     When and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-e\n-    and Click Element  css=li.select2-results-dept-0.select2-result.select2-result-selectable.select2-option-e\n+    and Wait For Then Click Element  css=${base_option_selector}-e\n     Then we expect 1 hits\n \n \n@@ -171,8 +164,7 @@ Scenario Review state query\n     and the querystring pattern\n     When I open the criteria Review State\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-private\n-    and Click Element  css=li.select2-option-private\n+    and Wait For Then Click Element  css=li.select2-option-private\n     Then we expect 7 hits\n \n Scenario Type query\n@@ -181,32 +173,26 @@ Scenario Type query\n     and the querystring pattern\n     When I open the criteria Type\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-event\n-    and Click Element  css=li.select2-option-event\n+    and Wait For Then Click Element  css=li.select2-option-event\n     Then we expect 4 hits\n     When I delete one selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-file\n-    and Click Element  css=li.select2-option-file\n+    and Wait For Then Click Element  css=li.select2-option-file\n     Then we do not expect any hits\n     When I delete one selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-folder\n-    and Click Element  css=li.select2-option-folder\n+    and Wait For Then Click Element  css=li.select2-option-folder\n     Then we expect 5 hits\n     When I delete one selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-link\n-    and Click Element  css=li.select2-option-link\n+    and Wait For Then Click Element  css=li.select2-option-link\n     Then we expect 1 hits\n     When I delete one selection\n     and I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-document\n-    and Click Element  css=li.select2-option-document\n+    and Wait For Then Click Element  css=li.select2-option-document\n     Then we expect 2 hits\n     When I open the Selection Widget\n-    and Wait Until Element Is Visible  css=li.select2-option-link\n-    and Click Element  css=li.select2-option-link\n+    and Wait For Then Click Element  css=li.select2-option-link\n     Then we expect 3 hits\n \n Scenario Creator query\n@@ -264,7 +250,6 @@ I activate the operator ${OPERATOR} in the criteria ${CRITERIA}\n I expect an empty result after open the operator ${OPERATOR} in the criteria ${CRITERIA}\n     open the select box titled index\n     select index type ${CRITERIA}\n-    sleep  0.75\n     Wait for condition  return $("dl.searchResults").length == 0\n     open the select box titled operator\n     select index type ${OPERATOR}\n@@ -274,59 +259,61 @@ I open the criteria ${CRITERIA}\n     select index type ${CRITERIA}\n \n I search for ${KEYWORD}\n-    Wait Until Element Is Visible  css=input.querystring-criteria-value-StringWidget\n-    Click Element  css=input.querystring-criteria-value-StringWidget\n-    Input Text  css=input.querystring-criteria-value-StringWidget  ${KEYWORD}\n+    ${keyword_selector}  Set Variable  input.querystring-criteria-value-StringWidget\n+    Wait For Then Click Element  css=${keyword_selector}\n+    Input Text  css=${keyword_selector}  ${KEYWORD}\n     Click Element  css=div#content-core\n \n I open the Selection Widget\n-    wait until element is visible  css=div.select2-container-multi.querystring-criteria-value-MultipleSelectionWidget\n-    click element  css=div.select2-container-multi.querystring-criteria-value-MultipleSelectionWidget\n+    Wait For Then Click Element  css=div.select2-container-multi.querystring-criteria-value-MultipleSelectionWidget\n \n I delete one selection\n     #deletes one element\n-    Click Element  css=a.select2-search-choice-close\n+    Wait For Then Click Element  css=a.select2-search-choice-close\n \n I delete my selection\n     #deletes two elements\n-    Click Element  css=a.select2-search-choice-close\n-    Click Element  css=a.select2-search-choice-close\n+    Wait For Then Click Element  css=a.select2-search-choice-close\n+    Sleep  0.1\n+    Wait For Then Click Element  css=a.select2-search-choice-close\n \n I search in ${NAME} subfolder in the related items widget\n     mark results\n-    Click Element  css=ul.select2-choices\n+    Wait For Then Click Element  css=ul.select2-choices\n     Wait Until Page Contains  ${NAME}\n     Click Element  //a[contains(concat(\' \', normalize-space(@class), \' \'), \' pat-relateditems-result-select \')]//span[contains(text(),\'${NAME}\')]\n \n I expect to be in Advanced mode\n     open the select box titled operator\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Navigation Path\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Absolute Path\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Relative Path\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Simple Mode\n-    Click Element  css=div#select2-drop-mask\n-    Wait Until Element Is Not Visible  css=div#select2-drop-mask\n+    ${selector}  Set Variable  .select2-drop-active[style*="display: block;"]\n+    Element Should Contain  jquery=${selector}   Navigation Path\n+    Element Should Contain  jquery=${selector}   Absolute Path\n+    Element Should Contain  jquery=${selector}   Relative Path\n+    Element Should Contain  jquery=${selector}   Simple Mode\n+    ${selector}  Set Variable  div#select2-drop-mask\n+    Wait For Then Click Invisible Element  css=${selector}\n+    Wait Until Element Is Not Visible  css=${selector}\n \n I expect to be in Simple mode\n     open the select box titled operator\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Custom\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Parent (../)\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Current (./)\n-    Element Should Contain  jquery=.select2-drop-active[style*="display: block;"]   Advanced Mode\n-    Click Element  css=div#select2-drop-mask\n-    Wait Until Element Is Not Visible  css=div#select2-drop-mask\n+    ${selector}  Set Variable  .select2-drop-active[style*="display: block;"]\n+    Element Should Contain  jquery=${selector}   Custom\n+    Element Should Contain  jquery=${selector}   Parent (../)\n+    Element Should Contain  jquery=${selector}   Current (./)\n+    Element Should Contain  jquery=${selector}   Advanced Mode\n+    ${selector}  Set Variable  div#select2-drop-mask\n+    Wait For Then Click Invisible Element  css=${selector}\n+    Wait Until Element Is Not Visible  css=${selector}\n \n open the select box titled ${NAME}\n     Click Element  css=body\n-    ${select_criteria_selector}  Set Variable  .querystring-criteria-${NAME} .select2-container a\n-    Wait Until Element Is Visible  css=${select_criteria_selector}\n-    Click Element  css=${select_criteria_selector}\n+    Wait For Then Click Element  css=.querystring-criteria-${NAME} .select2-container\n \n select index type ${INDEX}\n     ${input_selector}  Set Variable  .select2-drop-active[style*="display: block;"] input\n-    Wait Until Element Is Visible  jquery=${input_selector}\n-    Input Text  jquery=${input_selector}   text=${INDEX}\n-    Press Key  jquery=:focus  \\\\13\n+    Wait For Element  css=${input_selector}\n+    Input Text  css=${input_selector}   text=${INDEX}\n+    Press Keys  jquery=:focus  RETURN\n \n we expect ${NUM} hits\n     #This assumes we have the 2 "Test document" and "Test folder" items from the\ndiff --git a/Products/CMFPlone/tests/robot/test_tinymce.robot b/Products/CMFPlone/tests/robot/test_tinymce.robot\nindex 8f56da5823..75eb8d00c7 100644\n--- a/Products/CMFPlone/tests/robot/test_tinymce.robot\n+++ b/Products/CMFPlone/tests/robot/test_tinymce.robot\n@@ -28,9 +28,7 @@ Scenario: A page is opened to edit in TinyMCE\n       and insert link\n       and insert image\n \n-    Set Focus To Element  css=#form-buttons-save\n-    Wait Until Element Is Visible  css=#form-buttons-save\n-    Click Button  Save\n+    Wait For Then Click Element  css=#form-buttons-save\n     Wait until page contains  Changes saved\n \n \ndiff --git a/Products/CMFPlone/tests/testResourceRegistries.py b/Products/CMFPlone/tests/testResourceRegistries.py\nindex d7214266cf..e2113462aa 100644\n--- a/Products/CMFPlone/tests/testResourceRegistries.py\n+++ b/Products/CMFPlone/tests/testResourceRegistries.py\n@@ -76,9 +76,9 @@ def test_scripts_viewlet(self):\n         scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n         scripts.update()\n         results = scripts.render()\n-        self.assertIn("++plone++static/bundle-jquery/jquery.min.js", results)\n+        self.assertIn("++plone++static/bundle-plone/jquery-remote.min.js", results)\n         self.assertIn(\n-            "++plone++static/bundle-bootstrap/js/bootstrap.bundle.min.js", results\n+            "++plone++static/bundle-plone/bootstrap-remote.min.js", results\n         )\n         self.assertIn("++plone++static/bundle-plone/bundle.min.js", results)\n         self.assertIn("http://nohost/plone/++webresource++", results)\n@@ -88,9 +88,9 @@ def test_scripts_viewlet_anonymous(self):\n         scripts = ScriptsView(self.layer["portal"], self.layer["request"], None)\n         scripts.update()\n         results = scripts.render()\n-        self.assertIn("++plone++static/bundle-jquery/jquery.min.js", results)\n+        self.assertIn("++plone++static/bundle-plone/jquery-remote.min.js", results)\n         self.assertIn(\n-            "++plone++static/bundle-bootstrap/js/bootstrap.bundle.min.js", results\n+            "++plone++static/bundle-plone/bootstrap-remote.min.js", results\n         )\n         self.assertIn("++plone++static/bundle-plone/bundle.min.js", results)\n         self.assertIn("http://nohost/plone/++webresource++", results)\ndiff --git a/news/3528.feature b/news/3528.feature\nnew file mode 100644\nindex 0000000000..6b0488bd07\n--- /dev/null\n+++ b/news/3528.feature\n@@ -0,0 +1,2 @@\n+Show link to the Volto-migration (@@migrate_to_volto) in the view @@plone-upgrade when the option is available.\n+[pbauer]\n\\ No newline at end of file\ndiff --git a/news/3539.bugfix b/news/3539.bugfix\nnew file mode 100644\nindex 0000000000..6a03bb0dca\n--- /dev/null\n+++ b/news/3539.bugfix\n@@ -0,0 +1,2 @@\n+Fix tests for updated module federation bundles.\n+[thet]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-06-09T22:32:39+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/40be9133dd26ea159e52320c966616710b61394f

Restore imageScales / image_scales in patterns settings.

Otherwise the new code with picture variants is only used when you have the right mockup branch,
and mockup running, and the resource registries setup to use it,
or the mockup changes should have landed in plone.staticresources already.

Note that the breakage is not too bad though:
if imageScales is not in the patterns settings and you still have TinyMCE from old staticresources,
then TinyMCE will still work.  It will just use an internal copy of the imageScales,
which for example is missing the new greater and huge scales.
With the current commit, we support both old and new TinyMCE, as long as we think this is needed.

Files changed:
M Products/CMFPlone/patterns/settings.py

b'diff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex 7f1fb5979e..a8fe05d5a2 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -71,6 +71,16 @@ def mark_special_links(self):\n             }\n         return result\n \n+    @property\n+    def image_scales(self):\n+        # Keep image_scales at least until https://github.com/plone/mockup/pull/1156\n+        # is merged and plone.staticresources is updated.\n+        factory = getUtility(IVocabularyFactory, "plone.app.vocabularies.ImagesScales")\n+        vocabulary = factory(self.context)\n+        ret = [{"title": translate(it.title), "value": it.value} for it in vocabulary]\n+        ret = sorted(ret, key=lambda it: it["title"])\n+        return json.dumps(ret)\n+\n     @property\n     def picture_variants(self):\n         registry = getUtility(IRegistry)\n@@ -140,6 +150,9 @@ def tinymce(self):\n         configuration = {\n             "base_url": self.context.absolute_url(),\n             "imageTypes": image_types,\n+            # Keep imageScales at least until https://github.com/plone/mockup/pull/1156\n+            # is merged and plone.staticresources is updated.\n+            "imageScales": self.image_scales,\n             "pictureVariants": self.picture_variants,\n             "imageCaptioningEnabled": self.image_captioning,\n             "linkAttribute": "UID",\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-06-09T22:40:24+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/a1c4159b1a2e1695c2005d32fcb39a8becc59809

Merge branch 'master' into mrtango-image-handling-sourcesets-settings

Files changed:
A news/3555.bugfix
M Products/CMFPlone/profiles/default/actions.xml
M Products/CMFPlone/tests/robot/test_querystring.robot

b'diff --git a/Products/CMFPlone/profiles/default/actions.xml b/Products/CMFPlone/profiles/default/actions.xml\nindex 18f0a826bf..0f79034d3f 100644\n--- a/Products/CMFPlone/profiles/default/actions.xml\n+++ b/Products/CMFPlone/profiles/default/actions.xml\n@@ -273,7 +273,7 @@\n     <element value="View"/>\n    </property>\n    <property name="visible">True</property>\n-   <property name="modal" type="text">{"title": "Log in", "width": "26em", "actionOptions": {"redirectOnResponse": true}}</property>\n+   <property name="modal" type="text">{}</property>\n   </object>\n   <object name="join" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Register</property>\n@@ -285,7 +285,7 @@\n     <element value="Add portal member"/>\n    </property>\n    <property name="visible">True</property>\n-   <property name="modal" type="text">{"prependContent": ".portalMessage"}</property>\n+   <property name="modal" type="text">{}</property>\n   </object>\n   <object name="undo" meta_type="CMF Action" i18n:domain="plone">\n    <property name="title" i18n:translate="">Undo</property>\ndiff --git a/Products/CMFPlone/tests/robot/test_querystring.robot b/Products/CMFPlone/tests/robot/test_querystring.robot\nindex 2ab1944c6a..989187671c 100644\n--- a/Products/CMFPlone/tests/robot/test_querystring.robot\n+++ b/Products/CMFPlone/tests/robot/test_querystring.robot\n@@ -213,6 +213,8 @@ the querystring pattern\n     Go to  ${PLONE_URL}/a/++add++Collection\n     Wait until page contains element  css=.pat-querystring\n     Given querystring pattern loaded\n+    # Set a title, otherwise you see \'Please fill out this field\'\n+    Execute Javascript  $(\'#form-widgets-IDublinCore-title\').val(\'A Collection\'); return 0;\n     # for some unknown reason unload protection pops up, but only in robot tests\n     Execute Javascript  $(window).unbind(\'beforeunload\')\n \ndiff --git a/news/3555.bugfix b/news/3555.bugfix\nnew file mode 100644\nindex 0000000000..b5a978dc3a\n--- /dev/null\n+++ b/news/3555.bugfix\n@@ -0,0 +1,2 @@\n+Remove modal from login and join action.\n+[agitator]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-06-10T12:23:40+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/d416cd1fda2f51f298127a3f9f4cb29b742472ca

Fix white space problem in browser_collection_views.txt.

With newer plone.outputfilters the spacing is slightly different.

Files changed:
M Products/CMFPlone/tests/browser_collection_views.txt

b'diff --git a/Products/CMFPlone/tests/browser_collection_views.txt b/Products/CMFPlone/tests/browser_collection_views.txt\nindex 1410ef8387..c2458703d0 100644\n--- a/Products/CMFPlone/tests/browser_collection_views.txt\n+++ b/Products/CMFPlone/tests/browser_collection_views.txt\n@@ -48,6 +48,12 @@ Now let\'s login and visit the collection in the test browser:\n     >>> browser.getControl(\'Log in\').click()\n     >>> browser.open(\'http://nohost/plone/folder/collection\')\n \n+When checking if the collection text is in the output, we are not interested in differences in whitespace.\n+So we use a normalize function:\n+\n+    >>> def normalize(value):\n+    ...     return value.translate(str.maketrans({" ": None, "\\n": None, "\\t": None, "\\r": None}))\n+\n Lets check the listing_view (Standard view):\n \n     >>> browser.getLink(\'Standard view\').click()\n@@ -55,7 +61,7 @@ Lets check the listing_view (Standard view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the summary_view (Summary view):\n@@ -65,7 +71,7 @@ Lets check the summary_view (Summary view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the full_view (All content):\n@@ -75,7 +81,7 @@ Lets check the full_view (All content):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the tabular_view (Tabular view):\n@@ -86,7 +92,7 @@ Lets check the tabular_view (Tabular view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets ensure that the text field is not requested on a folder. We\n@@ -110,5 +116,5 @@ Lets ensure text is shown when Collection is default view of a folder\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-06-13T12:00:30+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/8b566c5acc713f1a5df0457270499b0e75dd3eb3

Merge branch 'master' into mrtango-image-handling-sourcesets-settings

Files changed:
A Products/CMFPlone/browser/static/plone-logo.svg
A news/3558.feature
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/browser/templates/plone-addsite.pt
M Products/CMFPlone/browser/templates/plone-admin-logged-out.pt
M Products/CMFPlone/browser/templates/plone-overview.pt
M Products/CMFPlone/browser/templates/plone-upgrade.pt
M Products/CMFPlone/tests/test_utils.py
M Products/CMFPlone/utils.py

b'diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml\nindex 009ec8f691..419bbca7bc 100644\n--- a/Products/CMFPlone/browser/configure.zcml\n+++ b/Products/CMFPlone/browser/configure.zcml\n@@ -21,8 +21,8 @@\n       title="Allow sendto" />\n \n   <browser:resource\n-      file="static/plone-logo.png"\n-      name="plone-logo.png"\n+      file="static/plone-logo.svg"\n+      name="plone-logo.svg"\n       />\n \n   <browser:page\ndiff --git a/Products/CMFPlone/browser/static/plone-logo.svg b/Products/CMFPlone/browser/static/plone-logo.svg\nnew file mode 100644\nindex 0000000000..32b3772726\n--- /dev/null\n+++ b/Products/CMFPlone/browser/static/plone-logo.svg\n@@ -0,0 +1,24 @@\n+<?xml version="1.0" encoding="UTF-8"?>\n+<!-- Generator: Adobe Illustrator 13.0.1, SVG Export Plug-In . SVG Version: 6.00 Build 14948)  -->\n+<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n+<svg version="1.1" id="plone-logo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="215px" height="56px" viewBox="0 0 158.253 40.686" enable-background="new 0 0 158.253 40.686" xml:space="preserve">\n+<g>\n+\t<path fill="#0095D3" d="M65.327,23.208h-6.589v11.388h-4.393V5.638h10.981c5.653,0,9.271,3.742,9.271,8.785   S70.979,23.208,65.327,23.208z M65.082,9.583h-6.345v9.639h6.345c3.05,0,5.124-1.749,5.124-4.799   C70.206,11.372,68.132,9.583,65.082,9.583z"/>\n+\t<path fill="#0095D3" d="M83.969,34.596c-3.904,0-5.652-2.644-5.652-5.693V5.638h4.148v23.021c0,1.587,0.567,2.399,2.235,2.399h1.83   v3.538H83.969z"/>\n+\t<path fill="#0095D3" d="M104.762,32.399c-1.344,1.384-3.377,2.44-6.184,2.44c-2.805,0-4.799-1.058-6.141-2.44   c-1.951-2.032-2.439-4.637-2.439-8.134c0-3.457,0.488-6.061,2.439-8.094c1.342-1.383,3.336-2.44,6.141-2.44   c2.807,0,4.84,1.059,6.184,2.44c1.951,2.033,2.439,4.637,2.439,8.094C107.203,27.763,106.713,30.366,104.762,32.399z    M101.629,18.613c-0.773-0.773-1.83-1.181-3.051-1.181c-1.219,0-2.236,0.406-3.01,1.181c-1.26,1.261-1.422,3.416-1.422,5.652   s0.162,4.393,1.422,5.653c0.773,0.771,1.791,1.22,3.01,1.22c1.221,0,2.277-0.447,3.051-1.22c1.262-1.262,1.424-3.417,1.424-5.653   S102.891,19.873,101.629,18.613z"/>\n+\t<path fill="#0095D3" d="M123.643,34.596V22.029c0-3.214-1.83-4.597-4.147-4.597s-4.271,1.423-4.271,4.597v12.566h-4.147v-20.62   h4.065v2.074c1.425-1.546,3.416-2.318,5.49-2.318c2.115,0,3.865,0.691,5.084,1.871c1.586,1.545,2.074,3.497,2.074,5.815v13.178   L123.643,34.596L123.643,34.596z"/>\n+\t<path fill="#0095D3" d="M135.772,25.486c0,3.537,1.871,5.774,5.246,5.774c2.317,0,3.539-0.649,5.004-2.115l2.643,2.481   c-2.115,2.114-4.107,3.213-7.727,3.213c-5.166,0-9.273-2.725-9.273-10.574c0-6.671,3.457-10.534,8.744-10.534   c5.531,0,8.744,4.067,8.744,9.925v1.83H135.772z M144.475,19.791c-0.65-1.545-2.113-2.604-4.066-2.604   c-1.951,0-3.457,1.059-4.107,2.604c-0.406,0.936-0.488,1.546-0.529,2.807h9.273C145.003,21.337,144.883,20.726,144.475,19.791z"/>\n+\t<circle fill="#0095D3" cx="17.815" cy="11.516" r="4.402"/>\n+\t<path fill="#0095D3" d="M31.167,20.311c0,2.433-1.969,4.401-4.403,4.401c-2.427,0-4.401-1.97-4.401-4.401   c0-2.433,1.975-4.401,4.401-4.401C29.2,15.909,31.167,17.879,31.167,20.311z"/>\n+\t<circle fill="#0095D3" cx="17.801" cy="29.131" r="4.402"/>\n+\t<g>\n+\t\t<path fill="#0095D3" d="M20.441-0.045C9.207-0.044,0.1,9.063,0.099,20.298C0.1,31.532,9.207,40.639,20.441,40.641    c11.235-0.002,20.341-9.107,20.343-20.343C40.783,9.063,31.677-0.044,20.441-0.045z M31.891,31.747    c-2.937,2.934-6.972,4.742-11.45,4.743c-4.478-0.001-8.513-1.811-11.45-4.743C6.058,28.81,4.25,24.775,4.249,20.298    c0.001-4.478,1.809-8.513,4.743-11.45c2.937-2.934,6.972-4.742,11.45-4.743c4.478,0.001,8.513,1.81,11.45,4.743    c2.934,2.938,4.742,6.973,4.743,11.45C36.633,24.775,34.825,28.81,31.891,31.747z"/>\n+\t</g>\n+\t<g>\n+\t\t<path fill="#0095D3" d="M153.985,9.95c-1.195,0-2.164,0.971-2.164,2.168c0.002,1.197,0.969,2.168,2.164,2.168    c1.199,0,2.172-0.971,2.172-2.168S155.184,9.95,153.985,9.95z M153.985,13.968c-1.021-0.002-1.846-0.827-1.846-1.85    c0.002-1.021,0.825-1.849,1.846-1.851c1.023,0.002,1.852,0.828,1.854,1.851C155.836,13.141,155.008,13.966,153.985,13.968z"/>\n+\t</g>\n+\t<g>\n+\t\t<path fill="#0095D3" d="M154.507,13.409l-0.54-1.08h-0.486v1.08h-0.389v-2.564h0.994c0.484,0,0.796,0.313,0.796,0.75    c0,0.367-0.224,0.602-0.513,0.68l0.592,1.136L154.507,13.409L154.507,13.409z M154.056,11.195h-0.575v0.803h0.575    c0.261,0,0.437-0.147,0.437-0.399S154.317,11.195,154.056,11.195z"/>\n+\t</g>\n+</g>\n+</svg>\ndiff --git a/Products/CMFPlone/browser/templates/plone-addsite.pt b/Products/CMFPlone/browser/templates/plone-addsite.pt\nindex 7dff6a74c5..95641ab424 100644\n--- a/Products/CMFPlone/browser/templates/plone-addsite.pt\n+++ b/Products/CMFPlone/browser/templates/plone-addsite.pt\n@@ -24,9 +24,9 @@\n \n   <div class="container admin mt-5 mb-5 p-4 ">\n     <header class="row">\n-      <p><img src="/++resource++plone-logo.png"\n+      <p><img src="/++resource++plone-logo.svg"\n                width="215" height="56"\n-               tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.png"\n+               tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.svg"\n                alt="Plone logo"\n                i18n:attributes="alt" /></p>\n     </header>\ndiff --git a/Products/CMFPlone/browser/templates/plone-admin-logged-out.pt b/Products/CMFPlone/browser/templates/plone-admin-logged-out.pt\nindex b12de5f1e0..da0752d9ba 100644\n--- a/Products/CMFPlone/browser/templates/plone-admin-logged-out.pt\n+++ b/Products/CMFPlone/browser/templates/plone-admin-logged-out.pt\n@@ -23,9 +23,9 @@\n \n   <div class="container admin mt-5 mb-5 p-4">\n     <div class="row">\n-      <p><img src="/++resource++plone-logo.png"\n+      <p><img src="/++resource++plone-logo.svg"\n               width="215" height="56"\n-              tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.png"\n+              tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.svg"\n               alt="Plone logo"\n               i18n:attributes="alt" /></p>\n       <h1 i18n:translate="">You are now logged out.</h1>\ndiff --git a/Products/CMFPlone/browser/templates/plone-overview.pt b/Products/CMFPlone/browser/templates/plone-overview.pt\nindex b1a159b988..2e1b2e50d3 100644\n--- a/Products/CMFPlone/browser/templates/plone-overview.pt\n+++ b/Products/CMFPlone/browser/templates/plone-overview.pt\n@@ -24,11 +24,11 @@\n                   many python:len(sites) > 1;">\n   <div class="container admin mt-5 mb-5 p-4">\n     <header class="row">\n-        <p><img src="/++resource++plone-logo.png"\n-                 width="215" height="56"\n-                 tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.png"\n-                 alt="Plone logo"\n-                 i18n:attributes="alt" /></p>\n+        <p><img src="/++resource++plone-logo.svg"\n+                width="215" height="56"\n+                tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.svg"\n+                alt="Plone logo"\n+                i18n:attributes="alt" /></p>\n         <h1 i18n:translate="">Plone is up and running.</h1>\n         <p class="lead">\n             <span i18n:translate="label_plone_com_description"> For an introduction to Plone, success stories, demos, providers, visit</span>\ndiff --git a/Products/CMFPlone/browser/templates/plone-upgrade.pt b/Products/CMFPlone/browser/templates/plone-upgrade.pt\nindex 21b66bbe9e..3d899aa99c 100644\n--- a/Products/CMFPlone/browser/templates/plone-upgrade.pt\n+++ b/Products/CMFPlone/browser/templates/plone-upgrade.pt\n@@ -25,9 +25,9 @@\n \n     <div class="container admin mt-5 mb-5 p-4">\n         <header class="row">\n-            <p><img src="/++resource++plone-logo.png"\n+            <p><img src="/++resource++plone-logo.svg"\n                     width="215" height="56"\n-                    tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.png"\n+                    tal:attributes="src string:${context/absolute_url}/++resource++plone-logo.svg"\n                     alt="Plone logo"\n                     i18n:attributes="alt" /></p>\n             <h1>\ndiff --git a/Products/CMFPlone/tests/test_utils.py b/Products/CMFPlone/tests/test_utils.py\nindex 17e66a96fc..eb30c720bf 100644\n--- a/Products/CMFPlone/tests/test_utils.py\n+++ b/Products/CMFPlone/tests/test_utils.py\n@@ -43,13 +43,22 @@ def test_getSiteLogo_with_setting(self):\n         registry = getUtility(IRegistry)\n         settings = registry.forInterface(ISiteSchema, prefix=\'plone\')\n         settings.site_logo = SITE_LOGO_BASE64\n+        logo_url, logo_type = getSiteLogo(include_type=True)\n \n         self.assertTrue(\n             \'http://nohost/plone/@@site-logo/pixel.png\'\n-            in getSiteLogo())\n+            in logo_url)\n+\n+        self.assertEqual(\n+            "image/png", logo_type\n+        )\n \n     def test_getSiteLogo_with_no_setting(self):\n         from Products.CMFPlone.utils import getSiteLogo\n+        logo_url, logo_type = getSiteLogo(include_type=True)\n         self.assertTrue(\n-            \'http://nohost/plone/logo.png\'\n-            in getSiteLogo())\n+            \'http://nohost/plone/++resource++plone-logo.svg\'\n+            in logo_url)\n+        self.assertEqual(\n+            "image/svg+xml", logo_type\n+        )\ndiff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py\nindex e94f7446ea..c92cae5786 100644\n--- a/Products/CMFPlone/utils.py\n+++ b/Products/CMFPlone/utils.py\n@@ -596,9 +596,11 @@ def getHighPixelDensityScales():\n     return func()\n \n \n-def getSiteLogo(site=None):\n+def getSiteLogo(site=None, include_type=False):\n     from plone.base.interfaces import ISiteSchema\n     from plone.formwidget.namedfile.converter import b64decode_file\n+    import mimetypes\n+\n     if site is None:\n         site = getSite()\n     registry = getUtility(IRegistry)\n@@ -607,10 +609,17 @@ def getSiteLogo(site=None):\n \n     if getattr(settings, \'site_logo\', False):\n         filename, data = b64decode_file(settings.site_logo)\n-        return \'{}/@@site-logo/{}\'.format(\n+        site_logo_url = \'{}/@@site-logo/{}\'.format(\n             site_url, filename)\n-    return \'%s/logo.png\' % site_url\n+        site_logo_type = mimetypes.guess_type(filename)[0]\n+    else:\n+        site_logo_url = \'%s/++resource++plone-logo.svg\' % site_url\n+        site_logo_type = "image/svg+xml"\n+\n+    if not include_type:\n+        return site_logo_url\n \n+    return (site_logo_url, site_logo_type)\n \n \n def _safe_format(inst, method):\ndiff --git a/news/3558.feature b/news/3558.feature\nnew file mode 100644\nindex 0000000000..e7bec0e2a1\n--- /dev/null\n+++ b/news/3558.feature\n@@ -0,0 +1,2 @@\n+SVG image as default Plone logo.\n+[petschki]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-06-16T18:54:19+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/c7433f66ca4f1902c64b19668eba1b4c99734cb5

Merge pull request #3477 from plone/mrtango-image-handling-sourcesets-settings

Add image srcset's configuration to TinyMCE pattern settings

Files changed:
A news/3477.feature
M Products/CMFPlone/patterns/settings.py
M Products/CMFPlone/tests/browser_collection_views.txt

b'diff --git a/Products/CMFPlone/patterns/settings.py b/Products/CMFPlone/patterns/settings.py\nindex 2d63b3ef69..a8fe05d5a2 100644\n--- a/Products/CMFPlone/patterns/settings.py\n+++ b/Products/CMFPlone/patterns/settings.py\n@@ -7,6 +7,7 @@\n from plone.registry.interfaces import IRegistry\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.interfaces._content import IFolderish\n+from plone.base.interfaces import IImagingSchema\n from plone.base.interfaces import ILinkSchema\n from plone.base.interfaces import IPatternsSettings\n from plone.base.interfaces import IPloneSiteRoot\n@@ -72,12 +73,32 @@ def mark_special_links(self):\n \n     @property\n     def image_scales(self):\n+        # Keep image_scales at least until https://github.com/plone/mockup/pull/1156\n+        # is merged and plone.staticresources is updated.\n         factory = getUtility(IVocabularyFactory, "plone.app.vocabularies.ImagesScales")\n         vocabulary = factory(self.context)\n         ret = [{"title": translate(it.title), "value": it.value} for it in vocabulary]\n         ret = sorted(ret, key=lambda it: it["title"])\n         return json.dumps(ret)\n \n+    @property\n+    def picture_variants(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n+        editor_picture_variants = {}\n+        for k, picture_variant in settings.picture_variants.items():\n+            hide_in_editor = picture_variant.get("hideInEditor")\n+            if hide_in_editor:\n+                continue\n+            editor_picture_variants[k] = picture_variant\n+        return editor_picture_variants\n+\n+    @property\n+    def image_captioning(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(IImagingSchema, prefix="plone", check=False)\n+        return settings.image_captioning\n+\n     def tinymce(self):\n         """\n         data-pat-tinymce : JSON.stringify({\n@@ -129,7 +150,11 @@ def tinymce(self):\n         configuration = {\n             "base_url": self.context.absolute_url(),\n             "imageTypes": image_types,\n+            # Keep imageScales at least until https://github.com/plone/mockup/pull/1156\n+            # is merged and plone.staticresources is updated.\n             "imageScales": self.image_scales,\n+            "pictureVariants": self.picture_variants,\n+            "imageCaptioningEnabled": self.image_captioning,\n             "linkAttribute": "UID",\n             # This is for loading the languages on tinymce\n             "loadingBaseUrl": "{}/++plone++static/components/tinymce-builded/"\ndiff --git a/Products/CMFPlone/tests/browser_collection_views.txt b/Products/CMFPlone/tests/browser_collection_views.txt\nindex 1410ef8387..c2458703d0 100644\n--- a/Products/CMFPlone/tests/browser_collection_views.txt\n+++ b/Products/CMFPlone/tests/browser_collection_views.txt\n@@ -48,6 +48,12 @@ Now let\'s login and visit the collection in the test browser:\n     >>> browser.getControl(\'Log in\').click()\n     >>> browser.open(\'http://nohost/plone/folder/collection\')\n \n+When checking if the collection text is in the output, we are not interested in differences in whitespace.\n+So we use a normalize function:\n+\n+    >>> def normalize(value):\n+    ...     return value.translate(str.maketrans({" ": None, "\\n": None, "\\t": None, "\\r": None}))\n+\n Lets check the listing_view (Standard view):\n \n     >>> browser.getLink(\'Standard view\').click()\n@@ -55,7 +61,7 @@ Lets check the listing_view (Standard view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the summary_view (Summary view):\n@@ -65,7 +71,7 @@ Lets check the summary_view (Summary view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the full_view (All content):\n@@ -75,7 +81,7 @@ Lets check the full_view (All content):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets check the tabular_view (Tabular view):\n@@ -86,7 +92,7 @@ Lets check the tabular_view (Tabular view):\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\n \n Lets ensure that the text field is not requested on a folder. We\n@@ -110,5 +116,5 @@ Lets ensure text is shown when Collection is default view of a folder\n     True\n     >>> collection_description in browser.contents\n     True\n-    >>> collection_text in browser.contents\n+    >>> normalize(collection_text) in normalize(browser.contents)\n     True\ndiff --git a/news/3477.feature b/news/3477.feature\nnew file mode 100644\nindex 0000000000..78e99ea9a1\n--- /dev/null\n+++ b/news/3477.feature\n@@ -0,0 +1 @@\n+Add image srcset\'s configuration to TinyMCE pattern settings [MrTango]\n\\ No newline at end of file\n'

