Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-02-13T15:36:27+10:30
Author: Daniel Marks (displacedaussie) <dmarks@pretaweb.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/8c5b6a97c4172a924b4eef6e62a670be6d5019a0

Load patterns when using AJAX/iframe, improve ajax template

Files changed:
M Products/CMFPlone/browser/templates/ajax_main_template.pt
M Products/CMFPlone/static/plone.js

diff --git a/Products/CMFPlone/browser/templates/ajax_main_template.pt b/Products/CMFPlone/browser/templates/ajax_main_template.pt
index 855c0dc..41f51e1 100644
--- a/Products/CMFPlone/browser/templates/ajax_main_template.pt
+++ b/Products/CMFPlone/browser/templates/ajax_main_template.pt
@@ -2,6 +2,9 @@
 <tal:doctype tal:replace="structure string:&lt;!DOCTYPE html&gt;" />
 
 <html xmlns="http://www.w3.org/1999/xhtml"
+      xmlns:tal="http://xml.zope.org/namespaces/tal"
+      xmlns:metal="http://xml.zope.org/namespaces/metal"
+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
     tal:define="portal_state context/@@plone_portal_state;
         context_state context/@@plone_context_state;
         plone_view context/@@plone;
@@ -46,10 +49,14 @@
                   sr python:plone_layout.have_portlets('plone.rightcolumn', view);
                   body_class python:plone_layout.bodyClass(template, view);"
     tal:attributes="class string: ${body_class} ajax_load;
-                    dir python:isRTL and 'rtl' or 'ltr'">
+                    dir python:isRTL and 'rtl' or 'ltr';
+                    python:plone_view.patterns_settings()"
+    id="visual-portal-wrapper">
+
+    <header id="portal-top" i18n:domain="plone"/>
 
     <aside id="global_statusmessage">
-      <tal:message tal:content="provider:plone.globalstatusmessage"/>
+      <tal:message tal:content="structure provider:plone.globalstatusmessage"/>
       <div metal:define-slot="global_statusmessage">
       </div>
     </aside>
diff --git a/Products/CMFPlone/static/plone.js b/Products/CMFPlone/static/plone.js
index fdede77..fe40cf8 100644
--- a/Products/CMFPlone/static/plone.js
+++ b/Products/CMFPlone/static/plone.js
@@ -45,7 +45,8 @@ require([
   'use strict';
 
   // initialize only if we are in top frame
-  if (window.parent === window) {
+  if ((window.parent === window) ||
+      (window.frameElement.nodeName === 'IFRAME')) {
     $(document).ready(function() {
       $('body').addClass('pat-plone');
       if (!registry.initialized) {


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-02-13T15:48:05+10:30
Author: Daniel Marks (displacedaussie) <dmarks@pretaweb.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/1315e4399a077177c53bfc36cb380360c70da5be

Include changelog entry

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 7729819..0c59567 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -153,6 +153,7 @@ New features:
 
 Bug fixes:
 
+- Include JS Patterns when loading a page via ajax or an iframe [displacedaussie]
 
 - Restore ability to include head when loading via ajax [displacedaussie]
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-02-14T19:58:40+01:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/919e894a791951e57ee4f0f3345791a292112c11

Merge pull request #1948 from pretagov/improve_ajax_template

Load patterns when using AJAX/iframe, improve AJAX template

Files changed:
M CHANGES.rst
M Products/CMFPlone/browser/templates/ajax_main_template.pt
M Products/CMFPlone/static/plone.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 7729819..0c59567 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -153,6 +153,7 @@ New features:
 
 Bug fixes:
 
+- Include JS Patterns when loading a page via ajax or an iframe [displacedaussie]
 
 - Restore ability to include head when loading via ajax [displacedaussie]
 
diff --git a/Products/CMFPlone/browser/templates/ajax_main_template.pt b/Products/CMFPlone/browser/templates/ajax_main_template.pt
index 855c0dc..41f51e1 100644
--- a/Products/CMFPlone/browser/templates/ajax_main_template.pt
+++ b/Products/CMFPlone/browser/templates/ajax_main_template.pt
@@ -2,6 +2,9 @@
 <tal:doctype tal:replace="structure string:&lt;!DOCTYPE html&gt;" />
 
 <html xmlns="http://www.w3.org/1999/xhtml"
+      xmlns:tal="http://xml.zope.org/namespaces/tal"
+      xmlns:metal="http://xml.zope.org/namespaces/metal"
+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
     tal:define="portal_state context/@@plone_portal_state;
         context_state context/@@plone_context_state;
         plone_view context/@@plone;
@@ -46,10 +49,14 @@
                   sr python:plone_layout.have_portlets('plone.rightcolumn', view);
                   body_class python:plone_layout.bodyClass(template, view);"
     tal:attributes="class string: ${body_class} ajax_load;
-                    dir python:isRTL and 'rtl' or 'ltr'">
+                    dir python:isRTL and 'rtl' or 'ltr';
+                    python:plone_view.patterns_settings()"
+    id="visual-portal-wrapper">
+
+    <header id="portal-top" i18n:domain="plone"/>
 
     <aside id="global_statusmessage">
-      <tal:message tal:content="provider:plone.globalstatusmessage"/>
+      <tal:message tal:content="structure provider:plone.globalstatusmessage"/>
       <div metal:define-slot="global_statusmessage">
       </div>
     </aside>
diff --git a/Products/CMFPlone/static/plone.js b/Products/CMFPlone/static/plone.js
index fdede77..fe40cf8 100644
--- a/Products/CMFPlone/static/plone.js
+++ b/Products/CMFPlone/static/plone.js
@@ -45,7 +45,8 @@ require([
   'use strict';
 
   // initialize only if we are in top frame
-  if (window.parent === window) {
+  if ((window.parent === window) ||
+      (window.frameElement.nodeName === 'IFRAME')) {
     $(document).ready(function() {
       $('body').addClass('pat-plone');
       if (!registry.initialized) {


