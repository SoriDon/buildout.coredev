Repository: plone.app.contentlisting


Branch: refs/heads/master
Date: 2022-09-09T14:21:28+02:00
Author: Gauthier Bastien (gbastien) <gauthier.bastien@imio.be>
Commit: https://github.com/plone/plone.app.contentlisting/commit/01bc62b49af8452b84774e028eaca0393c1f1ec3

In RealContentListingObject.__getattr__ check attribute existence without acquisition but return the attribute with acquisition in case it is a method that needs acquisition.
See #47

Files changed:
A news/47.bugfix
M plone/app/contentlisting/realobject.py
M plone/app/contentlisting/tests/test_integration_unit.py

b'diff --git a/news/47.bugfix b/news/47.bugfix\nnew file mode 100644\nindex 0000000..b91e6c8\n--- /dev/null\n+++ b/news/47.bugfix\n@@ -0,0 +1 @@\n+In RealContentListingObject.__getattr__ check attribute existence without acquisition but return the attribute with acquisition in case it is a method that needs acquisition. [gbastien]\ndiff --git a/plone/app/contentlisting/realobject.py b/plone/app/contentlisting/realobject.py\nindex 0579a5b..980a142 100644\n--- a/plone/app/contentlisting/realobject.py\n+++ b/plone/app/contentlisting/realobject.py\n@@ -2,6 +2,7 @@\n from Acquisition import aq_get\n from plone.app.contentlisting.contentlisting import BaseContentListingObject\n from plone.app.contentlisting.interfaces import IContentListingObject\n+from plone.base.utils import base_hasattr\n from plone.base.utils import human_readable_size\n from plone.rfc822.interfaces import IPrimaryFieldInfo\n from plone.uuid.interfaces import IUUID\n@@ -36,9 +37,11 @@ def __getattr__(self, name):\n         if name.startswith("_"):\n             raise AttributeError(name)\n         obj = self.getObject()\n-        obj_name = getattr(aq_base(obj), name, MARKER)\n-        if obj_name is not MARKER:\n-            return obj_name\n+        # we check that obj without acquisition has the attribute\n+        # but we return it with acquisition in case it is a method\n+        # that itself uses the acquisition\n+        if base_hasattr(obj, name):\n+            return getattr(obj, name)\n         raise AttributeError(name)\n \n     def getObject(self):\ndiff --git a/plone/app/contentlisting/tests/test_integration_unit.py b/plone/app/contentlisting/tests/test_integration_unit.py\nindex 0a72fdb..a340f18 100644\n--- a/plone/app/contentlisting/tests/test_integration_unit.py\n+++ b/plone/app/contentlisting/tests/test_integration_unit.py\n@@ -171,6 +171,10 @@ def test_containment(self):\n         )\n \n \n+def patched_Title(self):\n+    return "{0} - {1}".format(self.aq_parent.Title(), self.title)\n+\n+\n class TestIndividualRealContentItems(unittest.TestCase):\n     layer = CONTENTLISTING_FUNCTIONAL_TESTING\n \n@@ -262,6 +266,14 @@ def test_item_get_none(self):\n                 "result in an AttributeError."\n             )\n \n+    def test_item_getattr_acquisition(self):\n+        self.portal.get("test-folder").setTitle("Test folder")\n+        self.item._realobject.__class__.Title = patched_Title\n+        # works on the object\n+        self.assertEqual(self.item._realobject.Title(), "Test folder - My Page")\n+        # works on the contentlisting object\n+        self.assertEqual(self.item.Title(), "Test folder - My Page")\n+\n \n class TestFolderContents(unittest.TestCase):\n     """Testing that the folder contents browserview works and behaves\n'

Repository: plone.app.contentlisting


Branch: refs/heads/master
Date: 2022-10-15T11:25:58+02:00
Author: Gauthier Bastien (gbastien) <gauthier.bastien@imio.be>
Commit: https://github.com/plone/plone.app.contentlisting/commit/ba2e79c1f896a80daad102ba534787fbc15fc0f1

Adapted test_item_getattr_acquisition to use absolute_url and remove Title monkeypatch

Files changed:
M plone/app/contentlisting/tests/test_integration_unit.py

b'diff --git a/plone/app/contentlisting/tests/test_integration_unit.py b/plone/app/contentlisting/tests/test_integration_unit.py\nindex a340f18..97abc90 100644\n--- a/plone/app/contentlisting/tests/test_integration_unit.py\n+++ b/plone/app/contentlisting/tests/test_integration_unit.py\n@@ -171,10 +171,6 @@ def test_containment(self):\n         )\n \n \n-def patched_Title(self):\n-    return "{0} - {1}".format(self.aq_parent.Title(), self.title)\n-\n-\n class TestIndividualRealContentItems(unittest.TestCase):\n     layer = CONTENTLISTING_FUNCTIONAL_TESTING\n \n@@ -267,12 +263,15 @@ def test_item_get_none(self):\n             )\n \n     def test_item_getattr_acquisition(self):\n-        self.portal.get("test-folder").setTitle("Test folder")\n-        self.item._realobject.__class__.Title = patched_Title\n-        # works on the object\n-        self.assertEqual(self.item._realobject.Title(), "Test folder - My Page")\n-        # works on the contentlisting object\n-        self.assertEqual(self.item.Title(), "Test folder - My Page")\n+        # absolute_url needs acquisition to work\n+        # on the object\n+        self.assertEqual(\n+            self.item._realobject.absolute_url(),\n+            "http://nohost/plone/test-folder/mypage")\n+        # on the contentlisting object\n+        self.assertEqual(\n+            self.item.absolute_url(),\n+            "http://nohost/plone/test-folder/mypage")\n \n \n class TestFolderContents(unittest.TestCase):\n'

Repository: plone.app.contentlisting


Branch: refs/heads/master
Date: 2022-11-23T11:28:01+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contentlisting/commit/2c5df45a0034eef9ee59aba48697f5655aea5766

Merge branch 'master' into 47_realcontent_getattr_with_acquisition

Files changed:
M setup.py

b'diff --git a/setup.py b/setup.py\nindex c43c41c..b7b57f9 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -24,10 +24,10 @@ def read(*rnames):\n         "Framework :: Plone :: 6.0",\n         "License :: OSI Approved :: GNU General Public License v2 (GPLv2)",\n         "Programming Language :: Python",\n-        "Programming Language :: Python :: 3.7",\n         "Programming Language :: Python :: 3.8",\n         "Programming Language :: Python :: 3.9",\n         "Programming Language :: Python :: 3.10",\n+        "Programming Language :: Python :: 3.11",\n     ],\n     keywords="content list Plone",\n     author="Plone Foundation",\n'

Repository: plone.app.contentlisting


Branch: refs/heads/master
Date: 2022-12-02T16:38:15+01:00
Author: Gauthier Bastien (gbastien) <gauthier.bastien@imio.be>
Commit: https://github.com/plone/plone.app.contentlisting/commit/633871a6c973536d14035166cd7126d6f73c1dac

Removed TestIndividualRealContentItems.test_special_getattr_from_object as default behavior changed

Files changed:
M plone/app/contentlisting/tests/test_integration_unit.py

b'diff --git a/plone/app/contentlisting/tests/test_integration_unit.py b/plone/app/contentlisting/tests/test_integration_unit.py\nindex 97abc90..f558e88 100644\n--- a/plone/app/contentlisting/tests/test_integration_unit.py\n+++ b/plone/app/contentlisting/tests/test_integration_unit.py\n@@ -204,14 +204,16 @@ def test_special_getattr_with_underscore(self):\n         # AttributeError\n         self.assertRaises(AttributeError, self.item.__getattr__, "foo")\n \n-    def test_special_getattr_from_object(self):\n-        # Asking for an attribute not in the contentlistingobject, should\n-        # defer lookup to the brain\n-        self.assertEqual(self.item.absolute_url(), "")\n+    def test_item_getattr_acquisition(self):\n+        # absolute_url needs acquisition to work\n+        # on the object\n         self.assertEqual(\n-            repr(self.item.getDataOrigin()),\n-            "<Document at /plone/test-folder/mypage>",\n-        )\n+            self.item._realobject.absolute_url(),\n+            "http://nohost/plone/test-folder/mypage")\n+        # on the contentlisting object\n+        self.assertEqual(\n+            self.item.absolute_url(),\n+            "http://nohost/plone/test-folder/mypage")\n \n     def test_item_Title(self):\n         self.assertEqual(self.item.Title(), "My Page")\n@@ -262,17 +264,6 @@ def test_item_get_none(self):\n                 "result in an AttributeError."\n             )\n \n-    def test_item_getattr_acquisition(self):\n-        # absolute_url needs acquisition to work\n-        # on the object\n-        self.assertEqual(\n-            self.item._realobject.absolute_url(),\n-            "http://nohost/plone/test-folder/mypage")\n-        # on the contentlisting object\n-        self.assertEqual(\n-            self.item.absolute_url(),\n-            "http://nohost/plone/test-folder/mypage")\n-\n \n class TestFolderContents(unittest.TestCase):\n     """Testing that the folder contents browserview works and behaves\n'

Repository: plone.app.contentlisting


Branch: refs/heads/master
Date: 2022-12-04T11:39:36+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contentlisting/commit/e80c59890a0c46054381f32ae38507ac92ebc1d0

Merge pull request #48 from plone/47_realcontent_getattr_with_acquisition

In RealContentListingObject.__getattr__ check attribute existence without acquisition but return the attribute with acquisition in case it is a method that needs acquisition.

Files changed:
A news/47.bugfix
M plone/app/contentlisting/realobject.py
M plone/app/contentlisting/tests/test_integration_unit.py

b'diff --git a/news/47.bugfix b/news/47.bugfix\nnew file mode 100644\nindex 0000000..b91e6c8\n--- /dev/null\n+++ b/news/47.bugfix\n@@ -0,0 +1 @@\n+In RealContentListingObject.__getattr__ check attribute existence without acquisition but return the attribute with acquisition in case it is a method that needs acquisition. [gbastien]\ndiff --git a/plone/app/contentlisting/realobject.py b/plone/app/contentlisting/realobject.py\nindex 0579a5b..980a142 100644\n--- a/plone/app/contentlisting/realobject.py\n+++ b/plone/app/contentlisting/realobject.py\n@@ -2,6 +2,7 @@\n from Acquisition import aq_get\n from plone.app.contentlisting.contentlisting import BaseContentListingObject\n from plone.app.contentlisting.interfaces import IContentListingObject\n+from plone.base.utils import base_hasattr\n from plone.base.utils import human_readable_size\n from plone.rfc822.interfaces import IPrimaryFieldInfo\n from plone.uuid.interfaces import IUUID\n@@ -36,9 +37,11 @@ def __getattr__(self, name):\n         if name.startswith("_"):\n             raise AttributeError(name)\n         obj = self.getObject()\n-        obj_name = getattr(aq_base(obj), name, MARKER)\n-        if obj_name is not MARKER:\n-            return obj_name\n+        # we check that obj without acquisition has the attribute\n+        # but we return it with acquisition in case it is a method\n+        # that itself uses the acquisition\n+        if base_hasattr(obj, name):\n+            return getattr(obj, name)\n         raise AttributeError(name)\n \n     def getObject(self):\ndiff --git a/plone/app/contentlisting/tests/test_integration_unit.py b/plone/app/contentlisting/tests/test_integration_unit.py\nindex 0a72fdb..f558e88 100644\n--- a/plone/app/contentlisting/tests/test_integration_unit.py\n+++ b/plone/app/contentlisting/tests/test_integration_unit.py\n@@ -204,14 +204,16 @@ def test_special_getattr_with_underscore(self):\n         # AttributeError\n         self.assertRaises(AttributeError, self.item.__getattr__, "foo")\n \n-    def test_special_getattr_from_object(self):\n-        # Asking for an attribute not in the contentlistingobject, should\n-        # defer lookup to the brain\n-        self.assertEqual(self.item.absolute_url(), "")\n+    def test_item_getattr_acquisition(self):\n+        # absolute_url needs acquisition to work\n+        # on the object\n         self.assertEqual(\n-            repr(self.item.getDataOrigin()),\n-            "<Document at /plone/test-folder/mypage>",\n-        )\n+            self.item._realobject.absolute_url(),\n+            "http://nohost/plone/test-folder/mypage")\n+        # on the contentlisting object\n+        self.assertEqual(\n+            self.item.absolute_url(),\n+            "http://nohost/plone/test-folder/mypage")\n \n     def test_item_Title(self):\n         self.assertEqual(self.item.Title(), "My Page")\n'

