Repository: plone.volto


Branch: refs/heads/main
Date: 2023-02-27T21:36:22+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/7106428f248007f4c7e4244ef3015c50db38e681

adapt relative path of query when migration default-page collection to listing block

Files changed:
M src/plone/volto/browser/migrate_to_volto.py

b'diff --git a/src/plone/volto/browser/migrate_to_volto.py b/src/plone/volto/browser/migrate_to_volto.py\nindex 34eb439..c0f2dca 100644\n--- a/src/plone/volto/browser/migrate_to_volto.py\n+++ b/src/plone/volto/browser/migrate_to_volto.py\n@@ -149,7 +149,7 @@ def do_migrate_default_page(self, obj):\n             blocks_layout = default_page_obj.blocks_layout or blocks_layout\n \n             if default_page_type == "Collection":\n-                uuid, block = generate_listing_block_from_collection(default_page_obj)\n+                uuid, block = generate_listing_block_from_collection(default_page_obj, move_relative_path=True)\n                 blocks[uuid] = block\n                 blocks_layout["items"].append(uuid)\n \n@@ -237,10 +237,17 @@ def generate_listing_block(obj):\n     return uuid, block\n \n \n-def generate_listing_block_from_collection(obj):\n+def generate_listing_block_from_collection(obj, move_relative_path=False):\n     """Transform collection query and setting to listing block."""\n     collection = ICollection(obj)\n     uuid = str(uuid4())\n+    if move_relative_path and collection.query:\n+        # when we migrate collections that were used as default-pages\n+        # with a relative path to the parent ("..::") that path now needs\n+        # to point to itself.\n+        for qu in collection.query:\n+            if "path" in qu["i"] and "relativePath" in qu["o"] and qu["v"].startswith(".."):\n+                qu["v"] = qu["v"].replace("..", ".", 1)\n     qs = {"query": collection.query}\n     if collection.item_count:\n         qs["b_size"] = collection.item_count\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2023-02-27T21:36:22+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/fc47a4f2e90907937b4a0c6ad20676f542a15572

fix migrating sort_order of collections to listing-block (the block needs literal and boolean)

Files changed:
M src/plone/volto/browser/migrate_to_volto.py
M src/plone/volto/tests/test_migrate_to_volto.py

b'diff --git a/src/plone/volto/browser/migrate_to_volto.py b/src/plone/volto/browser/migrate_to_volto.py\nindex c0f2dca..1cf490b 100644\n--- a/src/plone/volto/browser/migrate_to_volto.py\n+++ b/src/plone/volto/browser/migrate_to_volto.py\n@@ -255,6 +255,7 @@ def generate_listing_block_from_collection(obj, move_relative_path=False):\n         qs["limit"] = collection.limit\n     if collection.sort_on:\n         qs["sort_on"] = collection.sort_on\n+    qs["sort_order"] = "descending" if collection.sort_reversed else "ascending"\n     qs["sort_order_boolean"] = True if collection.sort_reversed else False\n \n     # Set layout of collection to listing block\ndiff --git a/src/plone/volto/tests/test_migrate_to_volto.py b/src/plone/volto/tests/test_migrate_to_volto.py\nindex 56d3361..2709205 100644\n--- a/src/plone/volto/tests/test_migrate_to_volto.py\n+++ b/src/plone/volto/tests/test_migrate_to_volto.py\n@@ -159,6 +159,7 @@ def test_collections_are_migrated(self):\n                 ],\n                 "sort_on": "effective",\n                 "sort_order_boolean": False,\n+                "sort_order": "ascending"\n             },\n         )\n \n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2023-02-27T21:36:22+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/c99b9f51577567eb0a7b3fb9ada26dd7286cf016

test default-page collection migration some more

Files changed:
M src/plone/volto/tests/test_migrate_to_volto.py

b'diff --git a/src/plone/volto/tests/test_migrate_to_volto.py b/src/plone/volto/tests/test_migrate_to_volto.py\nindex 2709205..b7199cf 100644\n--- a/src/plone/volto/tests/test_migrate_to_volto.py\n+++ b/src/plone/volto/tests/test_migrate_to_volto.py\n@@ -196,15 +196,45 @@ def test_default_page_collections_are_migrated(self):\n             id="folder",\n             title="Folder",\n         )\n-        api.content.create(\n+        collection = api.content.create(\n             container=folder,\n             type="Collection",\n             id="collection",\n             title="Collection",\n             description="This is a default collection",\n+            limit=1000,\n+            item_count=30,\n+            sort_on="modified",\n+            sort_reversed=True,\n         )\n+        collection.query = [\n+            {\n+                "i": "path",\n+                "o": "plone.app.querystring.operation.string.relativePath",\n+                "v": "..::1",\n+            }, {\n+                "i": "portal_type",\n+                "o": "plone.app.querystring.operation.selection.any",\n+                "v": ["Document"],\n+            }\n+        ]\n         folder.setDefaultPage("collection")\n+        api.content.create(\n+            container=folder,\n+            type="Document",\n+            id="doc1",\n+            title="Doc 1",\n+            description="This is a document",\n+        )\n+        api.content.create(\n+            container=folder,\n+            type="Document",\n+            id="doc2",\n+            title="Doc 2",\n+            description="This is a document",\n+        )\n         self.assertIn("collection", folder.keys())\n+        self.assertEqual(len(collection.results()), 2)\n \n         view = self.portal.restrictedTraverse("@@migrate_to_volto")\n         self.request.form["form.submitted"] = True\n@@ -216,6 +246,29 @@ def test_default_page_collections_are_migrated(self):\n         self.assertNotIn("collection", folder.keys())\n         self.assertEqual(folder.title, "Collection")\n         self.assertEqual(folder.description, "This is a default collection")\n+        listing = collection.blocks[collection.blocks_layout["items"][1]]\n+        self.assertEqual(listing["@type"], "listing")\n+        self.assertEqual(\n+            listing["querystring"],\n+            {\n+                "b_size": 30,\n+                "limit": 1000,\n+                "query": [\n+                    {\n+                        "i": "path",\n+                        "o": "plone.app.querystring.operation.string.relativePath",\n+                        "v": ".::1",\n+                    }, {\n+                        "i": "portal_type",\n+                        "o": "plone.app.querystring.operation.selection.any",\n+                        "v": ["Document"],\n+                    }\n+                ],\n+                "sort_on": "modified",\n+                "sort_order_boolean": True,\n+                "sort_order": "descending"\n+            },\n+        )\n \n     def test_default_page_news_are_not_migrated(self):\n         folder = api.content.create(\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2023-02-27T21:36:22+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/4beb80902b42145810e8739e1037b8fb3a897763

black

Files changed:
M src/plone/volto/browser/migrate_to_volto.py
M src/plone/volto/tests/test_migrate_to_volto.py

b'diff --git a/src/plone/volto/browser/migrate_to_volto.py b/src/plone/volto/browser/migrate_to_volto.py\nindex 1cf490b..d1092e6 100644\n--- a/src/plone/volto/browser/migrate_to_volto.py\n+++ b/src/plone/volto/browser/migrate_to_volto.py\n@@ -149,7 +149,9 @@ def do_migrate_default_page(self, obj):\n             blocks_layout = default_page_obj.blocks_layout or blocks_layout\n \n             if default_page_type == "Collection":\n-                uuid, block = generate_listing_block_from_collection(default_page_obj, move_relative_path=True)\n+                uuid, block = generate_listing_block_from_collection(\n+                    default_page_obj, move_relative_path=True\n+                )\n                 blocks[uuid] = block\n                 blocks_layout["items"].append(uuid)\n \n@@ -245,9 +247,13 @@ def generate_listing_block_from_collection(obj, move_relative_path=False):\n         # when we migrate collections that were used as default-pages\n         # with a relative path to the parent ("..::") that path now needs\n         # to point to itself.\n-        for qu in collection.query:\n-            if "path" in qu["i"] and "relativePath" in qu["o"] and qu["v"].startswith(".."):\n-                qu["v"] = qu["v"].replace("..", ".", 1)\n+        for query_part in collection.query:\n+            if (\n+                "path" in query_part["i"]\n+                and "relativePath" in query_part["o"]\n+                and query_part["v"].startswith("..")\n+            ):\n+                query_part["v"] = query_part["v"].replace("..", ".", 1)\n     qs = {"query": collection.query}\n     if collection.item_count:\n         qs["b_size"] = collection.item_count\ndiff --git a/src/plone/volto/tests/test_migrate_to_volto.py b/src/plone/volto/tests/test_migrate_to_volto.py\nindex b7199cf..e72af5a 100644\n--- a/src/plone/volto/tests/test_migrate_to_volto.py\n+++ b/src/plone/volto/tests/test_migrate_to_volto.py\n@@ -159,7 +159,7 @@ def test_collections_are_migrated(self):\n                 ],\n                 "sort_on": "effective",\n                 "sort_order_boolean": False,\n-                "sort_order": "ascending"\n+                "sort_order": "ascending",\n             },\n         )\n \n@@ -212,11 +212,12 @@ def test_default_page_collections_are_migrated(self):\n                 "i": "path",\n                 "o": "plone.app.querystring.operation.string.relativePath",\n                 "v": "..::1",\n-            }, {\n+            },\n+            {\n                 "i": "portal_type",\n                 "o": "plone.app.querystring.operation.selection.any",\n                 "v": ["Document"],\n-            }\n+            },\n         ]\n         folder.setDefaultPage("collection")\n         api.content.create(\n@@ -258,15 +259,16 @@ def test_default_page_collections_are_migrated(self):\n                         "i": "path",\n                         "o": "plone.app.querystring.operation.string.relativePath",\n                         "v": ".::1",\n-                    }, {\n+                    },\n+                    {\n                         "i": "portal_type",\n                         "o": "plone.app.querystring.operation.selection.any",\n                         "v": ["Document"],\n-                    }\n+                    },\n                 ],\n                 "sort_on": "modified",\n                 "sort_order_boolean": True,\n-                "sort_order": "descending"\n+                "sort_order": "descending",\n             },\n         )\n \n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2023-02-27T21:36:22+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/dd29c48c3ecb5f734608a45c639b0a480252b523

add changenote

Files changed:
A news/111.bugfix

b'diff --git a/news/111.bugfix b/news/111.bugfix\nnew file mode 100644\nindex 0000000..23f0ebc\n--- /dev/null\n+++ b/news/111.bugfix\n@@ -0,0 +1,2 @@\n+Better migration of collections: Fix migrating sort_order. Adapt relative path of query when migrating default-page collection to listing block.\n+[pbauer]\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2023-02-28T07:37:54+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/1bfadf7ccff5f4dee153ec432602447da87acc61

Merge pull request #111 from plone/improve_collection_migration

Files changed:
A news/111.bugfix
M src/plone/volto/browser/migrate_to_volto.py
M src/plone/volto/tests/test_migrate_to_volto.py

b'diff --git a/news/111.bugfix b/news/111.bugfix\nnew file mode 100644\nindex 0000000..23f0ebc\n--- /dev/null\n+++ b/news/111.bugfix\n@@ -0,0 +1,2 @@\n+Better migration of collections: Fix migrating sort_order. Adapt relative path of query when migrating default-page collection to listing block.\n+[pbauer]\ndiff --git a/src/plone/volto/browser/migrate_to_volto.py b/src/plone/volto/browser/migrate_to_volto.py\nindex 34eb439..d1092e6 100644\n--- a/src/plone/volto/browser/migrate_to_volto.py\n+++ b/src/plone/volto/browser/migrate_to_volto.py\n@@ -149,7 +149,9 @@ def do_migrate_default_page(self, obj):\n             blocks_layout = default_page_obj.blocks_layout or blocks_layout\n \n             if default_page_type == "Collection":\n-                uuid, block = generate_listing_block_from_collection(default_page_obj)\n+                uuid, block = generate_listing_block_from_collection(\n+                    default_page_obj, move_relative_path=True\n+                )\n                 blocks[uuid] = block\n                 blocks_layout["items"].append(uuid)\n \n@@ -237,10 +239,21 @@ def generate_listing_block(obj):\n     return uuid, block\n \n \n-def generate_listing_block_from_collection(obj):\n+def generate_listing_block_from_collection(obj, move_relative_path=False):\n     """Transform collection query and setting to listing block."""\n     collection = ICollection(obj)\n     uuid = str(uuid4())\n+    if move_relative_path and collection.query:\n+        # when we migrate collections that were used as default-pages\n+        # with a relative path to the parent ("..::") that path now needs\n+        # to point to itself.\n+        for query_part in collection.query:\n+            if (\n+                "path" in query_part["i"]\n+                and "relativePath" in query_part["o"]\n+                and query_part["v"].startswith("..")\n+            ):\n+                query_part["v"] = query_part["v"].replace("..", ".", 1)\n     qs = {"query": collection.query}\n     if collection.item_count:\n         qs["b_size"] = collection.item_count\n@@ -248,6 +261,7 @@ def generate_listing_block_from_collection(obj):\n         qs["limit"] = collection.limit\n     if collection.sort_on:\n         qs["sort_on"] = collection.sort_on\n+    qs["sort_order"] = "descending" if collection.sort_reversed else "ascending"\n     qs["sort_order_boolean"] = True if collection.sort_reversed else False\n \n     # Set layout of collection to listing block\ndiff --git a/src/plone/volto/tests/test_migrate_to_volto.py b/src/plone/volto/tests/test_migrate_to_volto.py\nindex 56d3361..e72af5a 100644\n--- a/src/plone/volto/tests/test_migrate_to_volto.py\n+++ b/src/plone/volto/tests/test_migrate_to_volto.py\n@@ -159,6 +159,7 @@ def test_collections_are_migrated(self):\n                 ],\n                 "sort_on": "effective",\n                 "sort_order_boolean": False,\n+                "sort_order": "ascending",\n             },\n         )\n \n@@ -195,15 +196,46 @@ def test_default_page_collections_are_migrated(self):\n             id="folder",\n             title="Folder",\n         )\n-        api.content.create(\n+        collection = api.content.create(\n             container=folder,\n             type="Collection",\n             id="collection",\n             title="Collection",\n             description="This is a default collection",\n+            limit=1000,\n+            item_count=30,\n+            sort_on="modified",\n+            sort_reversed=True,\n         )\n+        collection.query = [\n+            {\n+                "i": "path",\n+                "o": "plone.app.querystring.operation.string.relativePath",\n+                "v": "..::1",\n+            },\n+            {\n+                "i": "portal_type",\n+                "o": "plone.app.querystring.operation.selection.any",\n+                "v": ["Document"],\n+            },\n+        ]\n         folder.setDefaultPage("collection")\n+        api.content.create(\n+            container=folder,\n+            type="Document",\n+            id="doc1",\n+            title="Doc 1",\n+            description="This is a document",\n+        )\n+        api.content.create(\n+            container=folder,\n+            type="Document",\n+            id="doc2",\n+            title="Doc 2",\n+            description="This is a document",\n+        )\n         self.assertIn("collection", folder.keys())\n+        self.assertEqual(len(collection.results()), 2)\n \n         view = self.portal.restrictedTraverse("@@migrate_to_volto")\n         self.request.form["form.submitted"] = True\n@@ -215,6 +247,30 @@ def test_default_page_collections_are_migrated(self):\n         self.assertNotIn("collection", folder.keys())\n         self.assertEqual(folder.title, "Collection")\n         self.assertEqual(folder.description, "This is a default collection")\n+        listing = collection.blocks[collection.blocks_layout["items"][1]]\n+        self.assertEqual(listing["@type"], "listing")\n+        self.assertEqual(\n+            listing["querystring"],\n+            {\n+                "b_size": 30,\n+                "limit": 1000,\n+                "query": [\n+                    {\n+                        "i": "path",\n+                        "o": "plone.app.querystring.operation.string.relativePath",\n+                        "v": ".::1",\n+                    },\n+                    {\n+                        "i": "portal_type",\n+                        "o": "plone.app.querystring.operation.selection.any",\n+                        "v": ["Document"],\n+                    },\n+                ],\n+                "sort_on": "modified",\n+                "sort_order_boolean": True,\n+                "sort_order": "descending",\n+            },\n+        )\n \n     def test_default_page_news_are_not_migrated(self):\n         folder = api.content.create(\n'

