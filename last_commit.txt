Repository: plone.volto


Branch: refs/heads/main
Date: 2022-03-26T13:39:44+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/b1f68131e7e2394774e3eb9a3f853c9af3af923a

Move form @@migrate_to_slate to migrate html-richtext to slate blocks to plone.volto

Files changed:
A src/plone/volto/browser/migrate_richtext.py
A src/plone/volto/browser/migrate_to_slate.pt
A src/plone/volto/scripts/migrate_richtext.py
M src/plone/volto/browser/configure.zcml

b'diff --git a/src/plone/volto/browser/configure.zcml b/src/plone/volto/browser/configure.zcml\nindex 2654c2f..3b79fa3 100644\n--- a/src/plone/volto/browser/configure.zcml\n+++ b/src/plone/volto/browser/configure.zcml\n@@ -26,4 +26,12 @@\n       zcml:condition="have plone-5"\n       />\n \n+  <browser:page\n+      name="migrate_to_slate"\n+      for="zope.interface.Interface"\n+      class=".migrate_richtext.TransformRichTextToSlate"\n+      template="migrate_to_slate.pt"\n+      permission="cmf.ManagePortal"\n+      />\n+\n </configure>\ndiff --git a/src/plone/volto/browser/migrate_richtext.py b/src/plone/volto/browser/migrate_richtext.py\nnew file mode 100644\nindex 0000000..ded828d\n--- /dev/null\n+++ b/src/plone/volto/browser/migrate_richtext.py\n@@ -0,0 +1,125 @@\n+from logging import getLogger\n+from operator import itemgetter\n+from plone import api\n+from plone.app.textfield.value import RichTextValue\n+from Products.Five import BrowserView\n+from uuid import uuid4\n+from zope.i18n import translate\n+\n+import requests\n+import transaction\n+\n+logger = getLogger(__name__)\n+\n+\n+class TransformRichTextToSlate(BrowserView):\n+\n+    service = "http://localhost:5000/html"\n+\n+    def __call__(self):\n+        request = self.request\n+        self.service_url = request.get("service_url", "http://localhost:5000/html")\n+        self.purge_richtext = request.get("purge_richtext", False)\n+        self.portal_types = request.get("portal_types", [])\n+        self.portal_types_info = self.types_with_blocks()\n+\n+        if not self.request.form.get("form.submitted", False):\n+            return self.index()\n+\n+        results = migrate_to_slate(\n+            portal_types=self.portal_types,\n+            service_url=self.service_url,\n+            purge_richtext=self.purge_richtext,\n+        )\n+        api.portal.show_message(u"Migrated {} items from richtext to slate".format(results), request=self.request)\n+        return self.index()\n+\n+    def types_with_blocks(self):\n+        """A list with info on all content types with existing items."""\n+        catalog = api.portal.get_tool("portal_catalog")\n+        portal_types = api.portal.get_tool("portal_types")\n+        results = []\n+        for fti in portal_types.listTypeInfo():\n+            behaviors = getattr(fti, "behaviors", [])\n+            if "volto.blocks" not in behaviors:\n+                continue\n+            number = len(catalog.unrestrictedSearchResults(portal_type=fti.id))\n+            if number >= 1:\n+                results.append(\n+                    {\n+                        "number": number,\n+                        "value": fti.id,\n+                        "title": translate(\n+                            fti.title, domain="plone", context=self.request\n+                        ),\n+                    }\n+                )\n+        return sorted(results, key=itemgetter("title"))\n+\n+\n+def migrate_to_slate(portal_types, service_url="http://localhost:5000/html", purge_richtext=False):\n+\n+    if isinstance(portal_types, str):\n+        portal_types = [portal_types]\n+    fieldname = "text"\n+    headers = {\n+        "Accept": "application/json",\n+        "Content-Type": "application/json",\n+    }\n+    results = 0\n+    for portal_type in portal_types:\n+        for index, brain in enumerate(\n+            api.content.find(portal_type=portal_type, sort_on="path"), start=1\n+        ):\n+            obj = brain.getObject()\n+            text = getattr(obj.aq_base, fieldname, None)\n+            if not text:\n+                continue\n+            if isinstance(text, RichTextValue):\n+                text = text.raw\n+            if not text.strip():\n+                continue\n+\n+            # use https://github.com/plone/blocks-conversion-tool\n+            r = requests.post(service_url, headers=headers, json={"html": text})\n+            r.raise_for_status()\n+            slate_data = r.json()\n+            slate_data = slate_data["data"]\n+\n+            blocks = {}\n+            uuids = []\n+\n+            # add title\n+            uuid = str(uuid4())\n+            blocks[uuid] = {"@type": "title"}\n+            uuids.append(uuid)\n+\n+            # add description\n+            if obj.description:\n+                uuid = str(uuid4())\n+                blocks[uuid] = {"@type": "description"}\n+                uuids.append(uuid)\n+\n+            # add slate blocks\n+            for block in slate_data:\n+                uuid = str(uuid4())\n+                uuids.append(uuid)\n+                blocks[uuid] = block\n+\n+            obj.blocks = blocks\n+            obj.blocks_layout = {"items": uuids}\n+            obj._p_changed = True\n+\n+            if purge_richtext:\n+                setattr(obj, fieldname, None)\n+\n+            obj.reindexObject(idxs=["SearchableText"])\n+            results += 1\n+            logger.debug(f"Migrated richtext to slate for: {obj.absolute_url()}")\n+\n+            if not index % 1000:\n+                logger.info(f"Commiting after {index} items...")\n+                transaction.commit()\n+        msg = f"Migrated {index} {portal_type} to slate"\n+        logger.info(msg)\n+    return results\ndiff --git a/src/plone/volto/browser/migrate_to_slate.pt b/src/plone/volto/browser/migrate_to_slate.pt\nnew file mode 100644\nindex 0000000..cedf37a\n--- /dev/null\n+++ b/src/plone/volto/browser/migrate_to_slate.pt\n@@ -0,0 +1,75 @@\n+<html xmlns="http://www.w3.org/1999/xhtml"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      i18n:domain="plone"\n+      metal:use-macro="context/main_template/macros/master">\n+\n+<div metal:fill-slot="main">\n+    <tal:main-macro metal:define-macro="main">\n+\n+      <h1 class="documentFirstHeading">Migrate Richtext to Slate Block</h1>\n+\n+      <p class="documentDescription">Migrate text from RichText-fields to text in the Volto Editor</p>\n+\n+        <form id="migrate_to_slate" action="@@migrate_to_slate" tal:attributes="action request/URL" method="post" enctype="multipart/form-data">\n+\n+            <div class="field mb-3">\n+              <label for="portal_types" class="form-label">\n+                <span i18n:translate="">Content Types to handle</span>\n+              </label>\n+              <tal:types tal:repeat="ptype python: view.portal_types_info">\n+                <div class="form-check">\n+                  <input type="checkbox"\n+                         name="portal_types"\n+                         class="form-check-input"\n+                         tal:attributes="value ptype/value; id ptype/value;\n+                                         checked python: ptype[\'value\'] in view.portal_types">\n+                  <label class="form-check-label"\n+                         tal:attributes="for ptype/value"\n+                         tal:content="string:${ptype/title} - ${ptype/value} (${ptype/number})"></label>\n+                </div>\n+              </tal:types>\n+            </div>\n+\n+            <div class="field mb-3">\n+              <label for="service_url" class="form-label">\n+                URL of blocks-conversion-tool. The migration requires a service to run. See https://github.com/plone/blocks-conversion-tool for details.\n+              </label>\n+              <input class="form-control" type="text" name="service_url" id="service_url" value=""\n+                     tal:attributes="value python:view.service_url">\n+            </div>\n+\n+            <div class="form-check">\n+                <input\n+                    class="form-check-input"\n+                    type="checkbox"\n+                    name="purge_richtext:boolean"\n+                    id="purge_richtext"\n+                    value=""\n+                    tal:attributes="checked python:view.purge_richtext"\n+                    />\n+              <label class="form-check-label" for="purge_richtext">\n+                Purge Richtext-fields after migrating to Slate\n+              </label>\n+            </div>\n+\n+\n+            <div class="formControls" class="form-group">\n+                <input type="hidden" name="form.submitted" value="1"/>\n+\n+                <button class="btn btn-primary submit-widget button-field context"\n+                        type="submit" name="submit" value="export">Migrate\n+                </button>\n+            </div>\n+\n+            <div metal:use-macro="context/@@exportimport_links/links">\n+              Links to all exports and imports\n+            </div>\n+\n+        </form>\n+\n+    </tal:main-macro>\n+</div>\n+\n+</html>\ndiff --git a/src/plone/volto/scripts/migrate_richtext.py b/src/plone/volto/scripts/migrate_richtext.py\nnew file mode 100644\nindex 0000000..4954821\n--- /dev/null\n+++ b/src/plone/volto/scripts/migrate_richtext.py\n@@ -0,0 +1,22 @@\n+"""\n+bin/instance -O Plone run scripts/migrate-richtext.py\n+    Migrate all richtexts to slate blocks.\n+    Requires a instance of https://github.com/plone/blocks-conversion-tool to run\n+    on http://localhost:5000/html (the default)\n+    For more control use the form @@migrate-to-slate\n+\n+"""\n+from plone import api\n+from plone.volto.browser.migrate_richtext import migrate_to_slate\n+\n+\n+if __name__ == "__main__":\n+    portal_types = api.portal.get_tool("portal_types")\n+    portal_types = []\n+    for fti in portal_types.listTypeInfo():\n+        behaviors = getattr(fti, "behaviors", [])\n+        if "volto.blocks" in behaviors:\n+            portal_types.append(fti.id)\n+\n+    migrate_to_slate(portal_types=portal_types)\n+\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-03-26T13:41:23+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/fd7b34c488f294366b1dd70c6b79886a44966f72

add changenote

Files changed:
M CHANGES.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 63d2c60..0353690 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -4,7 +4,8 @@ Changelog\n 4.0.0a4 (unreleased)\n --------------------\n \n-- Nothing changed yet.\n+- Add form @@migrate_to_slate to migrate html-richtext to slate blocks\n+  [pbauer]\n \n \n 4.0.0a3 (2022-02-04)\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-03-26T13:54:52+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/0f56570f8e001bf715cf9dab1e3f379f727251c4

rename form to @@migrate_richtext, black, cleanup

Files changed:
A src/plone/volto/browser/migrate_richtext.pt
M src/plone/volto/browser/configure.zcml
M src/plone/volto/browser/migrate_richtext.py
M src/plone/volto/scripts/migrate_richtext.py
D src/plone/volto/browser/migrate_to_slate.pt

b'diff --git a/src/plone/volto/browser/configure.zcml b/src/plone/volto/browser/configure.zcml\nindex 3b79fa3..4f1b949 100644\n--- a/src/plone/volto/browser/configure.zcml\n+++ b/src/plone/volto/browser/configure.zcml\n@@ -27,10 +27,10 @@\n       />\n \n   <browser:page\n-      name="migrate_to_slate"\n+      name="migrate_richtext"\n       for="zope.interface.Interface"\n-      class=".migrate_richtext.TransformRichTextToSlate"\n-      template="migrate_to_slate.pt"\n+      class=".migrate_richtext.MigrateRichTextToSlate"\n+      template="migrate_richtext.pt"\n       permission="cmf.ManagePortal"\n       />\n \ndiff --git a/src/plone/volto/browser/migrate_to_slate.pt b/src/plone/volto/browser/migrate_richtext.pt\nsimilarity index 97%\nrename from src/plone/volto/browser/migrate_to_slate.pt\nrename to src/plone/volto/browser/migrate_richtext.pt\nindex cedf37a..03c5161 100644\n--- a/src/plone/volto/browser/migrate_to_slate.pt\n+++ b/src/plone/volto/browser/migrate_richtext.pt\n@@ -12,7 +12,7 @@\n \n       <p class="documentDescription">Migrate text from RichText-fields to text in the Volto Editor</p>\n \n-        <form id="migrate_to_slate" action="@@migrate_to_slate" tal:attributes="action request/URL" method="post" enctype="multipart/form-data">\n+        <form id="migrate_richtext" action="@@migrate_richtext" tal:attributes="action request/URL" method="post" enctype="multipart/form-data">\n \n             <div class="field mb-3">\n               <label for="portal_types" class="form-label">\ndiff --git a/src/plone/volto/browser/migrate_richtext.py b/src/plone/volto/browser/migrate_richtext.py\nindex ded828d..e279c8d 100644\n--- a/src/plone/volto/browser/migrate_richtext.py\n+++ b/src/plone/volto/browser/migrate_richtext.py\n@@ -12,9 +12,8 @@\n logger = getLogger(__name__)\n \n \n-class TransformRichTextToSlate(BrowserView):\n-\n-    service = "http://localhost:5000/html"\n+class MigrateRichTextToSlate(BrowserView):\n+    """Form to trigger migrating html from Richxtext fields to slate."""\n \n     def __call__(self):\n         request = self.request\n@@ -26,12 +25,15 @@ def __call__(self):\n         if not self.request.form.get("form.submitted", False):\n             return self.index()\n \n-        results = migrate_to_slate(\n+        results = migrate_richtext_to_slate(\n             portal_types=self.portal_types,\n             service_url=self.service_url,\n             purge_richtext=self.purge_richtext,\n         )\n-        api.portal.show_message(u"Migrated {} items from richtext to slate".format(results), request=self.request)\n+        api.portal.show_message(\n+            u"Migrated {} items from richtext to slate".format(results),\n+            request=self.request,\n+        )\n         return self.index()\n \n     def types_with_blocks(self):\n@@ -57,7 +59,9 @@ def types_with_blocks(self):\n         return sorted(results, key=itemgetter("title"))\n \n \n-def migrate_to_slate(portal_types, service_url="http://localhost:5000/html", purge_richtext=False):\n+def migrate_richtext_to_slate(\n+    portal_types, service_url="http://localhost:5000/html", purge_richtext=False\n+):\n \n     if isinstance(portal_types, str):\n         portal_types = [portal_types]\ndiff --git a/src/plone/volto/scripts/migrate_richtext.py b/src/plone/volto/scripts/migrate_richtext.py\nindex 4954821..aa6fc46 100644\n--- a/src/plone/volto/scripts/migrate_richtext.py\n+++ b/src/plone/volto/scripts/migrate_richtext.py\n@@ -3,11 +3,11 @@\n     Migrate all richtexts to slate blocks.\n     Requires a instance of https://github.com/plone/blocks-conversion-tool to run\n     on http://localhost:5000/html (the default)\n-    For more control use the form @@migrate-to-slate\n+    For more control use the form @@migrate_richtext\n \n """\n from plone import api\n-from plone.volto.browser.migrate_richtext import migrate_to_slate\n+from plone.volto.browser.migrate_richtext import migrate_richtext_to_slate\n \n \n if __name__ == "__main__":\n@@ -18,5 +18,4 @@\n         if "volto.blocks" in behaviors:\n             portal_types.append(fti.id)\n \n-    migrate_to_slate(portal_types=portal_types)\n-\n+    migrate_richtext_to_slate(portal_types=portal_types)\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-03-26T13:56:00+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/02eff64eb1e8a6571474815010568113f44ad317

more black

Files changed:
M src/plone/volto/browser/migrate_richtext.py

b'diff --git a/src/plone/volto/browser/migrate_richtext.py b/src/plone/volto/browser/migrate_richtext.py\nindex e279c8d..6b7a64a 100644\n--- a/src/plone/volto/browser/migrate_richtext.py\n+++ b/src/plone/volto/browser/migrate_richtext.py\n@@ -31,7 +31,7 @@ def __call__(self):\n             purge_richtext=self.purge_richtext,\n         )\n         api.portal.show_message(\n-            u"Migrated {} items from richtext to slate".format(results),\n+            "Migrated {} items from richtext to slate".format(results),\n             request=self.request,\n         )\n         return self.index()\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-04-08T13:29:16+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/a6a6af93f76fa8b3fbd055e441f49adabaa47350

Merge branch 'main' into migrate-richtext

# Conflicts:
#	CHANGES.rst

Files changed:
A news/.gitkeep
A news/47.feature
M CHANGES.rst
M setup.py
M src/plone/volto/browser/breadcrumbs.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 0353690..17dafb4 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -1,10 +1,17 @@\n Changelog\n =========\n \n-4.0.0a4 (unreleased)\n+.. You should *NOT* be adding new change log entries to this file.\n+   You should create a file in the news directory instead.\n+   For helpful instructions, please see:\n+   https://github.com/plone/plone.releaser/blob/master/ADD-A-NEWS-ITEM.rst\n+\n+.. towncrier release notes start\n+\n+4.0.0a4 (2022-04-08)\n --------------------\n \n-- Add form @@migrate_to_slate to migrate html-richtext to slate blocks\n+- Fix deprecated import of isDefaultPage\n   [pbauer]\n \n \ndiff --git a/news/.gitkeep b/news/.gitkeep\nnew file mode 100644\nindex 0000000..8b13789\n--- /dev/null\n+++ b/news/.gitkeep\n@@ -0,0 +1 @@\n+\ndiff --git a/news/47.feature b/news/47.feature\nnew file mode 100644\nindex 0000000..0ab89fb\n--- /dev/null\n+++ b/news/47.feature\n@@ -0,0 +1,2 @@\n+- Add form @@migrate_to_slate to migrate html-richtext to slate blocks\n+  [pbauer]\ndiff --git a/setup.py b/setup.py\nindex 71dd42f..20eca67 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -24,7 +24,7 @@ def readfile(name):\n \n setup(\n     name="plone.volto",\n-    version="4.0.0a4.dev0",\n+    version="4.0.0a5.dev0",\n     description="Volto integration add-on for Plone",\n     long_description=long_description,\n     # Get more from https://pypi.org/classifiers/\ndiff --git a/src/plone/volto/browser/breadcrumbs.py b/src/plone/volto/browser/breadcrumbs.py\nindex 85ac05a..e5a93fa 100644\n--- a/src/plone/volto/browser/breadcrumbs.py\n+++ b/src/plone/volto/browser/breadcrumbs.py\n@@ -5,6 +5,7 @@\n from Products.CMFPlone import utils\n from Products.CMFPlone.browser.interfaces import INavigationBreadcrumbs\n from Products.CMFPlone.browser.navigation import get_view_url\n+from Products.CMFPlone.defaultpage import check_default_page_via_view\n from Products.CMFPlone.interfaces import IHideFromBreadcrumbs\n from Products.Five import BrowserView\n from zope.component import getMultiAdapter\n@@ -46,9 +47,9 @@ def breadcrumbs(self):\n \n         # don\'t show default pages in breadcrumbs or pages above the navigation\n         # root\n-        if not utils.isDefaultPage(context, request) and not rootPath.startswith(\n-            itemPath\n-        ):\n+        if not check_default_page_via_view(\n+            context, request\n+        ) and not rootPath.startswith(itemPath):\n             base += (\n                 {\n                     "absolute_url": item_url,\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-04-08T13:42:37+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/e7abe4159afe065e981cbe2f3bdbb9623217bf8a

re-add dropped file

Files changed:
A pyproject.toml

b'diff --git a/pyproject.toml b/pyproject.toml\nnew file mode 100644\nindex 0000000..05b615d\n--- /dev/null\n+++ b/pyproject.toml\n@@ -0,0 +1,20 @@\n+[tool.towncrier]\n+filename = "CHANGES.rst"\n+directory = "news/"\n+title_format = "{version} ({project_date})"\n+underlines = ["-", ""]\n+\n+[[tool.towncrier.type]]\n+directory = "breaking"\n+name = "Breaking changes:"\n+showcontent = true\n+\n+[[tool.towncrier.type]]\n+directory = "feature"\n+name = "New features:"\n+showcontent = true\n+\n+[[tool.towncrier.type]]\n+directory = "bugfix"\n+name = "Bug fixes:"\n+showcontent = true\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2022-04-14T09:20:00+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.volto/commit/8192a1cee18b0cffc3cd79c9ee622e0939121158

Merge pull request #47 from plone/migrate-richtext

Add form to migrate richtext to slate using blocks-conversion-tool

Files changed:
A news/47.feature
A src/plone/volto/browser/migrate_richtext.pt
A src/plone/volto/browser/migrate_richtext.py
A src/plone/volto/scripts/migrate_richtext.py
M src/plone/volto/browser/configure.zcml

b'diff --git a/news/47.feature b/news/47.feature\nnew file mode 100644\nindex 0000000..0ab89fb\n--- /dev/null\n+++ b/news/47.feature\n@@ -0,0 +1,2 @@\n+- Add form @@migrate_to_slate to migrate html-richtext to slate blocks\n+  [pbauer]\ndiff --git a/src/plone/volto/browser/configure.zcml b/src/plone/volto/browser/configure.zcml\nindex 2654c2f..4f1b949 100644\n--- a/src/plone/volto/browser/configure.zcml\n+++ b/src/plone/volto/browser/configure.zcml\n@@ -26,4 +26,12 @@\n       zcml:condition="have plone-5"\n       />\n \n+  <browser:page\n+      name="migrate_richtext"\n+      for="zope.interface.Interface"\n+      class=".migrate_richtext.MigrateRichTextToSlate"\n+      template="migrate_richtext.pt"\n+      permission="cmf.ManagePortal"\n+      />\n+\n </configure>\ndiff --git a/src/plone/volto/browser/migrate_richtext.pt b/src/plone/volto/browser/migrate_richtext.pt\nnew file mode 100644\nindex 0000000..03c5161\n--- /dev/null\n+++ b/src/plone/volto/browser/migrate_richtext.pt\n@@ -0,0 +1,75 @@\n+<html xmlns="http://www.w3.org/1999/xhtml"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      i18n:domain="plone"\n+      metal:use-macro="context/main_template/macros/master">\n+\n+<div metal:fill-slot="main">\n+    <tal:main-macro metal:define-macro="main">\n+\n+      <h1 class="documentFirstHeading">Migrate Richtext to Slate Block</h1>\n+\n+      <p class="documentDescription">Migrate text from RichText-fields to text in the Volto Editor</p>\n+\n+        <form id="migrate_richtext" action="@@migrate_richtext" tal:attributes="action request/URL" method="post" enctype="multipart/form-data">\n+\n+            <div class="field mb-3">\n+              <label for="portal_types" class="form-label">\n+                <span i18n:translate="">Content Types to handle</span>\n+              </label>\n+              <tal:types tal:repeat="ptype python: view.portal_types_info">\n+                <div class="form-check">\n+                  <input type="checkbox"\n+                         name="portal_types"\n+                         class="form-check-input"\n+                         tal:attributes="value ptype/value; id ptype/value;\n+                                         checked python: ptype[\'value\'] in view.portal_types">\n+                  <label class="form-check-label"\n+                         tal:attributes="for ptype/value"\n+                         tal:content="string:${ptype/title} - ${ptype/value} (${ptype/number})"></label>\n+                </div>\n+              </tal:types>\n+            </div>\n+\n+            <div class="field mb-3">\n+              <label for="service_url" class="form-label">\n+                URL of blocks-conversion-tool. The migration requires a service to run. See https://github.com/plone/blocks-conversion-tool for details.\n+              </label>\n+              <input class="form-control" type="text" name="service_url" id="service_url" value=""\n+                     tal:attributes="value python:view.service_url">\n+            </div>\n+\n+            <div class="form-check">\n+                <input\n+                    class="form-check-input"\n+                    type="checkbox"\n+                    name="purge_richtext:boolean"\n+                    id="purge_richtext"\n+                    value=""\n+                    tal:attributes="checked python:view.purge_richtext"\n+                    />\n+              <label class="form-check-label" for="purge_richtext">\n+                Purge Richtext-fields after migrating to Slate\n+              </label>\n+            </div>\n+\n+\n+            <div class="formControls" class="form-group">\n+                <input type="hidden" name="form.submitted" value="1"/>\n+\n+                <button class="btn btn-primary submit-widget button-field context"\n+                        type="submit" name="submit" value="export">Migrate\n+                </button>\n+            </div>\n+\n+            <div metal:use-macro="context/@@exportimport_links/links">\n+              Links to all exports and imports\n+            </div>\n+\n+        </form>\n+\n+    </tal:main-macro>\n+</div>\n+\n+</html>\ndiff --git a/src/plone/volto/browser/migrate_richtext.py b/src/plone/volto/browser/migrate_richtext.py\nnew file mode 100644\nindex 0000000..6b7a64a\n--- /dev/null\n+++ b/src/plone/volto/browser/migrate_richtext.py\n@@ -0,0 +1,129 @@\n+from logging import getLogger\n+from operator import itemgetter\n+from plone import api\n+from plone.app.textfield.value import RichTextValue\n+from Products.Five import BrowserView\n+from uuid import uuid4\n+from zope.i18n import translate\n+\n+import requests\n+import transaction\n+\n+logger = getLogger(__name__)\n+\n+\n+class MigrateRichTextToSlate(BrowserView):\n+    """Form to trigger migrating html from Richxtext fields to slate."""\n+\n+    def __call__(self):\n+        request = self.request\n+        self.service_url = request.get("service_url", "http://localhost:5000/html")\n+        self.purge_richtext = request.get("purge_richtext", False)\n+        self.portal_types = request.get("portal_types", [])\n+        self.portal_types_info = self.types_with_blocks()\n+\n+        if not self.request.form.get("form.submitted", False):\n+            return self.index()\n+\n+        results = migrate_richtext_to_slate(\n+            portal_types=self.portal_types,\n+            service_url=self.service_url,\n+            purge_richtext=self.purge_richtext,\n+        )\n+        api.portal.show_message(\n+            "Migrated {} items from richtext to slate".format(results),\n+            request=self.request,\n+        )\n+        return self.index()\n+\n+    def types_with_blocks(self):\n+        """A list with info on all content types with existing items."""\n+        catalog = api.portal.get_tool("portal_catalog")\n+        portal_types = api.portal.get_tool("portal_types")\n+        results = []\n+        for fti in portal_types.listTypeInfo():\n+            behaviors = getattr(fti, "behaviors", [])\n+            if "volto.blocks" not in behaviors:\n+                continue\n+            number = len(catalog.unrestrictedSearchResults(portal_type=fti.id))\n+            if number >= 1:\n+                results.append(\n+                    {\n+                        "number": number,\n+                        "value": fti.id,\n+                        "title": translate(\n+                            fti.title, domain="plone", context=self.request\n+                        ),\n+                    }\n+                )\n+        return sorted(results, key=itemgetter("title"))\n+\n+\n+def migrate_richtext_to_slate(\n+    portal_types, service_url="http://localhost:5000/html", purge_richtext=False\n+):\n+\n+    if isinstance(portal_types, str):\n+        portal_types = [portal_types]\n+    fieldname = "text"\n+    headers = {\n+        "Accept": "application/json",\n+        "Content-Type": "application/json",\n+    }\n+    results = 0\n+    for portal_type in portal_types:\n+        for index, brain in enumerate(\n+            api.content.find(portal_type=portal_type, sort_on="path"), start=1\n+        ):\n+            obj = brain.getObject()\n+            text = getattr(obj.aq_base, fieldname, None)\n+            if not text:\n+                continue\n+            if isinstance(text, RichTextValue):\n+                text = text.raw\n+            if not text.strip():\n+                continue\n+\n+            # use https://github.com/plone/blocks-conversion-tool\n+            r = requests.post(service_url, headers=headers, json={"html": text})\n+            r.raise_for_status()\n+            slate_data = r.json()\n+            slate_data = slate_data["data"]\n+\n+            blocks = {}\n+            uuids = []\n+\n+            # add title\n+            uuid = str(uuid4())\n+            blocks[uuid] = {"@type": "title"}\n+            uuids.append(uuid)\n+\n+            # add description\n+            if obj.description:\n+                uuid = str(uuid4())\n+                blocks[uuid] = {"@type": "description"}\n+                uuids.append(uuid)\n+\n+            # add slate blocks\n+            for block in slate_data:\n+                uuid = str(uuid4())\n+                uuids.append(uuid)\n+                blocks[uuid] = block\n+\n+            obj.blocks = blocks\n+            obj.blocks_layout = {"items": uuids}\n+            obj._p_changed = True\n+\n+            if purge_richtext:\n+                setattr(obj, fieldname, None)\n+\n+            obj.reindexObject(idxs=["SearchableText"])\n+            results += 1\n+            logger.debug(f"Migrated richtext to slate for: {obj.absolute_url()}")\n+\n+            if not index % 1000:\n+                logger.info(f"Commiting after {index} items...")\n+                transaction.commit()\n+        msg = f"Migrated {index} {portal_type} to slate"\n+        logger.info(msg)\n+    return results\ndiff --git a/src/plone/volto/scripts/migrate_richtext.py b/src/plone/volto/scripts/migrate_richtext.py\nnew file mode 100644\nindex 0000000..aa6fc46\n--- /dev/null\n+++ b/src/plone/volto/scripts/migrate_richtext.py\n@@ -0,0 +1,21 @@\n+"""\n+bin/instance -O Plone run scripts/migrate-richtext.py\n+    Migrate all richtexts to slate blocks.\n+    Requires a instance of https://github.com/plone/blocks-conversion-tool to run\n+    on http://localhost:5000/html (the default)\n+    For more control use the form @@migrate_richtext\n+\n+"""\n+from plone import api\n+from plone.volto.browser.migrate_richtext import migrate_richtext_to_slate\n+\n+\n+if __name__ == "__main__":\n+    portal_types = api.portal.get_tool("portal_types")\n+    portal_types = []\n+    for fti in portal_types.listTypeInfo():\n+        behaviors = getattr(fti, "behaviors", [])\n+        if "volto.blocks" in behaviors:\n+            portal_types.append(fti.id)\n+\n+    migrate_richtext_to_slate(portal_types=portal_types)\n'

