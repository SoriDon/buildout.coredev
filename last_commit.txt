Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2016-11-24T12:39:49+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.Archetypes/commit/8e1e54c867c42ab7d1fd1497ca48bb3a9117db43

Moved selection widget translation tests from CMFPlone to Archetypes.

This is a pure Archetypes test, so it should be here.

I added an unchanged copy of Products/CMFPlone/tests/translate.txt.
This needs a few changes, which I will do in the next commit.

Files changed:
A Products/Archetypes/tests/translate.txt
M CHANGES.rst
M Products/Archetypes/tests/test_doctests.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 599cf9a..4f2c17c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,9 @@ Breaking changes:
 
 New features:
 
+- Moved selection widget translation tests from CMFPlone to Archetypes.
+  [maurits]
+
 - ``OFS.HistoryAware`` was dropped in Zope 4.
   Make AnnotationStorage awareness of it optional.
   [jensens]
diff --git a/Products/Archetypes/tests/test_doctests.py b/Products/Archetypes/tests/test_doctests.py
index b3653c2..9c22aaf 100644
--- a/Products/Archetypes/tests/test_doctests.py
+++ b/Products/Archetypes/tests/test_doctests.py
@@ -18,6 +18,7 @@
 
 DOCTEST_FILES = (
     'events.txt',
+    'translate.txt',
     'traversal_4981.txt',
     'folder_marshall.txt',
     'webdav_operations.txt',
diff --git a/Products/Archetypes/tests/translate.txt b/Products/Archetypes/tests/translate.txt
new file mode 100644
index 0000000..bfee85b
--- /dev/null
+++ b/Products/Archetypes/tests/translate.txt
@@ -0,0 +1,45 @@
+Test for https://dev.plone.org/ticket/7627
+===========================================
+Goal is to have values from selection widgets translated in /base_view
+::
+
+    >>> from plone.testing.z2 import Browser
+    >>> from zope.i18n import ITranslationDomain
+    >>> from zope.interface import implements  
+    >>> from Products.Archetypes.tests.utils import makeContent
+    >>> def browser(url):
+    ...     import transaction; transaction.commit()
+    ...     br = Browser(app)
+    ...     br.handleErrors = False
+    ...     br.addHeader('Authorization','Basic %s:%s'%(portal_owner, 'secret'))
+    ...     br.open(url)
+    ...     return br
+    >>> doc = makeContent(folder, portal_type='ComplexType', id='vocdemodoc3')
+
+
+First make a custom translator for our i18n domain
+::
+
+    >>> class TranslationDomain(object):
+    ...     implements(ITranslationDomain)
+    ...     def translate(self, msgid, mapping=None,
+    ...                   context=None, target_language=None,
+    ...                   default=None):
+    ...         return "translated:%s" % (msgid)
+    >>> t = TranslationDomain()
+    >>> from zope.component import provideUtility
+    >>> provideUtility(t, ITranslationDomain, 'attesti18n')
+    >>> from plone.app.testing import SITE_OWNER_NAME as portal_owner
+
+
+Now be sure our values are correctly translated in view
+::
+
+    >>> doc.setSelectionlinesfield2('Test')
+    >>> doc.setSelectionlinesfield3(['test2'])
+    >>> import transaction
+    >>> transaction.commit()
+    >>> br = browser(doc.absolute_url()+"/base_view")
+    >>> 'translated:test2' in br.contents and 'translated:Test' in br.contents
+    True
+


Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2016-11-24T12:40:28+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.Archetypes/commit/92e9f8d108b045cdb62864eefc9619756f11cc13

Fixed selection widget translation tests.

Files changed:
M Products/Archetypes/tests/translate.txt

diff --git a/Products/Archetypes/tests/translate.txt b/Products/Archetypes/tests/translate.txt
index bfee85b..f6ad44e 100644
--- a/Products/Archetypes/tests/translate.txt
+++ b/Products/Archetypes/tests/translate.txt
@@ -1,24 +1,30 @@
 Test for https://dev.plone.org/ticket/7627
 ===========================================
-Goal is to have values from selection widgets translated in /base_view
-::
 
+Goal is to have values from selection widgets translated in /base_view::
+
+    >>> from plone.app.testing import SITE_OWNER_NAME
+    >>> from plone.app.testing import login
     >>> from plone.testing.z2 import Browser
-    >>> from zope.i18n import ITranslationDomain
-    >>> from zope.interface import implements  
     >>> from Products.Archetypes.tests.utils import makeContent
+    >>> from zope.component import provideUtility
+    >>> from zope.i18n import ITranslationDomain
+    >>> from zope.interface import implements
+    >>> import transaction
+    >>> app = layer['app']
+    >>> portal = layer['portal']
+    >>> login(app, SITE_OWNER_NAME)
     >>> def browser(url):
-    ...     import transaction; transaction.commit()
+    ...     transaction.commit()
     ...     br = Browser(app)
     ...     br.handleErrors = False
-    ...     br.addHeader('Authorization','Basic %s:%s'%(portal_owner, 'secret'))
+    ...     br.addHeader('Authorization','Basic %s:%s'%(SITE_OWNER_NAME, 'secret'))
     ...     br.open(url)
     ...     return br
-    >>> doc = makeContent(folder, portal_type='ComplexType', id='vocdemodoc3')
+    >>> doc = makeContent(portal, portal_type='ComplexType', id='vocdemodoc3')
 
 
-First make a custom translator for our i18n domain
-::
+First make a custom translator for our i18n domain::
 
     >>> class TranslationDomain(object):
     ...     implements(ITranslationDomain)
@@ -27,19 +33,14 @@ First make a custom translator for our i18n domain
     ...                   default=None):
     ...         return "translated:%s" % (msgid)
     >>> t = TranslationDomain()
-    >>> from zope.component import provideUtility
     >>> provideUtility(t, ITranslationDomain, 'attesti18n')
-    >>> from plone.app.testing import SITE_OWNER_NAME as portal_owner
 
 
-Now be sure our values are correctly translated in view
-::
+Now be sure our values are correctly translated in view::
 
     >>> doc.setSelectionlinesfield2('Test')
     >>> doc.setSelectionlinesfield3(['test2'])
-    >>> import transaction
     >>> transaction.commit()
     >>> br = browser(doc.absolute_url()+"/base_view")
     >>> 'translated:test2' in br.contents and 'translated:Test' in br.contents
     True
-


Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2016-11-24T19:26:44+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.Archetypes/commit/e5d732211f737696ee15a50cbea612ecf69d2ed6

translate.txt: unregister translation domain utility at the end.

Otherwise the utility breaks other tests.
For example test_vocabulary_alternate_domain.txt would pass when run in isolation,
but not when run together with translate.txt.

Files changed:
M Products/Archetypes/tests/translate.txt

diff --git a/Products/Archetypes/tests/translate.txt b/Products/Archetypes/tests/translate.txt
index f6ad44e..0ce2b4f 100644
--- a/Products/Archetypes/tests/translate.txt
+++ b/Products/Archetypes/tests/translate.txt
@@ -7,6 +7,7 @@ Goal is to have values from selection widgets translated in /base_view::
     >>> from plone.app.testing import login
     >>> from plone.testing.z2 import Browser
     >>> from Products.Archetypes.tests.utils import makeContent
+    >>> from zope.component import getGlobalSiteManager
     >>> from zope.component import provideUtility
     >>> from zope.i18n import ITranslationDomain
     >>> from zope.interface import implements
@@ -33,8 +34,8 @@ First make a custom translator for our i18n domain::
     ...                   default=None):
     ...         return "translated:%s" % (msgid)
     >>> t = TranslationDomain()
-    >>> provideUtility(t, ITranslationDomain, 'attesti18n')
-
+    >>> gsm = getGlobalSiteManager()
+    >>> gsm.registerUtility(t, ITranslationDomain, 'attesti18n')
 
 Now be sure our values are correctly translated in view::
 
@@ -44,3 +45,5 @@ Now be sure our values are correctly translated in view::
     >>> br = browser(doc.absolute_url()+"/base_view")
     >>> 'translated:test2' in br.contents and 'translated:Test' in br.contents
     True
+    >>> gsm.unregisterUtility(t, ITranslationDomain, 'attesti18n')
+    True
\ No newline at end of file


Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2016-11-24T22:51:09+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.Archetypes/commit/2f295e772fd0d9a3fc40e6d473195ff64309357d

Merge pull request #71 from plone/copy-translate-test-from-cmfplone

Copy selection widget translate test from CMFPlone

Files changed:
A Products/Archetypes/tests/translate.txt
M CHANGES.rst
M Products/Archetypes/tests/test_doctests.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 599cf9a..4f2c17c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,9 @@ Breaking changes:
 
 New features:
 
+- Moved selection widget translation tests from CMFPlone to Archetypes.
+  [maurits]
+
 - ``OFS.HistoryAware`` was dropped in Zope 4.
   Make AnnotationStorage awareness of it optional.
   [jensens]
diff --git a/Products/Archetypes/tests/test_doctests.py b/Products/Archetypes/tests/test_doctests.py
index b3653c2..9c22aaf 100644
--- a/Products/Archetypes/tests/test_doctests.py
+++ b/Products/Archetypes/tests/test_doctests.py
@@ -18,6 +18,7 @@
 
 DOCTEST_FILES = (
     'events.txt',
+    'translate.txt',
     'traversal_4981.txt',
     'folder_marshall.txt',
     'webdav_operations.txt',
diff --git a/Products/Archetypes/tests/translate.txt b/Products/Archetypes/tests/translate.txt
new file mode 100644
index 0000000..0ce2b4f
--- /dev/null
+++ b/Products/Archetypes/tests/translate.txt
@@ -0,0 +1,49 @@
+Test for https://dev.plone.org/ticket/7627
+===========================================
+
+Goal is to have values from selection widgets translated in /base_view::
+
+    >>> from plone.app.testing import SITE_OWNER_NAME
+    >>> from plone.app.testing import login
+    >>> from plone.testing.z2 import Browser
+    >>> from Products.Archetypes.tests.utils import makeContent
+    >>> from zope.component import getGlobalSiteManager
+    >>> from zope.component import provideUtility
+    >>> from zope.i18n import ITranslationDomain
+    >>> from zope.interface import implements
+    >>> import transaction
+    >>> app = layer['app']
+    >>> portal = layer['portal']
+    >>> login(app, SITE_OWNER_NAME)
+    >>> def browser(url):
+    ...     transaction.commit()
+    ...     br = Browser(app)
+    ...     br.handleErrors = False
+    ...     br.addHeader('Authorization','Basic %s:%s'%(SITE_OWNER_NAME, 'secret'))
+    ...     br.open(url)
+    ...     return br
+    >>> doc = makeContent(portal, portal_type='ComplexType', id='vocdemodoc3')
+
+
+First make a custom translator for our i18n domain::
+
+    >>> class TranslationDomain(object):
+    ...     implements(ITranslationDomain)
+    ...     def translate(self, msgid, mapping=None,
+    ...                   context=None, target_language=None,
+    ...                   default=None):
+    ...         return "translated:%s" % (msgid)
+    >>> t = TranslationDomain()
+    >>> gsm = getGlobalSiteManager()
+    >>> gsm.registerUtility(t, ITranslationDomain, 'attesti18n')
+
+Now be sure our values are correctly translated in view::
+
+    >>> doc.setSelectionlinesfield2('Test')
+    >>> doc.setSelectionlinesfield3(['test2'])
+    >>> transaction.commit()
+    >>> br = browser(doc.absolute_url()+"/base_view")
+    >>> 'translated:test2' in br.contents and 'translated:Test' in br.contents
+    True
+    >>> gsm.unregisterUtility(t, ITranslationDomain, 'attesti18n')
+    True
\ No newline at end of file


