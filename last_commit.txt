Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-12-30T10:00:15+01:00
Author: talarias (talarias) <talarias@live.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/168dc1fccde020ffb754a99fc75974f68bae73fe

add favicon

Files changed:
A Products/CMFPlone/browser/favicon.py
A news/plip-barceloneta_lts_favicon.feature
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/controlpanel/browser/site.py
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/profiles/default/viewlets.xml

b'diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml\nindex 313c944bab..5841d608d0 100644\n--- a/Products/CMFPlone/browser/configure.zcml\n+++ b/Products/CMFPlone/browser/configure.zcml\n@@ -32,6 +32,18 @@\n       permission="zope.Public"\n       />\n \n+ <browser:resource\n+       file="static/favicon.ico"\n+       name="favicon.ico"\n+       />\n+\n+    <browser:page\n+      for="*"\n+      name="favicon"\n+      class=".favicon.SiteFavicon"\n+      permission="zope.Public"\n+      />\n+\n   <browser:page\n       for="*"\n       name="sendto_form"\ndiff --git a/Products/CMFPlone/browser/favicon.py b/Products/CMFPlone/browser/favicon.py\nnew file mode 100644\nindex 0000000000..2753869081\n--- /dev/null\n+++ b/Products/CMFPlone/browser/favicon.py\n@@ -0,0 +1,26 @@\n+from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.formwidget.namedfile.converter import b64decode_file\n+from plone.namedfile.browser import Download\n+from plone.namedfile.file import NamedImage\n+from plone.registry.interfaces import IRegistry\n+from zope.component import getUtility\n+from plone.memoize import ram\n+\n+\n+class SiteFavicon(Download):\n+\n+    def __init__(self, context, request):\n+        super().__init__(context, request)\n+        self.filename = None\n+        self.data = None\n+\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(ISiteSchema, prefix="plone")\n+        if getattr(settings, \'site_favicon\', False):\n+            filename, data = b64decode_file(settings.site_favicon)\n+            data = NamedImage(data=data, filename=filename)\n+            self.data = data\n+            self.filename = filename\n+\n+    def _getFile(self):\n+        return self.data\ndiff --git a/Products/CMFPlone/controlpanel/browser/site.py b/Products/CMFPlone/controlpanel/browser/site.py\nindex 269fe1b029..f87c056104 100644\n--- a/Products/CMFPlone/controlpanel/browser/site.py\n+++ b/Products/CMFPlone/controlpanel/browser/site.py\n@@ -16,6 +16,7 @@ class SiteControlPanelForm(controlpanel.RegistryEditForm):\n     def updateFields(self):\n         super().updateFields()\n         self.fields[\'site_logo\'].widgetFactory = NamedImageFieldWidget\n+        self.fields[\'site_favicon\'].widgetFactory = NamedImageFieldWidget\n \n     def updateWidgets(self):\n         super().updateWidgets()\ndiff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py\nindex 09b96721d0..48915fb046 100644\n--- a/Products/CMFPlone/interfaces/controlpanel.py\n+++ b/Products/CMFPlone/interfaces/controlpanel.py\n@@ -1005,6 +1005,20 @@ class ISiteSchema(Interface):\n         required=False,\n     )\n \n+    site_favicon = schema.Bytes(\n+        title=_(\'Site Favicon\'),\n+        description=_(\'This shows a custom favicon on your site.\'),\n+        required=False,\n+    )\n+\n+    site_favicon_mimetype = schema.TextLine(\n+        title=_(\'Site Favicon Mimetype\'),\n+        description=_(\'Automatically setted Mimetype of the Favicon\'),\n+        required=False,\n+        readonly=True,\n+        default=\'image/x-icon\'\n+    )\n+\n     exposeDCMetaTags = schema.Bool(\n         title=_(\'Expose Dublin Core metadata\'),\n         description=_(\'Exposes the Dublin Core properties as metatags.\'),\ndiff --git a/Products/CMFPlone/profiles/default/viewlets.xml b/Products/CMFPlone/profiles/default/viewlets.xml\nindex 4e86ae7d91..7a9c503cbc 100644\n--- a/Products/CMFPlone/profiles/default/viewlets.xml\n+++ b/Products/CMFPlone/profiles/default/viewlets.xml\n@@ -7,6 +7,7 @@\n     <viewlet name="plone.anontools" />\n     <viewlet name="plone.membertools" />\n     <viewlet name="plone.logo" />\n+    <viewlet name="plone.favicon" />\n     <viewlet name="plone.searchbox" />\n     <viewlet name="plone.app.i18n.locales.languageselector" />\n     <viewlet name="plone.app.multilingual.languageselector" />\ndiff --git a/news/plip-barceloneta_lts_favicon.feature b/news/plip-barceloneta_lts_favicon.feature\nnew file mode 100644\nindex 0000000000..bc089405c1\n--- /dev/null\n+++ b/news/plip-barceloneta_lts_favicon.feature\n@@ -0,0 +1,3 @@\n+a new entry in site-controlpanel to change the favicon.\n+The favicon can be a .ico/png or other image-file\n+[talarias]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-12-30T10:11:03+01:00
Author: talarias (talarias) <talarias@live.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/7e310549d0126bf07fec2c40dbc7554486c52bbb

fix hidden field error

Files changed:
A Products/CMFPlone/browser/static/favicon.ico
M Products/CMFPlone/interfaces/controlpanel.py

b"diff --git a/Products/CMFPlone/browser/static/favicon.ico b/Products/CMFPlone/browser/static/favicon.ico\nnew file mode 100644\nindex 0000000000..e69de29bb2\ndiff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py\nindex 48915fb046..00bb2df553 100644\n--- a/Products/CMFPlone/interfaces/controlpanel.py\n+++ b/Products/CMFPlone/interfaces/controlpanel.py\n@@ -1015,7 +1015,6 @@ class ISiteSchema(Interface):\n         title=_('Site Favicon Mimetype'),\n         description=_('Automatically setted Mimetype of the Favicon'),\n         required=False,\n-        readonly=True,\n         default='image/x-icon'\n     )\n \n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-12-30T10:12:57+01:00
Author: talarias (talarias) <talarias@live.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/6078372c16b344767bf2e2d8c3a88e4b9f3e79e5

fix hidden field error

Files changed:
M Products/CMFPlone/interfaces/controlpanel.py

b"diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py\nindex 00bb2df553..13c4139873 100644\n--- a/Products/CMFPlone/interfaces/controlpanel.py\n+++ b/Products/CMFPlone/interfaces/controlpanel.py\n@@ -1005,17 +1005,17 @@ class ISiteSchema(Interface):\n         required=False,\n     )\n \n-    site_favicon = schema.Bytes(\n-        title=_('Site Favicon'),\n-        description=_('This shows a custom favicon on your site.'),\n+    site_favicon_mimetype = schema.TextLine(\n+        title=_('MIME type of the site favicon'),\n+        description=_('MIME type of the favicon (automatically set when a new favicon is uploaded)'),\n         required=False,\n+        default='image/x-icon'\n     )\n \n-    site_favicon_mimetype = schema.TextLine(\n-        title=_('Site Favicon Mimetype'),\n-        description=_('Automatically setted Mimetype of the Favicon'),\n+    site_favicon = schema.Bytes(\n+        title=_('Site Favicon'),\n+        description=_('This shows a custom favicon on your site.'),\n         required=False,\n-        default='image/x-icon'\n     )\n \n     exposeDCMetaTags = schema.Bool(\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2021-12-30T10:16:26+01:00
Author: talarias (talarias) <talarias@live.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/d39933c4ca178ba07fe545e48686e326df8f49e2

fix missing favicon.ico

Files changed:
M Products/CMFPlone/browser/static/favicon.ico

b'diff --git a/Products/CMFPlone/browser/static/favicon.ico b/Products/CMFPlone/browser/static/favicon.ico\nindex e69de29bb2..ae7bb0cd8b 100644\nBinary files a/Products/CMFPlone/browser/static/favicon.ico and b/Products/CMFPlone/browser/static/favicon.ico differ\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-01-13T10:49:18+01:00
Author: talarias (talarias) <talarias@live.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/81d318380cf06f8663daa4115b10c184f31671d9

del unused favicon.ico and static ressource

Files changed:
M Products/CMFPlone/browser/configure.zcml
D Products/CMFPlone/browser/static/favicon.ico

b'diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml\nindex 5841d608d0..f92dbef537 100644\n--- a/Products/CMFPlone/browser/configure.zcml\n+++ b/Products/CMFPlone/browser/configure.zcml\n@@ -32,12 +32,7 @@\n       permission="zope.Public"\n       />\n \n- <browser:resource\n-       file="static/favicon.ico"\n-       name="favicon.ico"\n-       />\n-\n-    <browser:page\n+  <browser:page\n       for="*"\n       name="favicon"\n       class=".favicon.SiteFavicon"\ndiff --git a/Products/CMFPlone/browser/static/favicon.ico b/Products/CMFPlone/browser/static/favicon.ico\ndeleted file mode 100644\nindex ae7bb0cd8b..0000000000\nBinary files a/Products/CMFPlone/browser/static/favicon.ico and /dev/null differ\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-01-13T10:56:07+01:00
Author: talarias (talarias) <talarias@live.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/d4f4d719a47078017ac4f6d626303735536796da

refactoring

Files changed:
M news/plip-barceloneta_lts_favicon.feature

b'diff --git a/news/plip-barceloneta_lts_favicon.feature b/news/plip-barceloneta_lts_favicon.feature\nindex bc089405c1..6ce2a7bf34 100644\n--- a/news/plip-barceloneta_lts_favicon.feature\n+++ b/news/plip-barceloneta_lts_favicon.feature\n@@ -1,3 +1,3 @@\n-a new entry in site-controlpanel to change the favicon.\n-The favicon can be a .ico/png or other image-file\n+add a new entry in site-controlpanel to change the favicon and its MIME-type\n+The favicon can be a .ico/png or SVG-file\n [talarias]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-01-13T12:15:38+01:00
Author: Florian Danzmann (talarias) <talarias@live.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/683bf1e7675cedcd7b7fc6f20dcfae108a327950

Merge branch 'master' into plip-barceloneta_lts_favicon

Files changed:
A Products/CMFPlone/controlpanel/browser/error_log_form.pt
A Products/CMFPlone/controlpanel/browser/error_log_form.py
A Products/CMFPlone/controlpanel/browser/error_log_show_entry.pt
A news/3393.enhancement
A news/3397.bugfix
M Products/CMFPlone/browser/login/templates/mail_password_form.pt
M Products/CMFPlone/browser/templates/error_message.pt
M Products/CMFPlone/controlpanel/browser/configure.zcml
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py
M Products/CMFPlone/profiles/default/controlpanel.xml
M Products/CMFPlone/tests/robot/robodoc/config-screens.robot
D Products/CMFPlone/controlpanel/browser/prefs_error_log_form.pt
D Products/CMFPlone/controlpanel/browser/prefs_error_log_form.py
D Products/CMFPlone/controlpanel/browser/prefs_error_log_showEntry.pt

b'diff --git a/Products/CMFPlone/browser/login/templates/mail_password_form.pt b/Products/CMFPlone/browser/login/templates/mail_password_form.pt\nindex 8c90b0e6a3..b82d74286b 100644\n--- a/Products/CMFPlone/browser/login/templates/mail_password_form.pt\n+++ b/Products/CMFPlone/browser/login/templates/mail_password_form.pt\n@@ -76,7 +76,7 @@\n             name or your email address has changed), contact the\n             <span i18n:name="site_admin">\n             <a href="#"\n-               i18n:translate="label_site_admin"\n+               i18n:translate="label_site_administration"\n                tal:attributes="href string:${portal_url}/contact-info">site administration</a></span>.\n         </p>\n \n@@ -86,7 +86,7 @@\n             address has changed), contact the\n             <span i18n:name="site_admin">\n             <a href="#"\n-               i18n:translate="label_site_admin"\n+               i18n:translate="label_site_administration"\n                tal:attributes="href string:${portal_url}/contact-info">site administration</a></span>.\n         </p>\n \ndiff --git a/Products/CMFPlone/browser/templates/error_message.pt b/Products/CMFPlone/browser/templates/error_message.pt\nindex f68a5d4774..bb375632f7 100644\n--- a/Products/CMFPlone/browser/templates/error_message.pt\n+++ b/Products/CMFPlone/browser/templates/error_message.pt\n@@ -31,7 +31,7 @@\n                         If you are certain you have the correct web address but are encountering an error, please\n                         contact the <span i18n:name="site_admin">\n                         <a href="#"\n-                           i18n:translate="label_site_admin"\n+                           i18n:translate="label_site_administration"\n                            tal:attributes="href string:${context/portal_url}/contact-info">site administration</a></span>.\n                     </p>\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/configure.zcml b/Products/CMFPlone/controlpanel/browser/configure.zcml\nindex fa419f3c44..1204b15af6 100644\n--- a/Products/CMFPlone/controlpanel/browser/configure.zcml\n+++ b/Products/CMFPlone/controlpanel/browser/configure.zcml\n@@ -111,32 +111,32 @@\n       permission="cmf.ManagePortal"\n       />\n \n-  <!-- Prefs Error Log Form Control Panel -->\n+  <!-- Error Log Form Control Panel -->\n   <browser:page\n-      name="prefs_error_log_form"\n+      name="error-log-form"\n       for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n-      template="prefs_error_log_form.pt"\n+      template="error_log_form.pt"\n       permission="cmf.ManagePortal"\n       />\n \n   <browser:page\n-      name="prefs_error_log_showEntry"\n+      name="error-log-show-entry"\n       for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n-      template="prefs_error_log_showEntry.pt"\n+      template="error_log_show_entry.pt"\n       permission="cmf.ManagePortal"\n       />\n \n   <browser:page\n-      name="prefs_error_log_update"\n+      name="error-log-update"\n       for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n-      class=".prefs_error_log_form.PrefsErrorLogUpdate"\n+      class=".error_log_form.ErrorLogUpdate"\n       permission="cmf.ManagePortal"\n       />\n \n   <browser:page\n-      name="prefs_error_log_setProperties"\n+      name="error-log-set-properties"\n       for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n-      class=".prefs_error_log_form.PrefsErrorLogSetProperties"\n+      class=".error_log_form.ErrorLogSetProperties"\n       permission="cmf.ManagePortal"\n       />\n \ndiff --git a/Products/CMFPlone/controlpanel/browser/error_log_form.pt b/Products/CMFPlone/controlpanel/browser/error_log_form.pt\nnew file mode 100644\nindex 0000000000..221df55ae8\n--- /dev/null\n+++ b/Products/CMFPlone/controlpanel/browser/error_log_form.pt\n@@ -0,0 +1,166 @@\n+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n+      xmlns:tal="http://xml.zope.org/namespaces/tal"\n+      xmlns:metal="http://xml.zope.org/namespaces/metal"\n+      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+      lang="en"\n+      metal:use-macro="context/prefs_main_template/macros/master"\n+      i18n:domain="plone">\n+\n+<body>\n+\n+<metal:main fill-slot="prefs_configlet_main">\n+\n+    <header>\n+      <h1 i18n:translate="heading_error_log">Error log</h1>\n+      <p class="lead" i18n:translate="description_error_log_setup">\n+        This page lists the exceptions that have occurred in this site\n+        recently. You can configure how many exceptions should be kept\n+        and whether the exceptions should be copied to Zope\'s event log\n+        file(s).\n+      </p>\n+      <p class="discreet">\n+        <a href="https://docs.plone.org/appendices/error-reference.html"\n+           i18n:translate="description_error_rerference_link">\n+          Refer to the plone.org error reference for more information about\n+          these exceptions.\n+        </a>\n+      </p>\n+    </header>\n+\n+    <div id="content-core">\n+      <div id="layout-contents">\n+\n+        <form class="mb-4" action="@@error-log-update" method="get">\n+          <fieldset class="mb-3" tal:define="entries context/error_log/getLogEntries">\n+            <div class="field" tal:condition="not:entries" i18n:translate="legend_lognoexceptions">\n+              No exceptions logged.\n+            </div>\n+\n+            <table class="table table-responsive table-bordered table-striped" tal:condition="entries">\n+              <caption i18n:translate="summary_exception_log">Error Log (most recent first)</caption>\n+\n+              <thead>\n+                <tr>\n+                  <th i18n:translate="label_time">Time</th>\n+                  <th i18n:translate="label_user_name">User Name</th>\n+                  <th i18n:translate="label_exception">Exception</th>\n+                </tr>\n+              </thead>\n+\n+              <tbody tal:define="member context/@@plone_portal_state/member;\n+                                 updatetime python:member.getProperty(\'error_log_update\', 0.0);\n+                                 updatetime python:updatetime and updatetime or 0.0;\n+                                 updatetime python:float(updatetime)">\n+\n+                <tal:entry tal:repeat="entry entries">\n+                  <tr tal:define="oddrow repeat/entry/odd;"\n+                      tal:attributes="class python: oddrow and \'odd\' or \'even\'"\n+                      tal:condition="python: entry[\'time\'] > updatetime">\n+\n+                    <td tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;"\n+                        tal:content="python:toLocalizedTime(entry[\'time\'], long_format=True)">13:04:41</td>\n+                    <td tal:content="string:${entry/username} (${entry/userid})">joe</td>\n+                    <td>\n+                      <a href="showEntry"\n+                         tal:attributes="href string:@@error-log-show-entry?id=${entry/id}">\n+                        <span tal:replace="entry/type">AttributeError</span>:\n+                        <span tal:define="value entry/value"\n+                              tal:content="python: len(value) &lt; 70 and value or value[:70] + \'...\'">\n+                          Application object has no attribute "gak"\n+                        </span>\n+                      </a>\n+                    </td>\n+                  </tr>\n+                </tal:entry>\n+              </tbody>\n+            </table>\n+\n+          </fieldset>\n+        </form>\n+\n+        <form class="mb-4" action="@@error-log-update" method="get">\n+          <fieldset class="mb-3">\n+            <legend i18n:translate="label_search_entry">\n+              Search for an error log entry <span class="formHelp"> (such as "1257962690.640.49636048561")\n+            </legend>\n+\n+            <div class="mb-3 field widget-mode-input">\n+              <input type="text"\n+                     name="search_entry"\n+                     id="search_entry"\n+                     class="form-control text-widget textline-field"/>\n+            </div>\n+\n+            <div class="formControls">\n+              <input class="btn btn-primary"\n+                     type="submit"\n+                     name="form.button.search"\n+                     value="Search"\n+                     i18n:attributes="value label_search;" />\n+            </div>\n+\n+          </fieldset>\n+        </form>\n+\n+        <hr />\n+\n+        <form class="mb-4" action="@@error-log-set-properties" method="post">\n+          <fieldset class="mb-3" tal:define="props context/error_log/getProperties">\n+\n+            <legend i18n:translate="legend_logdetails">Log details</legend>\n+\n+            <div class="mb-3 field widget-mode-input">\n+              <label class="form-label" for="keep_entries"\n+                     i18n:translate="label_number_exceptions">Number of exceptions to keep</label>\n+\n+              <input type="text"\n+                     name="keep_entries"\n+                     id="keep_entries"\n+                     class="form-control text-widget textline-field"\n+                     tal:attributes="value props/keep_entries" />\n+            </div>\n+\n+            <div class="mb-3 form-check">\n+              <input type="checkbox"\n+                     class="form-check-input single-checkbox-bool-widget bool-field"\n+                     id="cb_copy_to_zlog"\n+                     name="copy_to_zlog"\n+                     tal:attributes="checked props/copy_to_zlog;\n+                                     disabled not:context/error_log/checkEventLogPermission|nothing" />\n+\n+              <label class="form-check-label" for="cb_copy_to_zlog" i18n:translate="label_copy_exceptions">\n+                Copy exceptions to the event log\n+              </label>\n+            </div>\n+\n+            <div class="mb-3 field widget-mode-input">\n+              <label class="form-label" for="ignored_exceptions"\n+                     i18n:translate="label_ignored_exception">Ignored exception types</label>\n+\n+              <br>\n+              <textarea name="ignored_exceptions:lines"\n+                        id="ignored_exceptions"\n+                        cols="40"\n+                        rows="3"\n+                        class="form-control textarea-widget list-field"\n+                        tal:content="python: \'\\n\'.join(props[\'ignored_exceptions\'])"></textarea>\n+            </div>\n+\n+            <div class="formControls">\n+              <input class="btn btn-primary"\n+                     type="submit"\n+                     name="submit"\n+                     value="Save"\n+                     i18n:attributes="value label_save;" />\n+            </div>\n+\n+          </fieldset>\n+        </form>\n+\n+      </div>\n+    </div>\n+\n+</metal:main>\n+\n+</body>\n+</html>\ndiff --git a/Products/CMFPlone/controlpanel/browser/prefs_error_log_form.py b/Products/CMFPlone/controlpanel/browser/error_log_form.py\nsimilarity index 81%\nrename from Products/CMFPlone/controlpanel/browser/prefs_error_log_form.py\nrename to Products/CMFPlone/controlpanel/browser/error_log_form.py\nindex d73f68cbd5..c2d2d2f495 100644\n--- a/Products/CMFPlone/controlpanel/browser/prefs_error_log_form.py\n+++ b/Products/CMFPlone/controlpanel/browser/error_log_form.py\n@@ -3,10 +3,9 @@\n from Products.CMFPlone import PloneMessageFactory as _\n from Products.CMFPlone.utils import safe_nativestring\n from Products.Five import BrowserView\n-from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n \n \n-class PrefsErrorLogUpdate(BrowserView):\n+class ErrorLogUpdate(BrowserView):\n \n     def __call__(self):\n         member = api.user.get_current()\n@@ -16,24 +15,24 @@ def __call__(self):\n             if search == \'\':\n                 member.setProperties(error_log_update=0.0)\n                 self.context.plone_utils.addPortalMessage(_(\'Showing all entries\'))\n-                return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/prefs_error_log_form\')\n-            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/prefs_error_log_showEntry?id=%s\' % search)\n+                return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\n+            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-show-entry?id=%s\' % search)\n \n         elif getattr(self.request, \'form.button.showall\', None) is not None:\n             member.setProperties(error_log_update=0.0)\n             self.context.plone_utils.addPortalMessage(_(\'Showing all entries\'))\n-            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/prefs_error_log_form\')\n+            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\n \n         elif getattr(self.request, \'form.button.clear\', None) is not None:\n             member.setProperties(error_log_update=DateTime().timeTime())\n             self.context.plone_utils.addPortalMessage(_(\'Entries cleared\'))\n-            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/prefs_error_log_form\')\n+            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\n \n         else:\n-            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/prefs_error_log_form\')\n+            return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\n \n \n-class PrefsErrorLogSetProperties(BrowserView):\n+class ErrorLogSetProperties(BrowserView):\n \n     def __call__(self):\n         keep_entries = self.request.form.get(\'keep_entries\')\n@@ -44,4 +43,4 @@ def __call__(self):\n         self.context.error_log.setProperties(keep_entries, copy_to_zlog, ignored_exceptions)\n         self.context.plone_utils.addPortalMessage(_(\'Changes made.\'))\n \n-        return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/prefs_error_log_form\')\n+        return self.request.RESPONSE.redirect(self.context.absolute_url() + \'/@@error-log-form\')\ndiff --git a/Products/CMFPlone/controlpanel/browser/prefs_error_log_showEntry.pt b/Products/CMFPlone/controlpanel/browser/error_log_show_entry.pt\nsimilarity index 98%\nrename from Products/CMFPlone/controlpanel/browser/prefs_error_log_showEntry.pt\nrename to Products/CMFPlone/controlpanel/browser/error_log_show_entry.pt\nindex dbaa22cfff..2e89da22ba 100644\n--- a/Products/CMFPlone/controlpanel/browser/prefs_error_log_showEntry.pt\n+++ b/Products/CMFPlone/controlpanel/browser/error_log_show_entry.pt\n@@ -20,7 +20,7 @@\n     <div id="content-core">\n         <a href=""\n            class="link-parent"\n-           tal:attributes="href string:$portal_url/prefs_error_log_form"\n+           tal:attributes="href string:$portal_url/@@error-log-form"\n            i18n:translate="label_back_to_errorlog">\n         Back to Error Log\n         </a>\ndiff --git a/Products/CMFPlone/controlpanel/browser/prefs_error_log_form.pt b/Products/CMFPlone/controlpanel/browser/prefs_error_log_form.pt\ndeleted file mode 100644\nindex 4a6f2cc652..0000000000\n--- a/Products/CMFPlone/controlpanel/browser/prefs_error_log_form.pt\n+++ /dev/null\n@@ -1,184 +0,0 @@\n-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"\n-      xmlns:tal="http://xml.zope.org/namespaces/tal"\n-      xmlns:metal="http://xml.zope.org/namespaces/metal"\n-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n-      lang="en"\n-      metal:use-macro="context/prefs_main_template/macros/master"\n-      i18n:domain="plone">\n-\n-<body>\n-\n-<metal:main fill-slot="prefs_configlet_main">\n-\n-    <h1 class="documentFirstHeading"\n-        i18n:translate="heading_error_log">Error log</h1>\n-\n-    <div class="documentDescription" i18n:translate="description_error_log_setup">\n-        This page lists the exceptions that have occurred in this site\n-        recently. You can configure how many exceptions should be kept\n-        and whether the exceptions should be copied to Zope\'s event log\n-        file(s).\n-    </div>\n-\n-    <div id="content-core">\n-\n-        <p>\n-            <a href="https://docs.plone.org/appendices/error-reference.html"\n-               i18n:translate="description_error_rerference_link">\n-                Refer to the plone.org error reference for more information about\n-                these exceptions.\n-            </a>\n-        </p>\n-\n-        <form action="prefs_error_log_update" method="get">\n-\n-            <fieldset tal:define="entries context/error_log/getLogEntries">\n-\n-                <legend i18n:translate="legend_logexception">Exception Log (most recent first)</legend>\n-\n-                <div class="field">\n-                    <label for="search_entry"\n-                           i18n:translate="label_search_entry">Search for an error log entry <span class="formHelp"> (such as "1257962690.640.49636048561")</span></label>\n-\n-                    <input type="text"\n-                           name="search_entry"\n-                           id="search_entry"\n-                           size="35" />\n-                </div>\n-\n-                <div class="field" tal:condition="not:entries" i18n:translate="legend_lognoexceptions">\n-                    No exceptions logged.\n-                </div>\n-\n-                <div class="formControls">\n-                    <input class="btn btn-primary"\n-                           type="submit"\n-                           name="form.button.search"\n-                           value="Search"\n-                           i18n:attributes="value label_search;" />\n-                    <input class="btn btn-secondary"\n-                           type="submit"\n-                           name="form.button.refresh"\n-                           value="Refresh"\n-                           i18n:attributes="value label_refresh;" />\n-                    <input class="btn btn-secondary"\n-                           type="submit"\n-                           name="form.button.clear"\n-                           value="Clear Displayed Entries"\n-                           i18n:attributes="value label_clear_displayed_entries;" />\n-                    <input class="btn btn-secondary"\n-                           type="submit"\n-                           name="form.button.showall"\n-                           value="Show all entries"\n-                           i18n:attributes="value label_show_all_entries;" />\n-                </div>\n-\n-                <table class="listing"\n-                       id="sortable"\n-                       summary="Exception Log (most recent first)"\n-                       i18n:attributes="summary summary_exception_log;"\n-                       tal:condition="entries">\n-                    <thead>\n-                        <tr>\n-                            <th i18n:translate="label_time">Time</th>\n-                            <th i18n:translate="label_user_name">User Name</th>\n-                            <th i18n:translate="label_exception">Exception</th>\n-                        </tr>\n-                    </thead>\n-\n-                    <tbody tal:define="member context/@@plone_portal_state/member;\n-                                       updatetime python:member.getProperty(\'error_log_update\', 0.0);\n-                                       updatetime python:updatetime and updatetime or 0.0;\n-                                       updatetime python:float(updatetime)">\n-\n-                        <tal:entry tal:repeat="entry entries">\n-                        <tr tal:define="oddrow repeat/entry/odd;"\n-                            tal:attributes="class python: oddrow and \'odd\' or \'even\'"\n-                            tal:condition="python: entry[\'time\'] > updatetime">\n-\n-                            <td\n-                                tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;"\n-                                tal:content="python:toLocalizedTime(entry[\'time\'], long_format=True)">13:04:41</td>\n-                            <td tal:content="string:${entry/username} (${entry/userid})">joe</td>\n-                            <td>\n-                                <a href="showEntry"\n-                                   tal:attributes="href string:prefs_error_log_showEntry?id=${entry/id}">\n-                                    <span tal:replace="entry/type">AttributeError</span>:\n-                                    <span tal:define="value entry/value"\n-                                          tal:content="python: len(value) &lt; 70 and value or value[:70] + \'...\'">\n-                                    Application object has no attribute "gak"\n-                                    </span>\n-                                </a>\n-                            </td>\n-                        </tr>\n-                        </tal:entry>\n-                    </tbody>\n-                </table>\n-\n-            </fieldset>\n-        </form>\n-\n-        <form action="prefs_error_log_setProperties"\n-              method="post"\n-              class="pat-formunloadalert">\n-\n-            <fieldset tal:define="props context/error_log/getProperties">\n-\n-                <legend i18n:translate="legend_logdetails">Log details</legend>\n-\n-                <div class="field">\n-                    <label for="keep_entries"\n-                           i18n:translate="label_number_exceptions">Number of exceptions to keep</label>\n-\n-                    <div></div>\n-\n-                    <input type="text"\n-                           name="keep_entries"\n-                           id="keep_entries"\n-                           size="40"\n-                           tal:attributes="value props/keep_entries" />\n-                </div>\n-\n-                <div class="field">\n-                    <input type="checkbox"\n-                           class="noborder"\n-                           id="cb_copy_to_zlog"\n-                           name="copy_to_zlog"\n-                           tal:attributes="checked props/copy_to_zlog;\n-                                           disabled not:context/error_log/checkEventLogPermission|nothing" />\n-\n-                    <label for="cb_copy_to_zlog" i18n:translate="label_copy_exceptions">\n-                        Copy exceptions to the event log\n-                    </label>\n-\n-                </div>\n-\n-                <div class="field">\n-                    <label for="ignored_exceptions"\n-                           i18n:translate="label_ignored_exception">Ignored exception types</label>\n-\n-                    <br>\n-                    <textarea name="ignored_exceptions:lines"\n-                              id="ignored_exceptions"\n-                              cols="40"\n-                              rows="3"\n-                              tal:content="python: \'\\n\'.join(props[\'ignored_exceptions\'])"></textarea>\n-                </div>\n-\n-                <div class="formControls">\n-                    <input class="btn btn-primary"\n-                           type="submit"\n-                           name="submit"\n-                           value="Save"\n-                           i18n:attributes="value label_save;" />\n-                </div>\n-\n-            </fieldset>\n-\n-        </form>\n-    </div>\n-\n-</metal:main>\n-\n-</body>\n-</html>\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py\nindex 848a9e721d..ae797cd070 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_error_log.py\n@@ -41,8 +41,8 @@ def test_error_log_control_panel_link(self):\n         self.browser.open("%s/@@overview-controlpanel" % self.portal_url)\n         self.browser.getLink(\'Errors\').click()\n \n-        self.assertEqual(self.browser.url, "%s/prefs_error_log_form" % self.portal_url)\n-        self.assertIn(\'<h1 class="documentFirstHeading">Error log</h1>\', self.browser.contents)\n+        self.assertEqual(self.browser.url, "%s/@@error-log-form" % self.portal_url)\n+        self.assertIn(\'<h1>Error log</h1>\', self.browser.contents)\n \n     def test_error_log_set_properties(self):\n         self.assertEqual(self.error_log_properties[\'keep_entries\'], 20)\n@@ -55,7 +55,7 @@ def test_error_log_set_properties(self):\n         }\n \n         set_properties_view = getMultiAdapter((self.portal, self.request),\n-                                name=\'prefs_error_log_setProperties\')\n+                                name=\'error-log-set-properties\')\n         set_properties_view()\n \n         error_log_properties = self.portal.error_log.getProperties()\ndiff --git a/Products/CMFPlone/profiles/default/controlpanel.xml b/Products/CMFPlone/profiles/default/controlpanel.xml\nindex fd652eb20b..1cf104e4b7 100644\n--- a/Products/CMFPlone/profiles/default/controlpanel.xml\n+++ b/Products/CMFPlone/profiles/default/controlpanel.xml\n@@ -88,7 +88,7 @@\n  <configlet title="Errors" action_id="errorLog" appId="ErrorLog"\n     category="plone-security" condition_expr=""\n     icon_expr="string:exclamation-square"\n-    url_expr="string:${portal_url}/prefs_error_log_form" visible="True"\n+    url_expr="string:${portal_url}/@@error-log-form" visible="True"\n     i18n:attributes="title">\n   <permission>Manage portal</permission>\n  </configlet>\ndiff --git a/Products/CMFPlone/tests/robot/robodoc/config-screens.robot b/Products/CMFPlone/tests/robot/robodoc/config-screens.robot\nindex 230a0e4552..c810bec965 100644\n--- a/Products/CMFPlone/tests/robot/robodoc/config-screens.robot\n+++ b/Products/CMFPlone/tests/robot/robodoc/config-screens.robot\n@@ -78,7 +78,7 @@ Show Editing setup screen\n     ...  css=#content\n \n Show Error log setup screen\n-    Go to  ${PLONE_URL}/prefs_error_log_form\n+    Go to  ${PLONE_URL}/@@error-log-form\n     Capture and crop page screenshot\n     ...  ${CURDIR}/_robot/errorlog-setup.png\n     ...  css=#content\n@@ -213,4 +213,4 @@ Changing the logo\n     Capture and crop page screenshot\n     ...    ${CURDIR}/_robot/change-logo-in-site-control-panel.png\n     ...    css=#content\n-    ...    css=#formfield-form-widgets-site_logo\n\\ No newline at end of file\n+    ...    css=#formfield-form-widgets-site_logo\ndiff --git a/news/3393.enhancement b/news/3393.enhancement\nnew file mode 100644\nindex 0000000000..de652bdf6c\n--- /dev/null\n+++ b/news/3393.enhancement\n@@ -0,0 +1,3 @@\n+Update Controlpanel Error Log Form Layout\n+Rename ControlPanel Error Log Form View prefs_error_log_form -> error-log-form\n+[jmevissen]\ndiff --git a/news/3397.bugfix b/news/3397.bugfix\nnew file mode 100644\nindex 0000000000..db8c105e7f\n--- /dev/null\n+++ b/news/3397.bugfix\n@@ -0,0 +1 @@\n+Use label_site_administration instead of label_site_admin in error and mail_password_form templates\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-01-20T09:48:46+01:00
Author: Florian Danzmann (talarias) <talarias@live.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/a3c0b27ccfd97f1f109ae75d5acb38754f457711

Merge branch 'master' into plip-barceloneta_lts_favicon

Files changed:
A news/3146.feature
M Products/CMFPlone/browser/ploneview.py
M Products/CMFPlone/tests/testPloneView.py

b"diff --git a/Products/CMFPlone/browser/ploneview.py b/Products/CMFPlone/browser/ploneview.py\nindex 7bae74eb74..c9735e95c8 100644\n--- a/Products/CMFPlone/browser/ploneview.py\n+++ b/Products/CMFPlone/browser/ploneview.py\n@@ -211,3 +211,7 @@ def patterns_settings(self):\n         return getMultiAdapter(\n             (context, self.request),\n             name='plone_patterns_settings')()\n+\n+    @property\n+    def human_readable_size(self):\n+        return utils.human_readable_size\ndiff --git a/Products/CMFPlone/tests/testPloneView.py b/Products/CMFPlone/tests/testPloneView.py\nindex 4f68681a98..5efdcc84bd 100644\n--- a/Products/CMFPlone/tests/testPloneView.py\n+++ b/Products/CMFPlone/tests/testPloneView.py\n@@ -151,3 +151,8 @@ def testCropText(self):\n     def testSiteEncoding(self):\n         view = Plone(self.portal, self.app.REQUEST)\n         self.assertEqual('utf-8', view.site_encoding())\n+\n+    def test_human_readable_size(self):\n+        view = Plone(self.portal, self.app.REQUEST)\n+        from Products.CMFPlone.utils import human_readable_size\n+        self.assertIs(view.human_readable_size, human_readable_size)\ndiff --git a/news/3146.feature b/news/3146.feature\nnew file mode 100644\nindex 0000000000..49a34411e5\n--- /dev/null\n+++ b/news/3146.feature\n@@ -0,0 +1,2 @@\n+The @@plone view exposes the human_readable_size helper\n+[ale-rt]\n"

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2022-01-20T17:06:10+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/eb4a4443550dedd85e21669e8bc6a07efd8e883d

Merge pull request #3389 from plone/plip-barceloneta_lts_favicon

add favicon

Files changed:
A Products/CMFPlone/browser/favicon.py
A news/plip-barceloneta_lts_favicon.feature
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/controlpanel/browser/site.py
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/profiles/default/viewlets.xml

b'diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml\nindex 313c944bab..f92dbef537 100644\n--- a/Products/CMFPlone/browser/configure.zcml\n+++ b/Products/CMFPlone/browser/configure.zcml\n@@ -32,6 +32,13 @@\n       permission="zope.Public"\n       />\n \n+  <browser:page\n+      for="*"\n+      name="favicon"\n+      class=".favicon.SiteFavicon"\n+      permission="zope.Public"\n+      />\n+\n   <browser:page\n       for="*"\n       name="sendto_form"\ndiff --git a/Products/CMFPlone/browser/favicon.py b/Products/CMFPlone/browser/favicon.py\nnew file mode 100644\nindex 0000000000..2753869081\n--- /dev/null\n+++ b/Products/CMFPlone/browser/favicon.py\n@@ -0,0 +1,26 @@\n+from Products.CMFPlone.interfaces import ISiteSchema\n+from plone.formwidget.namedfile.converter import b64decode_file\n+from plone.namedfile.browser import Download\n+from plone.namedfile.file import NamedImage\n+from plone.registry.interfaces import IRegistry\n+from zope.component import getUtility\n+from plone.memoize import ram\n+\n+\n+class SiteFavicon(Download):\n+\n+    def __init__(self, context, request):\n+        super().__init__(context, request)\n+        self.filename = None\n+        self.data = None\n+\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(ISiteSchema, prefix="plone")\n+        if getattr(settings, \'site_favicon\', False):\n+            filename, data = b64decode_file(settings.site_favicon)\n+            data = NamedImage(data=data, filename=filename)\n+            self.data = data\n+            self.filename = filename\n+\n+    def _getFile(self):\n+        return self.data\ndiff --git a/Products/CMFPlone/controlpanel/browser/site.py b/Products/CMFPlone/controlpanel/browser/site.py\nindex 269fe1b029..f87c056104 100644\n--- a/Products/CMFPlone/controlpanel/browser/site.py\n+++ b/Products/CMFPlone/controlpanel/browser/site.py\n@@ -16,6 +16,7 @@ class SiteControlPanelForm(controlpanel.RegistryEditForm):\n     def updateFields(self):\n         super().updateFields()\n         self.fields[\'site_logo\'].widgetFactory = NamedImageFieldWidget\n+        self.fields[\'site_favicon\'].widgetFactory = NamedImageFieldWidget\n \n     def updateWidgets(self):\n         super().updateWidgets()\ndiff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py\nindex 09b96721d0..13c4139873 100644\n--- a/Products/CMFPlone/interfaces/controlpanel.py\n+++ b/Products/CMFPlone/interfaces/controlpanel.py\n@@ -1005,6 +1005,19 @@ class ISiteSchema(Interface):\n         required=False,\n     )\n \n+    site_favicon_mimetype = schema.TextLine(\n+        title=_(\'MIME type of the site favicon\'),\n+        description=_(\'MIME type of the favicon (automatically set when a new favicon is uploaded)\'),\n+        required=False,\n+        default=\'image/x-icon\'\n+    )\n+\n+    site_favicon = schema.Bytes(\n+        title=_(\'Site Favicon\'),\n+        description=_(\'This shows a custom favicon on your site.\'),\n+        required=False,\n+    )\n+\n     exposeDCMetaTags = schema.Bool(\n         title=_(\'Expose Dublin Core metadata\'),\n         description=_(\'Exposes the Dublin Core properties as metatags.\'),\ndiff --git a/Products/CMFPlone/profiles/default/viewlets.xml b/Products/CMFPlone/profiles/default/viewlets.xml\nindex 4e86ae7d91..7a9c503cbc 100644\n--- a/Products/CMFPlone/profiles/default/viewlets.xml\n+++ b/Products/CMFPlone/profiles/default/viewlets.xml\n@@ -7,6 +7,7 @@\n     <viewlet name="plone.anontools" />\n     <viewlet name="plone.membertools" />\n     <viewlet name="plone.logo" />\n+    <viewlet name="plone.favicon" />\n     <viewlet name="plone.searchbox" />\n     <viewlet name="plone.app.i18n.locales.languageselector" />\n     <viewlet name="plone.app.multilingual.languageselector" />\ndiff --git a/news/plip-barceloneta_lts_favicon.feature b/news/plip-barceloneta_lts_favicon.feature\nnew file mode 100644\nindex 0000000000..6ce2a7bf34\n--- /dev/null\n+++ b/news/plip-barceloneta_lts_favicon.feature\n@@ -0,0 +1,3 @@\n+add a new entry in site-controlpanel to change the favicon and its MIME-type\n+The favicon can be a .ico/png or SVG-file\n+[talarias]\n\\ No newline at end of file\n'

