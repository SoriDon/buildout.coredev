Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2022-05-09T15:32:39+02:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.dexterity/commit/9ff07c63d45060581b9fc139d7af0690c581d38c

Don't acquire .language from portal root.

Files changed:
M plone/app/dexterity/behaviors/metadata.py

b'diff --git a/plone/app/dexterity/behaviors/metadata.py b/plone/app/dexterity/behaviors/metadata.py\nindex 8eabe5b..88555d6 100644\n--- a/plone/app/dexterity/behaviors/metadata.py\n+++ b/plone/app/dexterity/behaviors/metadata.py\n@@ -38,22 +38,27 @@ def default_language(context):\n     # this new content is being added\n     language = None\n \n-    if context is not None and not IPloneSiteRoot.providedBy(context):\n-        language = context.Language()\n-        if not language:\n+    # Try to get the language from context or parent(s)\n+    while context is not None and not IPloneSiteRoot.providedBy(context):\n+        try:\n+            # Use aq_base so the .language attribute isn\'t acquired from root\n+            language = context.aq_base.Language()\n+        except AttributeError:  # Accesses .language\n             # If we are here, it means we were editing an object that didn\'t\n             # have its language set or that the container where we were adding\n             # the new content didn\'t have a language set. So we check its\n-            # parent, unless we are at site\'s root, in which case we get site\'s\n-            # default language\n-            if not IPloneSiteRoot.providedBy(context.aq_parent):\n-                language = context.aq_parent.Language()\n+            # parent.\n+            context = context.__parent__\n+\n+    pl = getToolByName(getSite(), \'portal_languages\')\n+    default_language = pl.getDefaultLanguage()\n \n     if not language:\n-        # Finally, if we still don\'t have a language, then just use site\'s\n-        # default\n-        pl = getToolByName(getSite(), "portal_languages")\n-        language = pl.getDefaultLanguage()\n+        language = default_language\n+\n+    # Is the language supported/enabled at all?\n+    if language not in pl.getAvailableLanguages():\n+        language = default_language\n \n     return language\n \n'

Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2022-05-09T15:36:08+02:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.dexterity/commit/3e57847488981bd7dcba9dd07e6a7399bbd4b5a6

add news

Files changed:
A news/350.bugfix

b"diff --git a/news/350.bugfix b/news/350.bugfix\nnew file mode 100644\nindex 00000000..0c3733b2\n--- /dev/null\n+++ b/news/350.bugfix\n@@ -0,0 +1,4 @@\n+\n+Don't acquire lanuage from portal root default_language for ICategorization.language.\n+Fixes https://github.com/plone/plone.app.dexterity/issues/258\n+[jaroel]\n\\ No newline at end of file\n"

Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2022-05-09T18:37:12+02:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.dexterity/commit/e0cd92002acd6f67ce98f1a3347b35bbf0f3f214

use getattr

Files changed:
M plone/app/dexterity/behaviors/metadata.py

b"diff --git a/plone/app/dexterity/behaviors/metadata.py b/plone/app/dexterity/behaviors/metadata.py\nindex 88555d6..6c75867 100644\n--- a/plone/app/dexterity/behaviors/metadata.py\n+++ b/plone/app/dexterity/behaviors/metadata.py\n@@ -39,25 +39,24 @@ def default_language(context):\n     language = None\n \n     # Try to get the language from context or parent(s)\n-    while context is not None and not IPloneSiteRoot.providedBy(context):\n-        try:\n-            # Use aq_base so the .language attribute isn't acquired from root\n-            language = context.aq_base.Language()\n-        except AttributeError:  # Accesses .language\n+    while not language and context is not None and not IPloneSiteRoot.providedBy(context):\n+        language = getattr(context.aq_base, 'language', None)\n+\n+        if not language:\n             # If we are here, it means we were editing an object that didn't\n             # have its language set or that the container where we were adding\n             # the new content didn't have a language set. So we check its\n             # parent.\n             context = context.__parent__\n \n-    pl = getToolByName(getSite(), 'portal_languages')\n-    default_language = pl.getDefaultLanguage()\n+    language_tool = getToolByName(getSite(), 'portal_languages')\n+    default_language = language_tool.getDefaultLanguage()\n \n     if not language:\n         language = default_language\n \n     # Is the language supported/enabled at all?\n-    if language not in pl.getAvailableLanguages():\n+    if language not in language_tool.getAvailableLanguages():\n         language = default_language\n \n     return language\n"

Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2022-05-09T21:42:12+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/692d932f796801325679383aeb384bf4e15ac106

Merge pull request #350 from plone/defaultlanglookup

[6.0] Don't acquire .language from portal root.

Files changed:
A news/350.bugfix
M plone/app/dexterity/behaviors/metadata.py

b'diff --git a/news/350.bugfix b/news/350.bugfix\nnew file mode 100644\nindex 00000000..0c3733b2\n--- /dev/null\n+++ b/news/350.bugfix\n@@ -0,0 +1,4 @@\n+\n+Don\'t acquire lanuage from portal root default_language for ICategorization.language.\n+Fixes https://github.com/plone/plone.app.dexterity/issues/258\n+[jaroel]\n\\ No newline at end of file\ndiff --git a/plone/app/dexterity/behaviors/metadata.py b/plone/app/dexterity/behaviors/metadata.py\nindex 8eabe5b0..6c758676 100644\n--- a/plone/app/dexterity/behaviors/metadata.py\n+++ b/plone/app/dexterity/behaviors/metadata.py\n@@ -38,22 +38,26 @@ def default_language(context):\n     # this new content is being added\n     language = None\n \n-    if context is not None and not IPloneSiteRoot.providedBy(context):\n-        language = context.Language()\n+    # Try to get the language from context or parent(s)\n+    while not language and context is not None and not IPloneSiteRoot.providedBy(context):\n+        language = getattr(context.aq_base, \'language\', None)\n+\n         if not language:\n             # If we are here, it means we were editing an object that didn\'t\n             # have its language set or that the container where we were adding\n             # the new content didn\'t have a language set. So we check its\n-            # parent, unless we are at site\'s root, in which case we get site\'s\n-            # default language\n-            if not IPloneSiteRoot.providedBy(context.aq_parent):\n-                language = context.aq_parent.Language()\n+            # parent.\n+            context = context.__parent__\n+\n+    language_tool = getToolByName(getSite(), \'portal_languages\')\n+    default_language = language_tool.getDefaultLanguage()\n \n     if not language:\n-        # Finally, if we still don\'t have a language, then just use site\'s\n-        # default\n-        pl = getToolByName(getSite(), "portal_languages")\n-        language = pl.getDefaultLanguage()\n+        language = default_language\n+\n+    # Is the language supported/enabled at all?\n+    if language not in language_tool.getAvailableLanguages():\n+        language = default_language\n \n     return language\n \n'

