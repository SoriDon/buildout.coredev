Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-24T20:37:00-05:00
Author: nathan.vangheem () <nathan.vangheem@wildcardcorp.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/03e1483dd73a23ad13f3c7f05d88ad62cde20c32

Fix custom tinymce content styles not getting included correctly

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index aa7e94c..bcae7a3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,9 @@ New:
 
 Fixes:
 
+- Fix custom tinymce content styles not getting included correctly
+  [vangheem]
+
 - Fix timing problem with robot framework tests.
   [jensens]
 
diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index f513702..ab0d06f 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -30,14 +30,16 @@ def __init__(self, context, request):
     def get_theme(self):
         return theming_policy().get_theme()
 
-    def get_content_css(self):
+    def get_content_css(self, style_css=''):
         files = [
-            '%s/++plone++static/plone-compiled.css' % self.portal_url,
-            '%s/++plone++static/tinymce-styles.css' % self.portal_url
+            '%s/++plone++static/plone-compiled.css' % self.portal_url
         ]
+        if style_css:
+            files.extend(style_css.split(','))
         content_css = self.settings.content_css or []
         for url in content_css:
-            files.append('%s/%s' % (self.portal_url, url))
+            if url and url.strip():
+                files.append('%s/%s' % (self.portal_url, url.strip()))
         theme = self.get_theme()
         if (theme and hasattr(theme, 'tinymce_content_css') and
                 theme.tinymce_content_css):
@@ -88,16 +90,24 @@ def get_all_style_formats(self):
     def get_tiny_config(self):
         settings = self.settings
 
+        importcss_file_filter = '%s/++plone++static/tinymce-styles.css' % (
+            self.portal_url)
+
+        theme = self.get_theme()
+        if theme and getattr(theme, 'tinymce_styles_css', None):
+            importcss_file_filter += ',%s/%s' % (
+                self.portal_url,
+                theme.tinymce_styles_css.lstrip('/'))
+
         tiny_config = {
             'resize': settings.resizing and 'both' or False,
-            'content_css': self.get_content_css(),
+            'content_css': self.get_content_css(importcss_file_filter),
             'plugins': ['plonelink', 'ploneimage', 'importcss'] + settings.plugins,
             'external_plugins': {},
             'toolbar': settings.toolbar,
             'entity_encoding': settings.entity_encoding,
             'importcss_append': True,
-            'importcss_file_filter': '%s/++plone++static/tinymce-styles.css' % (
-                self.portal_url)
+            'importcss_file_filter': importcss_file_filter
         }
         toolbar_additions = settings.custom_buttons or []
 
@@ -113,12 +123,6 @@ def get_tiny_config(self):
         if 'contextmenu' in settings.plugins:
             tiny_config['contextmenu'] = "plonelink ploneimage inserttable | cell row column deletetable"  # noqa
 
-        theme = self.get_theme()
-        if theme and getattr(theme, 'tinymce_styles_css', None):
-            tiny_config['importcss_file_filter'] += ',%s/%s' % (
-                self.portal_url,
-                theme.tinymce_styles_css.lstrip('/'))
-
         if settings.libraries_spellchecker_choice == 'AtD':
             mtool = getToolByName(self.portal, 'portal_membership')
             member = mtool.getAuthenticatedMember()


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-24T22:14:47-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/05cdabc787c35c78345631abba74ae48743e5ac1

Merge pull request #1329 from plone/tinymce-importcss_file_filter-fix

Fix custom tinymce content styles not getting included correctly

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index aa7e94c..bcae7a3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,9 @@ New:
 
 Fixes:
 
+- Fix custom tinymce content styles not getting included correctly
+  [vangheem]
+
 - Fix timing problem with robot framework tests.
   [jensens]
 
diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index f513702..ab0d06f 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -30,14 +30,16 @@ def __init__(self, context, request):
     def get_theme(self):
         return theming_policy().get_theme()
 
-    def get_content_css(self):
+    def get_content_css(self, style_css=''):
         files = [
-            '%s/++plone++static/plone-compiled.css' % self.portal_url,
-            '%s/++plone++static/tinymce-styles.css' % self.portal_url
+            '%s/++plone++static/plone-compiled.css' % self.portal_url
         ]
+        if style_css:
+            files.extend(style_css.split(','))
         content_css = self.settings.content_css or []
         for url in content_css:
-            files.append('%s/%s' % (self.portal_url, url))
+            if url and url.strip():
+                files.append('%s/%s' % (self.portal_url, url.strip()))
         theme = self.get_theme()
         if (theme and hasattr(theme, 'tinymce_content_css') and
                 theme.tinymce_content_css):
@@ -88,16 +90,24 @@ def get_all_style_formats(self):
     def get_tiny_config(self):
         settings = self.settings
 
+        importcss_file_filter = '%s/++plone++static/tinymce-styles.css' % (
+            self.portal_url)
+
+        theme = self.get_theme()
+        if theme and getattr(theme, 'tinymce_styles_css', None):
+            importcss_file_filter += ',%s/%s' % (
+                self.portal_url,
+                theme.tinymce_styles_css.lstrip('/'))
+
         tiny_config = {
             'resize': settings.resizing and 'both' or False,
-            'content_css': self.get_content_css(),
+            'content_css': self.get_content_css(importcss_file_filter),
             'plugins': ['plonelink', 'ploneimage', 'importcss'] + settings.plugins,
             'external_plugins': {},
             'toolbar': settings.toolbar,
             'entity_encoding': settings.entity_encoding,
             'importcss_append': True,
-            'importcss_file_filter': '%s/++plone++static/tinymce-styles.css' % (
-                self.portal_url)
+            'importcss_file_filter': importcss_file_filter
         }
         toolbar_additions = settings.custom_buttons or []
 
@@ -113,12 +123,6 @@ def get_tiny_config(self):
         if 'contextmenu' in settings.plugins:
             tiny_config['contextmenu'] = "plonelink ploneimage inserttable | cell row column deletetable"  # noqa
 
-        theme = self.get_theme()
-        if theme and getattr(theme, 'tinymce_styles_css', None):
-            tiny_config['importcss_file_filter'] += ',%s/%s' % (
-                self.portal_url,
-                theme.tinymce_styles_css.lstrip('/'))
-
         if settings.libraries_spellchecker_choice == 'AtD':
             mtool = getToolByName(self.portal, 'portal_membership')
             member = mtool.getAuthenticatedMember()


