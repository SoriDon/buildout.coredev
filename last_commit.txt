Repository: plone.app.versioningbehavior


Branch: refs/heads/master
Date: 2015-11-22T01:53:18+01:00
Author: Rafael Oliveira (rafaelbco) <rafaelbco@gmail.com>
Commit: https://github.com/plone/plone.app.versioningbehavior/commit/fb583a6cea9699fd47496045f4a3a5c9ceaa1fdb

Fixes #10: Views for Image and File versions don't work.

Files changed:
M CHANGES.rst
M plone/app/versioningbehavior/browser.py
M plone/app/versioningbehavior/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 7161ff2..7654f29 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -9,6 +9,9 @@ Fixes:
 - Update Italian translations
   [ale-rt, cekk]
 
+- Fixes #10: Views for Image and File versions don't work.
+  [rafaelbco]
+
 
 1.2.5 (2015-09-20)
 ------------------
@@ -16,6 +19,7 @@ Fixes:
 - Update French translations
   [enclope]
 
+
 1.2.4 (2015-09-11)
 ------------------
 
diff --git a/plone/app/versioningbehavior/browser.py b/plone/app/versioningbehavior/browser.py
index 3ecaef6..7e74c28 100644
--- a/plone/app/versioningbehavior/browser.py
+++ b/plone/app/versioningbehavior/browser.py
@@ -9,15 +9,31 @@
 
 class VersionView(object):
 
+    download_url_patterns = (
+        re.compile(r'/@@download/(?P<field_id>.*?)/(?P<filename>.*?)"'),
+        re.compile(
+            r'/versions_history_form/'
+            r'\+\+widget\+\+form\.widgets\.(?P<field_id>.*?)'
+            r'/@@download/(?P<filename>.*?)"'
+        ),
+    )
+
+    version_of_namedfile_template = (
+        r'/@@download-version?'
+        r'field_id=\g<field_id>&filename=\g<filename>&version_id={version_id}"'
+    )
+
     def __call__(self):
         version_id = self.request.version_id
         content_core_view = getMultiAdapter((self.context, self.request), name='content-core')
         html = content_core_view()
-        return re.sub(
-            r'''/@@download/(?P<field_id>.*?)/(?P<filename>.*?)"''',
-            r'''/@@download-version?field_id=\g<field_id>&filename=\g<filename>&version_id=''' + version_id + '"',
-            html
-        )
+        transformed_html = html
+
+        for pattern in self.download_url_patterns:
+            repl = self.version_of_namedfile_template.format(version_id=version_id)
+            transformed_html = pattern.sub(repl, html)
+
+        return transformed_html
 
 
 class DownloadVersion(object):
diff --git a/plone/app/versioningbehavior/configure.zcml b/plone/app/versioningbehavior/configure.zcml
index b9f4ad2..0d7cbbf 100644
--- a/plone/app/versioningbehavior/configure.zcml
+++ b/plone/app/versioningbehavior/configure.zcml
@@ -60,7 +60,7 @@
           for="plone.dexterity.interfaces.IDexterityContent"
           name="download-version"
           permission="zope2.View"
-          class=".browser.VersionView"
+          class=".browser.DownloadVersion"
           />
 
     <genericsetup:registerProfile


Repository: plone.app.versioningbehavior


Branch: refs/heads/master
Date: 2015-11-22T01:53:18+01:00
Author: Rafael Oliveira (rafaelbco) <rafaelbco@gmail.com>
Commit: https://github.com/plone/plone.app.versioningbehavior/commit/40927feb079a833c1a2b7f6b5cb99c8b2d4421a0

@@version-view: Handle file fields defined in behaviors when converting download URLs.

Files changed:
M plone/app/versioningbehavior/browser.py

diff --git a/plone/app/versioningbehavior/browser.py b/plone/app/versioningbehavior/browser.py
index 7e74c28..2999e9a 100644
--- a/plone/app/versioningbehavior/browser.py
+++ b/plone/app/versioningbehavior/browser.py
@@ -11,6 +11,14 @@ class VersionView(object):
 
     download_url_patterns = (
         re.compile(r'/@@download/(?P<field_id>.*?)/(?P<filename>.*?)"'),
+
+        # Behavior name before field name, like "LeadImage.image"
+        re.compile(
+            r'/versions_history_form/'
+            r'\+\+widget\+\+form\.widgets\.\S+\.(?P<field_id>.*?)'
+            r'/@@download/(?P<filename>.*?)"'
+        ),
+
         re.compile(
             r'/versions_history_form/'
             r'\+\+widget\+\+form\.widgets\.(?P<field_id>.*?)'
@@ -31,7 +39,7 @@ def __call__(self):
 
         for pattern in self.download_url_patterns:
             repl = self.version_of_namedfile_template.format(version_id=version_id)
-            transformed_html = pattern.sub(repl, html)
+            transformed_html = pattern.sub(repl, transformed_html)
 
         return transformed_html
 
@@ -44,7 +52,10 @@ def __call__(self):
         filename = self.request.filename
         repository = getToolByName(self.context, 'portal_repository')
         old_obj = repository.retrieve(self.context, version_id).object
-        file_ = getattr(old_obj, field_id)
+
+        # Will only work if the file is stored as an attribute with the same
+        # name of the field.
+        file_ = getattr(old_obj, field_id, None)
 
         if file_ is None:
             raise NotFound(self, filename, self.request)


Repository: plone.app.versioningbehavior


Branch: refs/heads/master
Date: 2015-11-25T12:17:45+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.forcada@freitag.de>
Commit: https://github.com/plone/plone.app.versioningbehavior/commit/1bb4988923c4b4e4e048a6a04ff9831a97ada7ef

Merge pull request #20 from syslabcom/master

Refs #18 - Fix for Views for Image and File versions don't work.

Files changed:
M CHANGES.rst
M plone/app/versioningbehavior/browser.py
M plone/app/versioningbehavior/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 7161ff2..7654f29 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -9,6 +9,9 @@ Fixes:
 - Update Italian translations
   [ale-rt, cekk]
 
+- Fixes #10: Views for Image and File versions don't work.
+  [rafaelbco]
+
 
 1.2.5 (2015-09-20)
 ------------------
@@ -16,6 +19,7 @@ Fixes:
 - Update French translations
   [enclope]
 
+
 1.2.4 (2015-09-11)
 ------------------
 
diff --git a/plone/app/versioningbehavior/browser.py b/plone/app/versioningbehavior/browser.py
index 3ecaef6..2999e9a 100644
--- a/plone/app/versioningbehavior/browser.py
+++ b/plone/app/versioningbehavior/browser.py
@@ -9,15 +9,39 @@
 
 class VersionView(object):
 
+    download_url_patterns = (
+        re.compile(r'/@@download/(?P<field_id>.*?)/(?P<filename>.*?)"'),
+
+        # Behavior name before field name, like "LeadImage.image"
+        re.compile(
+            r'/versions_history_form/'
+            r'\+\+widget\+\+form\.widgets\.\S+\.(?P<field_id>.*?)'
+            r'/@@download/(?P<filename>.*?)"'
+        ),
+
+        re.compile(
+            r'/versions_history_form/'
+            r'\+\+widget\+\+form\.widgets\.(?P<field_id>.*?)'
+            r'/@@download/(?P<filename>.*?)"'
+        ),
+    )
+
+    version_of_namedfile_template = (
+        r'/@@download-version?'
+        r'field_id=\g<field_id>&filename=\g<filename>&version_id={version_id}"'
+    )
+
     def __call__(self):
         version_id = self.request.version_id
         content_core_view = getMultiAdapter((self.context, self.request), name='content-core')
         html = content_core_view()
-        return re.sub(
-            r'''/@@download/(?P<field_id>.*?)/(?P<filename>.*?)"''',
-            r'''/@@download-version?field_id=\g<field_id>&filename=\g<filename>&version_id=''' + version_id + '"',
-            html
-        )
+        transformed_html = html
+
+        for pattern in self.download_url_patterns:
+            repl = self.version_of_namedfile_template.format(version_id=version_id)
+            transformed_html = pattern.sub(repl, transformed_html)
+
+        return transformed_html
 
 
 class DownloadVersion(object):
@@ -28,7 +52,10 @@ def __call__(self):
         filename = self.request.filename
         repository = getToolByName(self.context, 'portal_repository')
         old_obj = repository.retrieve(self.context, version_id).object
-        file_ = getattr(old_obj, field_id)
+
+        # Will only work if the file is stored as an attribute with the same
+        # name of the field.
+        file_ = getattr(old_obj, field_id, None)
 
         if file_ is None:
             raise NotFound(self, filename, self.request)
diff --git a/plone/app/versioningbehavior/configure.zcml b/plone/app/versioningbehavior/configure.zcml
index b9f4ad2..0d7cbbf 100644
--- a/plone/app/versioningbehavior/configure.zcml
+++ b/plone/app/versioningbehavior/configure.zcml
@@ -60,7 +60,7 @@
           for="plone.dexterity.interfaces.IDexterityContent"
           name="download-version"
           permission="zope2.View"
-          class=".browser.VersionView"
+          class=".browser.DownloadVersion"
           />
 
     <genericsetup:registerProfile


