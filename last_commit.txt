Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-30T03:27:42+01:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/69fb2eb50c4765e73ce0f0848772d65ed9181900

Mock MailHost on testing

So that any test relying on mails does not need to set up it by itself.

Files changed:
M CHANGES.rst
M Products/CMFPlone/testing.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bcae7a3..a403143 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -26,6 +26,8 @@ Fixes:
 - Fix use of icons in search results
   [vangheem]
 
+- Mock MailHost on testing.py so that tests relying on mails can use it.
+  [gforcada]
 
 
 5.0.2 (2016-01-08)
diff --git a/Products/CMFPlone/testing.py b/Products/CMFPlone/testing.py
index 8b909a9..4d942e5 100644
--- a/Products/CMFPlone/testing.py
+++ b/Products/CMFPlone/testing.py
@@ -1,3 +1,4 @@
+from Acquisition import aq_base
 from plone.app.contenttypes.testing import PLONE_APP_CONTENTTYPES_FIXTURE
 from plone.app.robotframework import AutoLogin
 from plone.app.robotframework import Content
@@ -11,7 +12,11 @@
 from plone.app.testing.layers import IntegrationTesting
 from plone.testing import z2
 from Products.CMFPlone.tests.robot.robot_setup import CMFPloneRemoteKeywords
+from Products.CMFPlone.tests.utils import MockMailHost
+from Products.MailHost.interfaces import IMailHost
+from zope.component import getSiteManager
 from zope.configuration import xmlconfig
+
 import doctest
 
 
@@ -52,11 +57,28 @@ def setUpPloneSite(self, portal):
                 title=u"Members"
             )
 
+        portal._original_MailHost = portal.MailHost
+        mail_host = MockMailHost('MailHost')
+        mail_host.smtp_host = 'localhost'
+        portal.MailHost = mail_host
+        site_manager = getSiteManager(portal)
+        site_manager.unregisterUtility(provided=IMailHost)
+        site_manager.registerUtility(mail_host, IMailHost)
+
+
     def tearDownPloneSite(self, portal):
         login(portal, 'admin')
         setRoles(portal, TEST_USER_ID, ['Manager'])
         portal.manage_delObjects(['test-folder'])
 
+        portal.MailHost = portal._original_MailHost
+        sm = getSiteManager(context=portal)
+        sm.unregisterUtility(provided=IMailHost)
+        sm.registerUtility(
+            aq_base(portal._original_MailHost),
+            provided=IMailHost
+        )
+
 
 PRODUCTS_CMFPLONE_FIXTURE = ProductsCMFPloneLayer()
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-31T23:06:38+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/bc1a375f05dbf08b7bb538de5cb18b981fb20c71

Merge pull request #1350 from plone/gforcada-testing-mailhost

Mock MailHost on testing

Files changed:
M CHANGES.rst
M Products/CMFPlone/testing.py

diff --git a/CHANGES.rst b/CHANGES.rst
index dfcd7ee..3ef80c4 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -27,6 +27,8 @@ Fixes:
 - Fix use of icons in search results
   [vangheem]
 
+- Mock MailHost on testing.py so that tests relying on mails can use it.
+  [gforcada]
 
 
 5.0.2 (2016-01-08)
diff --git a/Products/CMFPlone/testing.py b/Products/CMFPlone/testing.py
index 8b909a9..4d942e5 100644
--- a/Products/CMFPlone/testing.py
+++ b/Products/CMFPlone/testing.py
@@ -1,3 +1,4 @@
+from Acquisition import aq_base
 from plone.app.contenttypes.testing import PLONE_APP_CONTENTTYPES_FIXTURE
 from plone.app.robotframework import AutoLogin
 from plone.app.robotframework import Content
@@ -11,7 +12,11 @@
 from plone.app.testing.layers import IntegrationTesting
 from plone.testing import z2
 from Products.CMFPlone.tests.robot.robot_setup import CMFPloneRemoteKeywords
+from Products.CMFPlone.tests.utils import MockMailHost
+from Products.MailHost.interfaces import IMailHost
+from zope.component import getSiteManager
 from zope.configuration import xmlconfig
+
 import doctest
 
 
@@ -52,11 +57,28 @@ def setUpPloneSite(self, portal):
                 title=u"Members"
             )
 
+        portal._original_MailHost = portal.MailHost
+        mail_host = MockMailHost('MailHost')
+        mail_host.smtp_host = 'localhost'
+        portal.MailHost = mail_host
+        site_manager = getSiteManager(portal)
+        site_manager.unregisterUtility(provided=IMailHost)
+        site_manager.registerUtility(mail_host, IMailHost)
+
+
     def tearDownPloneSite(self, portal):
         login(portal, 'admin')
         setRoles(portal, TEST_USER_ID, ['Manager'])
         portal.manage_delObjects(['test-folder'])
 
+        portal.MailHost = portal._original_MailHost
+        sm = getSiteManager(context=portal)
+        sm.unregisterUtility(provided=IMailHost)
+        sm.registerUtility(
+            aq_base(portal._original_MailHost),
+            provided=IMailHost
+        )
+
 
 PRODUCTS_CMFPLONE_FIXTURE = ProductsCMFPloneLayer()
 


