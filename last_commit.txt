Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2016-02-29T23:58:00+01:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/6ae344a157dcfa48b258da53e83a04af5e52300f

Fix test isolation problems

Fixes:
https://github.com/plone/plone.app.linkintegrity/issues/36

Files changed:
M CHANGES.rst
M plone/app/linkintegrity/tests/base.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 7cf888d..d71934a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,11 @@ New:
 
 Fixes:
 
-- *add item here*
+- Fix test isolation problems: if a test calls transaction.commit() directly or
+  indirectly it can not be an integration test, either avoid the commit or
+  change the layer into a functional one.
+  Fixes: https://github.com/plone/plone.app.linkintegrity/issues/36
+  [gforcada]
 
 
 3.0.4 (2016-02-02)
diff --git a/plone/app/linkintegrity/tests/base.py b/plone/app/linkintegrity/tests/base.py
index e20717d..c9e0f85 100644
--- a/plone/app/linkintegrity/tests/base.py
+++ b/plone/app/linkintegrity/tests/base.py
@@ -12,7 +12,6 @@
 from zope.interface import alsoProvides
 from zope.lifecycleevent import modified
 
-import transaction
 import unittest
 
 
@@ -23,8 +22,6 @@ def setUp(self):
         self.request = self.layer['request']
         alsoProvides(self.request, IFormLayer)
 
-        transaction.commit()
-
         # Get a testbrowser
         self.browser = Browser(self.layer['app'])
         self.browser.handleErrors = False
@@ -48,7 +45,7 @@ def _get_token(self, obj):
 class DXBaseTestCase(BaseTestCase):
     """Base testcase for testing Dexterity content types"""
 
-    layer = testing.PLONE_APP_LINKINTEGRITY_DX_INTEGRATION_TESTING
+    layer = testing.PLONE_APP_LINKINTEGRITY_DX_FUNCTIONAL_TESTING
 
     def _set_text(self, obj, text):
         obj.text = RichTextValue(text)
@@ -69,7 +66,7 @@ def _get_related_items(self, obj):
 class ATBaseTestCase(BaseTestCase):
     """Base testcase for testing Archetypes content types"""
 
-    layer = testing.PLONE_APP_LINKINTEGRITY_AT_INTEGRATION_TESTING
+    layer = testing.PLONE_APP_LINKINTEGRITY_AT_FUNCTIONAL_TESTING
 
     def _set_text(self, obj, text):
         obj.setText(text, mimetype='text/html')


Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2016-03-01T01:55:16+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.forcada@freitag.de>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/0009d0b1510bd12ecc43c9e55ce15b2b4e335bfe

Merge pull request #37 from plone/fix-test-isolation-problems

Fix test isolation problems

Files changed:
M CHANGES.rst
M plone/app/linkintegrity/tests/base.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 7cf888d..d71934a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,11 @@ New:
 
 Fixes:
 
-- *add item here*
+- Fix test isolation problems: if a test calls transaction.commit() directly or
+  indirectly it can not be an integration test, either avoid the commit or
+  change the layer into a functional one.
+  Fixes: https://github.com/plone/plone.app.linkintegrity/issues/36
+  [gforcada]
 
 
 3.0.4 (2016-02-02)
diff --git a/plone/app/linkintegrity/tests/base.py b/plone/app/linkintegrity/tests/base.py
index e20717d..c9e0f85 100644
--- a/plone/app/linkintegrity/tests/base.py
+++ b/plone/app/linkintegrity/tests/base.py
@@ -12,7 +12,6 @@
 from zope.interface import alsoProvides
 from zope.lifecycleevent import modified
 
-import transaction
 import unittest
 
 
@@ -23,8 +22,6 @@ def setUp(self):
         self.request = self.layer['request']
         alsoProvides(self.request, IFormLayer)
 
-        transaction.commit()
-
         # Get a testbrowser
         self.browser = Browser(self.layer['app'])
         self.browser.handleErrors = False
@@ -48,7 +45,7 @@ def _get_token(self, obj):
 class DXBaseTestCase(BaseTestCase):
     """Base testcase for testing Dexterity content types"""
 
-    layer = testing.PLONE_APP_LINKINTEGRITY_DX_INTEGRATION_TESTING
+    layer = testing.PLONE_APP_LINKINTEGRITY_DX_FUNCTIONAL_TESTING
 
     def _set_text(self, obj, text):
         obj.text = RichTextValue(text)
@@ -69,7 +66,7 @@ def _get_related_items(self, obj):
 class ATBaseTestCase(BaseTestCase):
     """Base testcase for testing Archetypes content types"""
 
-    layer = testing.PLONE_APP_LINKINTEGRITY_AT_INTEGRATION_TESTING
+    layer = testing.PLONE_APP_LINKINTEGRITY_AT_FUNCTIONAL_TESTING
 
     def _set_text(self, obj, text):
         obj.setText(text, mimetype='text/html')


