Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2023-03-20T12:31:01+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.multilingual/commit/5b77b43fa7997c0901cd5d320d902da68f6c33df

Update old view methods and layouts from LIF/LRF type definitions and instances.

For example, in Plone 6 `folder_summary_view` is no longer available: use `summary_view` instead.

Files changed:
A news/1001.bugfix
M src/plone/app/multilingual/profiles/default/metadata.xml
M src/plone/app/multilingual/profiles/default/types/LIF.xml
M src/plone/app/multilingual/profiles/default/types/LRF.xml
M src/plone/app/multilingual/upgrades.py
M src/plone/app/multilingual/upgrades.zcml

b'diff --git a/news/1001.bugfix b/news/1001.bugfix\nnew file mode 100644\nindex 00000000..d441fd57\n--- /dev/null\n+++ b/news/1001.bugfix\n@@ -0,0 +1,3 @@\n+Update old view methods and layouts from LIF/LRF type definitions and instances.\n+For example, in Plone 6 ``folder_summary_view`` is no longer available: use ``summary_view`` instead.\n+[maurits]\ndiff --git a/src/plone/app/multilingual/profiles/default/metadata.xml b/src/plone/app/multilingual/profiles/default/metadata.xml\nindex 796db634..f13799b6 100644\n--- a/src/plone/app/multilingual/profiles/default/metadata.xml\n+++ b/src/plone/app/multilingual/profiles/default/metadata.xml\n@@ -1,6 +1,6 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>1000</version>\n+  <version>1001</version>\n   <dependencies>\n     <dependency>profile-plone.app.dexterity:default</dependency>\n   </dependencies>\ndiff --git a/src/plone/app/multilingual/profiles/default/types/LIF.xml b/src/plone/app/multilingual/profiles/default/types/LIF.xml\nindex e6aadd68..fecf1565 100644\n--- a/src/plone/app/multilingual/profiles/default/types/LIF.xml\n+++ b/src/plone/app/multilingual/profiles/default/types/LIF.xml\n@@ -13,10 +13,10 @@\n   <property name="allow_discussion">False</property>\n   <property name="default_view">folder_listing</property>\n   <property name="view_methods">\n-    <element value="folder_summary_view"/>\n-    <element value="folder_full_view"/>\n-    <element value="folder_tabular_view"/>\n-    <element value="atct_album_view"/>\n+    <element value="summary_view"/>\n+    <element value="full_view"/>\n+    <element value="tabular_view"/>\n+    <element value="album_view"/>\n     <element value="folder_listing"/>\n   </property>\n   <property name="default_view_fallback">False</property>\ndiff --git a/src/plone/app/multilingual/profiles/default/types/LRF.xml b/src/plone/app/multilingual/profiles/default/types/LRF.xml\nindex 5df0a851..66fb6567 100644\n--- a/src/plone/app/multilingual/profiles/default/types/LRF.xml\n+++ b/src/plone/app/multilingual/profiles/default/types/LRF.xml\n@@ -13,10 +13,10 @@\n   <property name="allow_discussion">False</property>\n   <property name="default_view">folder_listing</property>\n   <property name="view_methods">\n-    <element value="folder_summary_view"/>\n-    <element value="folder_full_view"/>\n-    <element value="folder_tabular_view"/>\n-    <element value="atct_album_view"/>\n+    <element value="summary_view"/>\n+    <element value="full_view"/>\n+    <element value="tabular_view"/>\n+    <element value="album_view"/>\n     <element value="folder_listing"/>\n   </property>\n   <property name="default_view_fallback">False</property>\ndiff --git a/src/plone/app/multilingual/upgrades.py b/src/plone/app/multilingual/upgrades.py\nindex e9cc710e..efd21125 100644\n--- a/src/plone/app/multilingual/upgrades.py\n+++ b/src/plone/app/multilingual/upgrades.py\n@@ -1,5 +1,7 @@\n+from Acquisition import aq_base\n from plone.app.multilingual import logger\n from plone.base.interfaces import ILanguage\n+from plone.dexterity.interfaces import IDexterityFTI\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from plone.base.utils import unrestricted_construct_instance\n@@ -156,3 +158,63 @@ def upgrade_to_4(context):\n         PROFILE_ID.replace("default", "to_4"),\n         "plone.app.registry",\n     )\n+\n+\n+def update_old_layouts(context):\n+    """We may have no longer existing layouts layouts set."""\n+    DEFAULT = "folder_listing"\n+    MAPPING = {\n+        "folder_summary_view": "summary_view",\n+        "folder_full_view": "full_view",\n+        "folder_tabular_view": "tabular_view",\n+        "atct_album_view": "album_view",\n+    }\n+    types_tool = getToolByName(context, "portal_types")\n+    catalog = getToolByName(context, "portal_catalog")\n+    our_types = ["LIF", "LRF"]\n+    for type_name in our_types:\n+        fti = types_tool.get(type_name)\n+        if fti is None:\n+            # Should not happen, but I like upgrade steps to be forgiving.\n+            logger.warning("Could not find portal_type %s.", type_name)\n+            continue\n+\n+        # First update the FTI.\n+        old_view_methods = fti.view_methods\n+        view_methods = []\n+        for name in fti.view_methods:\n+            name = MAPPING.get(name, name)\n+            view_methods.append(name)\n+        if DEFAULT not in view_methods:\n+            view_methods.append(DEFAULT)\n+        view_methods = tuple(view_methods)\n+        if old_view_methods != view_methods:\n+            fti.view_methods = view_methods\n+            logger.info("Updated old view methods in FTI %s.", type_name)\n+        if fti.default_view not in view_methods:\n+            default_view = MAPPING.get(fti.default_view, DEFAULT)\n+            logger.info("Set default_view of FTI %s to %s.", type_name, default_view)\n+            fti.default_view = default_view\n+\n+        # Now update all instances of this FTI.\n+        for brain in catalog.unrestrictedSearchResults(portal_type=type_name):\n+            obj = brain.getObject()\n+            layout = obj.getProperty("layout", None)\n+            if layout is None or layout in view_methods:\n+                continue\n+            new_layout = MAPPING.get(layout)\n+            if not new_layout:\n+                # Use the default view: remove the explicit layout.\n+                obj._delProperty("layout")\n+                logger.info(\n+                    "Removed property \'layout\' with value %r at %s",\n+                    layout,\n+                    "/".join(obj.getPhysicalPath()),\n+                )\n+                continue\n+            obj._updateProperty("layout", new_layout)\n+            logger.info(\n+                "Updated property \'layout\' to %r at %s",\n+                new_layout,\n+                "/".join(obj.getPhysicalPath()),\n+            )\ndiff --git a/src/plone/app/multilingual/upgrades.zcml b/src/plone/app/multilingual/upgrades.zcml\nindex 3ff68e0b..b3fa5443 100644\n--- a/src/plone/app/multilingual/upgrades.zcml\n+++ b/src/plone/app/multilingual/upgrades.zcml\n@@ -70,4 +70,11 @@\n \n   </genericsetup:upgradeSteps>\n \n+  <genericsetup:upgradeStep\n+      source="1000"\n+      destination="1001"\n+      profile="plone.app.multilingual:default"\n+      title="Update old layouts"\n+      handler=".upgrades.update_old_layouts" />\n+\n </configure>\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2023-03-21T00:01:12+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/ee40d7a5b172302eeab95dd92f8a498307ac9153

Merge pull request #413 from plone/maurits-update-view-methods

Update view methods and layouts from LIF/LRF FTI and objects

Files changed:
A news/1001.bugfix
M src/plone/app/multilingual/profiles/default/metadata.xml
M src/plone/app/multilingual/profiles/default/types/LIF.xml
M src/plone/app/multilingual/profiles/default/types/LRF.xml
M src/plone/app/multilingual/upgrades.py
M src/plone/app/multilingual/upgrades.zcml

b'diff --git a/news/1001.bugfix b/news/1001.bugfix\nnew file mode 100644\nindex 00000000..d441fd57\n--- /dev/null\n+++ b/news/1001.bugfix\n@@ -0,0 +1,3 @@\n+Update old view methods and layouts from LIF/LRF type definitions and instances.\n+For example, in Plone 6 ``folder_summary_view`` is no longer available: use ``summary_view`` instead.\n+[maurits]\ndiff --git a/src/plone/app/multilingual/profiles/default/metadata.xml b/src/plone/app/multilingual/profiles/default/metadata.xml\nindex 796db634..f13799b6 100644\n--- a/src/plone/app/multilingual/profiles/default/metadata.xml\n+++ b/src/plone/app/multilingual/profiles/default/metadata.xml\n@@ -1,6 +1,6 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>1000</version>\n+  <version>1001</version>\n   <dependencies>\n     <dependency>profile-plone.app.dexterity:default</dependency>\n   </dependencies>\ndiff --git a/src/plone/app/multilingual/profiles/default/types/LIF.xml b/src/plone/app/multilingual/profiles/default/types/LIF.xml\nindex e6aadd68..fecf1565 100644\n--- a/src/plone/app/multilingual/profiles/default/types/LIF.xml\n+++ b/src/plone/app/multilingual/profiles/default/types/LIF.xml\n@@ -13,10 +13,10 @@\n   <property name="allow_discussion">False</property>\n   <property name="default_view">folder_listing</property>\n   <property name="view_methods">\n-    <element value="folder_summary_view"/>\n-    <element value="folder_full_view"/>\n-    <element value="folder_tabular_view"/>\n-    <element value="atct_album_view"/>\n+    <element value="summary_view"/>\n+    <element value="full_view"/>\n+    <element value="tabular_view"/>\n+    <element value="album_view"/>\n     <element value="folder_listing"/>\n   </property>\n   <property name="default_view_fallback">False</property>\ndiff --git a/src/plone/app/multilingual/profiles/default/types/LRF.xml b/src/plone/app/multilingual/profiles/default/types/LRF.xml\nindex 5df0a851..66fb6567 100644\n--- a/src/plone/app/multilingual/profiles/default/types/LRF.xml\n+++ b/src/plone/app/multilingual/profiles/default/types/LRF.xml\n@@ -13,10 +13,10 @@\n   <property name="allow_discussion">False</property>\n   <property name="default_view">folder_listing</property>\n   <property name="view_methods">\n-    <element value="folder_summary_view"/>\n-    <element value="folder_full_view"/>\n-    <element value="folder_tabular_view"/>\n-    <element value="atct_album_view"/>\n+    <element value="summary_view"/>\n+    <element value="full_view"/>\n+    <element value="tabular_view"/>\n+    <element value="album_view"/>\n     <element value="folder_listing"/>\n   </property>\n   <property name="default_view_fallback">False</property>\ndiff --git a/src/plone/app/multilingual/upgrades.py b/src/plone/app/multilingual/upgrades.py\nindex e9cc710e..efd21125 100644\n--- a/src/plone/app/multilingual/upgrades.py\n+++ b/src/plone/app/multilingual/upgrades.py\n@@ -1,5 +1,7 @@\n+from Acquisition import aq_base\n from plone.app.multilingual import logger\n from plone.base.interfaces import ILanguage\n+from plone.dexterity.interfaces import IDexterityFTI\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from plone.base.utils import unrestricted_construct_instance\n@@ -156,3 +158,63 @@ def upgrade_to_4(context):\n         PROFILE_ID.replace("default", "to_4"),\n         "plone.app.registry",\n     )\n+\n+\n+def update_old_layouts(context):\n+    """We may have no longer existing layouts layouts set."""\n+    DEFAULT = "folder_listing"\n+    MAPPING = {\n+        "folder_summary_view": "summary_view",\n+        "folder_full_view": "full_view",\n+        "folder_tabular_view": "tabular_view",\n+        "atct_album_view": "album_view",\n+    }\n+    types_tool = getToolByName(context, "portal_types")\n+    catalog = getToolByName(context, "portal_catalog")\n+    our_types = ["LIF", "LRF"]\n+    for type_name in our_types:\n+        fti = types_tool.get(type_name)\n+        if fti is None:\n+            # Should not happen, but I like upgrade steps to be forgiving.\n+            logger.warning("Could not find portal_type %s.", type_name)\n+            continue\n+\n+        # First update the FTI.\n+        old_view_methods = fti.view_methods\n+        view_methods = []\n+        for name in fti.view_methods:\n+            name = MAPPING.get(name, name)\n+            view_methods.append(name)\n+        if DEFAULT not in view_methods:\n+            view_methods.append(DEFAULT)\n+        view_methods = tuple(view_methods)\n+        if old_view_methods != view_methods:\n+            fti.view_methods = view_methods\n+            logger.info("Updated old view methods in FTI %s.", type_name)\n+        if fti.default_view not in view_methods:\n+            default_view = MAPPING.get(fti.default_view, DEFAULT)\n+            logger.info("Set default_view of FTI %s to %s.", type_name, default_view)\n+            fti.default_view = default_view\n+\n+        # Now update all instances of this FTI.\n+        for brain in catalog.unrestrictedSearchResults(portal_type=type_name):\n+            obj = brain.getObject()\n+            layout = obj.getProperty("layout", None)\n+            if layout is None or layout in view_methods:\n+                continue\n+            new_layout = MAPPING.get(layout)\n+            if not new_layout:\n+                # Use the default view: remove the explicit layout.\n+                obj._delProperty("layout")\n+                logger.info(\n+                    "Removed property \'layout\' with value %r at %s",\n+                    layout,\n+                    "/".join(obj.getPhysicalPath()),\n+                )\n+                continue\n+            obj._updateProperty("layout", new_layout)\n+            logger.info(\n+                "Updated property \'layout\' to %r at %s",\n+                new_layout,\n+                "/".join(obj.getPhysicalPath()),\n+            )\ndiff --git a/src/plone/app/multilingual/upgrades.zcml b/src/plone/app/multilingual/upgrades.zcml\nindex 3ff68e0b..b3fa5443 100644\n--- a/src/plone/app/multilingual/upgrades.zcml\n+++ b/src/plone/app/multilingual/upgrades.zcml\n@@ -70,4 +70,11 @@\n \n   </genericsetup:upgradeSteps>\n \n+  <genericsetup:upgradeStep\n+      source="1000"\n+      destination="1001"\n+      profile="plone.app.multilingual:default"\n+      title="Update old layouts"\n+      handler=".upgrades.update_old_layouts" />\n+\n </configure>\n'

