Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-07-08T14:56:31+02:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/dd2e93dd449a3cb7296ba2b79c04d1cea6755b61

Fix link content serialization when url points to local content but it does not exist (#1168)

Files changed:
A news/1167.bugfix
M src/plone/restapi/serializer/dxfields.py
M src/plone/restapi/tests/test_dxfield_serializer.py

b'diff --git a/news/1167.bugfix b/news/1167.bugfix\nnew file mode 100644\nindex 000000000..c448bbb72\n--- /dev/null\n+++ b/news/1167.bugfix\n@@ -0,0 +1,2 @@\n+Fix link content serialization when url points to local content but it does not exist\n+[sneridagh]\ndiff --git a/src/plone/restapi/serializer/dxfields.py b/src/plone/restapi/serializer/dxfields.py\nindex 745490816..afadc6e02 100644\n--- a/src/plone/restapi/serializer/dxfields.py\n+++ b/src/plone/restapi/serializer/dxfields.py\n@@ -143,11 +143,16 @@ def __call__(self):\n         portal = getMultiAdapter(\n             (self.context, self.context.REQUEST), name="plone_portal_state"\n         ).portal()\n-        ref_obj = portal.restrictedTraverse(path, None)\n+        # We should traverse unrestricted, just in case that the path to the object\n+        # is not all public, we should be able to reach it by finger pointing\n+        ref_obj = portal.unrestrictedTraverse(path, None)\n         if ref_obj:\n             value = ref_obj.absolute_url()\n             return json_compatible(value)\n-        return json_compatible(path)\n+        else:\n+            # The URL does not point to an existing object, so just return the value\n+            # without value interpolation\n+            return json_compatible(value.replace("${portal_url}", ""))\n \n \n @adapter(IField, IDexterityContent, Interface)\ndiff --git a/src/plone/restapi/tests/test_dxfield_serializer.py b/src/plone/restapi/tests/test_dxfield_serializer.py\nindex 66d1f7fd5..680c700ca 100644\n--- a/src/plone/restapi/tests/test_dxfield_serializer.py\n+++ b/src/plone/restapi/tests/test_dxfield_serializer.py\n@@ -337,6 +337,12 @@ def test_remoteurl_field_in_links_get_converted(self):\n         dm.set("${portal_url}/doc1")\n         self.assertEqual(serializer(), self.portal.doc1.absolute_url())\n \n+        dm.set("${portal_url}/doc2")\n+        self.assertEqual(serializer(), "/doc2")\n+\n+        dm.set("/doc2")\n+        self.assertEqual(serializer(), "/doc2")\n+\n \n @unittest.skipUnless(\n     PLONE_VERSION.base_version < "5.1",\n'

