Repository: plone.formwidget.namedfile


Branch: refs/heads/master
Date: 2023-03-08T11:42:20+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.formwidget.namedfile/commit/26c5285a022c1ee0360c4d2df3b30367caa1aa1a

Use latin-1 decoded filename in tests with FileUpload.

This seems to be what browsers actually use, or how the filename is at this point in the zope publishing machinery.
See https://github.com/zopefoundation/Zope/pull/1094#issuecomment-1459047253

Files changed:
A news/1094.bugfix
M plone/formwidget/namedfile/converter.py
M plone/formwidget/namedfile/widget.rst

b'diff --git a/news/1094.bugfix b/news/1094.bugfix\nnew file mode 100644\nindex 0000000..e5efd72\n--- /dev/null\n+++ b/news/1094.bugfix\n@@ -0,0 +1,2 @@\n+Test fix: use latin-1 decoded filename in tests with FileUpload.\n+[maurits]\ndiff --git a/plone/formwidget/namedfile/converter.py b/plone/formwidget/namedfile/converter.py\nindex 367c587..9607bca 100644\n--- a/plone/formwidget/namedfile/converter.py\n+++ b/plone/formwidget/namedfile/converter.py\n@@ -71,7 +71,7 @@ def b64encode_file(filename, data):\n \n def b64decode_file(value):\n     if isinstance(value, str):\n-        value = value.encode("utf8")\n+        value = value.encode("utf-8")\n     filename, data = value.split(b";")\n \n     filename = filename.split(b":")[1]\ndiff --git a/plone/formwidget/namedfile/widget.rst b/plone/formwidget/namedfile/widget.rst\nindex c8715e0..d9878ea 100644\n--- a/plone/formwidget/namedfile/widget.rst\n+++ b/plone/formwidget/namedfile/widget.rst\n@@ -496,12 +496,13 @@ content type::\n \n   >>> myfile = six.BytesIO(b\'File upload contents.\')\n   >>> # \\xc3\\xb8 is UTF-8 for a small letter o with slash\n-  >>> aFieldStorage = FieldStorageStub(myfile, filename=b\'rand\\xc3\\xb8m.txt\'.decode(\'utf8\'),\n+  >>> # Still, we must decode it using latin-1 according to HTTP/1.1.\n+  >>> aFieldStorage = FieldStorageStub(myfile, filename=b\'rand\\xc3\\xb8m.txt\'.decode(\'latin-1\'),\n   ...     headers={\'Content-Type\': \'text/x-dummy\'})\n   >>> file_obj = file_converter.toFieldValue(FileUpload(aFieldStorage))\n   >>> file_obj.data\n   b\'File upload contents.\'\n-  >>> file_obj.filename.encode(\'utf8\')\n+  >>> file_obj.filename.encode(\'utf-8\')\n   b\'rand\\xc3\\xb8m.txt\'\n \n Content type from headers sent by browser should be ignored::\n@@ -640,7 +641,8 @@ filename too::\n \n   >>> myfile = six.BytesIO(b\'File upload contents.\')\n   >>> # \\xc3\\xb8 is UTF-8 for a small letter o with slash\n-  >>> aFieldStorage = FieldStorageStub(myfile, filename=b\'rand\\xc3\\xb8m.txt\'.decode(\'utf8\'),\n+  >>> # Still, we must decode it using latin-1 according to HTTP/1.1.\n+  >>> aFieldStorage = FieldStorageStub(myfile, filename=b\'rand\\xc3\\xb8m.txt\'.decode(\'latin-1\'),\n   ...     headers={\'Content-Type\': \'text/x-dummy\'})\n   >>> bytes_file_converter.toFieldValue(FileUpload(aFieldStorage))\n   b\'filenameb64:cmFuZMO4bS50eHQ=;datab64:RmlsZSB1cGxvYWQgY29udGVudHMu\'\n'

Repository: plone.formwidget.namedfile


Branch: refs/heads/master
Date: 2023-03-10T21:31:14+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.formwidget.namedfile/commit/ddbeeecaac76975484ce0844514b9520bc67ae2a

Merge pull request #60 from plone/maurits-widget-tests-latin-1

Use latin-1 decoded filename in tests with FileUpload.

Files changed:
A news/1094.bugfix
M plone/formwidget/namedfile/converter.py
M plone/formwidget/namedfile/widget.rst

b'diff --git a/news/1094.bugfix b/news/1094.bugfix\nnew file mode 100644\nindex 0000000..e5efd72\n--- /dev/null\n+++ b/news/1094.bugfix\n@@ -0,0 +1,2 @@\n+Test fix: use latin-1 decoded filename in tests with FileUpload.\n+[maurits]\ndiff --git a/plone/formwidget/namedfile/converter.py b/plone/formwidget/namedfile/converter.py\nindex 367c587..9607bca 100644\n--- a/plone/formwidget/namedfile/converter.py\n+++ b/plone/formwidget/namedfile/converter.py\n@@ -71,7 +71,7 @@ def b64encode_file(filename, data):\n \n def b64decode_file(value):\n     if isinstance(value, str):\n-        value = value.encode("utf8")\n+        value = value.encode("utf-8")\n     filename, data = value.split(b";")\n \n     filename = filename.split(b":")[1]\ndiff --git a/plone/formwidget/namedfile/widget.rst b/plone/formwidget/namedfile/widget.rst\nindex c8715e0..d9878ea 100644\n--- a/plone/formwidget/namedfile/widget.rst\n+++ b/plone/formwidget/namedfile/widget.rst\n@@ -496,12 +496,13 @@ content type::\n \n   >>> myfile = six.BytesIO(b\'File upload contents.\')\n   >>> # \\xc3\\xb8 is UTF-8 for a small letter o with slash\n-  >>> aFieldStorage = FieldStorageStub(myfile, filename=b\'rand\\xc3\\xb8m.txt\'.decode(\'utf8\'),\n+  >>> # Still, we must decode it using latin-1 according to HTTP/1.1.\n+  >>> aFieldStorage = FieldStorageStub(myfile, filename=b\'rand\\xc3\\xb8m.txt\'.decode(\'latin-1\'),\n   ...     headers={\'Content-Type\': \'text/x-dummy\'})\n   >>> file_obj = file_converter.toFieldValue(FileUpload(aFieldStorage))\n   >>> file_obj.data\n   b\'File upload contents.\'\n-  >>> file_obj.filename.encode(\'utf8\')\n+  >>> file_obj.filename.encode(\'utf-8\')\n   b\'rand\\xc3\\xb8m.txt\'\n \n Content type from headers sent by browser should be ignored::\n@@ -640,7 +641,8 @@ filename too::\n \n   >>> myfile = six.BytesIO(b\'File upload contents.\')\n   >>> # \\xc3\\xb8 is UTF-8 for a small letter o with slash\n-  >>> aFieldStorage = FieldStorageStub(myfile, filename=b\'rand\\xc3\\xb8m.txt\'.decode(\'utf8\'),\n+  >>> # Still, we must decode it using latin-1 according to HTTP/1.1.\n+  >>> aFieldStorage = FieldStorageStub(myfile, filename=b\'rand\\xc3\\xb8m.txt\'.decode(\'latin-1\'),\n   ...     headers={\'Content-Type\': \'text/x-dummy\'})\n   >>> bytes_file_converter.toFieldValue(FileUpload(aFieldStorage))\n   b\'filenameb64:cmFuZMO4bS50eHQ=;datab64:RmlsZSB1cGxvYWQgY29udGVudHMu\'\n'

