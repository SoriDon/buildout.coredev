Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-03-07T14:35:51+01:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/7d4b90abe82edd74877e4cda534c50c265a4cd09

reset default from ZDOptions.realize

Files changed:
M src/plone/recipe/zope2instance/ctl.py

b"diff --git a/src/plone/recipe/zope2instance/ctl.py b/src/plone/recipe/zope2instance/ctl.py\nindex 1ba9d55..b036936 100644\n--- a/src/plone/recipe/zope2instance/ctl.py\n+++ b/src/plone/recipe/zope2instance/ctl.py\n@@ -100,6 +100,8 @@ def __init__(self):\n \n     def realize(self, *args, **kw):\n         self.ZopeOptions.realize(self, *args, **kw)\n+        if '-s' not in args:\n+            self.sockname = None\n         # Additional checking of user option; set uid and gid\n         if self.user is not None:\n             import pwd\n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-03-07T15:01:17+01:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/56864aa13532f3757ab1f7b10c4264255deeb326

update changelog; simplify

Files changed:
A news/79.bugfix
M src/plone/recipe/zope2instance/ctl.py

b'diff --git a/news/79.bugfix b/news/79.bugfix\nnew file mode 100644\nindex 0000000..06f7da3\n--- /dev/null\n+++ b/news/79.bugfix\n@@ -0,0 +1 @@\n+- Fix zdaemon socket location when it\'s not passed on the command line (`#79 <https://github.com/plone/plone.recipe.zope2instance/pull/79>`_). [tschorr]\ndiff --git a/src/plone/recipe/zope2instance/ctl.py b/src/plone/recipe/zope2instance/ctl.py\nindex b036936..b599bd1 100644\n--- a/src/plone/recipe/zope2instance/ctl.py\n+++ b/src/plone/recipe/zope2instance/ctl.py\n@@ -100,8 +100,6 @@ def __init__(self):\n \n     def realize(self, *args, **kw):\n         self.ZopeOptions.realize(self, *args, **kw)\n-        if \'-s\' not in args:\n-            self.sockname = None\n         # Additional checking of user option; set uid and gid\n         if self.user is not None:\n             import pwd\n@@ -132,8 +130,10 @@ def realize(self, *args, **kw):\n             self.program = config.runner.program\n         else:\n             self.program = [os.path.join(self.directory, "bin", "runzope")]\n-        if self.sockname:\n+        if \'-s\' in args:\n             # set by command line option\n+            # or by zdaemon.zdoptions - we need\n+            # to override the latter case\n             pass\n         elif config.runner and config.runner.socket_name:\n             self.sockname = config.runner.socket_name\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-03-07T15:29:56+01:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/488d632753cdfa827cce02f0b4cd627b2550ba1e

Merge remote-tracking branch 'origin/master' into fix_zdsock_location

Files changed:
M CHANGES.rst
M setup.py
M src/plone/recipe/zope2instance/ctl.py
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/wsgi.txt

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex bb3097b..f05bf33 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -8,6 +8,15 @@ Changelog\n \n .. towncrier release notes start\n \n+6.1.4 (unreleased)\n+------------------\n+\n+Bug fixes:\n+\n+- restore http-fast-listen for waitress (`#71 <https://github.com/plone/plone.recipe.zope2instance/issues/71>`_)\n+  [tschorr]\n+\n+\n 6.1.3 (2019-03-04)\n ------------------\n \ndiff --git a/setup.py b/setup.py\nindex 8ffb052..8941ab7 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -43,6 +43,7 @@\n         \'Zope >= 4.0b1\',\n         \'ZODB >= 5.1.1\',\n         \'ZEO\',\n+        \'waitress >= 1.2.0\',\n         \'Paste\',\n     ],\n     extras_require={\n@@ -51,5 +52,13 @@\n         ],\n     },\n     zip_safe=False,\n-    entry_points={\'zc.buildout\': [\'default = %s.recipe:Recipe\' % name]},\n+    entry_points={\n+        \'zc.buildout\': [\'default = %s.recipe:Recipe\' % name],\n+        \'paste.server_runner\': [\n+            \'main=plone.recipe.zope2instance.ctl:serve_paste\',\n+        ],\n+        \'paste.server_factory\': [\n+            \'main=plone.recipe.zope2instance.ctl:server_factory\',\n+        ],\n+        },\n )\ndiff --git a/src/plone/recipe/zope2instance/ctl.py b/src/plone/recipe/zope2instance/ctl.py\nindex b599bd1..ae273fb 100644\n--- a/src/plone/recipe/zope2instance/ctl.py\n+++ b/src/plone/recipe/zope2instance/ctl.py\n@@ -28,6 +28,8 @@\n """\n \n from pkg_resources import iter_entry_points\n+from time import sleep\n+from waitress.wasyncore import dispatcher\n from ZConfig.loader import SchemaLoader\n from zdaemon.zdctl import ZDCmd, ZDCtlOptions\n from zdaemon.zdoptions import ZDOptions\n@@ -37,10 +39,13 @@\n import os.path\n import pkg_resources\n import six\n+import socket\n import sys\n import xml.sax\n+import waitress\n import zdaemon\n \n+\n if sys.version_info > (3, ):\n     basestring = str\n \n@@ -876,6 +881,43 @@ def help_adduser(self):\n         print("adduser <name> <password> -- add a Zope management user")\n \n \n+def serve_paste(app, global_conf, **kw):\n+    sock = None\n+    if \'prebound\' in global_conf:\n+        _sock = socket.fromfd(\n+            int(global_conf[\'prebound\']), socket.AF_INET, socket.SOCK_STREAM)\n+        if six.PY2:\n+            sock = socket.socket()\n+            sock._sock = _sock\n+        else:\n+            sock = _sock\n+        kw.update(sockets=[sock])\n+    try:\n+        waitress.serve(app, **kw)\n+    finally:\n+        if isinstance(sock, socket.socket):\n+            sock.close()\n+    return 0\n+\n+\n+def server_factory(global_conf, **kws):\n+    if \'fast-listen\' in kws:\n+        host, port = kws[\'fast-listen\'].split(\':\')\n+        prebound = dispatcher()\n+        prebound.create_socket(socket.AF_INET, socket.SOCK_STREAM)\n+        prebound.bind((host, int(port)))\n+        prebound.listen(5)\n+        while not prebound.readable():\n+            sleep(1)\n+        global_conf.update(prebound=str(prebound.socket.fileno()))\n+        del kws[\'fast-listen\']\n+    del kws[\'paste.server_factory\']\n+\n+    def serve(app):\n+        return serve_paste(app, global_conf, **kws)\n+    return serve\n+\n+\n def main(args=None):\n     """Customized entry point for launching Zope without forking other processes\n     """\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 70fdbbe..a7f297b 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -661,6 +661,7 @@ def build_wsgi_ini(self):\n         options = self.options\n         wsgi_ini_path = os.path.join(options[\'location\'], \'etc\', \'wsgi.ini\')\n         listen = options.get(\'http-address\', \'0.0.0.0:8080\')\n+        fast = \'fast-\' if options.get(\'http-fast-listen\') is not None else \'\'\n         if \':\' not in listen:\n             listen = \'0.0.0.0:{}\'.format(listen)\n \n@@ -698,6 +699,7 @@ def build_wsgi_ini(self):\n             \'location\': options[\'location\'],\n             \'http_address\': listen,\n             \'threads\': options.get(\'threads\', 4),\n+            \'fast-listen\': fast,\n             \'eventlog_name\': eventlog_name,\n             \'root_handlers\': root_handlers,\n             \'event_handlers\': event_handlers,\n@@ -1229,8 +1231,9 @@ def render_file_storage(self, file_storage, blob_storage,\n \n wsgi_ini_template = """\\\n [server:main]\n-use = egg:waitress#main\n-listen = %(http_address)s\n+paste.server_factory = plone.recipe.zope2instance:main\n+use = egg:plone.recipe.zope2instance#main\n+%(fast-listen)slisten = %(http_address)s\n threads = %(threads)s\n \n [app:zope]\ndiff --git a/src/plone/recipe/zope2instance/tests/wsgi.txt b/src/plone/recipe/zope2instance/tests/wsgi.txt\nindex 0c14ff7..5fff07f 100644\n--- a/src/plone/recipe/zope2instance/tests/wsgi.txt\n+++ b/src/plone/recipe/zope2instance/tests/wsgi.txt\n@@ -75,7 +75,8 @@ The buildout has also created an INI file containing the waitress configuration:\n     >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n     >>> print(wsgi_ini)\n     [server:main]\n-    use = egg:waitress#main\n+    paste.server_factory = plone.recipe.zope2instance:main\n+    use = egg:plone.recipe.zope2instance#main\n     listen = 0.0.0.0:8080\n     threads = 4\n     <BLANKLINE>\n@@ -159,6 +160,7 @@ Let\'s create another buildout configuring a custom port and a custom number of w\n     ... eggs =\n     ... user = me:me\n     ... http-address = localhost:6543\n+    ... http-fast-listen = on\n     ... threads = 3\n     ... \'\'\' % options)\n \n@@ -176,8 +178,9 @@ The buildout has updated our INI file:\n     >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n     >>> print(wsgi_ini)\n     [server:main]\n-    use = egg:waitress#main\n-    listen = localhost:6543\n+    paste.server_factory = plone.recipe.zope2instance:main\n+    use = egg:plone.recipe.zope2instance#main\n+    fast-listen = localhost:6543\n     threads = 3\n     <BLANKLINE>\n     [app:zope]\n@@ -219,7 +222,8 @@ The buildout has updated our INI file:\n     >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n     >>> print(wsgi_ini)\n     [server:main]\n-    use = egg:waitress#main\n+    paste.server_factory = plone.recipe.zope2instance:main\n+    use = egg:plone.recipe.zope2instance#main\n     ...\n     [logger_root]\n     level = ERROR\n@@ -283,7 +287,8 @@ The buildout has updated our INI file:\n     >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n     >>> print(wsgi_ini)\n     [server:main]\n-    use = egg:waitress#main\n+    paste.server_factory = plone.recipe.zope2instance:main\n+    use = egg:plone.recipe.zope2instance#main\n     ...\n     [pipeline:main]\n     pipeline =\n@@ -321,7 +326,8 @@ The buildout has updated our INI file:\n     >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n     >>> print(wsgi_ini)\n     [server:main]\n-    use = egg:waitress#main\n+    paste.server_factory = plone.recipe.zope2instance:main\n+    use = egg:plone.recipe.zope2instance#main\n     ...\n     [pipeline:main]\n     pipeline =\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2019-03-15T18:22:28+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/44185ed553c7ab0fd51ca4ba5fb53e7ef11f7d7b

Merge pull request #79 from plone/fix_zdsock_location

Fix zdaemon socket location

Files changed:
A news/79.bugfix
M src/plone/recipe/zope2instance/ctl.py

b'diff --git a/news/79.bugfix b/news/79.bugfix\nnew file mode 100644\nindex 0000000..06f7da3\n--- /dev/null\n+++ b/news/79.bugfix\n@@ -0,0 +1 @@\n+- Fix zdaemon socket location when it\'s not passed on the command line (`#79 <https://github.com/plone/plone.recipe.zope2instance/pull/79>`_). [tschorr]\ndiff --git a/src/plone/recipe/zope2instance/ctl.py b/src/plone/recipe/zope2instance/ctl.py\nindex d90319d..e1fd2d5 100644\n--- a/src/plone/recipe/zope2instance/ctl.py\n+++ b/src/plone/recipe/zope2instance/ctl.py\n@@ -135,8 +135,10 @@ def realize(self, *args, **kw):\n             self.program = config.runner.program\n         else:\n             self.program = [os.path.join(self.directory, "bin", "runzope")]\n-        if self.sockname:\n+        if \'-s\' in args:\n             # set by command line option\n+            # or by zdaemon.zdoptions - we need\n+            # to override the latter case\n             pass\n         elif config.runner and config.runner.socket_name:\n             self.sockname = config.runner.socket_name\n'

