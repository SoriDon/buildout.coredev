Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2022-08-31T11:38:57+02:00
Author: ale-rt (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/28f47094581ac84e473e3a45a795280177e34394

Update the portal actions icon expressions

Fixes #298

Files changed:
A news/298.bugfix
M plone/app/upgrade/v60/betas.py
M plone/app/upgrade/v60/configure.zcml

b'diff --git a/news/298.bugfix b/news/298.bugfix\nnew file mode 100644\nindex 00000000..211ba6fb\n--- /dev/null\n+++ b/news/298.bugfix\n@@ -0,0 +1,2 @@\n+Update the portal actions icon expressions\n+[ale-rt]\ndiff --git a/plone/app/upgrade/v60/betas.py b/plone/app/upgrade/v60/betas.py\nindex debd2b49..979335b9 100644\n--- a/plone/app/upgrade/v60/betas.py\n+++ b/plone/app/upgrade/v60/betas.py\n@@ -1,6 +1,9 @@\n+from Products.CMFCore.Expression import Expression\n from Products.CMFPlone.utils import getToolByName\n+\n import logging\n \n+\n logger = logging.getLogger("plone.app.upgrade")\n \n \n@@ -10,3 +13,65 @@ def add_the_timezone_property(context):\n     if portal_memberdata.hasProperty("timezone"):\n         return\n     portal_memberdata.manage_addProperty("timezone", "", "string")\n+\n+\n+def add_action_icons(context):\n+    """Add action icons"""\n+    portal_actions = getToolByName(context, "portal_actions")\n+\n+    def _set_icon_expr(action, icon_expr):\n+        """setting icon_expr also requires to add an icon_expr_object"""\n+        action.icon_expr = icon_expr\n+        action.icon_expr_object = Expression(icon_expr)\n+\n+    # Fix actions that had an icon expression\n+    for action_path, old, new in (\n+        (\n+            "document_actions/print",\n+            "string:$portal_url/print_icon.png",\n+            "string:plone-print",\n+        ),\n+        ("document_actions/rss", "string:$portal_url/rss.png", "string:plone-rss"),\n+    ):\n+        action = portal_actions.unrestrictedTraverse(action_path, None)\n+        if action is not None:\n+            if action.icon_expr == old:\n+                _set_icon_expr(action, new)\n+            elif action.icon_expr != new:\n+                logger.info("Skipping action %r, it looks customized", action_path)\n+\n+    # Fix actions that did not have an icon expression\n+    mapping = {\n+        "object_buttons/copy": "string:plone-copy",\n+        "object_buttons/cut": "string:plone-cut",\n+        "object_buttons/delete": "string:plone-delete",\n+        "object_buttons/ical_import_disable": "",\n+        "object_buttons/ical_import_enable": "",\n+        "object_buttons/paste": "string:plone-paste",\n+        "object_buttons/redirection": "string:plone-redirection",\n+        "object_buttons/rename": "string:plone-rename",\n+        "object/contentrules": "string:plone-rules",\n+        "object/folderContents": "string:toolbar-action/folderContents",\n+        "object/history": "string:toolbar-action/history",\n+        "object/ical_import_settings": "",\n+        "object/local_roles": "string:toolbar-action/sharing",\n+        "object/syndication": "string:plone-rss",\n+        "portal_tabs/index_html": "string:plone-home",\n+        "site_actions/accessibility": "string:plone-accessibility",\n+        "site_actions/contact": "string:plone-contact-info",\n+        "site_actions/sitemap": "string:plone-sitemap",\n+        "user/dashboard": "string:plone-dashboard",\n+        "user/join": "string:plone-register",\n+        "user/login": "string:plone-login",\n+        "user/logout": "string:plone-logout",\n+        "user/plone_setup": "string:plone-controlpanel",\n+        "user/preferences": "string:plone-user",\n+        "user/undo": "string:plone-undo",\n+    }\n+    for action_path, new in mapping.items():\n+        action = portal_actions.unrestrictedTraverse(action_path, None)\n+        if action:\n+            if not action.icon_expr:\n+                _set_icon_expr(action, new)\n+            elif action.icon_expr != new:\n+                logger.info("Skipping action %r, it looks customized", action_path)\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 78e8883f..a2b0a763 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -148,6 +148,11 @@\n           handler=".betas.add_the_timezone_property"\n           />\n \n+      <gs:upgradeStep\n+          title="Fix the portal action icons."\n+          handler=".betas.add_action_icons"\n+          />\n+\n     </gs:upgradeSteps>\n \n </configure>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2022-08-31T23:54:03+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/c3d1b842681f510732ab1aeb65ba38550a6ff107

Merge pull request #299 from plone/298-bugfix

Update the portal actions icon expressions

Files changed:
A news/298.bugfix
M plone/app/upgrade/v60/betas.py
M plone/app/upgrade/v60/configure.zcml

b'diff --git a/news/298.bugfix b/news/298.bugfix\nnew file mode 100644\nindex 00000000..211ba6fb\n--- /dev/null\n+++ b/news/298.bugfix\n@@ -0,0 +1,2 @@\n+Update the portal actions icon expressions\n+[ale-rt]\ndiff --git a/plone/app/upgrade/v60/betas.py b/plone/app/upgrade/v60/betas.py\nindex debd2b49..979335b9 100644\n--- a/plone/app/upgrade/v60/betas.py\n+++ b/plone/app/upgrade/v60/betas.py\n@@ -1,6 +1,9 @@\n+from Products.CMFCore.Expression import Expression\n from Products.CMFPlone.utils import getToolByName\n+\n import logging\n \n+\n logger = logging.getLogger("plone.app.upgrade")\n \n \n@@ -10,3 +13,65 @@ def add_the_timezone_property(context):\n     if portal_memberdata.hasProperty("timezone"):\n         return\n     portal_memberdata.manage_addProperty("timezone", "", "string")\n+\n+\n+def add_action_icons(context):\n+    """Add action icons"""\n+    portal_actions = getToolByName(context, "portal_actions")\n+\n+    def _set_icon_expr(action, icon_expr):\n+        """setting icon_expr also requires to add an icon_expr_object"""\n+        action.icon_expr = icon_expr\n+        action.icon_expr_object = Expression(icon_expr)\n+\n+    # Fix actions that had an icon expression\n+    for action_path, old, new in (\n+        (\n+            "document_actions/print",\n+            "string:$portal_url/print_icon.png",\n+            "string:plone-print",\n+        ),\n+        ("document_actions/rss", "string:$portal_url/rss.png", "string:plone-rss"),\n+    ):\n+        action = portal_actions.unrestrictedTraverse(action_path, None)\n+        if action is not None:\n+            if action.icon_expr == old:\n+                _set_icon_expr(action, new)\n+            elif action.icon_expr != new:\n+                logger.info("Skipping action %r, it looks customized", action_path)\n+\n+    # Fix actions that did not have an icon expression\n+    mapping = {\n+        "object_buttons/copy": "string:plone-copy",\n+        "object_buttons/cut": "string:plone-cut",\n+        "object_buttons/delete": "string:plone-delete",\n+        "object_buttons/ical_import_disable": "",\n+        "object_buttons/ical_import_enable": "",\n+        "object_buttons/paste": "string:plone-paste",\n+        "object_buttons/redirection": "string:plone-redirection",\n+        "object_buttons/rename": "string:plone-rename",\n+        "object/contentrules": "string:plone-rules",\n+        "object/folderContents": "string:toolbar-action/folderContents",\n+        "object/history": "string:toolbar-action/history",\n+        "object/ical_import_settings": "",\n+        "object/local_roles": "string:toolbar-action/sharing",\n+        "object/syndication": "string:plone-rss",\n+        "portal_tabs/index_html": "string:plone-home",\n+        "site_actions/accessibility": "string:plone-accessibility",\n+        "site_actions/contact": "string:plone-contact-info",\n+        "site_actions/sitemap": "string:plone-sitemap",\n+        "user/dashboard": "string:plone-dashboard",\n+        "user/join": "string:plone-register",\n+        "user/login": "string:plone-login",\n+        "user/logout": "string:plone-logout",\n+        "user/plone_setup": "string:plone-controlpanel",\n+        "user/preferences": "string:plone-user",\n+        "user/undo": "string:plone-undo",\n+    }\n+    for action_path, new in mapping.items():\n+        action = portal_actions.unrestrictedTraverse(action_path, None)\n+        if action:\n+            if not action.icon_expr:\n+                _set_icon_expr(action, new)\n+            elif action.icon_expr != new:\n+                logger.info("Skipping action %r, it looks customized", action_path)\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 78e8883f..a2b0a763 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -148,6 +148,11 @@\n           handler=".betas.add_the_timezone_property"\n           />\n \n+      <gs:upgradeStep\n+          title="Fix the portal action icons."\n+          handler=".betas.add_action_icons"\n+          />\n+\n     </gs:upgradeSteps>\n \n </configure>\n'

