Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2017-02-02T21:08:32+01:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/Products.ATContentTypes/commit/6bb64d5d3bc26e9a6fabcaaea2f51556ecc5ee25

fix atimage tests

Files changed:
M CHANGES.rst
M Products/ATContentTypes/tests/test_atimage.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 585070e..c7e15c2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix tests on Zope 4. [davisagli]
 
 
 2.3.2 (2017-01-20)
diff --git a/Products/ATContentTypes/tests/test_atimage.py b/Products/ATContentTypes/tests/test_atimage.py
index e59f29f..140d74f 100644
--- a/Products/ATContentTypes/tests/test_atimage.py
+++ b/Products/ATContentTypes/tests/test_atimage.py
@@ -17,6 +17,7 @@
 from zope.interface.verify import verifyObject
 
 import exif
+import io
 import os
 
 
@@ -74,10 +75,9 @@ def _make_image(self, title, filename='canoneye.jpg'):
         self.browser.open(self.portal.absolute_url() +
                           '/createObject?type_name=Image')
         self.browser.getControl('Title').value = title
-        image = self.browser.getControl(name='image_file')
-        image.filename = filename
         TEST_JPEG_FILE.seek(0)
-        image.value = TEST_JPEG_FILE
+        self.browser.getControl(name='image_file').add_file(
+            io.BytesIO(TEST_JPEG_FILE.read()), 'image/jpeg', filename)
         self.browser.getControl('Save').click()
 
     def test_image_id_from_filename_and_title(self):
@@ -307,6 +307,4 @@ def test_bobo_hook_security(self):
         self.assertEqual(response2.getStatus(), 200)  # OK
         # Should fail for anonymous
         response3 = self.publish(self.obj_path + '/image')
-        self.assertEqual(response3.getStatus(), 302)
-        bobo_exception = response3.getHeader('bobo-exception-type')
-        self.assertTrue('Unauthorized' in bobo_exception)
+        self.assertIn('require_login', response3.headers['location'])


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2017-02-03T16:13:43+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/875291c10c2dd779cfa26d31fce4b186a40a0faa

Fixed a few traversal tests.

Files changed:
M Products/ATContentTypes/tests/traversal.txt

diff --git a/Products/ATContentTypes/tests/traversal.txt b/Products/ATContentTypes/tests/traversal.txt
index 6025f34..7be50b1 100644
--- a/Products/ATContentTypes/tests/traversal.txt
+++ b/Products/ATContentTypes/tests/traversal.txt
@@ -52,7 +52,7 @@ be allowed to acquire content from higher-level hierarchies:
   ...
   ... </methodCall>
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Plone site...
 
   >>> print portal.test_document.getPortalTypeName()
@@ -74,7 +74,7 @@ be allowed to acquire content from higher-level hierarchies:
   ...
   ... </methodCall>
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Root Document...
 
   >>> 'test_document' in portal.simple_folder
@@ -93,7 +93,7 @@ be allowed to acquire content from higher-level hierarchies:
   ...
   ... </methodCall>
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Root Document...
 
 Browser
@@ -109,7 +109,7 @@ method instead.
   ... GET /%s/title_or_id HTTP/1.0
   ... Authorization: Basic %s:%s
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Plone site...
 
   >>> print portal.test_document.getPortalTypeName()
@@ -122,7 +122,7 @@ method instead.
   ... GET /%s/test_document/title_or_id HTTP/1.0
   ... Authorization: Basic %s:%s
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Root Document...
 
   >>> 'test_document' in portal.simple_folder
@@ -132,7 +132,7 @@ method instead.
   ... GET /%s/simple_folder/test_document/title_or_id HTTP/1.0
   ... Authorization: Basic %s:%s
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Root Document...
 
 Lets make sure view lookup takes precedence over acquired views.


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2017-02-04T13:31:40+01:00
Author: David Glick (davisagli) <david.glick@plone.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/adf95ebb93da105344f7753990848177c662fabe

Merge pull request #40 from plone/plonezope4

Changes to support Zope 4

Files changed:
M CHANGES.rst
M Products/ATContentTypes/tests/test_atimage.py
M Products/ATContentTypes/tests/traversal.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index 585070e..c7e15c2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix tests on Zope 4. [davisagli]
 
 
 2.3.2 (2017-01-20)
diff --git a/Products/ATContentTypes/tests/test_atimage.py b/Products/ATContentTypes/tests/test_atimage.py
index e59f29f..140d74f 100644
--- a/Products/ATContentTypes/tests/test_atimage.py
+++ b/Products/ATContentTypes/tests/test_atimage.py
@@ -17,6 +17,7 @@
 from zope.interface.verify import verifyObject
 
 import exif
+import io
 import os
 
 
@@ -74,10 +75,9 @@ def _make_image(self, title, filename='canoneye.jpg'):
         self.browser.open(self.portal.absolute_url() +
                           '/createObject?type_name=Image')
         self.browser.getControl('Title').value = title
-        image = self.browser.getControl(name='image_file')
-        image.filename = filename
         TEST_JPEG_FILE.seek(0)
-        image.value = TEST_JPEG_FILE
+        self.browser.getControl(name='image_file').add_file(
+            io.BytesIO(TEST_JPEG_FILE.read()), 'image/jpeg', filename)
         self.browser.getControl('Save').click()
 
     def test_image_id_from_filename_and_title(self):
@@ -307,6 +307,4 @@ def test_bobo_hook_security(self):
         self.assertEqual(response2.getStatus(), 200)  # OK
         # Should fail for anonymous
         response3 = self.publish(self.obj_path + '/image')
-        self.assertEqual(response3.getStatus(), 302)
-        bobo_exception = response3.getHeader('bobo-exception-type')
-        self.assertTrue('Unauthorized' in bobo_exception)
+        self.assertIn('require_login', response3.headers['location'])
diff --git a/Products/ATContentTypes/tests/traversal.txt b/Products/ATContentTypes/tests/traversal.txt
index 6025f34..7be50b1 100644
--- a/Products/ATContentTypes/tests/traversal.txt
+++ b/Products/ATContentTypes/tests/traversal.txt
@@ -52,7 +52,7 @@ be allowed to acquire content from higher-level hierarchies:
   ...
   ... </methodCall>
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Plone site...
 
   >>> print portal.test_document.getPortalTypeName()
@@ -74,7 +74,7 @@ be allowed to acquire content from higher-level hierarchies:
   ...
   ... </methodCall>
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Root Document...
 
   >>> 'test_document' in portal.simple_folder
@@ -93,7 +93,7 @@ be allowed to acquire content from higher-level hierarchies:
   ...
   ... </methodCall>
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Root Document...
 
 Browser
@@ -109,7 +109,7 @@ method instead.
   ... GET /%s/title_or_id HTTP/1.0
   ... Authorization: Basic %s:%s
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Plone site...
 
   >>> print portal.test_document.getPortalTypeName()
@@ -122,7 +122,7 @@ method instead.
   ... GET /%s/test_document/title_or_id HTTP/1.0
   ... Authorization: Basic %s:%s
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Root Document...
 
   >>> 'test_document' in portal.simple_folder
@@ -132,7 +132,7 @@ method instead.
   ... GET /%s/simple_folder/test_document/title_or_id HTTP/1.0
   ... Authorization: Basic %s:%s
   ... """ % (portal_name, default_user, default_password))
-  HTTP/1.0 200 OK
+  HTTP/1... 200 OK
   ...Root Document...
 
 Lets make sure view lookup takes precedence over acquired views.


