Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-12-21T15:30:44+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.ATContentTypes/commit/b6d667a8bd75c6cc1f4e33d77caec8afea0af888

Fixed Unauthorized error causing a redirect loop in old style Topics.

This only happened for anonymous users.

Fixes issue https://github.com/plone/Products.CMFPlone/issues/1292

Files changed:
M CHANGES.rst
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index e88502a..ae12d4e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,10 @@ New:
 
 Fixes:
 
-- *add item here*
+- Fixed Unauthorized error causing a redirect loop in old style
+  Topics.  This only happened for anonymous users.
+  Fixes issue https://github.com/plone/Products.CMFPlone/issues/1292
+  [maurits]
 
 
 2.2.9 (2015-11-26)
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
index 73e2286..d65bf98 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
@@ -5,7 +5,7 @@
          xmlns:i18n="http://xml.zope.org/namespaces/i18n"
          filename="report.pdf"
          tal:define="portal python:here.portal_url.getPortalObject();
-                     use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);
+                     use_view_action python:context.portal_registry['plone.types_use_view_action_in_listings'];
                      toLocalizedTime nocall:here/toLocalizedTime;">
 
   <title tal:content="here/title | nothing">Default Topic</title>
@@ -77,7 +77,7 @@
                                 August 16, 2001 at 23:35:59
                             </span>
                         </tal:modified>
-    
+
                         <metal:description define-slot="description_slot">
                             <tal:comment replace="nothing">
                                 Place custom listing info for custom types here
@@ -86,7 +86,7 @@
                     </para>
                     <para style="Table">
                        <span tal:omit-tag="python:1" tal:content="item_description|nothing">
-                            description 
+                            description
                         </span>
                     </para>
                 </td>
@@ -146,4 +146,3 @@
         </tal:topiccontents>
     </content>
 </document>
-
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
index 1287028..78d2aa1 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
@@ -3,7 +3,7 @@
     metal:use-macro="container/main_template/macros/master">
 
 <body>
-<metal:main fill-slot="main"    
+<metal:main fill-slot="main"
             tal:define="batch python:context.getFolderContents(batch=True, b_size=100);
                         here_url context/@@plone_context_state/object_url;">
 
@@ -20,14 +20,14 @@
         </div>
 
         <div id="content-core">
-            
+
             <form name="folderContentsForm"
                   method="post"
                   action="folder_object"
                   tal:attributes="action here_url">
-            
+
                 <metal:listing define-macro="folder_listing"
-                               tal:define="use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);">
+                               tal:define="use_view_action python:context.portal_registry['plone.types_use_view_action_in_listings'];">
 
                     <div class="visualClear" id="clear-space-before-navigation"><!-- --></div>
 
@@ -70,7 +70,7 @@
                           </tr>
                         </metal:block>
                       </thead>
-                
+
                       <metal:block tal:condition="batch|nothing">
                       <tbody tal:define="portal context/@@plone_portal_state/portal;
                                          getRelativeContentURL nocall:context/portal_url/getRelativeContentURL;
@@ -100,7 +100,7 @@
                                              item_folderish       item/is_folderish|nothing"
                                  tal:attributes="class python:test(oddrow, 'draggable even', 'draggable odd');
                                                  id string:folder-contents-item-${item_id};" >
-                
+
                                  <td class="notDraggable">
                                      <input type="checkbox"
                                             class="noborder"
@@ -113,7 +113,7 @@
                                                             title   string:Select $item_title_or_id" />
                                 <input type="hidden" name="obj_paths:list" value="#"
                                        tal:attributes="value item_rel_url" />
-                
+
                               </td>
                               <td tal:define="url python:test(item_use_view, item_url+'/view',
                                               test(item_folderish, item_url+'/folder_contents', item_url+'/'));">
@@ -130,12 +130,12 @@
                                           </strong>
                                       </a>
                                   </span>
-                
+
                                   <span class="state-expired"
                                         tal:condition="python:portal.isExpired(item)"
                                         i18n:translate="time_expired">expired</span>
                               </td>
-                
+
                               <metal:item_slot metal:define-slot="item_display">
                               <td>
                                 <span tal:condition="not: item_size"> &nbsp; </span>
@@ -160,7 +160,7 @@
                           </tal:items>
                       </tbody>
                       </metal:block>
-                  
+
                     </table>
                     <!-- Navigation -->
                     <div metal:use-macro="context/batch_macros/macros/navigation" />
@@ -181,7 +181,7 @@
                                              class python:test((button['id'] == 'paste'), 'standalone', 'context')" />
                     </tal:buttons>
                 </metal:buttons>
-            </form>            
+            </form>
         </div>
 </metal:main>
 </body>
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
index 70c528b..0918e08 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
@@ -14,7 +14,7 @@
 
         <metal:listingmacro define-macro="listing">
         <tal:topiccontents define="topicContents python:here.queryCatalog(batch=True);
-                                   use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);
+                                   use_view_action python:context.portal_registry['plone.types_use_view_action_in_listings'];
                                    batch topicContents;"
                            on-error="python:request.RESPONSE.redirect(context.absolute_url())">
 


