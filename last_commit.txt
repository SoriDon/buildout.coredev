Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2017-02-20T12:39:35+01:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/Products.CMFEditions/commit/7ffad0fc804253efa9f622b28a26f911e07f6019

Adapt tests

With PLIP 1343 being merged some tests need to be adapted.

Now the catalog no longer processes indexing operations right away.

Some tests rely on that, so a minimal adaptation was needed.

References:
https://github.com/plone/Products.CMFPlone/issues/1343

Files changed:
M CHANGES.rst
M Products/CMFEditions/tests/test_IntegrationTests.py
M Products/CMFEditions/tests/test_ZVCStorageTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1bcadaa..2391b63 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -58,6 +58,9 @@ Bug fixes:
 - Do not log using plone restricted python logging script.
   [jensens]
 
+- Adapt tests to the new indexing operations queueing.
+  Part of PLIP 1343: https://github.com/plone/Products.CMFPlone/issues/1343
+  [gforcada]
 
 2.2.21 (2016-08-18)
 -------------------
diff --git a/Products/CMFEditions/tests/test_IntegrationTests.py b/Products/CMFEditions/tests/test_IntegrationTests.py
index c1ad5b6..80eee18 100644
--- a/Products/CMFEditions/tests/test_IntegrationTests.py
+++ b/Products/CMFEditions/tests/test_IntegrationTests.py
@@ -24,6 +24,7 @@
 
 """
 from Acquisition import aq_base
+from Products.CMFCore.indexing import processQueue
 from Products.CMFEditions.tests.base import CMFEditionsBaseTestCase
 from ZODB import broken
 from zope.component.persistentregistry import PersistentComponents
@@ -539,6 +540,7 @@ def test15_retrieveInsideRefsFolderWithAddedOrDeletedObjects(self):
 
         # remove an item
         fol.manage_delObjects('doc2')
+        processQueue()
 
         cur_ids = fol.objectIds()
         self.assertEqual(len(cur_ids), 1)
@@ -1102,6 +1104,7 @@ def test25_versioningRestoresInsideRefsFolderOrder(self):
         fol.moveObjectsToTop(['doc3'])
         fol.moveObjectsToTop(['doc4'])
         fol.manage_delObjects(['doc2'])
+        processQueue()
         transaction.savepoint(optimistic=True)
         doc3 = fol['doc3']
         doc4 = fol['doc4']
diff --git a/Products/CMFEditions/tests/test_ZVCStorageTool.py b/Products/CMFEditions/tests/test_ZVCStorageTool.py
index 400e9e4..70812ba 100644
--- a/Products/CMFEditions/tests/test_ZVCStorageTool.py
+++ b/Products/CMFEditions/tests/test_ZVCStorageTool.py
@@ -37,6 +37,8 @@
 from Products.CMFEditions.interfaces.IStorage import StorageUnregisteredError
 from Products.CMFEditions.interfaces.IStorage import StorageRetrieveError
 
+from Products.CMFCore.indexing import processQueue
+
 from DummyTools import Dummy as Dummy
 from DummyTools import DummyPurgePolicy
 from DummyTools import MemoryStorage
@@ -511,6 +513,7 @@ def test15_storageStatistics(self):
         self.portal.portal_catalog.indexObject(self.portal.public)
         portal_storage.register(cmf_uid, ObjectData(obj7), metadata=self.buildMetadata('saved public'))
 
+        processQueue()
         got = portal_storage.zmi_getStorageStatistics()
         expected = {'deleted': [],
                     'summaries': {


Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2017-02-21T21:58:42+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFEditions/commit/9b54bd77d798f03bea2a1f47b6055137a753f8bb

Merge pull request #37 from plone/merge-collective-indexing

Merge collective indexing

Files changed:
M CHANGES.rst
M Products/CMFEditions/tests/test_IntegrationTests.py
M Products/CMFEditions/tests/test_ZVCStorageTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1bcadaa..2391b63 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -58,6 +58,9 @@ Bug fixes:
 - Do not log using plone restricted python logging script.
   [jensens]
 
+- Adapt tests to the new indexing operations queueing.
+  Part of PLIP 1343: https://github.com/plone/Products.CMFPlone/issues/1343
+  [gforcada]
 
 2.2.21 (2016-08-18)
 -------------------
diff --git a/Products/CMFEditions/tests/test_IntegrationTests.py b/Products/CMFEditions/tests/test_IntegrationTests.py
index c1ad5b6..80eee18 100644
--- a/Products/CMFEditions/tests/test_IntegrationTests.py
+++ b/Products/CMFEditions/tests/test_IntegrationTests.py
@@ -24,6 +24,7 @@
 
 """
 from Acquisition import aq_base
+from Products.CMFCore.indexing import processQueue
 from Products.CMFEditions.tests.base import CMFEditionsBaseTestCase
 from ZODB import broken
 from zope.component.persistentregistry import PersistentComponents
@@ -539,6 +540,7 @@ def test15_retrieveInsideRefsFolderWithAddedOrDeletedObjects(self):
 
         # remove an item
         fol.manage_delObjects('doc2')
+        processQueue()
 
         cur_ids = fol.objectIds()
         self.assertEqual(len(cur_ids), 1)
@@ -1102,6 +1104,7 @@ def test25_versioningRestoresInsideRefsFolderOrder(self):
         fol.moveObjectsToTop(['doc3'])
         fol.moveObjectsToTop(['doc4'])
         fol.manage_delObjects(['doc2'])
+        processQueue()
         transaction.savepoint(optimistic=True)
         doc3 = fol['doc3']
         doc4 = fol['doc4']
diff --git a/Products/CMFEditions/tests/test_ZVCStorageTool.py b/Products/CMFEditions/tests/test_ZVCStorageTool.py
index 400e9e4..70812ba 100644
--- a/Products/CMFEditions/tests/test_ZVCStorageTool.py
+++ b/Products/CMFEditions/tests/test_ZVCStorageTool.py
@@ -37,6 +37,8 @@
 from Products.CMFEditions.interfaces.IStorage import StorageUnregisteredError
 from Products.CMFEditions.interfaces.IStorage import StorageRetrieveError
 
+from Products.CMFCore.indexing import processQueue
+
 from DummyTools import Dummy as Dummy
 from DummyTools import DummyPurgePolicy
 from DummyTools import MemoryStorage
@@ -511,6 +513,7 @@ def test15_storageStatistics(self):
         self.portal.portal_catalog.indexObject(self.portal.public)
         portal_storage.register(cmf_uid, ObjectData(obj7), metadata=self.buildMetadata('saved public'))
 
+        processQueue()
         got = portal_storage.zmi_getStorageStatistics()
         expected = {'deleted': [],
                     'summaries': {


