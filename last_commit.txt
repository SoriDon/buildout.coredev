Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-07-08T14:56:45+02:00
Author: Ã‰rico Andrei (ericof) <ericof@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/1a485dd9d5ed6c524a8f475af74d3b936cf95c7b

Fix nav_title metadata not being applied on navigation service items. (#1170)

Files changed:
A news/1169.bugfix
A src/plone/restapi/profiles/testing/catalog.xml
M src/plone/restapi/services/navigation/get.py
M src/plone/restapi/tests/dxtypes.py
M src/plone/restapi/tests/http-examples/link.resp
M src/plone/restapi/tests/test_services_navigation.py

b'diff --git a/news/1169.bugfix b/news/1169.bugfix\nnew file mode 100644\nindex 000000000..0d3df90cb\n--- /dev/null\n+++ b/news/1169.bugfix\n@@ -0,0 +1,2 @@\n+Fix navigation service not using nav_title metadata.\n+[ericof]\ndiff --git a/src/plone/restapi/profiles/testing/catalog.xml b/src/plone/restapi/profiles/testing/catalog.xml\nnew file mode 100644\nindex 000000000..cb243018d\n--- /dev/null\n+++ b/src/plone/restapi/profiles/testing/catalog.xml\n@@ -0,0 +1,4 @@\n+<?xml version="1.0"?>\n+<object name="portal_catalog">\n+  <column value="nav_title" />\n+</object>\ndiff --git a/src/plone/restapi/services/navigation/get.py b/src/plone/restapi/services/navigation/get.py\nindex c9b6b6a7f..8d3d2ca5d 100644\n--- a/src/plone/restapi/services/navigation/get.py\n+++ b/src/plone/restapi/services/navigation/get.py\n@@ -174,9 +174,8 @@ def navtree(self):\n                 "review_state": json_compatible(brain.review_state),\n                 "use_view_action_in_listings": brain.portal_type in types_using_view,\n             }\n-\n-            if brain.get("nav_title", False):\n-                entry.update({"title": brain["nav_title"]})\n+            if "nav_title" in brain and brain.nav_title:\n+                entry.update({"title": brain.nav_title})\n \n             self.customize_entry(entry, brain)\n             ret[brain_parent_path].append(entry)\ndiff --git a/src/plone/restapi/tests/dxtypes.py b/src/plone/restapi/tests/dxtypes.py\nindex a71d5fd9d..493801524 100644\n--- a/src/plone/restapi/tests/dxtypes.py\n+++ b/src/plone/restapi/tests/dxtypes.py\n@@ -312,6 +312,8 @@ class DXTestDocument(Item):\n class ITestBehavior(model.Schema):\n \n     test_behavior_field = schema.TextLine(required=False)\n+    # Add nav_title to test if it gets substituted in Navigation service\n+    nav_title = schema.TextLine(required=False)\n \n \n @provider(IFormFieldProvider)\ndiff --git a/src/plone/restapi/tests/http-examples/link.resp b/src/plone/restapi/tests/http-examples/link.resp\nindex 9a7c04edb..7e57f8c08 100644\n--- a/src/plone/restapi/tests/http-examples/link.resp\n+++ b/src/plone/restapi/tests/http-examples/link.resp\n@@ -54,7 +54,7 @@ Content-Type: application/json\n     "description": "Congratulations! You have successfully installed Plone.", \n     "title": "Welcome to Plone"\n   }, \n-  "remoteUrl": "http://localhost:55001/plone",\n+  "remoteUrl": "http://localhost:55001/plone", \n   "review_state": "private", \n   "rights": "", \n   "subjects": [], \ndiff --git a/src/plone/restapi/tests/test_services_navigation.py b/src/plone/restapi/tests/test_services_navigation.py\nindex 74c08eee5..89092d17f 100644\n--- a/src/plone/restapi/tests/test_services_navigation.py\n+++ b/src/plone/restapi/tests/test_services_navigation.py\n@@ -3,8 +3,11 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.utils import createContentInContainer\n+from plone.registry.interfaces import IRegistry\n from plone.restapi.testing import PLONE_RESTAPI_DX_FUNCTIONAL_TESTING\n from plone.restapi.testing import RelativeSession\n+from Products.CMFPlone.interfaces.controlpanel import INavigationSchema\n+from zope.component import getUtility\n \n import transaction\n import unittest\n@@ -207,3 +210,27 @@ def test_navigation_sorting(self):\n                 "/folder/doc1",\n             ],\n         )\n+\n+    def test_use_nav_title_when_available_and_set(self):\n+        registry = getUtility(IRegistry)\n+        settings = registry.forInterface(INavigationSchema, prefix="plone")\n+        displayed_types = settings.displayed_types\n+        settings.displayed_types = tuple(list(displayed_types) + ["DXTestDocument"])\n+\n+        title = "Example Document"\n+        nav_title = "Fancy title"\n+\n+        createContentInContainer(\n+            self.folder,\n+            "DXTestDocument",\n+            id="example-dx-document",\n+            title=title,\n+            nav_title=nav_title,\n+        )\n+        transaction.commit()\n+\n+        response = self.api_session.get(\n+            "/folder/@navigation", params={"expand.navigation.depth": 2}\n+        )\n+\n+        self.assertEqual(response.json()["items"][1]["items"][-1]["title"], nav_title)\n'

