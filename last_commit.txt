Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-02-04T22:11:26-08:00
Author: Alec Mitchell (alecpm) <alecpm@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/7a8a1e8c5be25013beb83d4edcdb40afb6d3cda4

Implement Navigation Root support in TinyMCE browser. (Refs plone/mockup#623)

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5ad4419..a4cec22 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,9 @@ Changelog
 
 New:
 
+- Add custom navigation root in TinyMCE configuration.
+  [alecm]
+
 - Add barceloneta theme path in less configuration.
   [Gagaro]
 
diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index ab0d06f..6bb7629 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -11,6 +11,7 @@
 from plone.uuid.interfaces import IUUID
 from Products.CMFPlone.interfaces import IPloneSiteRoot
 from Acquisition import aq_parent, aq_inner
+from plone.app.layout.navigation.root import getNavigationRootObject
 from plone.app.theming.utils import theming_policy
 from Products.CMFCore.utils import getToolByName
 from zope.component.hooks import getSite
@@ -241,7 +242,10 @@ def tinymce(self):
             initial = None
         else:
             initial = IUUID(folder, None)
-        current_path = folder.absolute_url()[len(generator.portal_url):]
+
+        nav_root = getNavigationRootObject(folder, generator.portal)
+        root_url = get_portal_url(folder)
+        current_path = folder.absolute_url()[len(root_url):]
 
         image_types = settings.image_objects or []
         folder_types = settings.contains_objects or []
@@ -252,8 +256,10 @@ def tinymce(self):
             'relatedItems': {
                 'vocabularyUrl':
                     '%s/@@getVocabulary?name=plone.app.vocabularies.Catalog' % (
-                        generator.portal_url),
-                'folderTypes': folder_types
+                        root_url),
+                'folderTypes': folder_types,
+                'rootPath': '/'.join(nav_root.getPhysicalPath()) if nav_root
+                            else '/',
             },
             'upload': {
                 'initialFolder': initial,


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-02-07T22:01:12-06:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/0aa8e742c82b3775ab69157baa8b997caf3ed80f

Merge pull request #1366 from plone/issue-623-related-breadcrumbs

Implement Navigation Root support in TinyMCE browser.

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5ad4419..a4cec22 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,9 @@ Changelog
 
 New:
 
+- Add custom navigation root in TinyMCE configuration.
+  [alecm]
+
 - Add barceloneta theme path in less configuration.
   [Gagaro]
 
diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index ab0d06f..6bb7629 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -11,6 +11,7 @@
 from plone.uuid.interfaces import IUUID
 from Products.CMFPlone.interfaces import IPloneSiteRoot
 from Acquisition import aq_parent, aq_inner
+from plone.app.layout.navigation.root import getNavigationRootObject
 from plone.app.theming.utils import theming_policy
 from Products.CMFCore.utils import getToolByName
 from zope.component.hooks import getSite
@@ -241,7 +242,10 @@ def tinymce(self):
             initial = None
         else:
             initial = IUUID(folder, None)
-        current_path = folder.absolute_url()[len(generator.portal_url):]
+
+        nav_root = getNavigationRootObject(folder, generator.portal)
+        root_url = get_portal_url(folder)
+        current_path = folder.absolute_url()[len(root_url):]
 
         image_types = settings.image_objects or []
         folder_types = settings.contains_objects or []
@@ -252,8 +256,10 @@ def tinymce(self):
             'relatedItems': {
                 'vocabularyUrl':
                     '%s/@@getVocabulary?name=plone.app.vocabularies.Catalog' % (
-                        generator.portal_url),
-                'folderTypes': folder_types
+                        root_url),
+                'folderTypes': folder_types,
+                'rootPath': '/'.join(nav_root.getPhysicalPath()) if nav_root
+                            else '/',
             },
             'upload': {
                 'initialFolder': initial,


