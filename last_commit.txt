Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-09-25T07:18:18+02:00
Author: Fred van Dijk (fredvd) <fredvd@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/fb8f29d1f8e1ec9432d544492278c3f9328367f4

Make masking specific validation errors configurable  (#1212)

* Make masking specific validation errors configurable in DX DeserializeFromJson. Refs #1211

* test using sorted list to avoid likely unrelated test failure on Python3.6.

Files changed:
A news/1211.feature
M src/plone/restapi/deserializer/dxcontent.py
M src/plone/restapi/tests/test_search.py

b'diff --git a/news/1211.feature b/news/1211.feature\nnew file mode 100644\nindex 000000000..810eb2efe\n--- /dev/null\n+++ b/news/1211.feature\n@@ -0,0 +1 @@\n+Make masking specific validation errors configurable in DX DeserializeFromJson. [fredvd]\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/deserializer/dxcontent.py b/src/plone/restapi/deserializer/dxcontent.py\nindex 70fe9de18..88258ab04 100644\n--- a/src/plone/restapi/deserializer/dxcontent.py\n+++ b/src/plone/restapi/deserializer/dxcontent.py\n@@ -35,7 +35,7 @@ def __init__(self, context, request):\n         self.modified = {}\n \n     def __call__(\n-        self, validate_all=False, data=None, create=False\n+        self, validate_all=False, data=None, create=False, mask_validation_errors=True\n     ):  # noqa: ignore=C901\n \n         if data is None:\n@@ -52,10 +52,11 @@ def __call__(\n                 errors.append({"error": error, "message": str(error)})\n \n         if errors:\n-            # Drop Python specific error classes in order to be able to better handle\n-            # errors on front-end\n-            for error in errors:\n-                error["error"] = "ValidationError"\n+            if mask_validation_errors:\n+                # Drop Python specific error classes in order to be able to better handle\n+                # errors on front-end\n+                for error in errors:\n+                    error["error"] = "ValidationError"\n             raise BadRequest(errors)\n \n         # We\'ll set the layout after the validation and even if there\ndiff --git a/src/plone/restapi/tests/test_search.py b/src/plone/restapi/tests/test_search.py\nindex e68d65bfe..e2602ced2 100644\n--- a/src/plone/restapi/tests/test_search.py\n+++ b/src/plone/restapi/tests/test_search.py\n@@ -748,15 +748,17 @@ def test_search_use_site_search_settings_with_vhm(self):\n         response = self.api_session.get(\n             vhm_url, params={"use_site_search_settings": 1, "path": "/"}\n         ).json()\n-        titles = [\n-            "Some Folder",\n-            "Lorem Ipsum",\n-            "Other Document",\n-            "Another Folder",\n-            "Document in second folder",\n-            "Doc outside folder",\n-        ]\n-        self.assertEqual([item["title"] for item in response["items"]], titles)\n+        titles = sorted(\n+            [\n+                "Another Folder",\n+                "Doc outside folder",\n+                "Document in second folder",\n+                "Lorem Ipsum",\n+                "Other Document",\n+                "Some Folder",\n+            ]\n+        )\n+        self.assertEqual(sorted([item["title"] for item in response["items"]]), titles)\n \n         noLongerProvides(self.folder, INavigationRoot)\n         transaction.commit()\n'

