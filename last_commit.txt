Repository: Products.contentmigration


Branch: refs/heads/master
Date: 2018-10-05T13:26:11+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.contentmigration/commit/0b1d2964a5b7a0a96fd61be5674364fe8f55799e

prevent additionalQuery from spilling to other calls and testlayers

Files changed:
M Products/contentmigration/tests/cmtc.py
M Products/contentmigration/tests/layer.py
M Products/contentmigration/tests/testATFieldMigration.py
M Products/contentmigration/walker.py

b'diff --git a/Products/contentmigration/tests/cmtc.py b/Products/contentmigration/tests/cmtc.py\nindex 8d2bc35..c2e7a34 100644\n--- a/Products/contentmigration/tests/cmtc.py\n+++ b/Products/contentmigration/tests/cmtc.py\n@@ -5,7 +5,7 @@\n \n import transaction\n \n-from plone.app.testing.bbb import PloneTestCase\n+from plone.app.testing.bbb_at import PloneTestCase\n \n # Callback methods\n \ndiff --git a/Products/contentmigration/tests/layer.py b/Products/contentmigration/tests/layer.py\nindex 6f5e3a7..c7be5a9 100644\n--- a/Products/contentmigration/tests/layer.py\n+++ b/Products/contentmigration/tests/layer.py\n@@ -27,6 +27,7 @@ def setUpZope(self, app, configurationContext):\n     def setUpPloneSite(self, portal):\n         testing.applyProfile(portal, \'Products.contentmigration:CMF_sampletypes\')\n \n+\n PCM_FIXTURE = PloneTestCaseFixture()\n TestLayer = testing.FunctionalTesting(\n     bases=(PCM_FIXTURE, ), name=\'PloneContentMigrationTestCase:Functional\')\ndiff --git a/Products/contentmigration/tests/testATFieldMigration.py b/Products/contentmigration/tests/testATFieldMigration.py\nindex b2e549c..ca93a4a 100644\n--- a/Products/contentmigration/tests/testATFieldMigration.py\n+++ b/Products/contentmigration/tests/testATFieldMigration.py\n@@ -152,10 +152,5 @@ def testUnsetAttributeWithCustomQuery(self):\n                     },)\n         self.execute(query, actions)\n         self.assertEqual(storage.get(\'text\', self.folder[\'d2\']).getRaw(), \'Body two\')\n-        self.assertRaises(AttributeError, storage.get, \'text\', self.folder[\'d1\'])\n-\n-def test_suite():\n-    from unittest import TestSuite, makeSuite\n-    suite = TestSuite()\n-    suite.addTest(makeSuite(TestFieldMigration))\n-    return suite\n+        with self.assertRaises(AttributeError):\n+            storage.get(\'text\', self.folder[\'d1\'])\ndiff --git a/Products/contentmigration/walker.py b/Products/contentmigration/walker.py\nindex 39acc0d..36c44ba 100644\n--- a/Products/contentmigration/walker.py\n+++ b/Products/contentmigration/walker.py\n@@ -12,7 +12,6 @@ class CustomQueryWalker(CatalogWalker):\n     """Walker using portal_catalog and an optional custom query. The ATCT\n     migration framework uses this to find content to migrate.\n     """\n-    additionalQuery = {}\n \n     def __init__(self, portal, migrator, src_portal_type=None, dst_portal_type=None,\n                     query={}, callBefore=None, **kwargs):\n@@ -35,7 +34,7 @@ def __init__(self, portal, migrator, src_portal_type=None, dst_portal_type=None,\n         CatalogWalker.__init__(self, portal, migrator,\n                                src_portal_type=src_portal_type,\n                                dst_portal_type=dst_portal_type, **kwargs)\n-        self.additionalQuery.update(query)\n+        self.additionalQuery = query\n         self.callBefore = callBefore\n         self.kwargs = kwargs\n \n'

Repository: Products.contentmigration


Branch: refs/heads/master
Date: 2018-10-10T11:45:19+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.contentmigration/commit/393eb22faab32a682f44f9bc443a9b0e84645682

add changenote

Files changed:
A news/21.bugfix
M news/19.bugfix

b'diff --git a/news/19.bugfix b/news/19.bugfix\nindex 6156317..f1ed08a 100644\n--- a/news/19.bugfix\n+++ b/news/19.bugfix\n@@ -1,3 +1,3 @@\n Switch to new TestCase using AT after PloneTestcase is now DX.\n-\n [pbauer]\n+\ndiff --git a/news/21.bugfix b/news/21.bugfix\nnew file mode 100644\nindex 0000000..f3f0cbd\n--- /dev/null\n+++ b/news/21.bugfix\n@@ -0,0 +1,2 @@\n+Prevent additionalQuery from spilling to other calls and testlayers.\n+[pbauer]\n'

Repository: Products.contentmigration


Branch: refs/heads/master
Date: 2018-10-10T11:46:33+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.contentmigration/commit/720e991493198b601a9cddae4833d11bb4db7432

Merge pull request #20 from plone/fix_isolation_issue_with_additionalQuery

prevent additionalQuery from spilling to other calls and testlayers

Files changed:
A news/21.bugfix
M Products/contentmigration/tests/cmtc.py
M Products/contentmigration/tests/layer.py
M Products/contentmigration/tests/testATFieldMigration.py
M Products/contentmigration/walker.py
M news/19.bugfix

b'diff --git a/Products/contentmigration/tests/cmtc.py b/Products/contentmigration/tests/cmtc.py\nindex 8d2bc35..c2e7a34 100644\n--- a/Products/contentmigration/tests/cmtc.py\n+++ b/Products/contentmigration/tests/cmtc.py\n@@ -5,7 +5,7 @@\n \n import transaction\n \n-from plone.app.testing.bbb import PloneTestCase\n+from plone.app.testing.bbb_at import PloneTestCase\n \n # Callback methods\n \ndiff --git a/Products/contentmigration/tests/layer.py b/Products/contentmigration/tests/layer.py\nindex 6f5e3a7..c7be5a9 100644\n--- a/Products/contentmigration/tests/layer.py\n+++ b/Products/contentmigration/tests/layer.py\n@@ -27,6 +27,7 @@ def setUpZope(self, app, configurationContext):\n     def setUpPloneSite(self, portal):\n         testing.applyProfile(portal, \'Products.contentmigration:CMF_sampletypes\')\n \n+\n PCM_FIXTURE = PloneTestCaseFixture()\n TestLayer = testing.FunctionalTesting(\n     bases=(PCM_FIXTURE, ), name=\'PloneContentMigrationTestCase:Functional\')\ndiff --git a/Products/contentmigration/tests/testATFieldMigration.py b/Products/contentmigration/tests/testATFieldMigration.py\nindex b2e549c..ca93a4a 100644\n--- a/Products/contentmigration/tests/testATFieldMigration.py\n+++ b/Products/contentmigration/tests/testATFieldMigration.py\n@@ -152,10 +152,5 @@ def testUnsetAttributeWithCustomQuery(self):\n                     },)\n         self.execute(query, actions)\n         self.assertEqual(storage.get(\'text\', self.folder[\'d2\']).getRaw(), \'Body two\')\n-        self.assertRaises(AttributeError, storage.get, \'text\', self.folder[\'d1\'])\n-\n-def test_suite():\n-    from unittest import TestSuite, makeSuite\n-    suite = TestSuite()\n-    suite.addTest(makeSuite(TestFieldMigration))\n-    return suite\n+        with self.assertRaises(AttributeError):\n+            storage.get(\'text\', self.folder[\'d1\'])\ndiff --git a/Products/contentmigration/walker.py b/Products/contentmigration/walker.py\nindex 39acc0d..36c44ba 100644\n--- a/Products/contentmigration/walker.py\n+++ b/Products/contentmigration/walker.py\n@@ -12,7 +12,6 @@ class CustomQueryWalker(CatalogWalker):\n     """Walker using portal_catalog and an optional custom query. The ATCT\n     migration framework uses this to find content to migrate.\n     """\n-    additionalQuery = {}\n \n     def __init__(self, portal, migrator, src_portal_type=None, dst_portal_type=None,\n                     query={}, callBefore=None, **kwargs):\n@@ -35,7 +34,7 @@ def __init__(self, portal, migrator, src_portal_type=None, dst_portal_type=None,\n         CatalogWalker.__init__(self, portal, migrator,\n                                src_portal_type=src_portal_type,\n                                dst_portal_type=dst_portal_type, **kwargs)\n-        self.additionalQuery.update(query)\n+        self.additionalQuery = query\n         self.callBefore = callBefore\n         self.kwargs = kwargs\n \ndiff --git a/news/19.bugfix b/news/19.bugfix\nindex 6156317..f1ed08a 100644\n--- a/news/19.bugfix\n+++ b/news/19.bugfix\n@@ -1,3 +1,3 @@\n Switch to new TestCase using AT after PloneTestcase is now DX.\n-\n [pbauer]\n+\ndiff --git a/news/21.bugfix b/news/21.bugfix\nnew file mode 100644\nindex 0000000..f3f0cbd\n--- /dev/null\n+++ b/news/21.bugfix\n@@ -0,0 +1,2 @@\n+Prevent additionalQuery from spilling to other calls and testlayers.\n+[pbauer]\n'

