Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-02-02T21:40:10+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/20a46bcca5ce095d88d2fe6ebccda0bcf9939d50

Do not modify the Content-Type header on bundle combine

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c60bb36..badf986 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -139,6 +139,9 @@ New features:
 - Simplify generated Gruntfile.js (DRY)
   [jensens]
 
+- Fix: Do not modify the Content-Type header on bundle combine.
+  [jensens]
+
 
 Bug fixes:
 
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 7a8e89e..696ed87 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -53,13 +53,19 @@ def get_resource(context, path):
     if isinstance(resource, FilesystemFile):
         (directory, sep, filename) = path.rpartition('/')
         return context.unrestrictedTraverse(directory).readFile(filename)
+
+    # calling the resource may modify the header, i.e. the content-type.
+    # we do not want this, so keep the original header intact.
+    response_before = context.REQUEST.response
+    context.REQUEST.response = response_before.__class__()
+    if hasattr(aq_base(resource), 'GET'):
+        # for FileResource
+        result = resource.GET()
     else:
-        if hasattr(aq_base(resource), 'GET'):
-            # for FileResource
-            return resource.GET()
-        else:
-            # any BrowserView
-            return resource()
+        # any BrowserView
+        result = resource()
+    context.REQUEST.response = response_before
+    return result
 
 
 def write_js(context, folder, meta_bundle):


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2017-02-03T11:01:16+01:00
Author: Robert Niederreiter (rnixx) <office@squarewave.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/b857a26135d21bca0e893a226423bdc4c6cd221b

Merge pull request #1924 from plone/jensens-fix-modified-headers-on-combine-bundles

Do not modify the Content-Type header on bundle combine

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c60bb36..badf986 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -139,6 +139,9 @@ New features:
 - Simplify generated Gruntfile.js (DRY)
   [jensens]
 
+- Fix: Do not modify the Content-Type header on bundle combine.
+  [jensens]
+
 
 Bug fixes:
 
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 7a8e89e..696ed87 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -53,13 +53,19 @@ def get_resource(context, path):
     if isinstance(resource, FilesystemFile):
         (directory, sep, filename) = path.rpartition('/')
         return context.unrestrictedTraverse(directory).readFile(filename)
+
+    # calling the resource may modify the header, i.e. the content-type.
+    # we do not want this, so keep the original header intact.
+    response_before = context.REQUEST.response
+    context.REQUEST.response = response_before.__class__()
+    if hasattr(aq_base(resource), 'GET'):
+        # for FileResource
+        result = resource.GET()
     else:
-        if hasattr(aq_base(resource), 'GET'):
-            # for FileResource
-            return resource.GET()
-        else:
-            # any BrowserView
-            return resource()
+        # any BrowserView
+        result = resource()
+    context.REQUEST.response = response_before
+    return result
 
 
 def write_js(context, folder, meta_bundle):


