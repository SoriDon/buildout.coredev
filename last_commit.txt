Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-02-29T10:22:37+01:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/78a88d293d45362d3a7fa576f865e5929972a464

Fix #637 return a JSON error instead of the Plone error page for non-HTML resources

Files changed:
M CHANGES.rst
M Products/CMFPlone/skins/plone_templates/standard_error_message.py
M Products/CMFPlone/tests/redirection.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index c2e0192..4aee29a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -73,6 +73,10 @@ Fixes:
 - Sort relateditems tree by sortable_title in tinymce.
   [Gagaro]
 
+- Return a JSON error instead of a the Plone error page when the requested
+  resource is not text/html (fix #637).
+  [ebrehault]
+
 
 5.0.2 (2016-01-08)
 ------------------
diff --git a/Products/CMFPlone/skins/plone_templates/standard_error_message.py b/Products/CMFPlone/skins/plone_templates/standard_error_message.py
index 260f1ee..7879337 100644
--- a/Products/CMFPlone/skins/plone_templates/standard_error_message.py
+++ b/Products/CMFPlone/skins/plone_templates/standard_error_message.py
@@ -27,6 +27,10 @@
 error_traceback = kwargs.get('error_traceback', None)
 error_value = kwargs.get('error_value', None)
 
+if "text/html" not in context.REQUEST.getHeader('Accept', ''):
+    context.REQUEST.RESPONSE.setHeader("Content-Type", "application/json")
+    return '{"error_type": "{0:s}"}'.format(error_type)
+
 if error_log_url:
     error_log_id = error_log_url.split('?id=')[1]
 else:
diff --git a/Products/CMFPlone/tests/redirection.txt b/Products/CMFPlone/tests/redirection.txt
index 7529911..0106d5b 100644
--- a/Products/CMFPlone/tests/redirection.txt
+++ b/Products/CMFPlone/tests/redirection.txt
@@ -31,5 +31,16 @@ But it should not give an error while rendering the default error page:
 
   >>> "the following error occurred while attempting to render the standard error message" in browser.contents
   False
+
+As it is an image, it should return a JSON message
+  >>> '{"error_type": "NotFound"}' in browser.contents
+  True
+
+A non-existing page would return a human readable error page
+  >>> browser.addHeader('Accept', 'text/html')
+  >>> browser.open('http://nohost/plone/non-existing-page')
+  Traceback (most recent call last):
+  ...
+  HTTPError: HTTP Error 404: Not Found
   >>> "This page does not seem to exist" in browser.contents
   True


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-02-29T10:34:33+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/5f89c0640349a56be4c71db55d9f41982f812ce0

Merge pull request #1417 from plone/ebr-http-errors

Fix #637 return a JSON error instead of the Plone error page for non-HTML resources

Files changed:
M CHANGES.rst
M Products/CMFPlone/skins/plone_templates/standard_error_message.py
M Products/CMFPlone/tests/redirection.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index 8bb0bef..196595d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -79,6 +79,10 @@ Fixes:
 - Sort relateditems tree by sortable_title in tinymce.
   [Gagaro]
 
+- Return a JSON error instead of a the Plone error page when the requested
+  resource is not text/html (fix #637).
+  [ebrehault]
+
 
 5.0.2 (2016-01-08)
 ------------------
diff --git a/Products/CMFPlone/skins/plone_templates/standard_error_message.py b/Products/CMFPlone/skins/plone_templates/standard_error_message.py
index 260f1ee..7879337 100644
--- a/Products/CMFPlone/skins/plone_templates/standard_error_message.py
+++ b/Products/CMFPlone/skins/plone_templates/standard_error_message.py
@@ -27,6 +27,10 @@
 error_traceback = kwargs.get('error_traceback', None)
 error_value = kwargs.get('error_value', None)
 
+if "text/html" not in context.REQUEST.getHeader('Accept', ''):
+    context.REQUEST.RESPONSE.setHeader("Content-Type", "application/json")
+    return '{"error_type": "{0:s}"}'.format(error_type)
+
 if error_log_url:
     error_log_id = error_log_url.split('?id=')[1]
 else:
diff --git a/Products/CMFPlone/tests/redirection.txt b/Products/CMFPlone/tests/redirection.txt
index 7529911..0106d5b 100644
--- a/Products/CMFPlone/tests/redirection.txt
+++ b/Products/CMFPlone/tests/redirection.txt
@@ -31,5 +31,16 @@ But it should not give an error while rendering the default error page:
 
   >>> "the following error occurred while attempting to render the standard error message" in browser.contents
   False
+
+As it is an image, it should return a JSON message
+  >>> '{"error_type": "NotFound"}' in browser.contents
+  True
+
+A non-existing page would return a human readable error page
+  >>> browser.addHeader('Accept', 'text/html')
+  >>> browser.open('http://nohost/plone/non-existing-page')
+  Traceback (most recent call last):
+  ...
+  HTTPError: HTTP Error 404: Not Found
   >>> "This page does not seem to exist" in browser.contents
   True


