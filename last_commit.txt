Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-25T14:46:25+01:00
Author: Fred van Dijk (fredvd) <fredvd@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/af7ec5ff7980359328370493656c0a416852f9a8

Move p.a.discussion monkey patch for reindexing conversations to CatalogTool.py

Files changed:
M CHANGES.rst
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bcae7a3..1e77e81 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,11 @@ New:
 
 Fixes:
 
+- Move p.a.discussion monkey patch for reindexing conversations to
+  CatalogTool.py as p.a.discussion is part of Plone core.
+  Issue https://github.com/plone/Products.CMFPlone/issues/1332
+  [fredvd, staeff]
+
 - Fix custom tinymce content styles not getting included correctly
   [vangheem]
 
diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py
index 87c902d..93d1036 100644
--- a/Products/CMFPlone/CatalogTool.py
+++ b/Products/CMFPlone/CatalogTool.py
@@ -22,6 +22,7 @@
 from Products.CMFCore.utils import _checkPermission
 from Products.CMFCore.utils import _getAuthenticatedUser
 from Products.CMFCore.utils import getToolByName
+from Products.CMFPlone import DISCUSSION_ANNOTATION_KEY
 from Products.CMFPlone.PloneBaseTool import PloneBaseTool
 from Products.CMFPlone.interfaces import INonStructuralFolder
 from Products.CMFPlone.interfaces import IPloneCatalogTool
@@ -32,6 +33,7 @@
 from plone.i18n.normalizer.base import mapUnicode
 from plone.indexer import indexer
 from plone.indexer.interfaces import IIndexableObject
+from zope.annotation.interfaces import IAnnotations
 from zope.component import queryMultiAdapter
 from zope.interface import Interface
 from zope.interface import implementer
@@ -425,6 +427,21 @@ def indexObject(obj, path):
                     safe_callable(obj.indexObject)):
                 try:
                     obj.indexObject()
+
+                    # index conversions from plone.app.discussion
+                    annotions = IAnnotations(obj)
+                    catalog = getToolByName(obj, "portal_catalog")
+                    if DISCUSSION_ANNOTATION_KEY in annotions:
+                        conversation = annotions[DISCUSSION_ANNOTATION_KEY]
+                        conversation = conversation.__of__(obj)
+                        for comment in conversation.getComments():
+                            try:
+                                if catalog:
+                                    catalog.indexObject(comment)
+                            except StopIteration:  # pragma: no cover
+                                pass
+
+
                 except TypeError:
                     # Catalogs have 'indexObject' as well, but they
                     # take different args, and will fail
diff --git a/Products/CMFPlone/__init__.py b/Products/CMFPlone/__init__.py
index 81c7454..9ea177f 100644
--- a/Products/CMFPlone/__init__.py
+++ b/Products/CMFPlone/__init__.py
@@ -15,6 +15,8 @@
     os.path.join('skins', 'plone_images', 'logoIcon.png'),
     cmfplone_globals)}
 
+DISCUSSION_ANNOTATION_KEY = 'plone.app.discussion:conversation'
+
 
 def initialize(context):
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2016-01-31T23:33:06+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/f57a28567ccf295676f3327230b0e519f4d67d69

Merge pull request #1333 from plone/remove-p.a.discussion-monkey

Move p.a.discussion monkey patch for reindexing conversations

Files changed:
M CHANGES.rst
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3ef80c4..7ecfd02 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,6 +15,11 @@ New:
 
 Fixes:
 
+- Move p.a.discussion monkey patch for reindexing conversations to
+  CatalogTool.py as p.a.discussion is part of Plone core.
+  Issue https://github.com/plone/Products.CMFPlone/issues/1332
+  [fredvd, staeff]
+
 - Fix custom tinymce content styles not getting included correctly
   [vangheem]
 
diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py
index 87c902d..93d1036 100644
--- a/Products/CMFPlone/CatalogTool.py
+++ b/Products/CMFPlone/CatalogTool.py
@@ -22,6 +22,7 @@
 from Products.CMFCore.utils import _checkPermission
 from Products.CMFCore.utils import _getAuthenticatedUser
 from Products.CMFCore.utils import getToolByName
+from Products.CMFPlone import DISCUSSION_ANNOTATION_KEY
 from Products.CMFPlone.PloneBaseTool import PloneBaseTool
 from Products.CMFPlone.interfaces import INonStructuralFolder
 from Products.CMFPlone.interfaces import IPloneCatalogTool
@@ -32,6 +33,7 @@
 from plone.i18n.normalizer.base import mapUnicode
 from plone.indexer import indexer
 from plone.indexer.interfaces import IIndexableObject
+from zope.annotation.interfaces import IAnnotations
 from zope.component import queryMultiAdapter
 from zope.interface import Interface
 from zope.interface import implementer
@@ -425,6 +427,21 @@ def indexObject(obj, path):
                     safe_callable(obj.indexObject)):
                 try:
                     obj.indexObject()
+
+                    # index conversions from plone.app.discussion
+                    annotions = IAnnotations(obj)
+                    catalog = getToolByName(obj, "portal_catalog")
+                    if DISCUSSION_ANNOTATION_KEY in annotions:
+                        conversation = annotions[DISCUSSION_ANNOTATION_KEY]
+                        conversation = conversation.__of__(obj)
+                        for comment in conversation.getComments():
+                            try:
+                                if catalog:
+                                    catalog.indexObject(comment)
+                            except StopIteration:  # pragma: no cover
+                                pass
+
+
                 except TypeError:
                     # Catalogs have 'indexObject' as well, but they
                     # take different args, and will fail
diff --git a/Products/CMFPlone/__init__.py b/Products/CMFPlone/__init__.py
index 81c7454..9ea177f 100644
--- a/Products/CMFPlone/__init__.py
+++ b/Products/CMFPlone/__init__.py
@@ -15,6 +15,8 @@
     os.path.join('skins', 'plone_images', 'logoIcon.png'),
     cmfplone_globals)}
 
+DISCUSSION_ANNOTATION_KEY = 'plone.app.discussion:conversation'
+
 
 def initialize(context):
 


