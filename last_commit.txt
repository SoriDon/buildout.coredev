Repository: plone.app.widgets


Branch: refs/heads/master
Date: 2016-02-17T03:10:27-08:00
Author: Alec Mitchell (alecpm) <alecpm@gmail.com>
Commit: https://github.com/plone/plone.app.widgets/commit/59f74d53482f5092ee7dd0c6d9c29d2637ea168c

Ensure vocabulary lookup works on add forms for related items widget, and with add forms using schema groups.

Files changed:
M CHANGES.rst
M plone/app/widgets/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5b1e48c..d8ba9e2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -12,7 +12,8 @@ New:
 
 Fixes:
 
-- *add item here*
+- Ensure vocabulary lookup works on add forms for related items widget.
+  [alecm]
 
 
 2.0.3 (2016-02-14)
diff --git a/plone/app/widgets/utils.py b/plone/app/widgets/utils.py
index 7a164e9..49bccc4 100644
--- a/plone/app/widgets/utils.py
+++ b/plone/app/widgets/utils.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 
+from Acquisition import aq_base
 from Products.CMFCore.interfaces import ISiteRoot
 from Products.CMFCore.utils import getToolByName
 from datetime import datetime
@@ -122,7 +123,8 @@ def get_relateditems_options(context, value, separator, vocabulary_name,
     options = get_ajaxselect_options(context, value, separator,
                                      vocabulary_name, vocabulary_view,
                                      field_name)
-
+    if IAddForm.providedBy(context):
+        context = context.context
     request = getRequest()
     msgstr = translate(_(u'Search'), context=request)
     options.setdefault('searchText', msgstr)
@@ -204,3 +206,10 @@ def get_context_url(context):
     else:
         url = get_portal_url(context)
     return url
+
+
+def get_widget_form(widget):
+    form = getattr(widget, 'form', None)
+    if getattr(aq_base(form), 'parentForm', None) is not None:
+        form = form.parentForm
+    return form


