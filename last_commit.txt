Repository: plone.namedfile


Branch: refs/heads/master
Date: 2023-04-25T17:02:11+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.namedfile/commit/5d0bbcf3105a75e4bbb31fdd6b4682bcf1c514c0

Fix picture tag when original image is used instead of a scale.

Fixes https://github.com/plone/plone.namedfile/issues/142

Files changed:
A news/142.bugfix
M plone/namedfile/picture.py
M plone/namedfile/tests/test_scaling.py

b'diff --git a/news/142.bugfix b/news/142.bugfix\nnew file mode 100644\nindex 0000000..17bd527\n--- /dev/null\n+++ b/news/142.bugfix\n@@ -0,0 +1,2 @@\n+Fix picture tag when original image is used instead of a scale.\n+[maurits]\ndiff --git a/plone/namedfile/picture.py b/plone/namedfile/picture.py\nindex 6b38786..14ea65b 100644\n--- a/plone/namedfile/picture.py\n+++ b/plone/namedfile/picture.py\n@@ -145,5 +145,15 @@ def update_src_scale(self, src, scale):\n             src_scale = "/".join(parts[:-1]) + f"/{field_name}/{scale}"\n             src_scale\n         else:\n-            src_scale = "/".join(parts[:-1]) + f"/{scale}"\n+            # Usually the url has \'@@images/fieldname/other_scale\',\n+            # and then we replace the other scale.\n+            # But the url may use the original image, e.g. @@images/image.\n+            # Then we want to keep the fieldname and return \'.../image/scale\'.\n+            try:\n+                full = len(parts) - parts.index("@@images") == 2\n+            except ValueError:\n+                full = False\n+            if not full:\n+                parts = parts[:-1]\n+            src_scale = "/".join(parts) + f"/{scale}"\n         return src_scale\ndiff --git a/plone/namedfile/tests/test_scaling.py b/plone/namedfile/tests/test_scaling.py\nindex ed4382a..4bba8eb 100644\n--- a/plone/namedfile/tests/test_scaling.py\n+++ b/plone/namedfile/tests/test_scaling.py\n@@ -980,6 +980,34 @@ def test_title(self):\n         )\n \n \n+class Img2PictureTagTests(unittest.TestCase):\n+    """Low level tests for Img2PictureTag."""\n+\n+    def _makeOne(self):\n+        return plone.namedfile.picture.Img2PictureTag()\n+\n+    def test_update_src_scale(self):\n+        update_src_scale = self._makeOne().update_src_scale\n+        self.assertEqual(\n+            update_src_scale("foo/fieldname/old", "new"),\n+            "foo/fieldname/new"\n+        )\n+        self.assertEqual(\n+            update_src_scale("@@images/fieldname/old", "mini"),\n+            "@@images/fieldname/mini"\n+        )\n+        self.assertEqual(\n+            update_src_scale("@@images/fieldname", "preview"),\n+            "@@images/fieldname/preview"\n+        )\n+        self.assertEqual(\n+            update_src_scale(\n+                "photo.jpg/@@images/image-1200-4a03b0a8227d28737f5d9e3e481bdbd6.jpeg",\n+                "teaser"),\n+            "photo.jpg/@@images/image/teaser",\n+        )\n+\n+\n def test_suite():\n     from unittest import defaultTestLoader\n \n'

Repository: plone.namedfile


Branch: refs/heads/master
Date: 2023-05-02T10:34:05+02:00
Author: Fred van Dijk (fredvd) <fredvd@gmail.com>
Commit: https://github.com/plone/plone.namedfile/commit/cf8574af9cb90adcfacdc014c49c2f20d24ac876

Merge pull request #143 from plone/maurits-fix-update_src_scale-for-full-image-urls

Fix picture tag when original image is used instead of a scale.

Files changed:
A news/142.bugfix
M plone/namedfile/picture.py
M plone/namedfile/tests/test_scaling.py

b'diff --git a/news/142.bugfix b/news/142.bugfix\nnew file mode 100644\nindex 0000000..17bd527\n--- /dev/null\n+++ b/news/142.bugfix\n@@ -0,0 +1,2 @@\n+Fix picture tag when original image is used instead of a scale.\n+[maurits]\ndiff --git a/plone/namedfile/picture.py b/plone/namedfile/picture.py\nindex 6b38786..14ea65b 100644\n--- a/plone/namedfile/picture.py\n+++ b/plone/namedfile/picture.py\n@@ -145,5 +145,15 @@ def update_src_scale(self, src, scale):\n             src_scale = "/".join(parts[:-1]) + f"/{field_name}/{scale}"\n             src_scale\n         else:\n-            src_scale = "/".join(parts[:-1]) + f"/{scale}"\n+            # Usually the url has \'@@images/fieldname/other_scale\',\n+            # and then we replace the other scale.\n+            # But the url may use the original image, e.g. @@images/image.\n+            # Then we want to keep the fieldname and return \'.../image/scale\'.\n+            try:\n+                full = len(parts) - parts.index("@@images") == 2\n+            except ValueError:\n+                full = False\n+            if not full:\n+                parts = parts[:-1]\n+            src_scale = "/".join(parts) + f"/{scale}"\n         return src_scale\ndiff --git a/plone/namedfile/tests/test_scaling.py b/plone/namedfile/tests/test_scaling.py\nindex ed4382a..4bba8eb 100644\n--- a/plone/namedfile/tests/test_scaling.py\n+++ b/plone/namedfile/tests/test_scaling.py\n@@ -980,6 +980,34 @@ def test_title(self):\n         )\n \n \n+class Img2PictureTagTests(unittest.TestCase):\n+    """Low level tests for Img2PictureTag."""\n+\n+    def _makeOne(self):\n+        return plone.namedfile.picture.Img2PictureTag()\n+\n+    def test_update_src_scale(self):\n+        update_src_scale = self._makeOne().update_src_scale\n+        self.assertEqual(\n+            update_src_scale("foo/fieldname/old", "new"),\n+            "foo/fieldname/new"\n+        )\n+        self.assertEqual(\n+            update_src_scale("@@images/fieldname/old", "mini"),\n+            "@@images/fieldname/mini"\n+        )\n+        self.assertEqual(\n+            update_src_scale("@@images/fieldname", "preview"),\n+            "@@images/fieldname/preview"\n+        )\n+        self.assertEqual(\n+            update_src_scale(\n+                "photo.jpg/@@images/image-1200-4a03b0a8227d28737f5d9e3e481bdbd6.jpeg",\n+                "teaser"),\n+            "photo.jpg/@@images/image/teaser",\n+        )\n+\n+\n def test_suite():\n     from unittest import defaultTestLoader\n \n'

